"use strict";function makeLocalDBMS(){function A(){this._init(e)}var e={};return A.prototype.getSettings=function(){return this.database.Settings},baseAPI(A,Migrator,CommonUtils,EventEmitter),statisticsAPI(A,R,CommonUtils),consistencyCheckAPI(A,R,CommonUtils,Ajv,Schema),charactersAPI(A,Constants,CommonUtils,Errors,e),groupsAPI(A,R,Constants,CommonUtils,Errors,e),investigationBoardAPI(A,R,Constants,CommonUtils,Errors,e),relationsAPI(A,R,Constants,CommonUtils,Errors,e),briefingExportAPI(A,CommonUtils,R,Constants),profileConfigurerAPI(A,Constants,CommonUtils,Errors),storyBaseAPI(A,R,CommonUtils,Errors),storyEventsAPI(A,R,CommonUtils,Errors),storyCharactersAPI(A,R,CommonUtils,Errors,e),storyViewAPI(A,R,CommonUtils,dateFormat),storyAdaptationsAPI(A,CommonUtils),accessManagerAPI(A,CommonUtils,R),logAPI(A,R,CommonUtils),Logger.attachLogCalls(A,R,!1),A}function makeRemoteDBMS(A){function e(){this.clearSettings()}var t="/",r=!1;return e._simpleGet=function(A,e,r){var a="";e&&(a="?params="+encodeURIComponent(JSON.stringify(e)));var n=$.ajax({url:t+A+a,dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",cache:!1,timeout:Constants.httpTimeout});n.done(function(A){r(null,JSON.parse(A))}),n.fail(function(A,e,t){try{r(JSON.parse(A.responseText))}catch(a){r(A.responseText||e||"error")}})},e._simplePut=function(A,e,a){var n=$.ajax({url:t+A,dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify(e),timeout:Constants.httpTimeout});if(r){var i=clearEl(getEl("debugNotification"));removeClass(i,"hidden"),removeClass(i,"operationOK"),removeClass(i,"operationFail"),addEl(i,makeText(A+" "+JSON.stringify(e)))}n.done(function(A){r&&(addClass(i,"operationOK"),setTimeout(function(){addClass(i,"hidden")},1e3)),a&&a()}),n.fail(function(A,e,t){r&&(addClass(i,"operationFail"),setTimeout(function(){addClass(i,"hidden")},1e3));try{a(JSON.parse(A.responseText))}catch(n){a(A.responseText||e||"error")}})},Object.keys(A.prototype).forEach(function(A){e.prototype[A]=function(){for(var t=[],r=0;r<arguments.length-1;r++)t.push(arguments[r]);CommonUtils.startsWith(A,"get")||CommonUtils.startsWith(A,"is")?e._simpleGet(A,t,arguments[arguments.length-1]):e._simplePut(A,t,arguments[arguments.length-1])}}),e.prototype.clearSettings=function(){this.Settings={BriefingPreview:{},Stories:{},CharacterProfile:{}}},e.prototype.getSettings=function(){return this.Settings},e}function getL10n(A){return L10n.getValue(A)}function constL10n(A){return L10n.getValue("constant-"+A)}function isEmpty(A){return 0===Object.getOwnPropertyNames(A).length}function toggleClass(A,e){hasClass(A,e)?removeClass(A,e):addClass(A,e)}function hasClass(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");return t.test(A.className)}function setClassByCondition(A,e,t){t?addClass(A,e):removeClass(A,e)}function getEl(A){return document.getElementById(A)}function queryEl(A){return document.querySelector(A)}function queryElEls(A,e){return A.querySelectorAll(e)}function getEls(A){return document.getElementsByClassName(A)}function makeEl(A){return document.createElement(A)}function makeText(A){return document.createTextNode(A)}function delAttr(A,e){return A.removeAttribute(e),A}function getAttr(A,e){return A.getAttribute(e)}function setProp(A,e,t){return A[e]=t,A}function setProps(A,e){for(var t in e)setProp(A,t,e[t]);return A}function clearEl(A){return Utils.removeChildren(A),A}function passEls(A,e){for(var t=0;t<A.children.length;t++)addEl(e,A.children[t])}function listen(A,e,t){A.addEventListener(e,t)}function arr2Chunks(A,e){var t,r,a=[];for(t=0,r=A.length;r>t;t+=e)a.push(A.slice(t,t+e));return a}function fillSelector(A,e){e.forEach(function(e){var t=makeEl("option");addEl(t,makeText(e.name)),e.value&&(t.value=e.value),e.selected&&(t.selected=!0),addEl(A,t)})}function nl2array(A){return Array.prototype.slice.call(A)}var LocalDBMS=makeLocalDBMS(),RemoteDBMS=makeRemoteDBMS(LocalDBMS),FileUtils={};FileUtils.init=function(A){FileUtils.callback=A},FileUtils.makeNewBase=function(){Utils.confirm(getL10n("utils-new-base-warning"))&&DBMS.setDatabase(CommonUtils.clone(EmptyBase.data),FileUtils.callback)},FileUtils.openHelp=function(){window.open("extras/doc/nims.html")},FileUtils.readSingleFile=function(A){var e=A.target.files[0];if(e){var t=new FileReader;t.onload=function(A){var e=A.target.result,t=JSON.parse(e);DBMS.setDatabase(t,FileUtils.callback)},t.readAsText(e)}else Utils.alert(getL10n("utils-base-file-loading-error"))},FileUtils.saveFile=function(){DBMS.getDatabase(function(A,e){return A?void Utils.handleError(A):void FileUtils.json2File(e,"nims-base.json")})},FileUtils.json2File=function(A,e){FileUtils.str2File(JSON.stringify(A,null,"  "),e)},FileUtils.str2File=function(A,e){var t=new Blob([A],{type:"text/plain;charset=utf-8"});saveAs(t,e)};var L10n={};L10n.initialized=!1,L10n.l10nDelegates=[],L10n.init=function(){if(!L10n.initialized){L10n.dictionaries={},console.log(navigator.language);var A=function(A){var e={};for(var t in A)for(var r in A[t])e[t+"-"+r]=A[t][r];return e};for(var e in Dictionaries)L10n.dictionaries[e]=A(Dictionaries[e]);var t=defaultLang;console.log(t),L10n.dictionaries[t]?L10n.dict=L10n.dictionaries[t]:L10n.dict=L10n.dictionaries.en,L10n.initialized=!0}};var lang=defaultLang;L10n.toggleL10n=function(){"ru"===lang?(L10n.dict=L10n.dictionaries.en,lang="en"):(L10n.dict=L10n.dictionaries.ru,lang="ru"),L10n.localizeStatic(),L10n.l10nDelegates.forEach(function(A){A()}),PageManager.currentView.refresh()},L10n.getLang=function(){return lang.toLowerCase()},L10n.getValue=function(A){var e=L10n.dict[A];return e?e:A+":RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA"},L10n.getFixedValue=function(A){return function(){return L10n.getValue(A)}},L10n.onL10nChange=function(A){L10n.l10nDelegates.push(A)},L10n.localizeStatic=function(){L10n.init();for(var A,e=document.querySelectorAll("[l10n-id]"),t=0;t<e.length;t++)A=e[t],addEl(clearEl(A),makeText(L10n.getValue(getAttr(A,"l10n-id"))));e=document.querySelectorAll("[l10n-placeholder-id]");for(var t=0;t<e.length;t++)A=e[t],setAttr(A,"placeholder",L10n.getValue(getAttr(A,"l10n-placeholder-id")))};var PageManager={},DBMS;PageManager.onLoad=function(){L10n.localizeStatic(),UI.initSelectorFilters(),UI.initPanelTogglers(),"Standalone"===MODE?(DBMS=new LocalDBMS,DBMS.setDatabase(BaseExample.data,function(A){return A?void Utils.handleError(A):void PageManager.consistencyCheck(PageManager.onDatabaseLoad)})):"NIMS_Server"===MODE&&(DBMS=new RemoteDBMS,PageManager.consistencyCheck(PageManager.onDatabaseLoad))},PageManager.consistencyCheck=function(A){DBMS.getConsistencyCheckResult(function(e,t){return e?void Utils.handleError(e):(t.forEach(CommonUtils.consoleLog),t.length>0?Utils.alert(getL10n("overview-consistency-problem-detected")):console.log("Consistency check didn't find errors"),void A())})},PageManager.onDatabaseLoad=function(){PermissionInformer.refresh(function(A){return A?void Utils.handleError(A):void PermissionInformer.isAdmin(function(A,e){if(A)return void Utils.handleError(A);var t=PageManager;t.views={};var r,a="navigation",n="contentArea",i=getEl(a),o={root:t,navigation:i,content:getEl(n)};Utils.addView(o,"overview",Overview,{mainPage:!0}),Utils.addView(o,"characters",Characters),Utils.addView(o,"stories",Stories),Utils.addView(o,"adaptations",Events),Utils.addView(o,"briefings",Briefings),addEl(i,addClass(makeEl("div"),"nav-separator")),Utils.addView(o,"timeline",Timeline,{id:"timelineButton",tooltip:!0}),Utils.addView(o,"social-network",SocialNetwork,{id:"socialNetworkButton",tooltip:!0}),Utils.addView(o,"character-filter",CharacterFilter,{id:"filterButton",tooltip:!0}),Utils.addView(o,"groups",Groups,{id:"groupsButton",tooltip:!0}),addEl(i,addClass(makeEl("div"),"nav-separator"));var s={tooltip:!0,className:"mainNavButton"};if(e){var r=PageManager.makeButton("dataLoadButton","open-database",null,s);r.addEventListener("change",FileUtils.readSingleFile,!1);var l=makeEl("input");l.type="file",addClass(l,"hidden"),setAttr(l,"tabindex",-1),r.appendChild(l),r.addEventListener("click",function(A){l.click()}),addEl(i,r)}addEl(i,PageManager.makeButton("dataSaveButton","save-database",FileUtils.saveFile,s)),"Standalone"===MODE&&addEl(i,PageManager.makeButton("newBaseButton","create-database",FileUtils.makeNewBase,s)),addEl(i,PageManager.makeButton("mainHelpButton","docs",FileUtils.openHelp,s)),Utils.addView(o,"logViewer",LogViewer2,{id:"logViewerButton",tooltip:!0}),"NIMS_Server"===MODE&&(Utils.addView(o,"admins",AccessManager,{id:"accessManagerButton",tooltip:!0}),addEl(i,PageManager.makeButton("logoutButton","logout",PageManager.postLogout,s))),FileUtils.init(function(A){return A?void Utils.handleError(A):void PageManager.consistencyCheck(PageManager.currentView.refresh)}),PageManager.currentView.refresh()})})},PageManager.runTests=function(){PageManager.consistencyCheck(function(){})},PageManager.postLogout=function(){document.querySelector("#logoutForm button").click()},PageManager.makeButton=function(A,e,t,r){var a=makeEl("button");if(a.id=A,r.tooltip){var n=function(){$(a).attr("data-original-title",L10n.getValue("header-"+e))};L10n.onL10nChange(n),$(a).tooltip({title:L10n.getValue("header-"+e),placement:"bottom"})}return addClass(a,"action-button"),r.className&&addClass(a,r.className),t&&listen(a,"click",t),a},window.onbeforeunload=function(A){var e=getL10n("utils-close-page-warning");return"undefined"==typeof A&&(A=window.event),A&&(A.returnValue=e),e};var PermissionInformer={};PermissionInformer.summary={},"NIMS_Server"===MODE?(PermissionInformer.refresh=function(A){var e=$.ajax({url:"/getPermissionsSummary",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",timeout:Constants.httpTimeout});e.done(function(e){PermissionInformer.summary=JSON.parse(e),A?A():PermissionInformer.subscribe()}),e.fail(function(e,t,r){A?A(e.responseText||"error"):setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.subscribe=function(){var A=$.ajax({url:"/subscribeOnPermissionsUpdate",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",timeout:Constants.httpTimeout});A.done(function(A){PermissionInformer.summary=JSON.parse(A),PermissionInformer.subscribe()}),A.fail(function(A,e,t){setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.refresh(),PermissionInformer.isAdmin=function(A){A(null,PermissionInformer.summary.isAdmin)},PermissionInformer.isEditor=function(A){A(null,PermissionInformer.summary.isEditor)},PermissionInformer.isCharacterEditable=function(A,e){e(null,PermissionInformer.isObjectEditableSync("characters",A))},PermissionInformer.isStoryEditable=function(A,e){e(null,PermissionInformer.isObjectEditableSync("stories",A))},PermissionInformer.isGroupEditable=function(A,e){e(null,PermissionInformer.isObjectEditableSync("groups",A))},PermissionInformer.isObjectEditableSync=function(A,e){return PermissionInformer.summary.isEditor?!0:PermissionInformer.summary.existEditor?!1:-1!==PermissionInformer.summary.user[A].indexOf(e)},PermissionInformer.getEntityNamesArray=R.curry(function(A,e,t){var r=PermissionInformer.summary.user[A],a=PermissionInformer.summary.all[A],n=PermissionInformer.summary.ownerMaps[A],i=a.filter(function(t){return e?PermissionInformer.isObjectEditableSync(A,t):!0}).map(function(e){return{displayName:n[e]+". "+e,value:e,editable:PermissionInformer.isObjectEditableSync(A,e),isOwner:-1!==r.indexOf(e)}});i.sort(Utils.charOrdAObject),t(null,i)}),PermissionInformer.getCharacterNamesArray=PermissionInformer.getEntityNamesArray("characters"),PermissionInformer.getStoryNamesArray=PermissionInformer.getEntityNamesArray("stories"),PermissionInformer.getGroupNamesArray=PermissionInformer.getEntityNamesArray("groups"),PermissionInformer.areAdaptationsEditable=function(A,e){var t={},r=PermissionInformer.summary.isAdaptationRightsByStory;A.forEach(function(A){var e=A.storyName+"-"+A.characterName;r?t[e]=PermissionInformer.isObjectEditableSync("stories",A.storyName):t[e]=PermissionInformer.isObjectEditableSync("characters",A.characterName)}),e(null,t)}):(PermissionInformer.refresh=function(A){A()},PermissionInformer.isAdmin=function(A){A(null,!0)},PermissionInformer.isEditor=function(A){A(null,!0)},PermissionInformer.getEntityNamesArray=R.curry(function(A,e,t){DBMS[A](function(A,e){if(A)return void Utils.handleError(A);var r=[];e.forEach(function(A){r.push({displayName:A,value:A,editable:!0})}),t(null,r)})}),PermissionInformer.getCharacterNamesArray=PermissionInformer.getEntityNamesArray("getCharacterNamesArray"),PermissionInformer.getStoryNamesArray=PermissionInformer.getEntityNamesArray("getStoryNamesArray"),PermissionInformer.getGroupNamesArray=PermissionInformer.getEntityNamesArray("getGroupNamesArray"),PermissionInformer.isStoryEditable=PermissionInformer.isGroupEditable=PermissionInformer.isCharacterEditable=function(A,e){e(null,!0)},PermissionInformer.areAdaptationsEditable=function(A,e){var t={};A.forEach(function(A){t[A.storyName+"-"+A.characterName]=!0}),e(null,t)});var UI={};UI.initTabPanel=function(A,e){var t,r=getEls(e);for(t=1;t<r.length;t++)addClass(r[t],"hidden");var a=getEls(A);for(addClass(a[0],"active"),t=0;t<a.length;t++)listen(a[t],"click",UI.tabButtonClick(a,r))},UI.tabButtonClick=function(A,e){return function(t){for(var r=0;r<A.length;r++)setClassByCondition(A[r],"active",t.target.id===A[r].id);for(var r=0;r<e.length;r++)setClassByCondition(e[r],"hidden",t.target.id+"Container"!==e[r].id)}},UI.fillShowItemSelector=function(A,e){var t;setAttr(A,"size",e.length),e.forEach(function(e,r){t=setProps(makeEl("option"),{selected:!0}),addEl(A,addEl(t,makeText(e)))})},UI.showSelectedEls=function(A){return function(e){var t,r,a,n=e.target;for(r=0;r<n.options.length;r+=1)for(t=getEls(r+A),a=0;a<t.length;a++)setClassByCondition(t[a],"hidden",!n.options[r].selected)}},UI.initSelectorFilters=function(){for(var A,e,t=document.querySelectorAll("[selector-filter]"),r=0;r<t.length;r++)A=t[r],e=queryEl(getAttr(A,"selector-filter")),listen(A,"input",UI.filterOptions(e))},UI.filterOptions=function(A){return function(e){var t,r,a=e.target.value;for(a=CommonUtils.globStringToRegex(a.trim().toLowerCase()),t=0;t<A.options.length;t+=1)r=A.options[t],setClassByCondition(r,"hidden",-1===r.innerHTML.toLowerCase().search(a))}},UI.initPanelTogglers=function(){for(var A,e,t,r=document.querySelectorAll("[panel-toggler]"),a=0;a<r.length;a++)A=r[a],t=getAttr(A,"panel-toggler"),e=document.querySelector(t),null==e&&Utils.alert("Panel toggler is broken: "+t),listen(A,"click",UI.togglePanel(e))},UI.togglePanel=function(A){return function(e){toggleClass(A,"hidden")}},UI.makeEventTimePicker=function(A){var e=makeEl("input");R.ap([addClass(e)],A.extraClasses),addClass(e,"eventTime"),e.value=A.eventTime,e.eventIndex=A.index;var t={lang:L10n.getLang(),mask:!0,startDate:new Date(A.preGameDate),endDate:new Date(A.date),onChangeDateTime:A.onChangeDateTimeCreator(e)};return""!==A.eventTime?t.value=A.eventTime:(t.value=A.date,addClass(e,"defaultDate")),jQuery(e).datetimepicker(t),e},UI.resizeTextarea=function(A){var e=A.target;e.style.height="24px",e.style.height=e.scrollHeight+12+"px"},UI.makeAdaptationTimeInput=function(A,e,t,r){var a=makeEl("input");return setClassByCondition(a,"notEditable",!r),addClass(a,"adaptationTimeInput"),a.value=e.characters[t].time,a.dataKey=JSON.stringify([A,e.index,t]),listen(a,"change",UI.onChangePersonalTimeDelegate),a},UI.onChangePersonalTimeDelegate=function(A){var e=JSON.parse(A.target.dataKey),t=A.target.value;DBMS.setEventAdaptationTime(e[0],e[1],e[2],t,Utils.processError())};var Utils={};Utils.addView=function(A,e,t,r){var r=r||{};t.init();var a="navigation-button";A.root.views[e]=t;var n=makeEl("button");if(r.tooltip){var i=function(){$(n).attr("data-original-title",L10n.getValue("header-"+e))};L10n.onL10nChange(i),$(n).tooltip({title:L10n.getValue("header-"+e),placement:"bottom"})}else addEl(n,makeText(L10n.getValue("header-"+e))),setAttr(n,"l10n-id","header-"+e);addClass(n,a),addClass(n,"-test-"+e),addClass(n,"-toggle-class-"+e),r.id&&(n.id=r.id),A.navigation.appendChild(n);var o,s=function(t){return function(n){if(o=A.navigation.getElementsByClassName(a),r.toggle)for(var i=getEls("-toggle-class-"+e),s=0;s<i.length;s++)n.target.isEqualNode(i[s])||hasClass(i[s],"active")&&i[s].click();var l=hasClass(n.target,"active");for(s=0;s<o.length;s++)removeClass(o[s],"active");!r.toggle||r.toggle&&!l?(addClass(n.target,"active"),passEls(A.content,getEl("warehouse")),A.content.appendChild(t.content),removeClass(A.content,"hidden"),A.root.currentView=t,t.refresh()):(removeClass(n.target,"active"),passEls(A.content,getEl("warehouse")),A.root.currentView=null,addClass(A.content,"hidden"))}};n.addEventListener("click",s(t)),r.mainPage&&(addClass(n,"active"),A.content.appendChild(t.content),A.root.currentView=t)},Utils.alert=function(A){window.alert(A)},Utils.confirm=function(A){return window.confirm(A)},Utils.removeChildren=function(A){if(A)for(;A.firstChild;)A.removeChild(A.firstChild)},Utils.processError=function(A){return function(e){if(e)return void Utils.handleError(e);if(A){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);A.apply(null,t)}}},Utils.handleError=function(A){A instanceof Errors.ValidationError||A.name&&"ValidationError"===A.name?Utils.alert(strFormat(getL10n(A.messageId),A.parameters)):"object"==typeof A?Utils.alert(A.message):Utils.alert(A)},Utils.enable=function(A,e,t){var r,a,n,i=A.getElementsByClassName(e);for(r=0;r<i.length;r++)a=i[r],n="textarea"===a.tagName.toLowerCase()?"readonly":"disabled",t?a.removeAttribute(n):a.setAttribute(n,n)},Utils.charOrdAObject=CommonUtils.charOrdAFactory(function(A){return A.displayName.toLowerCase()}),Utils.rebuildSelector=function(A,e){clearEl(A),e.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e.displayName)),t.value=e.value,A.appendChild(t)})},Utils.rebuildSelectorArr=function(A,e){clearEl(A),e.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e)),A.appendChild(t)})},String.prototype.endsWith=function(A){return-1!==this.indexOf(A,this.length-A.length)};var strFormat=R.curry(CommonUtils.strFormat),addClass=R.curry(function(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");if(!t.test(A.className))return A.className=(A.className+" "+e).replace(/\s+/g," ").replace(/(^ | $)/g,""),A}),addClasses=R.curry(function(A,e){return R.ap([addClass(A)],e),A}),rAddClass=R.curry(function(A,e){var t=new RegExp("(^|\\s)"+A+"(\\s|$)","g");if(!t.test(e.className))return e.className=(e.className+" "+A).replace(/\s+/g," ").replace(/(^ | $)/g,""),e}),removeClass=R.curry(function(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");A.className=A.className.replace(t,"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}),addEl=R.curry(function(A,e){return A.appendChild(e),A}),addEls=R.curry(function(A,e){return R.ap([addEl(A)],e),A}),makeOpt=function(A){var e=makeEl("option");return addEl(e,makeText(A)),e},rAddEl=R.curry(function(A,e){return e.appendChild(A),e}),setAttr=R.curry(function(A,e,t){return A.setAttribute(e,t),A}),remapProps=R.curry(function(A,e,t){return R.compose(R.zipObj(A),R.values,R.pick(e))(t)}),remapProps4Select2=remapProps(["id","text"],["value","displayName"]),remapProps4Select=remapProps(["value","name"],["value","displayName"]),getSelect2DataCommon=R.curry(function(A,e){return R.compose(R.zipObj(["data"]),R.append(R.__,[]),R.map(A))(e)}),getSelect2Data=getSelect2DataCommon(remapProps4Select2),makeSelect2Opt=R.compose(R.zipObj(["id","text"]),R.repeat(R.__,2)),arr2Select2=R.compose(R.assoc("data",R.__,{}),R.map(makeSelect2Opt)),getSelectedRadio=function(A){for(var e=document.querySelectorAll(A),t=0;t<e.length;t++)if(e[t].checked===!0)return e[t];return null},debugInterceptor=function(A){return function(){console.log(JSON.stringify(arguments[0])),A.apply(null,arguments)}};Date.prototype.format=function(A,e){return dateFormat(this,A,e)};