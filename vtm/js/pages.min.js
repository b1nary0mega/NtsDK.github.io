/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const root = '.charsheet-tab ';
    const state = {
        refreshHooks: []
    };
    const onRefresh = callback => state.refreshHooks.push(callback);
    const addRefreshHook = R.curry((getter, itemName, rangeOnLoad2) =>
        onRefresh(onRefreshHook(getter, itemName, rangeOnLoad2)));

    exports.init = () => {
        listen(queryEl(`${root}.background-color-input`), 'change', onBackgroundColorChange);

        const sel = clearEl(queryEl(`${root}.charsheet-back-mode`));
        fillSelector(sel, constArr2Select(Constants.charsheetBackModes));
        listen(sel, 'change', onCharsheetBackModeChange);
        listen(queryEl(`${root}.charsheet-background-color-input`), 'change', onCharsheetBackColorChange);
        listen(queryEl(`${root}.back-image-to-default`), 'click', toDefaultImage);

        listen(queryEl(`${root}.charsheet-background-image-input`), 'change', readImage);
        listen(queryEl(`${root}.charsheet-background-image-input`), 'focus', (e) => {
            e.target.value = '';
        });

        const profileEls = Constants.profileCols.map(R.map(makeProfileEl)).map(els => addEls(makeEl('div'), els));
        addEls(queryEl(`${root}.profile-container`), profileEls);

        const attrRange = makeRangeEl('setAttribute', 0, Constants.maxPoints, makeStaticLabel, addRefreshHook('getAttribute'));
        fillStats('.attributes-container', Constants.attributeCols, attrRange);

        const abilRange = makeRangeEl('setAbility', 0, Constants.maxPoints, makeStaticLabel, addRefreshHook('getAbility'));
        fillStats('.abilities-container', Constants.abilityCols, abilRange);

        const virtueRange = makeRangeEl('setVirtue', 1, Constants.maxPoints, makeStaticLabel, addRefreshHook('getVirtue'));
        fillVirtues('.virtues-container', Constants.virtues, virtueRange);

        const someState = makeRangeEl('setState', 0, Constants.extrasMaxPoints, nuller, addRefreshHook('getState'));
        addEl(queryEl('.humanity-container'), someState('humanity'));
        addEl(queryEl('.willpower-container'), someState('willpower'));
        addEl(queryEl('.willpower2-container'), someState('willpower2'));
        const someState2 = makeRangeEl3('setState', 0, 20, nuller, addRefreshHook('getState'));
        addEls(queryEl('.bloodpool-container'), someState2('bloodpool'));

        const meritInput = makeEntityRenameInput('setBackstory', 'merits', false);
        listen(queryEl('.merits-container .add-button'), 'click', makeInputBuilder('.merits-container', meritInput));
        addRefreshHook('getBackstory', 'merits', backstoryCb('.merits-container', meritInput));

        const flawInput = makeEntityRenameInput('setBackstory', 'flaws', false);
        listen(queryEl('.flaws-container .add-button'), 'click', makeInputBuilder('.flaws-container', flawInput));
        addRefreshHook('getBackstory', 'flaws', backstoryCb('.flaws-container', flawInput));

        const backgroundInput = makeAdvantageInput('renameAdvantage', 'backgrounds', 'setBackground');
        listen(queryEl('.backgrounds-container .add-button'), 'click', makeInputBuilder('.backgrounds-container', backgroundInput));
        addRefreshHook('getAdvantages', 'backgrounds', backstoryCb('.backgrounds-container', backgroundInput));

        const disciplineInput = makeAdvantageInput('renameAdvantage', 'disciplines', 'setDiscipline');
        listen(queryEl('.disciplines-container .add-button'), 'click', makeInputBuilder('.disciplines-container', disciplineInput));
        addRefreshHook('getAdvantages', 'disciplines', backstoryCb('.disciplines-container', disciplineInput));

        fillStats('.health-container', Constants.healthCols, makeHealthRow);

        listen(queryEl('.notes-content'), 'change', event => DBMS.setNotes(event.target.value, Utils.processError()));
        onRefresh(() => {
            DBMS.getNotes((err, value) => {
                if (err) { Utils.handleError(err); return; }
                queryEl('.notes-content').value = value;
            });
        });

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getSettings((err, settings) => {
            if (err) { Utils.handleError(err); return; }
            setStyle(queryEl('body'), 'background-color', settings.backgroundColor);
            queryEl(`${root}.background-color-input`).value = settings.backgroundColor;
            queryEl(`${root}.charsheet-background-color-input`).value = settings.charsheetBackColor;
            queryEl(`${root}.charsheet-back-mode`).value = settings.charsheetBackMode;
            let img = settings.charsheetBackImage;
            if (CommonUtils.startsWith(img, '..')) {
                img = img.substring(1);
            }
            //            setStyle(queryEl(`${root}.charsheet-background-image`), 'backgroundImage', `url(${img})`);
            let color;
            let image;
            switch (settings.charsheetBackMode) {
            case 'charsheet-image':
                color = 'transparent';
                image = `url(${img})`;
                break;
            case 'charsheet-none':
                color = 'transparent';
                image = 'none';
                break;
            case 'charsheet-color':
                color = settings.charsheetBackColor;
                image = 'none';
                break;
            default:
                throw new Error(`Unexpected mode ${settings.charsheetBackMode}`);
            }
            queryEls(`${root}.charsheet-page`).forEach((el) => {
                setImportantStyle(el, 'background-color', color);
                setImportantStyle(el, 'background-image', image);
            });

            state.refreshHooks.forEach(R.apply(R.__, []));
        });
    };

    function readImage(event) {
        const reader = new FileReader();
        reader.onload = (readerEvent) => {
            const imageData = readerEvent.target.result;
            // setStyle(queryEl(`${root}.charsheet-background-image`), 'backgroundImage', `url(${imageData})`);
            DBMS.setCharsheetBackImage(imageData, Utils.processError(exports.refresh));
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    function onBackgroundColorChange(event) {
        DBMS.setBackgroundColor(event.target.value, Utils.processError(exports.refresh));
    }
    function toDefaultImage(event) {
        DBMS.setCharsheetBackImage(Constants.defaultImg, Utils.processError(exports.refresh));
    }
    function onCharsheetBackColorChange(event) {
        DBMS.setCharsheetBackgroundColor(event.target.value, Utils.processError(exports.refresh));
    }
    function onCharsheetBackModeChange(event) {
        DBMS.setCharsheetBackMode(event.target.value, Utils.processError(exports.refresh));
    }

    function makeProfileEl(itemName) {
        const input = makeEl('input');
        addRefreshHook('getProfileItem', itemName, value => (input.value = value));
        listen(input, 'change', event =>
            DBMS.setProfileItem(itemName, event.target.value.trim(), Utils.processError()));
        return addEls(makeEl('div'), [fillText(makeEl('span'), itemName), input]);
    }

    // eslint-disable-next-line no-var,vars-on-top
    var fillVirtues = (selector, data, func) => addEls(queryEl(selector), data.map(func));

    function fillStats(selector, data, func) {
        addEls(queryEl(selector), data.map(obj =>
            // return addEls(makeEl('div'), makeRangeEls(obj, func));
            addEls(makeEl('div'), obj.arr.map(func))));
    }

    function makeHealthRow(val) {
        const icon = makeEl('img');
        icon.str = val.name;
        setAttr(icon, 'src', 'images/injure_deadly.svg');
        function setImg(num) {
            if (num === 0) {
                setAttr(icon, 'src', 'images/injure_no.svg');
            }
            if (num === 1) {
                setAttr(icon, 'src', 'images/injure_wound.svg');
            }
            if (num === 2) {
                setAttr(icon, 'src', 'images/injure_deadly.svg');
            }
            setClassByCondition(icon.parentNode, 'wounded', num !== 0);
        }

        addRefreshHook('getHealth', val.name, (num) => {
            icon.num = num;
            setImg(num);
        });

        listen(icon, 'click', (event) => {
            //            if (!event.ctrlKey && !event.metaKey) { return; }
            event.target.num = (event.target.num + 1) % 3;
            setImg(event.target.num);
            DBMS.setHealth(event.target.str, event.target.num, Utils.processError());
        });
        return addEls(addClass(makeEl('div'), 'health-stat'), [makeStaticLabel(val.name), icon,
            addEl(makeEl('span'), makeText(val.penalty))]);
    }

    function makeStaticLabel(label) {
        return fillText(makeEl('span'), label);
    }
    function nuller() {
        return null;
    }

    function rangeOnClick(setter, icons, min, max, itemNameCb) {
        return (event) => {
            //            if (!event.ctrlKey && !event.metaKey) { return; }
            const { target } = event;
            const isPointOn = getAttr(target, 'src') === 'images/radio-on-button.svg';
            let selected = isPointOn ? target.number - 1 : target.number;
            selected = selected < min ? min - 1 : selected;
            for (let j = 0; j < max; j++) {
                setAttr(icons[j], 'src', selected >= j ? 'images/radio-on-button.svg' : 'images/circumference.svg');
            }
            DBMS[setter](itemNameCb(), Number(selected + 1), Utils.processError());
        };
    }

    function rangeOnLoad(icons, max) {
        return (num) => {
            for (let i = 0; i < max; i++) {
                setAttr(icons[i], 'src', num > i ? 'images/radio-on-button.svg' : 'images/circumference.svg');
            }
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var makeRangeEl = R.curry((setter, min, max, labelMaker, initRange, itemName) => {
        const label = labelMaker(itemName);
        return makeRangeEl2(setter, min, max, label, initRange, R.always(itemName));
    });

    // eslint-disable-next-line no-var,vars-on-top
    var makeRangeEl2 = R.curry((setter, min, max, label, initRange, itemNameCb) => {
        const icons = [];
        for (let i = 0; i < max; i++) {
            const icon = makeEl('img');
            icon.number = i;
            listen(icon, 'click', rangeOnClick(setter, icons, min, max, itemNameCb));
            icons.push(icon);
        }

        const div = addEls(addClass(makeEl('div'), 'range-container'), icons.map(icon => addEl(makeEl('div'), icon)));
        initRange(itemNameCb(), rangeOnLoad(icons, max));
        const els = label != null ? [label, div] : [div];
        return addEls(addClass(makeEl('div'), 'stat-container'), els);
    });

    // eslint-disable-next-line no-var,vars-on-top
    var makeRangeEl3 = R.curry((setter, min, max, labelMaker, initRange, itemName) => {
        const label = labelMaker(itemName);
        const itemNameCb = R.always(itemName);
        const icons = [];
        for (let i = 0; i < max; i++) {
            const icon = makeEl('img');
            icon.number = i;
            listen(icon, 'click', rangeOnClick(setter, icons, min, max, itemNameCb));
            icons.push(icon);
        }

        const icons2Container = icons2 =>
            addEls(addClass(makeEl('div'), 'range-container'), icons2.map(icon => addEl(makeEl('div'), icon)));

        const divs = R.splitEvery(10, icons).map(icons2Container);
        initRange(itemNameCb(), rangeOnLoad(icons, max));
        const els = label != null ? R.prepend(label, divs) : divs;
        return els.map(el => addEl(addClass(makeEl('div'), 'stat-container'), el));
    });

    function makeInputBuilder(container, makeInput) {
        return (event) => {
            //            if (!event.ctrlKey && !event.metaKey) { return; }
            addEl(queryEl(`${container} .entity-container`), makeInput(null));
        };
    }

    function onInputChange(renameFunc, type, isPart) {
        return (event) => {
            const { oldName } = event.target;
            const newName = event.target.value;
            if (newName.trim() === '') {
                addClass(isPart ? event.target.parentNode : event.target, 'hidden');
            } else {
                event.target.oldName = newName.trim();
            }
            DBMS[renameFunc](type, oldName, newName, Utils.processError());
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var makeEntityRenameInput = R.curry((renameFunc, type, isPart, oldName) => {
        oldName = oldName || '';
        const input = makeEl('input');
        input.oldName = oldName;
        input.value = oldName;
        listen(input, 'change', onInputChange(renameFunc, type, isPart));
        return input;
    });
    // eslint-disable-next-line no-var,vars-on-top
    var makeAdvantageInput = R.curry((renameFunc, type, setter, pair) => {
        pair = pair || ['', 0];

        const labelMaker = makeEntityRenameInput(renameFunc, type, true);
        function initRange(str, rangeOnLoad2) {
            rangeOnLoad2(pair[1]);
        }
        const itemName = pair[0];
        const label = labelMaker(itemName);
        return makeRangeEl2(setter, 0, Constants.maxPoints, label, initRange, () => label.value);
    });

    function onRefreshHook(getter, itemName, callback) {
        return () => {
            DBMS[getter](itemName, (err, value) => {
                if (err) { Utils.handleError(err); return; }
                callback(value);
            });
        };
    }

    function fillText(el, str) {
        const l10nKey = `charsheet-${str}`;
        setAttr(el, 'l10n-id', l10nKey);
        return addEl(el, makeText(getL10n(l10nKey)));
    }
    // eslint-disable-next-line no-var,vars-on-top
    var backstoryCb = (container, inputMaker) =>
        arr => addEls(clearEl(queryEl(`${container} .entity-container`)), arr.map(inputMaker));
})(this.Charsheet = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const root = '.instruction-tab ';
    const state = {};

    exports.init = () => {
        exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };
})(this.Instruction = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const root = '.-tab ';
    const state = {};

    exports.init = () => {
        exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };
})(this.Template = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    exports.init = () => {
        exports.content = getEl('aboutDiv');
    };

    exports.refresh = () => {
    };
})(this.About = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    exports.init = () => {
        listen(getEl('logPageSelector'), 'change', (event) => {
            DBMS.getLog(Number(event.target.value), dataRecieved);
        });

        exports.content = getEl('logViewerDiv');
    };

    exports.refresh = () => {
        getEl('logPageSelector').selectedIndex = 0;
        DBMS.getLog(0, dataRecieved);
    };

    function dataRecieved(err, data) {
        if (err) { Utils.handleError(err); return; }

        const sel = getEl('logPageSelector');
        const { selectedIndex } = sel;
        clearEl(sel);

        const selData = [];
        for (let i = 0; i < data.logSize; i++) {
            selData.push({ name: i + 1, value: String(i), selected: selectedIndex === i });
        }
        fillSelector(sel, selData);

        const container = clearEl(getEl('logData'));

        R.ap([addEl(container)], data.requestedLog.map(makeRow));
    }

    function makeRow(rowData) {
        const tr = makeEl('tr');
        const addText = (text) => {
            addEl(tr, addEl(makeEl('td'), addEl(makeEl('span'), makeText(text))));
        };
        addText(rowData[0]);
        addText(new Date(rowData[2]).format('yyyy/mm/dd HH:MM:ss'));
        addText(rowData[1]);
        addText(rowData[3]);
        addText(rowData[4]);
        return tr;
    }
})(this.LogViewer = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};

    exports.init = () => {
        state.views = {};
        const nav = '.log-viewer2-tab .sub-tab-navigation';
        const content = '.log-viewer2-tab .sub-tab-content';
        const containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, 'logViewer', LogViewer, { mainPage: true });
        Utils.addView(containers, 'about', About);

        exports.content = queryEl('.log-viewer2-tab');
    };

    exports.refresh = () => {
        state.currentView.refresh();
    };
})(this.LogViewer2 = {});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL2NoYXJzaGVldC5qcyIsImpzL3BhZ2VzL2luc3RydWN0aW9uLmpzIiwianMvcGFnZXMvdGVtcGxhdGUuanMiLCJqcy9wYWdlcy9sb2dzL2Fib3V0LmpzIiwianMvcGFnZXMvbG9ncy9sb2dWaWV3ZXIuanMiLCJqcy9wYWdlcy9sb2dzL2xvZ1ZpZXdlcjIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxVUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InBhZ2VzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmNoYXJzaGVldC10YWIgJztcclxuICAgIGNvbnN0IHN0YXRlID0ge1xyXG4gICAgICAgIHJlZnJlc2hIb29rczogW11cclxuICAgIH07XHJcbiAgICBjb25zdCBvblJlZnJlc2ggPSBjYWxsYmFjayA9PiBzdGF0ZS5yZWZyZXNoSG9va3MucHVzaChjYWxsYmFjayk7XHJcbiAgICBjb25zdCBhZGRSZWZyZXNoSG9vayA9IFIuY3VycnkoKGdldHRlciwgaXRlbU5hbWUsIHJhbmdlT25Mb2FkMikgPT5cclxuICAgICAgICBvblJlZnJlc2gob25SZWZyZXNoSG9vayhnZXR0ZXIsIGl0ZW1OYW1lLCByYW5nZU9uTG9hZDIpKSk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmJhY2tncm91bmQtY29sb3ItaW5wdXRgKSwgJ2NoYW5nZScsIG9uQmFja2dyb3VuZENvbG9yQ2hhbmdlKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2VsID0gY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNoYXJzaGVldC1iYWNrLW1vZGVgKSk7XHJcbiAgICAgICAgZmlsbFNlbGVjdG9yKHNlbCwgY29uc3RBcnIyU2VsZWN0KENvbnN0YW50cy5jaGFyc2hlZXRCYWNrTW9kZXMpKTtcclxuICAgICAgICBsaXN0ZW4oc2VsLCAnY2hhbmdlJywgb25DaGFyc2hlZXRCYWNrTW9kZUNoYW5nZSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhcnNoZWV0LWJhY2tncm91bmQtY29sb3ItaW5wdXRgKSwgJ2NoYW5nZScsIG9uQ2hhcnNoZWV0QmFja0NvbG9yQ2hhbmdlKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5iYWNrLWltYWdlLXRvLWRlZmF1bHRgKSwgJ2NsaWNrJywgdG9EZWZhdWx0SW1hZ2UpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5jaGFyc2hlZXQtYmFja2dyb3VuZC1pbWFnZS1pbnB1dGApLCAnY2hhbmdlJywgcmVhZEltYWdlKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5jaGFyc2hlZXQtYmFja2dyb3VuZC1pbWFnZS1pbnB1dGApLCAnZm9jdXMnLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBlLnRhcmdldC52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBwcm9maWxlRWxzID0gQ29uc3RhbnRzLnByb2ZpbGVDb2xzLm1hcChSLm1hcChtYWtlUHJvZmlsZUVsKSkubWFwKGVscyA9PiBhZGRFbHMobWFrZUVsKCdkaXYnKSwgZWxzKSk7XHJcbiAgICAgICAgYWRkRWxzKHF1ZXJ5RWwoYCR7cm9vdH0ucHJvZmlsZS1jb250YWluZXJgKSwgcHJvZmlsZUVscyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGF0dHJSYW5nZSA9IG1ha2VSYW5nZUVsKCdzZXRBdHRyaWJ1dGUnLCAwLCBDb25zdGFudHMubWF4UG9pbnRzLCBtYWtlU3RhdGljTGFiZWwsIGFkZFJlZnJlc2hIb29rKCdnZXRBdHRyaWJ1dGUnKSk7XHJcbiAgICAgICAgZmlsbFN0YXRzKCcuYXR0cmlidXRlcy1jb250YWluZXInLCBDb25zdGFudHMuYXR0cmlidXRlQ29scywgYXR0clJhbmdlKTtcclxuXHJcbiAgICAgICAgY29uc3QgYWJpbFJhbmdlID0gbWFrZVJhbmdlRWwoJ3NldEFiaWxpdHknLCAwLCBDb25zdGFudHMubWF4UG9pbnRzLCBtYWtlU3RhdGljTGFiZWwsIGFkZFJlZnJlc2hIb29rKCdnZXRBYmlsaXR5JykpO1xyXG4gICAgICAgIGZpbGxTdGF0cygnLmFiaWxpdGllcy1jb250YWluZXInLCBDb25zdGFudHMuYWJpbGl0eUNvbHMsIGFiaWxSYW5nZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHZpcnR1ZVJhbmdlID0gbWFrZVJhbmdlRWwoJ3NldFZpcnR1ZScsIDEsIENvbnN0YW50cy5tYXhQb2ludHMsIG1ha2VTdGF0aWNMYWJlbCwgYWRkUmVmcmVzaEhvb2soJ2dldFZpcnR1ZScpKTtcclxuICAgICAgICBmaWxsVmlydHVlcygnLnZpcnR1ZXMtY29udGFpbmVyJywgQ29uc3RhbnRzLnZpcnR1ZXMsIHZpcnR1ZVJhbmdlKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc29tZVN0YXRlID0gbWFrZVJhbmdlRWwoJ3NldFN0YXRlJywgMCwgQ29uc3RhbnRzLmV4dHJhc01heFBvaW50cywgbnVsbGVyLCBhZGRSZWZyZXNoSG9vaygnZ2V0U3RhdGUnKSk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnLmh1bWFuaXR5LWNvbnRhaW5lcicpLCBzb21lU3RhdGUoJ2h1bWFuaXR5JykpO1xyXG4gICAgICAgIGFkZEVsKHF1ZXJ5RWwoJy53aWxscG93ZXItY29udGFpbmVyJyksIHNvbWVTdGF0ZSgnd2lsbHBvd2VyJykpO1xyXG4gICAgICAgIGFkZEVsKHF1ZXJ5RWwoJy53aWxscG93ZXIyLWNvbnRhaW5lcicpLCBzb21lU3RhdGUoJ3dpbGxwb3dlcjInKSk7XHJcbiAgICAgICAgY29uc3Qgc29tZVN0YXRlMiA9IG1ha2VSYW5nZUVsMygnc2V0U3RhdGUnLCAwLCAyMCwgbnVsbGVyLCBhZGRSZWZyZXNoSG9vaygnZ2V0U3RhdGUnKSk7XHJcbiAgICAgICAgYWRkRWxzKHF1ZXJ5RWwoJy5ibG9vZHBvb2wtY29udGFpbmVyJyksIHNvbWVTdGF0ZTIoJ2Jsb29kcG9vbCcpKTtcclxuXHJcbiAgICAgICAgY29uc3QgbWVyaXRJbnB1dCA9IG1ha2VFbnRpdHlSZW5hbWVJbnB1dCgnc2V0QmFja3N0b3J5JywgJ21lcml0cycsIGZhbHNlKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbCgnLm1lcml0cy1jb250YWluZXIgLmFkZC1idXR0b24nKSwgJ2NsaWNrJywgbWFrZUlucHV0QnVpbGRlcignLm1lcml0cy1jb250YWluZXInLCBtZXJpdElucHV0KSk7XHJcbiAgICAgICAgYWRkUmVmcmVzaEhvb2soJ2dldEJhY2tzdG9yeScsICdtZXJpdHMnLCBiYWNrc3RvcnlDYignLm1lcml0cy1jb250YWluZXInLCBtZXJpdElucHV0KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZsYXdJbnB1dCA9IG1ha2VFbnRpdHlSZW5hbWVJbnB1dCgnc2V0QmFja3N0b3J5JywgJ2ZsYXdzJywgZmFsc2UpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKCcuZmxhd3MtY29udGFpbmVyIC5hZGQtYnV0dG9uJyksICdjbGljaycsIG1ha2VJbnB1dEJ1aWxkZXIoJy5mbGF3cy1jb250YWluZXInLCBmbGF3SW5wdXQpKTtcclxuICAgICAgICBhZGRSZWZyZXNoSG9vaygnZ2V0QmFja3N0b3J5JywgJ2ZsYXdzJywgYmFja3N0b3J5Q2IoJy5mbGF3cy1jb250YWluZXInLCBmbGF3SW5wdXQpKTtcclxuXHJcbiAgICAgICAgY29uc3QgYmFja2dyb3VuZElucHV0ID0gbWFrZUFkdmFudGFnZUlucHV0KCdyZW5hbWVBZHZhbnRhZ2UnLCAnYmFja2dyb3VuZHMnLCAnc2V0QmFja2dyb3VuZCcpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKCcuYmFja2dyb3VuZHMtY29udGFpbmVyIC5hZGQtYnV0dG9uJyksICdjbGljaycsIG1ha2VJbnB1dEJ1aWxkZXIoJy5iYWNrZ3JvdW5kcy1jb250YWluZXInLCBiYWNrZ3JvdW5kSW5wdXQpKTtcclxuICAgICAgICBhZGRSZWZyZXNoSG9vaygnZ2V0QWR2YW50YWdlcycsICdiYWNrZ3JvdW5kcycsIGJhY2tzdG9yeUNiKCcuYmFja2dyb3VuZHMtY29udGFpbmVyJywgYmFja2dyb3VuZElucHV0KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRpc2NpcGxpbmVJbnB1dCA9IG1ha2VBZHZhbnRhZ2VJbnB1dCgncmVuYW1lQWR2YW50YWdlJywgJ2Rpc2NpcGxpbmVzJywgJ3NldERpc2NpcGxpbmUnKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbCgnLmRpc2NpcGxpbmVzLWNvbnRhaW5lciAuYWRkLWJ1dHRvbicpLCAnY2xpY2snLCBtYWtlSW5wdXRCdWlsZGVyKCcuZGlzY2lwbGluZXMtY29udGFpbmVyJywgZGlzY2lwbGluZUlucHV0KSk7XHJcbiAgICAgICAgYWRkUmVmcmVzaEhvb2soJ2dldEFkdmFudGFnZXMnLCAnZGlzY2lwbGluZXMnLCBiYWNrc3RvcnlDYignLmRpc2NpcGxpbmVzLWNvbnRhaW5lcicsIGRpc2NpcGxpbmVJbnB1dCkpO1xyXG5cclxuICAgICAgICBmaWxsU3RhdHMoJy5oZWFsdGgtY29udGFpbmVyJywgQ29uc3RhbnRzLmhlYWx0aENvbHMsIG1ha2VIZWFsdGhSb3cpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbCgnLm5vdGVzLWNvbnRlbnQnKSwgJ2NoYW5nZScsIGV2ZW50ID0+IERCTVMuc2V0Tm90ZXMoZXZlbnQudGFyZ2V0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSkpO1xyXG4gICAgICAgIG9uUmVmcmVzaCgoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuZ2V0Tm90ZXMoKGVyciwgdmFsdWUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBxdWVyeUVsKCcubm90ZXMtY29udGVudCcpLnZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRTZXR0aW5ncygoZXJyLCBzZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBzZXRTdHlsZShxdWVyeUVsKCdib2R5JyksICdiYWNrZ3JvdW5kLWNvbG9yJywgc2V0dGluZ3MuYmFja2dyb3VuZENvbG9yKTtcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fS5iYWNrZ3JvdW5kLWNvbG9yLWlucHV0YCkudmFsdWUgPSBzZXR0aW5ncy5iYWNrZ3JvdW5kQ29sb3I7XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0uY2hhcnNoZWV0LWJhY2tncm91bmQtY29sb3ItaW5wdXRgKS52YWx1ZSA9IHNldHRpbmdzLmNoYXJzaGVldEJhY2tDb2xvcjtcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fS5jaGFyc2hlZXQtYmFjay1tb2RlYCkudmFsdWUgPSBzZXR0aW5ncy5jaGFyc2hlZXRCYWNrTW9kZTtcclxuICAgICAgICAgICAgbGV0IGltZyA9IHNldHRpbmdzLmNoYXJzaGVldEJhY2tJbWFnZTtcclxuICAgICAgICAgICAgaWYgKENvbW1vblV0aWxzLnN0YXJ0c1dpdGgoaW1nLCAnLi4nKSkge1xyXG4gICAgICAgICAgICAgICAgaW1nID0gaW1nLnN1YnN0cmluZygxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIHNldFN0eWxlKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhcnNoZWV0LWJhY2tncm91bmQtaW1hZ2VgKSwgJ2JhY2tncm91bmRJbWFnZScsIGB1cmwoJHtpbWd9KWApO1xyXG4gICAgICAgICAgICBsZXQgY29sb3I7XHJcbiAgICAgICAgICAgIGxldCBpbWFnZTtcclxuICAgICAgICAgICAgc3dpdGNoIChzZXR0aW5ncy5jaGFyc2hlZXRCYWNrTW9kZSkge1xyXG4gICAgICAgICAgICBjYXNlICdjaGFyc2hlZXQtaW1hZ2UnOlxyXG4gICAgICAgICAgICAgICAgY29sb3IgPSAndHJhbnNwYXJlbnQnO1xyXG4gICAgICAgICAgICAgICAgaW1hZ2UgPSBgdXJsKCR7aW1nfSlgO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoYXJzaGVldC1ub25lJzpcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gJ3RyYW5zcGFyZW50JztcclxuICAgICAgICAgICAgICAgIGltYWdlID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoYXJzaGVldC1jb2xvcic6XHJcbiAgICAgICAgICAgICAgICBjb2xvciA9IHNldHRpbmdzLmNoYXJzaGVldEJhY2tDb2xvcjtcclxuICAgICAgICAgICAgICAgIGltYWdlID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgbW9kZSAke3NldHRpbmdzLmNoYXJzaGVldEJhY2tNb2RlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9LmNoYXJzaGVldC1wYWdlYCkuZm9yRWFjaCgoZWwpID0+IHtcclxuICAgICAgICAgICAgICAgIHNldEltcG9ydGFudFN0eWxlKGVsLCAnYmFja2dyb3VuZC1jb2xvcicsIGNvbG9yKTtcclxuICAgICAgICAgICAgICAgIHNldEltcG9ydGFudFN0eWxlKGVsLCAnYmFja2dyb3VuZC1pbWFnZScsIGltYWdlKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBzdGF0ZS5yZWZyZXNoSG9va3MuZm9yRWFjaChSLmFwcGx5KFIuX18sIFtdKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlYWRJbWFnZShldmVudCkge1xyXG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChyZWFkZXJFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbWFnZURhdGEgPSByZWFkZXJFdmVudC50YXJnZXQucmVzdWx0O1xyXG4gICAgICAgICAgICAvLyBzZXRTdHlsZShxdWVyeUVsKGAke3Jvb3R9LmNoYXJzaGVldC1iYWNrZ3JvdW5kLWltYWdlYCksICdiYWNrZ3JvdW5kSW1hZ2UnLCBgdXJsKCR7aW1hZ2VEYXRhfSlgKTtcclxuICAgICAgICAgICAgREJNUy5zZXRDaGFyc2hlZXRCYWNrSW1hZ2UoaW1hZ2VEYXRhLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChldmVudC50YXJnZXQuZmlsZXNbMF0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQmFja2dyb3VuZENvbG9yQ2hhbmdlKGV2ZW50KSB7XHJcbiAgICAgICAgREJNUy5zZXRCYWNrZ3JvdW5kQ29sb3IoZXZlbnQudGFyZ2V0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiB0b0RlZmF1bHRJbWFnZShldmVudCkge1xyXG4gICAgICAgIERCTVMuc2V0Q2hhcnNoZWV0QmFja0ltYWdlKENvbnN0YW50cy5kZWZhdWx0SW1nLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBvbkNoYXJzaGVldEJhY2tDb2xvckNoYW5nZShldmVudCkge1xyXG4gICAgICAgIERCTVMuc2V0Q2hhcnNoZWV0QmFja2dyb3VuZENvbG9yKGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gb25DaGFyc2hlZXRCYWNrTW9kZUNoYW5nZShldmVudCkge1xyXG4gICAgICAgIERCTVMuc2V0Q2hhcnNoZWV0QmFja01vZGUoZXZlbnQudGFyZ2V0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVByb2ZpbGVFbChpdGVtTmFtZSkge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIGFkZFJlZnJlc2hIb29rKCdnZXRQcm9maWxlSXRlbScsIGl0ZW1OYW1lLCB2YWx1ZSA9PiAoaW5wdXQudmFsdWUgPSB2YWx1ZSkpO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIGV2ZW50ID0+XHJcbiAgICAgICAgICAgIERCTVMuc2V0UHJvZmlsZUl0ZW0oaXRlbU5hbWUsIGV2ZW50LnRhcmdldC52YWx1ZS50cmltKCksIFV0aWxzLnByb2Nlc3NFcnJvcigpKSk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ2RpdicpLCBbZmlsbFRleHQobWFrZUVsKCdzcGFuJyksIGl0ZW1OYW1lKSwgaW5wdXRdKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZmlsbFZpcnR1ZXMgPSAoc2VsZWN0b3IsIGRhdGEsIGZ1bmMpID0+IGFkZEVscyhxdWVyeUVsKHNlbGVjdG9yKSwgZGF0YS5tYXAoZnVuYykpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxTdGF0cyhzZWxlY3RvciwgZGF0YSwgZnVuYykge1xyXG4gICAgICAgIGFkZEVscyhxdWVyeUVsKHNlbGVjdG9yKSwgZGF0YS5tYXAob2JqID0+XHJcbiAgICAgICAgICAgIC8vIHJldHVybiBhZGRFbHMobWFrZUVsKCdkaXYnKSwgbWFrZVJhbmdlRWxzKG9iaiwgZnVuYykpO1xyXG4gICAgICAgICAgICBhZGRFbHMobWFrZUVsKCdkaXYnKSwgb2JqLmFyci5tYXAoZnVuYykpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUhlYWx0aFJvdyh2YWwpIHtcclxuICAgICAgICBjb25zdCBpY29uID0gbWFrZUVsKCdpbWcnKTtcclxuICAgICAgICBpY29uLnN0ciA9IHZhbC5uYW1lO1xyXG4gICAgICAgIHNldEF0dHIoaWNvbiwgJ3NyYycsICdpbWFnZXMvaW5qdXJlX2RlYWRseS5zdmcnKTtcclxuICAgICAgICBmdW5jdGlvbiBzZXRJbWcobnVtKSB7XHJcbiAgICAgICAgICAgIGlmIChudW0gPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoaWNvbiwgJ3NyYycsICdpbWFnZXMvaW5qdXJlX25vLnN2ZycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChudW0gPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoaWNvbiwgJ3NyYycsICdpbWFnZXMvaW5qdXJlX3dvdW5kLnN2ZycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChudW0gPT09IDIpIHtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoaWNvbiwgJ3NyYycsICdpbWFnZXMvaW5qdXJlX2RlYWRseS5zdmcnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGljb24ucGFyZW50Tm9kZSwgJ3dvdW5kZWQnLCBudW0gIT09IDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYWRkUmVmcmVzaEhvb2soJ2dldEhlYWx0aCcsIHZhbC5uYW1lLCAobnVtKSA9PiB7XHJcbiAgICAgICAgICAgIGljb24ubnVtID0gbnVtO1xyXG4gICAgICAgICAgICBzZXRJbWcobnVtKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGljb24sICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIGlmICghZXZlbnQuY3RybEtleSAmJiAhZXZlbnQubWV0YUtleSkgeyByZXR1cm47IH1cclxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0Lm51bSA9IChldmVudC50YXJnZXQubnVtICsgMSkgJSAzO1xyXG4gICAgICAgICAgICBzZXRJbWcoZXZlbnQudGFyZ2V0Lm51bSk7XHJcbiAgICAgICAgICAgIERCTVMuc2V0SGVhbHRoKGV2ZW50LnRhcmdldC5zdHIsIGV2ZW50LnRhcmdldC5udW0sIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdoZWFsdGgtc3RhdCcpLCBbbWFrZVN0YXRpY0xhYmVsKHZhbC5uYW1lKSwgaWNvbixcclxuICAgICAgICAgICAgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KHZhbC5wZW5hbHR5KSldKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlU3RhdGljTGFiZWwobGFiZWwpIHtcclxuICAgICAgICByZXR1cm4gZmlsbFRleHQobWFrZUVsKCdzcGFuJyksIGxhYmVsKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIG51bGxlcigpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByYW5nZU9uQ2xpY2soc2V0dGVyLCBpY29ucywgbWluLCBtYXgsIGl0ZW1OYW1lQ2IpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgaWYgKCFldmVudC5jdHJsS2V5ICYmICFldmVudC5tZXRhS2V5KSB7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCB7IHRhcmdldCB9ID0gZXZlbnQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzUG9pbnRPbiA9IGdldEF0dHIodGFyZ2V0LCAnc3JjJykgPT09ICdpbWFnZXMvcmFkaW8tb24tYnV0dG9uLnN2Zyc7XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZCA9IGlzUG9pbnRPbiA/IHRhcmdldC5udW1iZXIgLSAxIDogdGFyZ2V0Lm51bWJlcjtcclxuICAgICAgICAgICAgc2VsZWN0ZWQgPSBzZWxlY3RlZCA8IG1pbiA/IG1pbiAtIDEgOiBzZWxlY3RlZDtcclxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtYXg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihpY29uc1tqXSwgJ3NyYycsIHNlbGVjdGVkID49IGogPyAnaW1hZ2VzL3JhZGlvLW9uLWJ1dHRvbi5zdmcnIDogJ2ltYWdlcy9jaXJjdW1mZXJlbmNlLnN2ZycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIERCTVNbc2V0dGVyXShpdGVtTmFtZUNiKCksIE51bWJlcihzZWxlY3RlZCArIDEpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByYW5nZU9uTG9hZChpY29ucywgbWF4KSB7XHJcbiAgICAgICAgcmV0dXJuIChudW0pID0+IHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihpY29uc1tpXSwgJ3NyYycsIG51bSA+IGkgPyAnaW1hZ2VzL3JhZGlvLW9uLWJ1dHRvbi5zdmcnIDogJ2ltYWdlcy9jaXJjdW1mZXJlbmNlLnN2ZycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgbWFrZVJhbmdlRWwgPSBSLmN1cnJ5KChzZXR0ZXIsIG1pbiwgbWF4LCBsYWJlbE1ha2VyLCBpbml0UmFuZ2UsIGl0ZW1OYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGFiZWwgPSBsYWJlbE1ha2VyKGl0ZW1OYW1lKTtcclxuICAgICAgICByZXR1cm4gbWFrZVJhbmdlRWwyKHNldHRlciwgbWluLCBtYXgsIGxhYmVsLCBpbml0UmFuZ2UsIFIuYWx3YXlzKGl0ZW1OYW1lKSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgbWFrZVJhbmdlRWwyID0gUi5jdXJyeSgoc2V0dGVyLCBtaW4sIG1heCwgbGFiZWwsIGluaXRSYW5nZSwgaXRlbU5hbWVDYikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGljb25zID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpY29uID0gbWFrZUVsKCdpbWcnKTtcclxuICAgICAgICAgICAgaWNvbi5udW1iZXIgPSBpO1xyXG4gICAgICAgICAgICBsaXN0ZW4oaWNvbiwgJ2NsaWNrJywgcmFuZ2VPbkNsaWNrKHNldHRlciwgaWNvbnMsIG1pbiwgbWF4LCBpdGVtTmFtZUNiKSk7XHJcbiAgICAgICAgICAgIGljb25zLnB1c2goaWNvbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBkaXYgPSBhZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3JhbmdlLWNvbnRhaW5lcicpLCBpY29ucy5tYXAoaWNvbiA9PiBhZGRFbChtYWtlRWwoJ2RpdicpLCBpY29uKSkpO1xyXG4gICAgICAgIGluaXRSYW5nZShpdGVtTmFtZUNiKCksIHJhbmdlT25Mb2FkKGljb25zLCBtYXgpKTtcclxuICAgICAgICBjb25zdCBlbHMgPSBsYWJlbCAhPSBudWxsID8gW2xhYmVsLCBkaXZdIDogW2Rpdl07XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnc3RhdC1jb250YWluZXInKSwgZWxzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBtYWtlUmFuZ2VFbDMgPSBSLmN1cnJ5KChzZXR0ZXIsIG1pbiwgbWF4LCBsYWJlbE1ha2VyLCBpbml0UmFuZ2UsIGl0ZW1OYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbGFiZWwgPSBsYWJlbE1ha2VyKGl0ZW1OYW1lKTtcclxuICAgICAgICBjb25zdCBpdGVtTmFtZUNiID0gUi5hbHdheXMoaXRlbU5hbWUpO1xyXG4gICAgICAgIGNvbnN0IGljb25zID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpY29uID0gbWFrZUVsKCdpbWcnKTtcclxuICAgICAgICAgICAgaWNvbi5udW1iZXIgPSBpO1xyXG4gICAgICAgICAgICBsaXN0ZW4oaWNvbiwgJ2NsaWNrJywgcmFuZ2VPbkNsaWNrKHNldHRlciwgaWNvbnMsIG1pbiwgbWF4LCBpdGVtTmFtZUNiKSk7XHJcbiAgICAgICAgICAgIGljb25zLnB1c2goaWNvbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpY29uczJDb250YWluZXIgPSBpY29uczIgPT5cclxuICAgICAgICAgICAgYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdyYW5nZS1jb250YWluZXInKSwgaWNvbnMyLm1hcChpY29uID0+IGFkZEVsKG1ha2VFbCgnZGl2JyksIGljb24pKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRpdnMgPSBSLnNwbGl0RXZlcnkoMTAsIGljb25zKS5tYXAoaWNvbnMyQ29udGFpbmVyKTtcclxuICAgICAgICBpbml0UmFuZ2UoaXRlbU5hbWVDYigpLCByYW5nZU9uTG9hZChpY29ucywgbWF4KSk7XHJcbiAgICAgICAgY29uc3QgZWxzID0gbGFiZWwgIT0gbnVsbCA/IFIucHJlcGVuZChsYWJlbCwgZGl2cykgOiBkaXZzO1xyXG4gICAgICAgIHJldHVybiBlbHMubWFwKGVsID0+IGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdzdGF0LWNvbnRhaW5lcicpLCBlbCkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUlucHV0QnVpbGRlcihjb250YWluZXIsIG1ha2VJbnB1dCkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICBpZiAoIWV2ZW50LmN0cmxLZXkgJiYgIWV2ZW50Lm1ldGFLZXkpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGFkZEVsKHF1ZXJ5RWwoYCR7Y29udGFpbmVyfSAuZW50aXR5LWNvbnRhaW5lcmApLCBtYWtlSW5wdXQobnVsbCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25JbnB1dENoYW5nZShyZW5hbWVGdW5jLCB0eXBlLCBpc1BhcnQpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgb2xkTmFtZSB9ID0gZXZlbnQudGFyZ2V0O1xyXG4gICAgICAgICAgICBjb25zdCBuZXdOYW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICBpZiAobmV3TmFtZS50cmltKCkgPT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpc1BhcnQgPyBldmVudC50YXJnZXQucGFyZW50Tm9kZSA6IGV2ZW50LnRhcmdldCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0Lm9sZE5hbWUgPSBuZXdOYW1lLnRyaW0oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBEQk1TW3JlbmFtZUZ1bmNdKHR5cGUsIG9sZE5hbWUsIG5ld05hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBtYWtlRW50aXR5UmVuYW1lSW5wdXQgPSBSLmN1cnJ5KChyZW5hbWVGdW5jLCB0eXBlLCBpc1BhcnQsIG9sZE5hbWUpID0+IHtcclxuICAgICAgICBvbGROYW1lID0gb2xkTmFtZSB8fCAnJztcclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBpbnB1dC5vbGROYW1lID0gb2xkTmFtZTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IG9sZE5hbWU7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgb25JbnB1dENoYW5nZShyZW5hbWVGdW5jLCB0eXBlLCBpc1BhcnQpKTtcclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9KTtcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBtYWtlQWR2YW50YWdlSW5wdXQgPSBSLmN1cnJ5KChyZW5hbWVGdW5jLCB0eXBlLCBzZXR0ZXIsIHBhaXIpID0+IHtcclxuICAgICAgICBwYWlyID0gcGFpciB8fCBbJycsIDBdO1xyXG5cclxuICAgICAgICBjb25zdCBsYWJlbE1ha2VyID0gbWFrZUVudGl0eVJlbmFtZUlucHV0KHJlbmFtZUZ1bmMsIHR5cGUsIHRydWUpO1xyXG4gICAgICAgIGZ1bmN0aW9uIGluaXRSYW5nZShzdHIsIHJhbmdlT25Mb2FkMikge1xyXG4gICAgICAgICAgICByYW5nZU9uTG9hZDIocGFpclsxXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGl0ZW1OYW1lID0gcGFpclswXTtcclxuICAgICAgICBjb25zdCBsYWJlbCA9IGxhYmVsTWFrZXIoaXRlbU5hbWUpO1xyXG4gICAgICAgIHJldHVybiBtYWtlUmFuZ2VFbDIoc2V0dGVyLCAwLCBDb25zdGFudHMubWF4UG9pbnRzLCBsYWJlbCwgaW5pdFJhbmdlLCAoKSA9PiBsYWJlbC52YWx1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBvblJlZnJlc2hIb29rKGdldHRlciwgaXRlbU5hbWUsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgREJNU1tnZXR0ZXJdKGl0ZW1OYW1lLCAoZXJyLCB2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHZhbHVlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBmaWxsVGV4dChlbCwgc3RyKSB7XHJcbiAgICAgICAgY29uc3QgbDEwbktleSA9IGBjaGFyc2hlZXQtJHtzdHJ9YDtcclxuICAgICAgICBzZXRBdHRyKGVsLCAnbDEwbi1pZCcsIGwxMG5LZXkpO1xyXG4gICAgICAgIHJldHVybiBhZGRFbChlbCwgbWFrZVRleHQoZ2V0TDEwbihsMTBuS2V5KSkpO1xyXG4gICAgfVxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGJhY2tzdG9yeUNiID0gKGNvbnRhaW5lciwgaW5wdXRNYWtlcikgPT5cclxuICAgICAgICBhcnIgPT4gYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtjb250YWluZXJ9IC5lbnRpdHktY29udGFpbmVyYCkpLCBhcnIubWFwKGlucHV0TWFrZXIpKTtcclxufSkodGhpcy5DaGFyc2hlZXQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmluc3RydWN0aW9uLXRhYiAnO1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG5cclxuICAgIH07XHJcbn0pKHRoaXMuSW5zdHJ1Y3Rpb24gPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLi10YWIgJztcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuXHJcbiAgICB9O1xyXG59KSh0aGlzLlRlbXBsYXRlID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gZ2V0RWwoJ2Fib3V0RGl2Jyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgIH07XHJcbn0pKHRoaXMuQWJvdXQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2xvZ1BhZ2VTZWxlY3RvcicpLCAnY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuZ2V0TG9nKE51bWJlcihldmVudC50YXJnZXQudmFsdWUpLCBkYXRhUmVjaWV2ZWQpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnbG9nVmlld2VyRGl2Jyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBnZXRFbCgnbG9nUGFnZVNlbGVjdG9yJykuc2VsZWN0ZWRJbmRleCA9IDA7XHJcbiAgICAgICAgREJNUy5nZXRMb2coMCwgZGF0YVJlY2lldmVkKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gZGF0YVJlY2lldmVkKGVyciwgZGF0YSkge1xyXG4gICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgIGNvbnN0IHNlbCA9IGdldEVsKCdsb2dQYWdlU2VsZWN0b3InKTtcclxuICAgICAgICBjb25zdCB7IHNlbGVjdGVkSW5kZXggfSA9IHNlbDtcclxuICAgICAgICBjbGVhckVsKHNlbCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNlbERhdGEgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubG9nU2l6ZTsgaSsrKSB7XHJcbiAgICAgICAgICAgIHNlbERhdGEucHVzaCh7IG5hbWU6IGkgKyAxLCB2YWx1ZTogU3RyaW5nKGkpLCBzZWxlY3RlZDogc2VsZWN0ZWRJbmRleCA9PT0gaSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZmlsbFNlbGVjdG9yKHNlbCwgc2VsRGF0YSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGNsZWFyRWwoZ2V0RWwoJ2xvZ0RhdGEnKSk7XHJcblxyXG4gICAgICAgIFIuYXAoW2FkZEVsKGNvbnRhaW5lcildLCBkYXRhLnJlcXVlc3RlZExvZy5tYXAobWFrZVJvdykpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VSb3cocm93RGF0YSkge1xyXG4gICAgICAgIGNvbnN0IHRyID0gbWFrZUVsKCd0cicpO1xyXG4gICAgICAgIGNvbnN0IGFkZFRleHQgPSAodGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBhZGRFbCh0ciwgYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQodGV4dCkpKSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBhZGRUZXh0KHJvd0RhdGFbMF0pO1xyXG4gICAgICAgIGFkZFRleHQobmV3IERhdGUocm93RGF0YVsyXSkuZm9ybWF0KCd5eXl5L21tL2RkIEhIOk1NOnNzJykpO1xyXG4gICAgICAgIGFkZFRleHQocm93RGF0YVsxXSk7XHJcbiAgICAgICAgYWRkVGV4dChyb3dEYXRhWzNdKTtcclxuICAgICAgICBhZGRUZXh0KHJvd0RhdGFbNF0pO1xyXG4gICAgICAgIHJldHVybiB0cjtcclxuICAgIH1cclxufSkodGhpcy5Mb2dWaWV3ZXIgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLnZpZXdzID0ge307XHJcbiAgICAgICAgY29uc3QgbmF2ID0gJy5sb2ctdmlld2VyMi10YWIgLnN1Yi10YWItbmF2aWdhdGlvbic7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9ICcubG9nLXZpZXdlcjItdGFiIC5zdWItdGFiLWNvbnRlbnQnO1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKG5hdiksXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IHF1ZXJ5RWwoY29udGVudClcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ2xvZ1ZpZXdlcicsIExvZ1ZpZXdlciwgeyBtYWluUGFnZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdhYm91dCcsIEFib3V0KTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbCgnLmxvZy12aWV3ZXIyLXRhYicpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuY3VycmVudFZpZXcucmVmcmVzaCgpO1xyXG4gICAgfTtcclxufSkodGhpcy5Mb2dWaWV3ZXIyID0ge30pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
