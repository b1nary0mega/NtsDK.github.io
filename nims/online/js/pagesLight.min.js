/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */


"use strict";

(function(exports){
    
    var root = ".enter-tab ";
    
    exports.init = function () {
        $(document.forms['login-form']).on('submit', submit);
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {

    };
            
    var submit = function() {
        var form = $(this);

        $('.error', form).html('');
//        $(":submit", form).button("loading");

        var request = $.ajax({
            url : "/login",
            method : "POST",
            data : form.serialize(),
            complete : function() {
                $(":submit", form).button("reset");
            },
//             statusCode : {
//                 200 : function() {
//                 },
//                 403 : function(jqXHR) {
//                     var error = JSON.parse(jqXHR.responseText);
//                     $('.error', form).html(error.message);
//                 }
//             }
        });
        request.done(function(data) {
//             //window.location.href = "/chat";
//             window.location.href = "/nims.html";
            window.location.href = "/page.html";
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            var msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch(err){
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
//             var error = JSON.parse(jqXHR.responseText);
//             $('.error', form).html(error.message); 
//            $('.error', form).html(textStatus); 
            $('.error', form).html(msg); 
        });
        
        return false;
    };
    
})(this['Enter']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){

    var root = '.player-tab ';
    var characterProfileDiv = root + ".character-profile-div";
    var playerProfileDiv = root + ".player-profile-div";
    var playerHeader = root + '.player-profile-header';
    var characterHeader = root + '.character-profile-header';
    
    var profileEditorCore;
    
    exports.init = function() {
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        DBMS.getWelcomeText(function(err, text){
            if(err) {Utils.handleError(err); return;}
            DBMS.getPlayerProfileInfo(function(err, profileInfo){
                if(err) {Utils.handleError(err); return;}
                DBMS.getPlayersOptions(function(err, playersOptions){
                    if(err) {Utils.handleError(err); return;}
                    buildInterface(text, profileInfo, playersOptions);
                });
            });
        });
    };
    
    var isEditable = function(profileName, profileStructure){
        return R.find(R.propEq('name', profileName), profileStructure).playerAccess === 'write';
    };
    
    var buildInterface = function(text, profileInfo, playersOptions){
        profileEditorCore.initProfileStructure(playerProfileDiv, 'player', profileInfo.player.profileStructure);
        profileEditorCore.fillProfileInformation(playerProfileDiv, 'player', profileInfo.player.profile, isEditable);
        addEl(clearEl(queryEl(playerHeader)), makeText(strFormat(getL10n('briefings-player-profile'), [profileInfo.player.profile.name])));
        
        if(profileInfo.character === undefined){
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [''])));
            var el = clearEl(queryEl(characterProfileDiv));
            if(playersOptions.allowCharacterCreation){
                var label = addEl(makeEl('div'), makeText(getL10n('profiles-player-has-no-character-and-can-create-it')));
                var input = setAttr(makeEl('input'), 'placeholder', getL10n('profiles-character-name'));
                var button = addEl(makeEl('button'), makeText(getL10n('common-create')));
                listen(button, 'click', function(){
                    DBMS.createCharacterByPlayer(input.value.trim(), Utils.processError(exports.refresh));
                });
                addEls(el, [label, input, button]);
            } else {
                addEl(el, addEl(makeEl('span'), makeText(getL10n('profiles-player-has-no-character-and-cant-create-it'))));
            }
        } else {
            profileEditorCore.initProfileStructure(characterProfileDiv, 'character', profileInfo.character.profileStructure);
            profileEditorCore.fillProfileInformation(characterProfileDiv, 'character', profileInfo.character.profile, isEditable);
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [profileInfo.character.profile.name])));
        }
        
        queryEl(root + '.welcome-text-area'     ).value = text;
    };
    
})(this['Player']={});
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */


"use strict";

(function(exports){
    
    var root = ".register-tab ";
    
    exports.init = function () {
        $(document.forms['register-form']).on('submit', submit);
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {

    };
            
    var submit = function() {
        var form = $(this);

        $('.error', form).html('');
        $(":submit", form).button("loading");

        var request = $.ajax({
            url : "/register",
            method : "POST",
            data : form.serialize(),
            complete : function() {
                $(":submit", form).button("reset");
            },
        });
        request.done(function(data) {
            form.html(getL10n('entrance-register-success')).addClass('alert-success');
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            var msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch(err){
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
            $('.error', form).html(msg); 
        });
        
        return false;
    };
    
})(this['Register']={});
/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var About = {};

About.init = function() {
    "use strict";

    About.content = getEl('aboutDiv');
};

About.refresh = function() {
};

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    exports.makeProfileEditorCore = function(){
        var innerExports = {};
        
        var state = {
            'character':{},
            'player':{}
        };
        
        innerExports.initProfileStructure = function(profileDiv, type, profileStructure, callback){
            var tbody = makeEl("tbody");
            addEl(clearEl(queryEl(profileDiv)), addEl(addClasses(makeEl("table"), ["table", 'table-striped']), tbody))
            
            state[type].inputItems = {};
            state[type].profileStructure = profileStructure;
            try {
                addEls(tbody, profileStructure.map(appendInput(type)));
            } catch (err) {
                Utils.handleError(err); return;
            }
            
            if(callback) callback();
        };
        
        var appendInput = R.curry(function (type, profileItemConfig) {
            var itemInput = new ProfileItemInput(type, profileItemConfig);
            state[type].inputItems[profileItemConfig.name] = itemInput;
            return addEls(makeEl("tr"), [addEl(makeEl("td"), makeText(profileItemConfig.name)), addEl(makeEl("td"), itemInput.dom)]);
        });
        
        innerExports.fillProfileInformation = function(profileDiv, type, profile, isEditable){
            removeClass(queryEl(profileDiv),'hidden');
            R.values(state[type].inputItems).forEach(itemInput => {
                if(itemInput.type === 'multiEnum'){
                    itemInput.multiEnumSelect.prop("disabled", !isEditable(itemInput.name, state[type].profileStructure));
                } else {
                    Utils.enableEl(itemInput.dom, isEditable(itemInput.name, state[type].profileStructure));
                }
            });
            
            state[type].name = profile.name;
            Object.values(state[type].inputItems).forEach(function(item){
                item.showFieldValue(profile);
            });
        };
        
        function ProfileItemInput(profileType, profileItemConfig){
            var input;
            switch (profileItemConfig.type) {
            case "text":
                input = makeEl("textarea");
                addClass(input, "profileTextInput");
                break;
            case "string":
                input = makeEl("input");
                addClass(input, "profileStringInput");
                break;
            case "enum":
                input = makeEl("select");
                addClass(input, "profileSelectInput");
                fillSelector(input, profileItemConfig.value.split(",").map(R.compose(R.zipObj(['name']), R.append(R.__, []))));
                break;
            case "number":
                input = makeEl("input");
                input.type = "number";
                break;
            case "checkbox":
                input = makeEl("input");
                input.type = "checkbox";
                break;
            case "multiEnum":
                this.multiEnumSelect = $("<select></select>");
                setAttr(this.multiEnumSelect[0], 'style', 'width: 400px;');
                addClass(this.multiEnumSelect[0], 'common-select');
                addClass(this.multiEnumSelect[0], 'profileStringInput');
                input = $("<span></span>").append(this.multiEnumSelect)[0];
                setAttr(this.multiEnumSelect[0], 'multiple', 'multiple');

                var sel = this.multiEnumSelect.select2(arr2Select2(profileItemConfig.value.split(",")));
                
                sel.on('change', this.updateFieldValue.bind(this));
                break;
            default:
                throw new Errors.InternalError('errors-unexpected-switch-argument', [profileItemConfig.type]);
            }
            
            if(profileItemConfig.type !== 'multiEnum'){
                listen(input, "change", this.updateFieldValue.bind(this));
            }
            
            this.dom = input;
            this.type = profileItemConfig.type;
            this.profileType = profileType;
            this.name = profileItemConfig.name;
        };
        
        ProfileItemInput.prototype.showFieldValue = function(profile){
            if (this.type === "checkbox") {
                this.dom.checked = profile[this.name];
            } else if (this.type === "multiEnum") {
                this.multiEnumSelect.val(profile[this.name] === '' ? null : profile[this.name].split(',')).trigger("change");
            } else {
                this.dom.value = profile[this.name];
            }
            this.oldValue = profile[this.name];
        };
        
        ProfileItemInput.prototype.updateFieldValue = function(event){
            var fieldName = this.name;
            var profileName = state[this.profileType].name;
            if(this.multiEnumSelect && this.multiEnumSelect.prop("disabled")){
                return; // we need to trigger change event on multiEnumSelect to update selection. It may be disabled so it has false positive call.
            }
            
            var value;
            switch(this.type){
            case "text":
            case "string":
            case "enum":
                value = this.dom.value;
                break;
            case "number":
                if (isNaN(this.dom.value)) {
                    Utils.alert(getL10n("profiles-not-a-number"));
                    this.dom.value = this.oldValue;
                    return;
                }
                value = Number(this.dom.value);
                break;
            case "checkbox":
                value = this.dom.checked;
                break;
            case "multiEnum":
                value = this.multiEnumSelect.val().join(',');
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [this.type])); 
                return;
            }
            DBMS.updateProfileField(this.profileType, profileName, fieldName, this.type, value, Utils.processError());
        };
        
        return innerExports;
    }
    
})(this['ProfileEditorCore']={});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL2VudGVyLmpzIiwianMvcGFnZXMvcGxheWVyLmpzIiwianMvcGFnZXMvcmVnaXN0ZXIuanMiLCJqcy9wYWdlcy9sb2dzL2Fib3V0LmpzIiwianMvcGFnZXMvcHJvZmlsZXMvcHJvZmlsZUVkaXRvckNvcmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InBhZ2VzTGlnaHQubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xuXG4vKmdsb2JhbFxuIFV0aWxzLCBEQk1TXG4gKi9cblxuXG5cInVzZSBzdHJpY3RcIjtcblxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xuICAgIFxuICAgIHZhciByb290ID0gXCIuZW50ZXItdGFiIFwiO1xuICAgIFxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJChkb2N1bWVudC5mb3Jtc1snbG9naW4tZm9ybSddKS5vbignc3VibWl0Jywgc3VibWl0KTtcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcbiAgICB9O1xuICAgIFxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgfTtcbiAgICAgICAgICAgIFxuICAgIHZhciBzdWJtaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIGZvcm0gPSAkKHRoaXMpO1xuXG4gICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoJycpO1xuLy8gICAgICAgICQoXCI6c3VibWl0XCIsIGZvcm0pLmJ1dHRvbihcImxvYWRpbmdcIik7XG5cbiAgICAgICAgdmFyIHJlcXVlc3QgPSAkLmFqYXgoe1xuICAgICAgICAgICAgdXJsIDogXCIvbG9naW5cIixcbiAgICAgICAgICAgIG1ldGhvZCA6IFwiUE9TVFwiLFxuICAgICAgICAgICAgZGF0YSA6IGZvcm0uc2VyaWFsaXplKCksXG4gICAgICAgICAgICBjb21wbGV0ZSA6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICQoXCI6c3VibWl0XCIsIGZvcm0pLmJ1dHRvbihcInJlc2V0XCIpO1xuICAgICAgICAgICAgfSxcbi8vICAgICAgICAgICAgIHN0YXR1c0NvZGUgOiB7XG4vLyAgICAgICAgICAgICAgICAgMjAwIDogZnVuY3Rpb24oKSB7XG4vLyAgICAgICAgICAgICAgICAgfSxcbi8vICAgICAgICAgICAgICAgICA0MDMgOiBmdW5jdGlvbihqcVhIUikge1xuLy8gICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGpxWEhSLnJlc3BvbnNlVGV4dCk7XG4vLyAgICAgICAgICAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoZXJyb3IubWVzc2FnZSk7XG4vLyAgICAgICAgICAgICAgICAgfVxuLy8gICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcbi8vICAgICAgICAgICAgIC8vd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9jaGF0XCI7XG4vLyAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IFwiL25pbXMuaHRtbFwiO1xuICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9wYWdlLmh0bWxcIjtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXF1ZXN0LmZhaWwoZnVuY3Rpb24oZXJyb3JJbmZvLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xuICAgICAgICAgICAgdmFyIG1zZztcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coSlNPTi5wYXJzZShlcnJvckluZm8ucmVzcG9uc2VUZXh0KSk7XG4gICAgICAgICAgICB9IGNhdGNoKGVycil7XG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCB8fCB0ZXh0U3RhdHVzIHx8ICdlcnJvcicpO1xuICAgICAgICAgICAgfVxuLy8gICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShqcVhIUi5yZXNwb25zZVRleHQpO1xuLy8gICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChlcnJvci5tZXNzYWdlKTsgXG4vLyAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwodGV4dFN0YXR1cyk7IFxuICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChtc2cpOyBcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICBcbn0pKHRoaXNbJ0VudGVyJ109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cblxuLypnbG9iYWxcbiBVdGlscywgREJNU1xuICovXG5cblwidXNlIHN0cmljdFwiO1xuXG4oZnVuY3Rpb24oZXhwb3J0cyl7XG5cbiAgICB2YXIgcm9vdCA9ICcucGxheWVyLXRhYiAnO1xuICAgIHZhciBjaGFyYWN0ZXJQcm9maWxlRGl2ID0gcm9vdCArIFwiLmNoYXJhY3Rlci1wcm9maWxlLWRpdlwiO1xuICAgIHZhciBwbGF5ZXJQcm9maWxlRGl2ID0gcm9vdCArIFwiLnBsYXllci1wcm9maWxlLWRpdlwiO1xuICAgIHZhciBwbGF5ZXJIZWFkZXIgPSByb290ICsgJy5wbGF5ZXItcHJvZmlsZS1oZWFkZXInO1xuICAgIHZhciBjaGFyYWN0ZXJIZWFkZXIgPSByb290ICsgJy5jaGFyYWN0ZXItcHJvZmlsZS1oZWFkZXInO1xuICAgIFxuICAgIHZhciBwcm9maWxlRWRpdG9yQ29yZTtcbiAgICBcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUgPSBQcm9maWxlRWRpdG9yQ29yZS5tYWtlUHJvZmlsZUVkaXRvckNvcmUoKTtcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcbiAgICB9O1xuICAgIFxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBEQk1TLmdldFdlbGNvbWVUZXh0KGZ1bmN0aW9uKGVyciwgdGV4dCl7XG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxuICAgICAgICAgICAgREJNUy5nZXRQbGF5ZXJQcm9maWxlSW5mbyhmdW5jdGlvbihlcnIsIHByb2ZpbGVJbmZvKXtcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UGxheWVyc09wdGlvbnMoZnVuY3Rpb24oZXJyLCBwbGF5ZXJzT3B0aW9ucyl7XG4gICAgICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkSW50ZXJmYWNlKHRleHQsIHByb2ZpbGVJbmZvLCBwbGF5ZXJzT3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICBcbiAgICB2YXIgaXNFZGl0YWJsZSA9IGZ1bmN0aW9uKHByb2ZpbGVOYW1lLCBwcm9maWxlU3RydWN0dXJlKXtcbiAgICAgICAgcmV0dXJuIFIuZmluZChSLnByb3BFcSgnbmFtZScsIHByb2ZpbGVOYW1lKSwgcHJvZmlsZVN0cnVjdHVyZSkucGxheWVyQWNjZXNzID09PSAnd3JpdGUnO1xuICAgIH07XG4gICAgXG4gICAgdmFyIGJ1aWxkSW50ZXJmYWNlID0gZnVuY3Rpb24odGV4dCwgcHJvZmlsZUluZm8sIHBsYXllcnNPcHRpb25zKXtcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuaW5pdFByb2ZpbGVTdHJ1Y3R1cmUocGxheWVyUHJvZmlsZURpdiwgJ3BsYXllcicsIHByb2ZpbGVJbmZvLnBsYXllci5wcm9maWxlU3RydWN0dXJlKTtcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbihwbGF5ZXJQcm9maWxlRGl2LCAncGxheWVyJywgcHJvZmlsZUluZm8ucGxheWVyLnByb2ZpbGUsIGlzRWRpdGFibGUpO1xuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwocGxheWVySGVhZGVyKSksIG1ha2VUZXh0KHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3MtcGxheWVyLXByb2ZpbGUnKSwgW3Byb2ZpbGVJbmZvLnBsYXllci5wcm9maWxlLm5hbWVdKSkpO1xuICAgICAgICBcbiAgICAgICAgaWYocHJvZmlsZUluZm8uY2hhcmFjdGVyID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKGNoYXJhY3RlckhlYWRlcikpLCBtYWtlVGV4dChzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLWNoYXJhY3Rlci1wcm9maWxlJyksIFsnJ10pKSk7XG4gICAgICAgICAgICB2YXIgZWwgPSBjbGVhckVsKHF1ZXJ5RWwoY2hhcmFjdGVyUHJvZmlsZURpdikpO1xuICAgICAgICAgICAgaWYocGxheWVyc09wdGlvbnMuYWxsb3dDaGFyYWN0ZXJDcmVhdGlvbil7XG4gICAgICAgICAgICAgICAgdmFyIGxhYmVsID0gYWRkRWwobWFrZUVsKCdkaXYnKSwgbWFrZVRleHQoZ2V0TDEwbigncHJvZmlsZXMtcGxheWVyLWhhcy1uby1jaGFyYWN0ZXItYW5kLWNhbi1jcmVhdGUtaXQnKSkpO1xuICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IHNldEF0dHIobWFrZUVsKCdpbnB1dCcpLCAncGxhY2Vob2xkZXInLCBnZXRMMTBuKCdwcm9maWxlcy1jaGFyYWN0ZXItbmFtZScpKTtcbiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uID0gYWRkRWwobWFrZUVsKCdidXR0b24nKSwgbWFrZVRleHQoZ2V0TDEwbignY29tbW9uLWNyZWF0ZScpKSk7XG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgREJNUy5jcmVhdGVDaGFyYWN0ZXJCeVBsYXllcihpbnB1dC52YWx1ZS50cmltKCksIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhZGRFbHMoZWwsIFtsYWJlbCwgaW5wdXQsIGJ1dHRvbl0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhZGRFbChlbCwgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KGdldEwxMG4oJ3Byb2ZpbGVzLXBsYXllci1oYXMtbm8tY2hhcmFjdGVyLWFuZC1jYW50LWNyZWF0ZS1pdCcpKSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuaW5pdFByb2ZpbGVTdHJ1Y3R1cmUoY2hhcmFjdGVyUHJvZmlsZURpdiwgJ2NoYXJhY3RlcicsIHByb2ZpbGVJbmZvLmNoYXJhY3Rlci5wcm9maWxlU3RydWN0dXJlKTtcbiAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmZpbGxQcm9maWxlSW5mb3JtYXRpb24oY2hhcmFjdGVyUHJvZmlsZURpdiwgJ2NoYXJhY3RlcicsIHByb2ZpbGVJbmZvLmNoYXJhY3Rlci5wcm9maWxlLCBpc0VkaXRhYmxlKTtcbiAgICAgICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChjaGFyYWN0ZXJIZWFkZXIpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1jaGFyYWN0ZXItcHJvZmlsZScpLCBbcHJvZmlsZUluZm8uY2hhcmFjdGVyLnByb2ZpbGUubmFtZV0pKSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHF1ZXJ5RWwocm9vdCArICcud2VsY29tZS10ZXh0LWFyZWEnICAgICApLnZhbHVlID0gdGV4dDtcbiAgICB9O1xuICAgIFxufSkodGhpc1snUGxheWVyJ109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cblxuLypnbG9iYWxcbiBVdGlscywgREJNU1xuICovXG5cblxuXCJ1c2Ugc3RyaWN0XCI7XG5cbihmdW5jdGlvbihleHBvcnRzKXtcbiAgICBcbiAgICB2YXIgcm9vdCA9IFwiLnJlZ2lzdGVyLXRhYiBcIjtcbiAgICBcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICQoZG9jdW1lbnQuZm9ybXNbJ3JlZ2lzdGVyLWZvcm0nXSkub24oJ3N1Ym1pdCcsIHN1Ym1pdCk7XG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XG4gICAgfTtcbiAgICBcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcblxuICAgIH07XG4gICAgICAgICAgICBcbiAgICB2YXIgc3VibWl0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBmb3JtID0gJCh0aGlzKTtcblxuICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKCcnKTtcbiAgICAgICAgJChcIjpzdWJtaXRcIiwgZm9ybSkuYnV0dG9uKFwibG9hZGluZ1wiKTtcblxuICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XG4gICAgICAgICAgICB1cmwgOiBcIi9yZWdpc3RlclwiLFxuICAgICAgICAgICAgbWV0aG9kIDogXCJQT1NUXCIsXG4gICAgICAgICAgICBkYXRhIDogZm9ybS5zZXJpYWxpemUoKSxcbiAgICAgICAgICAgIGNvbXBsZXRlIDogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgJChcIjpzdWJtaXRcIiwgZm9ybSkuYnV0dG9uKFwicmVzZXRcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIGZvcm0uaHRtbChnZXRMMTBuKCdlbnRyYW5jZS1yZWdpc3Rlci1zdWNjZXNzJykpLmFkZENsYXNzKCdhbGVydC1zdWNjZXNzJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmVxdWVzdC5mYWlsKGZ1bmN0aW9uKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcbiAgICAgICAgICAgIHZhciBtc2c7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG1zZyA9IFV0aWxzLmhhbmRsZUVycm9yTXNnKEpTT04ucGFyc2UoZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCkpO1xuICAgICAgICAgICAgfSBjYXRjaChlcnIpe1xuICAgICAgICAgICAgICAgIG1zZyA9IFV0aWxzLmhhbmRsZUVycm9yTXNnKGVycm9ySW5mby5yZXNwb25zZVRleHQgfHwgdGV4dFN0YXR1cyB8fCAnZXJyb3InKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwobXNnKTsgXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG4gICAgXG59KSh0aGlzWydSZWdpc3RlciddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE2IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBBYm91dCA9IHt9O1xyXG5cclxuQWJvdXQuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgQWJvdXQuY29udGVudCA9IGdldEVsKCdhYm91dERpdicpO1xyXG59O1xyXG5cclxuQWJvdXQucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG59O1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5tYWtlUHJvZmlsZUVkaXRvckNvcmUgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIHZhciBpbm5lckV4cG9ydHMgPSB7fTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgc3RhdGUgPSB7XHJcbiAgICAgICAgICAgICdjaGFyYWN0ZXInOnt9LFxyXG4gICAgICAgICAgICAncGxheWVyJzp7fVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgaW5uZXJFeHBvcnRzLmluaXRQcm9maWxlU3RydWN0dXJlID0gZnVuY3Rpb24ocHJvZmlsZURpdiwgdHlwZSwgcHJvZmlsZVN0cnVjdHVyZSwgY2FsbGJhY2spe1xyXG4gICAgICAgICAgICB2YXIgdGJvZHkgPSBtYWtlRWwoXCJ0Ym9keVwiKTtcclxuICAgICAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKHByb2ZpbGVEaXYpKSwgYWRkRWwoYWRkQ2xhc3NlcyhtYWtlRWwoXCJ0YWJsZVwiKSwgW1widGFibGVcIiwgJ3RhYmxlLXN0cmlwZWQnXSksIHRib2R5KSlcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLmlucHV0SXRlbXMgPSB7fTtcclxuICAgICAgICAgICAgc3RhdGVbdHlwZV0ucHJvZmlsZVN0cnVjdHVyZSA9IHByb2ZpbGVTdHJ1Y3R1cmU7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHModGJvZHksIHByb2ZpbGVTdHJ1Y3R1cmUubWFwKGFwcGVuZElucHV0KHR5cGUpKSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2soKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciBhcHBlbmRJbnB1dCA9IFIuY3VycnkoZnVuY3Rpb24gKHR5cGUsIHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIHZhciBpdGVtSW5wdXQgPSBuZXcgUHJvZmlsZUl0ZW1JbnB1dCh0eXBlLCBwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLmlucHV0SXRlbXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBpdGVtSW5wdXQ7XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKFwidHJcIiksIFthZGRFbChtYWtlRWwoXCJ0ZFwiKSwgbWFrZVRleHQocHJvZmlsZUl0ZW1Db25maWcubmFtZSkpLCBhZGRFbChtYWtlRWwoXCJ0ZFwiKSwgaXRlbUlucHV0LmRvbSldKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBpbm5lckV4cG9ydHMuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbiA9IGZ1bmN0aW9uKHByb2ZpbGVEaXYsIHR5cGUsIHByb2ZpbGUsIGlzRWRpdGFibGUpe1xyXG4gICAgICAgICAgICByZW1vdmVDbGFzcyhxdWVyeUVsKHByb2ZpbGVEaXYpLCdoaWRkZW4nKTtcclxuICAgICAgICAgICAgUi52YWx1ZXMoc3RhdGVbdHlwZV0uaW5wdXRJdGVtcykuZm9yRWFjaChpdGVtSW5wdXQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYoaXRlbUlucHV0LnR5cGUgPT09ICdtdWx0aUVudW0nKXtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtSW5wdXQubXVsdGlFbnVtU2VsZWN0LnByb3AoXCJkaXNhYmxlZFwiLCAhaXNFZGl0YWJsZShpdGVtSW5wdXQubmFtZSwgc3RhdGVbdHlwZV0ucHJvZmlsZVN0cnVjdHVyZSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChpdGVtSW5wdXQuZG9tLCBpc0VkaXRhYmxlKGl0ZW1JbnB1dC5uYW1lLCBzdGF0ZVt0eXBlXS5wcm9maWxlU3RydWN0dXJlKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc3RhdGVbdHlwZV0ubmFtZSA9IHByb2ZpbGUubmFtZTtcclxuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhzdGF0ZVt0eXBlXS5pbnB1dEl0ZW1zKS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pe1xyXG4gICAgICAgICAgICAgICAgaXRlbS5zaG93RmllbGRWYWx1ZShwcm9maWxlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBmdW5jdGlvbiBQcm9maWxlSXRlbUlucHV0KHByb2ZpbGVUeXBlLCBwcm9maWxlSXRlbUNvbmZpZyl7XHJcbiAgICAgICAgICAgIHZhciBpbnB1dDtcclxuICAgICAgICAgICAgc3dpdGNoIChwcm9maWxlSXRlbUNvbmZpZy50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJ0ZXh0XCI6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbChcInRleHRhcmVhXCIpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwicHJvZmlsZVRleHRJbnB1dFwiKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwic3RyaW5nXCI6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbChcImlucHV0XCIpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwicHJvZmlsZVN0cmluZ0lucHV0XCIpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJlbnVtXCI6XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9IG1ha2VFbChcInNlbGVjdFwiKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBcInByb2ZpbGVTZWxlY3RJbnB1dFwiKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihpbnB1dCwgcHJvZmlsZUl0ZW1Db25maWcudmFsdWUuc3BsaXQoXCIsXCIpLm1hcChSLmNvbXBvc2UoUi56aXBPYmooWyduYW1lJ10pLCBSLmFwcGVuZChSLl9fLCBbXSkpKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIm51bWJlclwiOlxyXG4gICAgICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICAgICAgICAgIGlucHV0LnR5cGUgPSBcIm51bWJlclwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJjaGVja2JveFwiOlxyXG4gICAgICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICAgICAgICAgIGlucHV0LnR5cGUgPSBcImNoZWNrYm94XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIm11bHRpRW51bVwiOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5tdWx0aUVudW1TZWxlY3QgPSAkKFwiPHNlbGVjdD48L3NlbGVjdD5cIik7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKHRoaXMubXVsdGlFbnVtU2VsZWN0WzBdLCAnc3R5bGUnLCAnd2lkdGg6IDQwMHB4OycpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3ModGhpcy5tdWx0aUVudW1TZWxlY3RbMF0sICdjb21tb24tc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyh0aGlzLm11bHRpRW51bVNlbGVjdFswXSwgJ3Byb2ZpbGVTdHJpbmdJbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgaW5wdXQgPSAkKFwiPHNwYW4+PC9zcGFuPlwiKS5hcHBlbmQodGhpcy5tdWx0aUVudW1TZWxlY3QpWzBdO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cih0aGlzLm11bHRpRW51bVNlbGVjdFswXSwgJ211bHRpcGxlJywgJ211bHRpcGxlJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHNlbCA9IHRoaXMubXVsdGlFbnVtU2VsZWN0LnNlbGVjdDIoYXJyMlNlbGVjdDIocHJvZmlsZUl0ZW1Db25maWcudmFsdWUuc3BsaXQoXCIsXCIpKSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHNlbC5vbignY2hhbmdlJywgdGhpcy51cGRhdGVGaWVsZFZhbHVlLmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3JzLkludGVybmFsRXJyb3IoJ2Vycm9ycy11bmV4cGVjdGVkLXN3aXRjaC1hcmd1bWVudCcsIFtwcm9maWxlSXRlbUNvbmZpZy50eXBlXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUgIT09ICdtdWx0aUVudW0nKXtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgXCJjaGFuZ2VcIiwgdGhpcy51cGRhdGVGaWVsZFZhbHVlLmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0aGlzLmRvbSA9IGlucHV0O1xyXG4gICAgICAgICAgICB0aGlzLnR5cGUgPSBwcm9maWxlSXRlbUNvbmZpZy50eXBlO1xyXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVUeXBlID0gcHJvZmlsZVR5cGU7XHJcbiAgICAgICAgICAgIHRoaXMubmFtZSA9IHByb2ZpbGVJdGVtQ29uZmlnLm5hbWU7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBQcm9maWxlSXRlbUlucHV0LnByb3RvdHlwZS5zaG93RmllbGRWYWx1ZSA9IGZ1bmN0aW9uKHByb2ZpbGUpe1xyXG4gICAgICAgICAgICBpZiAodGhpcy50eXBlID09PSBcImNoZWNrYm94XCIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tLmNoZWNrZWQgPSBwcm9maWxlW3RoaXMubmFtZV07XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlID09PSBcIm11bHRpRW51bVwiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm11bHRpRW51bVNlbGVjdC52YWwocHJvZmlsZVt0aGlzLm5hbWVdID09PSAnJyA/IG51bGwgOiBwcm9maWxlW3RoaXMubmFtZV0uc3BsaXQoJywnKSkudHJpZ2dlcihcImNoYW5nZVwiKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tLnZhbHVlID0gcHJvZmlsZVt0aGlzLm5hbWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmFsdWUgPSBwcm9maWxlW3RoaXMubmFtZV07XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBQcm9maWxlSXRlbUlucHV0LnByb3RvdHlwZS51cGRhdGVGaWVsZFZhbHVlID0gZnVuY3Rpb24oZXZlbnQpe1xyXG4gICAgICAgICAgICB2YXIgZmllbGROYW1lID0gdGhpcy5uYW1lO1xyXG4gICAgICAgICAgICB2YXIgcHJvZmlsZU5hbWUgPSBzdGF0ZVt0aGlzLnByb2ZpbGVUeXBlXS5uYW1lO1xyXG4gICAgICAgICAgICBpZih0aGlzLm11bHRpRW51bVNlbGVjdCAmJiB0aGlzLm11bHRpRW51bVNlbGVjdC5wcm9wKFwiZGlzYWJsZWRcIikpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuOyAvLyB3ZSBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIGV2ZW50IG9uIG11bHRpRW51bVNlbGVjdCB0byB1cGRhdGUgc2VsZWN0aW9uLiBJdCBtYXkgYmUgZGlzYWJsZWQgc28gaXQgaGFzIGZhbHNlIHBvc2l0aXZlIGNhbGwuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciB2YWx1ZTtcclxuICAgICAgICAgICAgc3dpdGNoKHRoaXMudHlwZSl7XHJcbiAgICAgICAgICAgIGNhc2UgXCJ0ZXh0XCI6XHJcbiAgICAgICAgICAgIGNhc2UgXCJzdHJpbmdcIjpcclxuICAgICAgICAgICAgY2FzZSBcImVudW1cIjpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5kb20udmFsdWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIm51bWJlclwiOlxyXG4gICAgICAgICAgICAgICAgaWYgKGlzTmFOKHRoaXMuZG9tLnZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oXCJwcm9maWxlcy1ub3QtYS1udW1iZXJcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZG9tLnZhbHVlID0gdGhpcy5vbGRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IE51bWJlcih0aGlzLmRvbS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcImNoZWNrYm94XCI6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZG9tLmNoZWNrZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIm11bHRpRW51bVwiOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLm11bHRpRW51bVNlbGVjdC52YWwoKS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKG5ldyBFcnJvcnMuSW50ZXJuYWxFcnJvcignZXJyb3JzLXVuZXhwZWN0ZWQtc3dpdGNoLWFyZ3VtZW50JywgW3RoaXMudHlwZV0pKTsgXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgREJNUy51cGRhdGVQcm9maWxlRmllbGQodGhpcy5wcm9maWxlVHlwZSwgcHJvZmlsZU5hbWUsIGZpZWxkTmFtZSwgdGhpcy50eXBlLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIGlubmVyRXhwb3J0cztcclxuICAgIH1cclxuICAgIFxyXG59KSh0aGlzWydQcm9maWxlRWRpdG9yQ29yZSddPXt9KTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
