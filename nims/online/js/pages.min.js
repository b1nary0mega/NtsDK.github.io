"use strict";var AccessManager={};AccessManager.init=function(){var e=getEl("createUserButton");e.addEventListener("click",AccessManager.createUser),e=getEl("changePasswordButton"),e.addEventListener("click",AccessManager.changePassword),e=getEl("removeUserButton"),e.addEventListener("click",AccessManager.removeUser),e=getEl("assignPermissionButton"),e.addEventListener("click",AccessManager.assignPermission),e=getEl("removePermissionButton"),e.addEventListener("click",AccessManager.removePermission),e=getEl("newAdminButton"),e.addEventListener("click",AccessManager.assignNewAdmin),e=getEl("removeEditorButton"),e.addEventListener("click",AccessManager.removeEditor),e=getEl("newEditorButton"),e.addEventListener("click",AccessManager.assignEditor);var t,i,n=document.getElementsByClassName("adaptationRights");for(t=0;t<n.length;t++)i=n[t],i.addEventListener("click",AccessManager.changeAdaptationRightsMode);AccessManager.content=getEl("accessManagerDiv")},AccessManager.refresh=function(){DBMS.getUsersInfo(function(e,t){return e?void Utils.handleError(e):void PermissionInformer.isAdmin(function(e,i){return e?void Utils.handleError(e):void PermissionInformer.isEditor(function(e,n){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!i,function(e,r){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!i,function(e,o){return e?void Utils.handleError(e):(!i&&n&&(r=r.filter(function(e){return e.isOwner}),o=o.filter(function(e){return e.isOwner})),AccessManager.rebuildInterface(r,o,t),Utils.enable(AccessManager.content,"adminOnly",i),void Utils.enable(AccessManager.content,"editorOrAdmin",i||n))})})})})})},Utils.rebuildSelector=function(e,t){clearEl(e),t.forEach(function(t){var i=makeEl("option");i.appendChild(makeText(t.displayName)),i.value=t.value,e.appendChild(i)})},Utils.rebuildSelectorArr=function(e,t){clearEl(e),t.forEach(function(t){var i=makeEl("option");i.appendChild(makeText(t)),e.appendChild(i)})},AccessManager.rebuildInterface=function(e,t,i){var n=i.usersInfo,r=Object.keys(n).sort(CommonUtils.charOrdA),o=[];o.push(getEl("passwordUserName")),o.push(getEl("userPermissionSelector")),o.push(getEl("newEditorSelector")),o.forEach(function(e){Utils.rebuildSelectorArr(e,r)});var s=r.slice(0);s.splice(r.indexOf(i.admin),1);var a=getEl("newAdminSelector");Utils.rebuildSelectorArr(a,s),a=getEl("userRemoveSelector"),Utils.rebuildSelectorArr(a,s),a=getEl("storyPermissionSelector"),Utils.rebuildSelector(a,t),a=getEl("characterPermissionSelector"),Utils.rebuildSelector(a,e),addEl(clearEl(getEl("currentAdministrator")),makeText(i.admin));var l=clearEl(getEl("currentEditor"));i.editor&&addEl(l,makeText(i.editor)),getEl("adaptationRights"+i.adaptationRights).checked=!0;var h=function(e){if(R.isArrayLike(e))return e.map(function(e){return h(e)});if(R.is(Object,e)){var t=addEl(makeEl("li"),makeText(e.name)),i=makeEl("ol");return h(e.values).forEach(function(e){e.forEach(addEl(i))}),[t,i]}return[addEl(makeEl("li"),makeText(e))]},c=clearEl(getEl("permissionTable")),d=makeEl("ul");addEl(c,d);var u=addEl(d),f=getL10n("admins-characters-header"),p=getL10n("admins-stories-header"),m=r.map(function(e){return{name:e,values:[{name:f,values:n[e].characters},{name:p,values:n[e].stories}]}}),A=R.curry(function(e,t){return r.every(function(i){return-1===n[i][e].indexOf(t)})});t=t.map(R.prop("value")).filter(A("stories")),e=e.map(R.prop("value")).filter(A("characters")),m.push({name:getL10n("admins-have-not-owner"),values:[{name:f,values:e},{name:p,values:t}]}),h(m).forEach(function(e){e.forEach(u)})},AccessManager.createUser=function(){var e=getEl("userNameInput"),t=e.value.trim();if(""===t)return void Utils.alert(getL10n("admins-user-name-is-not-specified"));var i=getEl("userPasswordInput"),n=i.value.trim();return""===n?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.isUserNameUsed(t,function(e,i){return e?void Utils.handleError(e):void(i?Utils.alert(getL10n("admins-user-already-exists")):DBMS.createUser(t,n,Utils.processError(AccessManager.refresh)))})},AccessManager.changePassword=function(){var e=getEl("passwordUserName").value.trim(),t=getEl("newPassword").value.trim();return""===t?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.changePassword(e,t,Utils.processError(AccessManager.refresh))},AccessManager.removeUser=function(){var e=getEl("userRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-user-remove"),[e]))&&DBMS.removeUser(e,Utils.processError(AccessManager.refresh))},AccessManager.removePermission=function(){var e=getEl("userPermissionSelector").value.trim();if(""===e)return void Utils.alert(getL10n("admins-user-is-not-selected"));for(var t=getEl("storyPermissionSelector").selectedOptions,i=[],n=0;n<t.length;n++)i.push(t[n].value);t=getEl("characterPermissionSelector").selectedOptions;for(var r=[],n=0;n<t.length;n++)r.push(t[n].value);DBMS.removePermission(e,i,r,Utils.processError(AccessManager.refresh))},AccessManager.assignPermission=function(){var e=getEl("userPermissionSelector").value.trim();if(""===e)return void Utils.alert(getL10n("admins-user-is-not-selected"));for(var t=getEl("storyPermissionSelector").selectedOptions,i=[],n=0;n<t.length;n++)i.push(t[n].value);t=getEl("characterPermissionSelector").selectedOptions;for(var r=[],n=0;n<t.length;n++)r.push(t[n].value);DBMS.assignPermission(e,i,r,Utils.processError(AccessManager.refresh))},AccessManager.assignNewAdmin=function(){var e=getEl("newAdminSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-admin-assigment"),[e]))&&DBMS.assignAdmin(e,Utils.processError(AccessManager.refresh))},AccessManager.removeEditor=function(){DBMS.removeEditor(Utils.processError(AccessManager.refresh))},AccessManager.assignEditor=function(){var e=getEl("newEditorSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-editor-assigment"),[e]))&&DBMS.assignEditor(e,Utils.processError(AccessManager.refresh))},AccessManager.changeAdaptationRightsMode=function(e){DBMS.changeAdaptationRightsMode(e.target.value,Utils.processError())};var BriefingExport={};BriefingExport.templates={},BriefingExport.init=function(){listen(getEl("makeDefaultTextBriefings"),"click",function(){BriefingExport.resolveTextTemplate(function(e){BriefingExport.makeTextBriefings("txt",e)})}),listen(getEl("makeCustomTextBriefings"),"click",function(){BriefingExport.makeTextBriefings(getEl("textTypeSelector").value,getEl("templateArea").value)});var e=getEl("docxBriefings");e.addEventListener("change",BriefingExport.readTemplateFile);for(var t=document.querySelectorAll("#briefingExportDiv input[name=exportSelection]"),i=0;i<t.length;i++)listen(t[i],"change",BriefingExport.onExportSelectionChange);getEl("exportSelectionAll").checked=!0,e=getEl("briefingNumberSelector"),Constants.briefingNumber.forEach(R.compose(addEl(e),makeOpt)),listen(e,"change",BriefingExport.onNumberSelectorChange),BriefingExport.briefingNumberSelector=e,BriefingExport.briefingIntervalSelector=getEl("briefingIntervalSelector"),BriefingExport.briefingMultiSelector=getEl("briefingMultiSelector"),getEl("makeBriefingsByTime ".trim()).addEventListener("click",BriefingExport.makeExport("templateByTime")),getEl("makeBriefingsByStory".trim()).addEventListener("click",BriefingExport.makeExport("templateByStory")),getEl("makeInventoryList   ".trim()).addEventListener("click",BriefingExport.makeExport("inventoryTemplate")),UI.initTabPanel("exportModeButton","exportContainer"),listen(getEl("previewTextOutput"),"click",BriefingExport.previewTextOutput),getEl("textBriefingPreviewArea").value="",listen(getEl("showRawData"),"click",BriefingExport.previewTextDataAsIs),listen(getEl("convertToDocxTemplate"),"click",BriefingExport.convertToDocxTemplate),listen(getEl("generateByDocxTemplate"),"click",BriefingExport.generateByDocxTemplate),BriefingExport.briefingSelector=getEl("briefingSelector"),BriefingExport.briefingMultiSelect=getEl("briefingMultiSelect"),BriefingExport.content=getEl("briefingExportDiv")},BriefingExport.refresh=function(){BriefingExport.resolveTextTemplate(function(e){getEl("templateArea").value=e,BriefingExport.onNumberSelectorChange()})},BriefingExport.resolveTextTemplate=function(e){DBMS.getAllProfileSettings(function(t,i){if(t)return void Utils.handleError(t);var n=R.compose(R.join(""),R.insert(1,R.__,["{{profileInfo-","}}\n"]),R.prop("name")),r=R.compose(R.equals(!0),R.prop("doExport")),o=i.filter(r).map(n).join("");e(R.replace(/\{0\}/g,o,TEXT_TEMPLATE))})},BriefingExport.onExportSelectionChange=function(e){var t="exportSelectionSpecific"===e.target.id,i="exportSelectionMultiple"===e.target.id;setClassByCondition(BriefingExport.briefingSelector,"hidden",!t),setClassByCondition(BriefingExport.briefingMultiSelect,"hidden",!i)},BriefingExport.getSelectedUsers=function(){var e=getSelectedRadio("#briefingExportDiv input[name=exportSelection]").id;switch(e){case"exportSelectionAll":return null;case"exportSelectionSpecific":return JSON.parse(BriefingExport.briefingIntervalSelector.selectedOptions[0].value);case"exportSelectionMultiple":for(var t=BriefingExport.briefingMultiSelector.selectedOptions,i={},n=0;n<t.length;n++)i[t[n].value]=!0;return i;default:Utils.alert("unexpected id: "+e)}return null},BriefingExport.onNumberSelectorChange=function(){var e,t,i,n=(clearEl(BriefingExport.briefingIntervalSelector),clearEl(BriefingExport.briefingMultiSelector)),r=Number(BriefingExport.briefingNumberSelector.value);PermissionInformer.getCharacterNamesArray(!1,function(o,s){if(o)return void Utils.handleError(o);if(s.length>0){e=arr2Chunks(s,r);var a=e.map(function(e){return t=1===e.length?e[0].displayName:e[0].displayName+" - "+e[e.length-1].displayName,i=JSON.stringify(e.reduce(function(e,t){return e[t.value]=!0,e},{})),{id:i,text:t}});$("#"+BriefingExport.briefingIntervalSelector.id).select2({data:a}),fillSelector(n,s.map(remapProps4Select))}})},BriefingExport.makeExport=function(e){return function(){BriefingExport.templates[e]||(BriefingExport.templates[e]=atob(templatesArr[e])),BriefingExport.exportDocxByTemplate(BriefingExport.templates[e])}},BriefingExport.getBriefingData=function(e){DBMS.getBriefingData(BriefingExport.getSelectedUsers(),function(t,i){return t?void Utils.handleError(t):void DBMS.getAllProfileSettings(function(t,n){if(t)return void Utils.handleError(t);var r=[],o=[];n.forEach(function(e,t){"checkbox"===e.type&&(r.push(t),o.push(e.name))}),i.briefings.forEach(function(e){r.forEach(function(t){var i=e.profileInfoArray[t];i&&(i.value=i.splittedText=constL10n(Constants[i.value]))}),o.forEach(function(t){e["profileInfo-"+t]=constL10n(Constants[e["profileInfo-"+t]])})}),e(null,i)})})},BriefingExport.exportDocxByTemplate=function(e){BriefingExport.getBriefingData(function(t,i){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",e),BriefingExport.generateSingleDocx("Uint8Array",e))})},BriefingExport.convertToDocxTemplate=function(){var e=BriefingExport.makeDocxTemplate("blob");Utils.confirm(getL10n("briefings-save-file"))&&saveAs(e,"template.docx")},BriefingExport.generateByDocxTemplate=function(){BriefingExport.exportDocxByTemplate(BriefingExport.makeDocxTemplate("Uint8Array"))},BriefingExport.makeDocxTemplate=function(e){var t=getEl("templateArea").value,i=R.pipe(R.replace(/{{{/g,"{"),R.replace(/}}}/g,"}"),R.replace(/{{/g,"{"),R.replace(/}}/g,"}"));t=i(t).split("\n").map(function(e){return{string:e}}),BriefingExport.templates.genericTemplate||(BriefingExport.templates.genericTemplate=atob(templatesArr.genericTemplate));var n=new window.Docxgen(BriefingExport.templates.genericTemplate);return n.setData({splittedText:t}),n.render(),n.getZip().generate({type:e})},BriefingExport.previewTextDataAsIs=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=JSON.stringify(t,null,"  "))})},BriefingExport.previewTextOutput=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=BriefingExport.generateSingleTxt(getEl("templateArea").value,t))})},BriefingExport.makeTextBriefings=function(e,t){var i=BriefingExport.generateSingleTxt(t);BriefingExport.getBriefingData(function(t,n){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(n,e,function(e){var t=i(e);return new Blob([t],{type:"text/plain;charset=utf-8"})},i)})},BriefingExport.readTemplateFile=function(e){var t=e.target.files[0];if(t){var i=new FileReader;i.onload=function(e){var t=e.target.result;BriefingExport.getBriefingData(function(e,i){return e?void Utils.handleError(e):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",t),BriefingExport.generateSingleDocx("Uint8Array",t))})},i.readAsBinaryString(t)}else Utils.alert(getL10n("briefings-error-on-template-uploading"))};var updateStatus=function(e){var t=getEl("exportStatus");clearEl(t),t.appendChild(makeText(e))};BriefingExport.generateBriefings=function(e,t,i,n){var r,o,s=getEl("toSeparateFileCheckbox").checked,a="briefings";updateStatus(getL10n("briefings-save-preparing"));try{if(s){var l=new JSZip;l.generate();updateStatus(getL10n("briefings-start-saving"));var h=BriefingExport.makeArchiveData(e,n);for(var c in h)l.file(c+"."+t,h[c]);updateStatus(getL10n("briefings-archiving")),o=l.generate({type:"blob"}),updateStatus(getL10n("briefings-archive-is-ready")),BriefingExport.saveFile("briefings-save-archive",o,a+".zip")}else updateStatus(getL10n("briefings-start-saving")),r=i(e),updateStatus(getL10n("briefings-file-is-ready")),BriefingExport.saveFile("briefings-save-file",r,a+"."+t)}catch(d){Utils.alert(getL10n("briefings-error-on-generating-briefings")),console.log(d)}},BriefingExport.saveFile=function(e,t,i){Utils.confirm(getL10n(e))&&saveAs(t,i)},BriefingExport.makeArchiveData=function(e,t){var i={};return e.briefings.forEach(function(n,r){i[n.name]=t({gameName:e.gameName,briefings:[n]}),updateStatus(strFormat(getL10n("briefings-save-status"),[r+1,e.briefings.length]))}),i},BriefingExport.generateSingleDocx=R.curry(function(e,t,i){var n=new window.Docxgen(t);n.setData(i),n.render();var r=n.getZip().generate({type:e});return r}),BriefingExport.generateSingleTxt=R.curry(function(e,t){return Mustache.render(e,t)});var BriefingPreview={};BriefingPreview.init=function(){$("#briefingCharacter").select2().on("change",BriefingPreview.buildContentDelegate);var e=getEl("eventGroupingByStoryRadio");listen(e,"change",BriefingPreview.refresh),e.checked=!0,listen(getEl("eventGroupingByTimeRadio"),"change",BriefingPreview.refresh),listen(getEl("hideAllPanelsCheckbox"),"change",BriefingPreview.refresh),listen(getEl("disableHeadersCheckbox"),"change",BriefingPreview.refresh),BriefingPreview.content=getEl("briefingPreviewDiv")},BriefingPreview.refresh=function(){clearEl(getEl("briefingCharacter")),clearEl(getEl("briefingContent")),DBMS.getAllProfileSettings(function(e,t){return e?void Utils.handleError(e):(BriefingPreview.profileSettings=t,void PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);if(t.length>0){var i=DBMS.getSettings();i.BriefingPreview||(i.BriefingPreview={characterName:t[0].value});var n=i.BriefingPreview.characterName,r=t.map(R.prop("value"));-1===r.indexOf(n)&&(i.BriefingPreview.characterName=t[0].value,n=t[0].value);var o=getSelect2Data(t);$("#briefingCharacter").select2(o).val(n).trigger("change")}}))})},BriefingPreview.buildContentDelegate=function(e){BriefingPreview.buildContent(e.target.value)},BriefingPreview.updateSettings=function(e){var t=DBMS.getSettings();t.BriefingPreview.characterName=e},BriefingPreview.buildContent=function(e){BriefingPreview.updateSettings(e);var t=clearEl(getEl("briefingContent"));DBMS.getProfile(e,function(i,n){return i?void Utils.handleError(i):(addEl(t,BriefingPreview.makePanel(makeText(getL10n("briefings-profile")),BriefingPreview.makeProfileContent(n))),void DBMS.getAllInventoryLists(e,function(i,n){return i?void Utils.handleError(i):void PermissionInformer.getStoryNamesArray(!0,function(i,r){if(i)return void Utils.handleError(i);var o={};r.forEach(function(e){o[e.value]=e}),addEl(t,BriefingPreview.makePanel(makeText(getL10n("briefings-inventory")+" ("+n.length+")"),BriefingPreview.makeInventoryContent(n,e,o)));var s=getEl("eventGroupingByStoryRadio").checked;s?BriefingPreview.showEventsByStory(t,e,o):BriefingPreview.showEventsByTime(t,e,o)})}))})},BriefingPreview.onBuildContentFinish=function(){BriefingPreview.refreshTextAreas(),Utils.enable(BriefingPreview.content,"notEditable",!1)},BriefingPreview.refreshTextAreas=function(){R.ap([UI.resizeTextarea],nl2array(getEl("briefingContent").getElementsByTagName("textarea")).map(function(e){return{target:e}}))},BriefingPreview.makePanel=function(e,t){var i=addClasses(makeEl("div"),["panel","panel-default"]),n=addClass(addEl(makeEl("h3"),e),"panel-title"),r=setAttr(makeEl("a"),"href","#/"),o=addClass(makeEl("div"),"panel-heading");addEl(i,addEl(o,addEl(r,n)));var s=addClass(makeEl("div"),"panel-body");setClassByCondition(s,"hidden",getEl("hideAllPanelsCheckbox").checked),addEl(i,addEl(s,t));var a=UI.togglePanel(s);return listen(r,"click",function(){a(),BriefingPreview.refreshTextAreas()}),i},BriefingPreview.makeInventoryContent=function(e,t,i){var n;return n=makeEl("tbody"),e.forEach(function(e){var r=makeEl("input");r.value=e.inventory,r.storyName=e.storyName,r.characterName=t,addClass(r,"inventoryInput"),i[e.storyName]||addClass(r,"notEditable"),r.addEventListener("change",BriefingPreview.updateCharacterInventory),addEl(n,BriefingPreview.makeTableRow(makeText(e.storyName),r))}),addEl(addClasses(makeEl("table"),["table","table-striped"]),n)},BriefingPreview.makeTableRow=function(e,t){return addEls(makeEl("tr"),[addEl(makeEl("td"),e),addEl(makeEl("td"),t)])},BriefingPreview.makeProfileContent=function(e){var t,i,n;return t=makeEl("tbody"),BriefingPreview.profileSettings.forEach(function(r){if(r.doExport){switch(i=makeText(r.name),r.type){case"text":n=addClass(makeEl("span"),"briefingTextSpan"),addEl(n,makeText(e[r.name]));break;case"enum":case"number":case"string":n=makeText(e[r.name]);break;case"checkbox":n=makeText(constL10n(Constants[e[r.name]]))}addEl(t,BriefingPreview.makeTableRow(i,n))}}),addEl(addClasses(makeEl("table"),["table","table-striped"]),t)},BriefingPreview.showEventsByTime=function(e,t,i){DBMS.getCharacterEventsByTime(t,function(n,r){if(n)return void Utils.handleError(n);var o=r.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(o,function(n,o){if(n)return void Utils.handleError(n);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!0},a=5;addEls(e,R.splitEvery(a,r).map(function(e,i){var n,r=addEls(makeEl("div"),e.map(function(e,n){return s.index=i*a+1+n,BriefingPreview.showEvent(e,t,s)}));return n=getEl("disableHeadersCheckbox").checked?makeText(strFormat(getL10n("briefings-events-header"),[i*a+1,i*a+e.length])):addEls(makeEl("div"),e.map(function(e){return BriefingPreview.getEventHeaderDiv(e,!0)})),BriefingPreview.makePanel(n,r)})),BriefingPreview.onBuildContentFinish()})})},BriefingPreview.getStoryHeader=function(e,t){var i;return i=getEl("disableHeadersCheckbox").checked?strFormat(getL10n("briefings-story-header"),[t+1]):e.storyName,makeText(i+" ("+e.events.length+")")},BriefingPreview.showEventsByStory=function(e,t,i){DBMS.getCharacterEventGroupsByStory(t,function(n,r){if(n)return void Utils.handleError(n);var o=r.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(o,function(n,o){if(n)return void Utils.handleError(n);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!1};addEls(e,r.map(function(e,i){var n=addEls(makeEl("div"),e.events.map(function(e,i){return s.index=i+1,BriefingPreview.showEvent(e,t,s)}));return BriefingPreview.makePanel(BriefingPreview.getStoryHeader(e,i),n)})),BriefingPreview.onBuildContentFinish()})})},BriefingPreview.getEventHeaderDiv=function(e,t){var i=addEl(makeEl("span"),makeText(strFormat("{0} {1}",[t?e.storyName+":":"",e.name]))),n=addClass(addEl(makeEl("span"),makeText(e.time)),"previewEventTime");return addEls(makeEl("div"),[n,i])},BriefingPreview.getEventLabelText=function(e,t,i){return getEl("disableHeadersCheckbox").checked?addEl(makeEl("h4"),makeText(strFormat(getL10n("briefings-event-header"),[i]))):addEl(makeEl("h4"),BriefingPreview.getEventHeaderDiv(e,t))},BriefingPreview.showEvent=function(e,t,i){var n,r=makeEl("div"),o=""===e.characters[t].text;n=o?!!i.userStoryNamesMap[e.storyName]:i.areAdaptationsEditable[e.storyName+"-"+t],addEl(r,BriefingPreview.getEventLabelText(e,i.showStoryName,i.index)),addEl(r,makeText(getL10n("briefings-subjective-time"))),addEl(r,UI.makeAdaptationTimeInput(e.storyName,e,t,i.areAdaptationsEditable[e.storyName+"-"+t]));var s=makeEl("textarea");return addClass(s,"briefingPersonalStory"),setClassByCondition(s,"notEditable",!n),o&&addEls(r,BriefingPreview.makeUnlockEventSourceButton(s,n)),addEl(r,makeEl("br")),o?s.value=e.text:(s.value=e.characters[t].text,s.characterName=t),s.eventIndex=e.index,s.storyName=e.storyName,listen(s,"change",BriefingPreview.onChangePersonalStory),listen(s,"keydown",UI.resizeTextarea),listen(s,"paste",UI.resizeTextarea),listen(s,"cut",UI.resizeTextarea),listen(s,"change",UI.resizeTextarea),listen(s,"drop",UI.resizeTextarea),addEl(r,s),addEl(r,makeEl("br")),r},BriefingPreview.makeUnlockEventSourceButton=function(e,t){e.setAttribute("disabled","disabled");var i=addEl(makeEl("button"),makeText(getL10n("briefings-unlock-event-source")));return setClassByCondition(i,"notEditable",!t),listen(i,"click",function(){e.removeAttribute("disabled")}),[makeEl("br"),i]},BriefingPreview.updateCharacterInventory=function(e){var t=e.target;DBMS.updateCharacterInventory(t.storyName,t.characterName,t.value,Utils.processError())},BriefingPreview.onChangePersonalStory=function(e){var t=e.target.storyName,i=e.target.eventIndex,n=e.target.characterName,r=e.target.value;DBMS.setEventText(t,i,n,r,Utils.processError())};var Briefings={};Briefings.init=function(){var e=Briefings;e.views={};var t="briefingsNavigation",i="briefingsContent",n={root:e,navigation:getEl(t),content:getEl(i)};Utils.addView(n,"briefing-preview",BriefingPreview,{mainPage:!0}),Utils.addView(n,"briefing-export",BriefingExport),Briefings.content=getEl("briefingsDiv")},Briefings.refresh=function(){Briefings.currentView.refresh()};var CharacterFilter={};CharacterFilter.init=function(){listen(getEl("profileItemSelector"),"change",UI.showSelectedEls("-dependent")),CharacterFilter.content=getEl("characterFilterDiv")},CharacterFilter.refresh=function(){CharacterFilter.sortKey="name",CharacterFilter.sortDir="asc";var e=getEl("filterSettingsDiv");clearEl(e),e.inputItems={},e.appendChild(makeText(getL10n("character-filter-character"))),e.appendChild(makeEl("br"));var t=makeEl("input");t.selfInfo={name:"name",type:"text"},t.value="",e.appendChild(t),e.inputItems.name=t,t.addEventListener("input",CharacterFilter.rebuildContent),e.appendChild(makeEl("br")),PermissionInformer.getCharacterNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void DBMS.getAllProfiles(function(t,n){return t?void Utils.handleError(t):(CharacterFilter.Characters=n,i.forEach(function(e){n[e.value].name=e.displayName}),void DBMS.getAllProfileSettings(function(t,i){if(t)return void Utils.handleError(t);CharacterFilter.allProfileSettings=i.filter(function(e){return!0}),CharacterFilter.unshiftedProfileSettings=CharacterFilter.allProfileSettings.filter(function(e){return!0}),CharacterFilter.unshiftedProfileSettings.unshift({name:"name",type:"text"}),CharacterFilter.allProfileSettings.forEach(function(t){CharacterFilter.appendInput(e,t)});var n=R.map(R.prop("name"),CharacterFilter.allProfileSettings);UI.fillShowItemSelector(clearEl(getEl("profileItemSelector")),n),CharacterFilter.appendContentHeader(clearEl(getEl("filterHead")),n),CharacterFilter.rebuildContent()}))})})},CharacterFilter.rebuildContent=function(){var e=clearEl(getEl("filterContent")),t=Object.keys(CharacterFilter.Characters).filter(CharacterFilter.acceptDataRow);addEl(clearEl(getEl("filterResultSize")),makeText(t.length)),t.sort(CharacterFilter.sortDataRows).forEach(function(t){CharacterFilter.appendDataString(e,CharacterFilter.Characters[t],CharacterFilter.unshiftedProfileSettings)}),UI.showSelectedEls("-dependent")({target:getEl("profileItemSelector")})},CharacterFilter.acceptDataRow=function(e){e=CharacterFilter.Characters[e];var t=getEl("filterSettingsDiv"),i=!0,n=function(n){if(!n.endsWith(":numberInput")&&i){var r,o,s,a,l=t.inputItems[n];switch(l.selfInfo.type){case"enum":for(r={},a=0;a<l.options.length;a+=1)l.options[a].selected&&(r[l.options[a].value]=!0);r[e[l.selfInfo.name]]||(i=!1);break;case"checkbox":r={},l.options[0].selected&&(r["true"]=!0),l.options[1].selected&&(r["false"]=!0),r[e[l.selfInfo.name]]||(i=!1);break;case"number":switch(s=Number(t.inputItems[l.selfInfo.name+":numberInput"].value),l.value){case"ignore":break;case"greater":i=e[l.selfInfo.name]>s;break;case"equal":i=e[l.selfInfo.name]===s;break;case"lesser":i=e[l.selfInfo.name]<s}break;case"text":case"string":o=Utils.globStringToRegex(l.value.toLowerCase()),i=e[l.selfInfo.name].toLowerCase().match(o)}}};return Object.keys(t.inputItems).forEach(n),i},CharacterFilter.sortDataRows=function(e,t){e=CharacterFilter.Characters[e],t=CharacterFilter.Characters[t];var i="name"===CharacterFilter.sortKey?"text":CharacterFilter.allProfileSettings.filter(function(e){return e.name===CharacterFilter.sortKey})[0].type;switch(i){case"text":case"string":case"enum":e=e[CharacterFilter.sortKey].toLowerCase(),t=t[CharacterFilter.sortKey].toLowerCase();break;case"checkbox":e=e[CharacterFilter.sortKey],t=t[CharacterFilter.sortKey];break;case"number":e=e[CharacterFilter.sortKey],t=t[CharacterFilter.sortKey]}return e>t?"asc"===CharacterFilter.sortDir?1:-1:t>e?"asc"===CharacterFilter.sortDir?-1:1:0},CharacterFilter.appendDataString=function(e,t,i){var n,r,o,s=makeEl("tr"),a=getEl("filterSettingsDiv").inputItems;i.forEach(function(e,i){n=makeEl("td"),"checkbox"===e.type?n.appendChild(makeText(constL10n(Constants[t[e.name]]))):"text"===e.type&&"name"!==e.name?(r=Utils.globStringToRegex(a[e.name].value),o=t[e.name].search(r),n.appendChild(makeText(t[e.name].substring(o-5,o+15)))):n.appendChild(makeText(t[e.name])),addClass(n,i-1+"-dependent"),s.appendChild(n)}),addEl(e,s)},CharacterFilter.appendContentHeader=function(e,t){var i=makeEl("tr"),n=makeEl("th");n.appendChild(makeText(getL10n("character-filter-character"))),n.appendChild(makeEl("span")),n.info="name",n.addEventListener("click",CharacterFilter.onSortChange),i.appendChild(n),t.forEach(function(e,t){n=makeEl("th"),n.appendChild(makeText(e)),n.appendChild(makeEl("span")),n.info=e,addClass(n,t+"-dependent"),n.addEventListener("click",CharacterFilter.onSortChange),i.appendChild(n)}),e.appendChild(i)},CharacterFilter.onSortChange=function(e){var t=e.target;if("span"===t.tagName.toLowerCase()&&(t=t.parentElement),CharacterFilter.sortKey===t.info)CharacterFilter.sortDir="asc"===CharacterFilter.sortDir?"desc":"asc","desc"===CharacterFilter.sortDir?(addClass(t,"sortDesc"),removeClass(t,"sortAsc")):(addClass(t,"sortAsc"),removeClass(t,"sortDesc"));else{var i,n=getEl("filterHead"),r=n.getElementsByClassName("sortAsc");for(i=0;i<r.length;i++)removeClass(r[i],"sortAsc");for(r=n.getElementsByClassName("sortDesc"),i=0;i<r.length;i++)removeClass(r[i],"sortDesc");CharacterFilter.sortKey=t.info,CharacterFilter.sortDir="asc",addClass(t,"sortAsc")}CharacterFilter.rebuildContent()},CharacterFilter.appendInput=function(e,t){e.appendChild(makeText(t.name)),e.appendChild(makeEl("br"));var i,n,r;switch(t.type){case"text":case"string":i=makeEl("input"),i.selfInfo=t,i.value="",e.appendChild(i),e.inputItems[t.name]=i,i.addEventListener("input",CharacterFilter.rebuildContent);break;case"enum":n=makeEl("select"),n.selfInfo=t,n.multiple="multiple",r=t.value.split(","),n.size=r.length,r.forEach(function(e){var t=makeEl("option");t.selected=!0,t.appendChild(makeText(e)),n.appendChild(t)}),e.appendChild(n),e.inputItems[t.name]=n,n.addEventListener("change",CharacterFilter.rebuildContent);break;case"number":n=makeEl("select"),n.selfInfo=t,Constants.numberFilter.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(constL10n(e))),t.value=e,n.appendChild(t)}),n.selectedIndex=0,e.appendChild(n),e.inputItems[t.name]=n,n.addEventListener("change",CharacterFilter.rebuildContent),i=makeEl("input"),i.value=0,i.type="number",e.appendChild(i),e.inputItems[t.name+":numberInput"]=i,i.addEventListener("change",CharacterFilter.rebuildContent);break;case"checkbox":n=makeEl("select"),n.selfInfo=t,n.multiple="multiple",n.size=2,Constants.yesNo.forEach(function(e){var t=makeEl("option");t.selected=!0,t.value=e,t.appendChild(makeText(constL10n(e))),n.appendChild(t)}),e.appendChild(n),e.inputItems[t.name]=n,n.addEventListener("change",CharacterFilter.rebuildContent)}e.appendChild(makeEl("br"))};var CharacterProfile={};CharacterProfile.init=function(){var e=getEl("bioEditorSelector");listen(e,"change",CharacterProfile.showProfileInfoDelegate),CharacterProfile.content=getEl("characterProfile")},CharacterProfile.refresh=function(){PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);var i=clearEl(getEl("bioEditorSelector"));t.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e.displayName)),t.value=e.value,i.appendChild(t)});var n=clearEl(getEl("profileContentDiv")),r=makeEl("table"),o=makeEl("tbody");r.appendChild(o),addClass(r,"table"),n.appendChild(r),CharacterProfile.inputItems={},DBMS.getAllProfileSettings(function(e,n){return e?void Utils.handleError(e):(n.forEach(function(e){CharacterProfile.appendInput(o,e)}),void CharacterProfile.applySettings(t,i))})})},CharacterProfile.applySettings=function(e,t){if(e.length>0){var i=e[0].value,n=DBMS.getSettings();n.CharacterProfile||(n.CharacterProfile={characterName:i});var r=n.CharacterProfile.characterName;-1===e.map(function(e){return e.value}).indexOf(r)&&(n.CharacterProfile.characterName=i,r=i),DBMS.getProfile(r,CharacterProfile.showProfileInfoCallback),t.value=r}},CharacterProfile.appendInput=function(e,t){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(t.name)),i.appendChild(n),n=makeEl("td");var r,o;switch(t.type){case"text":r=makeEl("textarea"),addClass(r,"profileTextInput");break;case"string":r=makeEl("input"),addClass(r,"profileStringInput");break;case"enum":r=makeEl("select"),o=t.value.split(","),o.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e)),r.appendChild(t)});break;case"number":r=makeEl("input"),r.type="number";break;case"checkbox":r=makeEl("input"),r.type="checkbox"}r.addEventListener("change",CharacterProfile.updateFieldValue(t.type)),r.selfName=t.name,addClass(r,"isCharacterEditable"),n.appendChild(r),CharacterProfile.inputItems[t.name]=r,i.appendChild(n),e.appendChild(i)},CharacterProfile.updateFieldValue=function(e){return function(t){var i,n=t.target.selfName,r=CharacterProfile.name;switch(e){case"text":case"string":case"enum":i=t.target.value;break;case"number":if(isNaN(t.target.value))return Utils.alert(getL10n("characters-not-a-number")),void(t.target.value=t.target.oldValue);i=Number(t.target.value);break;case"checkbox":i=t.target.checked}DBMS.updateProfileField(r,n,e,i,Utils.processError())}},CharacterProfile.showProfileInfoDelegate=function(e){var t=e.target.value.trim();DBMS.getProfile(t,CharacterProfile.showProfileInfoCallback)},CharacterProfile.showProfileInfoCallback=function(e,t){if(e)return void Utils.handleError(e);var i=t.name;PermissionInformer.isCharacterEditable(i,function(e,n){if(e)return void Utils.handleError(e);CharacterProfile.updateSettings(i),CharacterProfile.name=i;var r=CharacterProfile.inputItems;
Object.keys(r).forEach(function(e){"checkbox"===r[e].type?r[e].checked=t[e]:r[e].value=t[e],r[e].oldValue=t[e],Utils.enable(CharacterProfile.content,"isCharacterEditable",n)})})},CharacterProfile.updateSettings=function(e){var t=DBMS.getSettings();t.CharacterProfile.characterName=e};var CharacterProfileConfigurer={};CharacterProfileConfigurer.init=function(){var e=clearEl(getEl("profileItemTypeSelector")),t=function(){CharacterProfileConfigurer.fillSelector(clearEl(e))};t(),L10n.onL10nChange(t),listen(getEl("createProfileItemButton"),"click",CharacterProfileConfigurer.createProfileItem),listen(getEl("moveProfileItemButton"),"click",CharacterProfileConfigurer.moveProfileItem),listen(getEl("removeProfileItemButton"),"click",CharacterProfileConfigurer.removeProfileItem),CharacterProfileConfigurer.content=getEl("characterProfileConfigurer")},CharacterProfileConfigurer.refresh=function(){var e=[];e.push(getEl("profileItemPositionSelector")),e.push(getEl("moveProfileItemPositionSelector")),DBMS.getAllProfileSettings(function(t,i){if(t)return void Utils.handleError(t);var n;e.forEach(function(e){clearEl(e);var t=function(t){addEl(e,addEl(makeEl("option"),makeText(t)))};i.forEach(function(e){t(strFormat(getL10n("common-set-item-before"),[e.name]))}),t(getL10n("common-set-item-as-last")),e.selectedIndex=i.length});var r=clearEl(getEl("profileConfigBlock"));i.forEach(function(e,t){addEl(r,CharacterProfileConfigurer.getInput(e,t+1))}),PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(CharacterProfileConfigurer.content,"adminOnly",t)});var o=[];o.push(getEl("moveProfileItemSelector")),o.push(getEl("removeProfileItemSelector")),o.forEach(function(e){clearEl(e),i.forEach(function(t,i){n=makeEl("option"),n.appendChild(makeText(t.name)),n.profileItemIndex=i,e.appendChild(n)})})})},CharacterProfileConfigurer.createProfileItem=function(){var e=getEl("profileItemNameInput").value.trim();CharacterProfileConfigurer.validateProfileItemName(e,function(){var t=getEl("profileItemTypeSelector").value.trim();if(!Constants.profileFieldTypes[t])return void Utils.alert(strFormat(getL10n("characters-unknown-profile-item-type"),[t]));var i=Constants.profileFieldTypes[t].value,n=getEl("profileItemPositionSelector"),r=n.value;DBMS.createProfileItem(e,t,i,r===getL10n("common-set-item-as-last"),n.selectedIndex,Utils.processError(CharacterProfileConfigurer.refresh))})},CharacterProfileConfigurer.moveProfileItem=function(){var e=getEl("moveProfileItemSelector").selectedOptions[0].profileItemIndex,t=getEl("moveProfileItemPositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("characters-profile-item-positions-are-equal")):void DBMS.moveProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.removeProfileItem=function(){var e=getEl("removeProfileItemSelector").selectedIndex,t=getEl("removeProfileItemSelector").value;Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-removing-profile-item"),[t]))&&DBMS.removeProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.fillSelector=function(e){var t=function(e,t){return setProp(addEl(makeEl("option"),makeText(t)),"value",e)};R.values(Constants.profileFieldTypes).forEach(function(i){addEl(e,t(i.name,constL10n(i.name)))})},CharacterProfileConfigurer.getInput=function(e,t){var i=makeEl("tr"),n=R.compose(addEl(i),function(e){return addEl(makeEl("td"),e)});n(addEl(makeEl("span"),makeText(t)));var r=setProps(makeEl("input"),{value:e.name,info:e.name});listen(r,"change",CharacterProfileConfigurer.renameProfileItem),addClass(r,"itemNameInput"),addClass(r,"adminOnly"),n(r);var o=makeEl("select");CharacterProfileConfigurer.fillSelector(o),setProps(o,{value:e.type,info:e.name,oldType:e.type}),listen(o,"change",CharacterProfileConfigurer.changeProfileItemType),addClass(o,"adminOnly"),n(o);var s="text"==e.type||"enum"==e.type;switch(r=s?makeEl("textarea"):makeEl("input"),setProps(r,{info:e.name,infoType:e.type,oldValue:e.value}),addClass(r,"adminOnly"),addClass(r,"profile-configurer-"+e.type),e.type){case"text":case"string":case"enum":r.value=e.value;break;case"number":r.type="number",r.value=e.value;break;case"checkbox":r.type="checkbox",r.checked=e.value}listen(r,"change",CharacterProfileConfigurer.updateDefaultValue),n(r);var r=setProps(makeEl("input"),{checked:e.doExport,info:e.name,type:"checkbox"});return listen(r,"change",CharacterProfileConfigurer.doExportChange),addClass(r,"adminOnly"),n(r),i},CharacterProfileConfigurer.updateDefaultValue=function(e){var t,i=e.target.info,n=e.target.infoType,r=e.target.oldValue;switch(n){case"text":case"string":case"number":case"enum":t=e.target.value;break;case"checkbox":t=e.target.checked}var o,s,a,l,h;switch(n){case"text":case"string":case"checkbox":DBMS.updateDefaultValue(i,t,Utils.processError());break;case"number":if(isNaN(t))return Utils.alert(getL10n("characters-not-a-number")),void(e.target.value=r);DBMS.updateDefaultValue(i,Number(t),Utils.processError());break;case"enum":if(""===t)return Utils.alert(getL10n("characters-enum-item-cant-be-empty")),void(e.target.value=r);if(o=r.split(","),s=t.split(","),s=s.map(function(e){return e.trim()}),a=[{}].concat(s).reduce(function(e,t){return e[t]=!0,e}),l=o.filter(function(e){return!a[e]}),0!==l.length)return Utils.confirm(strFormat(getL10n("characters-new-enum-values-remove-some-old-values"),[l.join(",")]))?(h=s.join(","),e.target.value=h,void DBMS.updateDefaultValue(i,h,Utils.processError())):void(e.target.value=r);h=s.join(","),e.target.value=h,DBMS.updateDefaultValue(i,h,Utils.processError())}},CharacterProfileConfigurer.doExportChange=function(e){DBMS.doExportProfileItemChange(e.target.info,e.target.checked,Utils.processError())},CharacterProfileConfigurer.renameProfileItem=function(e){var t=e.target.value.trim(),i=e.target.info;CharacterProfileConfigurer.validateProfileItemName(t,function(){DBMS.renameProfileItem(t,i,Utils.processError(CharacterProfileConfigurer.refresh))},function(){e.target.value=e.target.info})},CharacterProfileConfigurer.validateProfileItemName=function(e,t,i){if(""===e)return Utils.alert(getL10n("characters-profile-item-name-is-not-specified")),void(i&&i());if("name"===e)return Utils.alert(getL10n("characters-profile-item-name-cant-be-name")),void(i&&i());var n=function(){Utils.alert(getL10n("characters-such-name-already-used")),i&&i()};DBMS.isProfileItemNameUsed(e,function(e,i){return e?void Utils.handleError(e):void(i?n():t())})},CharacterProfileConfigurer.changeProfileItemType=function(e){if(Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-changing-profile-item-type"),[e.target.info]))){var t=e.target.value,i=e.target.info;DBMS.changeProfileItemType(i,t,Utils.processError(CharacterProfileConfigurer.refresh))}else e.target.value=e.target.oldType};var Characters={};Characters.init=function(){var e=Characters;e.views={};var t="charactersNavigation",i="charactersContent",n={root:e,navigation:getEl(t),content:getEl(i)};Utils.addView(n,"character-profile",CharacterProfile,{mainPage:!0}),Utils.addView(n,"character-profile-configurer",CharacterProfileConfigurer),listen(getEl("createCharacterButton"),"click",Characters.createCharacter),listen(getEl("renameCharacter"),"click",Characters.renameCharacter),listen(getEl("removeCharacterButton"),"click",Characters.removeCharacter),Characters.content=getEl("charactersDiv")},Characters.refresh=function(){PermissionInformer.getCharacterNamesArray(!0,Utils.processError(Characters.rebuildInterface))},Characters.rebuildInterface=function(e){var t=getSelect2Data(e);clearEl(getEl("fromName")),$("#fromName").select2(t),clearEl(getEl("characterRemoveSelector")),$("#characterRemoveSelector").select2(t),Characters.currentView.refresh()},Characters.createCharacter=function(){var e=getEl("characterNameInput"),t=e.value.trim();return""===t?void Utils.alert(getL10n("characters-character-name-is-not-specified")):void DBMS.isCharacterNameUsed(t,function(e,i){return e?void Utils.handleError(e):void(i?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[t])):DBMS.createCharacter(t,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(t),void Characters.refresh())})}))})},Characters.renameCharacter=function(){var e=getEl("fromName").value.trim(),t=getEl("toName").value.trim();return""===t?void Utils.alert(getL10n("characters-new-character-name-is-not-specified")):e===t?void Utils.alert(getL10n("characters-names-are-the-same")):void DBMS.isCharacterNameUsed(t,function(i,n){return i?void Utils.handleError(i):void(n?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[t])):DBMS.renameCharacter(e,t,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(t),void Characters.refresh())})}))})},Characters.removeCharacter=function(){var e=getEl("characterRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-character-removing"),[e]))&&DBMS.removeCharacter(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Characters.refresh()})})};var Chat={};Chat.init=function(){var e=getEl("sendMessageButton");e.addEventListener("click",Chat.onSubmit),Chat.subscribe(),Chat.content=getEl("chatDiv")},Chat.refresh=function(){},Chat.onSubmit=function(){var e=getEl("chatMessage"),t=$.ajax({url:"/publish",dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify({message:e.value})});return t.done(function(e){}),t.fail(function(e,t,i){alert(e.responseText)}),e.value="",!1},Chat.subscribe=function(){var e=$.ajax({url:"/subscribe",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});e.done(function(e){var t=makeEl("li");t.appendChild(makeText(e)),messages.appendChild(t),Chat.subscribe()}),e.fail(function(e,t,i){setTimeout(Chat.subscribe,500)})};var EventPresence={name:"EventPresence"};EventPresence.init=function(){listen(getEl("eventPresenceSelector"),"change",UI.showSelectedEls("-dependent")),EventPresence.content=getEl("eventPresenceDiv")},EventPresence.refresh=function(){var e=getEl("eventPresenceTableHead"),t=getEl("eventPresenceTable"),i=getEl("eventPresenceSelector");return void 0==Stories.CurrentStoryName?(clearEl(e),clearEl(t),void clearEl(i)):void PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(n,r){return n?void Utils.handleError(n):void PermissionInformer.getCharacterNamesArray(!1,function(n,o){return n?void Utils.handleError(n):void DBMS.getStoryCharacterNamesArray(Stories.CurrentStoryName,function(n,s){if(n)return void Utils.handleError(n);var a={};o.forEach(function(e){a[e.value]=e});var l=s.map(function(e){return a[e]});l.sort(Utils.charOrdAObject);var h=l.map(function(e){return e.displayName}),s=l.map(function(e){return e.value});DBMS.getStoryEvents(Stories.CurrentStoryName,function(n,o){return n?void Utils.handleError(n):(clearEl(e),clearEl(t),UI.fillShowItemSelector(clearEl(i),h,s),EventPresence.appendTableHeader(e,h),void o.forEach(function(e,i){EventPresence.appendTableInput(t,e,i,s),Utils.enable(EventPresence.content,"isStoryEditable",r)}))})})})})},EventPresence.appendTableHeader=function(e,t){var i=makeEl("tr");rAddEl(rAddEl(makeText(getL10n("stories-event")),makeEl("th")),i),t.forEach(function(e,t){rAddEl(rAddEl(makeText(e),rAddClass(t+"-dependent",makeEl("th"))),i)}),e.appendChild(i)},EventPresence.appendTableInput=function(e,t,i,n){var r=makeEl("tr"),o=makeEl("td");o.appendChild(makeText(t.name)),r.appendChild(o),n.forEach(function(e,n){o=makeEl("td"),addClass(o,n+"-dependent");var s=makeEl("input");addClass(s,"isStoryEditable"),s.type="checkbox",t.characters[e]&&(s.checked=!0),s.eventIndex=i,s.eventName=t.name,s.characterName=e,s.hasText=null!=t.characters[e]&&""!=t.characters[e].text,s.addEventListener("change",EventPresence.onChangeCharacterCheckbox),o.appendChild(s),r.appendChild(o)}),e.appendChild(r)},EventPresence.onChangeCharacterCheckbox=function(e){e.target.checked?DBMS.addCharacterToEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.hasText?Utils.confirm(strFormat(getL10n("stories-remove-character-from-event-warning"),[e.target.characterName,e.target.eventName]))?DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.checked=!0:DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError())};var Events={};Events.init=function(){listen(getEl("events-storySelector"),"change",Events.updateAdaptationSelectorDelegate),listen(getEl("events-characterSelector"),"change",Events.showPersonalStoriesDelegate),listen(getEl("events-eventSelector"),"change",Events.showPersonalStoriesDelegate2),listen(getEl("finishedStoryCheckbox"),"change",Events.refresh),listen(getEl("adaptationFilterByCharacter"),"change",Events.updateFilter),listen(getEl("adaptationFilterByEvent"),"change",Events.updateFilter),Events.content=getEl("eventsDiv")},Events.getSelectedStoryName=function(e){var t=e.map(R.prop("storyName")),i=DBMS.getSettings();i.Events||(i.Events={storyName:t[0],characterNames:[],eventIndexes:[],selectedFilter:"adaptationFilterByCharacter"});var n=i.Events.storyName;return-1===t.indexOf(n)&&(i.Events.storyName=t[0],n=t[0]),n},Events.getNames=function(e,t,i){var n=e.map(R.prop(t)),r=DBMS.getSettings().Events[i],o=r.filter(function(e){return-1!==n.indexOf(e)});return Events.updateSettings(i,o),o},Events.getCharacterNames=function(e){return Events.getNames(e,"characterName","characterNames")},Events.getEventIndexes=function(e){return Events.getNames(e,"index","eventIndexes")},Events.refresh=function(){var e=clearEl(getEl("events-storySelector"));clearEl(getEl("events-characterSelector")),clearEl(getEl("events-eventSelector")),clearEl(getEl("personalStories")),PermissionInformer.getStoryNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void DBMS.getFilteredStoryNames(getEl("finishedStoryCheckbox").checked,function(t,n){if(t)return void Utils.handleError(t);if(!(n.length<=0)){var r=Events.getSelectedStoryName(n),o=arr2map(i,"value");n.forEach(function(e){e.displayName=o[e.storyName].displayName,e.value=o[e.storyName].value}),n.sort(Utils.charOrdAObject);var s;n.forEach(function(t){s=addEl(makeEl("option"),makeText(t.displayName+Events.getSuffix(t))),setProp(s,"selected",t.value===r),setProp(s,"storyInfo",t.value),addEl(e,s)}),Events.updateAdaptationSelector(r)}})})},Events.updateAdaptationSelectorDelegate=function(e){var t=e.target.selectedOptions[0].storyInfo;Events.updateSettings("storyName",t),Events.updateSettings("characterNames",[]),Events.updateAdaptationSelector(t)},Events.updateAdaptationSelector=function(e){var t=clearEl(getEl("events-characterSelector")),i=clearEl(getEl("events-eventSelector"));PermissionInformer.getCharacterNamesArray(!1,function(n,r){return n?void Utils.handleError(n):void DBMS.getFilteredCharacterNames(e,getEl("finishedStoryCheckbox").checked,function(n,o){return n?void Utils.handleError(n):void DBMS.getFilteredEventNames(e,getEl("finishedStoryCheckbox").checked,function(n,s){if(n)return void Utils.handleError(n);var a=Events.getCharacterNames(o),l=Events.getEventIndexes(s),h=arr2map(r,"value");o.forEach(function(e){e.displayName=h[e.characterName].displayName,e.value=h[e.characterName].value}),o.sort(Utils.charOrdAObject);var c;o.forEach(function(i){c=addEl(makeEl("option"),makeText(i.displayName+Events.getSuffix(i))),setProp(c,"selected",-1!==a.indexOf(i.value)),setProp(c,"storyInfo",e),setProp(c,"characterName",i.value),addEl(t,c)}),setAttr(t,"size",o.length),s.forEach(function(t){c=addEl(makeEl("option"),makeText(t.name+Events.getSuffix(t))),setProp(c,"selected",-1!==l.indexOf(t.index)),setProp(c,"storyInfo",e),setProp(c,"eventIndex222",t.index),addEl(i,c)}),setAttr(i,"size",s.length);var d=DBMS.getSettings().Events.selectedFilter;getEl(d).checked=!0,Events.updateFilter({target:{id:d}})})})})},Events.updateFilter=function(e){Events.updateSettings("selectedFilter",e.target.id);var t="adaptationFilterByCharacter"===e.target.id;if(setClassByCondition(getEl("events-characterSelectorDiv"),"hidden",!t),setClassByCondition(getEl("events-eventSelectorDiv"),"hidden",t),t)Events.showPersonalStoriesDelegate({target:getEl("events-characterSelector")});else{var i,n=getEl("events-characterSelector");if(0===n.options.length)return;var r=[];for(i=0;i<n.options.length;i+=1)r.push(n.options[i].characterName);Events.showPersonalStories(n.options[0].storyInfo,r,function(){Events.showPersonalStoriesDelegate2({target:getEl("events-eventSelector")})})}},Events.showPersonalStoriesDelegate=function(e){if(0!=e.target.selectedOptions.length){var t,i=e.target.selectedOptions[0],n=i.storyInfo,r=[],o=e.target;for(t=0;t<o.selectedOptions.length;t+=1)r.push(o.selectedOptions[t].characterName);Events.updateSettings("characterNames",r),Events.showPersonalStories(n,r)}},Events.showPersonalStoriesDelegate2=function(e){var t,i,n=[],r=getEl("events-eventSelector"),o=getEls("eventRow-dependent");for(t=0;t<o.length;t+=1)addClass(o[t],"hidden");for(t=0;t<r.selectedOptions.length;t+=1)i=r.selectedOptions[t].eventIndex222,removeClass(getEls(i+"-dependent")[0],"hidden"),n.push(i);Events.updateSettings("eventIndexes",n)},Events.showPersonalStories=function(e,t,i){DBMS.getMetaInfo(function(n,r){return n?void Utils.handleError(n):void DBMS.getEvents(e,t,function(n,o){return n?void Utils.handleError(n):void PermissionInformer.isStoryEditable(e,function(n,s){if(n)return void Utils.handleError(n);var a=t.map(function(t){return{characterName:t,storyName:e}});PermissionInformer.areAdaptationsEditable(a,function(n,a){return n?void Utils.handleError(n):(Events.buildAdaptationInterface(e,t,o,a,r),Utils.enable(Events.content,"isStoryEditable",s),Utils.enable(Events.content,"notEditable",!1),void(i&&i()))})})})})},Events.buildAdaptationInterface=function(e,t,i,n,r){var o,s,a,l,h,c,d,u,f=clearEl(getEl("personalStories"));R.ap([addEl(f)],i.map(function(i){return o=makeEl("div"),R.ap([addClass(o)],["eventMainPanelRow",i.index+"-dependent","eventRow-dependent"]),s=addClass(makeEl("div"),"eventMainPanelRow-left"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(s,c),addEl(d,addEl(makeEl("div"),makeText(i.name))),addEl(u,UI.makeEventTimePicker({eventTime:i.time,index:i.index,preGameDate:r.preGameDate,date:r.date,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:Events.onChangeDateTimeCreator(e)})),addEl(s,Events.makeOriginTextInput(e,i)),addEl(o,s),s=addClass(makeEl("div"),"eventMainPanelRow-right"),l=addClass(makeEl("div"),"events-eventsContainer"),R.ap([addEl(l)],t.filter(function(e){return i.characters[e]}).map(function(t){return a=addClass(makeEl("div"),"events-singleEventAdaptation"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(a,c),h=n[e+"-"+t],addEl(d,makeText(t)),addEl(u,UI.makeAdaptationTimeInput(e,i,t,h)),addEl(a,Events.makeAdaptationTextInput(e,i,t,h)),addEl(a,Events.makeAdaptationReadyInput(e,i,t,h)),a})),addEl(o,addEl(s,l)),o}))},Events.onChangeDateTimeCreator=R.curry(function(e,t){return function(i,n){DBMS.updateEventProperty(e,t.eventIndex,"time",n.val(),Utils.processError()),StoryEvents.lastDate=n.val(),removeClass(t,"defaultDate")}}),Events.makeOriginTextInput=function(e,t){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventPersonalStory"),i.value=t.text,i.dataKey=JSON.stringify([e,t.index]),listen(i,"change",Events.onChangePersonalStoryDelegate),i},Events.makeAdaptationTextInput=function(e,t,i,n){var r=makeEl("textarea");return setClassByCondition(r,"notEditable",!n),addClass(r,"eventPersonalStory"),r.value=t.characters[i].text,r.dataKey=JSON.stringify([e,t.index,i]),listen(r,"change",Events.onChangePersonalStoryDelegate),r},Events.makeAdaptationReadyInput=function(e,t,i,n){var r=makeEl("div"),o=makeEl("input");return setClassByCondition(o,"notEditable",!n),o.type="checkbox",o.checked=t.characters[i].ready,o.dataKey=JSON.stringify([e,t.index,i]),o.id=t.index+"-"+e+"-"+i,listen(o,"change",Events.onChangeReadyStatus),addEl(r,o),addEl(r,setAttr(addEl(makeEl("label"),makeText(constL10n(Constants.finishedText))),"for",o.id)),r},Events.onChangeReadyStatus=function(e){var t=JSON.parse(e.target.dataKey),i=e.target.checked;DBMS.changeAdaptationReadyStatus(t[0],t[1],t[2],i,Utils.processError())},Events.onChangePersonalStoryDelegate=function(e){var t=JSON.parse(e.target.dataKey),i=e.target.value;DBMS.setEventText(t[0],t[1],t[2],i,Utils.processError())},Events.getSuffix=function(e){return e.isEmpty?constL10n(Constants.emptySuffix):e.isFinished?constL10n(Constants.finishedSuffix):""},Events.updateSettings=function(e,t){var i=DBMS.getSettings();i.Events[e]=t};var LogViewer={};LogViewer.init=function(){listen(getEl("logPageSelector"),"change",function(e){DBMS.getLog(Number(e.target.value),LogViewer.dataRecieved)}),LogViewer.content=getEl("logViewerDiv")},LogViewer.refresh=function(){getEl("logPageSelector").selectedIndex=0,DBMS.getLog(0,LogViewer.dataRecieved)},LogViewer.dataRecieved=function(e,t){if(e)return void Utils.handleError(e);var i=getEl("logPageSelector"),n=i.selectedIndex;clearEl(i);for(var r=[],o=0;o<t.logSize;o++)r.push({name:o+1,value:String(o),selected:n==o});fillSelector(i,r);var s=clearEl(getEl("logData"));R.ap([addEl(s)],t.requestedLog.map(LogViewer.makeRow))},LogViewer.makeRow=function(e){var t=makeEl("tr"),i=function(e){addEl(t,addEl(makeEl("td"),makeText(e)))};return i(e[0]),i(new Date(e[2]).format("yyyy/mm/dd HH:MM:ss")),i(e[1]),i(e[3]),i(e[4]),t};var MasterStory={};MasterStory.init=function(){listen(getEl("masterStoryArea"),"change",MasterStory.updateMasterStory),MasterStory.content=getEl("masterStoryDiv2")},MasterStory.refresh=function(){var e=getEl("masterStoryArea"),t=Stories.CurrentStoryName;t?DBMS.getMasterStory(t,function(t,i){return t?void Utils.handleError(t):void(e.value=i)}):e.value=""},MasterStory.updateMasterStory=function(){var e=getEl("masterStoryArea");DBMS.updateMasterStory(Stories.CurrentStoryName,e.value,Utils.processError())};var statisticKeys=["storyNumber","characterNumber","eventsNumber","userNumber","textCharacterNumber","lastEvent","firstEvent"],Overview={};Overview.Charts={},Overview.init=function(){Overview.name=getEl("gameNameInput"),Overview.name.addEventListener("change",Overview.updateName),Overview.lastSaveTime=getEl("lastSaveTime"),Overview.date=getEl("gameDatePicker");var e={lang:"ru",mask:!0,onChangeDateTime:Overview.updateTime};jQuery(Overview.date).datetimepicker(e),Overview.preDate=getEl("preGameDatePicker"),e={lang:"ru",mask:!0,onChangeDateTime:Overview.updatePreGameDate},jQuery(Overview.preDate).datetimepicker(e),Overview.descr=getEl("gameDescription"),Overview.descr.addEventListener("change",Overview.updateDescr),UI.initTabPanel("overviewInfoButton","overviewContainer"),Overview.content=getEl("overviewDiv")},Overview.makeChart=function(e,t,i){Overview.Charts[e]&&Overview.Charts[e].destroy(),i.forEach(function(e,t){Constants.colorPalette[t]&&(e.color=Constants.colorPalette[t].color.background,e.highlight=Constants.colorPalette[t].color.hover.background)});var n=t.getContext("2d");Overview.Charts[e]=new Chart(n).Doughnut(i,{animateRotate:!1,tooltipTemplate:"<%if (label){%><%=label%><%}%>"})},Overview.makeHistogram=function(e,t){var i=null;t.forEach(function(e){e&&(null===i||e.value>i)&&(i=e.value)}),t.forEach(function(e){e&&(e.normValue=(e.value-0)/(i-0)*.9+.1)});var n;t.forEach(function(t){n=null===t?makeEl("div"):addEl(makeEl("div"),makeText(t.value)),addClass(n,"bar"),t&&(n.style.height=100*t.normValue+"%",$(n).tooltip({title:t.tip})),addEl(e,n)})},Overview.refresh=function(){PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(Overview.content,"adminOnly",t)}),DBMS.getMetaInfo(function(e,t){return e?void Utils.handleError(e):void DBMS.getStatistics(function(e,i){if(e)return void Utils.handleError(e);Overview.name.value=t.name,Overview.date.value=t.date,Overview.preDate.value=t.preGameDate,Overview.descr.value=t.description,addEl(clearEl(Overview.lastSaveTime),makeText(new Date(t.saveTime).format("yyyy/mm/dd HH:MM:ss"))),i.lastEvent=""!==i.lastEvent?new Date(i.lastEvent).format("yyyy/mm/dd h:MM"):"",i.firstEvent=""!==i.firstEvent?new Date(i.firstEvent).format("yyyy/mm/dd h:MM"):"",statisticKeys.forEach(function(e){Overview.updateStatisticValue(i,e)}),addEl(clearEl(getEl("generalCompleteness")),makeText(strFormat(getL10n("overview-general-completeness-value"),i.generalCompleteness))),addEl(clearEl(getEl("storyCompleteness")),makeText(strFormat(getL10n("overview-story-completeness-value"),i.storyCompleteness))),Overview.makeHistogram(clearEl(getEl("storyEventsHist")),i.storyEventsHist),Overview.makeHistogram(clearEl(getEl("storyCharactersHist")),i.storyCharactersHist),Overview.makeHistogram(clearEl(getEl("eventCompletenessHist")),i.eventCompletenessHist),Overview.makeChart("characterChart",getEl("characterChart"),i.characterChartData),Overview.makeChart("storyChart",getEl("storyChart"),i.storyChartData);var n,r,o=clearEl(getEl("profileDiagrams")),s=addEl(o),a=function(e){return n=makeEl("div"),addEl(n,addEl(makeEl("h4"),makeText(e.name))),addEl(n,e.bar),n},l=function(e){return r=setAttr(setAttr(makeEl("canvas"),"width","300"),"height","100"),Overview.makeChart(e.name,r,e.prepared),R.zipObj(["name","bar"],[e.name,r])},h=function(e){return r=makeEl("div"),addClass(r,"overviewHist"),Overview.makeHistogram(r,e.prepared),R.zipObj(["name","bar"],[e.name,r])},c=R.compose(s,a,l,Overview.prepareChart),d=R.compose(s,a,h,Overview.prepareHist),u=function(e){return e.data=R.fromPairs(R.toPairs(e.data).map(function(e){return e[0]=constL10n(Constants[e[0]]),e})),e},f=R.compose(c,u),p=R.cond([[R.compose(R.equals("enum"),R.prop("type")),c],[R.compose(R.equals("checkbox"),R.prop("type")),f],[R.T,d]]);i.profileCharts.forEach(p)})})},Overview.prepareChart=function(e){var t=R.sum(R.values(e.data));e.prepared=[];for(var i in e.data)e.prepared.push(R.zipObj(["value","label"],[e.data[i],Overview.makeChartLabel(t,i,e.data[i])]));return e},Overview.prepareHist=function(e){e.prepared=[];var t=e.data.step;e.data=e.data.groups;for(var i=R.apply(Math.min,R.keys(e.data)),n=R.apply(Math.max,R.keys(e.data)),r=i;n+1>r;r++)e.data[r]?e.prepared.push({value:e.data[r],label:r*t+"-"+(r*t+(t-1)),tip:r*t+"-"+(r*t+(t-1))}):e.prepared.push(null);return e},Overview.makeChartLabel=R.curry(function(e,t,i){return[t,": ",(i/e*100).toFixed(0),"% (",i,"/",e,")"].join("")}),Overview.updateStatisticValue=function(e,t){addEl(clearEl(getEl(t)),makeText(e[t]))},Overview.updateName=function(e){DBMS.setMetaInfo("name",e.target.value,Utils.processError())},Overview.updateTime=function(e,t){DBMS.setMetaInfo("date",t.val(),Utils.processError())},Overview.updatePreGameDate=function(e,t){DBMS.setMetaInfo("preGameDate",t.val(),Utils.processError())},Overview.updateDescr=function(e){DBMS.setMetaInfo("description",e.target.value,Utils.processError())};var Stories={};Stories.init=function(){Stories.left={views:{}},Stories.right={views:{}};var e={root:Stories.left,navigation:getEl("storiesNavigationLeft"),content:getEl("storiesContentLeft")};Utils.addView(e,"master-story",MasterStory,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),e={root:Stories.right,navigation:getEl("storiesNavigationRight"),content:getEl("storiesContentRight")},Utils.addView(e,"master-story",MasterStory,{toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),listen(getEl("createStoryButton"),"click",Stories.createStory),listen(getEl("renameStoryButton"),"click",Stories.renameStory),listen(getEl("removeStoryButton"),"click",Stories.removeStory),$("#storySelector").select2().on("change",Stories.onStorySelectorChangeDelegate),Stories.content=getEl("storiesDiv")},Stories.chainRefresh=function(){(Stories.left.currentView&&"EventPresence"===Stories.left.currentView.name||Stories.right.currentView&&"EventPresence"===Stories.right.currentView.name)&&EventPresence.refresh()},Stories.refresh=function(){var e=["fromStory","storyRemoveSelector"];clearEl(getEl("storySelector"));e.forEach(R.compose(clearEl,getEl)),PermissionInformer.getStoryNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void PermissionInformer.getStoryNamesArray(!0,function(t,n){if(t)return void Utils.handleError(t);if(n.length>0){var r=getSelect2Data(n);e.forEach(function(e){$("#"+e).select2(r)})}if(i.length>0){var o=Stories.getSelectedStoryName(i),r=getSelect2Data(i);$("#storySelector").select2(r).val(o).trigger("change"),Stories.onStorySelectorChange(o)}else Stories.onStorySelectorChange();Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh()})})},Stories.getSelectedStoryName=function(e){var t=DBMS.getSettings();t.Stories||(t.Stories={storyName:e[0].value});var i=t.Stories.storyName;return-1===e.map(function(e){return e.value}).indexOf(i)&&(t.Stories.storyName=e[0].value,i=e[0].value),i},Stories.createStory=function(){var e=getEl("createStoryName").value.trim();return""===e?void Utils.alert(getL10n("stories-story-name-is-not-specified")):void DBMS.isStoryExist(e,function(t,i){return t?void Utils.handleError(t):void(i?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[e])):DBMS.createStory(e,function(t){return t?void Utils.handleError(t):(Stories.updateSettings(e),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.renameStory=function(){var e=getEl("fromStory").value.trim(),t=getEl("toStory").value.trim();return""===t?void Utils.alert(getL10n("stories-new-story-name-is-not-specified")):e===t?void Utils.alert(getL10n("stories-names-are-the-same")):void DBMS.isStoryExist(t,function(i,n){return i?void Utils.handleError(i):void(n?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[t])):DBMS.renameStory(e,t,function(e){return e?void Utils.handleError(e):(Stories.updateSettings(t),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.removeStory=function(){var e=getEl("storyRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("stories-are-you-sure-about-story-removing"),[e]))&&DBMS.removeStory(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()})})},Stories.onStorySelectorChangeDelegate=function(e){var t=e.target.value;Stories.onStorySelectorChange(t)},Stories.onStorySelectorChange=function(e){Stories.CurrentStoryName=e,e?(Stories.updateSettings(e),PermissionInformer.isStoryEditable(e,function(e,t){return e?void Utils.handleError(e):(Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh(),void Utils.enable(Stories.content,"isStoryEditable",t))})):(Stories.updateSettings(null),Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh())},Stories.updateSettings=function(e){var t=DBMS.getSettings();
t.Stories.storyName=e};var StoryCharacters={};StoryCharacters.init=function(){var e=getEl("storyCharactersAddButton");e.addEventListener("click",StoryCharacters.addCharacter),e=getEl("storyCharactersSwitchButton"),e.addEventListener("click",StoryCharacters.switchCharacters),e=getEl("storyCharactersRemoveButton"),e.addEventListener("click",StoryCharacters.removeCharacter),StoryCharacters.ExternalCharacterSelectors=[getEl("storyCharactersAddSelector"),getEl("storyCharactersToSelector")],StoryCharacters.InternalCharacterSelectors=[getEl("storyCharactersRemoveSelector"),getEl("storyCharactersFromSelector")],StoryCharacters.content=getEl("storyCharactersDiv")},StoryCharacters.refresh=function(){StoryCharacters.ExternalCharacterSelectors.forEach(clearEl),StoryCharacters.InternalCharacterSelectors.forEach(clearEl),clearEl(getEl("story-characterActivityTableHead")),clearEl(getEl("story-characterActivityTable")),clearEl(getEl("storyCharactersTableHead")),clearEl(getEl("storyCharactersTable")),Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void DBMS.getStoryCharacters(Stories.CurrentStoryName,function(e,n){return e?void Utils.handleError(e):(StoryCharacters.rebuildInterface(i,n),Utils.enable(StoryCharacters.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryCharacters.rebuildInterface=function(e,t){var i=[],n=[];e.filter(function(e){return!t[e.value]}).forEach(function(e){i.push(e)}),e.filter(function(e){return t[e.value]}).forEach(function(e){n.push(e)}),i.sort(Utils.charOrdAObject),n.sort(Utils.charOrdAObject);var r=getSelect2Data(i),o=getSelect2Data(n);StoryCharacters.ExternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(r)}),StoryCharacters.InternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(o)});var s=clearEl(getEl("story-characterActivityTableHead")),a=clearEl(getEl("story-characterActivityTable"));addEl(s,StoryCharacters.getCharacterHeader([getL10n("stories-name")].concat(Constants.characterActivityTypes.map(constL10n)))),n.forEach(function(e){addEl(a,StoryCharacters.getCharacterActivity(e,t[e.value]))}),s=clearEl(getEl("storyCharactersTableHead")),a=clearEl(getEl("storyCharactersTable")),addEl(s,StoryCharacters.getCharacterHeader([getL10n("stories-name"),getL10n("stories-inventory")])),n.forEach(function(e){addEl(a,StoryCharacters.getCharacterInput(e,t[e.value]))})},StoryCharacters.addCharacter=function(){var e=getEl("storyCharactersAddSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void DBMS.addStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh))},StoryCharacters.switchCharacters=function(){var e=getEl("storyCharactersFromSelector").value.trim(),t=getEl("storyCharactersToSelector").value.trim();return""===e||""===t?void Utils.alert(getL10n("stories-one-of-switch-characters-is-not-specified")):void DBMS.switchStoryCharacters(Stories.CurrentStoryName,e,t,Utils.processError(StoryCharacters.refresh))},StoryCharacters.removeCharacter=function(){var e=getEl("storyCharactersRemoveSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void(Utils.confirm(strFormat(getL10n("stories-remove-character-from-story-warning"),[e]))&&DBMS.removeStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh)))},StoryCharacters.getCharacterHeader=function(e){var t=makeEl("tr");return e.forEach(function(e){addEl(t,addEl(makeEl("th"),makeText(e)))}),t},StoryCharacters.getCharacterInput=function(e,t){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(e.displayName)),i.appendChild(n),n=makeEl("td");var r=makeEl("input");return r.value=t.inventory,r.characterName=t.name,addClass(r,"inventoryInput"),addClass(r,"isStoryEditable"),r.addEventListener("change",StoryCharacters.updateCharacterInventory),n.appendChild(r),i.appendChild(n),i},StoryCharacters.updateCharacterInventory=function(e){DBMS.updateCharacterInventory(Stories.CurrentStoryName,e.target.characterName,e.target.value,Utils.processError())},StoryCharacters.getCharacterActivity=function(e,t){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(e.displayName)),i.appendChild(n);var r;return Constants.characterActivityTypes.forEach(function(e){n=makeEl("td"),r=makeEl("input"),addClass(r,"isStoryEditable"),r.type="checkbox",t.activity[e]&&(r.checked=!0),r.characterName=t.name,r.activityType=e,r.addEventListener("change",StoryCharacters.onChangeCharacterActivity),n.appendChild(r),i.appendChild(n)}),i},StoryCharacters.onChangeCharacterActivity=function(e){DBMS.onChangeCharacterActivity(Stories.CurrentStoryName,e.target.characterName,e.target.activityType,e.target.checked,Utils.processError())};var StoryEvents={};StoryEvents.init=function(){var e=getEl("createEventButton");e.addEventListener("click",StoryEvents.createEvent),e=getEl("moveEventButton"),e.addEventListener("click",StoryEvents.moveEvent),e=getEl("cloneEventButton"),e.addEventListener("click",StoryEvents.cloneEvent),e=getEl("mergeEventButton"),e.addEventListener("click",StoryEvents.mergeEvents),e=getEl("removeEventButton"),e.addEventListener("click",StoryEvents.removeEvent),StoryEvents.content=getEl("storyEventsDiv")},StoryEvents.refresh=function(){StoryEvents.clearInterface(),void 0!==Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void DBMS.getMetaInfo(function(e,i){return e?void Utils.handleError(e):void DBMS.getStoryEvents(Stories.CurrentStoryName,function(e,n){return e?void Utils.handleError(e):(StoryEvents.rebuildInterface(n,i),Utils.enable(StoryEvents.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryEvents.clearInterface=function(){clearEl(getEl("eventBlockHead")),clearEl(getEl("eventBlock"));var e=nl2array(document.querySelectorAll(".eventPositionSelector"));R.ap([clearEl],e);var t=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],t)},StoryEvents.rebuildInterface=function(e,t){var i=clearEl(getEl("eventBlockHead")),n=clearEl(getEl("eventBlock"));addEl(i,StoryEvents.getEventHeader());var r,o,s=R.curry(function(e,t){addEl(e,addEl(makeEl("option"),makeText(t)))}),a=nl2array(document.querySelectorAll(".eventPositionSelector"));R.ap([clearEl],a),a.forEach(function(t){o=s(t),e.forEach(function(e){o(strFormat(getL10n("common-set-item-before"),[e.name]))}),o(getL10n("common-set-item-as-last")),t.selectedIndex=e.length}),R.ap([addEl(n)],e.map(function(e,i){return StoryEvents.appendEventInput(e,i,t.date,t.preGameDate)})),StoryEvents.eventsLength=e.length;var l=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],l),e.forEach(function(e,t){l.forEach(function(i){r=makeEl("option"),r.appendChild(makeText(e.name)),r.eventIndex=t,i.appendChild(r)})})},StoryEvents.createEvent=function(){var e=getEl("eventNameInput"),t=e.value.trim(),i=getEl("eventTextInput"),n=getEl("positionSelector"),r=i.value.trim();return""===t?void Utils.alert(getL10n("stories-event-name-is-not-specified")):""===r?void Utils.alert(getL10n("stories-event-text-is-empty")):void DBMS.createEvent(Stories.CurrentStoryName,t,r,n.value===getL10n("common-set-item-as-last"),n.selectedIndex,function(t){return t?void Utils.handleError(t):(e.value="",i.value="",void StoryEvents.refresh())})},StoryEvents.moveEvent=function(){var e=getEl("moveEventSelector").selectedOptions[0].eventIndex,t=getEl("movePositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("stories-event-positions-are-the-same")):void DBMS.moveEvent(Stories.CurrentStoryName,e,t,Utils.processError(StoryEvents.refresh))},StoryEvents.cloneEvent=function(){var e=getEl("cloneEventSelector").selectedIndex;DBMS.cloneEvent(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.mergeEvents=function(){var e=getEl("mergeEventSelector").selectedIndex;return StoryEvents.eventsLength==e+1?void Utils.alert(getL10n("stories-cant-merge-last-event")):void DBMS.mergeEvents(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.removeEvent=function(){var e=getEl("removeEventSelector");Utils.confirm(strFormat(getL10n("stories-remove-event-warning"),[e.value]))&&DBMS.removeEvent(Stories.CurrentStoryName,e.selectedIndex,Utils.processError(StoryEvents.refresh))},StoryEvents.getEventHeader=function(){var e=makeEl("tr");return addEl(e,addEl(makeEl("th"),makeText("№"))),addEl(e,addEl(makeEl("th"),makeText(getL10n("stories-event")))),e},StoryEvents.appendEventInput=function(e,t,i,n){var r=makeEl("tr");addEl(r,addEl(makeEl("td"),addEl(makeEl("span"),makeText(t+1))));var o=makeEl("td"),s=addClass(makeEl("div"),"story-events-div-main"),a=addClass(makeEl("div"),"story-events-div-left"),l=addClass(makeEl("div"),"story-events-div-right");return addEl(s,a),addEl(s,l),addEl(o,s),addEl(a,StoryEvents.makeEventNameInput(e,t)),addEl(l,UI.makeEventTimePicker({eventTime:e.time,index:t,preGameDate:n,date:i,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:StoryEvents.onChangeDateTimeCreator})),addEl(o,StoryEvents.makeEventTextInput(e,t)),addEl(r,o),r},StoryEvents.makeEventNameInput=function(e,t){var i=makeEl("input");return addClass(i,"isStoryEditable"),i.value=e.name,i.eventIndex=t,i.addEventListener("change",StoryEvents.updateEventName),i},StoryEvents.makeEventTextInput=function(e,t){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventText"),i.value=e.text,i.eventIndex=t,i.addEventListener("change",StoryEvents.updateEventText),i},StoryEvents.onChangeDateTimeCreator=function(e){return function(t,i){DBMS.updateEventProperty(Stories.CurrentStoryName,e.eventIndex,"time",i.val(),Utils.processError()),StoryEvents.lastDate=i.val(),removeClass(e,"defaultDate")}},StoryEvents.updateEventName=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-name-is-not-specified")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"name",t.value,Utils.processError(StoryEvents.refresh))},StoryEvents.updateEventText=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-text-is-empty")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"text",t.value,Utils.processError())};var Template={};Template.init=function(){},Template.refresh=function(){};var Timeline={};Timeline.init=function(){var e=getEl("timelineStorySelector");e.addEventListener("change",Timeline.onStorySelectorChangeDelegate);var t=getEl("timelineContainer");Timeline.TimelineDataset=new vis.DataSet,Timeline.TagDataset=new vis.DataSet;var i={orientation:"top",showCurrentTime:!1},n=new vis.Timeline(t,null,i);n.setGroups(Timeline.TagDataset),n.setItems(Timeline.TimelineDataset),Timeline.timelineComponent=n,Timeline.content=getEl("timelineDiv")},Timeline.refresh=function(){var e=getEl("timelineStorySelector");clearEl(e);var t;DBMS.getMetaInfo(function(i,n){if(i)return void Utils.handleError(i);Timeline.postDate=n.date,Timeline.preDate=n.preGameDate;var r=new Date(Timeline.postDate),o=new Date(Timeline.preDate);r.setFullYear(r.getFullYear()+1),o.setFullYear(o.getFullYear()-1),Timeline.timelineComponent.setOptions({end:r,start:o}),PermissionInformer.getStoryNamesArray(!1,function(i,n){return i?void Utils.handleError(i):(n.forEach(function(i){t=makeEl("option"),t.appendChild(makeText(i.displayName)),t.value=i.value,e.appendChild(t)}),void(0!=n.length&&Timeline.onStorySelectorChange([n[0].value])))})})},Timeline.onStorySelectorChangeDelegate=function(e){for(var t=e.target.selectedOptions,i=[],n=0;n<t.length;n++)i.push(t[n].value);Timeline.onStorySelectorChange(i)},Timeline.onStorySelectorChange=function(e){Timeline.TagDataset.clear(),Timeline.TimelineDataset.clear();var t;DBMS.getEventGroupsForStories(e,function(i,n){return i?void Utils.handleError(i):(n.forEach(function(e){t=e.storyName,Timeline.TagDataset.add({id:t,content:t});var i=e.events;i.forEach(function(e){var i=Timeline.postDate;e.time&&(i=e.time),Timeline.TimelineDataset.add({content:e.name,start:i,group:t,storyName:t,eventIndex:e.index})})}),void(e[0]&&(Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-end-date"),start:new Date(Timeline.postDate),group:e[0],className:"importantItem",editable:!1}),Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-start-date"),start:new Date(Timeline.preDate),group:e[0],className:"importantItem",editable:!1}))))})};var NetworkSubsetsSelector={};NetworkSubsetsSelector.init=function(){listen(getEl("networkSubsetsSelector"),"change",NetworkSubsetsSelector.onNetworkSubsetsChange)},NetworkSubsetsSelector.refresh=function(e){NetworkSubsetsSelector.parent=e;var t,i=clearEl(getEl("networkSubsetsSelector")),n=!0;Constants.objectSubsets.forEach(function(e){t=makeEl("option"),t.appendChild(makeText(constL10n(e))),t.value=e,n&&(t.selected=!0,n=!1),i.appendChild(t)}),i=clearEl(getEl("networkCharacterSelector")),Object.keys(NetworkSubsetsSelector.parent.Characters).map(function(e){return NetworkSubsetsSelector.parent.Characters[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,i.appendChild(t)}),i=clearEl(getEl("networkStorySelector")),Object.keys(NetworkSubsetsSelector.parent.Stories).map(function(e){return NetworkSubsetsSelector.parent.Stories[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,i.appendChild(t)})},NetworkSubsetsSelector.getStoryNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Stories);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var i,n={};for(i=0;i<e.selectedOptions.length;i+=1)n[e.selectedOptions[i].value]=!0;var r,o,s=[],a=function(e){return n[e]};return Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){r=NetworkSubsetsSelector.parent.Stories[e],o=Object.keys(r.characters),o.some(a)&&s.push(e)}),s}e=getEl("networkStorySelector");var i,s=[];for(i=0;i<e.selectedOptions.length;i+=1)s.push(e.selectedOptions[i].value);return s},NetworkSubsetsSelector.getCharacterNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Characters);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var i,n={},r={};for(i=0;i<e.selectedOptions.length;i+=1)n[e.selectedOptions[i].value]=!0;var o,s,a,l,h=function(e){return n[e]};Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){o=NetworkSubsetsSelector.parent.Stories[e],s=Object.keys(o.characters),s.some(h)&&o.events.forEach(function(e){a=Object.keys(e.characters),a.some(h)&&a.forEach(function(e){h(e)||(r[e]=!0)})})});var c=Object.keys(n).concat(Object.keys(r));return c}e=getEl("networkStorySelector");var i,d=[],u={};for(i=0;i<e.selectedOptions.length;i+=1)d.push(e.selectedOptions[i].value);var o;return d.forEach(function(e){o=NetworkSubsetsSelector.parent.Stories[e];for(l in o.characters)u[l]=!0}),Object.keys(u)},NetworkSubsetsSelector.onNetworkSubsetsChange=function(e){var t=e.target.value,i=getEl("networkCharacterDiv"),n=getEl("networkStoryDiv");setClassByCondition(i,"hidden",t!==Constants.objectSubsets[1]),setClassByCondition(n,"hidden",t!==Constants.objectSubsets[2])};var SocialNetwork={};SocialNetwork.colorMap={},SocialNetwork.activityColors={active:"red",follower:"blue",defensive:"green",passive:"grey"},SocialNetwork.generatedColors=[],SocialNetwork.focusOptions={scale:1.2,offset:{x:0,y:0},animation:{duration:1e3,easingFunction:"easeInOutQuad"}},SocialNetwork.fixedColors={storyColor:{color:{background:"rgb(255,255,0)",border:"rgb(255,168,3)"}},noGroup:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}},thirdDegreeNode:{color:{background:"rgba(200,200,200,0.5)",border:"rgba(200,200,200,0.5)"}},secondDegreeNode:{color:{background:"rgba(150,150,150,0.75)",border:"rgba(150,150,150,0.75)"}},firstDegreeNode:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}}},SocialNetwork.init=function(){SocialNetwork.highlightActive=!0,NetworkSubsetsSelector.init(),listen(getEl("networkNodeGroupSelector"),"change",function(e){SocialNetwork.updateNodes(e.target.value)}),listen(getEl("drawNetworkButton"),"click",SocialNetwork.onDrawNetwork),$("#nodeFocusSelector").select2().on("change",SocialNetwork.onNodeFocus);var e=getEl("networkSelector");e.addEventListener("change",SocialNetwork.onNetworkSelectorChangeDelegate),e=getEl("activitySelector"),e.addEventListener("change",SocialNetwork.onActivitySelectorChangeDelegate);var t,i;Constants.characterActivityTypes.forEach(function(n){i=makeEl("option"),i.appendChild(makeText(constL10n(n))),t=i.style,t.color=SocialNetwork.activityColors[n],i.activity=n,e.appendChild(i)}),SocialNetwork.selectedActivities={},SocialNetwork.network,SocialNetwork.highlightActive=!1,getEl("hideNetworkSettingsButton").addEventListener("click",SocialNetwork.togglePanel),getEl("showNetworkSettingsButton").addEventListener("click",SocialNetwork.togglePanel);var n=function(){var e=clearEl(getEl("socialNetworkWarning"));addEl(e,makeText(getL10n("social-network-require-resources-warning")));var t=makeEl("button");addEl(t,makeText(getL10n("social-network-remove-resources-warning"))),addEl(e,t),t.addEventListener("click",function(){addClass(e,"hidden")})};n(),L10n.onL10nChange(n),SocialNetwork.nodeSort=CommonUtils.charOrdAFactory(function(e){return e.label.toLowerCase()}),SocialNetwork.content=getEl("socialNetworkDiv")},SocialNetwork.refresh=function(){var e,t=clearEl(getEl("networkSelector"));Constants.networks.forEach(function(i){e=makeEl("option"),e.appendChild(makeText(constL10n(i))),e.value=i,t.appendChild(e)}),t.value=Constants.networks[0],t=clearEl(getEl("networkNodeGroupSelector")),PermissionInformer.getCharacterNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!1,function(e,n){return e?void Utils.handleError(e):void DBMS.getAllProfiles(function(e,r){return e?void Utils.handleError(e):(SocialNetwork.Characters=r,i.forEach(function(e){r[e.value].displayName=e.displayName}),void DBMS.getAllStories(function(e,i){return e?void Utils.handleError(e):(SocialNetwork.Stories=i,n.forEach(function(e){i[e.value].displayName=e.displayName}),void DBMS.getAllProfileSettings(function(e,i){if(e)return void Utils.handleError(e);var n=i.filter(function(e){return"enum"===e.type||"checkbox"===e.type}),r=[{name:Constants.noGroup,displayName:constL10n(Constants.noGroup)}].concat(n.map(function(e){return{name:e.name,displayName:e.name}}));r.forEach(function(e){var i=makeEl("option");i.appendChild(makeText(e.displayName)),i.value=e.name,t.appendChild(i)}),SocialNetwork.groupColors={};for(var o in SocialNetwork.fixedColors)SocialNetwork.groupColors[o]=SocialNetwork.fixedColors[o];n.forEach(function(e){"enum"===e.type?e.value.split(",").forEach(function(t,i){SocialNetwork.groupColors[e.name+"."+t.trim()]=Constants.colorPalette[i]}):"checkbox"===e.type&&(e.value?(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[0],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[1]):(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[1],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[0]))}),NetworkSubsetsSelector.refresh(SocialNetwork)}))}))})})})},SocialNetwork.refreshLegend=function(e){var t=getEl("colorLegend");clearEl(t);var i;Object.keys(SocialNetwork.groupColors).filter(function(t){return t.substring(0,e.length)===e}).forEach(function(e){i=makeEl("div"),i.appendChild(makeText("noGroup"===e?constL10n("noGroup"):e)),i.style.backgroundColor=SocialNetwork.groupColors[e].color.background,i.style.border="solid 2px "+SocialNetwork.groupColors[e].color.border,t.appendChild(i)}),-1!==["characterPresenceInStory","characterActivityInStory"].indexOf(SocialNetwork.selectedNetwork)&&(i=makeEl("div"),i.appendChild(makeText(getL10n("social-network-story"))),i.style.backgroundColor=SocialNetwork.fixedColors.storyColor.color.background,i.style.border="solid 2px "+SocialNetwork.fixedColors.storyColor.color.border,t.appendChild(i))},SocialNetwork.updateNodes=function(e){SocialNetwork.refreshLegend(e);var t;NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var n=SocialNetwork.Characters[i];t="noGroup"===e?e:e+"."+n[e],SocialNetwork.nodesDataset.update({id:n.name,group:t})})},SocialNetwork.onActivitySelectorChangeDelegate=function(e){SocialNetwork.selectedActivities={};var t;for(t=0;t<e.target.selectedOptions.length;t+=1)SocialNetwork.selectedActivities[e.target.selectedOptions[t].activity]=!0},SocialNetwork.onNetworkSelectorChangeDelegate=function(e){var t=e.target.value,i=getEl("activityBlock");setClassByCondition(i,"hidden","characterActivityInStory"!==t)},SocialNetwork.onNodeFocus=function(e){SocialNetwork.network.focus(e.target.value,SocialNetwork.focusOptions)},SocialNetwork.onDrawNetwork=function(){SocialNetwork.onNetworkSelectorChange(getEl("networkSelector").value)},SocialNetwork.onNetworkSelectorChange=function(e){switch(SocialNetwork.selectedNetwork=e,SocialNetwork.nodes=[],SocialNetwork.edges=[],e){case"simpleNetwork":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getSimpleEdges();break;case"socialRelations":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getDetailedEdges();break;case"characterPresenceInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getStoryEdges();break;case"characterActivityInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getActivityEdges()}SocialNetwork.refreshLegend(getEl("networkNodeGroupSelector").value),clearEl(getEl("nodeFocusSelector")),SocialNetwork.nodes.sort(SocialNetwork.nodeSort);var t=getSelect2DataCommon(remapProps(["id","text"],["id","label"]),SocialNetwork.nodes);$("#nodeFocusSelector").select2(t),SocialNetwork.nodesDataset=new vis.DataSet(SocialNetwork.nodes),SocialNetwork.edgesDataset=new vis.DataSet(SocialNetwork.edges),SocialNetwork.redrawAll()},SocialNetwork.getCharacterNodes=function(){var e=getEl("networkNodeGroupSelector").value,t=[];return NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var n=SocialNetwork.Characters[i];t.push({id:n.name,label:n.name.split(" ").join("\n"),group:"noGroup"===e?constL10n("noGroup"):e+"."+n[e]})}),t},SocialNetwork.getStoryNodes=function(){var e=NetworkSubsetsSelector.getStoryNames().map(function(e){return{id:"St:"+e,label:e.split(" ").join("\n"),value:Object.keys(SocialNetwork.Stories[e].characters).length,title:Object.keys(SocialNetwork.Stories[e].characters).length,group:"storyColor"}});return e},SocialNetwork.getActivityEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var i=SocialNetwork.Stories[t];for(var n in i.characters)for(var r in i.characters[n].activity)SocialNetwork.selectedActivities[r]&&e.push({from:"St:"+t,to:n,color:SocialNetwork.activityColors[r],width:2,hoverWidth:4})}return e},SocialNetwork.getStoryEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var i=SocialNetwork.Stories[t];for(var n in i.characters)e.push({from:"St:"+t,to:n,color:"grey"})}return e},SocialNetwork.getSimpleEdges=function(){var e=[],t={};for(var i in SocialNetwork.Stories){var n=SocialNetwork.Stories[i];n.events.forEach(function(n){for(var r in n.characters)for(var o in n.characters)r===o||t[i+r+o]||t[i+o+r]||(t[i+r+o]=!0,e.push({from:r,to:o,color:"grey"}))})}return e},SocialNetwork.getDetailedEdges=function(){var e={};for(var t in SocialNetwork.Stories){var i=SocialNetwork.Stories[t];i.events.forEach(function(i){for(var n in i.characters)for(var r in i.characters)if(n!==r)if(e[n+r]||e[r+n]){if(e[n+r]||e[r+n]){var o=e[n+r]?e[n+r]:e[r+n];o.title[t]||(o.title[t]=!0,o.value++)}}else{var s={};s[t]=!0,e[n+r]={value:1,from:n,to:r,title:s}}})}var n=Object.keys(e).map(function(t){var i=e[t],n="",r=!0;for(var o in i.title)n+=(r?"":",")+o,r=!1;return{from:i.from,to:i.to,title:i.value+":"+n,value:i.value,color:"grey"}});return n},SocialNetwork.redrawAll=function(){var e=getEl("socialNetworkContainer"),t={nodes:{shape:"dot",scaling:{min:10,max:30,label:{min:8,max:30,drawThreshold:5,maxVisible:30}},font:{size:20,face:"Tahoma"}},edges:{width:.15,color:{inherit:"from"},smooth:{type:"dynamic"}},physics:{barnesHut:{gravitationalConstant:-3e4,springConstant:.1},stabilization:{iterations:50}},layout:{randomSeed:1200},interaction:{tooltipDelay:200},groups:SocialNetwork.groupColors},i={nodes:SocialNetwork.nodesDataset,edges:SocialNetwork.edgesDataset};SocialNetwork.network&&SocialNetwork.network.destroy(),SocialNetwork.network=new vis.Network(e,i,t),SocialNetwork.network.on("click",SocialNetwork.neighbourhoodHighlight)},SocialNetwork.neighbourhoodHighlight=function(e){var t=SocialNetwork.nodesDataset.get({returnType:"Object"}),i=SocialNetwork.network,n=SocialNetwork.nodesDataset;if(e.nodes.length>0){SocialNetwork.highlightActive=!0;var r,o,s=e.nodes[0],a=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var h=i.getConnectedNodes(s),c=[];for(r=1;a>r;r++)for(o=0;o<h.length;o++)c=c.concat(i.getConnectedNodes(h[o]));for(r=0;r<c.length;r++)t[c[r]].color="rgba(150,150,150,0.75)",void 0!==t[c[r]].hiddenLabel&&(t[c[r]].label=t[c[r]].hiddenLabel,t[c[r]].hiddenLabel=void 0);for(r=0;r<h.length;r++)t[h[r]].color=void 0,void 0!==t[h[r]].hiddenLabel&&(t[h[r]].label=t[h[r]].hiddenLabel,t[h[r]].hiddenLabel=void 0);t[s].color=void 0,void 0!==t[s].hiddenLabel&&(t[s].label=t[s].hiddenLabel,t[s].hiddenLabel=void 0)}else if(e.edges.length>0){SocialNetwork.highlightActive=!0;var r,o,d=e.edges[0],a=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var u=i.getConnectedNodes(d),f=[];for(r=1;a>r;r++)for(o=0;o<u.length;o++)f=f.concat(i.getConnectedNodes(u[o]));for(r=0;r<f.length;r++)t[f[r]].color="rgba(150,150,150,0.75)",void 0!==t[f[r]].hiddenLabel&&(t[f[r]].label=t[f[r]].hiddenLabel,t[f[r]].hiddenLabel=void 0);for(r=0;r<u.length;r++)t[u[r]].color=void 0,void 0!==t[u[r]].hiddenLabel&&(t[u[r]].label=t[u[r]].hiddenLabel,t[u[r]].hiddenLabel=void 0)}else if(SocialNetwork.highlightActive===!0){for(var l in t)t[l].color=void 0,void 0!==t[l].hiddenLabel&&(t[l].label=t[l].hiddenLabel,t[l].hiddenLabel=void 0);SocialNetwork.highlightActive=!1}var p=[];for(l in t)t.hasOwnProperty(l)&&p.push(t[l]);n.update(p)},SocialNetwork.togglePanel=function(){toggleClass(getEl("commonSettingsContainer"),"hidden"),toggleClass(getEl("privateSettingsContainer"),"hidden"),toggleClass(getEl("showSettingsButtonContainer"),"hidden")};