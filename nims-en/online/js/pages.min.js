"use strict";function FilterConfiguration(t){this.info=t,this.innerProfileSettings=CommonUtils.clone(t.innerProfileSettings),this.innerProfileSettings.forEach(function(t){CommonUtils.startsWith(t.name,"profile-")||(t.displayName=getL10n(t.displayName),t.value=""),t.canHide=t.name!=Constants.CHAR_NAME})}var About={};About.init=function(){About.content=getEl("aboutDiv")},About.refresh=function(){};var AccessManager={};AccessManager.init=function(){listen(getEl("createUserButton"),"click",AccessManager.createUser),listen(getEl("changePasswordButton"),"click",AccessManager.changePassword),listen(getEl("removeUserButton"),"click",AccessManager.removeUser),listen(getEl("assignPermissionButton"),"click",AccessManager.assignPermission),listen(getEl("removePermissionButton"),"click",AccessManager.removePermission),listen(getEl("newAdminButton"),"click",AccessManager.assignNewAdmin),listen(getEl("removeEditorButton"),"click",AccessManager.removeEditor),listen(getEl("newEditorButton"),"click",AccessManager.assignEditor),AccessManager.entities=["characters","stories","groups"];var t,e,i=document.getElementsByClassName("adaptationRights");for(t=0;t<i.length;t++)e=i[t],e.addEventListener("click",AccessManager.changeAdaptationRightsMode);AccessManager.content=getEl("accessManagerDiv")},AccessManager.refresh=function(){DBMS.getManagementInfo(function(t,e){return t?void Utils.handleError(t):void PermissionInformer.isAdmin(function(t,i){return t?void Utils.handleError(t):void PermissionInformer.isEditor(function(t,n){return t?void Utils.handleError(t):void PermissionInformer.getCharacterNamesArray(!i,function(t,r){return t?void Utils.handleError(t):void PermissionInformer.getStoryNamesArray(!i,function(t,o){return t?void Utils.handleError(t):void PermissionInformer.getGroupNamesArray(!i,function(t,a){if(t)return void Utils.handleError(t);var s={characters:r,groups:a,stories:o};if(!i&&n)for(var l in s)s[l]=s[l].filter(R.prop("isOwner"));AccessManager.rebuildInterface(s,e),Utils.enable(AccessManager.content,"adminOnly",i),Utils.enable(AccessManager.content,"editorOrAdmin",i||n)})})})})})})},AccessManager.rebuildInterface=function(t,e){var i=e.usersInfo,n=Object.keys(i).sort(CommonUtils.charOrdA),r=[];r.push(getEl("passwordUserName")),r.push(getEl("userPermissionSelector")),r.push(getEl("newEditorSelector")),r.forEach(function(t){Utils.rebuildSelectorArr(t,n)});var o=n.slice(0);o.splice(n.indexOf(e.admin),1);var a=getEl("newAdminSelector");Utils.rebuildSelectorArr(a,o),a=getEl("userRemoveSelector"),Utils.rebuildSelectorArr(a,o),AccessManager.entities.forEach(function(e){Utils.rebuildSelector(getEl("permission-selector__"+e),t[e])}),addEl(clearEl(getEl("currentAdministrator")),makeText(e.admin));var s=clearEl(getEl("currentEditor"));e.editor&&addEl(s,makeText(e.editor)),getEl("adaptationRights"+e.adaptationRights).checked=!0,AccessManager.buildPermissionList(t,i)},AccessManager.buildPermissionList=function(t,e){function i(t){return addEl(makeEl("li"),makeText(t))}function n(t){return AccessManager.entities.reduce(function(e,n){return e.push(i(a[n])),e.push(addEls(makeEl("ol"),t[n].sort().map(i))),e},[])}var r=clearEl(getEl("permissionTable")),o=makeEl("ul");addEl(r,o),R.keys(t).forEach(function(e){t[e]=t[e].map(R.prop("value"))}),R.values(e).forEach(function(e){R.keys(e).forEach(function(i){t[i]=R.difference(t[i],e[i])})}),e[getL10n("admins-have-not-owner")]=t;var a={characters:getL10n("admins-characters"),stories:getL10n("admins-stories"),groups:getL10n("admins-groups")},s=Object.keys(e).sort(CommonUtils.charOrdA);addEls(o,s.reduce(function(t,r){return t.push(i(r)),t.push(addEls(makeEl("ol"),n(e[r]))),t},[]))},AccessManager.createUser=function(){var t=getEl("userNameInput"),e=t.value.trim();if(""===e)return void Utils.alert(getL10n("admins-user-name-is-not-specified"));var i=getEl("userPasswordInput"),n=i.value.trim();return""===n?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.isUserNameUsed(e,function(t,i){return t?void Utils.handleError(t):void(i?Utils.alert(getL10n("admins-user-already-exists")):DBMS.createUser(e,n,Utils.processError(AccessManager.refresh)))})},AccessManager.changePassword=function(){var t=getEl("passwordUserName").value.trim(),e=getEl("newPassword").value.trim();return""===e?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.changePassword(t,e,Utils.processError(AccessManager.refresh))},AccessManager.removeUser=function(){var t=getEl("userRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-user-remove"),[t]))&&DBMS.removeUser(t,Utils.processError(AccessManager.refresh))},AccessManager.getSelectedOptions=function(t){for(var e=getEl(t).selectedOptions,i=[],n=0;n<e.length;n++)i.push(e[n].value);return i},AccessManager.permissionAction=function(t){return function(){var e=getEl("userPermissionSelector").value.trim();if(""===e)return void Utils.alert(getL10n("admins-user-is-not-selected"));var i={};AccessManager.entities.forEach(function(t){i[t]=AccessManager.getSelectedOptions("permission-selector__"+t)}),DBMS[t](e,i,Utils.processError(AccessManager.refresh))}},AccessManager.removePermission=AccessManager.permissionAction("removePermission"),AccessManager.assignPermission=AccessManager.permissionAction("assignPermission"),AccessManager.assignNewAdmin=function(){var t=getEl("newAdminSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-admin-assigment"),[t]))&&DBMS.assignAdmin(t,Utils.processError(AccessManager.refresh))},AccessManager.removeEditor=function(){DBMS.removeEditor(Utils.processError(AccessManager.refresh))},AccessManager.assignEditor=function(){var t=getEl("newEditorSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-editor-assigment"),[t]))&&DBMS.assignEditor(t,Utils.processError(AccessManager.refresh))},AccessManager.changeAdaptationRightsMode=function(t){DBMS.changeAdaptationRightsMode(t.target.value,Utils.processError())};var BriefingExport={};BriefingExport.templates={},BriefingExport.init=function(){listen(getEl("makeDefaultTextBriefings"),"click",function(){BriefingExport.resolveTextTemplate(function(t){BriefingExport.makeTextBriefings("txt",t)})}),listen(getEl("makeCustomTextBriefings"),"click",function(){BriefingExport.makeTextBriefings(getEl("textTypeSelector").value,getEl("templateArea").value)});var t=getEl("docxBriefings");t.addEventListener("change",BriefingExport.readTemplateFile);for(var e=document.querySelectorAll("#briefingExportDiv input[name=exportSelection]"),i=0;i<e.length;i++)listen(e[i],"change",BriefingExport.onExportSelectionChange);getEl("exportSelectionAll").checked=!0,t=getEl("briefingNumberSelector"),Constants.briefingNumber.forEach(R.compose(addEl(t),makeOpt)),listen(t,"change",BriefingExport.onNumberSelectorChange),BriefingExport.briefingNumberSelector=t,BriefingExport.briefingIntervalSelector=getEl("briefingIntervalSelector"),BriefingExport.briefingMultiSelector=getEl("briefingMultiSelector"),getEl("makeBriefingsByTime ".trim()).addEventListener("click",BriefingExport.makeExport("templateByTime")),getEl("makeBriefingsByStory".trim()).addEventListener("click",BriefingExport.makeExport("templateByStory")),getEl("makeInventoryList   ".trim()).addEventListener("click",BriefingExport.makeExport("inventoryTemplate")),UI.initTabPanel("exportModeButton","exportContainer"),listen(getEl("previewTextOutput"),"click",BriefingExport.previewTextOutput),getEl("textBriefingPreviewArea").value="",listen(getEl("showRawData"),"click",BriefingExport.previewTextDataAsIs),listen(getEl("convertToDocxTemplate"),"click",BriefingExport.convertToDocxTemplate),listen(getEl("generateByDocxTemplate"),"click",BriefingExport.generateByDocxTemplate),BriefingExport.briefingSelector=getEl("briefingSelector"),BriefingExport.briefingMultiSelect=getEl("briefingMultiSelect"),BriefingExport.content=getEl("briefingExportDiv")},BriefingExport.refresh=function(){BriefingExport.resolveTextTemplate(function(t){getEl("templateArea").value=t,BriefingExport.onNumberSelectorChange()})},BriefingExport.resolveTextTemplate=function(t){DBMS.getAllProfileSettings(function(e,i){if(e)return void Utils.handleError(e);var n=R.compose(R.join(""),R.insert(1,R.__,["{{profileInfo-","}}\n"]),R.prop("name")),r=R.compose(R.equals(!0),R.prop("doExport")),o=i.filter(r).map(n).join("");t(R.replace(/\{0\}/g,o,TEXT_TEMPLATE))})},BriefingExport.onExportSelectionChange=function(t){var e="exportSelectionSpecific"===t.target.id,i="exportSelectionMultiple"===t.target.id;setClassByCondition(BriefingExport.briefingSelector,"hidden",!e),setClassByCondition(BriefingExport.briefingMultiSelect,"hidden",!i)},BriefingExport.getSelectedUsers=function(){var t=getSelectedRadio("#briefingExportDiv input[name=exportSelection]").id;switch(t){case"exportSelectionAll":return null;case"exportSelectionSpecific":return JSON.parse(BriefingExport.briefingIntervalSelector.selectedOptions[0].value);case"exportSelectionMultiple":for(var e=BriefingExport.briefingMultiSelector.selectedOptions,i={},n=0;n<e.length;n++)i[e[n].value]=!0;return i;default:Utils.alert("unexpected id: "+t)}return null},BriefingExport.onNumberSelectorChange=function(){var t,e,i,n=(clearEl(BriefingExport.briefingIntervalSelector),clearEl(BriefingExport.briefingMultiSelector)),r=Number(BriefingExport.briefingNumberSelector.value);PermissionInformer.getCharacterNamesArray(!1,function(o,a){if(o)return void Utils.handleError(o);if(a.length>0){t=arr2Chunks(a,r);var s=t.map(function(t){return e=1===t.length?t[0].displayName:t[0].displayName+" - "+t[t.length-1].displayName,i=JSON.stringify(t.reduce(function(t,e){return t[e.value]=!0,t},{})),{id:i,text:e}});$("#"+BriefingExport.briefingIntervalSelector.id).select2({data:s}),fillSelector(n,a.map(remapProps4Select))}})},BriefingExport.makeExport=function(t){return function(){BriefingExport.templates[t]||(BriefingExport.templates[t]=atob(templatesArr[t])),BriefingExport.exportDocxByTemplate(BriefingExport.templates[t])}},BriefingExport.getBriefingData=function(t){DBMS.getBriefingData(BriefingExport.getSelectedUsers(),function(e,i){return e?void Utils.handleError(e):void DBMS.getAllProfileSettings(function(e,n){if(e)return void Utils.handleError(e);var r=n.filter(function(t,e){return"checkbox"===t.type}).map(R.prop("name"));i.briefings.forEach(function(t){t.profileInfoArray.forEach(function(t){-1!=r.indexOf(t.itemName)&&(t.value=constL10n(Constants[t.value]),t.splittedText=[{string:t.value}])}),r.forEach(function(e){t["profileInfo-"+e]=constL10n(Constants[t["profileInfo-"+e]])})}),t(null,i)})})},BriefingExport.exportDocxByTemplate=function(t){BriefingExport.getBriefingData(function(e,i){return e?void Utils.handleError(e):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",t),BriefingExport.generateSingleDocx("Uint8Array",t))})},BriefingExport.convertToDocxTemplate=function(){var t=BriefingExport.makeDocxTemplate("blob");Utils.confirm(getL10n("briefings-save-file"))&&saveAs(t,"template.docx")},BriefingExport.generateByDocxTemplate=function(){BriefingExport.exportDocxByTemplate(BriefingExport.makeDocxTemplate("Uint8Array"))},BriefingExport.makeDocxTemplate=function(t){var e=getEl("templateArea").value,i=R.pipe(R.replace(/{{{/g,"{"),R.replace(/}}}/g,"}"),R.replace(/{{/g,"{"),R.replace(/}}/g,"}"));e=i(e).split("\n").map(function(t){return{string:t}}),BriefingExport.templates.genericTemplate||(BriefingExport.templates.genericTemplate=atob(templatesArr.genericTemplate));var n=new window.Docxgen(BriefingExport.templates.genericTemplate);return n.setData({splittedText:e}),n.render(),n.getZip().generate({type:t})},BriefingExport.previewTextDataAsIs=function(){BriefingExport.getBriefingData(function(t,e){return t?void Utils.handleError(t):void(getEl("textBriefingPreviewArea").value=JSON.stringify(e,null,"  "))})},BriefingExport.previewTextOutput=function(){BriefingExport.getBriefingData(function(t,e){return t?void Utils.handleError(t):void(getEl("textBriefingPreviewArea").value=BriefingExport.generateSingleTxt(getEl("templateArea").value,e))})},BriefingExport.makeTextBriefings=function(t,e){var i=BriefingExport.generateSingleTxt(e);BriefingExport.getBriefingData(function(e,n){return e?void Utils.handleError(e):void BriefingExport.generateBriefings(n,t,function(t){var e=i(t);return new Blob([e],{type:"text/plain;charset=utf-8"})},i)})},BriefingExport.readTemplateFile=function(t){var e=t.target.files[0];if(e){var i=new FileReader;i.onload=function(t){var e=t.target.result;BriefingExport.getBriefingData(function(t,i){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",e),BriefingExport.generateSingleDocx("Uint8Array",e))})},i.readAsBinaryString(e)}else Utils.alert(getL10n("briefings-error-on-template-uploading"))};var updateStatus=function(t){var e=getEl("exportStatus");clearEl(e),e.appendChild(makeText(t))};BriefingExport.generateBriefings=function(t,e,i,n){var r,o,a=getEl("toSeparateFileCheckbox").checked,s="briefings";updateStatus(getL10n("briefings-save-preparing"));try{if(a){var l=new JSZip;l.generate();updateStatus(getL10n("briefings-start-saving"));var h=BriefingExport.makeArchiveData(t,n);for(var c in h)l.file(c+"."+e,h[c]);updateStatus(getL10n("briefings-archiving")),o=l.generate({type:"blob"}),updateStatus(getL10n("briefings-archive-is-ready")),BriefingExport.saveFile("briefings-save-archive",o,s+".zip")}else updateStatus(getL10n("briefings-start-saving")),r=i(t),updateStatus(getL10n("briefings-file-is-ready")),BriefingExport.saveFile("briefings-save-file",r,s+"."+e)}catch(d){Utils.alert(getL10n("briefings-error-on-generating-briefings")),console.log(d)}},BriefingExport.saveFile=function(t,e,i){Utils.confirm(getL10n(t))&&saveAs(e,i)},BriefingExport.makeArchiveData=function(t,e){var i={};return t.briefings.forEach(function(n,r){i[n.charName]=e({gameName:t.gameName,briefings:[n]}),updateStatus(strFormat(getL10n("briefings-save-status"),[r+1,t.briefings.length]))}),i},BriefingExport.generateSingleDocx=R.curry(function(t,e,i){var n=new window.Docxgen(e);n.setData(i),n.render();var r=n.getZip().generate({type:t});return r}),BriefingExport.generateSingleTxt=R.curry(function(t,e){try{return Mustache.render(t,e)}catch(i){throw Utils.alert(strFormat(getL10n("briefings-template-error"),[i.message])),i}}),function(t){var e;t.init=function(){$("#briefingCharacter").select2().on("change",i);var e=getEl("eventGroupingByStoryRadio");listen(e,"change",t.refresh),e.checked=!0,e=getEl("adaptationsModeRadio"),listen(e,"change",t.refresh),e.checked=!0,listen(getEl("eventGroupingByTimeRadio"),"change",t.refresh),listen(getEl("proofreadingModeRadio"),"change",t.refresh),listen(getEl("hideAllPanelsCheckbox"),"change",t.refresh),listen(getEl("disableHeadersCheckbox"),"change",t.refresh),t.content=getEl("briefingPreviewDiv")},t.refresh=function(){clearEl(getEl("briefingCharacter")),clearEl(getEl("briefingContent")),DBMS.getAllProfileSettings(function(t,i){return t?void Utils.handleError(t):(e=i,void PermissionInformer.getCharacterNamesArray(!1,function(t,e){if(t)return void Utils.handleError(t);if(e.length>0){var i=DBMS.getSettings();i.BriefingPreview||(i.BriefingPreview={characterName:e[0].value});var n=i.BriefingPreview.characterName,r=e.map(R.prop("value"));-1===r.indexOf(n)&&(i.BriefingPreview.characterName=e[0].value,n=e[0].value);var o=getSelect2Data(e);$("#briefingCharacter").select2(o).val(n).trigger("change")}}))})};var i=function(t){r(t.target.value)},n=function(t){var e=DBMS.getSettings();e.BriefingPreview.characterName=t},r=function(t){n(t);var e=clearEl(getEl("briefingContent")),i=0,r={characterName:t},a=function(){i<o.length?(i++,o[i-1].load(r,a)):o.map(R.prop("make")).forEach(function(t){t(e,r)})};a()},o=[{name:"storyRights",load:function(t,e){PermissionInformer.getStoryNamesArray(!0,function(i,n){return i?void Utils.handleError(i):(t.userStoryNamesMap=R.indexBy(R.prop("value"),n),void e())})},make:function(t,e){}},{name:"profile",load:function(t,e){DBMS.getProfile(t.characterName,function(i,n){return i?void Utils.handleError(i):(t.profile=n,void e())})},make:function(t,e){addEl(t,l(makeText(getL10n("briefings-profile")),b(e.profile)))}},{name:"inventory",load:function(t,e){DBMS.getAllInventoryLists(t.characterName,function(i,n){return i?void Utils.handleError(i):(t.allInventoryLists=n,void e())})},make:function(t,e){addEl(t,l(makeText(getL10n("briefings-inventory")+" ("+e.allInventoryLists.length+")"),v(e.allInventoryLists,e.characterName,e.userStoryNamesMap)))}},{name:"groups",load:function(t,e){DBMS.getCharacterGroupTexts(t.characterName,function(i,n){return i?void Utils.handleError(i):(t.groupTexts=n,void e())})},make:function(t,e){addEl(t,l(makeText(getL10n("header-groups")+" ("+e.groupTexts.length+")"),g(e.groupTexts)))}},{name:"relations",load:function(t,e){DBMS.getAllProfiles(function(i,n){return i?void Utils.handleError(i):void DBMS.getRelationsSummary(t.characterName,function(i,r){return i?void Utils.handleError(i):void PermissionInformer.getCharacterNamesArray(!1,function(i,o){return i?void Utils.handleError(i):(t.relationsSummary=r,t.characterNamesArray=o,t.profiles=n,void e())})})})},make:function(t,e){var i=getL10n("header-relations")+" ("+R.keys(e.relationsSummary.directRelations).length+")";addEl(t,l(makeText(i),m(e.characterName,e.relationsSummary,e.characterNamesArray,e.profiles)))}},{name:"stories",load:function(t,e){e()},make:function(t,e){var i=getEl("eventGroupingByStoryRadio").checked;i?w(t,e.characterName,e.userStoryNamesMap):E(t,e.characterName,e.userStoryNamesMap)}}],a=function(){s(),Utils.enable(t.content,"notEditable",!1)},s=function(){R.ap([UI.resizeTextarea],nl2array(getEl("briefingContent").getElementsByTagName("textarea")).map(function(t){return{target:t}}))},l=function(t,e){var i=addClasses(makeEl("div"),["panel","panel-default"]),n=addClass(addEl(makeEl("h3"),t),"panel-title"),r=setAttr(makeEl("a"),"href","#/"),o=addClass(makeEl("div"),"panel-heading");addEl(i,addEl(o,addEl(r,n)));var a=addClass(makeEl("div"),"panel-body");setClassByCondition(a,"hidden",getEl("hideAllPanelsCheckbox").checked),addEl(i,addEl(a,e));var l=UI.togglePanel(a);return listen(r,"click",function(){l(),s()}),i},h=["character-name","direct-relation","reverse-relation","extra-info"],c=["character-name","direct-relation","extra-info"],d=function(t,e){return[addEl(addClass(makeEl("div"),"bold-cursive"),makeText(t)),makeText(e)]},u=R.curry(function(t,e,i,n,r,o){var a=addClass(makeEl("textarea"),"briefing-relation-area");a.value=n.directRelations[o]||"",listen(a,"change",function(t){DBMS.setCharacterRelation(r,o,t.target.value,Utils.processError())});var s;i?(s=addClass(makeEl("textarea"),"briefing-relation-area"),s.value=n.reverseRelations[o]||"",listen(s,"change",function(t){DBMS.setCharacterRelation(o,r,t.target.value,Utils.processError())})):s=makeEl("span");var l=n.knownCharacters[o],h=[addEl(makeEl("td"),makeText(o)),addEl(makeEl("td"),a)];i&&h.push(addEl(makeEl("td"),s));var c=[addClass(addEl(makeEl("div"),makeText(getL10n("briefings-where-meets"))),"bold-cursive"),addEl(makeEl("div"),makeText(void 0===l?"":R.keys(l).join(", "))),makeEl("br"),addEls(setAttr(makeEl("div"),"toCharacter",o),d(e.value,t[o][e.value]))];return h.push(addEls(makeEl("td"),c)),addEls(makeEl("tr"),h)}),f=function(t,e,i){var n=$("<select></select>"),r=$("<span></span>").append(n);addClass(n[0],"common-select");var o=(n.select2(getSelect2Data(e)),addEl(makeEl("button"),makeText(getL10n("common-add"))));return listen(o,"click",function(){i(n[0].value),e=e.filter(R.compose(R.not,R.equals(n[0].value),R.prop("value"))),clearEl(n[0]),n.select2(getSelect2Data(e))}),addEls(makeEl("div"),[addEl(makeEl("span"),makeText(t)),r[0],o])},p=function(t){var i=$("<select></select>"),n=$("<span></span>").append(i);addClasses(i[0],["common-select","profile-item-select"]);var r=i.select2(arr2Select2(e.map(R.prop("name")).sort()));return r.on("change",t),e[0]&&r.val(e[0].name).trigger("change"),{el:addEls(makeEl("div"),[addEl(makeEl("span"),makeText(getL10n("briefings-profile-item"))),n[0]]),select:i[0]}},m=function(t,e,i,n){i=i.filter(R.compose(R.not,R.equals(t),R.prop("value")));var r=R.union(R.keys(e.directRelations),R.keys(e.reverseRelations)).sort(),o=i.filter(R.compose(R.not,R.contains(R.__,r),R.prop("value"))),a=o.filter(R.compose(R.contains(R.__,R.keys(e.knownCharacters)),R.prop("value"))),s=o.filter(R.compose(R.not,R.contains(R.__,R.keys(e.knownCharacters)),R.prop("value"))),l=getEl("adaptationsModeRadio").checked,m=makeEl("tbody"),g=p(function(t){var e=nl2array(queryElEls(m,"[toCharacter]"));e.map(clearEl).forEach(function(e){var i=getAttr(e,"toCharacter"),r=t.target.value;addEls(e,d(r,n[i][r]))})}),v=u(n,g.select,l,e,t),y=R.compose(addEl(m),v),b=addEls(addClass(makeEl("div"),"entity-management relations-management"),[f(getL10n("briefings-known-characters"),a,y),f(getL10n("briefings-unknown-characters"),s,y),g.el]),E=l?h:c,x=addEl(makeEl("thead"),addEls(makeEl("tr"),E.map(function(t){return addEl(makeEl("th"),makeText(getL10n("briefings-"+t)))}))),w=addEls(addClasses(makeEl("table"),["table"]),[x,m]);return addEls(m,r.filter(function(t){return l?!0:void 0!==e.directRelations[t]}).map(v)),addEls(makeEl("div"),[b,w])},g=function(t){return addEls(makeEl("div"),t.map(function(t){var e=makeEl("div");addEl(e,addEl(makeEl("h4"),makeText(t.groupName)));var i=addEl(makeEl("textarea"),makeText(t.text));return setAttr(i,"disabled","disabled"),addClass(i,"briefingTextSpan"),addEl(e,i)}))},v=function(t,e,i){var n;return n=makeEl("tbody"),t.forEach(function(t){var r=makeEl("input");r.value=t.inventory,r.storyName=t.storyName,r.characterName=e,addClass(r,"inventoryInput"),i[t.storyName]||addClass(r,"notEditable"),r.addEventListener("change",M),addEl(n,y(makeText(t.storyName),r))}),addEl(addClasses(makeEl("table"),["table","table-striped"]),n)},y=function(t,e){return addEls(makeEl("tr"),[addEl(makeEl("td"),t),addEl(makeEl("td"),e)])},b=function(t){var i,n,r;return i=makeEl("tbody"),e.forEach(function(e){if(e.doExport){switch(n=makeText(e.name),e.type){case"text":r=addClass(makeEl("span"),"briefingTextSpan"),addEl(r,makeText(t[e.name]));break;case"enum":case"number":case"string":r=makeText(t[e.name]);break;case"checkbox":r=makeText(constL10n(Constants[t[e.name]]))}addEl(i,y(n,r))}}),addEl(addClasses(makeEl("table"),["table","table-striped"]),i)},E=function(t,e,i){DBMS.getCharacterEventsByTime(e,function(n,r){if(n)return void Utils.handleError(n);var o=r.map(function(t){return{characterName:e,storyName:t.storyName}});PermissionInformer.areAdaptationsEditable(o,function(n,o){if(n)return void Utils.handleError(n);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!0},h=5;addEls(t,R.splitEvery(h,r).map(function(t,i){var n,r=addEls(makeEl("div"),t.map(function(t,n){return s.index=i*h+1+n,S(t,e,s)}));return n=getEl("disableHeadersCheckbox").checked?makeText(strFormat(getL10n("briefings-events-header"),[i*h+1,i*h+t.length])):addEls(makeEl("div"),t.map(function(t){return _(t,!0)})),l(n,r)})),a()})})},x=function(t,e){var i;return i=getEl("disableHeadersCheckbox").checked?strFormat(getL10n("briefings-story-header"),[e+1]):t.storyName,makeText(i+" ("+t.events.length+")")},w=function(t,e,i){DBMS.getCharacterEventGroupsByStory(e,function(n,r){if(n)return void Utils.handleError(n);var o=r.map(function(t){return{characterName:e,storyName:t.storyName}});PermissionInformer.areAdaptationsEditable(o,function(n,o){if(n)return void Utils.handleError(n);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!1};addEls(t,r.map(function(t,i){var n=addEls(makeEl("div"),t.events.map(function(t,i){return s.index=i+1,S(t,e,s)}));return l(x(t,i),n)})),a()})})},_=function(t,e){var i=addEl(makeEl("span"),makeText(strFormat("{0} {1}",[e?t.storyName+":":"",t.name]))),n=addClass(addEl(makeEl("span"),makeText(t.time)),"previewEventTime");return addEls(makeEl("div"),[n,i])},T=function(t,e,i){return getEl("disableHeadersCheckbox").checked?addEl(makeEl("h4"),makeText(strFormat(getL10n("briefings-event-header"),[i]))):addEl(makeEl("h4"),_(t,e))},S=function(t,e,i){var n=makeEl("div"),r=getEl("adaptationsModeRadio").checked,o=(t.text,t.characters[e].text),a=!!i.userStoryNamesMap[t.storyName],s=i.areAdaptationsEditable[t.storyName+"-"+e],l=""===o,h=[];h.push(T(t,i.showStoryName,i.index)),h.push(makeText(getL10n("briefings-subjective-time"))),h.push(UI.makeAdaptationTimeInput(t.storyName,t,e,s));var c;if(r||l){c=makeEl("textarea"),addClass(c,"briefingPersonalStory"),setClassByCondition(c,"notEditable",!a),c.value=t.text,c.eventIndex=t.index,c.storyName=t.storyName,listen(c,"change",P),C(c);var d=k(c,a),u=makeEl("div");addEls(u,[addEl(makeEl("h5"),makeText(getL10n("briefings-origin"))),d,c]),h.push(u)}if(r||!l){c=makeEl("textarea"),addClass(c,"briefingPersonalStory"),setClassByCondition(c,"notEditable",!s),c.value=t.characters[e].text,c.characterName=e,c.eventIndex=t.index,c.storyName=t.storyName,listen(c,"change",A),C(c);var f=makeEl("div");addEls(f,[addEl(makeEl("h5"),makeText(getL10n("briefings-adaptation"))),c,makeEl("br")]),h.push(f)}return addEls(n,h),n},C=function(t){listen(t,"keydown",UI.resizeTextarea),listen(t,"paste",UI.resizeTextarea),listen(t,"cut",UI.resizeTextarea),listen(t,"change",UI.resizeTextarea),listen(t,"drop",UI.resizeTextarea)},k=function(t,e){t.setAttribute("disabled","disabled");var i=addEl(makeEl("button"),makeText(getL10n("briefings-unlock-event-source")));return setClassByCondition(i,"notEditable",!e),listen(i,"click",function(){t.removeAttribute("disabled")}),i},M=function(t){var e=t.target;DBMS.updateCharacterInventory(e.storyName,e.characterName,e.value,Utils.processError())},P=function(t){var e=t.target.storyName,i=t.target.eventIndex,n=t.target.value;DBMS.setOriginEventText(e,i,n,Utils.processError())},A=function(t){var e=t.target.storyName,i=t.target.eventIndex,n=t.target.characterName,r=t.target.value;DBMS.setAdaptationEventText(e,i,n,r,Utils.processError())}}(this.BriefingPreview={});var Briefings={};Briefings.init=function(){var t=Briefings;t.views={};var e="briefingsNavigation",i="briefingsContent",n={root:t,navigation:getEl(e),content:getEl(i)};Utils.addView(n,"briefing-preview",BriefingPreview,{mainPage:!0}),Utils.addView(n,"briefing-export",BriefingExport),Briefings.content=getEl("briefingsDiv")},Briefings.refresh=function(){Briefings.currentView.refresh()};var CharacterFilter={};CharacterFilter.init=function(){listen(getEl("profileItemSelector"),"change",UI.showSelectedEls("-dependent")),listen(queryEl("#characterFilterDiv .create-entity-button"),"click",Groups.createGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .rename-entity-button"),"click",Groups.renameGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .remove-entity-button"),"click",Groups.removeGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .show-entity-button"),"click",CharacterFilter.loadFilterFromGroup),listen(queryEl("#characterFilterDiv .save-entity-button"),"click",CharacterFilter.saveFilterToGroup),listen(queryEl("#download-filter-table"),"click",CharacterFilter.downloadFilterTable),CharacterFilter.content=getEl("characterFilterDiv")},CharacterFilter.groupAreaRefresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(t){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(e){Groups.rebuildInterface("#characterFilterDiv",t);var i=getSelect2Data(e);clearEl(queryEl("#characterFilterDiv .save-entity-select")),$("#characterFilterDiv .save-entity-select").select2(i)}))}))},CharacterFilter.refresh=function(){CharacterFilter.sortKey=Constants.CHAR_NAME,CharacterFilter.sortDir="asc",CharacterFilter.inputItems={},CharacterFilter.checkboxes={};var t=clearEl(queryEl("#characterFilterDiv .filter-settings-panel"));addEl(t,addClass(makeEl("div"),"separator")),CharacterFilter.groupAreaRefresh(),FilterConfiguration.makeFilterConfiguration(function(e,i){if(e)return void Utils.handleError(e);CharacterFilter.filterConfiguration=i;var n=i.getAllProfileSettings();addEls(t,n.map(CharacterFilter.makeInput)),UI.fillShowItemSelector(clearEl(getEl("profileItemSelector")),CharacterFilter.getShowProfileItemNames(n)),addEl(clearEl(getEl("filterHead")),CharacterFilter.makeContentHeader(CharacterFilter.getHeaderProfileItemNames(n))),CharacterFilter.rebuildContent()})},CharacterFilter.getShowProfileItemNames=function(t){return R.map(R.prop("displayName"),t.filter(R.prop("canHide")))},CharacterFilter.getHeaderProfileItemNames=function(t){return R.map(R.pick(["name","displayName"]),t)},CharacterFilter.makePrintData=function(){var t=CharacterFilter.filterConfiguration.getDataArrays(CharacterFilter.makeFilterModel()),e=CommonUtils.charOrdAFactoryBase(CharacterFilter.sortDir,function(t){var e=CommonUtils.arr2map(t,"itemName"),i=e[CharacterFilter.sortKey],n=i.value;switch(i.type){case"text":case"string":case"enum":n=n.toLowerCase()}return n});return t.sort(e)},CharacterFilter.rebuildContent=function(){var t=CharacterFilter.makePrintData();addEl(clearEl(getEl("filterResultSize")),makeText(t.length)),addEls(clearEl(getEl("filterContent")),t.map(CharacterFilter.makeDataString)),UI.showSelectedEls("-dependent")({target:getEl("profileItemSelector")})},CharacterFilter.saveFilterToGroup=function(){var t=queryEl("#characterFilterDiv .save-entity-select").value.trim();PermissionInformer.isGroupEditable(t,function(e,i){return e?void Utils.handleError(e):i?void DBMS.saveFilterToGroup(t,CharacterFilter.makeFilterModel(),Utils.processError()):void Utils.alert(strFormat(getL10n("groups-group-editing-forbidden"),[t]))})},CharacterFilter.loadFilterFromGroup=function(){var t=queryEl("#characterFilterDiv .save-entity-select").value.trim();DBMS.getGroup(t,function(t,e){if(t)return void Utils.handleError(t);var i=CommonUtils.isFilterModelCompatibleWithProfiles(CharacterFilter.filterConfiguration.getBaseProfileSettings(),e.filterModel);return 0!=i.length?void Utils.alert(strFormat(getL10n("groups-base-filter-is-incompatible-with-page-profiles"),[i.join(",")])):(CharacterFilter.applyFilterModel(e.filterModel),void CharacterFilter.rebuildContent())})},CharacterFilter.downloadFilterTable=function(){function t(t){if(!("string"==typeof t||t instanceof String))return t;var e=t.replace(/"/g,'""');return e.search(/("|,|\n)/g)>=0&&(e='"'+e+'"'),e}for(var e=getEl("profileItemSelector"),i=[!0],n=0;n<e.options.length;n+=1)i[n+1]=e.options[n].selected;var r=CharacterFilter.makePrintData(),o="\ufeff"+r.map(function(e){return e.filter(function(t,e){return i[e]}).map(R.pipe(R.prop("value"),t)).join(";")}).join("\n"),a=new Blob([o],{type:"text/csv;charset=utf-8;"});saveAs(a,"table.csv")},CharacterFilter.applyFilterModel=function(t){var t=CommonUtils.arr2map(t,"name");Object.keys(CharacterFilter.inputItems).forEach(function(e){if(!e.endsWith(":numberInput")){var i,n=CharacterFilter.inputItems[e];if(CharacterFilter.checkboxes[e].checked!=(null!=t[e])&&CharacterFilter.checkboxes[e].click(),t[e]){var r=t[e];switch(n.selfInfo.type){case"enum":for(i=0;i<n.options.length;i+=1)n.options[i].selected=!!r.selectedOptions[n.options[i].value];break;case"checkbox":n.options[0].selected=r.selectedOptions["true"],n.options[1].selected=r.selectedOptions["false"];break;case"number":n.value=r.condition,CharacterFilter.inputItems[n.selfInfo.name+":numberInput"].value=r.num;break;case"text":case"string":n.value=r.regexString}}else switch(n.selfInfo.type){case"enum":case"checkbox":for(i=0;i<n.options.length;i+=1)n.options[i].selected=!0;break;case"number":CharacterFilter.inputItems[n.selfInfo.name+":numberInput"].value=0,n.value="ignore";break;case"text":case"string":n.value=""}}})},CharacterFilter.makeFilterModel=function(){var t=[];return Object.keys(CharacterFilter.inputItems).forEach(function(e){if(!e.endsWith(":numberInput")&&CharacterFilter.checkboxes[e].checked!==!1){var i,n,r,o,a=CharacterFilter.inputItems[e];
switch(a.selfInfo.type){case"enum":for(i={},o=0,r=0;r<a.options.length;r+=1)a.options[r].selected&&(i[a.options[r].value]=!0,o++);if(a.options.length==o)return;t.push({type:"enum",name:e,selectedOptions:i});break;case"checkbox":if(i={},a.options[0].selected&&a.options[1].selected)return;a.options[0].selected&&(i["true"]=!0),a.options[1].selected&&(i["false"]=!0),t.push({type:"checkbox",name:e,selectedOptions:i});break;case"number":if("ignore"===a.value)return;n=Number(CharacterFilter.inputItems[a.selfInfo.name+":numberInput"].value),t.push({type:"number",name:e,num:n,condition:a.value});break;case"text":case"string":if(""==a.value)return;t.push({type:a.selfInfo.type,name:e,regexString:a.value.toLowerCase()})}}}),t},CharacterFilter.makeDataString=function(t){var e,i,n,r=CharacterFilter.inputItems;return addEls(makeEl("tr"),t.map(function(t,o){return n=t.value,"checkbox"===t.type?n=constL10n(Constants[n]):"text"===t.type&&(i=n.toLowerCase().indexOf(r[t.itemName].value.toLowerCase()),n=n.substring(i-5,i+15)),e=addEl(makeEl("td"),makeText(n)),addClass(e,o-1+"-dependent"),e}))},CharacterFilter.makeContentHeader=function(t){return addEls(makeEl("tr"),t.map(function(t,e){var i=addEls(makeEl("th"),[makeText(t.displayName),makeEl("span")]);return i.info=t.name,addClass(i,e-1+"-dependent"),listen(i,"click",CharacterFilter.onSortChange),i}))},CharacterFilter.onSortChange=function(t){var e=t.target;if("span"===e.tagName.toLowerCase()&&(e=e.parentElement),CharacterFilter.sortKey===e.info)CharacterFilter.sortDir="asc"===CharacterFilter.sortDir?"desc":"asc",setClassByCondition(e,"sortDesc","desc"===CharacterFilter.sortDir),setClassByCondition(e,"sortAsc","asc"===CharacterFilter.sortDir);else{var i=getEl("filterHead");nl2array(i.getElementsByClassName("sortAsc")).forEach(removeClass(R.__,"sortAsc")),nl2array(i.getElementsByClassName("sortDesc")).forEach(removeClass(R.__,"sortDesc")),CharacterFilter.sortKey=e.info,CharacterFilter.sortDir="asc",addClass(e,"sortAsc")}CharacterFilter.rebuildContent()},CharacterFilter.makeInput=function(t){var e=makeEl("div"),i=makeEl("label"),n=makeEl("input");n.type="checkbox",n.checked=!1,addEl(i,n),addEl(i,makeText(t.displayName));var r=function(t,e){return function(i){setClassByCondition(e,"hidden",!i.target.checked),setClassByCondition(t,"flex-front-element",i.target.checked),CharacterFilter.rebuildContent()}};addEl(e,i);var o=makeEl("div");return addClass(o,"hidden"),addEl(e,o),listen(n,"click",r(e,o)),CharacterFilter.checkboxes[t.name]=n,addEl(o,CharacterFilter.makeFilter(t)),e},CharacterFilter.makeFilter=function(t){switch(t.type){case"text":case"string":return CharacterFilter.makeTextFilter(t);case"enum":return CharacterFilter.makeEnumFilter(t);case"number":return CharacterFilter.makeNumberFilter(t);case"checkbox":return CharacterFilter.makeCheckboxFilter(t)}},CharacterFilter.makeTextFilter=function(t){var e=makeEl("input");return e.selfInfo=t,e.value="",e.addEventListener("input",CharacterFilter.rebuildContent),CharacterFilter.inputItems[t.name]=e,e},CharacterFilter.makeCommonEnumFilter=function(t,e){var i=makeEl("select");return i.selfInfo=t,i.multiple="multiple",i.size=e.length,e.forEach(function(t){var e=makeEl("option");e.selected=!0,e.value=t.name,e.appendChild(makeText(t.displayName)),i.appendChild(e)}),i.addEventListener("change",CharacterFilter.rebuildContent),CharacterFilter.inputItems[t.name]=i,i},CharacterFilter.makeEnumFilter=function(t){var e=t.value.split(",").map(function(t){return{name:t,displayName:t}});return CharacterFilter.makeCommonEnumFilter(t,e)},CharacterFilter.makeCheckboxFilter=function(t){var e=[{name:Constants[!0],displayName:constL10n(Constants[!0])},{name:Constants[!1],displayName:constL10n(Constants[!1])}];return CharacterFilter.makeCommonEnumFilter(t,e)},CharacterFilter.makeNumberFilter=function(t){var e=makeEl("select");e.selfInfo=t,Constants.numberFilter.forEach(function(t){var i=makeEl("option");i.appendChild(makeText(constL10n(t))),i.value=t,e.appendChild(i)}),e.selectedIndex=0,CharacterFilter.inputItems[t.name]=e,e.addEventListener("change",CharacterFilter.rebuildContent);var i=makeEl("input");i.value=0,i.type="number",CharacterFilter.inputItems[t.name+":numberInput"]=i,i.addEventListener("input",CharacterFilter.rebuildContent);var n=makeEl("div");return addEl(n,e),addEl(n,i),n};var CharacterProfile={};CharacterProfile.init=function(){listen(getEl("bioEditorSelector"),"change",CharacterProfile.showProfileInfoDelegate),CharacterProfile.content=getEl("characterProfile")},CharacterProfile.refresh=function(){PermissionInformer.getCharacterNamesArray(!1,function(t,e){if(t)return void Utils.handleError(t);var i=clearEl(getEl("bioEditorSelector"));e.forEach(function(t){var e=makeEl("option");e.appendChild(makeText(t.displayName)),e.value=t.value,i.appendChild(e)});var n=clearEl(getEl("profileContentDiv")),r=makeEl("table"),o=makeEl("tbody");r.appendChild(o),addClass(r,"table"),n.appendChild(r),CharacterProfile.inputItems={},DBMS.getAllProfileSettings(function(t,n){return t?void Utils.handleError(t):(n.forEach(function(t){CharacterProfile.appendInput(o,t)}),void CharacterProfile.applySettings(e,i))})})},CharacterProfile.applySettings=function(t,e){if(t.length>0){var i=t[0].value,n=DBMS.getSettings();n.CharacterProfile||(n.CharacterProfile={characterName:i});var r=n.CharacterProfile.characterName;-1===t.map(function(t){return t.value}).indexOf(r)&&(n.CharacterProfile.characterName=i,r=i),DBMS.getProfile(r,CharacterProfile.showProfileInfoCallback),e.value=r}},CharacterProfile.appendInput=function(t,e){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(e.name)),i.appendChild(n),n=makeEl("td");var r,o;switch(e.type){case"text":r=makeEl("textarea"),addClass(r,"profileTextInput");break;case"string":r=makeEl("input"),addClass(r,"profileStringInput");break;case"enum":r=makeEl("select"),o=e.value.split(","),o.forEach(function(t){var e=makeEl("option");e.appendChild(makeText(t)),r.appendChild(e)});break;case"number":r=makeEl("input"),r.type="number";break;case"checkbox":r=makeEl("input"),r.type="checkbox"}r.addEventListener("change",CharacterProfile.updateFieldValue(e.type)),r.selfName=e.name,addClass(r,"isCharacterEditable"),n.appendChild(r),CharacterProfile.inputItems[e.name]=r,i.appendChild(n),t.appendChild(i)},CharacterProfile.updateFieldValue=function(t){return function(e){var i,n=e.target.selfName,r=CharacterProfile.name;switch(t){case"text":case"string":case"enum":i=e.target.value;break;case"number":if(isNaN(e.target.value))return Utils.alert(getL10n("characters-not-a-number")),void(e.target.value=e.target.oldValue);i=Number(e.target.value);break;case"checkbox":i=e.target.checked}DBMS.updateProfileField(r,n,t,i,Utils.processError())}},CharacterProfile.showProfileInfoDelegate=function(t){var e=t.target.value.trim();DBMS.getProfile(e,CharacterProfile.showProfileInfoCallback)},CharacterProfile.showProfileInfoCallback=function(t,e){if(t)return void Utils.handleError(t);var i=e.name;PermissionInformer.isCharacterEditable(i,function(t,n){if(t)return void Utils.handleError(t);CharacterProfile.updateSettings(i),CharacterProfile.name=i;var r=CharacterProfile.inputItems;Object.keys(r).forEach(function(t){"checkbox"===r[t].type?r[t].checked=e[t]:r[t].value=e[t],r[t].oldValue=e[t],Utils.enable(CharacterProfile.content,"isCharacterEditable",n)})})},CharacterProfile.updateSettings=function(t){var e=DBMS.getSettings();e.CharacterProfile.characterName=t};var CharacterProfileConfigurer={};CharacterProfileConfigurer.init=function(){var t=clearEl(getEl("profileItemTypeSelector")),e=function(){CharacterProfileConfigurer.fillSelector(clearEl(t))};e(),L10n.onL10nChange(e),listen(getEl("createProfileItemButton"),"click",CharacterProfileConfigurer.createProfileItem),listen(getEl("moveProfileItemButton"),"click",CharacterProfileConfigurer.moveProfileItem),listen(getEl("removeProfileItemButton"),"click",CharacterProfileConfigurer.removeProfileItem),CharacterProfileConfigurer.content=getEl("characterProfileConfigurer")},CharacterProfileConfigurer.refresh=function(){var t=[];t.push(getEl("profileItemPositionSelector")),t.push(getEl("moveProfileItemPositionSelector")),DBMS.getAllProfileSettings(function(e,i){if(e)return void Utils.handleError(e);var n;t.forEach(function(t){clearEl(t);var e=function(e){addEl(t,addEl(makeEl("option"),makeText(e)))};i.forEach(function(t){e(strFormat(getL10n("common-set-item-before"),[t.name]))}),e(getL10n("common-set-item-as-last")),t.selectedIndex=i.length});var r=clearEl(getEl("profileConfigBlock"));i.forEach(function(t,e){addEl(r,CharacterProfileConfigurer.getInput(t,e+1))}),PermissionInformer.isAdmin(function(t,e){return t?void Utils.handleError(t):void Utils.enable(CharacterProfileConfigurer.content,"adminOnly",e)});var o=[];o.push(getEl("moveProfileItemSelector")),o.push(getEl("removeProfileItemSelector")),o.forEach(function(t){clearEl(t),i.forEach(function(e,i){n=makeEl("option"),n.appendChild(makeText(e.name)),n.profileItemIndex=i,t.appendChild(n)})})})},CharacterProfileConfigurer.createProfileItem=function(){var t=getEl("profileItemNameInput").value.trim();CharacterProfileConfigurer.validateProfileItemName(t,function(){var e=getEl("profileItemTypeSelector").value.trim();if(!Constants.profileFieldTypes[e])return void Utils.alert(strFormat(getL10n("characters-unknown-profile-item-type"),[e]));var i=Constants.profileFieldTypes[e].value,n=getEl("profileItemPositionSelector"),r=n.value;DBMS.createProfileItem(t,e,i,r===getL10n("common-set-item-as-last"),n.selectedIndex,Utils.processError(CharacterProfileConfigurer.refresh))})},CharacterProfileConfigurer.moveProfileItem=function(){var t=getEl("moveProfileItemSelector").selectedOptions[0].profileItemIndex,e=getEl("moveProfileItemPositionSelector").selectedIndex;return t===e?void Utils.alert(getL10n("characters-profile-item-positions-are-equal")):void DBMS.moveProfileItem(t,e,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.removeProfileItem=function(){var t=getEl("removeProfileItemSelector").selectedIndex,e=getEl("removeProfileItemSelector").value;Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-removing-profile-item"),[e]))&&DBMS.removeProfileItem(t,e,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.fillSelector=function(t){var e=function(t,e){return setProp(addEl(makeEl("option"),makeText(e)),"value",t)};R.values(Constants.profileFieldTypes).forEach(function(i){addEl(t,e(i.name,constL10n(i.name)))})},CharacterProfileConfigurer.getInput=function(t,e){var i=makeEl("tr"),n=R.compose(addEl(i),function(t){return addEl(makeEl("td"),t)});n(addEl(makeEl("span"),makeText(e)));var r=setProps(makeEl("input"),{value:t.name,info:t.name});listen(r,"change",CharacterProfileConfigurer.renameProfileItem),addClass(r,"itemNameInput"),addClass(r,"adminOnly"),n(r);var o=makeEl("select");CharacterProfileConfigurer.fillSelector(o),setProps(o,{value:t.type,info:t.name,oldType:t.type}),listen(o,"change",CharacterProfileConfigurer.changeProfileItemType),addClass(o,"adminOnly"),n(o);var a="text"==t.type||"enum"==t.type;switch(r=a?makeEl("textarea"):makeEl("input"),setProps(r,{info:t.name,infoType:t.type,oldValue:t.value}),addClass(r,"adminOnly"),addClass(r,"profile-configurer-"+t.type),t.type){case"text":case"string":case"enum":r.value=t.value;break;case"number":r.type="number",r.value=t.value;break;case"checkbox":r.type="checkbox",r.checked=t.value}listen(r,"change",CharacterProfileConfigurer.updateDefaultValue),n(r);var r=setProps(makeEl("input"),{checked:t.doExport,info:t.name,type:"checkbox"});return listen(r,"change",CharacterProfileConfigurer.doExportChange),addClass(r,"adminOnly"),n(r),i},CharacterProfileConfigurer.updateDefaultValue=function(t){var e,i=t.target.info,n=t.target.infoType,r=t.target.oldValue;switch(n){case"text":case"string":case"number":case"enum":e=t.target.value;break;case"checkbox":e=t.target.checked}var o,a,s,l,h;switch(n){case"text":case"string":case"checkbox":DBMS.updateDefaultValue(i,e,Utils.processError());break;case"number":if(isNaN(e))return Utils.alert(getL10n("characters-not-a-number")),void(t.target.value=r);DBMS.updateDefaultValue(i,Number(e),Utils.processError());break;case"enum":if(""===e)return Utils.alert(getL10n("characters-enum-item-cant-be-empty")),void(t.target.value=r);if(o=r.split(","),a=e.split(","),a=a.map(function(t){return t.trim()}),s=[{}].concat(a).reduce(function(t,e){return t[e]=!0,t}),l=o.filter(function(t){return!s[t]}),0!==l.length)return Utils.confirm(strFormat(getL10n("characters-new-enum-values-remove-some-old-values"),[l.join(",")]))?(h=a.join(","),t.target.value=h,void DBMS.updateDefaultValue(i,h,Utils.processError())):void(t.target.value=r);h=a.join(","),t.target.value=h,DBMS.updateDefaultValue(i,h,Utils.processError())}},CharacterProfileConfigurer.doExportChange=function(t){DBMS.doExportProfileItemChange(t.target.info,t.target.checked,Utils.processError())},CharacterProfileConfigurer.renameProfileItem=function(t){var e=t.target.value.trim(),i=t.target.info;CharacterProfileConfigurer.validateProfileItemName(e,function(){DBMS.renameProfileItem(e,i,Utils.processError(CharacterProfileConfigurer.refresh))},function(){t.target.value=t.target.info})},CharacterProfileConfigurer.validateProfileItemName=function(t,e,i){if(""===t)return Utils.alert(getL10n("characters-profile-item-name-is-not-specified")),void(i&&i());if("name"===t)return Utils.alert(getL10n("characters-profile-item-name-cant-be-name")),void(i&&i());var n=function(){Utils.alert(getL10n("characters-such-name-already-used")),i&&i()};DBMS.isProfileItemNameUsed(t,function(t,i){return t?void Utils.handleError(t):void(i?n():e())})},CharacterProfileConfigurer.changeProfileItemType=function(t){if(Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-changing-profile-item-type"),[t.target.info]))){var e=t.target.value,i=t.target.info;DBMS.changeProfileItemType(i,e,Utils.processError(CharacterProfileConfigurer.refresh))}else t.target.value=t.target.oldType};var Characters={};Characters.init=function(){var t=Characters;t.views={};var e="charactersNavigation",i="charactersContent",n={root:t,navigation:getEl(e),content:getEl(i)};Utils.addView(n,"character-profile",CharacterProfile,{mainPage:!0}),Utils.addView(n,"character-profile-constructor",CharacterProfileConfigurer),listen(queryEl("#charactersDiv .create-entity-button"),"click",Characters.createCharacter),listen(queryEl("#charactersDiv .rename-entity-button"),"click",Characters.renameCharacter),listen(queryEl("#charactersDiv .remove-entity-button"),"click",Characters.removeCharacter),Characters.content=getEl("charactersDiv")},Characters.refresh=function(){PermissionInformer.getCharacterNamesArray(!0,Utils.processError(Characters.rebuildInterface))},Characters.rebuildInterface=function(t){var e=getSelect2Data(t);clearEl(queryEl("#charactersDiv .rename-entity-select")),$("#charactersDiv .rename-entity-select").select2(e),clearEl(queryEl("#charactersDiv .remove-entity-select")),$("#charactersDiv .remove-entity-select").select2(e),Characters.currentView.refresh()},Characters.createCharacter=function(){var t=queryEl("#charactersDiv .create-entity-input").value.trim();return""===t?void Utils.alert(getL10n("characters-character-name-is-not-specified")):void DBMS.isCharacterNameUsed(t,function(e,i){return e?void Utils.handleError(e):void(i?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[t])):DBMS.createCharacter(t,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(t),void Characters.refresh())})}))})},Characters.renameCharacter=function(){var t=queryEl("#charactersDiv .rename-entity-select").value.trim(),e=queryEl("#charactersDiv .rename-entity-input").value.trim();return""===e?void Utils.alert(getL10n("characters-new-character-name-is-not-specified")):t===e?void Utils.alert(getL10n("characters-names-are-the-same")):void DBMS.isCharacterNameUsed(e,function(i,n){return i?void Utils.handleError(i):void(n?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[e])):DBMS.renameCharacter(t,e,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(e),void Characters.refresh())})}))})},Characters.removeCharacter=function(){var t=queryEl("#charactersDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-character-removing"),[t]))&&DBMS.removeCharacter(t,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void Characters.refresh()})})};var Chat={};Chat.init=function(){var t=getEl("sendMessageButton");t.addEventListener("click",Chat.onSubmit),Chat.subscribe(),Chat.content=getEl("chatDiv")},Chat.refresh=function(){},Chat.onSubmit=function(){var t=getEl("chatMessage"),e=$.ajax({url:"/publish",dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify({message:t.value})});return e.done(function(t){}),e.fail(function(t,e,i){alert(t.responseText)}),t.value="",!1},Chat.subscribe=function(){var t=$.ajax({url:"/subscribe",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});t.done(function(t){var e=makeEl("li");e.appendChild(makeText(t)),messages.appendChild(e),Chat.subscribe()}),t.fail(function(t,e,i){setTimeout(Chat.subscribe,500)})};var EventPresence={name:"EventPresence"};EventPresence.init=function(){listen(getEl("eventPresenceSelector"),"change",UI.showSelectedEls("-dependent")),EventPresence.content=getEl("eventPresenceDiv")},EventPresence.refresh=function(){var t=getEl("eventPresenceTableHead"),e=getEl("eventPresenceTable"),i=getEl("eventPresenceSelector");return void 0==Stories.CurrentStoryName?(clearEl(t),clearEl(e),void clearEl(i)):void PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(n,r){return n?void Utils.handleError(n):void PermissionInformer.getCharacterNamesArray(!1,function(n,o){return n?void Utils.handleError(n):void DBMS.getStoryCharacterNamesArray(Stories.CurrentStoryName,function(n,a){if(n)return void Utils.handleError(n);var s={};o.forEach(function(t){s[t.value]=t});var l=a.map(function(t){return s[t]});l.sort(Utils.charOrdAObject);var h=l.map(function(t){return t.displayName}),a=l.map(function(t){return t.value});DBMS.getStoryEvents(Stories.CurrentStoryName,function(n,o){return n?void Utils.handleError(n):(clearEl(t),clearEl(e),UI.fillShowItemSelector(clearEl(i),h,a),EventPresence.appendTableHeader(t,h),void o.forEach(function(t,i){EventPresence.appendTableInput(e,t,i,a),Utils.enable(EventPresence.content,"isStoryEditable",r)}))})})})})},EventPresence.appendTableHeader=function(t,e){var i=makeEl("tr");rAddEl(rAddEl(makeText(getL10n("stories-event")),makeEl("th")),i),e.forEach(function(t,e){rAddEl(rAddEl(makeText(t),rAddClass(e+"-dependent",makeEl("th"))),i)}),t.appendChild(i)},EventPresence.appendTableInput=function(t,e,i,n){var r=makeEl("tr"),o=makeEl("td");o.appendChild(makeText(e.name)),r.appendChild(o),n.forEach(function(t,n){o=addClass(makeEl("td"),"vertical-aligned-td"),addClass(o,n+"-dependent");var a=makeEl("input");addClass(a,"isStoryEditable"),a.type="checkbox",e.characters[t]&&(a.checked=!0),a.eventIndex=i,a.eventName=e.name,a.characterName=t,a.hasText=null!=e.characters[t]&&""!=e.characters[t].text,a.addEventListener("change",EventPresence.onChangeCharacterCheckbox);var s=i+t;setAttr(a,"id",s),addClass(a,"hidden"),addEl(o,a);var l=addClass(makeEl("label"),"checkbox-label");setAttr(l,"for",s),addEl(o,l),r.appendChild(o)}),t.appendChild(r)},EventPresence.onChangeCharacterCheckbox=function(t){t.target.checked?DBMS.addCharacterToEvent(Stories.CurrentStoryName,t.target.eventIndex,t.target.characterName,Utils.processError()):t.target.hasText?Utils.confirm(strFormat(getL10n("stories-remove-character-from-event-warning"),[t.target.characterName,t.target.eventName]))?DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,t.target.eventIndex,t.target.characterName,Utils.processError()):t.target.checked=!0:DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,t.target.eventIndex,t.target.characterName,Utils.processError())};var Events={};Events.init=function(){listen(getEl("events-storySelector"),"change",Events.updateAdaptationSelectorDelegate),listen(getEl("events-characterSelector"),"change",Events.showPersonalStoriesDelegate),listen(getEl("events-eventSelector"),"change",Events.showPersonalStoriesDelegate2),listen(getEl("finishedStoryCheckbox"),"change",Events.refresh),listen(getEl("adaptationFilterByCharacter"),"change",Events.updateFilter),listen(getEl("adaptationFilterByEvent"),"change",Events.updateFilter),Events.content=getEl("eventsDiv")},Events.getSelectedStoryName=function(t){var e=t.map(R.prop("storyName")),i=DBMS.getSettings();i.Events||(i.Events={storyName:e[0],characterNames:[],eventIndexes:[],selectedFilter:"adaptationFilterByCharacter"});var n=i.Events.storyName;return-1===e.indexOf(n)&&(i.Events.storyName=e[0],n=e[0]),n},Events.getNames=function(t,e,i){var n=t.map(R.prop(e)),r=DBMS.getSettings().Events[i],o=r.filter(function(t){return-1!==n.indexOf(t)});return Events.updateSettings(i,o),o},Events.getCharacterNames=function(t){return Events.getNames(t,"characterName","characterNames")},Events.getEventIndexes=function(t){return Events.getNames(t,"index","eventIndexes")},Events.refresh=function(){var t=clearEl(getEl("events-storySelector"));clearEl(getEl("events-characterSelector")),clearEl(getEl("events-eventSelector")),clearEl(getEl("personalStories")),PermissionInformer.getStoryNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void DBMS.getFilteredStoryNames(getEl("finishedStoryCheckbox").checked,function(e,n){if(e)return void Utils.handleError(e);if(!(n.length<=0)){var r=Events.getSelectedStoryName(n),o=CommonUtils.arr2map(i,"value");n.forEach(function(t){t.displayName=o[t.storyName].displayName,t.value=o[t.storyName].value}),n.sort(Utils.charOrdAObject);var a;n.forEach(function(e){a=addEl(makeEl("option"),makeText(e.displayName+Events.getSuffix(e))),setProp(a,"selected",e.value===r),setProp(a,"storyInfo",e.value),addEl(t,a)}),Events.updateAdaptationSelector(r)}})})},Events.updateAdaptationSelectorDelegate=function(t){var e=t.target.selectedOptions[0].storyInfo;Events.updateSettings("storyName",e),Events.updateSettings("characterNames",[]),Events.updateAdaptationSelector(e)},Events.updateAdaptationSelector=function(t){var e=clearEl(getEl("events-characterSelector")),i=clearEl(getEl("events-eventSelector"));PermissionInformer.getCharacterNamesArray(!1,function(n,r){return n?void Utils.handleError(n):void DBMS.getFilteredCharacterNames(t,getEl("finishedStoryCheckbox").checked,function(n,o){return n?void Utils.handleError(n):void DBMS.getFilteredEventNames(t,getEl("finishedStoryCheckbox").checked,function(n,a){if(n)return void Utils.handleError(n);var s=Events.getCharacterNames(o),l=Events.getEventIndexes(a),h=CommonUtils.arr2map(r,"value");o.forEach(function(t){t.displayName=h[t.characterName].displayName,t.value=h[t.characterName].value}),o.sort(Utils.charOrdAObject);var c;o.forEach(function(i){c=addEl(makeEl("option"),makeText(i.displayName+Events.getSuffix(i))),setProp(c,"selected",-1!==s.indexOf(i.value)),setProp(c,"storyInfo",t),setProp(c,"characterName",i.value),addEl(e,c)}),setAttr(e,"size",o.length),a.forEach(function(e){c=addEl(makeEl("option"),makeText(e.name+Events.getSuffix(e))),setProp(c,"selected",-1!==l.indexOf(e.index)),setProp(c,"storyInfo",t),setProp(c,"eventIndex222",e.index),addEl(i,c)}),setAttr(i,"size",a.length);var d=DBMS.getSettings().Events.selectedFilter;getEl(d).checked=!0,Events.updateFilter({target:{id:d}})})})})},Events.updateFilter=function(t){Events.updateSettings("selectedFilter",t.target.id);var e="adaptationFilterByCharacter"===t.target.id;if(setClassByCondition(getEl("events-characterSelectorDiv"),"hidden",!e),setClassByCondition(getEl("events-eventSelectorDiv"),"hidden",e),e)Events.showPersonalStoriesDelegate({target:getEl("events-characterSelector")});else{var i,n=getEl("events-characterSelector");if(0===n.options.length)return;var r=[];for(i=0;i<n.options.length;i+=1)r.push(n.options[i].characterName);Events.showPersonalStories(n.options[0].storyInfo,r,function(){Events.showPersonalStoriesDelegate2({target:getEl("events-eventSelector")})})}},Events.showPersonalStoriesDelegate=function(t){if(0!=t.target.selectedOptions.length){var e,i=t.target.selectedOptions[0],n=i.storyInfo,r=[],o=t.target;for(e=0;e<o.selectedOptions.length;e+=1)r.push(o.selectedOptions[e].characterName);Events.updateSettings("characterNames",r),Events.showPersonalStories(n,r)}},Events.showPersonalStoriesDelegate2=function(t){var e,i,n=[],r=getEl("events-eventSelector"),o=getEls("eventRow-dependent");for(e=0;e<o.length;e+=1)addClass(o[e],"hidden");for(e=0;e<r.selectedOptions.length;e+=1)i=r.selectedOptions[e].eventIndex222,removeClass(getEls(i+"-dependent")[0],"hidden"),n.push(i);Events.updateSettings("eventIndexes",n)},Events.showPersonalStories=function(t,e,i){DBMS.getMetaInfo(function(n,r){return n?void Utils.handleError(n):void DBMS.getEvents(t,e,function(n,o){return n?void Utils.handleError(n):void PermissionInformer.isStoryEditable(t,function(n,a){if(n)return void Utils.handleError(n);var s=e.map(function(e){return{characterName:e,storyName:t}});PermissionInformer.areAdaptationsEditable(s,function(n,s){return n?void Utils.handleError(n):(Events.buildAdaptationInterface(t,e,o,s,r),Utils.enable(Events.content,"isStoryEditable",a),Utils.enable(Events.content,"notEditable",!1),void(i&&i()))})})})})},Events.buildAdaptationInterface=function(t,e,i,n,r){var o,a,s,l,h,c,d,u,f=clearEl(getEl("personalStories"));R.ap([addEl(f)],i.map(function(i){return o=makeEl("div"),R.ap([addClass(o)],["eventMainPanelRow",i.index+"-dependent","eventRow-dependent"]),a=addClass(makeEl("div"),"eventMainPanelRow-left"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(a,c),addEl(d,addEl(makeEl("div"),makeText(i.name))),addEl(u,UI.makeEventTimePicker({eventTime:i.time,index:i.index,preGameDate:r.preGameDate,date:r.date,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:Events.onChangeDateTimeCreator(t)})),addEl(a,Events.makeOriginTextInput(t,i)),addEl(o,a),a=addClass(makeEl("div"),"eventMainPanelRow-right"),l=addClass(makeEl("div"),"events-eventsContainer"),R.ap([addEl(l)],e.filter(function(t){return i.characters[t]}).map(function(e){return s=addClass(makeEl("div"),"events-singleEventAdaptation"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(s,c),h=n[t+"-"+e],addEl(d,makeText(e)),addEl(u,UI.makeAdaptationTimeInput(t,i,e,h)),addEl(s,Events.makeAdaptationTextInput(t,i,e,h)),addEl(s,Events.makeAdaptationReadyInput(t,i,e,h)),s})),addEl(o,addEl(a,l)),o}))},Events.onChangeDateTimeCreator=R.curry(function(t,e){return function(i,n){DBMS.updateEventProperty(t,e.eventIndex,"time",n.val(),Utils.processError()),StoryEvents.lastDate=n.val(),removeClass(e,"defaultDate")}}),Events.makeOriginTextInput=function(t,e){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventPersonalStory"),i.value=e.text,i.dataKey=JSON.stringify([t,e.index]),listen(i,"change",Events.onChangeOriginText),i},Events.makeAdaptationTextInput=function(t,e,i,n){var r=makeEl("textarea");return setClassByCondition(r,"notEditable",!n),addClass(r,"eventPersonalStory"),r.value=e.characters[i].text,r.dataKey=JSON.stringify([t,e.index,i]),listen(r,"change",Events.onChangeAdaptationText),r},Events.makeAdaptationReadyInput=function(t,e,i,n){var r=makeEl("div"),o=makeEl("input");return setClassByCondition(o,"notEditable",!n),o.type="checkbox",o.checked=e.characters[i].ready,o.dataKey=JSON.stringify([t,e.index,i]),o.id=e.index+"-"+t+"-"+i,listen(o,"change",Events.onChangeReadyStatus),addEl(r,o),addEl(r,setAttr(addEl(makeEl("label"),makeText(constL10n(Constants.finishedText))),"for",o.id)),r},Events.onChangeReadyStatus=function(t){var e=JSON.parse(t.target.dataKey),i=t.target.checked;DBMS.changeAdaptationReadyStatus(e[0],e[1],e[2],i,Utils.processError())},Events.onChangeOriginText=function(t){var e=JSON.parse(t.target.dataKey),i=t.target.value;DBMS.setOriginEventText(e[0],e[1],i,Utils.processError())},Events.onChangeAdaptationText=function(t){var e=JSON.parse(t.target.dataKey),i=t.target.value;DBMS.setAdaptationEventText(e[0],e[1],e[2],i,Utils.processError())},Events.getSuffix=function(t){return t.isEmpty?constL10n(Constants.emptySuffix):t.isFinished?constL10n(Constants.finishedSuffix):""},Events.updateSettings=function(t,e){var i=DBMS.getSettings();i.Events[t]=e},FilterConfiguration.makeFilterConfiguration=function(t){DBMS.getCharacterFilterInfo(function(e,i){if(e)return void Utils.handleError(e);var n=new FilterConfiguration(i);t(null,n)})},FilterConfiguration.prototype.getAllProfileSettings=function(){return this.innerProfileSettings},FilterConfiguration.prototype.getBaseProfileSettings=function(){return this.info.profileSettings},FilterConfiguration.prototype.getDataArrays=function(t){return CommonUtils.getDataArrays(this.info,t)};var GroupProfile={};GroupProfile.profileSettings=[{name:"filterModel",type:"container"},{name:"characterList",type:"container"},{name:"masterDescription",type:"text"},{name:"doExport",type:"checkbox"},{name:"characterDescription",type:"text"}],GroupProfile.init=function(){listen(queryEl(".group-profile-tab .entity-selector"),"change",GroupProfile.showProfileInfoDelegate);var t=clearEl(queryEl(".group-profile-tab .entity-profile"));GroupProfile.inputItems={},GroupProfile.profileSettings.forEach(function(e){e.displayName=getL10n("groups-"+e.name),addEl(t,GroupProfile.makeInput(e))}),GroupProfile.content=queryEl(".group-profile-tab")},GroupProfile.refresh=function(){PermissionInformer.getGroupNamesArray(!1,function(t,e){if(t)return void Utils.handleError(t);var i=clearEl(queryEl(".group-profile-tab .entity-selector"));fillSelector(i,e.map(remapProps4Select)),GroupProfile.applySettings(e,i)})},GroupProfile.applySettings=function(t,e){if(t.length>0){var i=t[0].value,n=DBMS.getSettings();n.GroupProfile||(n.GroupProfile={groupName:i});var r=n.GroupProfile.groupName;-1===t.map(function(t){return t.value}).indexOf(r)&&(n.GroupProfile.groupName=i,r=i),DBMS.getGroup(r,GroupProfile.showProfileInfoCallback),e.value=r}},GroupProfile.makeInput=function(t){var e,i=setAttr(makeEl("span"),"l10n-id","groups-"+t.name),n=addEl(makeEl("tr"),addEl(makeEl("td"),addEl(i,makeText(t.displayName))));switch(t.type){case"text":e=makeEl("textarea"),addClass(e,"profileTextInput"),e.addEventListener("change",GroupProfile.updateFieldValue(t.type));break;case"checkbox":e=makeEl("input"),e.type="checkbox",e.addEventListener("change",GroupProfile.updateFieldValue(t.type));break;case"container":e=makeEl("div"),e.type="container"}return e.selfName=t.name,addClass(e,"isGroupEditable"),GroupProfile.inputItems[t.name]=e,addEl(n,addEl(makeEl("td"),e))},GroupProfile.updateFieldValue=function(t){return function(e){var i,n=e.target.selfName,r=GroupProfile.name;switch(t){case"text":i=e.target.value;break;case"checkbox":i=e.target.checked}DBMS.updateGroupField(r,n,i,Utils.processError())}},GroupProfile.showProfileInfoDelegate=function(t){var e=t.target.value.trim();DBMS.getGroup(e,GroupProfile.showProfileInfoCallback)},GroupProfile.showProfileInfoCallback=function(t,e){if(t)return void Utils.handleError(t);var i=e.name;FilterConfiguration.makeFilterConfiguration(function(t,n){return t?void Utils.handleError(t):void PermissionInformer.isGroupEditable(i,function(t,r){if(t)return void Utils.handleError(t);
CharacterProfile.updateSettings(i),GroupProfile.name=i;var o=GroupProfile.inputItems;Object.keys(o).forEach(function(t){if("checkbox"===o[t].type)o[t].checked=e[t];else if("container"===o[t].type)if("filterModel"===t){var i=clearEl(o[t]),a=makeEl("table");addClass(a,"table");var s=makeEl("tbody");addEls(s,e.filterModel.map(GroupProfile.makeFilterItemString(n))),addEl(a,s),addEl(i,a)}else{var l=n.getDataArrays(e.filterModel).map(function(t){return t[0].value}).sort(),i=clearEl(o[t]);addEl(i,makeText(l.join(", "))),addEl(i,makeEl("br")),addEl(i,makeText(getL10n("groups-total")+l.length))}else o[t].value=e[t];o[t].oldValue=e[t],Utils.enable(GroupProfile.content,"isGroupEditable",r)})})})},GroupProfile.getHeaderDisplayName=function(t,e){return CommonUtils.arr2map(t.getAllProfileSettings(),"name")[e].displayName},GroupProfile.makeFilterItemString=R.curry(function(t,e){var i=makeEl("tr"),n=makeEl("td");addEl(i,n);var r=GroupProfile.getHeaderDisplayName(t,e.name);addEl(n,makeText(r));var o;switch(e.type){case"enum":o=strFormat("{0}",[Object.keys(e.selectedOptions).join(", ")]);break;case"checkbox":var a=[];e.selectedOptions["true"]&&a.push(getL10n("constant-yes")),e.selectedOptions["false"]&&a.push(getL10n("constant-no")),o=strFormat("{0}",[a.join(", ")]);break;case"number":o=strFormat("{0} {1}",[getL10n("constant-"+e.condition),e.num]);break;case"text":case"string":o=strFormat(getL10n("groups-text-contains"),[e.regexString])}return n=makeEl("td"),addEl(i,n),addEl(n,makeText(o)),i}),GroupProfile.updateSettings=function(t){var e=DBMS.getSettings();e.GroupProfile.groupName=t};var Groups={};Groups.init=function(){var t=Groups;t.views={};var e=".groups-tab .sub-tab-navigation",i=".groups-tab .sub-tab-content",n={root:t,navigation:queryEl(e),content:queryEl(i)};Utils.addView(n,"group-profile",GroupProfile,{mainPage:!0}),Utils.addView(n,"group-schema",GroupSchema),Utils.addView(n,"investigation-board",InvestigationBoard),listen(queryEl(".groups-tab .create-entity-button"),"click",Groups.createGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .rename-entity-button"),"click",Groups.renameGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .remove-entity-button"),"click",Groups.removeGroup(".groups-tab",Groups.refresh)),Groups.content=queryEl(".groups-tab")},Groups.refresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(t){Groups.rebuildInterface(".groups-tab",t),Groups.currentView.refresh()}))},Groups.rebuildInterface=function(t,e){var i=getSelect2Data(e);clearEl(queryEl(t+" .rename-entity-select")),$(t+" .rename-entity-select").select2(i),clearEl(queryEl(t+" .remove-entity-select")),$(t+" .remove-entity-select").select2(i)},Groups.createGroup=function(t,e){return function(){var i=queryEl(t+" .create-entity-input").value.trim();return""===i?void Utils.alert(getL10n("groups-group-name-is-not-specified")):void DBMS.isGroupNameUsed(i,function(t,n){return t?void Utils.handleError(t):n?void Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[i])):void DBMS.createGroup(i,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void e()})})})}},Groups.renameGroup=function(t,e){return function(){var i=queryEl(t+" .rename-entity-select").value.trim(),n=queryEl(t+" .rename-entity-input").value.trim();return""===n?void Utils.alert(getL10n("groups-new-group-name-is-not-specified")):i===n?void Utils.alert(getL10n("groups-names-are-the-same")):void DBMS.isGroupNameUsed(n,function(t,r){return t?void Utils.handleError(t):void(r?Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[n])):DBMS.renameGroup(i,n,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void e()})}))})}},Groups.removeGroup=function(t,e){return function(){var i=queryEl(t+" .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("groups-are-you-sure-about-group-removing"),[i]))&&DBMS.removeGroup(i,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void e()})})}};var GroupSchema={};GroupSchema.init=function(){GroupSchema.content=queryEl(".group-schema-tab")},GroupSchema.refresh=function(){DBMS.getGroupSchemas(function(t,e){GroupSchema.redrawSchema(e.theory)})},GroupSchema.redrawSchema=function(t){var e=queryEl(".group-schema-tab .schema-container");GroupSchema.network&&GroupSchema.network.destroy(),t.edges=t.edges.map(function(t){return R.merge(t,{physics:!1})}),GroupSchema.network=new vis.Network(e,t,Constants.groupSchemaOpts)};var InvestigationBoard={};InvestigationBoard.init=function(){listen(queryEl(".investigation-board-tab .group-add-button"),"click",InvestigationBoard.addGroup),listen(queryEl(".investigation-board-tab .group-switch-button"),"click",InvestigationBoard.switchGroup),listen(queryEl(".investigation-board-tab .group-save-notes-button"),"click",InvestigationBoard.setGroupNotes),listen(queryEl(".investigation-board-tab .create-entity-button"),"click",InvestigationBoard.createResource),listen(queryEl(".investigation-board-tab .rename-entity-button"),"click",InvestigationBoard.renameResource),listen(queryEl(".investigation-board-tab .save-edge-button"),"click",InvestigationBoard.saveEdge),listen(queryEl(".investigation-board-tab .cancel-node-adding-button"),"click",InvestigationBoard.cancel(".board-add-node-popup")),listen(queryEl(".investigation-board-tab .cancel-resource-editing-button"),"click",InvestigationBoard.cancel(".board-edit-resource-popup")),listen(queryEl(".investigation-board-tab .cancel-group-editing-button"),"click",InvestigationBoard.cancel(".board-edit-group-popup")),listen(queryEl(".investigation-board-tab .cancel-add-edge-button"),"click",InvestigationBoard.cancel(".board-add-edge-popup")),InvestigationBoard.nodesDataset=new vis.DataSet,InvestigationBoard.edgesDataset=new vis.DataSet;var t={nodes:InvestigationBoard.nodesDataset,edges:InvestigationBoard.edgesDataset},e=queryEl(".investigation-board-tab .schema-container");InvestigationBoard.network=new vis.Network(e,t,Constants.investigationBoardOpts),InvestigationBoard.network.on("selectEdge",InvestigationBoard.showEdgeLabelEditor),InvestigationBoard.network.on("deselectEdge",InvestigationBoard.hideEdgeLabelEditor),InvestigationBoard.content=queryEl(".investigation-board-tab")},InvestigationBoard.refresh=function(t){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(e){DBMS.getInvestigationBoardData(function(i,n){var r=e.map(R.prop("value")),o=R.keys(n.groups),a=R.difference(r,o);clearEl(queryEl(".investigation-board-tab .group-add-select")),$(".investigation-board-tab .group-add-select").select2(arr2Select2(a)),clearEl(queryEl(".investigation-board-tab .group-switch-select")),$(".investigation-board-tab .group-switch-select").select2(arr2Select2(a)),t||InvestigationBoard.redrawBoard(n)})}))},InvestigationBoard.addNode=function(t,e){InvestigationBoard.showPopup(".board-add-node-popup",!0),InvestigationBoard.modifyArgs={newNode:t,callback:e}},InvestigationBoard.addGroup=function(){var t=queryEl(".investigation-board-tab .group-add-select").value.trim();DBMS.addBoardGroup(t,function(e){return e?void Utils.handleError(e):void InvestigationBoard.setNode(t,"groups")})},InvestigationBoard.createResource=function(){var t=queryEl(".investigation-board-tab .create-entity-input").value.trim();DBMS.createResource(t,function(e){return e?void Utils.handleError(e):void InvestigationBoard.setNode(t,"resources")})},InvestigationBoard.setNode=function(t,e){var i=InvestigationBoard.modifyArgs.newNode;"groups"===e?(i.originalLabel=t,i.originalNotes="",i.label=InvestigationBoard.makeDisplayLabel(i.originalLabel,i.originalNotes)):i.label=t,i.id=InvestigationBoard._makeRelNodeId(t,e),i.group=e,InvestigationBoard.showPopup(".board-add-node-popup",!1),InvestigationBoard.refresh(!0),InvestigationBoard.modifyArgs.callback(i)},InvestigationBoard.editNodeFun=function(t,e){InvestigationBoard.modifyArgs={editNode:t,callback:e},"groups"===t.group?InvestigationBoard.editGroup():InvestigationBoard.editResource()},InvestigationBoard.editGroup=function(){InvestigationBoard.showPopup(".board-edit-group-popup",!0),queryEl(".investigation-board-tab .group-notes-editor").value=InvestigationBoard.modifyArgs.editNode.originalNotes},InvestigationBoard.switchGroup=function(){var t=InvestigationBoard.modifyArgs.editNode,e=t.originalLabel,i=queryEl(".investigation-board-tab .group-switch-select").value.trim(),n=InvestigationBoard.modifyArgs.callback;DBMS.switchGroups(e,i,function(e){return e?void Utils.handleError(e):(t.originalLabel=i,t.label=InvestigationBoard.makeDisplayLabel(t.originalLabel,t.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),n(t),void InvestigationBoard.refresh(!0))})},InvestigationBoard.setGroupNotes=function(){var t=InvestigationBoard.modifyArgs.editNode,e=queryEl(".investigation-board-tab .group-notes-editor").value.trim(),i=InvestigationBoard.modifyArgs.callback;DBMS.setGroupNotes(t.originalLabel,e,function(n){return n?void Utils.handleError(n):(t.originalNotes=e,t.label=InvestigationBoard.makeDisplayLabel(t.originalLabel,t.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),i(t),void InvestigationBoard.refresh(!0))})},InvestigationBoard.editResource=function(){InvestigationBoard.showPopup(".board-edit-resource-popup",!0)},InvestigationBoard.renameResource=function(){var t=InvestigationBoard.modifyArgs.editNode,e=t.label,i=queryEl(".investigation-board-tab .rename-entity-input").value.trim(),n=InvestigationBoard.modifyArgs.callback;DBMS.renameResource(e,i,function(e){return e?void Utils.handleError(e):(t.label=i,InvestigationBoard.showPopup(".board-edit-resource-popup",!1),void n(t))})},InvestigationBoard.deleteNode=function(t,e){var i=InvestigationBoard.nodesDataset.get(t.nodes[0]),n="groups"===i.group?"removeBoardGroup":"removeResource",r="groups"===i.group?getL10n("investigation-board-confirm-group-node-removing"):getL10n("investigation-board-confirm-resource-node-removing"),o="groups"===i.group?i.originalLabel:i.label;Utils.confirm(strFormat(r,[o]))?DBMS[n](o,function(i){return i?(Utils.handleError(i),void e()):(InvestigationBoard.refresh(!0),void e(t))}):e()},InvestigationBoard.makeDisplayLabel=function(t,e){function i(t){return t.split("\n").map(R.splitEvery(20)).map(R.join("\n")).join("\n")}return i(t)+(""===e.trim()?"":"\n\n"+i(e))},InvestigationBoard._makeRelNodeId=function(t,e){return("groups"===e?"group-":"resource-")+t},InvestigationBoard.redrawBoard=function(t){function e(t){return{label:t,id:InvestigationBoard._makeRelNodeId(t,"resources")}}function i(t){return{originalLabel:t.name,originalNotes:t.notes,label:InvestigationBoard.makeDisplayLabel(t.name,t.notes),id:InvestigationBoard._makeRelNodeId(t.name,"groups")}}var n=[];n=n.concat(R.values(t.groups).map(i).map(R.merge({group:"groups"}))),n=n.concat(R.keys(t.resources).map(e).map(R.merge({group:"resources"}))),InvestigationBoard.nodesDataset.clear(),InvestigationBoard.nodesDataset.add(n);var r=[],r=R.flatten(R.keys(t.relations).map(function(e){return R.keys(t.relations[e]).map(function(i){return{from:e,to:i,label:t.relations[e][i]}})}));InvestigationBoard.edgesDataset.clear(),InvestigationBoard.edgesDataset.add(r);var o=CommonUtils.clone(Constants.investigationBoardOpts);o=R.merge(o,{locale:L10n.getLang(),locales:Constants.visLocales,manipulation:{addNode:InvestigationBoard.addNode,deleteNode:InvestigationBoard.deleteNode,editNode:InvestigationBoard.editNodeFun,addEdge:InvestigationBoard.addEdge,editEdge:!1,deleteEdge:InvestigationBoard.deleteEdge}}),InvestigationBoard.network.setOptions(o)},InvestigationBoard.showEdgeLabelEditor=function(t){if(0!==t.edges.length&&0===t.nodes.length){var e=InvestigationBoard.edgesDataset.get(t.edges[0]);InvestigationBoard.modifyArgs={edge:e,callback:function(t){t&&InvestigationBoard.edgesDataset.update(t)},editEdge:!0},queryEl(".investigation-board-tab .add-edge-label-input").value=e.label,InvestigationBoard.showPopup(".board-add-edge-popup",!0)}},InvestigationBoard.hideEdgeLabelEditor=function(t){InvestigationBoard.showPopup(".board-add-edge-popup",!1)},InvestigationBoard.addEdge=function(t,e){var i=InvestigationBoard.nodesDataset.get(t.from);return"resources"===i.group?(Utils.alert(getL10n("investigation-board-resource-node-cant-be-first")),void e()):(InvestigationBoard.modifyArgs={fromNode:InvestigationBoard.nodesDataset.get(t.from),toNode:InvestigationBoard.nodesDataset.get(t.to),callback:e},void InvestigationBoard.showPopup(".board-add-edge-popup",!0))},InvestigationBoard.saveEdge=function(){InvestigationBoard.modifyArgs.editEdge?InvestigationBoard.updateEdge():InvestigationBoard.createEdge()},InvestigationBoard.updateEdge=function(){var t=queryEl(".investigation-board-tab .add-edge-label-input").value.trim(),e=InvestigationBoard.modifyArgs.edge;DBMS.setEdgeLabel(e.from,e.to,t,function(i){return i?void Utils.handleError(i):(e.label=t,InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback(e))})},InvestigationBoard.createEdge=function(){var t=InvestigationBoard.modifyArgs.fromNode,e=InvestigationBoard.modifyArgs.toNode,i=queryEl(".investigation-board-tab .add-edge-label-input").value.trim();DBMS.addEdge(t.id,e.id,i,function(n){return n?void Utils.handleError(n):(InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback({from:t.id,to:e.id,label:i}))})},InvestigationBoard.deleteEdge=function(t,e){var i=InvestigationBoard.edgesDataset.get(t.edges[0]);DBMS.removeEdge(i.from,i.to,function(i){return i?(Utils.handleError(i),void e()):void e(t)})},InvestigationBoard.cancel=function(t){return function(){InvestigationBoard.showPopup(t,!1),InvestigationBoard.modifyArgs.callback()}},InvestigationBoard.showPopup=R.curry(function(t,e){setClassByCondition(queryEl(".investigation-board-tab "+t),"hidden",!e)});var LogViewer={};LogViewer.init=function(){listen(getEl("logPageSelector"),"change",function(t){DBMS.getLog(Number(t.target.value),LogViewer.dataRecieved)}),LogViewer.content=getEl("logViewerDiv")},LogViewer.refresh=function(){getEl("logPageSelector").selectedIndex=0,DBMS.getLog(0,LogViewer.dataRecieved)},LogViewer.dataRecieved=function(t,e){if(t)return void Utils.handleError(t);var i=getEl("logPageSelector"),n=i.selectedIndex;clearEl(i);for(var r=[],o=0;o<e.logSize;o++)r.push({name:o+1,value:String(o),selected:n==o});fillSelector(i,r);var a=clearEl(getEl("logData"));R.ap([addEl(a)],e.requestedLog.map(LogViewer.makeRow))},LogViewer.makeRow=function(t){var e=makeEl("tr"),i=function(t){addEl(e,addEl(makeEl("td"),makeText(t)))};return i(t[0]),i(new Date(t[2]).format("yyyy/mm/dd HH:MM:ss")),i(t[1]),i(t[3]),i(t[4]),e};var LogViewer2={};LogViewer2.init=function(){var t=LogViewer2;t.views={};var e=".log-viewer2-tab .sub-tab-navigation",i=".log-viewer2-tab .sub-tab-content",n={root:t,navigation:queryEl(e),content:queryEl(i)};Utils.addView(n,"logViewer",LogViewer,{mainPage:!0}),Utils.addView(n,"about",About),LogViewer2.content=queryEl(".log-viewer2-tab")},LogViewer2.refresh=function(){LogViewer2.currentView.refresh()};var MasterStory={};MasterStory.init=function(){listen(getEl("masterStoryArea"),"change",MasterStory.updateMasterStory),MasterStory.content=getEl("masterStoryDiv2")},MasterStory.refresh=function(){var t=getEl("masterStoryArea"),e=Stories.CurrentStoryName;e?DBMS.getMasterStory(e,function(e,i){return e?void Utils.handleError(e):void(t.value=i)}):t.value=""},MasterStory.updateMasterStory=function(){var t=getEl("masterStoryArea");DBMS.updateMasterStory(Stories.CurrentStoryName,t.value,Utils.processError())};var statisticKeys=["storyNumber","characterNumber","eventsNumber","userNumber","textCharacterNumber","lastEvent","firstEvent"],Overview={};Overview.Charts={},Overview.init=function(){Overview.name=getEl("gameNameInput"),Overview.name.addEventListener("change",Overview.updateName),Overview.lastSaveTime=getEl("lastSaveTime"),Overview.date=getEl("gameDatePicker");var t={lang:L10n.getLang(),mask:!0,onChangeDateTime:Overview.updateTime};jQuery(Overview.date).datetimepicker(t),Overview.preDate=getEl("preGameDatePicker"),t={lang:L10n.getLang(),mask:!0,onChangeDateTime:Overview.updatePreGameDate},jQuery(Overview.preDate).datetimepicker(t),L10n.onL10nChange(function(){jQuery(Overview.date).datetimepicker({lang:L10n.getLang()}),jQuery(Overview.preDate).datetimepicker({lang:L10n.getLang()})}),Overview.descr=getEl("gameDescription"),Overview.descr.addEventListener("change",Overview.updateDescr),UI.initTabPanel("overviewInfoButton","overviewContainer"),Overview.content=getEl("overviewDiv")},Overview.makeChart=function(t,e,i){Overview.Charts[t]&&Overview.Charts[t].destroy(),i.forEach(function(t,e){Constants.colorPalette[e]&&(t.color=Constants.colorPalette[e].color.background,t.highlight=Constants.colorPalette[e].color.hover.background)});var n=e.getContext("2d");Overview.Charts[t]=new Chart(n).Doughnut(i,{animateRotate:!1,tooltipTemplate:"<%if (label){%><%=label%><%}%>"})},Overview.makeHistogram=function(t,e){var i=null;e.forEach(function(t){t&&(null===i||t.value>i)&&(i=t.value)}),e.forEach(function(t){t&&(t.normValue=(t.value-0)/(i-0)*.9+.1)});var n;e.forEach(function(e){n=null===e?makeEl("div"):addEl(makeEl("div"),makeText(e.value)),addClass(n,"bar"),e&&(n.style.height=100*e.normValue+"%",$(n).tooltip({title:e.tip})),addEl(t,n)})},Overview.refresh=function(){PermissionInformer.isAdmin(function(t,e){return t?void Utils.handleError(t):void Utils.enable(Overview.content,"adminOnly",e)}),DBMS.getMetaInfo(function(t,e){return t?void Utils.handleError(t):void DBMS.getStatistics(function(t,i){if(t)return void Utils.handleError(t);Overview.name.value=e.name,Overview.date.value=e.date,Overview.preDate.value=e.preGameDate,Overview.descr.value=e.description,addEl(clearEl(Overview.lastSaveTime),makeText(new Date(e.saveTime).format("yyyy/mm/dd HH:MM:ss"))),i.lastEvent=""!==i.lastEvent?new Date(i.lastEvent).format("yyyy/mm/dd h:MM"):"",i.firstEvent=""!==i.firstEvent?new Date(i.firstEvent).format("yyyy/mm/dd h:MM"):"",statisticKeys.forEach(function(t){Overview.updateStatisticValue(i,t)}),addEl(clearEl(getEl("generalCompleteness")),makeText(strFormat(getL10n("overview-general-completeness-value"),i.generalCompleteness))),addEl(clearEl(getEl("storyCompleteness")),makeText(strFormat(getL10n("overview-story-completeness-value"),i.storyCompleteness))),Overview.makeHistogram(clearEl(getEl("storyEventsHist")),i.storyEventsHist),Overview.makeHistogram(clearEl(getEl("storyCharactersHist")),i.storyCharactersHist),Overview.makeHistogram(clearEl(getEl("eventCompletenessHist")),i.eventCompletenessHist),Overview.makeHistogram(clearEl(getEl("characterSymbolsHist")),i.characterSymbolsHist),Overview.makeHistogram(clearEl(getEl("characterStoriesHist")),i.characterStoriesHist),Overview.makeChart("characterChart",getEl("characterChart"),i.characterChartData),Overview.makeChart("storyChart",getEl("storyChart"),i.storyChartData),Overview.makeChart("groupChart",getEl("groupChart"),i.groupChartData);var n,r,o=clearEl(getEl("profileDiagrams")),a=addEl(o),s=function(t){return n=makeEl("div"),addEl(n,addEl(makeEl("h4"),makeText(t.name))),addEl(n,t.bar),n},l=function(t){return r=setAttr(setAttr(makeEl("canvas"),"width","300"),"height","100"),Overview.makeChart(t.name,r,t.prepared),R.zipObj(["name","bar"],[t.name,r])},h=function(t){return r=makeEl("div"),addClass(r,"overviewHist"),Overview.makeHistogram(r,t.prepared),R.zipObj(["name","bar"],[t.name,r])},c=R.compose(a,s,l,Overview.prepareChart),d=R.compose(a,s,h,Overview.prepareHist),u=function(t){return t.data=R.fromPairs(R.toPairs(t.data).map(function(t){return t[0]=constL10n(Constants[t[0]]),t})),t},f=R.compose(c,u),p=R.cond([[R.compose(R.equals("enum"),R.prop("type")),c],[R.compose(R.equals("checkbox"),R.prop("type")),f],[R.T,d]]);i.profileCharts.forEach(p)})})},Overview.prepareChart=function(t){var e=R.sum(R.values(t.data));t.prepared=[];for(var i in t.data)t.prepared.push(R.zipObj(["value","label"],[t.data[i],Overview.makeChartLabel(e,i,t.data[i])]));return t},Overview.prepareHist=function(t){t.prepared=[];var e=t.data.step;t.data=t.data.groups;for(var i=R.apply(Math.min,R.keys(t.data)),n=R.apply(Math.max,R.keys(t.data)),r=i;n+1>r;r++)t.data[r]?t.prepared.push({value:t.data[r],label:r*e+"-"+(r*e+(e-1)),tip:r*e+"-"+(r*e+(e-1))}):t.prepared.push(null);return t},Overview.makeChartLabel=R.curry(function(t,e,i){return[e,": ",(i/t*100).toFixed(0),"% (",i,"/",t,")"].join("")}),Overview.updateStatisticValue=function(t,e){addEl(clearEl(getEl(e)),makeText(t[e]))},Overview.updateName=function(t){DBMS.setMetaInfo("name",t.target.value,Utils.processError())},Overview.updateTime=function(t,e){DBMS.setMetaInfo("date",e.val(),Utils.processError())},Overview.updatePreGameDate=function(t,e){DBMS.setMetaInfo("preGameDate",e.val(),Utils.processError())},Overview.updateDescr=function(t){DBMS.setMetaInfo("description",t.target.value,Utils.processError())};var Stories={};Stories.init=function(){Stories.left={views:{}},Stories.right={views:{}};var t={root:Stories.left,navigation:queryEl(".stories-navigation-container .left-side"),content:queryEl(".stories-content-container .left-side")};Utils.addView(t,"master-story",MasterStory,{mainPage:!0,toggle:!0}),Utils.addView(t,"story-events",StoryEvents,{toggle:!0}),Utils.addView(t,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(t,"event-presence",EventPresence,{toggle:!0}),t={root:Stories.right,navigation:queryEl(".stories-navigation-container .right-side"),content:queryEl(".stories-content-container .right-side")},Utils.addView(t,"master-story",MasterStory,{toggle:!0}),Utils.addView(t,"story-events",StoryEvents,{mainPage:!0,toggle:!0}),Utils.addView(t,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(t,"event-presence",EventPresence,{toggle:!0}),listen(queryEl("#storiesDiv .create-entity-button"),"click",Stories.createStory),listen(queryEl("#storiesDiv .rename-entity-button"),"click",Stories.renameStory),listen(queryEl("#storiesDiv .remove-entity-button"),"click",Stories.removeStory),$("#storySelector").select2().on("change",Stories.onStorySelectorChangeDelegate),Stories.content=getEl("storiesDiv")},Stories.chainRefresh=function(){(Stories.left.currentView&&"EventPresence"===Stories.left.currentView.name||Stories.right.currentView&&"EventPresence"===Stories.right.currentView.name)&&EventPresence.refresh()},Stories.refresh=function(){var t=["#storiesDiv .rename-entity-select","#storiesDiv .remove-entity-select"];clearEl(getEl("storySelector"));t.forEach(R.compose(clearEl,queryEl)),PermissionInformer.getStoryNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!0,function(e,n){if(e)return void Utils.handleError(e);if(n.length>0){var r=getSelect2Data(n);t.forEach(function(t){$(t).select2(r)})}if(i.length>0){var o=Stories.getSelectedStoryName(i),r=getSelect2Data(i);$("#storySelector").select2(r).val(o).trigger("change"),Stories.onStorySelectorChange(o)}else Stories.onStorySelectorChange();Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh()})})},Stories.getSelectedStoryName=function(t){var e=DBMS.getSettings();e.Stories||(e.Stories={storyName:t[0].value});var i=e.Stories.storyName;return-1===t.map(function(t){return t.value}).indexOf(i)&&(e.Stories.storyName=t[0].value,i=t[0].value),i},Stories.createStory=function(){var t=queryEl("#storiesDiv .create-entity-input").value.trim();return""===t?void Utils.alert(getL10n("stories-story-name-is-not-specified")):void DBMS.isStoryExist(t,function(e,i){return e?void Utils.handleError(e):void(i?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[t])):DBMS.createStory(t,function(e){return e?void Utils.handleError(e):(Stories.updateSettings(t),void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void Stories.refresh()}))}))})},Stories.renameStory=function(){var t=queryEl("#storiesDiv .rename-entity-select").value.trim(),e=queryEl("#storiesDiv .rename-entity-input").value.trim();return""===e?void Utils.alert(getL10n("stories-new-story-name-is-not-specified")):t===e?void Utils.alert(getL10n("stories-names-are-the-same")):void DBMS.isStoryExist(e,function(i,n){return i?void Utils.handleError(i):void(n?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[e])):DBMS.renameStory(t,e,function(t){return t?void Utils.handleError(t):(Stories.updateSettings(e),void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void Stories.refresh()}))}))})},Stories.removeStory=function(){var t=queryEl("#storiesDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("stories-are-you-sure-about-story-removing"),[t]))&&DBMS.removeStory(t,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):void Stories.refresh()})})},Stories.onStorySelectorChangeDelegate=function(t){var e=t.target.value;Stories.onStorySelectorChange(e)},Stories.onStorySelectorChange=function(t){Stories.CurrentStoryName=t,t?(Stories.updateSettings(t),PermissionInformer.isStoryEditable(t,function(t,e){return t?void Utils.handleError(t):(Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh(),void Utils.enable(Stories.content,"isStoryEditable",e))})):(Stories.updateSettings(null),Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh())},Stories.updateSettings=function(t){var e=DBMS.getSettings();e.Stories.storyName=t};var StoryCharacters={};StoryCharacters.init=function(){var t=getEl("storyCharactersAddButton");t.addEventListener("click",StoryCharacters.addCharacter),t=getEl("storyCharactersSwitchButton"),t.addEventListener("click",StoryCharacters.switchCharacters),t=getEl("storyCharactersRemoveButton"),t.addEventListener("click",StoryCharacters.removeCharacter),StoryCharacters.ExternalCharacterSelectors=[getEl("storyCharactersAddSelector"),getEl("storyCharactersToSelector")],StoryCharacters.InternalCharacterSelectors=[getEl("storyCharactersRemoveSelector"),getEl("storyCharactersFromSelector")],StoryCharacters.content=getEl("storyCharactersDiv")},StoryCharacters.refresh=function(){StoryCharacters.ExternalCharacterSelectors.forEach(clearEl),StoryCharacters.InternalCharacterSelectors.forEach(clearEl),clearEl(getEl("story-characterActivityTableHead")),clearEl(getEl("story-characterActivityTable")),clearEl(getEl("storyCharactersTableHead")),clearEl(getEl("storyCharactersTable")),Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(t,e){return t?void Utils.handleError(t):void PermissionInformer.getCharacterNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void DBMS.getStoryCharacters(Stories.CurrentStoryName,function(t,n){return t?void Utils.handleError(t):(StoryCharacters.rebuildInterface(i,n),Utils.enable(StoryCharacters.content,"isStoryEditable",e),void Stories.chainRefresh())})})})},StoryCharacters.rebuildInterface=function(t,e){var i=[],n=[];t.filter(function(t){return!e[t.value]}).forEach(function(t){i.push(t)}),t.filter(function(t){return e[t.value]}).forEach(function(t){n.push(t)}),i.sort(Utils.charOrdAObject),n.sort(Utils.charOrdAObject);var r=getSelect2Data(i),o=getSelect2Data(n);StoryCharacters.ExternalCharacterSelectors.forEach(function(t){$("#"+t.id).select2(r)}),StoryCharacters.InternalCharacterSelectors.forEach(function(t){$("#"+t.id).select2(o)});var a=clearEl(getEl("story-characterActivityTableHead")),s=clearEl(getEl("story-characterActivityTable"));addEl(a,StoryCharacters.getCharacterHeader([getL10n("stories-name")].concat(Constants.characterActivityTypes.map(constL10n)))),n.forEach(function(t){addEl(s,StoryCharacters.getCharacterActivity(t,e[t.value]))}),a=clearEl(getEl("storyCharactersTableHead")),s=clearEl(getEl("storyCharactersTable")),addEl(a,StoryCharacters.getCharacterHeader([getL10n("stories-name"),getL10n("stories-inventory")])),n.forEach(function(t){addEl(s,StoryCharacters.getCharacterInput(t,e[t.value]))})},StoryCharacters.addCharacter=function(){var t=getEl("storyCharactersAddSelector").value.trim();return""===t?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void DBMS.addStoryCharacter(Stories.CurrentStoryName,t,Utils.processError(StoryCharacters.refresh))},StoryCharacters.switchCharacters=function(){var t=getEl("storyCharactersFromSelector").value.trim(),e=getEl("storyCharactersToSelector").value.trim();return""===t||""===e?void Utils.alert(getL10n("stories-one-of-switch-characters-is-not-specified")):void DBMS.switchStoryCharacters(Stories.CurrentStoryName,t,e,Utils.processError(StoryCharacters.refresh))},StoryCharacters.removeCharacter=function(){var t=getEl("storyCharactersRemoveSelector").value.trim();return""===t?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void(Utils.confirm(strFormat(getL10n("stories-remove-character-from-story-warning"),[t]))&&DBMS.removeStoryCharacter(Stories.CurrentStoryName,t,Utils.processError(StoryCharacters.refresh)))},StoryCharacters.getCharacterHeader=function(t){var e=makeEl("tr");return t.forEach(function(t){addEl(e,addEl(makeEl("th"),makeText(t)))}),e},StoryCharacters.getCharacterInput=function(t,e){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(t.displayName)),i.appendChild(n),n=makeEl("td");var r=makeEl("input");return r.value=e.inventory,r.characterName=e.name,addClass(r,"inventoryInput"),addClass(r,"isStoryEditable"),r.addEventListener("change",StoryCharacters.updateCharacterInventory),n.appendChild(r),i.appendChild(n),i},StoryCharacters.updateCharacterInventory=function(t){DBMS.updateCharacterInventory(Stories.CurrentStoryName,t.target.characterName,t.target.value,Utils.processError())},StoryCharacters.getCharacterActivity=function(t,e){var i=makeEl("tr"),n=makeEl("td");n.appendChild(makeText(t.displayName)),i.appendChild(n);var r;return addEls(i,Constants.characterActivityTypes.map(function(t){n=addClass(makeEl("td"),"vertical-aligned-td"),r=makeEl("input"),addClass(r,"isStoryEditable"),r.type="checkbox",e.activity[t]&&(r.checked=!0),r.characterName=e.name,r.activityType=t,r.addEventListener("change",StoryCharacters.onChangeCharacterActivity),setAttr(r,"id",e.name+t),addClass(r,"hidden"),addEl(n,r);var i=addClass(makeEl("label"),"checkbox-label");return setAttr(i,"for",e.name+t),addEl(n,i)})),i},StoryCharacters.onChangeCharacterActivity=function(t){DBMS.onChangeCharacterActivity(Stories.CurrentStoryName,t.target.characterName,t.target.activityType,t.target.checked,Utils.processError())};var StoryEvents={};StoryEvents.init=function(){var t=getEl("createEventButton");t.addEventListener("click",StoryEvents.createEvent),t=getEl("moveEventButton"),t.addEventListener("click",StoryEvents.moveEvent),t=getEl("cloneEventButton"),t.addEventListener("click",StoryEvents.cloneEvent),t=getEl("mergeEventButton"),t.addEventListener("click",StoryEvents.mergeEvents),t=getEl("removeEventButton"),t.addEventListener("click",StoryEvents.removeEvent),StoryEvents.content=getEl("storyEventsDiv")},StoryEvents.refresh=function(){StoryEvents.clearInterface(),void 0!==Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(t,e){return t?void Utils.handleError(t):void DBMS.getMetaInfo(function(t,i){return t?void Utils.handleError(t):void DBMS.getStoryEvents(Stories.CurrentStoryName,function(t,n){return t?void Utils.handleError(t):(StoryEvents.rebuildInterface(n,i),Utils.enable(StoryEvents.content,"isStoryEditable",e),void Stories.chainRefresh())})})})},StoryEvents.clearInterface=function(){clearEl(getEl("eventBlockHead")),clearEl(getEl("eventBlock"));var t=nl2array(document.querySelectorAll(".eventPositionSelector"));
R.ap([clearEl],t);var e=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],e)},StoryEvents.rebuildInterface=function(t,e){var i=clearEl(getEl("eventBlockHead")),n=clearEl(getEl("eventBlock"));addEl(i,StoryEvents.getEventHeader());var r,o,a=R.curry(function(t,e){addEl(t,addEl(makeEl("option"),makeText(e)))}),s=nl2array(document.querySelectorAll(".eventPositionSelector"));R.ap([clearEl],s),s.forEach(function(e){o=a(e),t.forEach(function(t){o(strFormat(getL10n("common-set-item-before"),[t.name]))}),o(getL10n("common-set-item-as-last")),e.selectedIndex=t.length}),R.ap([addEl(n)],t.map(function(t,i){return StoryEvents.appendEventInput(t,i,e.date,e.preGameDate)})),StoryEvents.eventsLength=t.length;var l=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],l),t.forEach(function(t,e){l.forEach(function(i){r=makeEl("option"),r.appendChild(makeText(t.name)),r.eventIndex=e,i.appendChild(r)})})},StoryEvents.createEvent=function(){var t=getEl("eventNameInput"),e=t.value.trim(),i=getEl("eventTextInput"),n=getEl("positionSelector"),r=i.value.trim();return""===e?void Utils.alert(getL10n("stories-event-name-is-not-specified")):""===r?void Utils.alert(getL10n("stories-event-text-is-empty")):void DBMS.createEvent(Stories.CurrentStoryName,e,r,n.value===getL10n("common-set-item-as-last"),n.selectedIndex,function(e){return e?void Utils.handleError(e):(t.value="",i.value="",void StoryEvents.refresh())})},StoryEvents.moveEvent=function(){var t=getEl("moveEventSelector").selectedOptions[0].eventIndex,e=getEl("movePositionSelector").selectedIndex;return t===e?void Utils.alert(getL10n("stories-event-positions-are-the-same")):void DBMS.moveEvent(Stories.CurrentStoryName,t,e,Utils.processError(StoryEvents.refresh))},StoryEvents.cloneEvent=function(){var t=getEl("cloneEventSelector").selectedIndex;DBMS.cloneEvent(Stories.CurrentStoryName,t,Utils.processError(StoryEvents.refresh))},StoryEvents.mergeEvents=function(){var t=getEl("mergeEventSelector").selectedIndex;return StoryEvents.eventsLength==t+1?void Utils.alert(getL10n("stories-cant-merge-last-event")):void DBMS.mergeEvents(Stories.CurrentStoryName,t,Utils.processError(StoryEvents.refresh))},StoryEvents.removeEvent=function(){var t=getEl("removeEventSelector");Utils.confirm(strFormat(getL10n("stories-remove-event-warning"),[t.value]))&&DBMS.removeEvent(Stories.CurrentStoryName,t.selectedIndex,Utils.processError(StoryEvents.refresh))},StoryEvents.getEventHeader=function(){var t=makeEl("tr");return addEl(t,addEl(makeEl("th"),makeText("№"))),addEl(t,addEl(makeEl("th"),makeText(getL10n("stories-event")))),t},StoryEvents.appendEventInput=function(t,e,i,n){var r=makeEl("tr");addEl(r,addEl(makeEl("td"),addEl(makeEl("span"),makeText(e+1))));var o=makeEl("td"),a=addClass(makeEl("div"),"story-events-div-main"),s=addClass(makeEl("div"),"story-events-div-left"),l=addClass(makeEl("div"),"story-events-div-right");return addEl(a,s),addEl(a,l),addEl(o,a),addEl(s,StoryEvents.makeEventNameInput(t,e)),addEl(l,UI.makeEventTimePicker({eventTime:t.time,index:e,preGameDate:n,date:i,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:StoryEvents.onChangeDateTimeCreator})),addEl(o,StoryEvents.makeEventTextInput(t,e)),addEl(r,o),r},StoryEvents.makeEventNameInput=function(t,e){var i=makeEl("input");return addClass(i,"isStoryEditable"),i.value=t.name,i.eventIndex=e,i.addEventListener("change",StoryEvents.updateEventName),i},StoryEvents.makeEventTextInput=function(t,e){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventText"),i.value=t.text,i.eventIndex=e,i.addEventListener("change",StoryEvents.updateEventText),i},StoryEvents.onChangeDateTimeCreator=function(t){return function(e,i){DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"time",i.val(),Utils.processError()),StoryEvents.lastDate=i.val(),removeClass(t,"defaultDate")}},StoryEvents.updateEventName=function(t){var e=t.target;return""===e.value.trim()?(Utils.alert(getL10n("stories-event-name-is-not-specified")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,e.eventIndex,"name",e.value,Utils.processError(StoryEvents.refresh))},StoryEvents.updateEventText=function(t){var e=t.target;return""===e.value.trim()?(Utils.alert(getL10n("stories-event-text-is-empty")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,e.eventIndex,"text",e.value,Utils.processError())},function(t){t.init=function(){},t.refresh=function(){}}(this.Template={});var Timeline={};Timeline.init=function(){var t=getEl("timelineStorySelector");t.addEventListener("change",Timeline.onStorySelectorChangeDelegate);var e=getEl("timelineContainer");Timeline.TimelineDataset=new vis.DataSet,Timeline.TagDataset=new vis.DataSet;var i={orientation:"top",showCurrentTime:!1},n=new vis.Timeline(e,null,i);n.setGroups(Timeline.TagDataset),n.setItems(Timeline.TimelineDataset),Timeline.timelineComponent=n,Timeline.content=getEl("timelineDiv")},Timeline.refresh=function(){var t=getEl("timelineStorySelector");clearEl(t);var e;DBMS.getMetaInfo(function(i,n){if(i)return void Utils.handleError(i);Timeline.postDate=n.date,Timeline.preDate=n.preGameDate;var r=new Date(Timeline.postDate),o=new Date(Timeline.preDate);r.setFullYear(r.getFullYear()+1),o.setFullYear(o.getFullYear()-1),Timeline.timelineComponent.setOptions({end:r,start:o}),PermissionInformer.getStoryNamesArray(!1,function(i,n){return i?void Utils.handleError(i):(n.forEach(function(i){e=makeEl("option"),e.appendChild(makeText(i.displayName)),e.value=i.value,t.appendChild(e)}),void(0!=n.length&&Timeline.onStorySelectorChange([n[0].value])))})})},Timeline.onStorySelectorChangeDelegate=function(t){for(var e=t.target.selectedOptions,i=[],n=0;n<e.length;n++)i.push(e[n].value);Timeline.onStorySelectorChange(i)},Timeline.onStorySelectorChange=function(t){Timeline.TagDataset.clear(),Timeline.TimelineDataset.clear();var e;DBMS.getEventGroupsForStories(t,function(i,n){return i?void Utils.handleError(i):(n.forEach(function(t){e=t.storyName,Timeline.TagDataset.add({id:e,content:e});var i=t.events;i.forEach(function(t){var i=Timeline.postDate;t.time&&(i=t.time),Timeline.TimelineDataset.add({content:t.name,start:i,group:e,storyName:e,eventIndex:t.index})})}),void(t[0]&&(Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-end-date"),start:new Date(Timeline.postDate),group:t[0],className:"importantItem",editable:!1}),Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-start-date"),start:new Date(Timeline.preDate),group:t[0],className:"importantItem",editable:!1}))))})};var NetworkSubsetsSelector={};NetworkSubsetsSelector.init=function(){listen(getEl("networkSubsetsSelector"),"change",NetworkSubsetsSelector.onNetworkSubsetsChange)},NetworkSubsetsSelector.refresh=function(t){NetworkSubsetsSelector.parent=t;var e,i=clearEl(getEl("networkSubsetsSelector")),n=!0;Constants.objectSubsets.forEach(function(t){e=makeEl("option"),e.appendChild(makeText(constL10n(t))),e.value=t,n&&(e.selected=!0,n=!1),i.appendChild(e)}),i=clearEl(getEl("networkCharacterSelector")),Object.keys(NetworkSubsetsSelector.parent.Characters).map(function(t){return NetworkSubsetsSelector.parent.Characters[t]}).sort(Utils.charOrdAObject).forEach(function(t){e=makeEl("option"),e.appendChild(makeText(t.displayName)),e.value=t.name,i.appendChild(e)}),i=clearEl(getEl("networkStorySelector")),Object.keys(NetworkSubsetsSelector.parent.Stories).map(function(t){return NetworkSubsetsSelector.parent.Stories[t]}).sort(Utils.charOrdAObject).forEach(function(t){e=makeEl("option"),e.appendChild(makeText(t.displayName)),e.value=t.name,i.appendChild(e)})},NetworkSubsetsSelector.getStoryNames=function(){var t,e=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===e)return Object.keys(NetworkSubsetsSelector.parent.Stories);if(Constants.objectSubsets[1]===e){t=getEl("networkCharacterSelector");var i,n={};for(i=0;i<t.selectedOptions.length;i+=1)n[t.selectedOptions[i].value]=!0;var r,o,a=[],s=function(t){return n[t]};return Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(t){r=NetworkSubsetsSelector.parent.Stories[t],o=Object.keys(r.characters),o.some(s)&&a.push(t)}),a}t=getEl("networkStorySelector");var i,a=[];for(i=0;i<t.selectedOptions.length;i+=1)a.push(t.selectedOptions[i].value);return a},NetworkSubsetsSelector.getCharacterNames=function(){var t,e=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===e)return Object.keys(NetworkSubsetsSelector.parent.Characters);if(Constants.objectSubsets[1]===e){t=getEl("networkCharacterSelector");var i,n={},r={};for(i=0;i<t.selectedOptions.length;i+=1)n[t.selectedOptions[i].value]=!0;var o,a,s,l,h=function(t){return n[t]};Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(t){o=NetworkSubsetsSelector.parent.Stories[t],a=Object.keys(o.characters),a.some(h)&&o.events.forEach(function(t){s=Object.keys(t.characters),s.some(h)&&s.forEach(function(t){h(t)||(r[t]=!0)})})});var c=Object.keys(n).concat(Object.keys(r));return c}t=getEl("networkStorySelector");var i,d=[],u={};for(i=0;i<t.selectedOptions.length;i+=1)d.push(t.selectedOptions[i].value);var o;return d.forEach(function(t){o=NetworkSubsetsSelector.parent.Stories[t];for(l in o.characters)u[l]=!0}),Object.keys(u)},NetworkSubsetsSelector.onNetworkSubsetsChange=function(t){var e=t.target.value,i=getEl("networkCharacterDiv"),n=getEl("networkStoryDiv");setClassByCondition(i,"hidden",e!==Constants.objectSubsets[1]),setClassByCondition(n,"hidden",e!==Constants.objectSubsets[2])};var SocialNetwork={};SocialNetwork.colorMap={},SocialNetwork.activityColors={active:"red",follower:"blue",defensive:"green",passive:"grey"},SocialNetwork.generatedColors=[],SocialNetwork.focusOptions={scale:1.2,offset:{x:0,y:0},animation:{duration:1e3,easingFunction:"easeInOutQuad"}},SocialNetwork.fixedColors={storyColor:{color:{background:"rgb(255,255,0)",border:"rgb(255,168,3)"}},noGroup:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}},thirdDegreeNode:{color:{background:"rgba(200,200,200,0.5)",border:"rgba(200,200,200,0.5)"}},secondDegreeNode:{color:{background:"rgba(150,150,150,0.75)",border:"rgba(150,150,150,0.75)"}},firstDegreeNode:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}}},SocialNetwork.init=function(){SocialNetwork.highlightActive=!0,NetworkSubsetsSelector.init(),listen(getEl("networkNodeGroupSelector"),"change",function(t){SocialNetwork.updateNodes(t.target.value)}),listen(getEl("drawNetworkButton"),"click",SocialNetwork.onDrawNetwork),$("#nodeFocusSelector").select2().on("change",SocialNetwork.onNodeFocus);var t=getEl("networkSelector");t.addEventListener("change",SocialNetwork.onNetworkSelectorChangeDelegate),t=getEl("activitySelector"),t.addEventListener("change",SocialNetwork.onActivitySelectorChangeDelegate);var e,i;Constants.characterActivityTypes.forEach(function(n){i=makeEl("option"),i.appendChild(makeText(constL10n(n))),e=i.style,e.color=SocialNetwork.activityColors[n],i.activity=n,t.appendChild(i)}),SocialNetwork.selectedActivities={},SocialNetwork.network,SocialNetwork.highlightActive=!1;var n=function(){var t=clearEl(getEl("socialNetworkWarning"));addEl(t,makeText(getL10n("social-network-require-resources-warning")));var e=makeEl("button");addEl(e,makeText(getL10n("social-network-remove-resources-warning"))),addEl(t,e),e.addEventListener("click",function(){addClass(t,"hidden")})};n(),L10n.onL10nChange(n),SocialNetwork.nodeSort=CommonUtils.charOrdAFactory(function(t){return t.label.toLowerCase()}),SocialNetwork.content=getEl("socialNetworkDiv")},SocialNetwork.refresh=function(){var t,e=clearEl(getEl("networkSelector"));Constants.networks.forEach(function(i){t=makeEl("option"),t.appendChild(makeText(constL10n(i))),t.value=i,e.appendChild(t)}),e.value=Constants.networks[0],e=clearEl(getEl("networkNodeGroupSelector")),PermissionInformer.getCharacterNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void PermissionInformer.getStoryNamesArray(!1,function(t,n){return t?void Utils.handleError(t):void DBMS.getAllProfiles(function(t,r){return t?void Utils.handleError(t):(SocialNetwork.Characters=r,i.forEach(function(t){r[t.value].displayName=t.displayName}),void DBMS.getAllStories(function(t,i){return t?void Utils.handleError(t):(SocialNetwork.Stories=i,n.forEach(function(t){i[t.value].displayName=t.displayName}),void DBMS.getAllProfileSettings(function(t,i){return t?void Utils.handleError(t):void DBMS.getMetaInfo(function(t,n){if(t)return void Utils.handleError(t);SocialNetwork.metaInfo=n;var r=i.filter(function(t){return"enum"===t.type||"checkbox"===t.type}),o=[{name:Constants.noGroup,displayName:constL10n(Constants.noGroup)}].concat(r.map(function(t){return{name:t.name,displayName:t.name}}));o.forEach(function(t){var i=makeEl("option");i.appendChild(makeText(t.displayName)),i.value=t.name,e.appendChild(i)}),SocialNetwork.groupColors={},SocialNetwork.groupLists={noGroup:["noGroup"]};for(var a in SocialNetwork.fixedColors)SocialNetwork.groupColors[a]=SocialNetwork.fixedColors[a];r.forEach(function(t){if("enum"===t.type){var e=[];t.value.split(",").forEach(function(i,n){SocialNetwork.groupColors[t.name+"."+i.trim()]=Constants.colorPalette[n],e.push(t.name+"."+i.trim())}),SocialNetwork.groupLists[t.name]=e}else"checkbox"===t.type&&(t.value?(SocialNetwork.groupColors[t.name+".true"]=Constants.colorPalette[0],SocialNetwork.groupColors[t.name+".false"]=Constants.colorPalette[1]):(SocialNetwork.groupColors[t.name+".true"]=Constants.colorPalette[1],SocialNetwork.groupColors[t.name+".false"]=Constants.colorPalette[0]),SocialNetwork.groupLists[t.name]=[t.name+".true",t.name+".false"])}),NetworkSubsetsSelector.refresh(SocialNetwork)})}))}))})})})},SocialNetwork.refreshLegend=function(t){var e=getEl("colorLegend");clearEl(e);var i;SocialNetwork.groupLists[t].forEach(function(t){i=makeEl("div"),i.appendChild(makeText("noGroup"===t?constL10n("noGroup"):t)),i.style.backgroundColor=SocialNetwork.groupColors[t].color.background,i.style.border="solid 2px "+SocialNetwork.groupColors[t].color.border,e.appendChild(i)}),-1!==["characterPresenceInStory","characterActivityInStory"].indexOf(SocialNetwork.selectedNetwork)&&(i=makeEl("div"),i.appendChild(makeText(getL10n("social-network-story"))),i.style.backgroundColor=SocialNetwork.fixedColors.storyColor.color.background,i.style.border="solid 2px "+SocialNetwork.fixedColors.storyColor.color.border,e.appendChild(i))},SocialNetwork.updateNodes=function(t){SocialNetwork.refreshLegend(t);var e;NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var n=SocialNetwork.Characters[i];e="noGroup"===t?t:t+"."+n[t],SocialNetwork.nodesDataset.update({id:n.name,group:e})})},SocialNetwork.onActivitySelectorChangeDelegate=function(t){SocialNetwork.selectedActivities={};var e;for(e=0;e<t.target.selectedOptions.length;e+=1)SocialNetwork.selectedActivities[t.target.selectedOptions[e].activity]=!0},SocialNetwork.onNetworkSelectorChangeDelegate=function(t){var e=t.target.value,i=getEl("activityBlock");setClassByCondition(i,"hidden","characterActivityInStory"!==e)},SocialNetwork.onNodeFocus=function(t){SocialNetwork.network.focus(t.target.value,SocialNetwork.focusOptions)},SocialNetwork.onDrawNetwork=function(){SocialNetwork.onNetworkSelectorChange(getEl("networkSelector").value)},SocialNetwork.onNetworkSelectorChange=function(t){switch(SocialNetwork.selectedNetwork=t,SocialNetwork.nodes=[],SocialNetwork.edges=[],t){case"simpleNetwork":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getSimpleEdges();break;case"socialRelations":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getDetailedEdges();break;case"characterPresenceInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getStoryEdges();break;case"characterActivityInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getActivityEdges()}SocialNetwork.refreshLegend(getEl("networkNodeGroupSelector").value),clearEl(getEl("nodeFocusSelector")),SocialNetwork.nodes.sort(SocialNetwork.nodeSort);var e=getSelect2DataCommon(remapProps(["id","text"],["id","label"]),SocialNetwork.nodes);$("#nodeFocusSelector").select2(e),SocialNetwork.nodesDataset=new vis.DataSet(SocialNetwork.nodes),SocialNetwork.edgesDataset=new vis.DataSet(SocialNetwork.edges),SocialNetwork.redrawAll()},SocialNetwork.getCharacterNodes=function(){var t=getEl("networkNodeGroupSelector").value,e=[];return NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var n=SocialNetwork.Characters[i];e.push({id:n.name,label:n.name.split(" ").join("\n"),group:"noGroup"===t?constL10n("noGroup"):t+"."+n[t]})}),e},SocialNetwork.getStoryNodes=function(){var t=NetworkSubsetsSelector.getStoryNames().map(function(t){return{id:"St:"+t,label:t.split(" ").join("\n"),value:Object.keys(SocialNetwork.Stories[t].characters).length,title:Object.keys(SocialNetwork.Stories[t].characters).length,group:"storyColor"}});return t},SocialNetwork.getActivityEdges=function(){var t=[];for(var e in SocialNetwork.Stories){var i=SocialNetwork.Stories[e];for(var n in i.characters)for(var r in i.characters[n].activity)SocialNetwork.selectedActivities[r]&&t.push({from:"St:"+e,to:n,color:SocialNetwork.activityColors[r],width:2,hoverWidth:4})}return t},SocialNetwork.getStoryEdges=function(){var t=[];for(var e in SocialNetwork.Stories){var i=SocialNetwork.Stories[e];for(var n in i.characters)t.push({from:"St:"+e,to:n,color:"grey"})}return t},SocialNetwork.getSimpleEdges=function(){var t=[],e={};for(var i in SocialNetwork.Stories){var n=SocialNetwork.Stories[i];n.events.forEach(function(n){for(var r in n.characters)for(var o in n.characters)r===o||e[i+r+o]||e[i+o+r]||(e[i+r+o]=!0,t.push({from:r,to:o,color:"grey"}))})}return t},SocialNetwork.getEventDetails=function(){return R.flatten(R.values(SocialNetwork.Stories).map(function(t){return t.events.map(function(e){return{eventName:e.name,storyName:t.name,time:e.time,characters:R.keys(e.characters)}})}))},SocialNetwork.getDetailedEdges=function(){var t={};return R.values(SocialNetwork.Stories).forEach(function(e){e.events.forEach(function(i){var n=R.keys(i.characters).sort();n.forEach(function(i,r){n.forEach(function(n,o){if(!(o>=r)){var a=i+n;t[a]||(t[a]={from:i,to:n,title:{}}),t[a].title[e.name]=!0}})})})}),R.values(t).map(function(t){var e=R.keys(t.title).sort().join(", "),i=R.keys(t.title).length;return{from:t.from,to:t.to,title:i+": "+e,value:i,color:"grey"}})},SocialNetwork.redrawAll=function(){var t=getEl("socialNetworkContainer"),e={nodes:SocialNetwork.nodesDataset,edges:SocialNetwork.edgesDataset};SocialNetwork.network&&SocialNetwork.network.destroy();var i=CommonUtils.clone(Constants.socialNetworkOpts);i.groups=SocialNetwork.groupColors,SocialNetwork.network=new vis.Network(t,e,i),SocialNetwork.network.on("click",SocialNetwork.neighbourhoodHighlight)},SocialNetwork.neighbourhoodHighlight=function(t){var e=SocialNetwork.nodesDataset.get({returnType:"Object"}),i=SocialNetwork.network,n=SocialNetwork.nodesDataset;if(t.nodes.length>0){SocialNetwork.highlightActive=!0;var r,o,a=t.nodes[0],s=2;for(var l in e)e[l].color="rgba(200,200,200,0.5)",void 0===e[l].hiddenLabel&&(e[l].hiddenLabel=e[l].label,e[l].label=void 0);var h=i.getConnectedNodes(a),c=[];for(r=1;s>r;r++)for(o=0;o<h.length;o++)c=c.concat(i.getConnectedNodes(h[o]));for(r=0;r<c.length;r++)e[c[r]].color="rgba(150,150,150,0.75)",void 0!==e[c[r]].hiddenLabel&&(e[c[r]].label=e[c[r]].hiddenLabel,e[c[r]].hiddenLabel=void 0);for(r=0;r<h.length;r++)e[h[r]].color=void 0,void 0!==e[h[r]].hiddenLabel&&(e[h[r]].label=e[h[r]].hiddenLabel,e[h[r]].hiddenLabel=void 0);e[a].color=void 0,void 0!==e[a].hiddenLabel&&(e[a].label=e[a].hiddenLabel,e[a].hiddenLabel=void 0)}else if(t.edges.length>0){SocialNetwork.highlightActive=!0;var r,o,d=t.edges[0],s=2;for(var l in e)e[l].color="rgba(200,200,200,0.5)",void 0===e[l].hiddenLabel&&(e[l].hiddenLabel=e[l].label,e[l].label=void 0);var u=i.getConnectedNodes(d),f=[];for(r=1;s>r;r++)for(o=0;o<u.length;o++)f=f.concat(i.getConnectedNodes(u[o]));for(r=0;r<f.length;r++)e[f[r]].color="rgba(150,150,150,0.75)",void 0!==e[f[r]].hiddenLabel&&(e[f[r]].label=e[f[r]].hiddenLabel,e[f[r]].hiddenLabel=void 0);for(r=0;r<u.length;r++)e[u[r]].color=void 0,void 0!==e[u[r]].hiddenLabel&&(e[u[r]].label=e[u[r]].hiddenLabel,e[u[r]].hiddenLabel=void 0)}else if(SocialNetwork.highlightActive===!0){for(var l in e)e[l].color=void 0,void 0!==e[l].hiddenLabel&&(e[l].label=e[l].hiddenLabel,e[l].hiddenLabel=void 0);SocialNetwork.highlightActive=!1}var p=[];for(l in e)e.hasOwnProperty(l)&&p.push(e[l]);n.update(p)},function(t){function e(){var t=new Stats;return t.setMode(0),addEl(clearEl(getEl("Stats-output")),t.domElement),t}function i(){h=new THREE.WebGLRenderer,h.setClearColor(new THREE.Color(15658734,1)),addEl(clearEl(getEl("WebGL-output")),h.domElement),d=e(),c=new function(){this.rotationSpeed=.08,this.zScale=f,this.planeScale=10,this.cameraZ=120,this.outputObjects=function(){console.log(l.children)}};var t=new dat.GUI({autoPlace:!1});t.add(c,"rotationSpeed",0,.5),t.add(c,"zScale",1,100),t.add(c,"planeScale",1,100),t.add(c,"cameraZ",-500,500),t.add(c,"outputObjects"),addEl(getEl("gui-settings-output"),t.domElement)}function n(t,e,i,n,o){function m(t){t.minTime=R.reduce(R.min,1/0,t.events.map(R.prop("scaledTime"))),t.maxTime=R.reduce(R.max,-(1/0),t.events.map(R.prop("scaledTime")))}function g(t){return t.startsWith("St:")?w[t.substring(3)]:x[t]}function v(){d.update(),t.storePositions(),A?e.get().forEach(function(t){var e=l.getObjectByName(String("cyl-"+t.id));e&&(e.position.x=t.x/10,e.position.y=-t.y/10)}):(console.log(e.get()),console.log(i.get()),e.get().forEach(function(t){var e=g(t.id);if(e){var i=e.maxTime-e.minTime,n=(e.maxTime+e.minTime)/2;a(t.x/10,-t.y/10,n*f,i,.5,String("cyl-"+t.id))}}),A=!0),l.traverse(function(t){if(t instanceof THREE.Mesh&&t.name.startsWith("cyl-")){var e=g(t.name.substring(4));t.position.z=(e.maxTime+e.minTime)/2*c.zScale,t.scale.y=c.zScale}});var n=Date.now(),r=.005;s.position.x=50*Math.sin(n*c.rotationSpeed*r),s.position.y=50*Math.cos(n*c.rotationSpeed*r),s.position.z=c.cameraZ,s.lookAt(new THREE.Vector3(0,0,0)),requestAnimationFrame(v),h.render(l,s)}var y=new Date(o.preGameDate).getTime(),b=new Date(o.date).getTime(),E=b-y;console.log(y),console.log(b),console.log(E);var x={},w={};n.forEach(function(t){""===t.time&&(t.time=o.date),t.scaledTime=(new Date(t.time).getTime()-y)/E,console.log(t.scaledTime),w[t.storyName]=w[t.storyName]||{events:[]},w[t.storyName].events.push(t),t.characters.forEach(function(e){x[e]=x[e]||{events:[]},x[e].events.push(t)})}),console.log(w),console.log(x),R.values(w).forEach(m),R.values(x).forEach(m),console.log(w),console.log(x);var _=r();l=new THREE.Scene,s=new THREE.PerspectiveCamera(45,_.width/_.height,.1,1e3);var T=new THREE.AxisHelper(20);l.add(T);var S=new THREE.PlaneGeometry(60,20,1,1),C=new THREE.MeshBasicMaterial({color:16777215,opacity:0}),k=new THREE.Mesh(S,C);k.rotation.x=-.5*Math.PI,k.position.x=15,k.position.y=0,k.position.z=0,l.add(k),s.position.copy(u),s.lookAt(new THREE.Vector3(0,0,0)),s.position.add(new THREE.Vector3(0,-100,0)),s.lookAt(new THREE.Vector3(0,0,0));var M=new THREE.AmbientLight(789516);l.add(M);var P=new THREE.SpotLight(16777215);P.position.copy(p),l.add(P);var A=!1;v()}function r(){var t=getComputedStyle(getEl("socialNetworkContainer")),e=.75*t.width.split("px").join(""),i=.75*t.height.split("px").join("");return h.setSize(e,i),{width:e,height:i}}function o(){if(s&&h){var t=r();s.aspect=t.width/t.height,s.updateProjectionMatrix()}}function a(t,e,i,n,r,o){var a=new THREE.CylinderGeometry(r,r,n,32),s=new THREE.MeshLambertMaterial({color:7829503}),h=new THREE.Mesh(a,s);h.name=o,h.position.x=t,h.position.y=e,h.position.z=i,h.rotation.x=-.5*Math.PI,l.add(h)}var s,l,h,c,d,u=new THREE.Vector3(0,0,60).multiplyScalar(2.5),f=25,p=new THREE.Vector3(0,0,50);t.init=i,t.refresh=n,window.addEventListener("resize",o,!1)}(this.TimelinedNetwork={});