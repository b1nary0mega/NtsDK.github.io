/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, Database, Migrator
 */
"use strict";

function makeLocalDBMS(fullVersion){
//    if(!fullVersion){
//        function LocalDBMS(){
//        };
//        return LocalDBMS;
//    }
    
    var opts = {
        Migrator     : Migrator    ,
        CommonUtils  : CommonUtils ,
        EventEmitter : EventEmitter,
        R            : R           ,
        Ajv          : Ajv         ,
        Schema       : Schema      ,
        Errors       : Errors      ,
        listeners    : {}          ,
        Constants    : Constants   ,
        dbmsUtils    : {}          ,
        dateFormat   : dateFormat  ,
    };
    
    function LocalDBMS(){
        this._init(opts.listeners);
    };
    
    LocalDBMS.prototype.getSettings = function(){
        "use strict";
        return this.database.Settings;
    };
    
    var func = (name) => window[name](LocalDBMS, opts);
    
    ["baseAPI"               ,
    "consistencyCheckAPI"   ,
    "statisticsAPI"         ,
    "profilesAPI"           ,
    "profileBindingAPI"     ,
    
    "groupsAPI"             ,
    "groupSchemaAPI"        ,
    "investigationBoardAPI" ,
    "relationsAPI"          ,
    "briefingExportAPI"     ,
    
    "profileConfigurerAPI"  ,
    "entityAPI"             ,
    "storyBaseAPI"          ,
    "storyEventsAPI"        ,
    "storyCharactersAPI"    ,
    
    "storyViewAPI"          ,
    "storyAdaptationsAPI"   ,
    "accessManagerAPI"      ,
    "textSearchAPI"         ,
    "logAPI"].map(func);
    
    Logger.attachLogCalls(LocalDBMS, R, false);
    return LocalDBMS;
};



/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, Database
 */
"use strict";

var showNotification = true;
function makeRemoteDBMS(LocalDBMS){
    
    var url = "/";
    
    function RemoteDBMS(){
        this.clearSettings();
    };
    
    RemoteDBMS._simpleGet = function(name, params, callback){
        "use strict";
        var paramStr = "";
        if(params){
            paramStr = "?params=" + encodeURIComponent(JSON.stringify(params)); ; 
        }
        
        var request = $.ajax({
            url : url + name + paramStr,
            dataType : "text",
            method : "GET",
            contentType : "application/json;charset=utf-8",
            cache: false,
            timeout: Constants.httpTimeout,
        });
        
        request.done(function(data) {
            callback(null, JSON.parse(data));
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            try {
                callback(JSON.parse(errorInfo.responseText));
            } catch(err){
                callback(errorInfo.responseText || textStatus || 'error');
            }
        });
    };
    
    RemoteDBMS._simplePut = function(name, data, callback){
        "use strict";
        var request = $.ajax({
            url : url + name,
            dataType : "text",
            method : "PUT",
            contentType : "application/json;charset=utf-8",
            data: JSON.stringify(data),
            timeout: Constants.httpTimeout
        });
        
        if(showNotification){
            var notificationBox = clearEl(getEl('debugNotification'));
            removeClass(notificationBox, 'hidden');
            removeClass(notificationBox, 'operationOK');
            removeClass(notificationBox, 'operationFail');
            addEl(notificationBox, makeText(name + ' ' + JSON.stringify(data)));
        }
        
        request.done(function(data) {
            if(showNotification){
                addClass(notificationBox, 'operationOK');
                setTimeout(function(){
                    addClass(notificationBox, 'hidden');
                }, 2000);
            }
            if(callback) callback();
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            if(showNotification){
                addClass(notificationBox, 'operationFail');
                setTimeout(function(){
                    addClass(notificationBox, 'hidden');
                }, 2000);
            }
            try {
                callback(JSON.parse(errorInfo.responseText));
            } catch(err){
                callback(errorInfo.responseText || textStatus || 'error');
            }
        });
    };
    
    
    Object.keys(LocalDBMS.prototype).forEach(function(name){
        RemoteDBMS.prototype[name] = function(){
            var arr = [];
            for (var i = 0; i < arguments.length-1; i++) {
                arr.push(arguments[i]);
            }
//            if(CommonUtils.startsWith(name, "_")){
//                // do nothing for inner functions
//            } else 
            if(CommonUtils.startsWith(name, "get") || CommonUtils.startsWith(name, "is")){
                RemoteDBMS._simpleGet(name, arr, arguments[arguments.length-1]);
            } else {
                RemoteDBMS._simplePut(name, arr, arguments[arguments.length-1]);
            }
        }
    });
    
    
    RemoteDBMS.prototype.clearSettings = function() {
        "use strict";
        this.Settings = {
                "BriefingPreview" : {},
                "Stories" : {},
                "ProfileEditor" : {}
        };
    };
    
    RemoteDBMS.prototype.getSettings = function(){
        "use strict";
        return this.Settings;
    };
    return RemoteDBMS;
};



/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, saveAs, FileReader, Blob
 */

"use strict";

var FileUtils = {};

FileUtils.init = function (callback) {
    "use strict";
    FileUtils.callback = callback;
};

FileUtils.makeNewBase = function () {
    "use strict";
    Utils.confirm(getL10n("utils-new-base-warning"), () => {
        DBMS.setDatabase(CommonUtils.clone(EmptyBase.data), FileUtils.callback);
    });
};

FileUtils.openHelp = function () {
    "use strict";
    window.open("extras/doc/nims.html");
};

FileUtils.readSingleFile = function (evt) {
    "use strict";
    // Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0];

    if (f) {
        var r = new FileReader();
        r.onload = function (e) {
            var contents = e.target.result;
            var database = JSON.parse(contents);
            DBMS.setDatabase(database, FileUtils.callback);
        };
        r.readAsText(f);
    } else {
        Utils.alert(getL10n("utils-base-file-loading-error"));
    }
};

FileUtils.saveFile = function () {
    "use strict";
    DBMS.getDatabase(function(err, database){
        if(err) {Utils.handleError(err); return;}
        FileUtils.json2File(database, "nims-base.json");
    });
};

FileUtils.json2File = function (str, fileName) {
    "use strict";
    FileUtils.str2File(JSON.stringify(str, null, '  '), fileName);
};

FileUtils.str2File = function (str, fileName) {
    "use strict";
    var blob = new Blob([ str ], {
        type : "text/plain;charset=utf-8"
    });
    saveAs(blob, fileName);
};


/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 */

"use strict";

(function(exports, Dictionaries){

    var state = {};
    
    state.initialized = false;
    state.l10nDelegates = [];
    state.dictionaries = {};
    state.lang = defaultLang;
    
    var init = function(){
        if(state.initialized){
            return;
        }
//        console.log(navigator.language);
        
        for(var name in Dictionaries){
            state.dictionaries[name] = processDictionary(Dictionaries[name]);
        }
        
    //    var lang = (navigator.languages ? navigator.languages[0] : navigator.browserLanguage).split('-')[0];
    //    var lang = 'ru';
//        var lang = defaultLang;
//        console.log(lang);
        
        if(state.dictionaries[defaultLang]){
            state.dict = state.dictionaries[defaultLang];
        } else {
            state.dict = state.dictionaries['en'];
        }
        setHtmlLang(defaultLang);
        exports.onL10nChange(exports.localizeStatic);
        state.initialized = true;
    };
    
    var processDictionary = function(dictionary){
        var processedDictionary = {};
        for(var sectionName in dictionary){
            for(var name in dictionary[sectionName]){
                processedDictionary[sectionName+"-"+name] = dictionary[sectionName][name];
            }
        } 
        return processedDictionary;
    };
    
    var setHtmlLang = (lang) => setAttr(document.getElementsByTagName("html")[0],'lang', lang);
    
    exports.toggleL10n = function(){
        if(state.lang === "ru"){
            state.dict = state.dictionaries['en'];
            state.lang = "en";
        } else {
            state.dict = state.dictionaries['ru'];
            state.lang = "ru";
        }
        setHtmlLang(state.lang);
        state.l10nDelegates.forEach(function(delegate){
            delegate();
        });
    };
    
    exports.getLang = () => state.lang.toLowerCase();
    
    exports.getValue = function(name){
        var value = state.dict[name];
        return value ? value : name + ":RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA";
    };
    
    exports.onL10nChange = function(delegate){
        state.l10nDelegates.push(delegate);
    };
    
    exports.localizeStatic = function(){
        init();
        nl2array(document.querySelectorAll("[l10n-id]")).map(el => addEl(clearEl(el), makeText(exports.getValue(getAttr(el,"l10n-id")))));
        nl2array(document.querySelectorAll("[l10n-placeholder-id]")).map(el => setAttr(el,"placeholder", exports.getValue(getAttr(el,"l10n-placeholder-id"))));
    };

})(this['L10n']={}, Dictionaries);
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
Utils, Overview, Profiles, Stories, Adaptations, Briefings, Timeline, SocialNetwork, FileUtils
 */

"use strict";

(function(exports){

    var state = {};
    state.views = {};
    
    var btnOpts = {
        tooltip : true,
        className : 'mainNavButton'
    }
    
    var initPage = function(){
        L10n.localizeStatic();
        L10n.onL10nChange(() => state.currentView.refresh());
        UI.initSelectorFilters();
        UI.initPanelTogglers();
        function updateDialogs(){
            vex.dialog.buttons.YES.text = getL10n('common-ok');
            vex.dialog.buttons.NO.text = getL10n('common-cancel');
        }
        updateDialogs();
        L10n.onL10nChange(updateDialogs);
    }
    
    var protoExpander = function(arr){
        function protoCarrier(){};
        arr.forEach( name => protoCarrier.prototype[name] = (() => 1));
        return protoCarrier;
    };
    var playerArr = [
                    'getPlayersOptions'        ,
                    'getWelcomeText'           ,
                    'getPlayerProfileInfo'     ,
                    'createCharacterByPlayer'  ,
                    'updateProfileField'       ];
    
    exports.onPlayerPageLoad = function () {
        initPage();
        var RemoteDBMS = makeRemoteDBMS(protoExpander(playerArr));
        window.DBMS = new RemoteDBMS();
        stateInit();
        Utils.addView(state.containers, "player", Player, {mainPage:true});
        addEl(state.navigation, addClass(makeEl("div"), "nav-separator"));
        Utils.addView(state.containers, "about", About);
//        addEl(state.navigation, makeL10nButton());
        addEl(state.navigation, makeButton("logoutButton", "logout", postLogout, btnOpts));
        state.currentView.refresh();
    };
    
    exports.onIndexPageLoad = function () {
        initPage();
        var RemoteDBMS = makeRemoteDBMS(protoExpander(['getPlayersOptions']));
        window.DBMS = new RemoteDBMS();
        stateInit();
        DBMS.getPlayersOptions(function(err, playersOptions){
            if(err) {Utils.handleError(err); return;}
            addEl(state.navigation, addClass(makeEl("div"), "nav-separator"));
            Utils.addView(state.containers, "enter", Enter, {mainPage:true});
            if(playersOptions.allowPlayerCreation){
                Utils.addView(state.containers, "register", Register);
            }
            Utils.addView(state.containers, "about", About);
//            addEl(state.navigation, makeL10nButton());
            state.currentView.refresh();
        });
        
    };
    
    exports.onMasterPageLoad = function () {
        initPage();
        var LocalDBMS = makeLocalDBMS(true);
        if(MODE === "Standalone"){
            window.DBMS = new LocalDBMS();
            DBMS.setDatabase(BaseExample.data, function(err){
                if(err) {Utils.handleError(err); return;}
                consistencyCheck(onDatabaseLoad);
            });
        } else if(MODE === "NIMS_Server") {
            var RemoteDBMS = makeRemoteDBMS(LocalDBMS);
            window.DBMS = new RemoteDBMS();
            consistencyCheck(onDatabaseLoad);
        }
    };
    
    var consistencyCheck = function(callback){
        DBMS.getConsistencyCheckResult(function(err, consistencyErrors){
            if(err) {Utils.handleError(err); return;}
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if(consistencyErrors.length > 0){
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                console.log('Consistency check didn\'t find errors');
            }
            callback();
        });
    };
    
    var stateInit = function(){
        state.navigation = getEl("navigation");
        state.containers = {
                root: state,
                navigation: state.navigation,
                content: getEl("contentArea")
        };
    };
    
    var onDatabaseLoad = function () {
        PermissionInformer.refresh(function(err){
            if(err) {Utils.handleError(err); return;}
            
            PermissionInformer.isAdmin(function(err, isAdmin){
                if(err) {Utils.handleError(err); return;}
                
                var button;
                stateInit();

                Utils.addView(state.containers, "overview", Overview, {mainPage:true});
                Utils.addView(state.containers, "profiles", Profiles);
                Utils.addView(state.containers, "stories", Stories);
                Utils.addView(state.containers, "adaptations", Adaptations);
                Utils.addView(state.containers, "briefings", Briefings);
    //            Utils.addView(state.containers, "about", About);
                
                addEl(state.navigation, addClass(makeEl("div"), "nav-separator"));
                
                Utils.addView(state.containers, "timeline", Timeline, {id:"timelineButton", tooltip:true});
                Utils.addView(state.containers, "social-network", SocialNetwork, {id:"socialNetworkButton", tooltip:true});
                Utils.addView(state.containers, "profile-filter", ProfileFilter, {id:"filterButton", tooltip:true});
                Utils.addView(state.containers, "groups", Groups, {id:"groupsButton", tooltip:true});
                Utils.addView(state.containers, "textSearch", TextSearch, {id:"textSearchButton", tooltip:true});
                
                addEl(state.navigation, addClass(makeEl("div"), "nav-separator"));
                
                if(isAdmin){
                    var button = makeButton("dataLoadButton", "open-database", null, btnOpts);
                    button.addEventListener('change', FileUtils.readSingleFile, false);
                    
                    var input = makeEl("input");
                    input.type = "file";
                    addClass(input, 'hidden');
                    setAttr(input, 'tabindex', -1);
                    button.appendChild(input);
                    button.addEventListener('click', function(e){
                        input.click();
    //                    e.preventDefault(); // prevent navigation to "#"
                    });
                    addEl(state.navigation, button);
                }
                
                addEl(state.navigation, makeButton("dataSaveButton", "save-database", FileUtils.saveFile, btnOpts));
                if(MODE === "Standalone"){
                    addEl(state.navigation, makeButton("newBaseButton", "create-database", FileUtils.makeNewBase, btnOpts));
                }
                addEl(state.navigation, makeButton("mainHelpButton", "docs", FileUtils.openHelp, btnOpts));
                
                //addEl(state.navigation, makeL10nButton());
                
                Utils.addView(state.containers, "logViewer", LogViewer2, {id:"logViewerButton", tooltip:true});
                //addEl(state.navigation, makeButton("testButton", "test", runTests, btnOpts));
                if(MODE === "NIMS_Server"){
                    Utils.addView(state.containers, "admins", AccessManager, {id:"accessManagerButton", tooltip:true});
                    addEl(state.navigation, makeButton("logoutButton", "logout", postLogout, btnOpts));
                }
                
                FileUtils.init(function(err){
                    if(err) {Utils.handleError(err); return;}
                    consistencyCheck(state.currentView.refresh);
                });
                
                state.currentView.refresh();
                if(MODE === "Standalone") {
                    addBeforeUnloadListener();
                }
            });
        });
        
    };
    
    var makeL10nButton = function(){
        var l10nBtn = makeButton("toggleL10nButton", "l10n", L10n.toggleL10n, btnOpts);
        var setIcon = function(){
            l10nBtn.style.backgroundImage = strFormat('url("./images/{0}.svg")', [getL10n('header-dictionary-icon')]);
        }
        L10n.onL10nChange(setIcon);
        setIcon();
        return l10nBtn;
    };
    
    var runTests = function(){
    //    window.RunTests();
        consistencyCheck(function(err, checkRes){
            if(err) {Utils.handleError(err); return;}
            if(checkRes === undefined || checkRes.length === 0){
                Utils.alert(getL10n('overview-consistency-is-ok'));
            } else {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            }
        });
    };
    
    var postLogout = function(){
        document.querySelector('#logoutForm button').click();
    };
    
    var makeButton = function(id, name, callback, opts){
        var button = makeEl("button");
        button.id = id;
        if(opts.tooltip){
            var delegate = function(){
                $(button).attr('data-original-title', L10n.getValue("header-" + name));
            };
            L10n.onL10nChange(delegate);
            $(button).tooltip({
                title : L10n.getValue("header-" + name),
                placement : "bottom"
            });
        }
        addClass(button, "action-button");
        if(opts.className){
            addClass(button, opts.className);
        }
        if(callback){
            listen(button, 'click', callback);
        }
        return button;
    };
    
    var addBeforeUnloadListener = function(){
        window.onbeforeunload = function (evt) {
            var message = getL10n("utils-close-page-warning");
            if (typeof evt == "undefined") {
                evt = window.event;
            }
            if (evt) {
                evt.returnValue = message;
            }
            return message;
        };
    }
    

})(this['PageManager']={});
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 */

"use strict";

(function(exports, mode){

    var state = {};
    
    state.summary = {};
    
    if(mode === "NIMS_Server" && PERMISSION_INFORMER_ENABLED){
        exports.refresh = function(callback) {
            var request = $.ajax({
                url : "/getPermissionsSummary",
                dataType : "text",
                method : "GET",
                contentType : "application/json;charset=utf-8",
                timeout: Constants.httpTimeout
            });
            
            request.done(function(data) {
                state.summary = JSON.parse(data);
                if(callback){
                    callback();
                } else {
                    exports.subscribe();
                }
    //        alert(data);
    //        alert(state.summary);
            });
            
            request.fail(function(errorInfo, textStatus, errorThrown) {
                if(callback){
                    callback(errorInfo.responseText || 'error');
                } else {
                    setTimeout(exports.subscribe, 500);
                }
            });
        };
        
        exports.subscribe = function() {
            
            var request = $.ajax({
                url : "/subscribeOnPermissionsUpdate",
                dataType : "text",
                method : "GET",
                contentType : "application/json;charset=utf-8",
                timeout: Constants.httpTimeout
            });
            
            request.done(function(data) {
                state.summary = JSON.parse(data);
    //        alert(data);
    //        alert(state.summary);
                exports.subscribe();
            });
            
            request.fail(function(errorInfo, textStatus, errorThrown) {
                setTimeout(exports.subscribe, 500);
            });
        };
        
        exports.refresh();
    
        exports.isAdmin = function(callback){
            callback(null, state.summary.isAdmin);
        };
        
        exports.isEditor = function(callback){
            callback(null, state.summary.isEditor);
        };
        
        exports.isEntityEditable = function(type, entityName, callback) {
            callback(null, isObjectEditableSync(type, entityName));
        };
        
        var isObjectEditableSync = function(type, name){
            if(state.summary.isEditor){
                return true;
            }
            if(state.summary.existEditor){
                return false;
            }
            return state.summary.user[type].indexOf(name) !== -1;
        };
        
        exports.getEntityNamesArray = R.curry(function(type, editableOnly, callback){
            var userEntities = state.summary.user[type];
            var allEntities = state.summary.all[type];
            var ownerMap = state.summary.ownerMaps[type];
            var names = allEntities.filter(function(name){
                if(editableOnly){
                    return isObjectEditableSync(type, name);
                } else {
                    return true;
                }
            }).map(function(name){
                return {
                    displayName : ownerMap[name] + ". " + name,
                    value : name,
                    editable : isObjectEditableSync(type, name),
                    isOwner : userEntities.indexOf(name) !== -1
                };
            });
            
            names.sort(Utils.charOrdAObject);
            
            callback(null, names);
        });
        
        exports.areAdaptationsEditable = function(adaptations, callback){
            var map = {};
            var isAdaptationRightsByStory = state.summary.isAdaptationRightsByStory;
            
            adaptations.forEach(function(elem){
                var key = elem.storyName + "-" + elem.characterName;
                if(isAdaptationRightsByStory){
                    map[key] = isObjectEditableSync('story', elem.storyName);
                } else {
                    map[key] = isObjectEditableSync('character', elem.characterName);
                }
            });
            
            callback(null, map);
        };
        
    } else if (mode === "Standalone"){
        
        exports.refresh = function(callback) {
            callback();
        };
        
        exports.isAdmin = function(callback){
            callback(null, true);
        };
        
        exports.isEditor = function(callback){
            callback(null, true);
        };
        
        exports.getEntityNamesArray = R.curry(function(type, editableOnly, callback){
            function processNames(err, names){
                if(err) {Utils.handleError(err); return;}
                var newNames = [];
                names.forEach(function(name){
                    newNames.push({
                        displayName:name,
                        value:name,
                        editable: true
                    });
                });
                callback(null, newNames);
            }
            DBMS.getEntityNamesArray(type, processNames);
        });
        
        exports.isEntityEditable = function(type, entityName, callback) {
            callback(null, true);
        };
        
        exports.areAdaptationsEditable = function(adaptations, callback){
            var map = {};
            adaptations.forEach(function(elem){
                map[elem.storyName + "-" + elem.characterName] = true;
            });
            
            callback(null, map);
        };
    }

})(this['PermissionInformer']={}, MODE);
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

"use strict";

(function(exports){

    exports.initTabPanel = function(tabClazz, containerClazz) {
        var containers = getEls(containerClazz);
    
        var i;
        for (i = 1; i < containers.length; i++) { // don't hide 1st element
            addClass(containers[i], "hidden");
        }
    
        var tabButtons = getEls(tabClazz);
    
        addClass(tabButtons[0], "active");
    
        for (i = 0; i < tabButtons.length; i++) {
            listen(tabButtons[i], "click", tabButtonClick(tabButtons, containers));
        }
    };
    
    var tabButtonClick = function(buttons, containers) {
        return function(event) {
            for (var i = 0; i < buttons.length; i++) {
                setClassByCondition(buttons[i], "active", event.target.id === buttons[i].id);
            }
            for (var i = 0; i < containers.length; i++) {
                setClassByCondition(containers[i], "hidden", event.target.id + "Container" !== containers[i].id);
            }
        };
    };
    
    exports.fillShowItemSelector = function (selector, displayArray) {
        var el;
        setAttr(selector, "size", displayArray.length);
        displayArray.forEach(function(value) {
            el = setProps(makeEl("option"), {
                "selected" : true,
            });
            setClassByCondition(el, 'hidden', value.hidden);
            addEl(selector, addEl(el, makeText(value.name)));
        });
    };
    
    exports.fillShowItemSelector2 = function (selector, optionGroups) {
        var el, groupEl, counter = 0;
        addEls(selector, optionGroups.map(function(group) {
            counter++;
            groupEl = setAttr(makeEl("optgroup"), 'label', group.name);
            addEls(groupEl, group.array.map((value) => {
                el = setProps(makeEl("option"), {
                    "selected" : true,
                });
                setClassByCondition(el, 'hidden', value.hidden);
                counter += (value.hidden ? 0 : 1);
                return addEl(el, makeText(value.name));
            }));
            return groupEl;
        }));
        setAttr(selector, "size", counter);
    };
    
    exports.showSelectedEls = function(classKey){
        return function(event){
            var el = event.target;
            var els, i, j;
            for (i = 0; i < el.options.length; i += 1) {
                if(hasClass(el.options[i], 'hidden')){
                    continue;
                }
                els = getEls(i + classKey);
                for (j = 0; j < els.length; j++) {
                    setClassByCondition(els[j], "hidden", !el.options[i].selected);
                }
            }
        }
    };
    
    exports.initSelectorFilters = function(){
        var elems = document.querySelectorAll("[selector-filter]");
        var el, sel;
        for (var i = 0; i < elems.length; i++) {
            el = elems[i];
            sel = queryEl(getAttr(el,"selector-filter"));
            listen(el, "input", filterOptions(sel))
        }
    };
    
    var filterOptions = function(sel){
        return function(event){
            var val = event.target.value;
            var i, opt;
            val = CommonUtils.globStringToRegex(val.trim().toLowerCase());
            for (i = 0; i < sel.options.length; i += 1) {
                opt = sel.options[i];
                setClassByCondition(opt, "hidden", opt.innerHTML.toLowerCase().search(val) === -1);
            }
        }
    };
    
    exports.initPanelTogglers = function(){
        var elems = document.querySelectorAll("[panel-toggler]");
        var el, sel, attr;
        for (var i = 0; i < elems.length; i++) {
            el = elems[i];
            attr = getAttr(el,"panel-toggler");
            sel = document.querySelector(attr);
            if(sel == null){
                Utils.alert("Panel toggler is broken: " + attr);
            }
            listen(el, "click", exports.togglePanel(sel))
        }
    };
    
    exports.togglePanel = function(sel){
        return function(event){
            toggleClass(sel, "hidden");
        }
    };
    
    exports.makeEventTimePicker = function (opts) {
        var input = makeEl("input");
        R.ap([addClass(input)], opts.extraClasses);
        addClass(input, "eventTime");
        input.value = opts.eventTime;
        
        input.eventIndex = opts.index;
        
        var pickerOpts = {
            lang : L10n.getLang(),
            mask : true,
            startDate : new Date(opts.preGameDate),
            endDate : new Date(opts.date),
            onChangeDateTime : opts.onChangeDateTimeCreator(input),
        };
        
        if (opts.eventTime !== "") {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, "defaultDate");
        }
        
        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };
    
    exports.resizeTextarea = function (ev) {
        var that = ev.target;
        that.style.height = '24px';
        that.style.height = that.scrollHeight + 12 + 'px';
    };
    
    exports.resizeTextarea2 = function (that) {
        that.style.height = '24px';
        that.style.height = that.scrollHeight + 12 + 'px';
    };
    
    exports.makeAdaptationTimeInput = function(storyName, event, characterName, isEditable){
        var input = makeEl("input");
        setClassByCondition(input, "notEditable", !isEditable);
        addClass(input,"adaptationTimeInput");
        input.value = event.characters[characterName].time;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        listen(input, "change", onChangePersonalTimeDelegate);
        return input;
    };
    
    var onChangePersonalTimeDelegate = function (event) {
        var dataKey = JSON.parse(event.target.dataKey);
        var time = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'time', time, Utils.processError());
    };
    
    exports.makeAdaptationReadyInput = function(storyName, event, characterName, isEditable){
        var div = makeEl("div");
        var input = makeEl("input");
        setClassByCondition(input, "notEditable", !isEditable);
        input.type = "checkbox";
        input.checked = event.characters[characterName].ready;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        input.id = event.index + "-" + storyName + "-" + characterName;
        listen(input, "change", onChangeReadyStatus);
        addEl(div, input);
        
        addEl(div, setAttr(addEl(makeEl("label"), makeText(constL10n(Constants.finishedText))), "for", input.id));
        return div;
    };
    
    var onChangeReadyStatus = function (event) {
        var dataKey = JSON.parse(event.target.dataKey);
        var value = event.target.checked;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'ready', value, Utils.processError());
    };
    
    exports.makePanelCore = function(title, content){
        var panel = addClasses(makeEl('div'), ["panel", "panel-default"]);
        var h3 = addClass(addEl(makeEl('h3'), title), "panel-title");
        var a = setAttr(makeEl('a'),'href','#/');
        var headDiv = addClass(makeEl('div'), "panel-heading");
        addEl(panel, addEl(headDiv, addEl(a, h3)));
        var contentDiv = addClass(makeEl('div'), "panel-body");
        addEl(panel, addEl(contentDiv, content));
        return {
            panel: panel,
            contentDiv: contentDiv,
            a: a
        };
    };

})(this['UI']={});
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

"use strict";

var Utils = {};

/** opts
 *      tooltip - add tooltip to button, used for iconic buttons
 *      id - set button id
 *      mainPage - enable view as first page
 *      toggle - toggle content, associated with button
 */
Utils.addView = function (containers, name, view, opts) {
    "use strict";
    var opts = opts || {};
    view.init();
    var buttonClass = "navigation-button";
    containers.root.views[name] = view;
    var button = makeEl("button");
    if(opts.tooltip){
        var delegate = function(){
            $(button).attr('data-original-title', L10n.getValue("header-" + name));
        };
        L10n.onL10nChange(delegate);
        $(button).tooltip({
            title : L10n.getValue("header-" + name),
            placement : "bottom"
        });
    } else {
        addEl(button, makeText(L10n.getValue("header-" + name)));
        setAttr(button, "l10n-id", "header-" + name);
    }
    addClass(button, buttonClass);
    addClass(button, "-test-" + name);
    addClass(button, "-toggle-class-" + name);
    if(opts.id){
        button.id = opts.id;
    }
    containers.navigation.appendChild(button);
    

    var elems, i;
    var onClickDelegate = function (view) {
        return function (evt) {
            //Tests.run();
            elems = containers.navigation.getElementsByClassName(buttonClass);
            if(opts.toggle){
                var els = getEls("-toggle-class-" + name);
                for (var i = 0; i < els.length; i++) {
                    if(evt.target.isEqualNode(els[i])){
                        continue;
                    }
                    if(hasClass(els[i], "active")){
                        els[i].click();
                    }
                }
            }
            
            var isActive = hasClass(evt.target, "active");
            for (i = 0; i < elems.length; i++) {
                removeClass(elems[i], "active");
            }
            if(!opts.toggle || (opts.toggle && !isActive)){
                addClass(evt.target, "active");
                
                passEls(containers.content, getEl('warehouse'));
                containers.content.appendChild(view.content);
                removeClass(containers.content, "hidden");
                containers.root.currentView = view;
                view.refresh();
            } else {
                removeClass(evt.target, "active");
                passEls(containers.content, getEl('warehouse'));
                containers.root.currentView = null;
                addClass(containers.content, "hidden");
            }
        };
    };

    button.addEventListener("click", onClickDelegate(view));
    if (opts.mainPage) {
        addClass(button, "active");
        containers.content.appendChild(view.content);
        containers.root.currentView = view;
    }
};

Utils.alert = function (message) {
    vex.dialog.alert(message);
};

Utils.confirm = function (message, onOk, onCancel) {
    vex.dialog.confirm({
        message: message,
        callback: (val) => {
            if(val){
                if(onOk) onOk();
            } else {
                if(onCancel) onCancel();
            }
        }
    });
};

Utils.removeChildren = function (myNode) {
    "use strict";
    if (!myNode) {
        return;
    }
    while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
    }
};

Utils.processError = function(callback){
    return function(err){
        if(err) {
            Utils.handleError(err);
            return;
        }
        
        if(callback){
            var arr = [];
            for (var i = 1; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            callback.apply(null, arr);
        }
    }
};

Utils.handleErrorMsg = function(err){
    var checkErrorType = R.curry(function(err, name){
        return err instanceof Errors[name] || (err.name && err.name === name)
    });
    if (R.keys(Errors).some(checkErrorType(err))) {
        return strFormat(getL10n(err.messageId), err.parameters);
    } else if( typeof err === 'object'){
        return err.message;
    } else {
        return err;
    }
};

Utils.handleError = (err) => Utils.alert(Utils.handleErrorMsg(err));

Utils.enableEl = R.curry(function(el, condition){
    var key = el.tagName.toLowerCase() === "textarea" ? "readonly" : "disabled";
    if(condition){
        el.removeAttribute(key);
    } else {
        el.setAttribute(key,key);
    }
});

Utils.enable = function(root, className, condition){
    nl2array(root.getElementsByClassName(className)).map(Utils.enableEl(R.__, condition));
};

Utils.charOrdAObject = CommonUtils.charOrdAFactory(function(a){
    return a.displayName.toLowerCase();
});

Utils.rebuildSelector = function(selector, names){
    "use strict";
    clearEl(selector);
    names.forEach(function (nameInfo) {
        var option = makeEl("option");
        option.appendChild(makeText(nameInfo.displayName));
        option.value = nameInfo.value;
        selector.appendChild(option);
    });
};

Utils.rebuildSelectorArr = function(selector, names){
    "use strict";
    clearEl(selector);
    names.forEach(function (name) {
        var option = makeEl("option");
        option.appendChild(makeText(name));
        selector.appendChild(option);
    });
};

String.prototype.endsWith = function (suffix) {
    "use strict";
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

var strFormat = R.curry(CommonUtils.strFormat);

function getL10n(key){
    return L10n.getValue(key);
};

function constL10n(key){
    return L10n.getValue('constant-' + key);
}

function isEmpty (obj) {
    "use strict";
    return (Object.getOwnPropertyNames(obj).length === 0);
};

var addClass = R.curry(function(o, c){
    var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g")
    if (re.test(o.className)) return;
    o.className = (o.className + " " + c).replace(/\s+/g, " ").replace(/(^ | $)/g, "");
    return o;
});

var addClasses = R.curry(function(o, c){
    R.ap([addClass(o)], c);
    return o;
});

var rAddClass = R.curry(function(c, o){
  var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g")
  if (re.test(o.className)) return;
  o.className = (o.className + " " + c).replace(/\s+/g, " ").replace(/(^ | $)/g, "");
  return o;
});

function toggleClass(o, c){
    if(hasClass(o, c)){
        removeClass(o, c);
    } else {
        addClass(o, c);
    }
};

function hasClass(o, c){
    var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g")
    return (re.test(o.className));
};
 
var removeClass = R.curry(function(o, c){
    var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g")
    o.className = o.className.replace(re, "$1").replace(/\s+/g, " ").replace(/(^ | $)/g, "")
});

function setClassByCondition(o,c,condition){
    if(condition){
        addClass(o,c);
    } else {
        removeClass(o,c);
    }
    return o;
};

function getEl(id){
  return document.getElementById(id);
};

function queryEl(sel){
    return document.querySelector(sel);
};

function queryEls(sel){
    return nl2array(document.querySelectorAll(sel));
};

function queryElEls(el, sel){
    return nl2array(el.querySelectorAll(sel));
};

function getEls(clazz){
  return document.getElementsByClassName(clazz);
};

function makeEl(elTag){
  return document.createElement(elTag);
};

function makeText(text){
  return document.createTextNode(text);
};

var addEl = R.curry(function(parent, child){
    parent.appendChild(child);
    return parent;
});
var addEls = R.curry(function(parent, children){
    R.ap([addEl(parent)], children);
    return parent;
});

var makeOpt = function(label){
    var option = makeEl("option");
    addEl(option, (makeText(label)));
    return option;
};

var rAddEl = R.curry(function(child, parent){
  parent.appendChild(child);
  return parent;
});

var setAttr = R.curry(function(el, name, value){
  el.setAttribute(name, value);
  return el;
});

var setStyle = R.curry(function(el, name, value){
    el.style[name] = value;
    return el;
});

function delAttr(el, name){
    el.removeAttribute(name);
    return el;
};

function getAttr(el, name){
    return el.getAttribute(name);
};

var setProp = R.curry(function(el, key, value){
  el[key] = value;
  return el;
});

var setProps = R.curry(function(el, map){
  for(var key in map){
    setProp(el, key, map[key]);
  }
  return el;
});

function clearEl(el){
  Utils.removeChildren(el);
  return el;
};

function passEls(src, dst){
    for (var i = 0; i < src.children.length; i++) {
        addEl(dst, src.children[i]);
    }
};

var listen = R.curry(function(el, event, listener){
  el.addEventListener(event, listener);
  return el;
});

var listenOnEnter = R.curry(function(el, callback){
    listen(el, 'keydown', function(e) {
        if (e.keyCode === 13) {
            callback();
        }
    });
});

var fillSelector = R.curry(function(sel, data){
    return addEls(sel, data.map(function (item) {
        var opt = makeEl("option");
        addEl(opt, makeText(item.name));
        if(item.value){opt.value = item.value;}
        if(item.selected){opt.selected = true;}
        if(item.className){addClass(opt, item.className);}
        return opt;
    }));
});

function nl2array(nodeList){
    return Array.prototype.slice.call(nodeList);
};

var remapProps = R.curry(function(outKeys, pickKeys, obj){
    return R.compose(R.zipObj(outKeys), R.values, R.pick(pickKeys))(obj);
});

var remapProps4Select2 = remapProps(['id','text'], ['value', 'displayName']);
var remapProps4Select = remapProps(['value','name'], ['value', 'displayName']);

var getSelect2DataCommon = R.curry(function(preparator, obj){ 
    return R.compose(R.zipObj(['data']), R.append(R.__, []), R.map(preparator))(obj);
});

var getSelect2Data = getSelect2DataCommon(remapProps4Select2);

var makeSelect2Opt = R.compose(R.zipObj(['id', 'text']), R.repeat(R.__, 2));
var arr2Select2 = R.compose(R.assoc('data', R.__, {}), R.map(makeSelect2Opt));
var arr2Select = R.map(R.compose(R.zipObj(['value','name']), R.repeat(R.__, 2)));
var constArr2Select = R.map(R.compose(R.zipObj(['value','name']), (name) => [name, constL10n(name)]));

var getSelectedRadio = function(query){
    var els = document.querySelectorAll(query);
    for (var i = 0; i < els.length; i++) {
        if(els[i].checked === true){
            return els[i];
        }
    }
    return null;
};

var debugInterceptor = function(callback){
    return function(){
        console.log(JSON.stringify(arguments[0]));
        callback.apply(null, arguments);
    }
};

// from date format utils
//For convenience...
Date.prototype.format = function (mask, utc) {
    return dateFormat(this, mask, utc);
};


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2RibXMvbG9jYWxEQk1TLmpzIiwianMvZGJtcy9yZW1vdGVEQk1TLmpzIiwianMvZmlsZVV0aWxzLmpzIiwianMvbDEwbi5qcyIsImpzL3BhZ2VNYW5hZ2VyLmpzIiwianMvcGVybWlzc2lvbkluZm9ybWVyLmpzIiwianMvdWlVdGlscy5qcyIsImpzL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6SUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoT0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzY3JpcHRzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgRGF0YWJhc2UsIE1pZ3JhdG9yXHJcbiAqL1xyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbmZ1bmN0aW9uIG1ha2VMb2NhbERCTVMoZnVsbFZlcnNpb24pe1xyXG4vLyAgICBpZighZnVsbFZlcnNpb24pe1xyXG4vLyAgICAgICAgZnVuY3Rpb24gTG9jYWxEQk1TKCl7XHJcbi8vICAgICAgICB9O1xyXG4vLyAgICAgICAgcmV0dXJuIExvY2FsREJNUztcclxuLy8gICAgfVxyXG4gICAgXHJcbiAgICB2YXIgb3B0cyA9IHtcclxuICAgICAgICBNaWdyYXRvciAgICAgOiBNaWdyYXRvciAgICAsXHJcbiAgICAgICAgQ29tbW9uVXRpbHMgIDogQ29tbW9uVXRpbHMgLFxyXG4gICAgICAgIEV2ZW50RW1pdHRlciA6IEV2ZW50RW1pdHRlcixcclxuICAgICAgICBSICAgICAgICAgICAgOiBSICAgICAgICAgICAsXHJcbiAgICAgICAgQWp2ICAgICAgICAgIDogQWp2ICAgICAgICAgLFxyXG4gICAgICAgIFNjaGVtYSAgICAgICA6IFNjaGVtYSAgICAgICxcclxuICAgICAgICBFcnJvcnMgICAgICAgOiBFcnJvcnMgICAgICAsXHJcbiAgICAgICAgbGlzdGVuZXJzICAgIDoge30gICAgICAgICAgLFxyXG4gICAgICAgIENvbnN0YW50cyAgICA6IENvbnN0YW50cyAgICxcclxuICAgICAgICBkYm1zVXRpbHMgICAgOiB7fSAgICAgICAgICAsXHJcbiAgICAgICAgZGF0ZUZvcm1hdCAgIDogZGF0ZUZvcm1hdCAgLFxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZnVuY3Rpb24gTG9jYWxEQk1TKCl7XHJcbiAgICAgICAgdGhpcy5faW5pdChvcHRzLmxpc3RlbmVycyk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBMb2NhbERCTVMucHJvdG90eXBlLmdldFNldHRpbmdzID0gZnVuY3Rpb24oKXtcclxuICAgICAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhYmFzZS5TZXR0aW5ncztcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBmdW5jID0gKG5hbWUpID0+IHdpbmRvd1tuYW1lXShMb2NhbERCTVMsIG9wdHMpO1xyXG4gICAgXHJcbiAgICBbXCJiYXNlQVBJXCIgICAgICAgICAgICAgICAsXHJcbiAgICBcImNvbnNpc3RlbmN5Q2hlY2tBUElcIiAgICxcclxuICAgIFwic3RhdGlzdGljc0FQSVwiICAgICAgICAgLFxyXG4gICAgXCJwcm9maWxlc0FQSVwiICAgICAgICAgICAsXHJcbiAgICBcInByb2ZpbGVCaW5kaW5nQVBJXCIgICAgICxcclxuICAgIFxyXG4gICAgXCJncm91cHNBUElcIiAgICAgICAgICAgICAsXHJcbiAgICBcImdyb3VwU2NoZW1hQVBJXCIgICAgICAgICxcclxuICAgIFwiaW52ZXN0aWdhdGlvbkJvYXJkQVBJXCIgLFxyXG4gICAgXCJyZWxhdGlvbnNBUElcIiAgICAgICAgICAsXHJcbiAgICBcImJyaWVmaW5nRXhwb3J0QVBJXCIgICAgICxcclxuICAgIFxyXG4gICAgXCJwcm9maWxlQ29uZmlndXJlckFQSVwiICAsXHJcbiAgICBcImVudGl0eUFQSVwiICAgICAgICAgICAgICxcclxuICAgIFwic3RvcnlCYXNlQVBJXCIgICAgICAgICAgLFxyXG4gICAgXCJzdG9yeUV2ZW50c0FQSVwiICAgICAgICAsXHJcbiAgICBcInN0b3J5Q2hhcmFjdGVyc0FQSVwiICAgICxcclxuICAgIFxyXG4gICAgXCJzdG9yeVZpZXdBUElcIiAgICAgICAgICAsXHJcbiAgICBcInN0b3J5QWRhcHRhdGlvbnNBUElcIiAgICxcclxuICAgIFwiYWNjZXNzTWFuYWdlckFQSVwiICAgICAgLFxyXG4gICAgXCJ0ZXh0U2VhcmNoQVBJXCIgICAgICAgICAsXHJcbiAgICBcImxvZ0FQSVwiXS5tYXAoZnVuYyk7XHJcbiAgICBcclxuICAgIExvZ2dlci5hdHRhY2hMb2dDYWxscyhMb2NhbERCTVMsIFIsIGZhbHNlKTtcclxuICAgIHJldHVybiBMb2NhbERCTVM7XHJcbn07XHJcblxyXG5cclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEYXRhYmFzZVxyXG4gKi9cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG52YXIgc2hvd05vdGlmaWNhdGlvbiA9IHRydWU7XHJcbmZ1bmN0aW9uIG1ha2VSZW1vdGVEQk1TKExvY2FsREJNUyl7XHJcbiAgICBcclxuICAgIHZhciB1cmwgPSBcIi9cIjtcclxuICAgIFxyXG4gICAgZnVuY3Rpb24gUmVtb3RlREJNUygpe1xyXG4gICAgICAgIHRoaXMuY2xlYXJTZXR0aW5ncygpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgUmVtb3RlREJNUy5fc2ltcGxlR2V0ID0gZnVuY3Rpb24obmFtZSwgcGFyYW1zLCBjYWxsYmFjayl7XHJcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICAgICAgdmFyIHBhcmFtU3RyID0gXCJcIjtcclxuICAgICAgICBpZihwYXJhbXMpe1xyXG4gICAgICAgICAgICBwYXJhbVN0ciA9IFwiP3BhcmFtcz1cIiArIGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeShwYXJhbXMpKTsgOyBcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmwgOiB1cmwgKyBuYW1lICsgcGFyYW1TdHIsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlIDogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgIG1ldGhvZCA6IFwiR0VUXCIsXHJcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlIDogXCJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLThcIixcclxuICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICB0aW1lb3V0OiBDb25zdGFudHMuaHR0cFRpbWVvdXQsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgSlNPTi5wYXJzZShkYXRhKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKGZ1bmN0aW9uKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKEpTT04ucGFyc2UoZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoKGVycil7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8IHRleHRTdGF0dXMgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIFJlbW90ZURCTVMuX3NpbXBsZVB1dCA9IGZ1bmN0aW9uKG5hbWUsIGRhdGEsIGNhbGxiYWNrKXtcclxuICAgICAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybCA6IHVybCArIG5hbWUsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlIDogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgIG1ldGhvZCA6IFwiUFVUXCIsXHJcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlIDogXCJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLThcIixcclxuICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSksXHJcbiAgICAgICAgICAgIHRpbWVvdXQ6IENvbnN0YW50cy5odHRwVGltZW91dFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKHNob3dOb3RpZmljYXRpb24pe1xyXG4gICAgICAgICAgICB2YXIgbm90aWZpY2F0aW9uQm94ID0gY2xlYXJFbChnZXRFbCgnZGVidWdOb3RpZmljYXRpb24nKSk7XHJcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKG5vdGlmaWNhdGlvbkJveCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICByZW1vdmVDbGFzcyhub3RpZmljYXRpb25Cb3gsICdvcGVyYXRpb25PSycpO1xyXG4gICAgICAgICAgICByZW1vdmVDbGFzcyhub3RpZmljYXRpb25Cb3gsICdvcGVyYXRpb25GYWlsJyk7XHJcbiAgICAgICAgICAgIGFkZEVsKG5vdGlmaWNhdGlvbkJveCwgbWFrZVRleHQobmFtZSArICcgJyArIEpTT04uc3RyaW5naWZ5KGRhdGEpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJlcXVlc3QuZG9uZShmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgIGlmKHNob3dOb3RpZmljYXRpb24pe1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3Mobm90aWZpY2F0aW9uQm94LCAnb3BlcmF0aW9uT0snKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhub3RpZmljYXRpb25Cb3gsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgIH0sIDIwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJlcXVlc3QuZmFpbChmdW5jdGlvbihlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIGlmKHNob3dOb3RpZmljYXRpb24pe1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3Mobm90aWZpY2F0aW9uQm94LCAnb3BlcmF0aW9uRmFpbCcpO1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKG5vdGlmaWNhdGlvbkJveCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgfSwgMjAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKEpTT04ucGFyc2UoZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoKGVycil7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8IHRleHRTdGF0dXMgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIFxyXG4gICAgT2JqZWN0LmtleXMoTG9jYWxEQk1TLnByb3RvdHlwZSkuZm9yRWFjaChmdW5jdGlvbihuYW1lKXtcclxuICAgICAgICBSZW1vdGVEQk1TLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHZhciBhcnIgPSBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoLTE7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgYXJyLnB1c2goYXJndW1lbnRzW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgIGlmKENvbW1vblV0aWxzLnN0YXJ0c1dpdGgobmFtZSwgXCJfXCIpKXtcclxuLy8gICAgICAgICAgICAgICAgLy8gZG8gbm90aGluZyBmb3IgaW5uZXIgZnVuY3Rpb25zXHJcbi8vICAgICAgICAgICAgfSBlbHNlIFxyXG4gICAgICAgICAgICBpZihDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsIFwiZ2V0XCIpIHx8IENvbW1vblV0aWxzLnN0YXJ0c1dpdGgobmFtZSwgXCJpc1wiKSl7XHJcbiAgICAgICAgICAgICAgICBSZW1vdGVEQk1TLl9zaW1wbGVHZXQobmFtZSwgYXJyLCBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aC0xXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBSZW1vdGVEQk1TLl9zaW1wbGVQdXQobmFtZSwgYXJyLCBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aC0xXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgXHJcbiAgICBSZW1vdGVEQk1TLnByb3RvdHlwZS5jbGVhclNldHRpbmdzID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICAgICAgdGhpcy5TZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgICAgIFwiQnJpZWZpbmdQcmV2aWV3XCIgOiB7fSxcclxuICAgICAgICAgICAgICAgIFwiU3Rvcmllc1wiIDoge30sXHJcbiAgICAgICAgICAgICAgICBcIlByb2ZpbGVFZGl0b3JcIiA6IHt9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIFJlbW90ZURCTVMucHJvdG90eXBlLmdldFNldHRpbmdzID0gZnVuY3Rpb24oKXtcclxuICAgICAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgICAgICByZXR1cm4gdGhpcy5TZXR0aW5ncztcclxuICAgIH07XHJcbiAgICByZXR1cm4gUmVtb3RlREJNUztcclxufTtcclxuXHJcblxyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIHNhdmVBcywgRmlsZVJlYWRlciwgQmxvYlxyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxudmFyIEZpbGVVdGlscyA9IHt9O1xyXG5cclxuRmlsZVV0aWxzLmluaXQgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgRmlsZVV0aWxzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbn07XHJcblxyXG5GaWxlVXRpbHMubWFrZU5ld0Jhc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIFV0aWxzLmNvbmZpcm0oZ2V0TDEwbihcInV0aWxzLW5ldy1iYXNlLXdhcm5pbmdcIiksICgpID0+IHtcclxuICAgICAgICBEQk1TLnNldERhdGFiYXNlKENvbW1vblV0aWxzLmNsb25lKEVtcHR5QmFzZS5kYXRhKSwgRmlsZVV0aWxzLmNhbGxiYWNrKTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuRmlsZVV0aWxzLm9wZW5IZWxwID0gZnVuY3Rpb24gKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICB3aW5kb3cub3BlbihcImV4dHJhcy9kb2Mvbmltcy5odG1sXCIpO1xyXG59O1xyXG5cclxuRmlsZVV0aWxzLnJlYWRTaW5nbGVGaWxlID0gZnVuY3Rpb24gKGV2dCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICAvLyBSZXRyaWV2ZSB0aGUgZmlyc3QgKGFuZCBvbmx5ISkgRmlsZSBmcm9tIHRoZSBGaWxlTGlzdCBvYmplY3RcclxuICAgIHZhciBmID0gZXZ0LnRhcmdldC5maWxlc1swXTtcclxuXHJcbiAgICBpZiAoZikge1xyXG4gICAgICAgIHZhciByID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgICByLm9ubG9hZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIHZhciBjb250ZW50cyA9IGUudGFyZ2V0LnJlc3VsdDtcclxuICAgICAgICAgICAgdmFyIGRhdGFiYXNlID0gSlNPTi5wYXJzZShjb250ZW50cyk7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RGF0YWJhc2UoZGF0YWJhc2UsIEZpbGVVdGlscy5jYWxsYmFjayk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICByLnJlYWRBc1RleHQoZik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oXCJ1dGlscy1iYXNlLWZpbGUtbG9hZGluZy1lcnJvclwiKSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5GaWxlVXRpbHMuc2F2ZUZpbGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIERCTVMuZ2V0RGF0YWJhc2UoZnVuY3Rpb24oZXJyLCBkYXRhYmFzZSl7XHJcbiAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICBGaWxlVXRpbHMuanNvbjJGaWxlKGRhdGFiYXNlLCBcIm5pbXMtYmFzZS5qc29uXCIpO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5GaWxlVXRpbHMuanNvbjJGaWxlID0gZnVuY3Rpb24gKHN0ciwgZmlsZU5hbWUpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgRmlsZVV0aWxzLnN0cjJGaWxlKEpTT04uc3RyaW5naWZ5KHN0ciwgbnVsbCwgJyAgJyksIGZpbGVOYW1lKTtcclxufTtcclxuXHJcbkZpbGVVdGlscy5zdHIyRmlsZSA9IGZ1bmN0aW9uIChzdHIsIGZpbGVOYW1lKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIHZhciBibG9iID0gbmV3IEJsb2IoWyBzdHIgXSwge1xyXG4gICAgICAgIHR5cGUgOiBcInRleHQvcGxhaW47Y2hhcnNldD11dGYtOFwiXHJcbiAgICB9KTtcclxuICAgIHNhdmVBcyhibG9iLCBmaWxlTmFtZSk7XHJcbn07XHJcblxyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMsIERpY3Rpb25hcmllcyl7XHJcblxyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICBcclxuICAgIHN0YXRlLmluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzID0gW107XHJcbiAgICBzdGF0ZS5kaWN0aW9uYXJpZXMgPSB7fTtcclxuICAgIHN0YXRlLmxhbmcgPSBkZWZhdWx0TGFuZztcclxuICAgIFxyXG4gICAgdmFyIGluaXQgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIGlmKHN0YXRlLmluaXRpYWxpemVkKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuLy8gICAgICAgIGNvbnNvbGUubG9nKG5hdmlnYXRvci5sYW5ndWFnZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZm9yKHZhciBuYW1lIGluIERpY3Rpb25hcmllcyl7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3Rpb25hcmllc1tuYW1lXSA9IHByb2Nlc3NEaWN0aW9uYXJ5KERpY3Rpb25hcmllc1tuYW1lXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgLy8gICAgdmFyIGxhbmcgPSAobmF2aWdhdG9yLmxhbmd1YWdlcyA/IG5hdmlnYXRvci5sYW5ndWFnZXNbMF0gOiBuYXZpZ2F0b3IuYnJvd3Nlckxhbmd1YWdlKS5zcGxpdCgnLScpWzBdO1xyXG4gICAgLy8gICAgdmFyIGxhbmcgPSAncnUnO1xyXG4vLyAgICAgICAgdmFyIGxhbmcgPSBkZWZhdWx0TGFuZztcclxuLy8gICAgICAgIGNvbnNvbGUubG9nKGxhbmcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKHN0YXRlLmRpY3Rpb25hcmllc1tkZWZhdWx0TGFuZ10pe1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzW2RlZmF1bHRMYW5nXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzWydlbiddO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZXRIdG1sTGFuZyhkZWZhdWx0TGFuZyk7XHJcbiAgICAgICAgZXhwb3J0cy5vbkwxMG5DaGFuZ2UoZXhwb3J0cy5sb2NhbGl6ZVN0YXRpYyk7XHJcbiAgICAgICAgc3RhdGUuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHByb2Nlc3NEaWN0aW9uYXJ5ID0gZnVuY3Rpb24oZGljdGlvbmFyeSl7XHJcbiAgICAgICAgdmFyIHByb2Nlc3NlZERpY3Rpb25hcnkgPSB7fTtcclxuICAgICAgICBmb3IodmFyIHNlY3Rpb25OYW1lIGluIGRpY3Rpb25hcnkpe1xyXG4gICAgICAgICAgICBmb3IodmFyIG5hbWUgaW4gZGljdGlvbmFyeVtzZWN0aW9uTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2VkRGljdGlvbmFyeVtzZWN0aW9uTmFtZStcIi1cIituYW1lXSA9IGRpY3Rpb25hcnlbc2VjdGlvbk5hbWVdW25hbWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBcclxuICAgICAgICByZXR1cm4gcHJvY2Vzc2VkRGljdGlvbmFyeTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBzZXRIdG1sTGFuZyA9IChsYW5nKSA9PiBzZXRBdHRyKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaHRtbFwiKVswXSwnbGFuZycsIGxhbmcpO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnRvZ2dsZUwxMG4gPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIGlmKHN0YXRlLmxhbmcgPT09IFwicnVcIil7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXNbJ2VuJ107XHJcbiAgICAgICAgICAgIHN0YXRlLmxhbmcgPSBcImVuXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3RhdGUuZGljdCA9IHN0YXRlLmRpY3Rpb25hcmllc1sncnUnXTtcclxuICAgICAgICAgICAgc3RhdGUubGFuZyA9IFwicnVcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2V0SHRtbExhbmcoc3RhdGUubGFuZyk7XHJcbiAgICAgICAgc3RhdGUubDEwbkRlbGVnYXRlcy5mb3JFYWNoKGZ1bmN0aW9uKGRlbGVnYXRlKXtcclxuICAgICAgICAgICAgZGVsZWdhdGUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMuZ2V0TGFuZyA9ICgpID0+IHN0YXRlLmxhbmcudG9Mb3dlckNhc2UoKTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5nZXRWYWx1ZSA9IGZ1bmN0aW9uKG5hbWUpe1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IHN0YXRlLmRpY3RbbmFtZV07XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlID8gdmFsdWUgOiBuYW1lICsgXCI6UkEgUkEtQUgtQUgtQUggUk9NQSBST01BLU1BIEdBR0EgT0ggTEEtTEFcIjtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMub25MMTBuQ2hhbmdlID0gZnVuY3Rpb24oZGVsZWdhdGUpe1xyXG4gICAgICAgIHN0YXRlLmwxMG5EZWxlZ2F0ZXMucHVzaChkZWxlZ2F0ZSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmxvY2FsaXplU3RhdGljID0gZnVuY3Rpb24oKXtcclxuICAgICAgICBpbml0KCk7XHJcbiAgICAgICAgbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIltsMTBuLWlkXVwiKSkubWFwKGVsID0+IGFkZEVsKGNsZWFyRWwoZWwpLCBtYWtlVGV4dChleHBvcnRzLmdldFZhbHVlKGdldEF0dHIoZWwsXCJsMTBuLWlkXCIpKSkpKTtcclxuICAgICAgICBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiW2wxMG4tcGxhY2Vob2xkZXItaWRdXCIpKS5tYXAoZWwgPT4gc2V0QXR0cihlbCxcInBsYWNlaG9sZGVyXCIsIGV4cG9ydHMuZ2V0VmFsdWUoZ2V0QXR0cihlbCxcImwxMG4tcGxhY2Vob2xkZXItaWRcIikpKSk7XHJcbiAgICB9O1xyXG5cclxufSkodGhpc1snTDEwbiddPXt9LCBEaWN0aW9uYXJpZXMpOyIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcblV0aWxzLCBPdmVydmlldywgUHJvZmlsZXMsIFN0b3JpZXMsIEFkYXB0YXRpb25zLCBCcmllZmluZ3MsIFRpbWVsaW5lLCBTb2NpYWxOZXR3b3JrLCBGaWxlVXRpbHNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuXHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuICAgIHN0YXRlLnZpZXdzID0ge307XHJcbiAgICBcclxuICAgIHZhciBidG5PcHRzID0ge1xyXG4gICAgICAgIHRvb2x0aXAgOiB0cnVlLFxyXG4gICAgICAgIGNsYXNzTmFtZSA6ICdtYWluTmF2QnV0dG9uJ1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICB2YXIgaW5pdFBhZ2UgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSgoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCkpO1xyXG4gICAgICAgIFVJLmluaXRTZWxlY3RvckZpbHRlcnMoKTtcclxuICAgICAgICBVSS5pbml0UGFuZWxUb2dnbGVycygpO1xyXG4gICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURpYWxvZ3MoKXtcclxuICAgICAgICAgICAgdmV4LmRpYWxvZy5idXR0b25zLllFUy50ZXh0ID0gZ2V0TDEwbignY29tbW9uLW9rJyk7XHJcbiAgICAgICAgICAgIHZleC5kaWFsb2cuYnV0dG9ucy5OTy50ZXh0ID0gZ2V0TDEwbignY29tbW9uLWNhbmNlbCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB1cGRhdGVEaWFsb2dzKCk7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UodXBkYXRlRGlhbG9ncyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHZhciBwcm90b0V4cGFuZGVyID0gZnVuY3Rpb24oYXJyKXtcclxuICAgICAgICBmdW5jdGlvbiBwcm90b0NhcnJpZXIoKXt9O1xyXG4gICAgICAgIGFyci5mb3JFYWNoKCBuYW1lID0+IHByb3RvQ2Fycmllci5wcm90b3R5cGVbbmFtZV0gPSAoKCkgPT4gMSkpO1xyXG4gICAgICAgIHJldHVybiBwcm90b0NhcnJpZXI7XHJcbiAgICB9O1xyXG4gICAgdmFyIHBsYXllckFyciA9IFtcclxuICAgICAgICAgICAgICAgICAgICAnZ2V0UGxheWVyc09wdGlvbnMnICAgICAgICAsXHJcbiAgICAgICAgICAgICAgICAgICAgJ2dldFdlbGNvbWVUZXh0JyAgICAgICAgICAgLFxyXG4gICAgICAgICAgICAgICAgICAgICdnZXRQbGF5ZXJQcm9maWxlSW5mbycgICAgICxcclxuICAgICAgICAgICAgICAgICAgICAnY3JlYXRlQ2hhcmFjdGVyQnlQbGF5ZXInICAsXHJcbiAgICAgICAgICAgICAgICAgICAgJ3VwZGF0ZVByb2ZpbGVGaWVsZCcgICAgICAgXTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5vblBsYXllclBhZ2VMb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGluaXRQYWdlKCk7XHJcbiAgICAgICAgdmFyIFJlbW90ZURCTVMgPSBtYWtlUmVtb3RlREJNUyhwcm90b0V4cGFuZGVyKHBsYXllckFycikpO1xyXG4gICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IFJlbW90ZURCTVMoKTtcclxuICAgICAgICBzdGF0ZUluaXQoKTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsIFwicGxheWVyXCIsIFBsYXllciwge21haW5QYWdlOnRydWV9KTtcclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBhZGRDbGFzcyhtYWtlRWwoXCJkaXZcIiksIFwibmF2LXNlcGFyYXRvclwiKSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcImFib3V0XCIsIEFib3V0KTtcclxuLy8gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VMMTBuQnV0dG9uKCkpO1xyXG4gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJsb2dvdXRCdXR0b25cIiwgXCJsb2dvdXRcIiwgcG9zdExvZ291dCwgYnRuT3B0cykpO1xyXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMub25JbmRleFBhZ2VMb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGluaXRQYWdlKCk7XHJcbiAgICAgICAgdmFyIFJlbW90ZURCTVMgPSBtYWtlUmVtb3RlREJNUyhwcm90b0V4cGFuZGVyKFsnZ2V0UGxheWVyc09wdGlvbnMnXSkpO1xyXG4gICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IFJlbW90ZURCTVMoKTtcclxuICAgICAgICBzdGF0ZUluaXQoKTtcclxuICAgICAgICBEQk1TLmdldFBsYXllcnNPcHRpb25zKGZ1bmN0aW9uKGVyciwgcGxheWVyc09wdGlvbnMpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBhZGRDbGFzcyhtYWtlRWwoXCJkaXZcIiksIFwibmF2LXNlcGFyYXRvclwiKSk7XHJcbiAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJlbnRlclwiLCBFbnRlciwge21haW5QYWdlOnRydWV9KTtcclxuICAgICAgICAgICAgaWYocGxheWVyc09wdGlvbnMuYWxsb3dQbGF5ZXJDcmVhdGlvbil7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsIFwicmVnaXN0ZXJcIiwgUmVnaXN0ZXIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJhYm91dFwiLCBBYm91dCk7XHJcbi8vICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUwxMG5CdXR0b24oKSk7XHJcbiAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMub25NYXN0ZXJQYWdlTG9hZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpbml0UGFnZSgpO1xyXG4gICAgICAgIHZhciBMb2NhbERCTVMgPSBtYWtlTG9jYWxEQk1TKHRydWUpO1xyXG4gICAgICAgIGlmKE1PREUgPT09IFwiU3RhbmRhbG9uZVwiKXtcclxuICAgICAgICAgICAgd2luZG93LkRCTVMgPSBuZXcgTG9jYWxEQk1TKCk7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RGF0YWJhc2UoQmFzZUV4YW1wbGUuZGF0YSwgZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICBjb25zaXN0ZW5jeUNoZWNrKG9uRGF0YWJhc2VMb2FkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmKE1PREUgPT09IFwiTklNU19TZXJ2ZXJcIikge1xyXG4gICAgICAgICAgICB2YXIgUmVtb3RlREJNUyA9IG1ha2VSZW1vdGVEQk1TKExvY2FsREJNUyk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IFJlbW90ZURCTVMoKTtcclxuICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhvbkRhdGFiYXNlTG9hZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGNvbnNpc3RlbmN5Q2hlY2sgPSBmdW5jdGlvbihjYWxsYmFjayl7XHJcbiAgICAgICAgREJNUy5nZXRDb25zaXN0ZW5jeUNoZWNrUmVzdWx0KGZ1bmN0aW9uKGVyciwgY29uc2lzdGVuY3lFcnJvcnMpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBjb25zaXN0ZW5jeUVycm9ycy5mb3JFYWNoKENvbW1vblV0aWxzLmNvbnNvbGVMb2cpO1xyXG4gICAgICAgICAgICBpZihjb25zaXN0ZW5jeUVycm9ycy5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LXByb2JsZW0tZGV0ZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29uc2lzdGVuY3kgY2hlY2sgZGlkblxcJ3QgZmluZCBlcnJvcnMnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHN0YXRlSW5pdCA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgc3RhdGUubmF2aWdhdGlvbiA9IGdldEVsKFwibmF2aWdhdGlvblwiKTtcclxuICAgICAgICBzdGF0ZS5jb250YWluZXJzID0ge1xyXG4gICAgICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgICAgICBuYXZpZ2F0aW9uOiBzdGF0ZS5uYXZpZ2F0aW9uLFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogZ2V0RWwoXCJjb250ZW50QXJlYVwiKVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25EYXRhYmFzZUxvYWQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKGZ1bmN0aW9uKGVyciwgaXNBZG1pbil7XHJcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uO1xyXG4gICAgICAgICAgICAgICAgc3RhdGVJbml0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcIm92ZXJ2aWV3XCIsIE92ZXJ2aWV3LCB7bWFpblBhZ2U6dHJ1ZX0pO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcInByb2ZpbGVzXCIsIFByb2ZpbGVzKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJzdG9yaWVzXCIsIFN0b3JpZXMpO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcImFkYXB0YXRpb25zXCIsIEFkYXB0YXRpb25zKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJicmllZmluZ3NcIiwgQnJpZWZpbmdzKTtcclxuICAgIC8vICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcImFib3V0XCIsIEFib3V0KTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYWRkQ2xhc3MobWFrZUVsKFwiZGl2XCIpLCBcIm5hdi1zZXBhcmF0b3JcIikpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsIFwidGltZWxpbmVcIiwgVGltZWxpbmUsIHtpZDpcInRpbWVsaW5lQnV0dG9uXCIsIHRvb2x0aXA6dHJ1ZX0pO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcInNvY2lhbC1uZXR3b3JrXCIsIFNvY2lhbE5ldHdvcmssIHtpZDpcInNvY2lhbE5ldHdvcmtCdXR0b25cIiwgdG9vbHRpcDp0cnVlfSk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsIFwicHJvZmlsZS1maWx0ZXJcIiwgUHJvZmlsZUZpbHRlciwge2lkOlwiZmlsdGVyQnV0dG9uXCIsIHRvb2x0aXA6dHJ1ZX0pO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcImdyb3Vwc1wiLCBHcm91cHMsIHtpZDpcImdyb3Vwc0J1dHRvblwiLCB0b29sdGlwOnRydWV9KTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJ0ZXh0U2VhcmNoXCIsIFRleHRTZWFyY2gsIHtpZDpcInRleHRTZWFyY2hCdXR0b25cIiwgdG9vbHRpcDp0cnVlfSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGFkZENsYXNzKG1ha2VFbChcImRpdlwiKSwgXCJuYXYtc2VwYXJhdG9yXCIpKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYoaXNBZG1pbil7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IG1ha2VCdXR0b24oXCJkYXRhTG9hZEJ1dHRvblwiLCBcIm9wZW4tZGF0YWJhc2VcIiwgbnVsbCwgYnRuT3B0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIEZpbGVVdGlscy5yZWFkU2luZ2xlRmlsZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IG1ha2VFbChcImlucHV0XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnR5cGUgPSBcImZpbGVcIjtcclxuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEF0dHIoaW5wdXQsICd0YWJpbmRleCcsIC0xKTtcclxuICAgICAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kQ2hpbGQoaW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5jbGljaygpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXZpZ2F0aW9uIHRvIFwiI1wiXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYnV0dG9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbihcImRhdGFTYXZlQnV0dG9uXCIsIFwic2F2ZS1kYXRhYmFzZVwiLCBGaWxlVXRpbHMuc2F2ZUZpbGUsIGJ0bk9wdHMpKTtcclxuICAgICAgICAgICAgICAgIGlmKE1PREUgPT09IFwiU3RhbmRhbG9uZVwiKXtcclxuICAgICAgICAgICAgICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwibmV3QmFzZUJ1dHRvblwiLCBcImNyZWF0ZS1kYXRhYmFzZVwiLCBGaWxlVXRpbHMubWFrZU5ld0Jhc2UsIGJ0bk9wdHMpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJtYWluSGVscEJ1dHRvblwiLCBcImRvY3NcIiwgRmlsZVV0aWxzLm9wZW5IZWxwLCBidG5PcHRzKSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUwxMG5CdXR0b24oKSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgXCJsb2dWaWV3ZXJcIiwgTG9nVmlld2VyMiwge2lkOlwibG9nVmlld2VyQnV0dG9uXCIsIHRvb2x0aXA6dHJ1ZX0pO1xyXG4gICAgICAgICAgICAgICAgLy9hZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwidGVzdEJ1dHRvblwiLCBcInRlc3RcIiwgcnVuVGVzdHMsIGJ0bk9wdHMpKTtcclxuICAgICAgICAgICAgICAgIGlmKE1PREUgPT09IFwiTklNU19TZXJ2ZXJcIil7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCBcImFkbWluc1wiLCBBY2Nlc3NNYW5hZ2VyLCB7aWQ6XCJhY2Nlc3NNYW5hZ2VyQnV0dG9uXCIsIHRvb2x0aXA6dHJ1ZX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJsb2dvdXRCdXR0b25cIiwgXCJsb2dvdXRcIiwgcG9zdExvZ291dCwgYnRuT3B0cykpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBGaWxlVXRpbHMuaW5pdChmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICBpZihNT0RFID09PSBcIlN0YW5kYWxvbmVcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEJlZm9yZVVubG9hZExpc3RlbmVyKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VMMTBuQnV0dG9uID0gZnVuY3Rpb24oKXtcclxuICAgICAgICB2YXIgbDEwbkJ0biA9IG1ha2VCdXR0b24oXCJ0b2dnbGVMMTBuQnV0dG9uXCIsIFwibDEwblwiLCBMMTBuLnRvZ2dsZUwxMG4sIGJ0bk9wdHMpO1xyXG4gICAgICAgIHZhciBzZXRJY29uID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgbDEwbkJ0bi5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSBzdHJGb3JtYXQoJ3VybChcIi4vaW1hZ2VzL3swfS5zdmdcIiknLCBbZ2V0TDEwbignaGVhZGVyLWRpY3Rpb25hcnktaWNvbicpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKHNldEljb24pO1xyXG4gICAgICAgIHNldEljb24oKTtcclxuICAgICAgICByZXR1cm4gbDEwbkJ0bjtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBydW5UZXN0cyA9IGZ1bmN0aW9uKCl7XHJcbiAgICAvLyAgICB3aW5kb3cuUnVuVGVzdHMoKTtcclxuICAgICAgICBjb25zaXN0ZW5jeUNoZWNrKGZ1bmN0aW9uKGVyciwgY2hlY2tSZXMpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBpZihjaGVja1JlcyA9PT0gdW5kZWZpbmVkIHx8IGNoZWNrUmVzLmxlbmd0aCA9PT0gMCl7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdvdmVydmlldy1jb25zaXN0ZW5jeS1pcy1vaycpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LXByb2JsZW0tZGV0ZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBwb3N0TG9nb3V0ID0gZnVuY3Rpb24oKXtcclxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjbG9nb3V0Rm9ybSBidXR0b24nKS5jbGljaygpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VCdXR0b24gPSBmdW5jdGlvbihpZCwgbmFtZSwgY2FsbGJhY2ssIG9wdHMpe1xyXG4gICAgICAgIHZhciBidXR0b24gPSBtYWtlRWwoXCJidXR0b25cIik7XHJcbiAgICAgICAgYnV0dG9uLmlkID0gaWQ7XHJcbiAgICAgICAgaWYob3B0cy50b29sdGlwKXtcclxuICAgICAgICAgICAgdmFyIGRlbGVnYXRlID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICQoYnV0dG9uKS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJywgTDEwbi5nZXRWYWx1ZShcImhlYWRlci1cIiArIG5hbWUpKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZGVsZWdhdGUpO1xyXG4gICAgICAgICAgICAkKGJ1dHRvbikudG9vbHRpcCh7XHJcbiAgICAgICAgICAgICAgICB0aXRsZSA6IEwxMG4uZ2V0VmFsdWUoXCJoZWFkZXItXCIgKyBuYW1lKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlbWVudCA6IFwiYm90dG9tXCJcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgXCJhY3Rpb24tYnV0dG9uXCIpO1xyXG4gICAgICAgIGlmKG9wdHMuY2xhc3NOYW1lKXtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCBvcHRzLmNsYXNzTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKGNhbGxiYWNrKXtcclxuICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NsaWNrJywgY2FsbGJhY2spO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYnV0dG9uO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGFkZEJlZm9yZVVubG9hZExpc3RlbmVyID0gZnVuY3Rpb24oKXtcclxuICAgICAgICB3aW5kb3cub25iZWZvcmV1bmxvYWQgPSBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZ2V0TDEwbihcInV0aWxzLWNsb3NlLXBhZ2Utd2FybmluZ1wiKTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBldnQgPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgZXZ0ID0gd2luZG93LmV2ZW50O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChldnQpIHtcclxuICAgICAgICAgICAgICAgIGV2dC5yZXR1cm5WYWx1ZSA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIFxyXG5cclxufSkodGhpc1snUGFnZU1hbmFnZXInXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzLCBtb2RlKXtcclxuXHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuICAgIFxyXG4gICAgc3RhdGUuc3VtbWFyeSA9IHt9O1xyXG4gICAgXHJcbiAgICBpZihtb2RlID09PSBcIk5JTVNfU2VydmVyXCIgJiYgUEVSTUlTU0lPTl9JTkZPUk1FUl9FTkFCTEVEKXtcclxuICAgICAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbihjYWxsYmFjaykge1xyXG4gICAgICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XHJcbiAgICAgICAgICAgICAgICB1cmwgOiBcIi9nZXRQZXJtaXNzaW9uc1N1bW1hcnlcIixcclxuICAgICAgICAgICAgICAgIGRhdGFUeXBlIDogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgICAgICBtZXRob2QgOiBcIkdFVFwiLFxyXG4gICAgICAgICAgICAgICAgY29udGVudFR5cGUgOiBcImFwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOFwiLFxyXG4gICAgICAgICAgICAgICAgdGltZW91dDogQ29uc3RhbnRzLmh0dHBUaW1lb3V0XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnN1bW1hcnkgPSBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYoY2FsbGJhY2spe1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgYWxlcnQoZGF0YSk7XHJcbiAgICAvLyAgICAgICAgYWxlcnQoc3RhdGUuc3VtbWFyeSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVxdWVzdC5mYWlsKGZ1bmN0aW9uKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrKXtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8ICdlcnJvcicpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV4cG9ydHMuc3Vic2NyaWJlLCA1MDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuc3Vic2NyaWJlID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XHJcbiAgICAgICAgICAgICAgICB1cmwgOiBcIi9zdWJzY3JpYmVPblBlcm1pc3Npb25zVXBkYXRlXCIsXHJcbiAgICAgICAgICAgICAgICBkYXRhVHlwZSA6IFwidGV4dFwiLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kIDogXCJHRVRcIixcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlIDogXCJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLThcIixcclxuICAgICAgICAgICAgICAgIHRpbWVvdXQ6IENvbnN0YW50cy5odHRwVGltZW91dFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJlcXVlc3QuZG9uZShmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5zdW1tYXJ5ID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgIC8vICAgICAgICBhbGVydChkYXRhKTtcclxuICAgIC8vICAgICAgICBhbGVydChzdGF0ZS5zdW1tYXJ5KTtcclxuICAgICAgICAgICAgICAgIGV4cG9ydHMuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmVxdWVzdC5mYWlsKGZ1bmN0aW9uKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZXhwb3J0cy5zdWJzY3JpYmUsIDUwMCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICBcclxuICAgICAgICBleHBvcnRzLmlzQWRtaW4gPSBmdW5jdGlvbihjYWxsYmFjayl7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHN0YXRlLnN1bW1hcnkuaXNBZG1pbik7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmlzRWRpdG9yID0gZnVuY3Rpb24oY2FsbGJhY2spe1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBzdGF0ZS5zdW1tYXJ5LmlzRWRpdG9yKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuaXNFbnRpdHlFZGl0YWJsZSA9IGZ1bmN0aW9uKHR5cGUsIGVudGl0eU5hbWUsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGlzT2JqZWN0RWRpdGFibGVTeW5jKHR5cGUsIGVudGl0eU5hbWUpKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciBpc09iamVjdEVkaXRhYmxlU3luYyA9IGZ1bmN0aW9uKHR5cGUsIG5hbWUpe1xyXG4gICAgICAgICAgICBpZihzdGF0ZS5zdW1tYXJ5LmlzRWRpdG9yKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHN0YXRlLnN1bW1hcnkuZXhpc3RFZGl0b3Ipe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5zdW1tYXJ5LnVzZXJbdHlwZV0uaW5kZXhPZihuYW1lKSAhPT0gLTE7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmdldEVudGl0eU5hbWVzQXJyYXkgPSBSLmN1cnJ5KGZ1bmN0aW9uKHR5cGUsIGVkaXRhYmxlT25seSwgY2FsbGJhY2spe1xyXG4gICAgICAgICAgICB2YXIgdXNlckVudGl0aWVzID0gc3RhdGUuc3VtbWFyeS51c2VyW3R5cGVdO1xyXG4gICAgICAgICAgICB2YXIgYWxsRW50aXRpZXMgPSBzdGF0ZS5zdW1tYXJ5LmFsbFt0eXBlXTtcclxuICAgICAgICAgICAgdmFyIG93bmVyTWFwID0gc3RhdGUuc3VtbWFyeS5vd25lck1hcHNbdHlwZV07XHJcbiAgICAgICAgICAgIHZhciBuYW1lcyA9IGFsbEVudGl0aWVzLmZpbHRlcihmdW5jdGlvbihuYW1lKXtcclxuICAgICAgICAgICAgICAgIGlmKGVkaXRhYmxlT25seSl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0RWRpdGFibGVTeW5jKHR5cGUsIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkubWFwKGZ1bmN0aW9uKG5hbWUpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZSA6IG93bmVyTWFwW25hbWVdICsgXCIuIFwiICsgbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZWRpdGFibGUgOiBpc09iamVjdEVkaXRhYmxlU3luYyh0eXBlLCBuYW1lKSxcclxuICAgICAgICAgICAgICAgICAgICBpc093bmVyIDogdXNlckVudGl0aWVzLmluZGV4T2YobmFtZSkgIT09IC0xXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIG5hbWVzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbmFtZXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSA9IGZ1bmN0aW9uKGFkYXB0YXRpb25zLCBjYWxsYmFjayl7XHJcbiAgICAgICAgICAgIHZhciBtYXAgPSB7fTtcclxuICAgICAgICAgICAgdmFyIGlzQWRhcHRhdGlvblJpZ2h0c0J5U3RvcnkgPSBzdGF0ZS5zdW1tYXJ5LmlzQWRhcHRhdGlvblJpZ2h0c0J5U3Rvcnk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhZGFwdGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pe1xyXG4gICAgICAgICAgICAgICAgdmFyIGtleSA9IGVsZW0uc3RvcnlOYW1lICsgXCItXCIgKyBlbGVtLmNoYXJhY3Rlck5hbWU7XHJcbiAgICAgICAgICAgICAgICBpZihpc0FkYXB0YXRpb25SaWdodHNCeVN0b3J5KXtcclxuICAgICAgICAgICAgICAgICAgICBtYXBba2V5XSA9IGlzT2JqZWN0RWRpdGFibGVTeW5jKCdzdG9yeScsIGVsZW0uc3RvcnlOYW1lKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWFwW2tleV0gPSBpc09iamVjdEVkaXRhYmxlU3luYygnY2hhcmFjdGVyJywgZWxlbS5jaGFyYWN0ZXJOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBtYXApO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICB9IGVsc2UgaWYgKG1vZGUgPT09IFwiU3RhbmRhbG9uZVwiKXtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbihjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5pc0FkbWluID0gZnVuY3Rpb24oY2FsbGJhY2spe1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuaXNFZGl0b3IgPSBmdW5jdGlvbihjYWxsYmFjayl7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5nZXRFbnRpdHlOYW1lc0FycmF5ID0gUi5jdXJyeShmdW5jdGlvbih0eXBlLCBlZGl0YWJsZU9ubHksIGNhbGxiYWNrKXtcclxuICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc05hbWVzKGVyciwgbmFtZXMpe1xyXG4gICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgICAgIHZhciBuZXdOYW1lcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKXtcclxuICAgICAgICAgICAgICAgICAgICBuZXdOYW1lcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6bmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6bmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdGFibGU6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbmV3TmFtZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0RW50aXR5TmFtZXNBcnJheSh0eXBlLCBwcm9jZXNzTmFtZXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuaXNFbnRpdHlFZGl0YWJsZSA9IGZ1bmN0aW9uKHR5cGUsIGVudGl0eU5hbWUsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5hcmVBZGFwdGF0aW9uc0VkaXRhYmxlID0gZnVuY3Rpb24oYWRhcHRhdGlvbnMsIGNhbGxiYWNrKXtcclxuICAgICAgICAgICAgdmFyIG1hcCA9IHt9O1xyXG4gICAgICAgICAgICBhZGFwdGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGVsZW0pe1xyXG4gICAgICAgICAgICAgICAgbWFwW2VsZW0uc3RvcnlOYW1lICsgXCItXCIgKyBlbGVtLmNoYXJhY3Rlck5hbWVdID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBtYXApO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG59KSh0aGlzWydQZXJtaXNzaW9uSW5mb3JtZXInXT17fSwgTU9ERSk7IiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4oZnVuY3Rpb24oZXhwb3J0cyl7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0VGFiUGFuZWwgPSBmdW5jdGlvbih0YWJDbGF6eiwgY29udGFpbmVyQ2xhenopIHtcclxuICAgICAgICB2YXIgY29udGFpbmVycyA9IGdldEVscyhjb250YWluZXJDbGF6eik7XHJcbiAgICBcclxuICAgICAgICB2YXIgaTtcclxuICAgICAgICBmb3IgKGkgPSAxOyBpIDwgY29udGFpbmVycy5sZW5ndGg7IGkrKykgeyAvLyBkb24ndCBoaWRlIDFzdCBlbGVtZW50XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnNbaV0sIFwiaGlkZGVuXCIpO1xyXG4gICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgIHZhciB0YWJCdXR0b25zID0gZ2V0RWxzKHRhYkNsYXp6KTtcclxuICAgIFxyXG4gICAgICAgIGFkZENsYXNzKHRhYkJ1dHRvbnNbMF0sIFwiYWN0aXZlXCIpO1xyXG4gICAgXHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRhYkJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGlzdGVuKHRhYkJ1dHRvbnNbaV0sIFwiY2xpY2tcIiwgdGFiQnV0dG9uQ2xpY2sodGFiQnV0dG9ucywgY29udGFpbmVycykpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciB0YWJCdXR0b25DbGljayA9IGZ1bmN0aW9uKGJ1dHRvbnMsIGNvbnRhaW5lcnMpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGJ1dHRvbnNbaV0sIFwiYWN0aXZlXCIsIGV2ZW50LnRhcmdldC5pZCA9PT0gYnV0dG9uc1tpXS5pZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250YWluZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGNvbnRhaW5lcnNbaV0sIFwiaGlkZGVuXCIsIGV2ZW50LnRhcmdldC5pZCArIFwiQ29udGFpbmVyXCIgIT09IGNvbnRhaW5lcnNbaV0uaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMuZmlsbFNob3dJdGVtU2VsZWN0b3IgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGRpc3BsYXlBcnJheSkge1xyXG4gICAgICAgIHZhciBlbDtcclxuICAgICAgICBzZXRBdHRyKHNlbGVjdG9yLCBcInNpemVcIiwgZGlzcGxheUFycmF5Lmxlbmd0aCk7XHJcbiAgICAgICAgZGlzcGxheUFycmF5LmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHtcclxuICAgICAgICAgICAgZWwgPSBzZXRQcm9wcyhtYWtlRWwoXCJvcHRpb25cIiksIHtcclxuICAgICAgICAgICAgICAgIFwic2VsZWN0ZWRcIiA6IHRydWUsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGVsLCAnaGlkZGVuJywgdmFsdWUuaGlkZGVuKTtcclxuICAgICAgICAgICAgYWRkRWwoc2VsZWN0b3IsIGFkZEVsKGVsLCBtYWtlVGV4dCh2YWx1ZS5uYW1lKSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5maWxsU2hvd0l0ZW1TZWxlY3RvcjIgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG9wdGlvbkdyb3Vwcykge1xyXG4gICAgICAgIHZhciBlbCwgZ3JvdXBFbCwgY291bnRlciA9IDA7XHJcbiAgICAgICAgYWRkRWxzKHNlbGVjdG9yLCBvcHRpb25Hcm91cHMubWFwKGZ1bmN0aW9uKGdyb3VwKSB7XHJcbiAgICAgICAgICAgIGNvdW50ZXIrKztcclxuICAgICAgICAgICAgZ3JvdXBFbCA9IHNldEF0dHIobWFrZUVsKFwib3B0Z3JvdXBcIiksICdsYWJlbCcsIGdyb3VwLm5hbWUpO1xyXG4gICAgICAgICAgICBhZGRFbHMoZ3JvdXBFbCwgZ3JvdXAuYXJyYXkubWFwKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZWwgPSBzZXRQcm9wcyhtYWtlRWwoXCJvcHRpb25cIiksIHtcclxuICAgICAgICAgICAgICAgICAgICBcInNlbGVjdGVkXCIgOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGVsLCAnaGlkZGVuJywgdmFsdWUuaGlkZGVuKTtcclxuICAgICAgICAgICAgICAgIGNvdW50ZXIgKz0gKHZhbHVlLmhpZGRlbiA/IDAgOiAxKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhZGRFbChlbCwgbWFrZVRleHQodmFsdWUubmFtZSkpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIHJldHVybiBncm91cEVsO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBzZXRBdHRyKHNlbGVjdG9yLCBcInNpemVcIiwgY291bnRlcik7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnNob3dTZWxlY3RlZEVscyA9IGZ1bmN0aW9uKGNsYXNzS2V5KXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpe1xyXG4gICAgICAgICAgICB2YXIgZWwgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgICAgIHZhciBlbHMsIGksIGo7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICBpZihoYXNDbGFzcyhlbC5vcHRpb25zW2ldLCAnaGlkZGVuJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzID0gZ2V0RWxzKGkgKyBjbGFzc0tleSk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZWxzLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihlbHNbal0sIFwiaGlkZGVuXCIsICFlbC5vcHRpb25zW2ldLnNlbGVjdGVkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMuaW5pdFNlbGVjdG9yRmlsdGVycyA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgdmFyIGVsZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIltzZWxlY3Rvci1maWx0ZXJdXCIpO1xyXG4gICAgICAgIHZhciBlbCwgc2VsO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWwgPSBlbGVtc1tpXTtcclxuICAgICAgICAgICAgc2VsID0gcXVlcnlFbChnZXRBdHRyKGVsLFwic2VsZWN0b3ItZmlsdGVyXCIpKTtcclxuICAgICAgICAgICAgbGlzdGVuKGVsLCBcImlucHV0XCIsIGZpbHRlck9wdGlvbnMoc2VsKSlcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgZmlsdGVyT3B0aW9ucyA9IGZ1bmN0aW9uKHNlbCl7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KXtcclxuICAgICAgICAgICAgdmFyIHZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgdmFyIGksIG9wdDtcclxuICAgICAgICAgICAgdmFsID0gQ29tbW9uVXRpbHMuZ2xvYlN0cmluZ1RvUmVnZXgodmFsLnRyaW0oKS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICBvcHQgPSBzZWwub3B0aW9uc1tpXTtcclxuICAgICAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ob3B0LCBcImhpZGRlblwiLCBvcHQuaW5uZXJIVE1MLnRvTG93ZXJDYXNlKCkuc2VhcmNoKHZhbCkgPT09IC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMuaW5pdFBhbmVsVG9nZ2xlcnMgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIHZhciBlbGVtcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJbcGFuZWwtdG9nZ2xlcl1cIik7XHJcbiAgICAgICAgdmFyIGVsLCBzZWwsIGF0dHI7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBlbCA9IGVsZW1zW2ldO1xyXG4gICAgICAgICAgICBhdHRyID0gZ2V0QXR0cihlbCxcInBhbmVsLXRvZ2dsZXJcIik7XHJcbiAgICAgICAgICAgIHNlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYXR0cik7XHJcbiAgICAgICAgICAgIGlmKHNlbCA9PSBudWxsKXtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KFwiUGFuZWwgdG9nZ2xlciBpcyBicm9rZW46IFwiICsgYXR0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGlzdGVuKGVsLCBcImNsaWNrXCIsIGV4cG9ydHMudG9nZ2xlUGFuZWwoc2VsKSlcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnRvZ2dsZVBhbmVsID0gZnVuY3Rpb24oc2VsKXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpe1xyXG4gICAgICAgICAgICB0b2dnbGVDbGFzcyhzZWwsIFwiaGlkZGVuXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMubWFrZUV2ZW50VGltZVBpY2tlciA9IGZ1bmN0aW9uIChvcHRzKSB7XHJcbiAgICAgICAgdmFyIGlucHV0ID0gbWFrZUVsKFwiaW5wdXRcIik7XHJcbiAgICAgICAgUi5hcChbYWRkQ2xhc3MoaW5wdXQpXSwgb3B0cy5leHRyYUNsYXNzZXMpO1xyXG4gICAgICAgIGFkZENsYXNzKGlucHV0LCBcImV2ZW50VGltZVwiKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlucHV0LmV2ZW50SW5kZXggPSBvcHRzLmluZGV4O1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciBwaWNrZXJPcHRzID0ge1xyXG4gICAgICAgICAgICBsYW5nIDogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAgICAgICAgIG1hc2sgOiB0cnVlLFxyXG4gICAgICAgICAgICBzdGFydERhdGUgOiBuZXcgRGF0ZShvcHRzLnByZUdhbWVEYXRlKSxcclxuICAgICAgICAgICAgZW5kRGF0ZSA6IG5ldyBEYXRlKG9wdHMuZGF0ZSksXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWUgOiBvcHRzLm9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yKGlucHV0KSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChvcHRzLmV2ZW50VGltZSAhPT0gXCJcIikge1xyXG4gICAgICAgICAgICBwaWNrZXJPcHRzLnZhbHVlID0gb3B0cy5ldmVudFRpbWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcGlja2VyT3B0cy52YWx1ZSA9IG9wdHMuZGF0ZTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwiZGVmYXVsdERhdGVcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGpRdWVyeShpbnB1dCkuZGF0ZXRpbWVwaWNrZXIocGlja2VyT3B0cyk7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZXNpemVUZXh0YXJlYSA9IGZ1bmN0aW9uIChldikge1xyXG4gICAgICAgIHZhciB0aGF0ID0gZXYudGFyZ2V0O1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gJzI0cHgnO1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gdGhhdC5zY3JvbGxIZWlnaHQgKyAxMiArICdweCc7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlc2l6ZVRleHRhcmVhMiA9IGZ1bmN0aW9uICh0aGF0KSB7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSAnMjRweCc7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSB0aGF0LnNjcm9sbEhlaWdodCArIDEyICsgJ3B4JztcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMubWFrZUFkYXB0YXRpb25UaW1lSW5wdXQgPSBmdW5jdGlvbihzdG9yeU5hbWUsIGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBpc0VkaXRhYmxlKXtcclxuICAgICAgICB2YXIgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCBcIm5vdEVkaXRhYmxlXCIsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCxcImFkYXB0YXRpb25UaW1lSW5wdXRcIik7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnRpbWU7XHJcbiAgICAgICAgaW5wdXQuZGF0YUtleSA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCBcImNoYW5nZVwiLCBvbkNoYW5nZVBlcnNvbmFsVGltZURlbGVnYXRlKTtcclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25DaGFuZ2VQZXJzb25hbFRpbWVEZWxlZ2F0ZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBkYXRhS2V5ID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQuZGF0YUtleSk7XHJcbiAgICAgICAgdmFyIHRpbWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgREJNUy5zZXRFdmVudEFkYXB0YXRpb25Qcm9wZXJ0eShkYXRhS2V5WzBdLCBkYXRhS2V5WzFdLCBkYXRhS2V5WzJdLCAndGltZScsIHRpbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMubWFrZUFkYXB0YXRpb25SZWFkeUlucHV0ID0gZnVuY3Rpb24oc3RvcnlOYW1lLCBldmVudCwgY2hhcmFjdGVyTmFtZSwgaXNFZGl0YWJsZSl7XHJcbiAgICAgICAgdmFyIGRpdiA9IG1ha2VFbChcImRpdlwiKTtcclxuICAgICAgICB2YXIgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCBcIm5vdEVkaXRhYmxlXCIsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gXCJjaGVja2JveFwiO1xyXG4gICAgICAgIGlucHV0LmNoZWNrZWQgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnJlYWR5O1xyXG4gICAgICAgIGlucHV0LmRhdGFLZXkgPSBKU09OLnN0cmluZ2lmeShbc3RvcnlOYW1lLCBldmVudC5pbmRleCwgY2hhcmFjdGVyTmFtZV0pO1xyXG4gICAgICAgIGlucHV0LmlkID0gZXZlbnQuaW5kZXggKyBcIi1cIiArIHN0b3J5TmFtZSArIFwiLVwiICsgY2hhcmFjdGVyTmFtZTtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsIFwiY2hhbmdlXCIsIG9uQ2hhbmdlUmVhZHlTdGF0dXMpO1xyXG4gICAgICAgIGFkZEVsKGRpdiwgaW5wdXQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVsKGRpdiwgc2V0QXR0cihhZGRFbChtYWtlRWwoXCJsYWJlbFwiKSwgbWFrZVRleHQoY29uc3RMMTBuKENvbnN0YW50cy5maW5pc2hlZFRleHQpKSksIFwiZm9yXCIsIGlucHV0LmlkKSk7XHJcbiAgICAgICAgcmV0dXJuIGRpdjtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBvbkNoYW5nZVJlYWR5U3RhdHVzID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5kYXRhS2V5KTtcclxuICAgICAgICB2YXIgdmFsdWUgPSBldmVudC50YXJnZXQuY2hlY2tlZDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50QWRhcHRhdGlvblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sIGRhdGFLZXlbMl0sICdyZWFkeScsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLm1ha2VQYW5lbENvcmUgPSBmdW5jdGlvbih0aXRsZSwgY29udGVudCl7XHJcbiAgICAgICAgdmFyIHBhbmVsID0gYWRkQ2xhc3NlcyhtYWtlRWwoJ2RpdicpLCBbXCJwYW5lbFwiLCBcInBhbmVsLWRlZmF1bHRcIl0pO1xyXG4gICAgICAgIHZhciBoMyA9IGFkZENsYXNzKGFkZEVsKG1ha2VFbCgnaDMnKSwgdGl0bGUpLCBcInBhbmVsLXRpdGxlXCIpO1xyXG4gICAgICAgIHZhciBhID0gc2V0QXR0cihtYWtlRWwoJ2EnKSwnaHJlZicsJyMvJyk7XHJcbiAgICAgICAgdmFyIGhlYWREaXYgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCBcInBhbmVsLWhlYWRpbmdcIik7XHJcbiAgICAgICAgYWRkRWwocGFuZWwsIGFkZEVsKGhlYWREaXYsIGFkZEVsKGEsIGgzKSkpO1xyXG4gICAgICAgIHZhciBjb250ZW50RGl2ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgXCJwYW5lbC1ib2R5XCIpO1xyXG4gICAgICAgIGFkZEVsKHBhbmVsLCBhZGRFbChjb250ZW50RGl2LCBjb250ZW50KSk7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcGFuZWw6IHBhbmVsLFxyXG4gICAgICAgICAgICBjb250ZW50RGl2OiBjb250ZW50RGl2LFxyXG4gICAgICAgICAgICBhOiBhXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG59KSh0aGlzWydVSSddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBVdGlscyA9IHt9O1xyXG5cclxuLyoqIG9wdHNcclxuICogICAgICB0b29sdGlwIC0gYWRkIHRvb2x0aXAgdG8gYnV0dG9uLCB1c2VkIGZvciBpY29uaWMgYnV0dG9uc1xyXG4gKiAgICAgIGlkIC0gc2V0IGJ1dHRvbiBpZFxyXG4gKiAgICAgIG1haW5QYWdlIC0gZW5hYmxlIHZpZXcgYXMgZmlyc3QgcGFnZVxyXG4gKiAgICAgIHRvZ2dsZSAtIHRvZ2dsZSBjb250ZW50LCBhc3NvY2lhdGVkIHdpdGggYnV0dG9uXHJcbiAqL1xyXG5VdGlscy5hZGRWaWV3ID0gZnVuY3Rpb24gKGNvbnRhaW5lcnMsIG5hbWUsIHZpZXcsIG9wdHMpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgdmFyIG9wdHMgPSBvcHRzIHx8IHt9O1xyXG4gICAgdmlldy5pbml0KCk7XHJcbiAgICB2YXIgYnV0dG9uQ2xhc3MgPSBcIm5hdmlnYXRpb24tYnV0dG9uXCI7XHJcbiAgICBjb250YWluZXJzLnJvb3Qudmlld3NbbmFtZV0gPSB2aWV3O1xyXG4gICAgdmFyIGJ1dHRvbiA9IG1ha2VFbChcImJ1dHRvblwiKTtcclxuICAgIGlmKG9wdHMudG9vbHRpcCl7XHJcbiAgICAgICAgdmFyIGRlbGVnYXRlID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgJChidXR0b24pLmF0dHIoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCBMMTBuLmdldFZhbHVlKFwiaGVhZGVyLVwiICsgbmFtZSkpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZGVsZWdhdGUpO1xyXG4gICAgICAgICQoYnV0dG9uKS50b29sdGlwKHtcclxuICAgICAgICAgICAgdGl0bGUgOiBMMTBuLmdldFZhbHVlKFwiaGVhZGVyLVwiICsgbmFtZSksXHJcbiAgICAgICAgICAgIHBsYWNlbWVudCA6IFwiYm90dG9tXCJcclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYWRkRWwoYnV0dG9uLCBtYWtlVGV4dChMMTBuLmdldFZhbHVlKFwiaGVhZGVyLVwiICsgbmFtZSkpKTtcclxuICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgXCJsMTBuLWlkXCIsIFwiaGVhZGVyLVwiICsgbmFtZSk7XHJcbiAgICB9XHJcbiAgICBhZGRDbGFzcyhidXR0b24sIGJ1dHRvbkNsYXNzKTtcclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgXCItdGVzdC1cIiArIG5hbWUpO1xyXG4gICAgYWRkQ2xhc3MoYnV0dG9uLCBcIi10b2dnbGUtY2xhc3MtXCIgKyBuYW1lKTtcclxuICAgIGlmKG9wdHMuaWQpe1xyXG4gICAgICAgIGJ1dHRvbi5pZCA9IG9wdHMuaWQ7XHJcbiAgICB9XHJcbiAgICBjb250YWluZXJzLm5hdmlnYXRpb24uYXBwZW5kQ2hpbGQoYnV0dG9uKTtcclxuICAgIFxyXG5cclxuICAgIHZhciBlbGVtcywgaTtcclxuICAgIHZhciBvbkNsaWNrRGVsZWdhdGUgPSBmdW5jdGlvbiAodmlldykge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgIC8vVGVzdHMucnVuKCk7XHJcbiAgICAgICAgICAgIGVsZW1zID0gY29udGFpbmVycy5uYXZpZ2F0aW9uLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoYnV0dG9uQ2xhc3MpO1xyXG4gICAgICAgICAgICBpZihvcHRzLnRvZ2dsZSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgZWxzID0gZ2V0RWxzKFwiLXRvZ2dsZS1jbGFzcy1cIiArIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihldnQudGFyZ2V0LmlzRXF1YWxOb2RlKGVsc1tpXSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaGFzQ2xhc3MoZWxzW2ldLCBcImFjdGl2ZVwiKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc1tpXS5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGlzQWN0aXZlID0gaGFzQ2xhc3MoZXZ0LnRhcmdldCwgXCJhY3RpdmVcIik7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoZWxlbXNbaV0sIFwiYWN0aXZlXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKCFvcHRzLnRvZ2dsZSB8fCAob3B0cy50b2dnbGUgJiYgIWlzQWN0aXZlKSl7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhldnQudGFyZ2V0LCBcImFjdGl2ZVwiKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgcGFzc0Vscyhjb250YWluZXJzLmNvbnRlbnQsIGdldEVsKCd3YXJlaG91c2UnKSk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLmNvbnRlbnQuYXBwZW5kQ2hpbGQodmlldy5jb250ZW50KTtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGNvbnRhaW5lcnMuY29udGVudCwgXCJoaWRkZW5cIik7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSB2aWV3O1xyXG4gICAgICAgICAgICAgICAgdmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhldnQudGFyZ2V0LCBcImFjdGl2ZVwiKTtcclxuICAgICAgICAgICAgICAgIHBhc3NFbHMoY29udGFpbmVycy5jb250ZW50LCBnZXRFbCgnd2FyZWhvdXNlJykpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnMuY29udGVudCwgXCJoaWRkZW5cIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIG9uQ2xpY2tEZWxlZ2F0ZSh2aWV3KSk7XHJcbiAgICBpZiAob3B0cy5tYWluUGFnZSkge1xyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgXCJhY3RpdmVcIik7XHJcbiAgICAgICAgY29udGFpbmVycy5jb250ZW50LmFwcGVuZENoaWxkKHZpZXcuY29udGVudCk7XHJcbiAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gdmlldztcclxuICAgIH1cclxufTtcclxuXHJcblV0aWxzLmFsZXJ0ID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcclxuICAgIHZleC5kaWFsb2cuYWxlcnQobWVzc2FnZSk7XHJcbn07XHJcblxyXG5VdGlscy5jb25maXJtID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG9uT2ssIG9uQ2FuY2VsKSB7XHJcbiAgICB2ZXguZGlhbG9nLmNvbmZpcm0oe1xyXG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICAgICAgY2FsbGJhY2s6ICh2YWwpID0+IHtcclxuICAgICAgICAgICAgaWYodmFsKXtcclxuICAgICAgICAgICAgICAgIGlmKG9uT2spIG9uT2soKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmKG9uQ2FuY2VsKSBvbkNhbmNlbCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG5VdGlscy5yZW1vdmVDaGlsZHJlbiA9IGZ1bmN0aW9uIChteU5vZGUpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgaWYgKCFteU5vZGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB3aGlsZSAobXlOb2RlLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICBteU5vZGUucmVtb3ZlQ2hpbGQobXlOb2RlLmZpcnN0Q2hpbGQpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuVXRpbHMucHJvY2Vzc0Vycm9yID0gZnVuY3Rpb24oY2FsbGJhY2spe1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgaWYoZXJyKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYoY2FsbGJhY2spe1xyXG4gICAgICAgICAgICB2YXIgYXJyID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBhcnIucHVzaChhcmd1bWVudHNbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KG51bGwsIGFycik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5cclxuVXRpbHMuaGFuZGxlRXJyb3JNc2cgPSBmdW5jdGlvbihlcnIpe1xyXG4gICAgdmFyIGNoZWNrRXJyb3JUeXBlID0gUi5jdXJyeShmdW5jdGlvbihlcnIsIG5hbWUpe1xyXG4gICAgICAgIHJldHVybiBlcnIgaW5zdGFuY2VvZiBFcnJvcnNbbmFtZV0gfHwgKGVyci5uYW1lICYmIGVyci5uYW1lID09PSBuYW1lKVxyXG4gICAgfSk7XHJcbiAgICBpZiAoUi5rZXlzKEVycm9ycykuc29tZShjaGVja0Vycm9yVHlwZShlcnIpKSkge1xyXG4gICAgICAgIHJldHVybiBzdHJGb3JtYXQoZ2V0TDEwbihlcnIubWVzc2FnZUlkKSwgZXJyLnBhcmFtZXRlcnMpO1xyXG4gICAgfSBlbHNlIGlmKCB0eXBlb2YgZXJyID09PSAnb2JqZWN0Jyl7XHJcbiAgICAgICAgcmV0dXJuIGVyci5tZXNzYWdlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gZXJyO1xyXG4gICAgfVxyXG59O1xyXG5cclxuVXRpbHMuaGFuZGxlRXJyb3IgPSAoZXJyKSA9PiBVdGlscy5hbGVydChVdGlscy5oYW5kbGVFcnJvck1zZyhlcnIpKTtcclxuXHJcblV0aWxzLmVuYWJsZUVsID0gUi5jdXJyeShmdW5jdGlvbihlbCwgY29uZGl0aW9uKXtcclxuICAgIHZhciBrZXkgPSBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09IFwidGV4dGFyZWFcIiA/IFwicmVhZG9ubHlcIiA6IFwiZGlzYWJsZWRcIjtcclxuICAgIGlmKGNvbmRpdGlvbil7XHJcbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksa2V5KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5VdGlscy5lbmFibGUgPSBmdW5jdGlvbihyb290LCBjbGFzc05hbWUsIGNvbmRpdGlvbil7XHJcbiAgICBubDJhcnJheShyb290LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKSkubWFwKFV0aWxzLmVuYWJsZUVsKFIuX18sIGNvbmRpdGlvbikpO1xyXG59O1xyXG5cclxuVXRpbHMuY2hhck9yZEFPYmplY3QgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoZnVuY3Rpb24oYSl7XHJcbiAgICByZXR1cm4gYS5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG59KTtcclxuXHJcblV0aWxzLnJlYnVpbGRTZWxlY3RvciA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBuYW1lcyl7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIGNsZWFyRWwoc2VsZWN0b3IpO1xyXG4gICAgbmFtZXMuZm9yRWFjaChmdW5jdGlvbiAobmFtZUluZm8pIHtcclxuICAgICAgICB2YXIgb3B0aW9uID0gbWFrZUVsKFwib3B0aW9uXCIpO1xyXG4gICAgICAgIG9wdGlvbi5hcHBlbmRDaGlsZChtYWtlVGV4dChuYW1lSW5mby5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgIG9wdGlvbi52YWx1ZSA9IG5hbWVJbmZvLnZhbHVlO1xyXG4gICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICB9KTtcclxufTtcclxuXHJcblV0aWxzLnJlYnVpbGRTZWxlY3RvckFyciA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBuYW1lcyl7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIGNsZWFyRWwoc2VsZWN0b3IpO1xyXG4gICAgbmFtZXMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkge1xyXG4gICAgICAgIHZhciBvcHRpb24gPSBtYWtlRWwoXCJvcHRpb25cIik7XHJcbiAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KG5hbWUpKTtcclxuICAgICAgICBzZWxlY3Rvci5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5TdHJpbmcucHJvdG90eXBlLmVuZHNXaXRoID0gZnVuY3Rpb24gKHN1ZmZpeCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICByZXR1cm4gdGhpcy5pbmRleE9mKHN1ZmZpeCwgdGhpcy5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7XHJcbn07XHJcblxyXG52YXIgc3RyRm9ybWF0ID0gUi5jdXJyeShDb21tb25VdGlscy5zdHJGb3JtYXQpO1xyXG5cclxuZnVuY3Rpb24gZ2V0TDEwbihrZXkpe1xyXG4gICAgcmV0dXJuIEwxMG4uZ2V0VmFsdWUoa2V5KTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIGNvbnN0TDEwbihrZXkpe1xyXG4gICAgcmV0dXJuIEwxMG4uZ2V0VmFsdWUoJ2NvbnN0YW50LScgKyBrZXkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0VtcHR5IChvYmopIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgcmV0dXJuIChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLmxlbmd0aCA9PT0gMCk7XHJcbn07XHJcblxyXG52YXIgYWRkQ2xhc3MgPSBSLmN1cnJ5KGZ1bmN0aW9uKG8sIGMpe1xyXG4gICAgdmFyIHJlID0gbmV3IFJlZ0V4cChcIihefFxcXFxzKVwiICsgYyArIFwiKFxcXFxzfCQpXCIsIFwiZ1wiKVxyXG4gICAgaWYgKHJlLnRlc3Qoby5jbGFzc05hbWUpKSByZXR1cm47XHJcbiAgICBvLmNsYXNzTmFtZSA9IChvLmNsYXNzTmFtZSArIFwiIFwiICsgYykucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikucmVwbGFjZSgvKF4gfCAkKS9nLCBcIlwiKTtcclxuICAgIHJldHVybiBvO1xyXG59KTtcclxuXHJcbnZhciBhZGRDbGFzc2VzID0gUi5jdXJyeShmdW5jdGlvbihvLCBjKXtcclxuICAgIFIuYXAoW2FkZENsYXNzKG8pXSwgYyk7XHJcbiAgICByZXR1cm4gbztcclxufSk7XHJcblxyXG52YXIgckFkZENsYXNzID0gUi5jdXJyeShmdW5jdGlvbihjLCBvKXtcclxuICB2YXIgcmUgPSBuZXcgUmVnRXhwKFwiKF58XFxcXHMpXCIgKyBjICsgXCIoXFxcXHN8JClcIiwgXCJnXCIpXHJcbiAgaWYgKHJlLnRlc3Qoby5jbGFzc05hbWUpKSByZXR1cm47XHJcbiAgby5jbGFzc05hbWUgPSAoby5jbGFzc05hbWUgKyBcIiBcIiArIGMpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLnJlcGxhY2UoLyheIHwgJCkvZywgXCJcIik7XHJcbiAgcmV0dXJuIG87XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gdG9nZ2xlQ2xhc3MobywgYyl7XHJcbiAgICBpZihoYXNDbGFzcyhvLCBjKSl7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MobywgYyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGFkZENsYXNzKG8sIGMpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuZnVuY3Rpb24gaGFzQ2xhc3MobywgYyl7XHJcbiAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKFwiKF58XFxcXHMpXCIgKyBjICsgXCIoXFxcXHN8JClcIiwgXCJnXCIpXHJcbiAgICByZXR1cm4gKHJlLnRlc3Qoby5jbGFzc05hbWUpKTtcclxufTtcclxuIFxyXG52YXIgcmVtb3ZlQ2xhc3MgPSBSLmN1cnJ5KGZ1bmN0aW9uKG8sIGMpe1xyXG4gICAgdmFyIHJlID0gbmV3IFJlZ0V4cChcIihefFxcXFxzKVwiICsgYyArIFwiKFxcXFxzfCQpXCIsIFwiZ1wiKVxyXG4gICAgby5jbGFzc05hbWUgPSBvLmNsYXNzTmFtZS5yZXBsYWNlKHJlLCBcIiQxXCIpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpLnJlcGxhY2UoLyheIHwgJCkvZywgXCJcIilcclxufSk7XHJcblxyXG5mdW5jdGlvbiBzZXRDbGFzc0J5Q29uZGl0aW9uKG8sYyxjb25kaXRpb24pe1xyXG4gICAgaWYoY29uZGl0aW9uKXtcclxuICAgICAgICBhZGRDbGFzcyhvLGMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZW1vdmVDbGFzcyhvLGMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG87XHJcbn07XHJcblxyXG5mdW5jdGlvbiBnZXRFbChpZCl7XHJcbiAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIHF1ZXJ5RWwoc2VsKXtcclxuICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbCk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVscyhzZWwpe1xyXG4gICAgcmV0dXJuIG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsKSk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVsRWxzKGVsLCBzZWwpe1xyXG4gICAgcmV0dXJuIG5sMmFycmF5KGVsLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsKSk7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBnZXRFbHMoY2xhenope1xyXG4gIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXp6KTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIG1ha2VFbChlbFRhZyl7XHJcbiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZWxUYWcpO1xyXG59O1xyXG5cclxuZnVuY3Rpb24gbWFrZVRleHQodGV4dCl7XHJcbiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpO1xyXG59O1xyXG5cclxudmFyIGFkZEVsID0gUi5jdXJyeShmdW5jdGlvbihwYXJlbnQsIGNoaWxkKXtcclxuICAgIHBhcmVudC5hcHBlbmRDaGlsZChjaGlsZCk7XHJcbiAgICByZXR1cm4gcGFyZW50O1xyXG59KTtcclxudmFyIGFkZEVscyA9IFIuY3VycnkoZnVuY3Rpb24ocGFyZW50LCBjaGlsZHJlbil7XHJcbiAgICBSLmFwKFthZGRFbChwYXJlbnQpXSwgY2hpbGRyZW4pO1xyXG4gICAgcmV0dXJuIHBhcmVudDtcclxufSk7XHJcblxyXG52YXIgbWFrZU9wdCA9IGZ1bmN0aW9uKGxhYmVsKXtcclxuICAgIHZhciBvcHRpb24gPSBtYWtlRWwoXCJvcHRpb25cIik7XHJcbiAgICBhZGRFbChvcHRpb24sIChtYWtlVGV4dChsYWJlbCkpKTtcclxuICAgIHJldHVybiBvcHRpb247XHJcbn07XHJcblxyXG52YXIgckFkZEVsID0gUi5jdXJyeShmdW5jdGlvbihjaGlsZCwgcGFyZW50KXtcclxuICBwYXJlbnQuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gIHJldHVybiBwYXJlbnQ7XHJcbn0pO1xyXG5cclxudmFyIHNldEF0dHIgPSBSLmN1cnJ5KGZ1bmN0aW9uKGVsLCBuYW1lLCB2YWx1ZSl7XHJcbiAgZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcclxuICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxudmFyIHNldFN0eWxlID0gUi5jdXJyeShmdW5jdGlvbihlbCwgbmFtZSwgdmFsdWUpe1xyXG4gICAgZWwuc3R5bGVbbmFtZV0gPSB2YWx1ZTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBkZWxBdHRyKGVsLCBuYW1lKXtcclxuICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTtcclxuICAgIHJldHVybiBlbDtcclxufTtcclxuXHJcbmZ1bmN0aW9uIGdldEF0dHIoZWwsIG5hbWUpe1xyXG4gICAgcmV0dXJuIGVsLmdldEF0dHJpYnV0ZShuYW1lKTtcclxufTtcclxuXHJcbnZhciBzZXRQcm9wID0gUi5jdXJyeShmdW5jdGlvbihlbCwga2V5LCB2YWx1ZSl7XHJcbiAgZWxba2V5XSA9IHZhbHVlO1xyXG4gIHJldHVybiBlbDtcclxufSk7XHJcblxyXG52YXIgc2V0UHJvcHMgPSBSLmN1cnJ5KGZ1bmN0aW9uKGVsLCBtYXApe1xyXG4gIGZvcih2YXIga2V5IGluIG1hcCl7XHJcbiAgICBzZXRQcm9wKGVsLCBrZXksIG1hcFtrZXldKTtcclxuICB9XHJcbiAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGNsZWFyRWwoZWwpe1xyXG4gIFV0aWxzLnJlbW92ZUNoaWxkcmVuKGVsKTtcclxuICByZXR1cm4gZWw7XHJcbn07XHJcblxyXG5mdW5jdGlvbiBwYXNzRWxzKHNyYywgZHN0KXtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3JjLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgYWRkRWwoZHN0LCBzcmMuY2hpbGRyZW5baV0pO1xyXG4gICAgfVxyXG59O1xyXG5cclxudmFyIGxpc3RlbiA9IFIuY3VycnkoZnVuY3Rpb24oZWwsIGV2ZW50LCBsaXN0ZW5lcil7XHJcbiAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIpO1xyXG4gIHJldHVybiBlbDtcclxufSk7XHJcblxyXG52YXIgbGlzdGVuT25FbnRlciA9IFIuY3VycnkoZnVuY3Rpb24oZWwsIGNhbGxiYWNrKXtcclxuICAgIGxpc3RlbihlbCwgJ2tleWRvd24nLCBmdW5jdGlvbihlKSB7XHJcbiAgICAgICAgaWYgKGUua2V5Q29kZSA9PT0gMTMpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufSk7XHJcblxyXG52YXIgZmlsbFNlbGVjdG9yID0gUi5jdXJyeShmdW5jdGlvbihzZWwsIGRhdGEpe1xyXG4gICAgcmV0dXJuIGFkZEVscyhzZWwsIGRhdGEubWFwKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgdmFyIG9wdCA9IG1ha2VFbChcIm9wdGlvblwiKTtcclxuICAgICAgICBhZGRFbChvcHQsIG1ha2VUZXh0KGl0ZW0ubmFtZSkpO1xyXG4gICAgICAgIGlmKGl0ZW0udmFsdWUpe29wdC52YWx1ZSA9IGl0ZW0udmFsdWU7fVxyXG4gICAgICAgIGlmKGl0ZW0uc2VsZWN0ZWQpe29wdC5zZWxlY3RlZCA9IHRydWU7fVxyXG4gICAgICAgIGlmKGl0ZW0uY2xhc3NOYW1lKXthZGRDbGFzcyhvcHQsIGl0ZW0uY2xhc3NOYW1lKTt9XHJcbiAgICAgICAgcmV0dXJuIG9wdDtcclxuICAgIH0pKTtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBubDJhcnJheShub2RlTGlzdCl7XHJcbiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobm9kZUxpc3QpO1xyXG59O1xyXG5cclxudmFyIHJlbWFwUHJvcHMgPSBSLmN1cnJ5KGZ1bmN0aW9uKG91dEtleXMsIHBpY2tLZXlzLCBvYmope1xyXG4gICAgcmV0dXJuIFIuY29tcG9zZShSLnppcE9iaihvdXRLZXlzKSwgUi52YWx1ZXMsIFIucGljayhwaWNrS2V5cykpKG9iaik7XHJcbn0pO1xyXG5cclxudmFyIHJlbWFwUHJvcHM0U2VsZWN0MiA9IHJlbWFwUHJvcHMoWydpZCcsJ3RleHQnXSwgWyd2YWx1ZScsICdkaXNwbGF5TmFtZSddKTtcclxudmFyIHJlbWFwUHJvcHM0U2VsZWN0ID0gcmVtYXBQcm9wcyhbJ3ZhbHVlJywnbmFtZSddLCBbJ3ZhbHVlJywgJ2Rpc3BsYXlOYW1lJ10pO1xyXG5cclxudmFyIGdldFNlbGVjdDJEYXRhQ29tbW9uID0gUi5jdXJyeShmdW5jdGlvbihwcmVwYXJhdG9yLCBvYmopeyBcclxuICAgIHJldHVybiBSLmNvbXBvc2UoUi56aXBPYmooWydkYXRhJ10pLCBSLmFwcGVuZChSLl9fLCBbXSksIFIubWFwKHByZXBhcmF0b3IpKShvYmopO1xyXG59KTtcclxuXHJcbnZhciBnZXRTZWxlY3QyRGF0YSA9IGdldFNlbGVjdDJEYXRhQ29tbW9uKHJlbWFwUHJvcHM0U2VsZWN0Mik7XHJcblxyXG52YXIgbWFrZVNlbGVjdDJPcHQgPSBSLmNvbXBvc2UoUi56aXBPYmooWydpZCcsICd0ZXh0J10pLCBSLnJlcGVhdChSLl9fLCAyKSk7XHJcbnZhciBhcnIyU2VsZWN0MiA9IFIuY29tcG9zZShSLmFzc29jKCdkYXRhJywgUi5fXywge30pLCBSLm1hcChtYWtlU2VsZWN0Mk9wdCkpO1xyXG52YXIgYXJyMlNlbGVjdCA9IFIubWFwKFIuY29tcG9zZShSLnppcE9iaihbJ3ZhbHVlJywnbmFtZSddKSwgUi5yZXBlYXQoUi5fXywgMikpKTtcclxudmFyIGNvbnN0QXJyMlNlbGVjdCA9IFIubWFwKFIuY29tcG9zZShSLnppcE9iaihbJ3ZhbHVlJywnbmFtZSddKSwgKG5hbWUpID0+IFtuYW1lLCBjb25zdEwxMG4obmFtZSldKSk7XHJcblxyXG52YXIgZ2V0U2VsZWN0ZWRSYWRpbyA9IGZ1bmN0aW9uKHF1ZXJ5KXtcclxuICAgIHZhciBlbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5KTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYoZWxzW2ldLmNoZWNrZWQgPT09IHRydWUpe1xyXG4gICAgICAgICAgICByZXR1cm4gZWxzW2ldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59O1xyXG5cclxudmFyIGRlYnVnSW50ZXJjZXB0b3IgPSBmdW5jdGlvbihjYWxsYmFjayl7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24oKXtcclxuICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShhcmd1bWVudHNbMF0pKTtcclxuICAgICAgICBjYWxsYmFjay5hcHBseShudWxsLCBhcmd1bWVudHMpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuLy8gZnJvbSBkYXRlIGZvcm1hdCB1dGlsc1xyXG4vL0ZvciBjb252ZW5pZW5jZS4uLlxyXG5EYXRlLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbiAobWFzaywgdXRjKSB7XHJcbiAgICByZXR1cm4gZGF0ZUZvcm1hdCh0aGlzLCBtYXNrLCB1dGMpO1xyXG59O1xyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
