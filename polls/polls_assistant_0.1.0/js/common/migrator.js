/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 // Utils
 */

var ids = [ '0687', '2140', '2141', '2142', '2143', '2144', '2145', '2146', '2147', '2148', '2149', '2150', '2151', '2152', '2153', '2154', '2155', '2156', '2157', '2158', '2159', '2160', '2161',
        '2162', '2163', '2164', '2165', '2166', '2167', '2168', '2169', '2170', '2171', '2172', '2173', '2174', '2175', '2176', '2177', '2178', '2179', '2180', '2181', '2182', '2183', '2184', '2185' ];


var totals = {
        '2004':[-1,2019,1988,1708,2242,2125,1887,1851,2242,2121,2140,1953,2083,1960,2197,1913,2579,2559,1976,2125,2210,2293,2410,2481,2379,2314,2049,2054,2490,2848,2065,2127,2591,2035,2478,1771,1975,1426,2060,2330,2236,2365,1666,2202,1974,2087,2213],
        '2006':[-1,1892,1821,1685,2364,1893,1852,1785,2171,2073,2203,1924,2112,1973,2148,1886,2601,2425,1802,2025,2084,2178,2343,2446,2345,2286,1980,2063,2356,2776,1955,2057,2501,1982,2370,1756,2075,1407,2017,2170,2069,2343,1553,2089,1960,2040,2369],
        '2007':[-1,1984,1955,1765,2379,1998,1813,1787,2188,2176,2165,1950,2159,1956,2272,1956,2713,2547,1925,2200,2382,2214,2342,2446,2650,2340,2065,2042,2598,2782,2163,2030,2463,2093,2386,1802,2264,1580,2048,2283,2160,2405,1782,2174,1893,2080,2551],
        '2008':[-1,1972,1939,1668,2204,1957,1816,1779,2160,2134,2105,1962,2198,1957,2006,1946,2479,2558,1907,2290,2364,2209,2351,2458,2390,2329,2055,2077,2484,2803,2191,2052,2494,2145,2382,1928,2080,1636,2050,2284,2153,2367,1632,2210,1937,2106,2631],
        '2010':[861,1921,1905,1619,2222,1904,1797,1722,2117,2129,2103,1923,2233,2295,2346,1964,2492,2493,1862,2278,2116,2161,2343,2529,2358,2305,2014,2036,2505,2804,2292,2001,2433,2114,2391,1748,2077,1644,2041,2222,2087,2334,1660,2182,1899,1972,2305],
        '2012':[-1,1948,1865,1590,2202,1836,1770,1719,2129,2117,2067,1881,2329,2249,2305,2052,2459,2475,1824,2314,2190,2137,2283,2394,2335,2244,2032,1996,2514,2758,2307,1987,2352,1841,2370,1757,2143,1682,2012,2226,2033,2257,1762,2172,1860,1848,2402],
};



var marks = {

    '10' : {
        '2004' : [ -1, 60, 60, -1, 38, 39, 73, 76, 45, -1, 98, 61, 70, -1, -1, -1, -1, 65, 100, 60, 62, 56, 55, 70, -1, -1, -1, -1, 78, -1, 72, -1, 86, 57, 58, 49, 83, -1, 68, 63, -1, 64, -1, -1, -1,
                -1, -1 ],
        '2006' : [ -1, 85, 63, 88, 89, 94, 83, 64, 95, 76, 90, 102, 80, 70, 75, 81, 103, 101, 84, 60, 63, 88, 76, 82, 75, 73, 66, 75, 105, 115, 70, 89, 116, 81, 85, 90, 45, 38, 88, 100, 88, 110, 53,
                73, 45, 45, 80 ],
        '2007' : [ -1, 160, 140, 170, 184, 200, 157, 130, 193, 194, 201, 175, 204, 120, 179, 107, 320, 230, 152, 145, 189, 160, 222, 175, 247, 167, 184, 185, 224, 252, 221, 165, 172, 203, 180, 160,
                191, 136, 204, 190, 204, 212, 120, 243, 146, 231, 178 ],
        '2008' : [ -1, 135, 125, 120, 107, 195, 110, 153, 157, 165, 196, 160, 150, 125, 139, 100, 110, 168, 155, 160, 201, 153, 245, 193, 184, 186, 146, 124, 180, 258, 155, 125, 160, 150, 143, 167,
                89, 107, 176, 200, 246, 160, 112, 190, 148, 166, 156 ],
        '2010' : [ 54, 112, 71, 70, 100, 85, 93, 84, 105, 92, 106, 123, 103, 113, 83, 58, 126, 106, 96, 90, 105, 90, 102, 122, 100, 101, 97, 95, 143, 142, 69, 113, 113, 88, 127, 81, 70, 68, 125, 150,
                105, 82, 60, 124, 98, 88, 98 ],
        '2012' : [ -1, 138, 118, 100, 154, 121, 162, 140, 131, 137, 172, 167, 165, 165, 161, 128, 220, 158, 91, 98, 137, 147, 118, 135, 145, 153, 113, 122, 166, 190, 150, 130, 121, 142, 147, 186,
                149, 98, 165, 185, 139, 121, 98, 107, 110, 69, 173 ],
    },
    '12' : {
        '2004' : [ -1, 320, 240, 246, 194, 301, 318, 310, 276, 315, 302, 246, 255, 250, 317, 210, 310, 360, 315, 350, 251, 300, 330, 373, 390, 347, 309, 292, 305, 387, 280, 278, 358, 245, 307, 240,
                260, 161, 310, 310, 229, 250, 265, 444, 173, 369, 267 ],
        '2006' : [ -1, 266, 238, 260, 282, 247, 291, 259, 284, 300, 300, 251, 270, 272, 270, 249, 322, 346, 283, 230, 292, 312, 308, 332, 250, 248, 258, 258, 363, 315, 253, 310, 369, 250, 269, 284,
                216, 140, 299, 363, 266, 312, 203, 183, 148, 228, 251 ],
        '2007' : [ -1, 605, 536, 510, 595, 650, 511, 476, 660, 633, 651, 527, 600, 515, 560, 440, 800, 766, 579, 571, 674, 615, 676, 714, 610, 593, 503, 526, 618, 639, 585, 620, 703, 575, 631, 550,
                550, 430, 660, 700, 727, 750, 380, 669, 522, 693, 669 ],
        '2008' : [ -1, 480, 430, 444, 367, 507, 425, 484, 532, 500, 520, 460, 475, 425, 482, 409, 640, 545, 460, 463, 500, 540, 558, 601, 535, 540, 482, 425, 530, 686, 487, 520, 623, 503, 507, 500,
                444, 317, 529, 510, 547, 600, 391, 669, 435, 578, 535 ],
        '2010' : [ 152, 362, 274, 302, 294, 374, 312, 293, 345, 369, 372, 353, 400, 350, 335, 240, 422, 450, 372, 265, 393, 382, 439, 413, 350, 352, 327, 297, 446, 442, 333, 400, 450, 289, 383, 302,
                280, 217, 390, 480, 346, 394, 194, 453, 307, 312, 357 ],
        '2012' : [ -1, 495, 642, 375, 487, 550, 437, 464, 497, 620, 554, 550, 620, 550, 617, 454, 695, 658, 532, 434, 622, 556, 539, 570, 574, 538, 460, 432, 555, 621, 714, 499, 492, 426, 586, 502,
                517, 340, 625, 620, 546, 556, 377, 329, 442, 285, 654 ],
    },
    '14' : {
        '2004' : [ -1, 660, 580, 554, 514, 720, 635, 565, 628, 675, 663, 546, 560, 575, 632, 516, 684, 770, 610, 555, 634, 666, 820, 794, 786, 709, 667, 620, 730, 880, 585, 729, 750, 519, 657, 550,
                534, 335, 664, 738, 529, 650, 461, 840, 737, 743, 623 ],
        '2006' : [ -1, 506, 439, 460, 631, 458, 475, 449, 489, 536, 535, 420, 480, 468, 530, 422, 557, 564, 522, 380, 580, 541, 545, 576, 470, 443, 443, 474, 607, 574, 468, 536, 611, 424, 518, 475,
                436, 260, 507, 574, 513, 530, 301, 324, 317, 375, 512 ],
        '2007' : [ -1, 935, 930, 889, 1017, 1005, 857, 838, 1030, 1062, 1055, 924, 997, 860, 1018, 781, 1300, 1182, 982, 1000, 1080, 1027, 1163, 1172, 1120, 1104, 958, 1004, 1160, 1251, 967, 1025,
                1210, 945, 1057, 895, 932, 671, 1047, 1080, 1091, 1231, 618, 1087, 894, 896, 1212 ],
        '2008' : [ -1, 800, 770, 730, 707, 835, 751, 637, 843, 805, 846, 800, 860, 700, 887, 698, 1043, 936, 715, 861, 940, 883, 965, 967, 886, 897, 783, 761, 880, 1124, 844, 860, 1066, 832, 893,
                849, 791, 521, 896, 775, 855, 999, 601, 961, 826, 892, 949 ],
        '2010' : [ 248, 647, 553, 485, 507, 561, 538, 549, 588, 645, 580, 570, 650, 640, 594, 442, 703, 685, 592, 462, 685, 662, 673, 704, 629, 598, 545, 550, 673, 732, 608, 682, 828, 496, 612, 538,
                511, 355, 668, 750, 591, 711, 344, 682, 564, 539, 657 ],
    },
    '16' : {
        '2004' : [ -1, 955, 800, 716, 759, 1031, 881, 805, 819, 934, 900, 764, 830, 815, 885, 742, 986, 1030, 888, 844, 1042, 940, 1050, 1050, 1060, 928, 859, 868, 1010, 1160, 805, 997, 1142, 701,
                902, 773, 701, 902, 915, 960, 780, 895, 619, 1095, 990, 964, 892 ],
        '2006' : [ -1, 656, 572, 535, 838, 561, 592, 565, 600, 655, 690, 518, 620, 603, 700, 539, 697, 697, 644, 503, 737, 700, 672, 713, 600, 561, 571, 573, 771, 714, 591, 762, 819, 547, 635, 623,
                575, 303, 650, 740, 641, 735, 350, 430, 382, 459, 670 ],
        '2007' : [ -1, 1200, 1182, 1112, 1292, 1250, 1054, 1046, 1234, 1348, 1357, 1192, 1300, 1150, 1374, 1120, 1620, 1460, 1195, 1420, 1385, 1320, 1424, 1444, 1514, 1358, 1208, 1245, 1503, 1587,
                1364, 1283, 1606, 1171, 1312, 1170, 1309, 812, 1340, 1420, 1363, 1517, 782, 1375, 1128, 1240, 1549 ],
        '2008' : [ -1, 1080, 1035, 940, 945, 1090, 981, 943, 1103, 1200, 1147, 1018, 1150, 1035, 1192, 973, 1358, 1155, 1074, 1087, 1448, 1130, 1239, 1273, 1247, 1189, 1034, 1049, 1180, 1506, 1194,
                1175, 1465, 1143, 1180, 1172, 1044, 716, 1185, 1218, 1069, 1265, 697, 1218, 1082, 1111, 1339 ],
        '2010' : [ 304, 805, 678, 604, 652, 685, 654, 617, 720, 829, 730, 691, 800, 770, 743, 585, 865, 834, 734, 626, 816, 776, 808, 830, 757, 754, 680, 665, 816, 912, 813, 811, 992, 624, 801, 617,
                616, 438, 845, 862, 703, 879, 394, 786, 665, 643, 799 ],
    },
    '18' : {
        '2004' : [ -1, 1088, 989, -1, 914, 1167, 1037, 930, 976, -1, 1080, 919, 990, -1, -1, -1, -1, 1160, 1019, 984, 1334, 1146, 1160, 1198, -1, -1, -1, -1, 1209, -1, 970, -1, 1356, 830, 1112, 842,
                849, -1, 1097, 1140, -1, 1041, -1, -1, -1, -1, -1 ],
        '2006' : [ -1, 728, 654, 613, 951, 615, 678, 621, 704, 776, 800, 600, 740, 700, 800, 636, 813, 864, 734, 570, 830, 798, 812, 798, 720, 663, 652, 680, 887, 871, 695, 775, 945, 601, 733, 754,
                683, 353, 758, 860, 751, 874, 410, 535, 429, 514, 836 ],
        '2007' : [ -1, 1322, 1327, 1171, 1442, 1360, 1212, 1166, 1357, 1442, 1462, 1280, 1400, 1260, 1495, 1225, 1761, 1569, 1252, 1420, 1489, 1412, 1556, 1554, 1751, 1451, 1290, 1337, 1739, 1763,
                1446, 1408, 1724, 1278, 1466, 1268, 1425, 906, 1475, 1560, 1380, 1637, 980, 1615, 1227, 1329, 1684 ],
        '2008' : [ -1, 1181, 1122, 1023, 1148, 1186, 1064, 1045, 1252, 1300, 1300, 1140, 1291, 1160, 1324, 1074, 1503, 1654, 1163, 1241, 1570, 1164, 1320, 1367, 1300, 1273, 1147, 1177, 1328, 1661,
                1335, 1281, 1623, 1143, 1256, 1263, 1152, 750, 1310, 1386, 1218, 1411, 798, 1356, 1174, 1270, 1534 ],
        '2010' : [ 343, 840, 738, 670, 767, 754, 757, 687, 790, 911, 805, 759, 910, 850, 838, 652, 953, 990, 817, 716, 891, 880, 891, 934, 851, 842, 752, 723, 892, 1001, 937, 902, 1101, 710, 907,
                730, 698, 479, 947, 960, 783, 981, 422, 901, 723, 728, 882 ],
    },
    '20' : {
        '2004' : [ -1, 1181, 1073, 925, 1055, 1247, 1116, 1002, 1080, 1182, 1190, 1036, 1100, 1060, 1159, 1039, 1254, 1256, 1094, 1050, 1457, 1268, 1250, 1302, 1300, 1196, 1024, 1095, 1340, 1507,
                1059, 1221, 1497, 939, 1205, 970, 918, 609, 1199, 1260, 1079, 1200, 761, 1310, 1161, 1210, 1170 ],
        '2006' : [ -1, 810, 760, 665, 951, 675, 732, 662, 768, 862, 880, 692, 814, 802, 902, 690, 956, 904, 783, 657, 800, 867, 868, 869, 834, 709, 693, 752, 960, 948, 746, 836, 1007, 665, 774, 796,
                753, 398, 800, 929, 821, 949, 457, 608, 501, 647, 964 ],
    },
};


"use strict";

(function(exports) {
    
    var exists = function(data, prefix, key){
        console.log(prefix + '.' + key + ': ' + (data[key] !== undefined ? "OK" : "undefined"));
    };
    
	exports.migrate = function(data) {
	    exists(data, 'base', 'Stories');
	    
		if (!data.Version) {

			data.Settings = {};

			var story, storyCharacters;
			Object.keys(data.Stories).forEach(function(storyName) {
				story = data.Stories[storyName];
				storyCharacters = Object.keys(story.characters);
				storyCharacters.forEach(function(character) {
					story.characters[character].activity = {};
				});

			});

			data.Version = "0.0.4";
		}
		if (data.Version === "0.0.4") { // new versioning rule
			data.Version = "0.4.1";
		}
		if(data.Version === "0.4.1"){ // new 
		    delete data.Settings["Events"];
		    data.Version = "0.4.3";
		}
		if(data.Version === "0.4.3"){
		    data.Log = [];
		    data.Version = "0.4.4";
		    data.Meta.saveTime = new Date();
		}
		if(data.Version === "0.4.4"){
		    var char, story;
		    Object.keys(data.Characters).forEach(function(charName) {
		        char = data.Characters[charName];
		        delete char.displayName;
		    });
		    Object.keys(data.Stories).forEach(function(storyName) {
                story = data.Stories[storyName];
                delete story.displayName;
		    });
		    data.Version = "0.4.4u1";
		}
		
		exists(data, 'base', 'Characters');
		exists(data, 'base', 'ProfileSettings');
		exists(data, 'base', 'Meta');
		exists(data, 'base', 'Log');
		exists(data.Meta, 'base.Meta', 'name');
		exists(data.Meta, 'base.Meta', 'date');
		exists(data.Meta, 'base.Meta', 'preGameDate');
		exists(data.Meta, 'base.Meta', 'description');
		exists(data.Meta, 'base.Meta', 'saveTime');
		
//		for(var storyName in totals){
//		    ids.forEach(function(id,i){
//		        data.Stories[storyName].electors[id].total = totals[storyName][i];
//		    });
//		}
//		
//		for(var mark in marks){
//		    for(var storyName in marks[mark]){
//		        ids.forEach(function(id,i){
//	                data.Stories[storyName].electors[id][mark] = marks[mark][storyName][i];
//	            });
//		    }
//		}
		
		return data;
	};
	
})(typeof exports === 'undefined' ? this['Migrator'] = {} : exports);
