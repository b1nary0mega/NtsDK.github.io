/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

function makeLocalDBMS(fullVersion) {
    const opts = {
        Migrator,
        CommonUtils,
        EventEmitter,
        Precondition,
        R,
        Ajv,
        Schema,
        Errors,
        listeners: {},
        Constants,
        dbmsUtils: {},
        dateFormat,
    };

    function LocalDBMS() {
        this._init(opts.listeners);
    }

    LocalDBMS.prototype.getSettings = () => this.database.Settings;

    const func = name => window[name](LocalDBMS, opts);

    [
        'baseAPI',
        'consistencyCheckAPI',
        'logAPI',
        'charsheetAPI',
        'settingsAPI',
    ].map(func);

    Logger.attachLogCalls(LocalDBMS, R, false);
    return LocalDBMS;
}

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};

    exports.init = (callback) => {
        state.callback = callback;
    };

    exports.makeNewBase = () => {
        Utils.confirm(getL10n('utils-new-base-warning'), () => {
            DBMS.setDatabase(CommonUtils.clone(EmptyBase.data), state.callback);
        });
    };

    exports.openHelp = () => {
        window.open('extras/doc/nims.html');
    };

    exports.readSingleFile = (evt) => {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                const contents = e.target.result;
                const database = JSON.parse(contents);
                DBMS.setDatabase(database, state.callback);
            };
            r.readAsText(f);
        } else {
            Utils.alert(getL10n('utils-base-file-loading-error'));
        }
    };

    exports.saveFile = () => {
        DBMS.getDatabase((err, database) => {
            if (err) { Utils.handleError(err); return; }
            exports.json2File(database, `${BASE_FILE_NAME}.json`);
        });
    };

    exports.json2File = (str, fileName) => {
        exports.str2File(JSON.stringify(str, null, '  '), fileName);
    };

    exports.str2File = (str, fileName) => {
        const blob = new Blob([str], {
            type: 'text/plain;charset=utf-8'
        });
        saveAs(blob, fileName);
    };
})(this.FileUtils = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports, Dictionaries) => {
    const state = {};

    state.initialized = false;
    state.l10nDelegates = [];
    state.dictionaries = {};
    state.lang = defaultLang;

    const init = () => {
        if (state.initialized) {
            return;
        }
        //        console.log(navigator.language);

        state.dictionaries = R.map(processDictionary, Dictionaries);

        //    var lang = (navigator.languages ? navigator.languages[0] : navigator.browserLanguage).split('-')[0];
        //    var lang = 'ru';
        //        var lang = defaultLang;
        //        console.log(lang);

        if (state.dictionaries[defaultLang]) {
            state.dict = state.dictionaries[defaultLang];
        } else {
            state.dict = state.dictionaries.en;
        }
        setHtmlLang(defaultLang);
        exports.onL10nChange(exports.localizeStatic);
        state.initialized = true;
    };

    var processDictionary = (dictionary) => {
        const processedDictionary = {};
        R.toPairs(dictionary).forEach(([sectionName, section]) => {
            R.toPairs(section).forEach(([key, value]) => {
                processedDictionary[`${sectionName}-${key}`] = value;
            });
        });
        //        for (const sectionName in dictionary) {
        //            for (const name in dictionary[sectionName]) {
        //                processedDictionary[`${sectionName}-${name}`] = dictionary[sectionName][name];
        //            }
        //        }
        return processedDictionary;
    };

    var setHtmlLang = lang => setAttr(document.getElementsByTagName('html')[0], 'lang', lang);

    exports.toggleL10n = () => {
        if (state.lang === 'ru') {
            state.dict = state.dictionaries.en;
            state.lang = 'en';
        } else {
            state.dict = state.dictionaries.ru;
            state.lang = 'ru';
        }
        setHtmlLang(state.lang);
        state.l10nDelegates.forEach((delegate) => {
            delegate();
        });
    };

    exports.getLang = () => state.lang.toLowerCase();

    exports.format = R.curry((namespace, name, args) => strFormat(exports.get(namespace, name), args));

    exports.get = R.curry((namespace, name) => L10n.getValue(`${namespace}-${name}`));

    exports.getValue = (name) => {
        const value = state.dict[name];
        if (value === undefined) console.log(`Value is not found: ${name}`);
        return value || `${name}:RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA`;
    };

    exports.onL10nChange = (delegate) => {
        state.l10nDelegates.push(delegate);
    };

    exports.localizeStatic = () => {
        init();
        nl2array(document.querySelectorAll('[l10n-id]')).map(el => addEl(clearEl(el), makeText(exports.getValue(getAttr(el, 'l10n-id')))));
        nl2array(document.querySelectorAll('[l10n-placeholder-id]')).map(el => setAttr(el, 'placeholder', exports.getValue(getAttr(el, 'l10n-placeholder-id'))));
    };
})(this.L10n = {}, Dictionaries);

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports) => {
    exports.initTabPanel = (tabClazz, containerClazz) => {
        const containers = getEls(containerClazz);

        let i;
        for (i = 1; i < containers.length; i++) { // don't hide 1st element
            addClass(containers[i], 'hidden');
        }

        const tabButtons = getEls(tabClazz);

        addClass(tabButtons[0], 'active');

        for (i = 0; i < tabButtons.length; i++) {
            listen(tabButtons[i], 'click', tabButtonClick(tabButtons, containers));
        }
    };

    var tabButtonClick = (buttons, containers) => (event) => {
        for (let i = 0; i < buttons.length; i++) {
            setClassByCondition(buttons[i], 'active', event.target.id === buttons[i].id);
        }
        for (let i = 0; i < containers.length; i++) {
            setClassByCondition(containers[i], 'hidden', `${event.target.id}Container` !== containers[i].id);
        }
    };

    exports.fillShowItemSelector = (selector, displayArray) => {
        let el;
        setAttr(selector, 'size', displayArray.length);
        displayArray.forEach((value) => {
            el = setProps(makeEl('option'), {
                selected: true,
            });
            setClassByCondition(el, 'hidden', value.hidden);
            addEl(selector, addEl(el, makeText(value.name)));
        });
    };

    exports.fillShowItemSelector2 = (selector, optionGroups) => {
        let el, groupEl, counter = 0;
        addEls(selector, optionGroups.map((group) => {
            counter++;
            groupEl = setAttr(makeEl('optgroup'), 'label', group.name);
            addEls(groupEl, group.array.map((value) => {
                el = setProps(makeEl('option'), {
                    selected: true,
                });
                setClassByCondition(el, 'hidden', value.hidden);
                counter += (value.hidden ? 0 : 1);
                return addEl(el, makeText(value.name));
            }));
            return groupEl;
        }));
        setAttr(selector, 'size', counter);
    };

    exports.showSelectedEls = classKey => (event) => {
        const el = event.target;
        let els, i, j;
        for (i = 0; i < el.options.length; i += 1) {
            els = getEls(i + classKey);
            for (j = 0; j < els.length; j++) {
                setClassByCondition(els[j], 'hidden', !el.options[i].selected);
            }
        }
    };

    exports.initSelectorFilters = () => {
        const elems = document.querySelectorAll('[selector-filter]');
        let el, sel;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            sel = queryEl(getAttr(el, 'selector-filter'));
            el.value = '';
            listen(el, 'input', filterOptions(sel));
        }
    };

    var filterOptions = sel => (event) => {
        let val = event.target.value;
        let i, opt;
        val = CommonUtils.globStringToRegex(val.trim().toLowerCase());
        for (i = 0; i < sel.options.length; i += 1) {
            opt = sel.options[i];
            const isVisible = opt.innerHTML.toLowerCase().search(val) !== -1;
            if (!isVisible) {
                opt.selected = false;
            }
            setClassByCondition(opt, 'hidden', !isVisible);
            //                setClassByCondition(opt, "hidden", opt.innerHTML.toLowerCase().search(val) === -1);
        }
        sel.dispatchEvent(new Event('change'));
    };

    exports.initPanelTogglers = () => {
        const elems = document.querySelectorAll('[panel-toggler]');
        let el, sel, attr;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            attr = getAttr(el, 'panel-toggler');
            sel = document.querySelector(attr);
            if (sel == null) {
                Utils.alert(`Panel toggler is broken: ${attr}`);
            }
            listen(el, 'click', exports.togglePanel(sel));
        }
    };

    exports.togglePanel = sel => (event) => {
        toggleClass(sel, 'hidden');
    };

    exports.makeEventTimePicker = (opts) => {
        const input = makeEl('input');
        R.ap([addClass(input)], opts.extraClasses);
        addClass(input, 'eventTime');
        input.value = opts.eventTime;

        input.eventIndex = opts.index;

        const pickerOpts = {
            lang: L10n.getLang(),
            mask: true,
            startDate: new Date(opts.preGameDate),
            endDate: new Date(opts.date),
            onChangeDateTime: opts.onChangeDateTimeCreator(input),
        };

        if (opts.eventTime !== '') {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, 'defaultDate');
        }

        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };

    // bug about setting 0900 years in Braavos game is event date. Fixed in production.
    //  exports.makeEventTimePicker = function (opts) {
    //      var input = makeEl("input");
    //      R.ap([addClass(input)], opts.extraClasses);
    //      addClass(input, "eventTime");
    //      input.value = opts.eventTime;
    //
    //      input.eventIndex = opts.index;
    //
    //      var pickerOpts = {
    //          lang : L10n.getLang(),
    //          mask : true,
    //          startDate : new Date(opts.preGameDate),
    //          endDate : new Date(opts.date),
    //          onChangeDateTime : opts.onChangeDateTimeCreator(input),
    //      };
    //
    //      var picker = jQuery(input).datetimepicker(pickerOpts);
    //
    //      var value;
    //      if (opts.eventTime !== "") {
    //          value = new Date(opts.eventTime);
    //      } else {
    //          value = opts.date;
    //          addClass(input, "defaultDate");
    //      }
    //
    //      picker.value = value;
    //
    //
    //      return input;
    //  };

    exports.resizeTextarea = (ev) => {
        const that = ev.target;
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.resizeTextarea2 = (that) => {
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.makeAdaptationTimeInput = (storyName, event, characterName, isEditable) => {
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        addClass(input, 'adaptationTimeInput');
        input.value = event.characters[characterName].time;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        listen(input, 'change', onChangePersonalTimeDelegate);
        return input;
    };

    var onChangePersonalTimeDelegate = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const time = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'time', time, Utils.processError());
    };

    exports.makeAdaptationReadyInput = (storyName, event, characterName, isEditable) => {
        const div = makeEl('div');
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        input.type = 'checkbox';
        input.checked = event.characters[characterName].ready;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        input.id = `${event.index}-${storyName}-${characterName}`;
        listen(input, 'change', onChangeReadyStatus);
        addEl(div, input);

        addEl(div, setAttr(addEl(makeEl('label'), makeText(constL10n(Constants.finishedText))), 'for', input.id));
        return div;
    };

    var onChangeReadyStatus = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const value = event.target.checked;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'ready', value, Utils.processError());
    };

    exports.makePanelCore = (title, content) => {
        const panel = addClasses(makeEl('div'), ['panel', 'panel-default']);
        const h3 = addClass(addEl(makeEl('h3'), title), 'panel-title');
        const a = setAttr(makeEl('a'), 'href', '#/');
        const headDiv = addClass(makeEl('div'), 'panel-heading');
        addEl(panel, addEl(headDiv, addEl(a, h3)));
        const contentDiv = addClass(makeEl('div'), 'panel-body');
        addEl(panel, addEl(contentDiv, content));
        return {
            panel,
            contentDiv,
            a
        };
    };

    exports.makeProfileTable = (profileStructure, profile) => {
        let value;
        const profileDiv = addEls(makeEl('tbody'), profileStructure.filter(element => element.doExport).map((element) => {
            switch (element.type) {
            case 'text':
                value = addClass(makeEl('span'), 'briefingTextSpan');
                addEl(value, makeText(profile[element.name]));
                break;
            case 'enum':
            case 'multiEnum':
            case 'number':
            case 'string':
                value = makeText(profile[element.name]);
                break;
            case 'checkbox':
                value = makeText(constL10n(Constants[profile[element.name]]));
                break;
            default:
                throw new Error(`Unexpected type ${element.type}`);
            }
            return exports.makeTableRow(makeText(element.name), value);
        }));
        return addEl(addClasses(makeEl('table'), ['table', 'table-striped']), profileDiv);
    };

    exports.makeTableRow = (col1, col2) => addEls(makeEl('tr'), [addEl(makeEl('td'), col1), addEl(makeEl('td'), col2)]);
})(this.UI = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

// TODO need to lint utils with NIMS fixes
/* eslint-disable */

const strFormat = R.curry(CommonUtils.strFormat);

function getL10n(key) {
    return L10n.getValue(key);
}

function constL10n(key) {
    return L10n.getValue(`constant-${key}`);
}

function isEmpty(obj) {
    return (Object.getOwnPropertyNames(obj).length === 0);
}

const addClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    if (re.test(o.className)) return o;
    o.className = (`${o.className} ${c}`).replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
    return o;
});

const addClasses = R.curry((o, c) => {
    R.ap([addClass(o)], c);
    return o;
});

const rAddClass = R.curry((c, o) => addClass(o, c));

function hasClass(o, c) {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    return (re.test(o.className));
}

const removeClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    o.className = o.className.replace(re, '$1').replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
});

const toggleClass = R.curry((o, c) => {
    if (hasClass(o, c)) {
        removeClass(o, c);
    } else {
        addClass(o, c);
    }
});

function setClassByCondition(o, c, condition) {
    if (condition) {
        addClass(o, c);
    } else {
        removeClass(o, c);
    }
    return o;
}

function getEl(id) {
    return document.getElementById(id);
}

function queryEl(sel) {
    return document.querySelector(sel);
}

function queryEls(sel) {
    return nl2array(document.querySelectorAll(sel));
}

function queryElEls(el, sel) {
    return nl2array(el.querySelectorAll(sel));
}

function getEls(clazz) {
    return document.getElementsByClassName(clazz);
}

function makeEl(elTag) {
    return document.createElement(elTag);
}

function makeText(text) {
    return document.createTextNode(text);
}

const addEl = R.curry((parent, child) => {
    parent.appendChild(child);
    return parent;
});
const addEls = R.curry((parent, children) => {
    R.ap([addEl(parent)], children);
    return parent;
});

const makeOpt = function (label) {
    const option = makeEl('option');
    addEl(option, (makeText(label)));
    return option;
};

const rAddEl = R.curry((child, parent) => {
    parent.appendChild(child);
    return parent;
});


const setAttr = R.curry((el, name, value) => {
    el.setAttribute(name, value);
    return el;
});

const setStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value);
    return el;
});

const setImportantStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value, 'important');
    return el;
});

function delAttr(el, name) {
    el.removeAttribute(name);
    return el;
}

function getAttr(el, name) {
    return el.getAttribute(name);
}

const setProp = R.curry((el, key, value) => {
    el[key] = value;
    return el;
});

const setProps = R.curry((el, map) => {
    for (const key in map) {
        setProp(el, key, map[key]);
    }
    return el;
});

function clearEl(el) {
    Utils.removeChildren(el);
    return el;
}

function passEls(src, dst) {
    for (let i = 0; i < src.children.length; i++) {
        addEl(dst, src.children[i]);
    }
}

const listen = R.curry((el, event, listener) => {
    el.addEventListener(event, listener);
    return el;
});

const listenOnEnter = R.curry((el, callback) => {
    listen(el, 'keydown', (e) => {
        if (e.keyCode === 13) {
            callback();
        }
    });
});

const fillSelector = R.curry((sel, data) => addEls(sel, data.map((item) => {
    const opt = makeEl('option');
    addEl(opt, makeText(item.name));
    if (item.value) { opt.value = item.value; }
    if (item.selected) { opt.selected = true; }
    if (item.className) { addClass(opt, item.className); }
    return opt;
})));

function nl2array(nodeList) {
    return Array.prototype.slice.call(nodeList);
}

const remapProps = R.curry((outKeys, pickKeys, obj) => R.compose(R.zipObj(outKeys), R.values, R.pick(pickKeys))(obj));

const remapProps4Select2 = remapProps(['id', 'text'], ['value', 'displayName']);
const remapProps4Select = remapProps(['value', 'name'], ['value', 'displayName']);

const getSelect2DataCommon = R.curry((preparator, obj) => R.compose(R.zipObj(['data']), R.append(R.__, []), R.map(preparator))(obj));

const getSelect2Data = getSelect2DataCommon(remapProps4Select2);

const makeSelect2Opt = R.compose(R.zipObj(['id', 'text']), R.repeat(R.__, 2));
const arr2Select2 = R.compose(R.assoc('data', R.__, {}), R.map(makeSelect2Opt));
const arr2Select = R.map(R.compose(R.zipObj(['value', 'name']), R.repeat(R.__, 2)));
const constArr2Select = R.map(R.compose(R.zipObj(['value', 'name']), name => [name, constL10n(name)]));

const getSelectedRadio = function (query) {
    const els = document.querySelectorAll(query);
    for (let i = 0; i < els.length; i++) {
        if (els[i].checked === true) {
            return els[i];
        }
    }
    return null;
};

const debugInterceptor = function (callback) {
    return function () {
        console.log(JSON.stringify(arguments[0]));
        callback(...arguments);
    };
};

const Utils = {};

/** opts
    tooltip - add tooltip to button, used for iconic buttons
    id - set button id
    mainPage - enable view as first page
    toggle - toggle content, associated with button
*/
Utils.addView = function (containers, name, view, opts2) {
    const opts = opts2 || {};
    view.init();
    const buttonClass = 'navigation-button';
    containers.root.views[name] = view;
    const button = makeEl('button');
    function delegate() {
        $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
    }
    if (opts.tooltip) {
        L10n.onL10nChange(delegate);
        $(button).tooltip({
            title: L10n.getValue(`header-${name}`),
            placement: 'bottom'
        });
    } else {
        addEl(button, makeText(L10n.getValue(`header-${name}`)));
        setAttr(button, 'l10n-id', `header-${name}`);
    }
    addClass(button, buttonClass);
    addClass(button, `-test-${name}`);
    addClass(button, `-toggle-class-${name}`);
    if (opts.clazz) {
        addClass(button, opts.clazz);
    }
    containers.navigation.appendChild(button);

    const onClickDelegate = function (view2) {
        return function (evt) {
            //Tests.run();
            const elems = containers.navigation.getElementsByClassName(buttonClass);
            if (opts.toggle) {
                const els = getEls(`-toggle-class-${name}`);
                for (let i = 0; i < els.length; i++) {
                    if (evt.target.isEqualNode(els[i])) {
                        continue;
                    }
                    if (hasClass(els[i], 'active')) {
                        els[i].click();
                    }
                }
            }

            const isActive = hasClass(evt.target, 'active');
            for (let i = 0; i < elems.length; i++) {
                removeClass(elems[i], 'active');
            }
            if (!opts.toggle || (opts.toggle && !isActive)) {
                addClass(evt.target, 'active');

                passEls(containers.content, getEl('warehouse'));
                containers.content.appendChild(view2.content);
                removeClass(containers.content, 'hidden');
                containers.root.currentView = view2;
                view2.refresh();
            } else {
                removeClass(evt.target, 'active');
                passEls(containers.content, getEl('warehouse'));
                containers.root.currentView = null;
                addClass(containers.content, 'hidden');
            }
        };
    };

    button.addEventListener('click', onClickDelegate(view));
    if (opts.mainPage) {
        addClass(button, 'active');
        containers.content.appendChild(view.content);
        containers.root.currentView = view;
    }
};

Utils.alert = function (message) {
    vex.dialog.alert(message);
};

Utils.confirm = function (message, onOk, onCancel) {
    vex.dialog.confirm({
        message,
        callback: (val) => {
            if (val) {
                if (onOk) onOk();
            } else if (onCancel) onCancel();
        }
    });
};

Utils.removeChildren = function (myNode) {
    if (!myNode) {
        return;
    }
    while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
    }
};

Utils.processError = function (callback) {
    return function (err) {
        if (err) {
            Utils.handleError(err);
            return;
        }

        if (callback) {
            const arr = [];
            for (let i = 1; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            callback(...arr);
        }
    };
};

Utils.handleErrorMsg = function (err) {
    const checkErrorType = R.curry((err2, name) => err2 instanceof Errors[name] || (err2.name && err2.name === name));
    if (R.keys(Errors).some(checkErrorType(err))) {
        return strFormat(getL10n(err.messageId), err.parameters);
    } else if (typeof err === 'object') {
        return err.message;
    }
    return err;
};

Utils.handleError = err => Utils.alert(Utils.handleErrorMsg(err));

Utils.enableEl = R.curry((el, condition) => {
    const key = el.tagName.toLowerCase() === 'textarea' ? 'readonly' : 'disabled';
    if (condition) {
        el.removeAttribute(key);
    } else {
        el.setAttribute(key, key);
    }
});

Utils.enable = function (root, className, condition) {
    nl2array(root.getElementsByClassName(className)).map(Utils.enableEl(R.__, condition));
};

Utils.charOrdAObject = CommonUtils.charOrdAFactory(a => a.displayName.toLowerCase());

Utils.rebuildSelector = function (selector, names) {
    clearEl(selector);
    names.forEach((nameInfo) => {
        const option = makeEl('option');
        option.appendChild(makeText(nameInfo.displayName));
        option.value = nameInfo.value;
        selector.appendChild(option);
    });
};

Utils.rebuildSelectorArr = function (selector, names) {
    clearEl(selector);
    names.forEach((name) => {
        const option = makeEl('option');
        option.appendChild(makeText(name));
        selector.appendChild(option);
    });
};

String.prototype.endsWith = function (suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

// from date format utils
//For convenience...
Date.prototype.format = function (mask, utc) {
    return dateFormat(this, mask, utc);
};

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};
    state.views = {};

    const btnOpts = {
        tooltip: true,
        className: 'mainNavButton'
    };

    exports.onMasterPageLoad = () => {
        initPage();
        const LocalDBMS = makeLocalDBMS(true);
        if (MODE === 'Standalone') {
            window.DBMS = new LocalDBMS();
            DBMS.setDatabase(BaseExample.data, (err) => {
                if (err) { Utils.handleError(err); return; }
                consistencyCheck(onDatabaseLoad);
            });
        } else if (MODE === 'NIMS_Server') {
            const RemoteDBMS = makeRemoteDBMS(LocalDBMS);
            window.DBMS = new RemoteDBMS();
            consistencyCheck(onDatabaseLoad);
        }
    };

    function onDatabaseLoad() {
        //        initTheme();

        stateInit();

        Utils.addView(state.containers, 'charsheet', Charsheet, { mainPage: true });
        Utils.addView(state.containers, 'instruction', Instruction);

        addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

        const button = makeButton('dataLoadButton', 'open-database', null, btnOpts);
        button.addEventListener('change', FileUtils.readSingleFile, false);

        const input = makeEl('input');
        input.type = 'file';
        addClass(input, 'hidden');
        setAttr(input, 'tabindex', -1);
        button.appendChild(input);
        button.addEventListener('click', (e) => {
            input.value = '';
            input.click();
        });
        addEl(state.navigation, button);

        //                addEl(state.navigation, makeButton("themeButton", "theme", () => nextTheme(), btnOpts));
        addEl(state.navigation, makeButton('dataSaveButton', 'save-database', FileUtils.saveFile, btnOpts));
        if (MODE === 'Standalone') {
            addEl(state.navigation, makeButton('newBaseButton', 'create-database', FileUtils.makeNewBase, btnOpts));
        }
        //addEl(state.navigation, makeButton("mainHelpButton", "docs", FileUtils.openHelp, btnOpts));

        addEl(state.navigation, makeL10nButton());

        Utils.addView(state.containers, 'logViewer', LogViewer2, { clazz: 'logViewerButton', tooltip: true });
        //        addEl(state.navigation, makeButton('testButton', 'test', runTests, btnOpts));

        //addEl(state.navigation, makeButton("refreshButton", "refresh", () => state.currentView.refresh(), btnOpts));

        FileUtils.init((err) => {
            if (err) { Utils.handleError(err); return; }
            consistencyCheck(state.currentView.refresh);
        });

        state.currentView.refresh();
        addBeforeUnloadListener();
    }

    function initPage() {
        L10n.localizeStatic();
        L10n.onL10nChange(() => state.currentView.refresh());
        UI.initSelectorFilters();
        UI.initPanelTogglers();
        function updateDialogs() {
            vex.dialog.buttons.YES.text = getL10n('common-ok');
            vex.dialog.buttons.NO.text = getL10n('common-cancel');
        }
        updateDialogs();
        L10n.onL10nChange(updateDialogs);
    }

    //    var curTheme = Constants.themeList[1];
    //
    //    var initTheme = function() {
    //        if(DBMS.setTheme){
    //            DBMS.getTheme(function(err, theme){
    //                if(err) {console.log(err);}
    //                if(theme !== ''){
    //                    curTheme = theme;
    //                }
    //                addClass(queryEl('body'), curTheme);
    //            });
    //        } else {
    //            addClass(queryEl('body'), curTheme);
    //        }
    //    };
    //
    //    var nextTheme = function() {
    //        removeClass(queryEl('body'), curTheme);
    //        curTheme = Constants.themeList[(R.indexOf(curTheme, Constants.themeList)+1)%Constants.themeList.length];
    //        addClass(queryEl('body'), curTheme);
    //        if(DBMS.setTheme){
    //            DBMS.setTheme(curTheme, function(err){
    //                if(err) {console.log(err); return;}
    //            });
    //        }
    //    };

    function consistencyCheck(callback) {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                console.log('Consistency check didn\'t find errors');
            }
            callback();
        });
    }

    function stateInit() {
        state.navigation = getEl('navigation');
        state.containers = {
            root: state,
            navigation: state.navigation,
            content: getEl('contentArea')
        };
    }

    function runTests() {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                Utils.alert(getL10n('overview-consistency-is-ok'));
                console.log('Consistency check didn\'t find errors');
            }
        });
    }

    function makeButton(clazz, name, callback, opts) {
        const button = makeEl('button');
        addClass(button, clazz);
        function delegate() {
            $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
        }
        if (opts.tooltip) {
            L10n.onL10nChange(delegate);
            $(button).tooltip({
                title: L10n.getValue(`header-${name}`),
                placement: 'bottom'
            });
        }
        addClass(button, 'action-button');
        if (opts.className) {
            addClass(button, opts.className);
        }
        if (callback) {
            listen(button, 'click', callback);
        }
        return button;
    }

    function makeL10nButton() {
        const l10nBtn = makeButton('toggleL10nButton', 'l10n', L10n.toggleL10n, btnOpts);
        function setIcon() {
            l10nBtn.style.backgroundImage = strFormat('url("./images/{0}.svg")', [getL10n('header-dictionary-icon')]);
        }
        L10n.onL10nChange(setIcon);
        setIcon();
        return l10nBtn;
    }

    function addBeforeUnloadListener() {
        window.onbeforeunload = (evt) => {
            const message = getL10n('utils-close-page-warning');
            if (typeof evt === 'undefined') {
                evt = window.event;
            }
            if (evt) {
                evt.returnValue = message;
            }
            return message;
        };
    }
})(this.PageManager = {});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2RibXMvbG9jYWxEQk1TLmpzIiwiLi4vY29yZS9qcy9maWxlVXRpbHMuanMiLCIuLi9jb3JlL2pzL2wxMG4uanMiLCIuLi9jb3JlL2pzL3VpVXRpbHMuanMiLCIuLi9jb3JlL2pzL3V0aWxzLmpzIiwianMvcGFnZU1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pSQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDblpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzY3JpcHRzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5mdW5jdGlvbiBtYWtlTG9jYWxEQk1TKGZ1bGxWZXJzaW9uKSB7XHJcbiAgICBjb25zdCBvcHRzID0ge1xyXG4gICAgICAgIE1pZ3JhdG9yLFxyXG4gICAgICAgIENvbW1vblV0aWxzLFxyXG4gICAgICAgIEV2ZW50RW1pdHRlcixcclxuICAgICAgICBQcmVjb25kaXRpb24sXHJcbiAgICAgICAgUixcclxuICAgICAgICBBanYsXHJcbiAgICAgICAgU2NoZW1hLFxyXG4gICAgICAgIEVycm9ycyxcclxuICAgICAgICBsaXN0ZW5lcnM6IHt9LFxyXG4gICAgICAgIENvbnN0YW50cyxcclxuICAgICAgICBkYm1zVXRpbHM6IHt9LFxyXG4gICAgICAgIGRhdGVGb3JtYXQsXHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIExvY2FsREJNUygpIHtcclxuICAgICAgICB0aGlzLl9pbml0KG9wdHMubGlzdGVuZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICBMb2NhbERCTVMucHJvdG90eXBlLmdldFNldHRpbmdzID0gKCkgPT4gdGhpcy5kYXRhYmFzZS5TZXR0aW5ncztcclxuXHJcbiAgICBjb25zdCBmdW5jID0gbmFtZSA9PiB3aW5kb3dbbmFtZV0oTG9jYWxEQk1TLCBvcHRzKTtcclxuXHJcbiAgICBbXHJcbiAgICAgICAgJ2Jhc2VBUEknLFxyXG4gICAgICAgICdjb25zaXN0ZW5jeUNoZWNrQVBJJyxcclxuICAgICAgICAnbG9nQVBJJyxcclxuICAgICAgICAnY2hhcnNoZWV0QVBJJyxcclxuICAgICAgICAnc2V0dGluZ3NBUEknLFxyXG4gICAgXS5tYXAoZnVuYyk7XHJcblxyXG4gICAgTG9nZ2VyLmF0dGFjaExvZ0NhbGxzKExvY2FsREJNUywgUiwgZmFsc2UpO1xyXG4gICAgcmV0dXJuIExvY2FsREJNUztcclxufVxyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuY2FsbGJhY2sgPSBjYWxsYmFjaztcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlTmV3QmFzZSA9ICgpID0+IHtcclxuICAgICAgICBVdGlscy5jb25maXJtKGdldEwxMG4oJ3V0aWxzLW5ldy1iYXNlLXdhcm5pbmcnKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnNldERhdGFiYXNlKENvbW1vblV0aWxzLmNsb25lKEVtcHR5QmFzZS5kYXRhKSwgc3RhdGUuY2FsbGJhY2spO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9wZW5IZWxwID0gKCkgPT4ge1xyXG4gICAgICAgIHdpbmRvdy5vcGVuKCdleHRyYXMvZG9jL25pbXMuaHRtbCcpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlYWRTaW5nbGVGaWxlID0gKGV2dCkgPT4ge1xyXG4gICAgICAgIC8vIFJldHJpZXZlIHRoZSBmaXJzdCAoYW5kIG9ubHkhKSBGaWxlIGZyb20gdGhlIEZpbGVMaXN0IG9iamVjdFxyXG4gICAgICAgIGNvbnN0IGYgPSBldnQudGFyZ2V0LmZpbGVzWzBdO1xyXG5cclxuICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgICBjb25zdCByID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgICAgICAgci5vbmxvYWQgPSAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudHMgPSBlLnRhcmdldC5yZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhYmFzZSA9IEpTT04ucGFyc2UoY29udGVudHMpO1xyXG4gICAgICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShkYXRhYmFzZSwgc3RhdGUuY2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByLnJlYWRBc1RleHQoZik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigndXRpbHMtYmFzZS1maWxlLWxvYWRpbmctZXJyb3InKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNhdmVGaWxlID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0RGF0YWJhc2UoKGVyciwgZGF0YWJhc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZXhwb3J0cy5qc29uMkZpbGUoZGF0YWJhc2UsIGAke0JBU0VfRklMRV9OQU1FfS5qc29uYCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuanNvbjJGaWxlID0gKHN0ciwgZmlsZU5hbWUpID0+IHtcclxuICAgICAgICBleHBvcnRzLnN0cjJGaWxlKEpTT04uc3RyaW5naWZ5KHN0ciwgbnVsbCwgJyAgJyksIGZpbGVOYW1lKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5zdHIyRmlsZSA9IChzdHIsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtzdHJdLCB7XHJcbiAgICAgICAgICAgIHR5cGU6ICd0ZXh0L3BsYWluO2NoYXJzZXQ9dXRmLTgnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUFzKGJsb2IsIGZpbGVOYW1lKTtcclxuICAgIH07XHJcbn0pKHRoaXMuRmlsZVV0aWxzID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4vKiBlc2xpbnQtZGlzYWJsZSBuby12YXIsdmFycy1vbi10b3AgKi9cclxuXHJcbigoZXhwb3J0cywgRGljdGlvbmFyaWVzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIHN0YXRlLmluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzID0gW107XHJcbiAgICBzdGF0ZS5kaWN0aW9uYXJpZXMgPSB7fTtcclxuICAgIHN0YXRlLmxhbmcgPSBkZWZhdWx0TGFuZztcclxuXHJcbiAgICBjb25zdCBpbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChzdGF0ZS5pbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAgICBjb25zb2xlLmxvZyhuYXZpZ2F0b3IubGFuZ3VhZ2UpO1xyXG5cclxuICAgICAgICBzdGF0ZS5kaWN0aW9uYXJpZXMgPSBSLm1hcChwcm9jZXNzRGljdGlvbmFyeSwgRGljdGlvbmFyaWVzKTtcclxuXHJcbiAgICAgICAgLy8gICAgdmFyIGxhbmcgPSAobmF2aWdhdG9yLmxhbmd1YWdlcyA/IG5hdmlnYXRvci5sYW5ndWFnZXNbMF0gOiBuYXZpZ2F0b3IuYnJvd3Nlckxhbmd1YWdlKS5zcGxpdCgnLScpWzBdO1xyXG4gICAgICAgIC8vICAgIHZhciBsYW5nID0gJ3J1JztcclxuICAgICAgICAvLyAgICAgICAgdmFyIGxhbmcgPSBkZWZhdWx0TGFuZztcclxuICAgICAgICAvLyAgICAgICAgY29uc29sZS5sb2cobGFuZyk7XHJcblxyXG4gICAgICAgIGlmIChzdGF0ZS5kaWN0aW9uYXJpZXNbZGVmYXVsdExhbmddKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXNbZGVmYXVsdExhbmddO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMuZW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldEh0bWxMYW5nKGRlZmF1bHRMYW5nKTtcclxuICAgICAgICBleHBvcnRzLm9uTDEwbkNoYW5nZShleHBvcnRzLmxvY2FsaXplU3RhdGljKTtcclxuICAgICAgICBzdGF0ZS5pbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBwcm9jZXNzRGljdGlvbmFyeSA9IChkaWN0aW9uYXJ5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvY2Vzc2VkRGljdGlvbmFyeSA9IHt9O1xyXG4gICAgICAgIFIudG9QYWlycyhkaWN0aW9uYXJ5KS5mb3JFYWNoKChbc2VjdGlvbk5hbWUsIHNlY3Rpb25dKSA9PiB7XHJcbiAgICAgICAgICAgIFIudG9QYWlycyhzZWN0aW9uKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3NlZERpY3Rpb25hcnlbYCR7c2VjdGlvbk5hbWV9LSR7a2V5fWBdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vICAgICAgICBmb3IgKGNvbnN0IHNlY3Rpb25OYW1lIGluIGRpY3Rpb25hcnkpIHtcclxuICAgICAgICAvLyAgICAgICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiBkaWN0aW9uYXJ5W3NlY3Rpb25OYW1lXSkge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgICAgIHByb2Nlc3NlZERpY3Rpb25hcnlbYCR7c2VjdGlvbk5hbWV9LSR7bmFtZX1gXSA9IGRpY3Rpb25hcnlbc2VjdGlvbk5hbWVdW25hbWVdO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NlZERpY3Rpb25hcnk7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBzZXRIdG1sTGFuZyA9IGxhbmcgPT4gc2V0QXR0cihkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaHRtbCcpWzBdLCAnbGFuZycsIGxhbmcpO1xyXG5cclxuICAgIGV4cG9ydHMudG9nZ2xlTDEwbiA9ICgpID0+IHtcclxuICAgICAgICBpZiAoc3RhdGUubGFuZyA9PT0gJ3J1Jykge1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzLmVuO1xyXG4gICAgICAgICAgICBzdGF0ZS5sYW5nID0gJ2VuJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzLnJ1O1xyXG4gICAgICAgICAgICBzdGF0ZS5sYW5nID0gJ3J1JztcclxuICAgICAgICB9XHJcbiAgICAgICAgc2V0SHRtbExhbmcoc3RhdGUubGFuZyk7XHJcbiAgICAgICAgc3RhdGUubDEwbkRlbGVnYXRlcy5mb3JFYWNoKChkZWxlZ2F0ZSkgPT4ge1xyXG4gICAgICAgICAgICBkZWxlZ2F0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmdldExhbmcgPSAoKSA9PiBzdGF0ZS5sYW5nLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgZXhwb3J0cy5mb3JtYXQgPSBSLmN1cnJ5KChuYW1lc3BhY2UsIG5hbWUsIGFyZ3MpID0+IHN0ckZvcm1hdChleHBvcnRzLmdldChuYW1lc3BhY2UsIG5hbWUpLCBhcmdzKSk7XHJcblxyXG4gICAgZXhwb3J0cy5nZXQgPSBSLmN1cnJ5KChuYW1lc3BhY2UsIG5hbWUpID0+IEwxMG4uZ2V0VmFsdWUoYCR7bmFtZXNwYWNlfS0ke25hbWV9YCkpO1xyXG5cclxuICAgIGV4cG9ydHMuZ2V0VmFsdWUgPSAobmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gc3RhdGUuZGljdFtuYW1lXTtcclxuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgY29uc29sZS5sb2coYFZhbHVlIGlzIG5vdCBmb3VuZDogJHtuYW1lfWApO1xyXG4gICAgICAgIHJldHVybiB2YWx1ZSB8fCBgJHtuYW1lfTpSQSBSQS1BSC1BSC1BSCBST01BIFJPTUEtTUEgR0FHQSBPSCBMQS1MQWA7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMub25MMTBuQ2hhbmdlID0gKGRlbGVnYXRlKSA9PiB7XHJcbiAgICAgICAgc3RhdGUubDEwbkRlbGVnYXRlcy5wdXNoKGRlbGVnYXRlKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5sb2NhbGl6ZVN0YXRpYyA9ICgpID0+IHtcclxuICAgICAgICBpbml0KCk7XHJcbiAgICAgICAgbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2wxMG4taWRdJykpLm1hcChlbCA9PiBhZGRFbChjbGVhckVsKGVsKSwgbWFrZVRleHQoZXhwb3J0cy5nZXRWYWx1ZShnZXRBdHRyKGVsLCAnbDEwbi1pZCcpKSkpKTtcclxuICAgICAgICBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbbDEwbi1wbGFjZWhvbGRlci1pZF0nKSkubWFwKGVsID0+IHNldEF0dHIoZWwsICdwbGFjZWhvbGRlcicsIGV4cG9ydHMuZ2V0VmFsdWUoZ2V0QXR0cihlbCwgJ2wxMG4tcGxhY2Vob2xkZXItaWQnKSkpKTtcclxuICAgIH07XHJcbn0pKHRoaXMuTDEwbiA9IHt9LCBEaWN0aW9uYXJpZXMpO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4vKiBlc2xpbnQtZGlzYWJsZSBuby12YXIsdmFycy1vbi10b3AgKi9cclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgZXhwb3J0cy5pbml0VGFiUGFuZWwgPSAodGFiQ2xhenosIGNvbnRhaW5lckNsYXp6KSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IGdldEVscyhjb250YWluZXJDbGF6eik7XHJcblxyXG4gICAgICAgIGxldCBpO1xyXG4gICAgICAgIGZvciAoaSA9IDE7IGkgPCBjb250YWluZXJzLmxlbmd0aDsgaSsrKSB7IC8vIGRvbid0IGhpZGUgMXN0IGVsZW1lbnRcclxuICAgICAgICAgICAgYWRkQ2xhc3MoY29udGFpbmVyc1tpXSwgJ2hpZGRlbicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdGFiQnV0dG9ucyA9IGdldEVscyh0YWJDbGF6eik7XHJcblxyXG4gICAgICAgIGFkZENsYXNzKHRhYkJ1dHRvbnNbMF0sICdhY3RpdmUnKTtcclxuXHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRhYkJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGlzdGVuKHRhYkJ1dHRvbnNbaV0sICdjbGljaycsIHRhYkJ1dHRvbkNsaWNrKHRhYkJ1dHRvbnMsIGNvbnRhaW5lcnMpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciB0YWJCdXR0b25DbGljayA9IChidXR0b25zLCBjb250YWluZXJzKSA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihidXR0b25zW2ldLCAnYWN0aXZlJywgZXZlbnQudGFyZ2V0LmlkID09PSBidXR0b25zW2ldLmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb250YWluZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oY29udGFpbmVyc1tpXSwgJ2hpZGRlbicsIGAke2V2ZW50LnRhcmdldC5pZH1Db250YWluZXJgICE9PSBjb250YWluZXJzW2ldLmlkKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuZmlsbFNob3dJdGVtU2VsZWN0b3IgPSAoc2VsZWN0b3IsIGRpc3BsYXlBcnJheSkgPT4ge1xyXG4gICAgICAgIGxldCBlbDtcclxuICAgICAgICBzZXRBdHRyKHNlbGVjdG9yLCAnc2l6ZScsIGRpc3BsYXlBcnJheS5sZW5ndGgpO1xyXG4gICAgICAgIGRpc3BsYXlBcnJheS5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBlbCA9IHNldFByb3BzKG1ha2VFbCgnb3B0aW9uJyksIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihlbCwgJ2hpZGRlbicsIHZhbHVlLmhpZGRlbik7XHJcbiAgICAgICAgICAgIGFkZEVsKHNlbGVjdG9yLCBhZGRFbChlbCwgbWFrZVRleHQodmFsdWUubmFtZSkpKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5maWxsU2hvd0l0ZW1TZWxlY3RvcjIgPSAoc2VsZWN0b3IsIG9wdGlvbkdyb3VwcykgPT4ge1xyXG4gICAgICAgIGxldCBlbCwgZ3JvdXBFbCwgY291bnRlciA9IDA7XHJcbiAgICAgICAgYWRkRWxzKHNlbGVjdG9yLCBvcHRpb25Hcm91cHMubWFwKChncm91cCkgPT4ge1xyXG4gICAgICAgICAgICBjb3VudGVyKys7XHJcbiAgICAgICAgICAgIGdyb3VwRWwgPSBzZXRBdHRyKG1ha2VFbCgnb3B0Z3JvdXAnKSwgJ2xhYmVsJywgZ3JvdXAubmFtZSk7XHJcbiAgICAgICAgICAgIGFkZEVscyhncm91cEVsLCBncm91cC5hcnJheS5tYXAoKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlbCA9IHNldFByb3BzKG1ha2VFbCgnb3B0aW9uJyksIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihlbCwgJ2hpZGRlbicsIHZhbHVlLmhpZGRlbik7XHJcbiAgICAgICAgICAgICAgICBjb3VudGVyICs9ICh2YWx1ZS5oaWRkZW4gPyAwIDogMSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWRkRWwoZWwsIG1ha2VUZXh0KHZhbHVlLm5hbWUpKTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gZ3JvdXBFbDtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgc2V0QXR0cihzZWxlY3RvciwgJ3NpemUnLCBjb3VudGVyKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5zaG93U2VsZWN0ZWRFbHMgPSBjbGFzc0tleSA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBlbCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBsZXQgZWxzLCBpLCBqO1xyXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgIGVscyA9IGdldEVscyhpICsgY2xhc3NLZXkpO1xyXG4gICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZWxzLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGVsc1tqXSwgJ2hpZGRlbicsICFlbC5vcHRpb25zW2ldLnNlbGVjdGVkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5pbml0U2VsZWN0b3JGaWx0ZXJzID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW3NlbGVjdG9yLWZpbHRlcl0nKTtcclxuICAgICAgICBsZXQgZWwsIHNlbDtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGVsID0gZWxlbXNbaV07XHJcbiAgICAgICAgICAgIHNlbCA9IHF1ZXJ5RWwoZ2V0QXR0cihlbCwgJ3NlbGVjdG9yLWZpbHRlcicpKTtcclxuICAgICAgICAgICAgZWwudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgbGlzdGVuKGVsLCAnaW5wdXQnLCBmaWx0ZXJPcHRpb25zKHNlbCkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdmFyIGZpbHRlck9wdGlvbnMgPSBzZWwgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgbGV0IHZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBsZXQgaSwgb3B0O1xyXG4gICAgICAgIHZhbCA9IENvbW1vblV0aWxzLmdsb2JTdHJpbmdUb1JlZ2V4KHZhbC50cmltKCkudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgIG9wdCA9IHNlbC5vcHRpb25zW2ldO1xyXG4gICAgICAgICAgICBjb25zdCBpc1Zpc2libGUgPSBvcHQuaW5uZXJIVE1MLnRvTG93ZXJDYXNlKCkuc2VhcmNoKHZhbCkgIT09IC0xO1xyXG4gICAgICAgICAgICBpZiAoIWlzVmlzaWJsZSkge1xyXG4gICAgICAgICAgICAgICAgb3B0LnNlbGVjdGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihvcHQsICdoaWRkZW4nLCAhaXNWaXNpYmxlKTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihvcHQsIFwiaGlkZGVuXCIsIG9wdC5pbm5lckhUTUwudG9Mb3dlckNhc2UoKS5zZWFyY2godmFsKSA9PT0gLTEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZWwuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2NoYW5nZScpKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5pbml0UGFuZWxUb2dnbGVycyA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBlbGVtcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1twYW5lbC10b2dnbGVyXScpO1xyXG4gICAgICAgIGxldCBlbCwgc2VsLCBhdHRyO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWwgPSBlbGVtc1tpXTtcclxuICAgICAgICAgICAgYXR0ciA9IGdldEF0dHIoZWwsICdwYW5lbC10b2dnbGVyJyk7XHJcbiAgICAgICAgICAgIHNlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYXR0cik7XHJcbiAgICAgICAgICAgIGlmIChzZWwgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoYFBhbmVsIHRvZ2dsZXIgaXMgYnJva2VuOiAke2F0dHJ9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGlzdGVuKGVsLCAnY2xpY2snLCBleHBvcnRzLnRvZ2dsZVBhbmVsKHNlbCkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy50b2dnbGVQYW5lbCA9IHNlbCA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICB0b2dnbGVDbGFzcyhzZWwsICdoaWRkZW4nKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlRXZlbnRUaW1lUGlja2VyID0gKG9wdHMpID0+IHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBSLmFwKFthZGRDbGFzcyhpbnB1dCldLCBvcHRzLmV4dHJhQ2xhc3Nlcyk7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdldmVudFRpbWUnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG5cclxuICAgICAgICBpbnB1dC5ldmVudEluZGV4ID0gb3B0cy5pbmRleDtcclxuXHJcbiAgICAgICAgY29uc3QgcGlja2VyT3B0cyA9IHtcclxuICAgICAgICAgICAgbGFuZzogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAgICAgICAgIG1hc2s6IHRydWUsXHJcbiAgICAgICAgICAgIHN0YXJ0RGF0ZTogbmV3IERhdGUob3B0cy5wcmVHYW1lRGF0ZSksXHJcbiAgICAgICAgICAgIGVuZERhdGU6IG5ldyBEYXRlKG9wdHMuZGF0ZSksXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWU6IG9wdHMub25DaGFuZ2VEYXRlVGltZUNyZWF0b3IoaW5wdXQpLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChvcHRzLmV2ZW50VGltZSAhPT0gJycpIHtcclxuICAgICAgICAgICAgcGlja2VyT3B0cy52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBpY2tlck9wdHMudmFsdWUgPSBvcHRzLmRhdGU7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnZGVmYXVsdERhdGUnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGpRdWVyeShpbnB1dCkuZGF0ZXRpbWVwaWNrZXIocGlja2VyT3B0cyk7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBidWcgYWJvdXQgc2V0dGluZyAwOTAwIHllYXJzIGluIEJyYWF2b3MgZ2FtZSBpcyBldmVudCBkYXRlLiBGaXhlZCBpbiBwcm9kdWN0aW9uLlxyXG4gICAgLy8gIGV4cG9ydHMubWFrZUV2ZW50VGltZVBpY2tlciA9IGZ1bmN0aW9uIChvcHRzKSB7XHJcbiAgICAvLyAgICAgIHZhciBpbnB1dCA9IG1ha2VFbChcImlucHV0XCIpO1xyXG4gICAgLy8gICAgICBSLmFwKFthZGRDbGFzcyhpbnB1dCldLCBvcHRzLmV4dHJhQ2xhc3Nlcyk7XHJcbiAgICAvLyAgICAgIGFkZENsYXNzKGlucHV0LCBcImV2ZW50VGltZVwiKTtcclxuICAgIC8vICAgICAgaW5wdXQudmFsdWUgPSBvcHRzLmV2ZW50VGltZTtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgIGlucHV0LmV2ZW50SW5kZXggPSBvcHRzLmluZGV4O1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgdmFyIHBpY2tlck9wdHMgPSB7XHJcbiAgICAvLyAgICAgICAgICBsYW5nIDogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAvLyAgICAgICAgICBtYXNrIDogdHJ1ZSxcclxuICAgIC8vICAgICAgICAgIHN0YXJ0RGF0ZSA6IG5ldyBEYXRlKG9wdHMucHJlR2FtZURhdGUpLFxyXG4gICAgLy8gICAgICAgICAgZW5kRGF0ZSA6IG5ldyBEYXRlKG9wdHMuZGF0ZSksXHJcbiAgICAvLyAgICAgICAgICBvbkNoYW5nZURhdGVUaW1lIDogb3B0cy5vbkNoYW5nZURhdGVUaW1lQ3JlYXRvcihpbnB1dCksXHJcbiAgICAvLyAgICAgIH07XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICB2YXIgcGlja2VyID0galF1ZXJ5KGlucHV0KS5kYXRldGltZXBpY2tlcihwaWNrZXJPcHRzKTtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHZhciB2YWx1ZTtcclxuICAgIC8vICAgICAgaWYgKG9wdHMuZXZlbnRUaW1lICE9PSBcIlwiKSB7XHJcbiAgICAvLyAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKG9wdHMuZXZlbnRUaW1lKTtcclxuICAgIC8vICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgIHZhbHVlID0gb3B0cy5kYXRlO1xyXG4gICAgLy8gICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwiZGVmYXVsdERhdGVcIik7XHJcbiAgICAvLyAgICAgIH1cclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHBpY2tlci52YWx1ZSA9IHZhbHVlO1xyXG4gICAgLy9cclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIC8vICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVzaXplVGV4dGFyZWEgPSAoZXYpID0+IHtcclxuICAgICAgICBjb25zdCB0aGF0ID0gZXYudGFyZ2V0O1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gJzI0cHgnO1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gYCR7dGhhdC5zY3JvbGxIZWlnaHQgKyAxMn1weGA7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVzaXplVGV4dGFyZWEyID0gKHRoYXQpID0+IHtcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9ICcyNHB4JztcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9IGAke3RoYXQuc2Nyb2xsSGVpZ2h0ICsgMTJ9cHhgO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VBZGFwdGF0aW9uVGltZUlucHV0ID0gKHN0b3J5TmFtZSwgZXZlbnQsIGNoYXJhY3Rlck5hbWUsIGlzRWRpdGFibGUpID0+IHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCAnbm90RWRpdGFibGUnLCAhaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdhZGFwdGF0aW9uVGltZUlucHV0Jyk7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnRpbWU7XHJcbiAgICAgICAgaW5wdXQuZGF0YUtleSA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgb25DaGFuZ2VQZXJzb25hbFRpbWVEZWxlZ2F0ZSk7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgb25DaGFuZ2VQZXJzb25hbFRpbWVEZWxlZ2F0ZSA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5kYXRhS2V5KTtcclxuICAgICAgICBjb25zdCB0aW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgIERCTVMuc2V0RXZlbnRBZGFwdGF0aW9uUHJvcGVydHkoZGF0YUtleVswXSwgZGF0YUtleVsxXSwgZGF0YUtleVsyXSwgJ3RpbWUnLCB0aW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZUFkYXB0YXRpb25SZWFkeUlucHV0ID0gKHN0b3J5TmFtZSwgZXZlbnQsIGNoYXJhY3Rlck5hbWUsIGlzRWRpdGFibGUpID0+IHtcclxuICAgICAgICBjb25zdCBkaXYgPSBtYWtlRWwoJ2RpdicpO1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oaW5wdXQsICdub3RFZGl0YWJsZScsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JztcclxuICAgICAgICBpbnB1dC5jaGVja2VkID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS5yZWFkeTtcclxuICAgICAgICBpbnB1dC5kYXRhS2V5ID0gSlNPTi5zdHJpbmdpZnkoW3N0b3J5TmFtZSwgZXZlbnQuaW5kZXgsIGNoYXJhY3Rlck5hbWVdKTtcclxuICAgICAgICBpbnB1dC5pZCA9IGAke2V2ZW50LmluZGV4fS0ke3N0b3J5TmFtZX0tJHtjaGFyYWN0ZXJOYW1lfWA7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgb25DaGFuZ2VSZWFkeVN0YXR1cyk7XHJcbiAgICAgICAgYWRkRWwoZGl2LCBpbnB1dCk7XHJcblxyXG4gICAgICAgIGFkZEVsKGRpdiwgc2V0QXR0cihhZGRFbChtYWtlRWwoJ2xhYmVsJyksIG1ha2VUZXh0KGNvbnN0TDEwbihDb25zdGFudHMuZmluaXNoZWRUZXh0KSkpLCAnZm9yJywgaW5wdXQuaWQpKTtcclxuICAgICAgICByZXR1cm4gZGl2O1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgb25DaGFuZ2VSZWFkeVN0YXR1cyA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5kYXRhS2V5KTtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LnRhcmdldC5jaGVja2VkO1xyXG4gICAgICAgIERCTVMuc2V0RXZlbnRBZGFwdGF0aW9uUHJvcGVydHkoZGF0YUtleVswXSwgZGF0YUtleVsxXSwgZGF0YUtleVsyXSwgJ3JlYWR5JywgdmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUGFuZWxDb3JlID0gKHRpdGxlLCBjb250ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGFuZWwgPSBhZGRDbGFzc2VzKG1ha2VFbCgnZGl2JyksIFsncGFuZWwnLCAncGFuZWwtZGVmYXVsdCddKTtcclxuICAgICAgICBjb25zdCBoMyA9IGFkZENsYXNzKGFkZEVsKG1ha2VFbCgnaDMnKSwgdGl0bGUpLCAncGFuZWwtdGl0bGUnKTtcclxuICAgICAgICBjb25zdCBhID0gc2V0QXR0cihtYWtlRWwoJ2EnKSwgJ2hyZWYnLCAnIy8nKTtcclxuICAgICAgICBjb25zdCBoZWFkRGl2ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3BhbmVsLWhlYWRpbmcnKTtcclxuICAgICAgICBhZGRFbChwYW5lbCwgYWRkRWwoaGVhZERpdiwgYWRkRWwoYSwgaDMpKSk7XHJcbiAgICAgICAgY29uc3QgY29udGVudERpdiA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdwYW5lbC1ib2R5Jyk7XHJcbiAgICAgICAgYWRkRWwocGFuZWwsIGFkZEVsKGNvbnRlbnREaXYsIGNvbnRlbnQpKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwYW5lbCxcclxuICAgICAgICAgICAgY29udGVudERpdixcclxuICAgICAgICAgICAgYVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZVByb2ZpbGVUYWJsZSA9IChwcm9maWxlU3RydWN0dXJlLCBwcm9maWxlKSA9PiB7XHJcbiAgICAgICAgbGV0IHZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHByb2ZpbGVEaXYgPSBhZGRFbHMobWFrZUVsKCd0Ym9keScpLCBwcm9maWxlU3RydWN0dXJlLmZpbHRlcihlbGVtZW50ID0+IGVsZW1lbnQuZG9FeHBvcnQpLm1hcCgoZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGVsZW1lbnQudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gYWRkQ2xhc3MobWFrZUVsKCdzcGFuJyksICdicmllZmluZ1RleHRTcGFuJyk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbCh2YWx1ZSwgbWFrZVRleHQocHJvZmlsZVtlbGVtZW50Lm5hbWVdKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IG1ha2VUZXh0KHByb2ZpbGVbZWxlbWVudC5uYW1lXSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBtYWtlVGV4dChjb25zdEwxMG4oQ29uc3RhbnRzW3Byb2ZpbGVbZWxlbWVudC5uYW1lXV0pKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtlbGVtZW50LnR5cGV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMubWFrZVRhYmxlUm93KG1ha2VUZXh0KGVsZW1lbnQubmFtZSksIHZhbHVlKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVsKGFkZENsYXNzZXMobWFrZUVsKCd0YWJsZScpLCBbJ3RhYmxlJywgJ3RhYmxlLXN0cmlwZWQnXSksIHByb2ZpbGVEaXYpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VUYWJsZVJvdyA9IChjb2wxLCBjb2wyKSA9PiBhZGRFbHMobWFrZUVsKCd0cicpLCBbYWRkRWwobWFrZUVsKCd0ZCcpLCBjb2wxKSwgYWRkRWwobWFrZUVsKCd0ZCcpLCBjb2wyKV0pO1xyXG59KSh0aGlzLlVJID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4vLyBUT0RPIG5lZWQgdG8gbGludCB1dGlscyB3aXRoIE5JTVMgZml4ZXNcclxuLyogZXNsaW50LWRpc2FibGUgKi9cclxuXHJcbmNvbnN0IHN0ckZvcm1hdCA9IFIuY3VycnkoQ29tbW9uVXRpbHMuc3RyRm9ybWF0KTtcclxuXHJcbmZ1bmN0aW9uIGdldEwxMG4oa2V5KSB7XHJcbiAgICByZXR1cm4gTDEwbi5nZXRWYWx1ZShrZXkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb25zdEwxMG4oa2V5KSB7XHJcbiAgICByZXR1cm4gTDEwbi5nZXRWYWx1ZShgY29uc3RhbnQtJHtrZXl9YCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7XHJcbiAgICByZXR1cm4gKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKG9iaikubGVuZ3RoID09PSAwKTtcclxufVxyXG5cclxuY29uc3QgYWRkQ2xhc3MgPSBSLmN1cnJ5KChvLCBjKSA9PiB7XHJcbiAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYChefFxcXFxzKSR7Y30oXFxcXHN8JClgLCAnZycpO1xyXG4gICAgaWYgKHJlLnRlc3Qoby5jbGFzc05hbWUpKSByZXR1cm4gbztcclxuICAgIG8uY2xhc3NOYW1lID0gKGAke28uY2xhc3NOYW1lfSAke2N9YCkucmVwbGFjZSgvXFxzKy9nLCAnICcpLnJlcGxhY2UoLyheIHwgJCkvZywgJycpO1xyXG4gICAgcmV0dXJuIG87XHJcbn0pO1xyXG5cclxuY29uc3QgYWRkQ2xhc3NlcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIFIuYXAoW2FkZENsYXNzKG8pXSwgYyk7XHJcbiAgICByZXR1cm4gbztcclxufSk7XHJcblxyXG5jb25zdCByQWRkQ2xhc3MgPSBSLmN1cnJ5KChjLCBvKSA9PiBhZGRDbGFzcyhvLCBjKSk7XHJcblxyXG5mdW5jdGlvbiBoYXNDbGFzcyhvLCBjKSB7XHJcbiAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYChefFxcXFxzKSR7Y30oXFxcXHN8JClgLCAnZycpO1xyXG4gICAgcmV0dXJuIChyZS50ZXN0KG8uY2xhc3NOYW1lKSk7XHJcbn1cclxuXHJcbmNvbnN0IHJlbW92ZUNsYXNzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAoXnxcXFxccykke2N9KFxcXFxzfCQpYCwgJ2cnKTtcclxuICAgIG8uY2xhc3NOYW1lID0gby5jbGFzc05hbWUucmVwbGFjZShyZSwgJyQxJykucmVwbGFjZSgvXFxzKy9nLCAnICcpLnJlcGxhY2UoLyheIHwgJCkvZywgJycpO1xyXG59KTtcclxuXHJcbmNvbnN0IHRvZ2dsZUNsYXNzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgaWYgKGhhc0NsYXNzKG8sIGMpKSB7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MobywgYyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGFkZENsYXNzKG8sIGMpO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIHNldENsYXNzQnlDb25kaXRpb24obywgYywgY29uZGl0aW9uKSB7XHJcbiAgICBpZiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgYWRkQ2xhc3MobywgYyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG8sIGMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG87XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEVsKGlkKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVsKHNlbCkge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcXVlcnlFbHMoc2VsKSB7XHJcbiAgICByZXR1cm4gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWwpKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcXVlcnlFbEVscyhlbCwgc2VsKSB7XHJcbiAgICByZXR1cm4gbmwyYXJyYXkoZWwucXVlcnlTZWxlY3RvckFsbChzZWwpKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RWxzKGNsYXp6KSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGF6eik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1ha2VFbChlbFRhZykge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZWxUYWcpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlVGV4dCh0ZXh0KSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7XHJcbn1cclxuXHJcbmNvbnN0IGFkZEVsID0gUi5jdXJyeSgocGFyZW50LCBjaGlsZCkgPT4ge1xyXG4gICAgcGFyZW50LmFwcGVuZENoaWxkKGNoaWxkKTtcclxuICAgIHJldHVybiBwYXJlbnQ7XHJcbn0pO1xyXG5jb25zdCBhZGRFbHMgPSBSLmN1cnJ5KChwYXJlbnQsIGNoaWxkcmVuKSA9PiB7XHJcbiAgICBSLmFwKFthZGRFbChwYXJlbnQpXSwgY2hpbGRyZW4pO1xyXG4gICAgcmV0dXJuIHBhcmVudDtcclxufSk7XHJcblxyXG5jb25zdCBtYWtlT3B0ID0gZnVuY3Rpb24gKGxhYmVsKSB7XHJcbiAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgYWRkRWwob3B0aW9uLCAobWFrZVRleHQobGFiZWwpKSk7XHJcbiAgICByZXR1cm4gb3B0aW9uO1xyXG59O1xyXG5cclxuY29uc3QgckFkZEVsID0gUi5jdXJyeSgoY2hpbGQsIHBhcmVudCkgPT4ge1xyXG4gICAgcGFyZW50LmFwcGVuZENoaWxkKGNoaWxkKTtcclxuICAgIHJldHVybiBwYXJlbnQ7XHJcbn0pO1xyXG5cclxuXHJcbmNvbnN0IHNldEF0dHIgPSBSLmN1cnJ5KChlbCwgbmFtZSwgdmFsdWUpID0+IHtcclxuICAgIGVsLnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuY29uc3Qgc2V0U3R5bGUgPSBSLmN1cnJ5KChlbCwgbmFtZSwgdmFsdWUpID0+IHtcclxuICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBzZXRJbXBvcnRhbnRTdHlsZSA9IFIuY3VycnkoKGVsLCBuYW1lLCB2YWx1ZSkgPT4ge1xyXG4gICAgZWwuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUsICdpbXBvcnRhbnQnKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBkZWxBdHRyKGVsLCBuYW1lKSB7XHJcbiAgICBlbC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7XHJcbiAgICByZXR1cm4gZWw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEF0dHIoZWwsIG5hbWUpIHtcclxuICAgIHJldHVybiBlbC5nZXRBdHRyaWJ1dGUobmFtZSk7XHJcbn1cclxuXHJcbmNvbnN0IHNldFByb3AgPSBSLmN1cnJ5KChlbCwga2V5LCB2YWx1ZSkgPT4ge1xyXG4gICAgZWxba2V5XSA9IHZhbHVlO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldFByb3BzID0gUi5jdXJyeSgoZWwsIG1hcCkgPT4ge1xyXG4gICAgZm9yIChjb25zdCBrZXkgaW4gbWFwKSB7XHJcbiAgICAgICAgc2V0UHJvcChlbCwga2V5LCBtYXBba2V5XSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gY2xlYXJFbChlbCkge1xyXG4gICAgVXRpbHMucmVtb3ZlQ2hpbGRyZW4oZWwpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXNzRWxzKHNyYywgZHN0KSB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNyYy5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGFkZEVsKGRzdCwgc3JjLmNoaWxkcmVuW2ldKTtcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgbGlzdGVuID0gUi5jdXJyeSgoZWwsIGV2ZW50LCBsaXN0ZW5lcikgPT4ge1xyXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IGxpc3Rlbk9uRW50ZXIgPSBSLmN1cnJ5KChlbCwgY2FsbGJhY2spID0+IHtcclxuICAgIGxpc3RlbihlbCwgJ2tleWRvd24nLCAoZSkgPT4ge1xyXG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IDEzKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn0pO1xyXG5cclxuY29uc3QgZmlsbFNlbGVjdG9yID0gUi5jdXJyeSgoc2VsLCBkYXRhKSA9PiBhZGRFbHMoc2VsLCBkYXRhLm1hcCgoaXRlbSkgPT4ge1xyXG4gICAgY29uc3Qgb3B0ID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgIGFkZEVsKG9wdCwgbWFrZVRleHQoaXRlbS5uYW1lKSk7XHJcbiAgICBpZiAoaXRlbS52YWx1ZSkgeyBvcHQudmFsdWUgPSBpdGVtLnZhbHVlOyB9XHJcbiAgICBpZiAoaXRlbS5zZWxlY3RlZCkgeyBvcHQuc2VsZWN0ZWQgPSB0cnVlOyB9XHJcbiAgICBpZiAoaXRlbS5jbGFzc05hbWUpIHsgYWRkQ2xhc3Mob3B0LCBpdGVtLmNsYXNzTmFtZSk7IH1cclxuICAgIHJldHVybiBvcHQ7XHJcbn0pKSk7XHJcblxyXG5mdW5jdGlvbiBubDJhcnJheShub2RlTGlzdCkge1xyXG4gICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG5vZGVMaXN0KTtcclxufVxyXG5cclxuY29uc3QgcmVtYXBQcm9wcyA9IFIuY3VycnkoKG91dEtleXMsIHBpY2tLZXlzLCBvYmopID0+IFIuY29tcG9zZShSLnppcE9iaihvdXRLZXlzKSwgUi52YWx1ZXMsIFIucGljayhwaWNrS2V5cykpKG9iaikpO1xyXG5cclxuY29uc3QgcmVtYXBQcm9wczRTZWxlY3QyID0gcmVtYXBQcm9wcyhbJ2lkJywgJ3RleHQnXSwgWyd2YWx1ZScsICdkaXNwbGF5TmFtZSddKTtcclxuY29uc3QgcmVtYXBQcm9wczRTZWxlY3QgPSByZW1hcFByb3BzKFsndmFsdWUnLCAnbmFtZSddLCBbJ3ZhbHVlJywgJ2Rpc3BsYXlOYW1lJ10pO1xyXG5cclxuY29uc3QgZ2V0U2VsZWN0MkRhdGFDb21tb24gPSBSLmN1cnJ5KChwcmVwYXJhdG9yLCBvYmopID0+IFIuY29tcG9zZShSLnppcE9iaihbJ2RhdGEnXSksIFIuYXBwZW5kKFIuX18sIFtdKSwgUi5tYXAocHJlcGFyYXRvcikpKG9iaikpO1xyXG5cclxuY29uc3QgZ2V0U2VsZWN0MkRhdGEgPSBnZXRTZWxlY3QyRGF0YUNvbW1vbihyZW1hcFByb3BzNFNlbGVjdDIpO1xyXG5cclxuY29uc3QgbWFrZVNlbGVjdDJPcHQgPSBSLmNvbXBvc2UoUi56aXBPYmooWydpZCcsICd0ZXh0J10pLCBSLnJlcGVhdChSLl9fLCAyKSk7XHJcbmNvbnN0IGFycjJTZWxlY3QyID0gUi5jb21wb3NlKFIuYXNzb2MoJ2RhdGEnLCBSLl9fLCB7fSksIFIubWFwKG1ha2VTZWxlY3QyT3B0KSk7XHJcbmNvbnN0IGFycjJTZWxlY3QgPSBSLm1hcChSLmNvbXBvc2UoUi56aXBPYmooWyd2YWx1ZScsICduYW1lJ10pLCBSLnJlcGVhdChSLl9fLCAyKSkpO1xyXG5jb25zdCBjb25zdEFycjJTZWxlY3QgPSBSLm1hcChSLmNvbXBvc2UoUi56aXBPYmooWyd2YWx1ZScsICduYW1lJ10pLCBuYW1lID0+IFtuYW1lLCBjb25zdEwxMG4obmFtZSldKSk7XHJcblxyXG5jb25zdCBnZXRTZWxlY3RlZFJhZGlvID0gZnVuY3Rpb24gKHF1ZXJ5KSB7XHJcbiAgICBjb25zdCBlbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5KTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGVsc1tpXS5jaGVja2VkID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBlbHNbaV07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn07XHJcblxyXG5jb25zdCBkZWJ1Z0ludGVyY2VwdG9yID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50c1swXSkpO1xyXG4gICAgICAgIGNhbGxiYWNrKC4uLmFyZ3VtZW50cyk7XHJcbiAgICB9O1xyXG59O1xyXG5cclxuY29uc3QgVXRpbHMgPSB7fTtcclxuXHJcbi8qKiBvcHRzXHJcbiAgICB0b29sdGlwIC0gYWRkIHRvb2x0aXAgdG8gYnV0dG9uLCB1c2VkIGZvciBpY29uaWMgYnV0dG9uc1xyXG4gICAgaWQgLSBzZXQgYnV0dG9uIGlkXHJcbiAgICBtYWluUGFnZSAtIGVuYWJsZSB2aWV3IGFzIGZpcnN0IHBhZ2VcclxuICAgIHRvZ2dsZSAtIHRvZ2dsZSBjb250ZW50LCBhc3NvY2lhdGVkIHdpdGggYnV0dG9uXHJcbiovXHJcblV0aWxzLmFkZFZpZXcgPSBmdW5jdGlvbiAoY29udGFpbmVycywgbmFtZSwgdmlldywgb3B0czIpIHtcclxuICAgIGNvbnN0IG9wdHMgPSBvcHRzMiB8fCB7fTtcclxuICAgIHZpZXcuaW5pdCgpO1xyXG4gICAgY29uc3QgYnV0dG9uQ2xhc3MgPSAnbmF2aWdhdGlvbi1idXR0b24nO1xyXG4gICAgY29udGFpbmVycy5yb290LnZpZXdzW25hbWVdID0gdmlldztcclxuICAgIGNvbnN0IGJ1dHRvbiA9IG1ha2VFbCgnYnV0dG9uJyk7XHJcbiAgICBmdW5jdGlvbiBkZWxlZ2F0ZSgpIHtcclxuICAgICAgICAkKGJ1dHRvbikuYXR0cignZGF0YS1vcmlnaW5hbC10aXRsZScsIEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCkpO1xyXG4gICAgfVxyXG4gICAgaWYgKG9wdHMudG9vbHRpcCkge1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKGRlbGVnYXRlKTtcclxuICAgICAgICAkKGJ1dHRvbikudG9vbHRpcCh7XHJcbiAgICAgICAgICAgIHRpdGxlOiBMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApLFxyXG4gICAgICAgICAgICBwbGFjZW1lbnQ6ICdib3R0b20nXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGFkZEVsKGJ1dHRvbiwgbWFrZVRleHQoTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSkpO1xyXG4gICAgICAgIHNldEF0dHIoYnV0dG9uLCAnbDEwbi1pZCcsIGBoZWFkZXItJHtuYW1lfWApO1xyXG4gICAgfVxyXG4gICAgYWRkQ2xhc3MoYnV0dG9uLCBidXR0b25DbGFzcyk7XHJcbiAgICBhZGRDbGFzcyhidXR0b24sIGAtdGVzdC0ke25hbWV9YCk7XHJcbiAgICBhZGRDbGFzcyhidXR0b24sIGAtdG9nZ2xlLWNsYXNzLSR7bmFtZX1gKTtcclxuICAgIGlmIChvcHRzLmNsYXp6KSB7XHJcbiAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCBvcHRzLmNsYXp6KTtcclxuICAgIH1cclxuICAgIGNvbnRhaW5lcnMubmF2aWdhdGlvbi5hcHBlbmRDaGlsZChidXR0b24pO1xyXG5cclxuICAgIGNvbnN0IG9uQ2xpY2tEZWxlZ2F0ZSA9IGZ1bmN0aW9uICh2aWV3Mikge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgIC8vVGVzdHMucnVuKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsZW1zID0gY29udGFpbmVycy5uYXZpZ2F0aW9uLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoYnV0dG9uQ2xhc3MpO1xyXG4gICAgICAgICAgICBpZiAob3B0cy50b2dnbGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVscyA9IGdldEVscyhgLXRvZ2dsZS1jbGFzcy0ke25hbWV9YCk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChldnQudGFyZ2V0LmlzRXF1YWxOb2RlKGVsc1tpXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNDbGFzcyhlbHNbaV0sICdhY3RpdmUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNbaV0uY2xpY2soKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGlzQWN0aXZlID0gaGFzQ2xhc3MoZXZ0LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhlbGVtc1tpXSwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghb3B0cy50b2dnbGUgfHwgKG9wdHMudG9nZ2xlICYmICFpc0FjdGl2ZSkpIHtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGV2dC50YXJnZXQsICdhY3RpdmUnKTtcclxuXHJcbiAgICAgICAgICAgICAgICBwYXNzRWxzKGNvbnRhaW5lcnMuY29udGVudCwgZ2V0RWwoJ3dhcmVob3VzZScpKTtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMuY29udGVudC5hcHBlbmRDaGlsZCh2aWV3Mi5jb250ZW50KTtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGNvbnRhaW5lcnMuY29udGVudCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gdmlldzI7XHJcbiAgICAgICAgICAgICAgICB2aWV3Mi5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhldnQudGFyZ2V0LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICBwYXNzRWxzKGNvbnRhaW5lcnMuY29udGVudCwgZ2V0RWwoJ3dhcmVob3VzZScpKTtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMucm9vdC5jdXJyZW50VmlldyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhjb250YWluZXJzLmNvbnRlbnQsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG9uQ2xpY2tEZWxlZ2F0ZSh2aWV3KSk7XHJcbiAgICBpZiAob3B0cy5tYWluUGFnZSkge1xyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgJ2FjdGl2ZScpO1xyXG4gICAgICAgIGNvbnRhaW5lcnMuY29udGVudC5hcHBlbmRDaGlsZCh2aWV3LmNvbnRlbnQpO1xyXG4gICAgICAgIGNvbnRhaW5lcnMucm9vdC5jdXJyZW50VmlldyA9IHZpZXc7XHJcbiAgICB9XHJcbn07XHJcblxyXG5VdGlscy5hbGVydCA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7XHJcbiAgICB2ZXguZGlhbG9nLmFsZXJ0KG1lc3NhZ2UpO1xyXG59O1xyXG5cclxuVXRpbHMuY29uZmlybSA9IGZ1bmN0aW9uIChtZXNzYWdlLCBvbk9rLCBvbkNhbmNlbCkge1xyXG4gICAgdmV4LmRpYWxvZy5jb25maXJtKHtcclxuICAgICAgICBtZXNzYWdlLFxyXG4gICAgICAgIGNhbGxiYWNrOiAodmFsKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvbk9rKSBvbk9rKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob25DYW5jZWwpIG9uQ2FuY2VsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG5VdGlscy5yZW1vdmVDaGlsZHJlbiA9IGZ1bmN0aW9uIChteU5vZGUpIHtcclxuICAgIGlmICghbXlOb2RlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgd2hpbGUgKG15Tm9kZS5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgbXlOb2RlLnJlbW92ZUNoaWxkKG15Tm9kZS5maXJzdENoaWxkKTtcclxuICAgIH1cclxufTtcclxuXHJcblV0aWxzLnByb2Nlc3NFcnJvciA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKGFyZ3VtZW50c1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2soLi4uYXJyKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuVXRpbHMuaGFuZGxlRXJyb3JNc2cgPSBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICBjb25zdCBjaGVja0Vycm9yVHlwZSA9IFIuY3VycnkoKGVycjIsIG5hbWUpID0+IGVycjIgaW5zdGFuY2VvZiBFcnJvcnNbbmFtZV0gfHwgKGVycjIubmFtZSAmJiBlcnIyLm5hbWUgPT09IG5hbWUpKTtcclxuICAgIGlmIChSLmtleXMoRXJyb3JzKS5zb21lKGNoZWNrRXJyb3JUeXBlKGVycikpKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0ckZvcm1hdChnZXRMMTBuKGVyci5tZXNzYWdlSWQpLCBlcnIucGFyYW1ldGVycyk7XHJcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnIgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgcmV0dXJuIGVyci5tZXNzYWdlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVycjtcclxufTtcclxuXHJcblV0aWxzLmhhbmRsZUVycm9yID0gZXJyID0+IFV0aWxzLmFsZXJ0KFV0aWxzLmhhbmRsZUVycm9yTXNnKGVycikpO1xyXG5cclxuVXRpbHMuZW5hYmxlRWwgPSBSLmN1cnJ5KChlbCwgY29uZGl0aW9uKSA9PiB7XHJcbiAgICBjb25zdCBrZXkgPSBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICd0ZXh0YXJlYScgPyAncmVhZG9ubHknIDogJ2Rpc2FibGVkJztcclxuICAgIGlmIChjb25kaXRpb24pIHtcclxuICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZWwuc2V0QXR0cmlidXRlKGtleSwga2V5KTtcclxuICAgIH1cclxufSk7XHJcblxyXG5VdGlscy5lbmFibGUgPSBmdW5jdGlvbiAocm9vdCwgY2xhc3NOYW1lLCBjb25kaXRpb24pIHtcclxuICAgIG5sMmFycmF5KHJvb3QuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpKS5tYXAoVXRpbHMuZW5hYmxlRWwoUi5fXywgY29uZGl0aW9uKSk7XHJcbn07XHJcblxyXG5VdGlscy5jaGFyT3JkQU9iamVjdCA9IENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShhID0+IGEuZGlzcGxheU5hbWUudG9Mb3dlckNhc2UoKSk7XHJcblxyXG5VdGlscy5yZWJ1aWxkU2VsZWN0b3IgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG5hbWVzKSB7XHJcbiAgICBjbGVhckVsKHNlbGVjdG9yKTtcclxuICAgIG5hbWVzLmZvckVhY2goKG5hbWVJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgICAgICBvcHRpb24uYXBwZW5kQ2hpbGQobWFrZVRleHQobmFtZUluZm8uZGlzcGxheU5hbWUpKTtcclxuICAgICAgICBvcHRpb24udmFsdWUgPSBuYW1lSW5mby52YWx1ZTtcclxuICAgICAgICBzZWxlY3Rvci5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5VdGlscy5yZWJ1aWxkU2VsZWN0b3JBcnIgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG5hbWVzKSB7XHJcbiAgICBjbGVhckVsKHNlbGVjdG9yKTtcclxuICAgIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgIG9wdGlvbi5hcHBlbmRDaGlsZChtYWtlVGV4dChuYW1lKSk7XHJcbiAgICAgICAgc2VsZWN0b3IuYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuU3RyaW5nLnByb3RvdHlwZS5lbmRzV2l0aCA9IGZ1bmN0aW9uIChzdWZmaXgpIHtcclxuICAgIHJldHVybiB0aGlzLmluZGV4T2Yoc3VmZml4LCB0aGlzLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTtcclxufTtcclxuXHJcbi8vIGZyb20gZGF0ZSBmb3JtYXQgdXRpbHNcclxuLy9Gb3IgY29udmVuaWVuY2UuLi5cclxuRGF0ZS5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKG1hc2ssIHV0Yykge1xyXG4gICAgcmV0dXJuIGRhdGVGb3JtYXQodGhpcywgbWFzaywgdXRjKTtcclxufTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIHN0YXRlLnZpZXdzID0ge307XHJcblxyXG4gICAgY29uc3QgYnRuT3B0cyA9IHtcclxuICAgICAgICB0b29sdGlwOiB0cnVlLFxyXG4gICAgICAgIGNsYXNzTmFtZTogJ21haW5OYXZCdXR0b24nXHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMub25NYXN0ZXJQYWdlTG9hZCA9ICgpID0+IHtcclxuICAgICAgICBpbml0UGFnZSgpO1xyXG4gICAgICAgIGNvbnN0IExvY2FsREJNUyA9IG1ha2VMb2NhbERCTVModHJ1ZSk7XHJcbiAgICAgICAgaWYgKE1PREUgPT09ICdTdGFuZGFsb25lJykge1xyXG4gICAgICAgICAgICB3aW5kb3cuREJNUyA9IG5ldyBMb2NhbERCTVMoKTtcclxuICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShCYXNlRXhhbXBsZS5kYXRhLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhvbkRhdGFiYXNlTG9hZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoTU9ERSA9PT0gJ05JTVNfU2VydmVyJykge1xyXG4gICAgICAgICAgICBjb25zdCBSZW1vdGVEQk1TID0gbWFrZVJlbW90ZURCTVMoTG9jYWxEQk1TKTtcclxuICAgICAgICAgICAgd2luZG93LkRCTVMgPSBuZXcgUmVtb3RlREJNUygpO1xyXG4gICAgICAgICAgICBjb25zaXN0ZW5jeUNoZWNrKG9uRGF0YWJhc2VMb2FkKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uRGF0YWJhc2VMb2FkKCkge1xyXG4gICAgICAgIC8vICAgICAgICBpbml0VGhlbWUoKTtcclxuXHJcbiAgICAgICAgc3RhdGVJbml0KCk7XHJcblxyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ2NoYXJzaGVldCcsIENoYXJzaGVldCwgeyBtYWluUGFnZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdpbnN0cnVjdGlvbicsIEluc3RydWN0aW9uKTtcclxuXHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ25hdi1zZXBhcmF0b3InKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGJ1dHRvbiA9IG1ha2VCdXR0b24oJ2RhdGFMb2FkQnV0dG9uJywgJ29wZW4tZGF0YWJhc2UnLCBudWxsLCBidG5PcHRzKTtcclxuICAgICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgRmlsZVV0aWxzLnJlYWRTaW5nbGVGaWxlLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIGlucHV0LnR5cGUgPSAnZmlsZSc7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICBzZXRBdHRyKGlucHV0LCAndGFiaW5kZXgnLCAtMSk7XHJcbiAgICAgICAgYnV0dG9uLmFwcGVuZENoaWxkKGlucHV0KTtcclxuICAgICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBpbnB1dC5jbGljaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGJ1dHRvbik7XHJcblxyXG4gICAgICAgIC8vICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJ0aGVtZUJ1dHRvblwiLCBcInRoZW1lXCIsICgpID0+IG5leHRUaGVtZSgpLCBidG5PcHRzKSk7XHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignZGF0YVNhdmVCdXR0b24nLCAnc2F2ZS1kYXRhYmFzZScsIEZpbGVVdGlscy5zYXZlRmlsZSwgYnRuT3B0cykpO1xyXG4gICAgICAgIGlmIChNT0RFID09PSAnU3RhbmRhbG9uZScpIHtcclxuICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignbmV3QmFzZUJ1dHRvbicsICdjcmVhdGUtZGF0YWJhc2UnLCBGaWxlVXRpbHMubWFrZU5ld0Jhc2UsIGJ0bk9wdHMpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9hZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwibWFpbkhlbHBCdXR0b25cIiwgXCJkb2NzXCIsIEZpbGVVdGlscy5vcGVuSGVscCwgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlTDEwbkJ1dHRvbigpKTtcclxuXHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnbG9nVmlld2VyJywgTG9nVmlld2VyMiwgeyBjbGF6ejogJ2xvZ1ZpZXdlckJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcbiAgICAgICAgLy8gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ3Rlc3RCdXR0b24nLCAndGVzdCcsIHJ1blRlc3RzLCBidG5PcHRzKSk7XHJcblxyXG4gICAgICAgIC8vYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbihcInJlZnJlc2hCdXR0b25cIiwgXCJyZWZyZXNoXCIsICgpID0+IHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKSwgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICBGaWxlVXRpbHMuaW5pdCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5Q2hlY2soc3RhdGUuY3VycmVudFZpZXcucmVmcmVzaCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICBhZGRCZWZvcmVVbmxvYWRMaXN0ZW5lcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGluaXRQYWdlKCkge1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSgoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCkpO1xyXG4gICAgICAgIFVJLmluaXRTZWxlY3RvckZpbHRlcnMoKTtcclxuICAgICAgICBVSS5pbml0UGFuZWxUb2dnbGVycygpO1xyXG4gICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURpYWxvZ3MoKSB7XHJcbiAgICAgICAgICAgIHZleC5kaWFsb2cuYnV0dG9ucy5ZRVMudGV4dCA9IGdldEwxMG4oJ2NvbW1vbi1vaycpO1xyXG4gICAgICAgICAgICB2ZXguZGlhbG9nLmJ1dHRvbnMuTk8udGV4dCA9IGdldEwxMG4oJ2NvbW1vbi1jYW5jZWwnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdXBkYXRlRGlhbG9ncygpO1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKHVwZGF0ZURpYWxvZ3MpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vICAgIHZhciBjdXJUaGVtZSA9IENvbnN0YW50cy50aGVtZUxpc3RbMV07XHJcbiAgICAvL1xyXG4gICAgLy8gICAgdmFyIGluaXRUaGVtZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgLy8gICAgICAgIGlmKERCTVMuc2V0VGhlbWUpe1xyXG4gICAgLy8gICAgICAgICAgICBEQk1TLmdldFRoZW1lKGZ1bmN0aW9uKGVyciwgdGhlbWUpe1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYoZXJyKSB7Y29uc29sZS5sb2coZXJyKTt9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZih0aGVtZSAhPT0gJycpe1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGN1clRoZW1lID0gdGhlbWU7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBhZGRDbGFzcyhxdWVyeUVsKCdib2R5JyksIGN1clRoZW1lKTtcclxuICAgIC8vICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgYWRkQ2xhc3MocXVlcnlFbCgnYm9keScpLCBjdXJUaGVtZSk7XHJcbiAgICAvLyAgICAgICAgfVxyXG4gICAgLy8gICAgfTtcclxuICAgIC8vXHJcbiAgICAvLyAgICB2YXIgbmV4dFRoZW1lID0gZnVuY3Rpb24oKSB7XHJcbiAgICAvLyAgICAgICAgcmVtb3ZlQ2xhc3MocXVlcnlFbCgnYm9keScpLCBjdXJUaGVtZSk7XHJcbiAgICAvLyAgICAgICAgY3VyVGhlbWUgPSBDb25zdGFudHMudGhlbWVMaXN0WyhSLmluZGV4T2YoY3VyVGhlbWUsIENvbnN0YW50cy50aGVtZUxpc3QpKzEpJUNvbnN0YW50cy50aGVtZUxpc3QubGVuZ3RoXTtcclxuICAgIC8vICAgICAgICBhZGRDbGFzcyhxdWVyeUVsKCdib2R5JyksIGN1clRoZW1lKTtcclxuICAgIC8vICAgICAgICBpZihEQk1TLnNldFRoZW1lKXtcclxuICAgIC8vICAgICAgICAgICAgREJNUy5zZXRUaGVtZShjdXJUaGVtZSwgZnVuY3Rpb24oZXJyKXtcclxuICAgIC8vICAgICAgICAgICAgICAgIGlmKGVycikge2NvbnNvbGUubG9nKGVycik7IHJldHVybjt9XHJcbiAgICAvLyAgICAgICAgICAgIH0pO1xyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gY29uc2lzdGVuY3lDaGVjayhjYWxsYmFjaykge1xyXG4gICAgICAgIERCTVMuZ2V0Q29uc2lzdGVuY3lDaGVja1Jlc3VsdCgoZXJyLCBjb25zaXN0ZW5jeUVycm9ycykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zaXN0ZW5jeUVycm9ycy5mb3JFYWNoKENvbW1vblV0aWxzLmNvbnNvbGVMb2cpO1xyXG4gICAgICAgICAgICBpZiAoY29uc2lzdGVuY3lFcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignb3ZlcnZpZXctY29uc2lzdGVuY3ktcHJvYmxlbS1kZXRlY3RlZCcpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDb25zaXN0ZW5jeSBjaGVjayBkaWRuXFwndCBmaW5kIGVycm9ycycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3RhdGVJbml0KCkge1xyXG4gICAgICAgIHN0YXRlLm5hdmlnYXRpb24gPSBnZXRFbCgnbmF2aWdhdGlvbicpO1xyXG4gICAgICAgIHN0YXRlLmNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBzdGF0ZS5uYXZpZ2F0aW9uLFxyXG4gICAgICAgICAgICBjb250ZW50OiBnZXRFbCgnY29udGVudEFyZWEnKVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcnVuVGVzdHMoKSB7XHJcbiAgICAgICAgREJNUy5nZXRDb25zaXN0ZW5jeUNoZWNrUmVzdWx0KChlcnIsIGNvbnNpc3RlbmN5RXJyb3JzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5RXJyb3JzLmZvckVhY2goQ29tbW9uVXRpbHMuY29uc29sZUxvZyk7XHJcbiAgICAgICAgICAgIGlmIChjb25zaXN0ZW5jeUVycm9ycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdvdmVydmlldy1jb25zaXN0ZW5jeS1wcm9ibGVtLWRldGVjdGVkJykpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignb3ZlcnZpZXctY29uc2lzdGVuY3ktaXMtb2snKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29uc2lzdGVuY3kgY2hlY2sgZGlkblxcJ3QgZmluZCBlcnJvcnMnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VCdXR0b24oY2xhenosIG5hbWUsIGNhbGxiYWNrLCBvcHRzKSB7XHJcbiAgICAgICAgY29uc3QgYnV0dG9uID0gbWFrZUVsKCdidXR0b24nKTtcclxuICAgICAgICBhZGRDbGFzcyhidXR0b24sIGNsYXp6KTtcclxuICAgICAgICBmdW5jdGlvbiBkZWxlZ2F0ZSgpIHtcclxuICAgICAgICAgICAgJChidXR0b24pLmF0dHIoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCBMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdHMudG9vbHRpcCkge1xyXG4gICAgICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShkZWxlZ2F0ZSk7XHJcbiAgICAgICAgICAgICQoYnV0dG9uKS50b29sdGlwKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VtZW50OiAnYm90dG9tJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCAnYWN0aW9uLWJ1dHRvbicpO1xyXG4gICAgICAgIGlmIChvcHRzLmNsYXNzTmFtZSkge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhidXR0b24sIG9wdHMuY2xhc3NOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsIGNhbGxiYWNrKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGJ1dHRvbjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlTDEwbkJ1dHRvbigpIHtcclxuICAgICAgICBjb25zdCBsMTBuQnRuID0gbWFrZUJ1dHRvbigndG9nZ2xlTDEwbkJ1dHRvbicsICdsMTBuJywgTDEwbi50b2dnbGVMMTBuLCBidG5PcHRzKTtcclxuICAgICAgICBmdW5jdGlvbiBzZXRJY29uKCkge1xyXG4gICAgICAgICAgICBsMTBuQnRuLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IHN0ckZvcm1hdCgndXJsKFwiLi9pbWFnZXMvezB9LnN2Z1wiKScsIFtnZXRMMTBuKCdoZWFkZXItZGljdGlvbmFyeS1pY29uJyldKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2Uoc2V0SWNvbik7XHJcbiAgICAgICAgc2V0SWNvbigpO1xyXG4gICAgICAgIHJldHVybiBsMTBuQnRuO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGFkZEJlZm9yZVVubG9hZExpc3RlbmVyKCkge1xyXG4gICAgICAgIHdpbmRvdy5vbmJlZm9yZXVubG9hZCA9IChldnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGdldEwxMG4oJ3V0aWxzLWNsb3NlLXBhZ2Utd2FybmluZycpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGV2dCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgICAgIGV2dCA9IHdpbmRvdy5ldmVudDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZXZ0KSB7XHJcbiAgICAgICAgICAgICAgICBldnQucmV0dXJuVmFsdWUgPSBtZXNzYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn0pKHRoaXMuUGFnZU1hbmFnZXIgPSB7fSk7XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
