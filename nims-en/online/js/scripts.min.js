/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const showNotification = true;
    const notificationTimeout = 2000;
    
    exports.onCallStart = () => {
        if (!showNotification) return;
        const notificationBox = clearEl(getEl('debugNotification'));
        removeClass(notificationBox, 'hidden');
        removeClass(notificationBox, 'operationOK');
        removeClass(notificationBox, 'operationFail');
        addEl(notificationBox, makeText(L10n.get('constant', 'saving')));
    };
    
    exports.onCallFinished = (err) => {
        if (!showNotification) return;
        if(err) {
            onCallFail();
        } else {
            onCallSuccess();
        }
    };

    function onCallSuccess(){
        const notificationBox = getEl('debugNotification');
        addClass(notificationBox, 'operationOK');
        addEl(clearEl(notificationBox), makeText(L10n.get('constant', 'saving-success')));
        setTimeout(() => {
            addClass(notificationBox, 'hidden');
        }, notificationTimeout);
    }

    function onCallFail(){
        const notificationBox = getEl('debugNotification');
        addClass(notificationBox, 'operationFail');
        addEl(clearEl(notificationBox), makeText(L10n.get('constant', 'saving-fail')));
        setTimeout(() => {
            addClass(notificationBox, 'hidden');
        }, notificationTimeout);
    }
    
    
})(this.CallNotificator = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, Database, Migrator
 */

'use strict';

/* eslint-disable func-names */

function makeLocalDBMS(fullVersion) {
//    if(!fullVersion){
//        function LocalDBMS(){
//        };
//        return LocalDBMS;
//    }
    const listeners = {};

    function addListener(eventName, callback) {
        listeners[eventName] = listeners[eventName] || [];
        listeners[eventName].push(callback);
    }

    const opts = {
        Migrator,
        CommonUtils,
        CU: CommonUtils,
        ProjectUtils,
        PU: ProjectUtils,
        Precondition,
        PC: Precondition,
        EventEmitter,
        R,
        Ajv,
        Schema,
        Errors,
        addListener,
        Constants,
        dbmsUtils: {},
        dateFormat,
    };

    function LocalDBMS() {
        this._init(listeners);
    }

    LocalDBMS.prototype.getSettings = function () {
        'use strict';

        return this.database.Settings;
    };

    const funcList = {};
    const func = R.curry((name) => {
        const before = R.keys(LocalDBMS.prototype);
        window[name](LocalDBMS, opts);
        const after = R.keys(LocalDBMS.prototype);
        const diff = R.difference(after, before);
        //        console.log(`${name} ${diff}`);
        funcList[name] = R.zipObj(diff, R.repeat(true, diff.length));
    });

    ['baseAPI',
        'consistencyCheckAPI',
        'statisticsAPI',
        'profilesAPI',
        'profileBindingAPI',

        'profileViewAPI',

        'groupsAPI',
        'groupSchemaAPI',
        'investigationBoardAPI',
        'relationsAPI',
        'briefingExportAPI',

        'profileConfigurerAPI',
        'entityAPI',
        'storyBaseAPI',
        'storyEventsAPI',
        'storyCharactersAPI',

        'storyViewAPI',
        'storyAdaptationsAPI',
        'accessManagerAPI',
        'textSearchAPI',
        'gearsAPI',
        'slidersAPI',
        'logAPI'].map(func);

    Logger.attachLogCalls(LocalDBMS, R, false);

    const baseAPIList = R.keys(R.mergeAll(R.values(funcList)));
    const loggerAPIList = R.difference(R.keys(R.mergeAll(R.values(Logger.apiInfo))), Logger.offlineIgnoreList);

    const loggerDiff = R.symmetricDifference(loggerAPIList, baseAPIList);
    if (loggerDiff.length > 0) {
        console.error(`Logger diff: ${loggerDiff}`);
        console.error(`Logged but not in base: ${R.difference(loggerAPIList, baseAPIList)}`);
        console.error(`In base but not logged: ${R.difference(baseAPIList, loggerAPIList)}`);
        throw new Error('API processors are inconsistent');
    }

    return LocalDBMS;
}

function makeLocalDBMSWrapper(dbms) {

    function LocalDBMSWrapper(dbms) {
        this.dbms = dbms;
        this.clearSettings();
    }
    
    Object.keys(dbms.__proto__).forEach((name) => {
        LocalDBMSWrapper.prototype[name] = function () {
            if (CommonUtils.startsWith(name, 'get') || CommonUtils.startsWith(name, 'is') || R.equals(name, 'log')) {
                this.dbms[name].apply(this.dbms, arguments);
            } else {
                const callback = arguments[arguments.length - 1];
                const arr = [];
                for (let i = 0; i < arguments.length - 1; i++) {
                    arr.push(arguments[i]);
                }
                
                CallNotificator.onCallStart();
                
                arr.push(function(err) {
                    CallNotificator.onCallFinished(err);
                    callback(err);
                });
                this.dbms[name].apply(this.dbms, arr);
            }
        };
    });
    
    Promisificator.promisify(dbms, LocalDBMSWrapper);

    LocalDBMSWrapper.prototype.clearSettings = function () {
        this.Settings = {
            BriefingPreview: {},
            Stories: {},
            ProfileEditor: {}
        };
    };

    LocalDBMSWrapper.prototype.getSettings = function () {
        return this.Settings;
    };
    return new LocalDBMSWrapper(dbms);
}
/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    exports.promisify = (src, dst) => {
        Object.keys(src.__proto__).forEach((name) => {
            dst.prototype[name + 'Pm'] = function () {
                if (CommonUtils.startsWith(name, 'get') || CommonUtils.startsWith(name, 'is') || R.equals(name, 'log')) {
                    const arr = [];
                    for (let i = 0; i < arguments.length; i++) {
                        arr.push(arguments[i]);
                    }
                    
                    return new Promise(function(resolve, reject) {
                        arr.push(function(err, value) {
                            if(err) {reject(err); return;}
                            resolve(value);
                        });
                        this.dbms[name].apply(this.dbms, arr);
                    }.bind(this));
                } else {
                    const arr = [];
                    for (let i = 0; i < arguments.length; i++) {
                        arr.push(arguments[i]);
                    }
                    
                    CallNotificator.onCallStart();
                    
                    return new Promise(function(resolve, reject) {
                        arr.push(function(err, value) {
                            CallNotificator.onCallFinished(err);
                            
                            if(err) {reject(err); return;}
                            resolve();
                        });
                        this.dbms[name].apply(this.dbms, arr);
                    }.bind(this));
                }
            }
        });
    }
    
    
})(this.Promisificator = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, Database
 */

'use strict';

/* eslint-disable func-names,prefer-rest-params */


function makeRemoteDBMS(LocalDBMS) {
    const showNotification = true;
    const notificationTimeout = 2000;
    //const notificationTimeout = 10000;
    const url = '/';

    function RemoteDBMS() {
        this.clearSettings();
    }

    RemoteDBMS._simpleGet = function (name, params, callback) {
        let paramStr = '';
        if (params) {
            paramStr = `?params=${encodeURIComponent(JSON.stringify(params))}`;
        }

        const request = $.ajax({
            url: url + name + paramStr,
            dataType: 'text',
            method: 'GET',
            contentType: 'application/json;charset=utf-8',
            cache: false,
            timeout: Constants.httpTimeout,
        });

        request.done((data) => {
            callback(null, JSON.parse(data));
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            try {
                callback(JSON.parse(errorInfo.responseText));
            } catch (err) {
                callback(errorInfo.responseText || textStatus || 'error');
            }
        });
    };

    RemoteDBMS._simplePut = function (name, data, callback) {
        const request = $.ajax({
            url: url + name,
            dataType: 'text',
            method: 'PUT',
            contentType: 'application/json;charset=utf-8',
            data: JSON.stringify(data),
            timeout: Constants.httpTimeout
        });
        
        CallNotificator.onCallStart();

        request.done((data2) => {
            CallNotificator.onCallFinished();
            if (callback) callback();
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            CallNotificator.onCallFinished(errorInfo);
            try {
                callback(JSON.parse(errorInfo.responseText));
            } catch (err) {
                callback(errorInfo.responseText || textStatus || 'error');
            }
        });
    };


    Object.keys(LocalDBMS.prototype).forEach((name) => {
        RemoteDBMS.prototype[name] = function () {
            const arr = [];
            for (let i = 0; i < arguments.length - 1; i++) {
                arr.push(arguments[i]);
            }
            //            if(CommonUtils.startsWith(name, "_")){
            //                // do nothing for inner functions
            //            } else
            if (CommonUtils.startsWith(name, 'get') || CommonUtils.startsWith(name, 'is')) {
                RemoteDBMS._simpleGet(name, arr, arguments[arguments.length - 1]);
            } else {
                RemoteDBMS._simplePut(name, arr, arguments[arguments.length - 1]);
            }
        };
    });
    
    // promisification
    Object.keys(LocalDBMS.prototype).forEach((name) => {
        RemoteDBMS.prototype[name + 'Pm'] = function () {
            const arr = [];
            for (let i = 0; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            //            if(CommonUtils.startsWith(name, "_")){
            //                // do nothing for inner functions
            //            } else
            return new Promise(function(resolve, reject) {
                if (CommonUtils.startsWith(name, 'get') || CommonUtils.startsWith(name, 'is')) {
                    RemoteDBMS._simpleGet(name, arr, function(err, value) {
                        if(err) {reject(err); return;}
                        resolve(value);
                    });
                } else {
                    RemoteDBMS._simplePut(name, arr, function(err, value) {
                        if(err) {reject(err); return;}
                        resolve();
                    });
                }
            }.bind(this));
        };
    });

    RemoteDBMS.prototype.clearSettings = function () {
        this.Settings = {
            BriefingPreview: {},
            Stories: {},
            ProfileEditor: {}
        };
    };

    RemoteDBMS.prototype.getSettings = function () {
        return this.Settings;
    };
    return RemoteDBMS;
}

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    exports.makeNewBase = (callback) => () => {
        Utils.confirm(getL10n('utils-new-base-warning'), () => {
            DBMS.setDatabase(CommonUtils.clone(EmptyBase.data), callback);
//            TestUtils.addGroupTestingData();
        });
    };

    exports.openHelp = () => {
        window.open('extras/doc/nims.html');
    };

    exports.readSingleFile = (callback) => (evt) => {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                const contents = e.target.result;
                try {
                    const database = JSON.parse(contents);
                    DBMS.setDatabase(database, callback);
                } catch (err) {
                    callback(err);
                }
            };
            r.readAsText(f);
        } else {
            Utils.alert(getL10n('utils-base-file-loading-error'));
        }
    };

    exports.saveFile = () => {
        DBMS.getDatabase((err, database) => {
            if (err) { Utils.handleError(err); return; }
            exports.json2File(database, exports.makeFileName(`${BASE_FILE_NAME}_${database.Meta.name}`, 'json', new Date(database.Meta.saveTime)));
        });
    };
    
    exports.makeFileName = (root, extension, date) => {
        date = date || new Date();
        const timeStr = date.format('dd-mmm-yyyy_HH-MM-ss');
        const fileName = `${root}_${timeStr}`;
        return `${CommonUtils.sanitizeStr2FileName(fileName)}.${extension}`;
    };

    exports.json2File = (str, fileName) => {
        exports.str2File(JSON.stringify(str, null, '  '), fileName);
    };

    exports.str2File = (str, fileName) => {
        const blob = new Blob([str], {
            type: 'text/plain;charset=utf-8'
        });
        saveAs(blob, fileName);
    };

    function preprocessCsvStr(str) {
        if (!(typeof str === 'string' || str instanceof String)) {
            return str;
        }
        let result = str.replace(/"/g, '""');
        if (result.search(/("|,|\n)/g) >= 0) {
            result = `"${result}"`;
        }
        return result;
    }

    exports.arr2d2Csv = (arr, fileName) => {
        const csv = `\ufeff${arr.map(dataArray => dataArray.map(preprocessCsvStr).join(';')).join('\n')}`;

        const out = new Blob([csv], {
            type: 'text/csv;charset=utf-8;'
        });
        saveAs(out, exports.makeFileName(fileName, 'csv'));
    };
})(this.FileUtils = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports, Dictionaries) => {
    const state = {};

    state.initialized = false;
    state.l10nDelegates = [];
    state.dictionaries = {};
    state.lang = defaultLang;

    exports.init = () => {
        if (state.initialized) {
            return;
        }
        //        console.log(navigator.language);

        state.dictionaries = R.map(processDictionary, Dictionaries);

        //    var lang = (navigator.languages ? navigator.languages[0] : navigator.browserLanguage).split('-')[0];
        //    var lang = 'ru';
        //        var lang = defaultLang;
        //        console.log(lang);

        if (state.dictionaries[defaultLang]) {
            state.dict = state.dictionaries[defaultLang];
        } else {
            state.dict = state.dictionaries.en;
        }
        setHtmlLang(defaultLang);
        exports.onL10nChange(exports.localizeStatic);
        state.initialized = true;
    };

    var processDictionary = (dictionary) => {
        const processedDictionary = {};
        R.toPairs(dictionary).forEach(([sectionName, section]) => {
            R.toPairs(section).forEach(([key, value]) => {
                processedDictionary[`${sectionName}-${key}`] = value;
            });
        });
        //        for (const sectionName in dictionary) {
        //            for (const name in dictionary[sectionName]) {
        //                processedDictionary[`${sectionName}-${name}`] = dictionary[sectionName][name];
        //            }
        //        }
        return processedDictionary;
    };

    var setHtmlLang = lang => setAttr(document.getElementsByTagName('html')[0], 'lang', lang);
    
    exports.getLocale = () => state.lang;

    exports.toggleL10n = () => {
        if (state.lang === 'ru') {
            state.dict = state.dictionaries.en;
            state.lang = 'en';
        } else {
            state.dict = state.dictionaries.ru;
            state.lang = 'ru';
        }
        setHtmlLang(state.lang);
        state.l10nDelegates.forEach((delegate) => {
            delegate();
        });
    };

    exports.getLang = () => state.lang.toLowerCase();

    exports.format = R.curry((namespace, name, args) => strFormat(exports.get(namespace, name), args));

    exports.get = R.curry((namespace, name) => L10n.getValue(`${namespace}-${name}`));

    exports.getValue = (name) => {
        const value = state.dict[name];
        if (value === undefined) console.log(`Value is not found: ${name}`);
        return value || `${name}:RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA`;
    };
    
    exports.hasValue = (name) => {
        const value = state.dict[name];
        return value !== undefined;
    };

    exports.onL10nChange = (delegate) => {
        state.l10nDelegates.push(delegate);
    };

    exports.localizeStatic = (el) => {
        el = el || document;
        nl2array(qees(el, '[l10n-id]')).map(el2 =>
            addEl(clearEl(el2), makeText(exports.getValue(getAttr(el2, 'l10n-id')))));
        nl2array(qees(el, '[l10n-placeholder-id]')).map(el2 =>
            setAttr(el2, 'placeholder', exports.getValue(getAttr(el2, 'l10n-placeholder-id'))));
        nl2array(qees(el, '[l10n-title]')).map(el2 =>
            setAttr(el2, 'title', exports.getValue(getAttr(el2, 'l10n-title'))));
    };
})(this.L10n = {}, Dictionaries);

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const indexedDB     = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    const IDBTransaction  = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
    const baseName      = "filesBase";
    const storeName     = "filesStore";
    
// // This works on all devices/browsers, and uses IndexedDBShim as a final fallback 
//    var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;
//
//    // Open (or create) the database
//    var open = indexedDB.open("MyDatabase", 1);
//
//    // Create the schema
//    open.onupgradeneeded = function() {
//        var db = open.result;
//        var store = db.createObjectStore("MyObjectStore", {keyPath: "id"});
//        var index = store.createIndex("NameIndex", ["name.last", "name.first"]);
//    };
//
//    open.onsuccess = function() {
//        // Start a new transaction
//        var db = open.result;
//        var tx = db.transaction("MyObjectStore", "readwrite");
//        var store = tx.objectStore("MyObjectStore");
//        var index = store.index("NameIndex");
//
//        // Add some data
//        store.put({id: 12345, name: {first: "John", last: "Doe"}, age: 42});
//        store.put({id: 67890, name: {first: "Bob", last: "Smith"}, age: 35});
//        
//        // Query the data
//        var getJohn = store.get(12345);
//        var getBob = index.get(["Smith", "Bob"]);
//
//        getJohn.onsuccess = function() {
//            console.log(getJohn.result.name.first);  // => "John"
//        };
//
//        getBob.onsuccess = function() {
//            console.log(getBob.result.name.first);   // => "Bob"
//        };
//
//        // Close the db when the transaction is done
//        tx.oncomplete = function() {
//            db.close();
//        };
//    }
    
    exports.test = () => {
//        console.log('2323223');
//        exports.put('base1', {
//            'sd':12,
//        }, logerr2);
//        exports.put('base2', {
//            'ssdsdd':1654654,
//        }, logerr2);
//        exports.get('base1', (err, base) => {
//            if(err) {console.log(err); return;}
//            console.log(base);
//        });
//        exports.get('base3', (err, base) => {
//            if(err) {console.log(err); return;}
//            console.log(base);
//        });
    };

    function logerr(err){
        console.log(err);
    }
    
    var logerr2 = (err) => {
        if(err) {console.log(err); return;}
    };
    
    function connectDB(callback){
        var request = indexedDB.open(baseName, 1);
        request.onerror = callback;
        request.onsuccess = function(){
            callback(null, request.result);
        }
        request.onupgradeneeded = function(e){
            e.currentTarget.result.createObjectStore(storeName, { keyPath: "id" });
            connectDB(callback);
        }
    }
    
    exports.get = (id) => {
        return new Promise(function(resolve, reject) {
            connectDB(function(err, db){
                if(err) {reject(err); return;}
                var request = db.transaction([storeName], "readonly").objectStore(storeName).get(id);
                request.onerror = reject;
                request.onsuccess = function(){
                    resolve(request.result ? request.result : null);
                }
            });
        });
    }
    
    exports.put = (id, obj) => {
        return new Promise(function(resolve, reject) {
            connectDB(function(err, db){
                if(err) {reject(err); return;}
                var request = db.transaction([storeName], "readwrite").objectStore(storeName).put({id, obj});
                request.onerror = reject;
                request.onsuccess = function(){
                    resolve(request.result);
                }
            });
        });
    }
})(this.LocalBaseAPI = {});
/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    exports.runTests = () => {
        queryEl('body').style.overflow = 'auto';
        window.RunTests();
    };

    exports.showConsistencyCheckAlert = (checkRes) => {
        if (checkRes === undefined || checkRes.errors.length === 0) {
            Utils.alert(getL10n('overview-consistency-is-ok'));
        } else {
            Utils.alert(getL10n('overview-consistency-problem-detected'));
        }
    };

    exports.clickThroughtHeaders = () => {
        let tabs = queryEls('#navigation .navigation-button');

        let index = 0;
        let subTabsNum = 0;
        function runClicker() {
            if (index <= tabs.length - 1) {
                tabs[index].click();
                if (subTabsNum === 0) {
                    const subTabs = queryEls('#contentArea .navigation-button');
                    tabs = R.insertAll(index + 1, subTabs, tabs);
                    subTabsNum = subTabs.length;
                } else {
                    subTabsNum--;
                }
                index++;
                setTimeout(runClicker, 500);
            }
        }
        runClicker();
    };

    exports.showModuleSchema = (checkRes) => {
        addEl(queryEl('body'), queryEl('.consistency-check-result-dialog'));
        $(queryEl('.consistency-check-result-dialog')).modal('show');

        const svg = d3.select('.image-place svg');
        const svgGroup = svg.append('g');
        const root = svgGroup.append('g');

        // define an arrow head
        svg.append('svg:defs')
            .append('svg:marker')
            .attr('id', 'end')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', 3) // marker settings
            .attr('markerHeight', 5)
            .attr('orient', 'auto')
            .style('fill', '#999')
            .style('stroke-opacity', 0.6) // arrowhead color
            .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5');

        const nodeDict = checkRes.nodes.reduce((dict, name, i) => {
            dict[name] = i;
            return dict;
        }, {});

        const nodeWidth = 170;
        const nodeHeight = 30;

        const name2Node = name => ({
            id: nodeDict[name],
            name,
            width: nodeWidth,
            height: nodeHeight
        });

        const pair2Edge = (pair, i) => ({
            id: i + checkRes.nodes.length,
            source: nodeDict[pair[0]],
            target: nodeDict[pair[1]]
        });

        const graph = {
            nodes: checkRes.nodes.map(name2Node),
            links: checkRes.edges.map(pair2Edge)
        };

        const layouter = klay.d3adapter();
        const width = 960;
        const height = 600;

        layouter
            .nodes(graph.nodes)
            .links(graph.links)
            .size([width, height])
            .transformGroup(root)
            .options({
                edgeRouting: 'ORTHOGONAL',
                intCoordinates: false
            })
            .defaultPortSize([2, 2])
            .start();

        const link = root.selectAll('.link')
            .data(graph.links)
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', 'M0 0')
            .attr('marker-end', 'url(#end)');

        // we group nodes along with their ports
        const node = root.selectAll('.node')
            .data(graph.nodes)
            .enter()
            .append('g');

        node.append('rect')
            .attr('class', (d) => {
                const details = checkRes.details[d.name];
                if (details === undefined || details.length === 0) {
                    return 'node valid';
                }
                return 'node invalid';
            })
            .attr('width', nodeWidth)
            .attr('height', nodeHeight)
            .attr('rx', 5)
            .attr('ry', 5)
            .attr('x', 0)
            .attr('y', 0);

        node.append('text')
            .attr('x', nodeWidth / 2)
            .attr('y', nodeHeight / 2)
            .attr('alignment-baseline', 'middle')
            .attr('text-anchor', 'middle')
            .text(d => d.name)
            .attr('font-size', '4px');

        // ports
        const port = node.selectAll('.port')
            .data(d => d.ports)
            .enter()
            .append('rect')
            .attr('class', 'port')
            .attr('width', 2)
            .attr('height', 2)
            .attr('x', 0)
            .attr('y', 0);

        // apply layout
        layouter.on('finish', (d2) => {
        // apply edge routes
            link.transition().attr('d', (d) => {
                let path = '';
                path += `M${d.sourcePoint.x} ${d.sourcePoint.y} `;
                d.bendPoints.forEach((bp, i) => {
                    path += `L${bp.x} ${bp.y} `;
                });
                path += `L${d.targetPoint.x} ${d.targetPoint.y} `;
                return path;
            });

            // apply node positions
            node.transition()
                .attr('transform', d => `translate(${d.x} ${d.y})`);

            // apply port positions
            port.transition()
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        layouter.start();
    };
    
    exports.showDiffExample = () => {
        addEl(queryEl('body'), queryEl('.show-diff-dialog'));
        $(queryEl('.show-diff-dialog')).modal('show');
        
        DBMS.getLog(0, {
            action:"setMetaInfo",
            date:"",
            params:"",
            status:"OK",
            user:""
        }, (err, data) => {
            if (err) { Utils.handleError(err); return; }
            const el = clearEl(queryEl('.show-diff-dialog .container-fluid'));
            
            addEls(el, R.aperture(2, data.requestedLog).map(pair => {
                const row = qmte('.diff-row-tmpl');
                addEl(qee(row, '.first .user'), makeText(pair[0][1]));
                addEl(qee(row, '.first .time'), makeText(new Date(pair[0][2]).format('yyyy/mm/dd h:MM')));
                const firstText = JSON.parse(pair[0][4])[1];
                addEl(qee(row, '.first .text'), makeText(firstText));
                
                addEl(qee(row, '.last .user'), makeText(pair[1][1]));
                addEl(qee(row, '.last .time'), makeText(new Date(pair[1][2]).format('yyyy/mm/dd h:MM')));
                const lastText = JSON.parse(pair[1][4])[1];
                addEl(qee(row, '.last .text'), makeText(lastText));
                
                ////        const diff = JsDiff.diffChars(prevData[4] || '', rowData[4]);
                ////        const diff = JsDiff.diffWords(prevData[4] || '', rowData[4]);
//                const diff = JsDiff.diffWordsWithSpace(firstText, lastText);
                const diff = JsDiff.diffWordsWithSpace(lastText, firstText);
                const els = diff.map( part =>
                    [part.value, (part.added ? 'added' : (part.removed ? 'removed' : 'same'))]).map(pair => {
                    return addClasses(addEl(makeEl('span'), makeText(pair[0])), ['log-diff', pair[1]]);
                });
                addEls(qee(row, '.diff .text'), els);
                
                return row;
            }));
        })
    };
    
    const getAllSubsets = theArray => theArray.reduce((subsets, value) => 
        subsets.concat(subsets.map(set => [value,...set])),[[]]);
    
    exports.addGroupTestingData = () => {
        DBMS.createProfileItem('character', 'text', 'text', 0, () => '');
        DBMS.createProfileItem('character', 'string', 'string', 0, () => '');
        DBMS.createProfileItem('character', 'checkbox', 'checkbox', 0, () => '');
        DBMS.createProfileItem('character', 'number', 'number', 0, () => '');
        DBMS.createProfileItem('character', 'enum', 'enum', 0, () => '');
        DBMS.createProfileItem('character', 'multiEnum', 'multiEnum', 0, () => '');
        
        DBMS.updateDefaultValue("character","enum","1,2,3", () => '');
        DBMS.updateDefaultValue("character","multiEnum","1,2,3,4", () => '');
        
        
        const makeChar = (name, profileItem, value) => {
            DBMS.createProfile("character", name, () => '');
            DBMS.updateProfileField("character", name, profileItem, profileItem, value, () => '');
        }
        
        const makeGroup = (name, profileItem, obj) => {
            DBMS.createGroup(name, () => '');
            DBMS.saveFilterToGroup(name, [R.merge(obj, {"type":profileItem,"name":"profile-" + profileItem})], () => '');
        }
//        
//        
//        const enumValues = [1,2,3];
//        enumValues.map(value => makeChar('char enum ' + value, 'enum', String(value)));
//        getAllSubsets(enumValues).map( arr => {
//            const obj = arr.reduce( (acc, val) => {
//                acc[String(val)] = true;
//                return acc;
//            }, {});
//            makeGroup('group enum ' + arr.join(','), 'enum', {selectedOptions: obj});
//        });
//        
//        const multiEnumConditions = ['every','equal','some'];
        // bug in condition combination 
//        ['every']
//        ['every','equal']
//        ['every','some'] ...
        const multiEnumValues = [1,2,3];
        const multiEnumValues2 = [1,2,3,4];
        const multiEnumConditions = ['every','equal'];
        getAllSubsets(multiEnumValues2).map(value => makeChar('char multiEnum ' + value.join(','), 'multiEnum', String(value.join(','))));
        multiEnumConditions.map(condition => {
            getAllSubsets(multiEnumValues).map( arr => {
                const obj = arr.reduce( (acc, val) => {
                    acc[String(val)] = true;
                    return acc;
                }, {});
                makeGroup('group multiEnum ' + condition + ' ' + arr.join(','), 'multiEnum', {selectedOptions: obj, condition});
            });
        });
//        
//        
//        const numbers = [0,1,2,3,4];
//        const subNumbers = [1,2,3];
//        const numberConditions = ['greater','equal','lesser'];
//        numbers.map(value => makeChar('char number ' + value, 'number', (value)));
//        numberConditions.map(condition => {
//            subNumbers.map( num => {
//                makeGroup('group number ' + condition + ' ' + num, 'number', {num, condition});
//            });
//        });
//        
//        const checkboxes = [true, false];
//        checkboxes.map(value => makeChar('char checkbox ' + value, 'checkbox', value));
//        getAllSubsets(checkboxes).map( arr => {
//            const obj = arr.reduce( (acc, val) => {
//                acc[String(val)] = true;
//                return acc;
//            }, {});
//            makeGroup('group checkbox ' + arr.join(','), 'checkbox', {selectedOptions: obj});
//        });
//        
//        const chars = ['a','b','c','d'];
//        const subChars = ['a','b','c'];
//        getAllSubsets(chars).map(value => makeChar('char string ' + value.join(''), 'string', String(value.join(''))));
//        getAllSubsets(chars).map(value => makeChar('char text ' + value.join(''), 'text', String(value.join(''))));
//        
//        getAllSubsets(subChars).map( arr => {
//            makeGroup('group string ' + arr.join(''), 'string', {regexString: arr.join('')});
//        });
//        getAllSubsets(subChars).map( arr => {
//            makeGroup('group text ' + arr.join(''), 'text', {regexString: arr.join('')});
//        });
    }
})(this.TestUtils = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports) => {
    exports.createModalDialog = (root, onAction, opts) => {
        const commons = '.dialog-commons ';
        const el2 = wrapEl('div', qte(`${commons} .request-data-dialog-tmpl`));
        const el = qee(el2, '.modal');
        if (opts.dialogClass !== undefined) {
            addClass(el, opts.dialogClass);
        }
        const body = qee(el, '.modal-body');
        addEl(body, qte(`${commons} .${opts.bodySelector}`));
        if (opts.body !== undefined) {
            R.toPairs(opts.body).map(pair => setAttr(qee(body, pair[0]), 'l10n-id', pair[1]));
        }
        if (opts.initBody !== undefined) {
            opts.initBody(body);
        }
        addEl(body, qte(`${commons} .modal-error-block`));
        setAttr(qee(el, '.modal-title'), 'l10n-id', opts.dialogTitle);
        setAttr(qee(el, '.on-action-button'), 'l10n-id', opts.actionButtonTitle);
        L10n.localizeStatic(el);
        listen(qee(el, '.on-action-button'), 'click', onAction(el));
        el.showDlg = () => {
            clearError(el);
            $(el).modal('show');
            const focusable = qee(body, '.focusable');
            if(focusable !== null){
                setTimeout(() => focusable.focus(), 500);
            }
        };
        const onenterable = qees(body, '.onenterable');
        if(onenterable.length !== 0){
            onenterable.forEach(listenOnEnter(R.__, onAction(el)));
        }
        el.hideDlg = () => $(el).modal('hide');
        listen(qee(el, '.on-cancel-button'), 'click', () => {
            el.hideDlg()
            if(opts.onCancel) opts.onCancel();
        });
        listen(qee(el, '.on-close-button'), 'click', () => {
            el.hideDlg()
            if(opts.onCancel) opts.onCancel();
        });
        addEl(qe(root), el);
        return el;
    };

    exports.initTabPanel = (tabClazz, containerClazz) => {
        const containers = getEls(containerClazz);

        let i;
        for (i = 1; i < containers.length; i++) { // don't hide 1st element
            addClass(containers[i], 'hidden');
        }

        const tabButtons = getEls(tabClazz);

        addClass(tabButtons[0], 'active');

        for (i = 0; i < tabButtons.length; i++) {
            listen(tabButtons[i], 'click', tabButtonClick(tabButtons, containers));
        }
    };

    var tabButtonClick = (buttons, containers) => (event) => {
        for (let i = 0; i < buttons.length; i++) {
            setClassByCondition(buttons[i], 'active', event.target.id === buttons[i].id);
        }
        for (let i = 0; i < containers.length; i++) {
            hideEl(containers[i], `${event.target.id}Container` !== containers[i].id);
        }
    };

    exports.fillShowItemSelector = (selector, displayArray) => {
        let el;
        setAttr(selector, 'size', displayArray.length);
        displayArray.forEach((value) => {
            el = setProps(makeEl('option'), {
                selected: true,
            });
            hideEl(el, value.hidden);
            addEl(selector, addEl(el, makeText(value.name)));
        });
    };

    exports.fillShowItemSelector2 = (selector, optionGroups, setSize) => {
        let el, groupEl, counter = 0;
        addEls(selector, optionGroups.map((group) => {
            counter++;
            groupEl = setAttr(makeEl('optgroup'), 'label', group.displayName);
            addEls(groupEl, group.array.map((option) => {
                el = setProps(makeEl('option'), {
                    selected: true,
                });
                setAttr(el, 'value', option.name);
                counter++;
                return addEl(el, makeText(option.displayName));
            }));
            return groupEl;
        }));
        if(setSize) {
            setAttr(selector, 'size', counter);
        }
    };

//    exports.showSelectedEls = classKey => (event) => {
//        const t1 = performance.now();
//        const el = event.target;
//        let els, i, j;
//        for (i = 0; i < el.options.length; i += 1) {
//            els = getEls(classKey + i);
//            for (j = 0; j < els.length; j++) {
//                hideEl(els[j], !el.options[i].selected);
//            }
//        }
//        console.log('showSelectedEls time ' + (performance.now() - t1) + ' ms');
//    };
//    
//    exports.showSelectedEls2 = (root, classKey) => (event) => {
//        const t1 = performance.now();
//        const el = event.target;
//        let els, i, j;
//        for (i = 0; i < el.options.length; i += 1) {
//            els = queryEls(root + ' .' + classKey + i);
//            for (j = 0; j < els.length; j++) {
//                hideEl(els[j], !el.options[i].selected);
//            }
//        }
//        console.log('showSelectedEls2 time ' + (performance.now() - t1) + ' ms');
//    };
    
    exports.showSelectedEls3 = (root, classKey, attr) => (event) => {
        const t1 = performance.now();
        const el = event.target;
        let i, j;
        const map = {};
        for (i = 0; i < el.options.length; i += 1) {
            map[i] = el.options[i].selected;
        }
        const els = queryEls(root + ' .' + classKey);
        els.forEach(el2 => {
            showEl(el2, map[getAttr(el2, attr)]);
        });
        console.log('showSelectedEls3 time ' + (performance.now() - t1) + ' ms');
    };

    exports.initSelectorFilters = () => {
        queryEls('[selector-filter]').forEach((el) => {
            const sel = queryEl(getAttr(el, 'selector-filter'));
            el.value = '';
            setAttr(el, 'l10n-placeholder-id', 'constant-filter');
            addClass(el, 'form-control margin-bottom-8');
            listen(el, 'input', filterOptions(sel));
        });
    };

    var filterOptions = sel => (event) => {
        let val = event.target.value;
        let i, opt;
//        val = CommonUtils.globStringToRegex(val.trim().toLowerCase());
        val = val.toLowerCase();
        for (i = 0; i < sel.options.length; i += 1) {
            opt = sel.options[i];
//            const isVisible = opt.innerHTML.toLowerCase().search(val) !== -1;
            const isVisible = opt.innerHTML.toLowerCase().indexOf(val) !== -1;
            if (!isVisible) {
                opt.selected = false;
            }
            hideEl(opt, !isVisible);
            //                setClassByCondition(opt, "hidden", opt.innerHTML.toLowerCase().search(val) === -1);
        }
        sel.dispatchEvent(new Event('change'));
    };

    exports.initPanelToggler = (el) => {
        const attr = getAttr(el, 'panel-toggler');
        addClass(el, 'expanded');
        const sel = document.querySelector(attr);
        if (sel == null) {
            Utils.alert(`Panel toggler is broken: ${attr}`);
        }
        listen(el, 'click', togglePanel(el, sel));
    };

    exports.initPanelTogglers = el => qees(el || document, '[panel-toggler]').forEach(exports.initPanelToggler);

    exports.attachPanelToggler = (header, content, callback) => {
        addClass(header, 'expanded');
        listen(header, 'click', (event) => {
            if (callback) {
                callback(event, () => {
                    togglePanel(header, content)(event);
                });
            } else {
                togglePanel(header, content)(event);
            }
        });
    };

    var togglePanel = (el, sel) => (event) => {
        const isExpanded = hasClass(el, 'expanded');
        removeClasses(el, ['expanded', 'collapsed']);
        addClass(el, isExpanded ? 'collapsed' : 'expanded');
        toggleClass(sel, 'hidden');
    };

    exports.makeEventTimePicker = (opts) => {
        const input = makeEl('input');
        R.ap([addClass(input)], opts.extraClasses);
        addClass(input, 'eventTime');
        input.value = opts.eventTime;

        input.eventIndex = opts.index;

        const pickerOpts = {
            lang: L10n.getLang(),
            mask: true,
            startDate: new Date(opts.preGameDate),
            endDate: new Date(opts.date),
            onChangeDateTime: opts.onChangeDateTimeCreator(input),
        };

        if (opts.eventTime !== '') {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, 'defaultDate');
        }

        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };

    exports.makeEventTimePicker2 = (input, opts) => {
        input.value = opts.eventTime;

        input.eventIndex = opts.index;

        const pickerOpts = {
            lang: L10n.getLang(),
            mask: true,
            startDate: new Date(opts.preGameDate),
            endDate: new Date(opts.date),
            onChangeDateTime: opts.onChangeDateTimeCreator(input),
        };

        if (opts.eventTime !== '') {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, 'defaultDate');
        }

        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };

    // bug about setting 0900 years in Braavos game is event date. Fixed in production.
    //  exports.makeEventTimePicker = function (opts) {
    //      var input = makeEl("input");
    //      R.ap([addClass(input)], opts.extraClasses);
    //      addClass(input, "eventTime");
    //      input.value = opts.eventTime;
    //
    //      input.eventIndex = opts.index;
    //
    //      var pickerOpts = {
    //          lang : L10n.getLang(),
    //          mask : true,
    //          startDate : new Date(opts.preGameDate),
    //          endDate : new Date(opts.date),
    //          onChangeDateTime : opts.onChangeDateTimeCreator(input),
    //      };
    //
    //      var picker = jQuery(input).datetimepicker(pickerOpts);
    //
    //      var value;
    //      if (opts.eventTime !== "") {
    //          value = new Date(opts.eventTime);
    //      } else {
    //          value = opts.date;
    //          addClass(input, "defaultDate");
    //      }
    //
    //      picker.value = value;
    //
    //
    //      return input;
    //  };

    exports.initTextAreas = (sel) => {
        R.ap([exports.attachTextareaResizer], queryEls(sel));
    };

    exports.refreshTextAreas = (sel) => {
        R.ap([exports.resizeTextarea], queryEls(sel).map(el => ({ target: el })));
    };

    exports.attachTextareaResizer = (input) => {
        listen(input, 'keydown', exports.resizeTextarea);
        listen(input, 'paste', exports.resizeTextarea);
        listen(input, 'cut', exports.resizeTextarea);
        listen(input, 'change', exports.resizeTextarea);
        listen(input, 'drop', exports.resizeTextarea);
    };

    exports.resizeTextarea = (ev) => {
        const that = ev.target;
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.resizeTextarea2 = (that) => {
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.populateAdaptationTimeInput = (input, storyName, event, characterName, isEditable) => {
        setClassByCondition(input, 'notEditable', !isEditable);
        input.value = event.characters[characterName].time;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        listen(input, 'change', onChangePersonalTimeDelegate);
        return input;
    };

    var onChangePersonalTimeDelegate = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const time = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'time', time, Utils.processError());
    };

    exports.populateReadyCheckbox = (div, id, checked, isEditable, callback) => {
        const input = qee(div, 'input');
        setClassByCondition(input, 'notEditable', !isEditable);
        input.checked = checked;
        input.id = id;
        listen(input, 'change', callback);
        setAttr(qee(div, 'label'), 'for', input.id);
        return div;
    };

    exports.onChangeAdaptationReadyStatus2 = callback => (event) => {
        const dataKey = JSON.parse(event.target.id);
        const value = !hasClass(event.target, 'btn-primary');
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'ready', value, (err) => {
            if (err) { Utils.handleError(err); return; }
            setClassByCondition(event.target, 'btn-primary', value);
            callback(value);
        });
    };

    exports.makePanelCore = (title, content) => {
        const panel = addClasses(makeEl('div'), ['panel', 'panel-default']);
        const h3 = addClass(addEl(makeEl('h3'), title), 'panel-title');
        const a = setAttr(makeEl('a'), 'href', '#/');
        setAttr(a, 'panel-toggler', '');
        const headDiv = addClass(makeEl('div'), 'panel-heading');
        addEl(panel, addEl(headDiv, addEl(a, h3)));
        const contentDiv = addClass(makeEl('div'), 'panel-body');
        addEl(panel, addEl(contentDiv, content));
        return {
            panel,
            contentDiv,
            a
        };
    };

    exports.makeProfileTable = (profileStructure, profile) => {
        const container = qmte('.profile-editor-container-tmpl');
        addClass(container, 'profile-table');
        let value;
        return addEls(container, profileStructure.filter(element => element.doExport).map((element) => {
            switch (element.type) {
            case 'text':
                value = addClass(makeEl('span'), 'briefingTextSpan');
                addEl(value, makeText(profile[element.name]));
                break;
            case 'enum':
            case 'multiEnum':
            case 'number':
            case 'string':
                value = makeText(profile[element.name]);
                break;
            case 'checkbox':
                value = makeText(constL10n(Constants[profile[element.name]]));
                break;
            default:
                throw new Error(`Unexpected type ${element.type}`);
            }
            const row = qmte('.profile-editor-row-tmpl');
            addEl(qee(row, '.profile-item-name'), makeText(element.name));
            addEl(qee(row, '.profile-item-input'), value);
            return row;
        }));
    };

    exports.makeTableRow = (col1, col2) => addEls(makeEl('tr'), [addEl(makeEl('td'), col1), addEl(makeEl('td'), col2)]);

    exports.checkAndGetEntitySetting = (settingsPath, names) => {
        if (names.length === 0) return null;
        const settings = DBMS.getSettings();
        if (!settings[settingsPath]) {
            settings[settingsPath] = {
                name: names[0].value
            };
        }
        let { name } = settings[settingsPath];
        const rawNames = names.map(R.prop('value'));
        if (rawNames.indexOf(name) === -1) {
            settings[settingsPath].name = names[0].value;
            name = names[0].value;
        }
        return name;
    };

    exports.updateEntitySetting = (settingsPath, name) => {
        const settings = DBMS.getSettings();
        if(settings[settingsPath] === undefined) {
            settings[settingsPath] = {};
        }
        settings[settingsPath].name = name;
    };
    
    exports.scrollTo = (container, element) => {
        const domRect = element.getBoundingClientRect();
        const scrollTop = container.scrollTop;
        const scrollBottom = container.scrollTop + container.clientHeight;
        const condition = element.offsetTop < scrollTop || (element.offsetTop + domRect.height) > scrollBottom;
        
        if(condition){
            const from = container.scrollTop;
            const to = element.offsetTop - container.clientHeight/2 + domRect.height/2;
            
            Utils.animate({
                duration: 500,
                timing: Timing.makeEaseInOut(Timing.poly(4)),
                draw: function(progress) {
                    container.scrollTop = from + (to - from) * progress;
                }
            });
        }
    };
})(this.UI = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

// TODO need to lint utils with NIMS fixes
/* eslint-disable */

const strFormat = R.curry(CommonUtils.strFormat);

function getL10n(key) {
    return L10n.getValue(key);
}

function constL10n(key) {
    return L10n.getValue(`constant-${key}`);
}

function isEmpty(obj) {
    return (Object.getOwnPropertyNames(obj).length === 0);
}

const addClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    if (re.test(o.className)) return o;
    o.className = (`${o.className} ${c}`).replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
    return o;
});

const addClasses = R.curry((o, c) => {
    R.ap([addClass(o)], c);
    return o;
});

const hasClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    return (re.test(o.className));
});

const removeClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    o.className = o.className.replace(re, '$1').replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
    return o;
});

const removeClasses = R.curry((o, c) => {
    R.ap([removeClass(o)], c);
    return o;
});

const toggleClass = R.curry((o, c) => {
    if (hasClass(o, c)) {
        removeClass(o, c);
    } else {
        addClass(o, c);
    }
});

const setClassByCondition = R.curry((o, c, condition) => {
    if (condition) {
        addClass(o, c);
    } else {
        removeClass(o, c);
    }
    return o;
});

const setClassIf = setClassByCondition;

const showEl = (el, condition) => setClassByCondition(el, 'hidden', !condition);
const hideEl = (el, condition) => setClassByCondition(el, 'hidden', condition);

function getEl(id) {
    return document.getElementById(id);
}

function queryEl(sel) {
    return document.querySelector(sel);
}

const qe = queryEl;

// query template element
function qte(sel){
    return document.querySelector(sel).content.cloneNode(true);
}

// query materialize template element
function qmte(sel){
    return addEl(makeEl('div'), qte(sel)).firstChild;
}

function queryEls(sel) {
    return nl2array(document.querySelectorAll(sel));
}

const qes = queryEls;

function queryElEl(el, sel) {
    return el.querySelector(sel);
}

const qee = R.curry(queryElEl);

function queryElEls(el, sel) {
    return nl2array(el.querySelectorAll(sel));
}

const qees = R.curry(queryElEls);

function getEls(clazz) {
    return document.getElementsByClassName(clazz);
}

function makeEl(elTag) {
    return document.createElement(elTag);
}

const wrapEl = R.curry((elTag, el) => {
    return addEl(makeEl(elTag), el);
})

const wrapEls = R.curry((elTag, els) => {
    return addEls(makeEl(elTag), els);
})

function makeText(text) {
    return document.createTextNode(text);
}

const addEl = R.curry((parent, child) => {
    parent.appendChild(child);
    return parent;
});
const addEls = R.curry((parent, children) => {
    R.ap([addEl(parent)], children);
    return parent;
});

const makeOpt = function (label) {
    const option = makeEl('option');
    addEl(option, (makeText(label)));
    return option;
};

const setAttr = R.curry((el, name, value) => {
    el.setAttribute(name, value);
    return el;
});

const setStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value);
    return el;
});

const setImportantStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value, 'important');
    return el;
});

function delAttr(el, name) {
    el.removeAttribute(name);
    return el;
}

const getAttr = R.curry((el, name) => {
    return el.getAttribute(name);
});

const setProp = R.curry((el, key, value) => {
    el[key] = value;
    return el;
});

const setProps = R.curry((el, map) => {
    for (const key in map) {
        setProp(el, key, map[key]);
    }
    return el;
});

function clearEl(el) {
    Utils.removeChildren(el);
    return el;
}

function clearEls(els){
    return els.map(clearEl)
}

function passEls(src, dst) {
    for (let i = 0; i < src.children.length; i++) {
        addEl(dst, src.children[i]);
    }
}

const listen = R.curry((el, event, listener) => {
    el.addEventListener(event, listener);
    return el;
});

const listenOnEnter = R.curry((el, callback) => {
    listen(el, 'keydown', (e) => {
        if (e.keyCode === 13) {
            if(e.iAmNotAlone) {
                throw new Error('Oh dear!');
            }
            e.iAmNotAlone = true;
            
            callback();
        }
    });
});

const fillSelector = R.curry((sel, data) => addEls(sel, data.map((item) => {
    const opt = makeEl('option');
    addEl(opt, makeText(item.name));
    if (item.value !== undefined) { opt.value = item.value; }
    if (item.selected !== undefined) { opt.selected = true; }
    if (item.className !== undefined) { addClass(opt, item.className); }
    return opt;
})));

function nl2array(nodeList) {
    return Array.prototype.slice.call(nodeList);
}

const remapProps = R.curry((outKeys, pickKeys, obj) => R.compose(R.zipObj(outKeys), R.values, R.pick(pickKeys))(obj));

const remapProps4Select2 = remapProps(['id', 'text'], ['value', 'displayName']);
const remapProps4Select = remapProps(['value', 'name'], ['value', 'displayName']);

const getSelect2DataCommon = R.curry((preparator, obj) => R.compose(R.zipObj(['data']), R.append(R.__, []), R.map(preparator))(obj));

const getSelect2Data = getSelect2DataCommon(remapProps4Select2);

const makeSelect2Opt = R.compose(R.zipObj(['id', 'text']), R.repeat(R.__, 2));
const arr2Select2 = R.compose(R.assoc('data', R.__, {}), R.map(makeSelect2Opt));
const arr2Select = R.map(R.compose(R.zipObj(['value', 'name']), R.repeat(R.__, 2)));
const constArr2Select = R.map(R.compose(R.zipObj(['value', 'name']), name => [name, constL10n(name)]));

const getSelectedRadio = function (el, query) {
    return queryElEls(el, query).find(R.prop('checked'));
};

const debugInterceptor = function (callback) {
    return function () {
        console.log(JSON.stringify(arguments[0]));
        callback(...arguments);
    };
};

const Utils = {};

/** opts
    tooltip - add tooltip to button, used for iconic buttons
    id - set button id
    mainPage - enable view as first page - deprecated. Use Utils.setFirstTab instead
    toggle - toggle content, associated with button
*/
Utils.addView = function (containers, name, view, opts2) {
    const opts = opts2 || {};
    view.init();
    const buttonClass = 'navigation-button';
    containers.root.views[name] = view;
    const button = makeEl('button');
    function delegate() {
        $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
    }
    if (opts.tooltip) {
        L10n.onL10nChange(delegate);
        $(button).tooltip({
            title: L10n.getValue(`header-${name}`),
            placement: 'bottom'
        });
    } else {
        addEl(button, makeText(L10n.getValue(`header-${name}`)));
        setAttr(button, 'l10n-id', `header-${name}`);
    }
    addClass(button, buttonClass);
    addClass(button, `-test-${name}`);
    addClass(button, `-toggle-class-${name}`);
    if (opts.clazz) {
        addClass(button, opts.clazz);
    }
    containers.navigation.appendChild(button);

    const onClickDelegate = function (view2) {
        return function (evt) {
            //Tests.run();
            const elems = containers.navigation.getElementsByClassName(buttonClass);
            if (opts.toggle) {
                const els = getEls(`-toggle-class-${name}`);
                for (let i = 0; i < els.length; i++) {
                    if (evt.target.isEqualNode(els[i])) {
                        continue;
                    }
                    if (hasClass(els[i], 'active')) {
                        els[i].click();
                    }
                }
            }

            const isActive = hasClass(evt.target, 'active');
            for (let i = 0; i < elems.length; i++) {
                removeClass(elems[i], 'active');
            }
            if (!opts.toggle || (opts.toggle && !isActive)) {
                addClass(evt.target, 'active');

                passEls(containers.content, getEl('warehouse'));
                containers.content.appendChild(view2.content);
                removeClass(containers.content, 'hidden');
                containers.root.currentView = view2;
                view2.refresh();
            } else {
                removeClass(evt.target, 'active');
                passEls(containers.content, getEl('warehouse'));
                containers.root.currentView = null;
                addClass(containers.content, 'hidden');
            }
        };
    };

    button.addEventListener('click', onClickDelegate(view));

    // deprecated. Use Utils.setFirstTab instead
    if (opts.mainPage) {
        Utils.setFirstTab(containers, {button, view});
    }
    return {button, view};
};

Utils.setFirstTab = function(containers, opts){
    addClass(opts.button, 'active');
    containers.content.appendChild(opts.view.content);
    containers.root.currentView = opts.view;
}

Utils.alert = function (message) {
    vex.dialog.alert(message);
};

const setError = (el, err) => addEl(clearEl(qee(el, '.error-msg')), makeText(Utils.handleErrorMsg(err)));
const clearError = (el) => clearEl(qee(el, '.error-msg'));

Utils.confirm = function (message, onOk, onCancel) {
    vex.dialog.confirm({
        message,
        callback: (val) => {
            if (val) {
                if (onOk) onOk();
            } else if (onCancel) onCancel();
        }
    });
};

Utils.removeChildren = function (myNode) {
    if (!myNode) {
        return;
    }
    while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
    }
};

Utils.processError = function (callback) {
    return function (err) {
        if (err) {
            Utils.handleError(err);
            return;
        }

        if (callback) {
            const arr = [];
            for (let i = 1; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            callback(...arr);
        }
    };
};

Utils.handleErrorMsg = function (err) {
    const checkErrorType = R.curry((err2, name) => err2 instanceof Errors[name] || (err2.name && err2.name === name));
    if (R.keys(Errors).some(checkErrorType(err))) {
        const params = err.parameters.map(val => {
            return L10n.hasValue(val) ? L10n.getValue(val) : val;
        });
        return strFormat(getL10n(err.messageId), params);
    } else if (typeof err === 'object') {
        return err.message;
    }
    return err;
};

Utils.handleError = err => Utils.alert(Utils.handleErrorMsg(err));

Utils.enableEl = R.curry((el, condition) => {
    const key = el.tagName.toLowerCase() === 'textarea' ? 'readonly' : 'disabled';
    if (condition) {
        el.removeAttribute(key);
    } else {
        el.setAttribute(key, key);
    }
});

Utils.enable = function (root, className, condition) {
    nl2array(root.getElementsByClassName(className)).map(Utils.enableEl(R.__, condition));
};

Utils.charOrdAObject = CommonUtils.charOrdAFactory(a => a.displayName.toLowerCase());

Utils.rebuildSelector = function (selector, names) {
    clearEl(selector);
    names.forEach((nameInfo) => {
        const option = makeEl('option');
        option.appendChild(makeText(nameInfo.displayName));
        option.value = nameInfo.value;
        selector.appendChild(option);
    });
};

Utils.rebuildSelectorArr = function (selector, names) {
    clearEl(selector);
    names.forEach((name) => {
        const option = makeEl('option');
        option.appendChild(makeText(name));
        selector.appendChild(option);
    });
};

// from https://learn.javascript.ru/js-animation
Utils.animate = (options) => {
    const start = performance.now();

    requestAnimationFrame(function animate(time) {
        // timeFraction from 0 to 1
        let timeFraction = (time - start) / options.duration;
        if (timeFraction > 1) timeFraction = 1;
        
        // current animation state
        const progress = options.timing(timeFraction)
        
        options.draw(progress);
        
        if (timeFraction < 1) {
            requestAnimationFrame(animate);
        }
    });
}

const Timing = {};

// call examples
//timing: Timing.linear,
//timing: Timing.quad,
//timing: Timing.circ,
//timing: Timing.bounce,
//timing: Timing.makeEaseOut(Timing.bounce),
//timing: Timing.makeEaseInOut(Timing.bounce),
//timing: Timing.back(3.5),
//timing: Timing.elastic(1.5),
//timing: Timing.makeEaseInOut(Timing.poly(4)),

Timing.linear = (timeFraction) => {
    return timeFraction;
}

Timing.quad = ( progress) => {
    return Math.pow(progress, 2)
}

Timing.poly = R.curry((x, progress) => {
    return Math.pow(progress, x)
})

Timing.circ = (timeFraction) => {
    return 1 - Math.sin(Math.acos(timeFraction))
}

Timing.back = R.curry((x, timeFraction) => {
    return Math.pow(timeFraction, 2) * ((x + 1) * timeFraction - x)
})

Timing.bounce = (timeFraction) => {
    for (var a = 0, b = 1, result; 1; a += b, b /= 2) {
        if (timeFraction >= (7 - 4 * a) / 11) {
            return -Math.pow((11 - 6 * a - 11 * timeFraction) / 4, 2) + Math.pow(b, 2)
        }
    }
}

Timing.elastic = (x, timeFraction) => {
    return Math.pow(2, 10 * (timeFraction - 1)) * Math.cos(20 * Math.PI * x / 3 * timeFraction)
}

Timing.makeEaseOut = (timing) => {
    return function(timeFraction) {
        return 1 - timing(1 - timeFraction);
    }
}

Timing.makeEaseInOut = (timing) => {
    return function(timeFraction) {
        if (timeFraction < .5) {
            return timing(2 * timeFraction) / 2;
        } else {
            return (2 - timing(2 * (1 - timeFraction))) / 2;
        }
    }
}

String.prototype.endsWith = function (suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

// from date format utils
//For convenience...
Date.prototype.format = function (mask, utc) {
    return dateFormat(this, mask, utc);
};

/*Copyright 2015, 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
Utils, Overview, Profiles, Stories, Adaptations, Briefings, Timeline, SocialNetwork, FileUtils
 */

'use strict';

((exports) => {
    const state = {};
    state.views = {};
    state.firstBaseLoad = MODE === 'Standalone';
    
    const BACKUP_NUMBER = 4;
    const BACKUP_INTERVAL = 60000*10; // 10 min

    const btnOpts = {
        tooltip: true,
        className: 'mainNavButton'
    };

    const initPage = () => {
        L10n.init();
        L10n.onL10nChange(() => state.currentView.refresh());
        UI.initSelectorFilters();
        UI.initPanelTogglers();
        L10n.localizeStatic();
        function updateDialogs() {
            vex.dialog.buttons.YES.text = getL10n('common-ok');
            vex.dialog.buttons.NO.text = getL10n('common-cancel');
        }
        updateDialogs();
        L10n.onL10nChange(updateDialogs);
    };

    const protoExpander = (arr) => {
        function protoCarrier() {}
        arr.forEach(name => (protoCarrier.prototype[name] = (() => 1)));
        return protoCarrier;
    };
    const playerArr = [
        'getPlayersOptions',
        'getWelcomeText',
        'getPlayerProfileInfo',
        'createCharacterByPlayer',
        'updateProfileField',
        'getRoleGridInfo'];

    exports.refresh = () => state.currentView.refresh();

    exports.onPlayerPageLoad = () => {
        initPage();
        const RemoteDBMS = makeRemoteDBMS(protoExpander(playerArr));
        window.DBMS = new RemoteDBMS();
        stateInit();
        Utils.addView(state.containers, 'player', Player, { mainPage: true });
        addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));
        Utils.addView(state.containers, 'about', About);
        //        addEl(state.navigation, makeL10nButton());
        addEl(state.navigation, makeButton('logoutButton icon-button', 'logout', postLogout, btnOpts));
        state.currentView.refresh();
    };

    exports.onIndexPageLoad = () => {
        initPage();
        const RemoteDBMS = makeRemoteDBMS(protoExpander(['getPlayersOptions', 'getRoleGridInfo']));
        window.DBMS = new RemoteDBMS();
        stateInit();
        DBMS.getPlayersOptions((err, playersOptions) => {
            if (err) { Utils.handleError(err); return; }
            addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));
            Utils.addView(state.containers, 'enter', Enter, { mainPage: true });
            if (playersOptions.allowPlayerCreation) {
                Utils.addView(state.containers, 'sign-up', SignUp);
            }
            Utils.addView(state.containers, 'about', About);
            //            addEl(state.navigation, makeL10nButton());
            state.currentView.refresh();
        });
    };
    
    exports.onOrganizerPageLoad = () => {
        initPage();
        const LocalDBMS = makeLocalDBMS(true);
        if (MODE === 'Standalone') {
            window.DBMS = new LocalDBMS();
            window.DBMS = makeLocalDBMSWrapper(window.DBMS);
//            DBMS.setDatabase(DemoBase.data, onBaseLoaded);
            runBaseSelectDialog();
        } else if (MODE === 'NIMS_Server') {
            const RemoteDBMS = makeRemoteDBMS(LocalDBMS);
            window.DBMS = new RemoteDBMS();
            consistencyCheck((checkResult) => {
                consistencyCheckAlert(checkResult);
                onDatabaseLoad();
            });
        }
    };
    
    function runBaseSelectDialog() {
        const dbDialog = queryEl('.set-database-dialog');
        addEl(queryEl('body'), dbDialog);
        listen(qee(dbDialog, '.on-action-button'), 'click', (event) => {
            $(dbDialog).modal('hide');
        });
        
        readLocalBases().then((browserBases) => {
            addEls(qee(dbDialog, '.modal-body .backup-bases'), (browserBases || []).map((base,i) => {
                const baseSelect = qmte('.backup-base-tmpl');
                const input = qee(baseSelect, 'input');
                setAttr(input, 'value', "browserBackup" + i); 
                setAttr(input, 'id', "dbSourceBrowserBackup" + i);
                input.base = base;
                setAttr(qee(baseSelect, 'label'), 'for', "dbSourceBrowserBackup" + i);
                const date = new Date(base.Meta.saveTime).format('dd mmm yyyy HH:MM:ss');
                addEl(qee(baseSelect, '.base-name'), makeText(base.Meta.name + ' (' + date + ')'));
                return baseSelect;
            }));
            
            qee(dbDialog, 'input[name=dbSource]').checked = true;
            qee(dbDialog, '#dbSourceDemoBase').base = CommonUtils.clone(DemoBase.data);
            qee(dbDialog, '#dbSourceEmptyBase').base = CommonUtils.clone(EmptyBase.data);
            
            addEl(qee(dbDialog, '.demo-base-name'), makeText(DemoBase.data.Meta.name));
            
            const dialogOnBaseLoad = err => {
                if (err) { Utils.handleError(err); return; }
                $(dbDialog).modal('hide');
                onBaseLoaded(err);
            }
            
            initBaseLoadBtn(qee(dbDialog, '.upload-db'), qee(dbDialog, '.upload-db input'), dialogOnBaseLoad);
            
            listen(qee(dbDialog, '.on-action-button'), 'click', () => {
                const base = getSelectedRadio(dbDialog, 'input[name=dbSource]').base;
                DBMS.setDatabase(base, dialogOnBaseLoad);
            });
            
            L10n.localizeStatic(dbDialog);
            
            $(dbDialog).modal({
                backdrop: 'static'
            });
        }).catch(err => console.error(err));
    }

    function consistencyCheckAlert(checkResult) {
        if (checkResult.errors.length > 0) {
            Utils.alert(getL10n('overview-consistency-problem-detected'));
        } else {
            console.log('Consistency check didn\'t find errors');
        }
    }

    function consistencyCheck(callback) {
        DBMS.getConsistencyCheckResult((err, checkResult) => {
            if (err) { Utils.handleError(err); return; }
            checkResult.errors.forEach(CommonUtils.consoleErr);
            callback(checkResult);
        });
    }

    function stateInit() {
        state.navigation = getEl('navigation');
        state.containers = {
            root: state,
            navigation: state.navigation,
            content: getEl('contentArea')
        };
    }

    function onDatabaseLoad() {
        PermissionInformer.refresh((err) => {
            if (err) { Utils.handleError(err); return; }

            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                
                $.datetimepicker.setDateFormatter('moment');

                let button;
                stateInit();

                const tabs = {};
                const firstTab = 'Overview';

                const addView = (containers, btnName, viewName, opts) => {
                    tabs[viewName] = {
                        viewName,
                        viewRes: Utils.addView(containers, btnName, window[viewName], opts)
                    };
                };

                addView(state.containers, 'overview', 'Overview');
                //                addView(state.containers, 'profiles', 'Profiles');
                addView(state.containers, 'characters', 'Characters');
                addView(state.containers, 'players', 'Players');
                addView(state.containers, 'stories', 'Stories');
                addView(state.containers, 'adaptations', 'Adaptations');
                addView(state.containers, 'briefings', 'Briefings');
                addView(state.containers, 'relations', 'Relations');

                addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

                addView(state.containers, 'timeline', 'Timeline', { clazz: 'timelineButton icon-button', tooltip: true });
                addView(state.containers, 'social-network', 'SocialNetwork', { clazz: 'socialNetworkButton icon-button', tooltip: true });
                addView(state.containers, 'profile-filter', 'ProfileFilter', { clazz: 'filterButton icon-button', tooltip: true });
                addView(state.containers, 'groups', 'GroupProfile', { clazz: 'groupsButton icon-button', tooltip: true });
                addView(state.containers, 'textSearch', 'TextSearch', { clazz: 'textSearchButton icon-button', tooltip: true });
                addView(state.containers, 'roleGrid', 'RoleGrid', { clazz: 'roleGridButton icon-button', tooltip: true });

                addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

                if (MODE === 'NIMS_Server') {
                    addView(state.containers, 'admins', 'AccessManager', { clazz: 'accessManagerButton icon-button', tooltip: true });
                }
                addView(state.containers, 'logViewer', 'LogViewer2', { clazz: 'logViewerButton icon-button', tooltip: true });

                addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

                if (isAdmin) {
                    button = makeButton('dataLoadButton icon-button', 'open-database', null, btnOpts);
                    const input = makeEl('input');
                    input.type = 'file';
                    addClass(input, 'hidden');
                    setAttr(input, 'tabindex', -1);
                    button.appendChild(input);
                    
                    initBaseLoadBtn(button, input, onBaseLoaded);
                    addEl(state.navigation, button);
                }

                addEl(state.navigation, makeButton('dataSaveButton icon-button', 'save-database', FileUtils.saveFile, btnOpts));
                if (MODE === 'Standalone') {
                    addEl(state.navigation, makeButton('newBaseButton icon-button', 'create-database', FileUtils.makeNewBase(onBaseLoaded), btnOpts));
                }
//                addEl(state.navigation, makeButton('mainHelpButton icon-button', 'docs', FileUtils.openHelp, btnOpts));

                //                addEl(state.navigation, makeL10nButton());

//                addEl(state.navigation, makeButton('testButton icon-button', 'test', TestUtils.runTests, btnOpts));
//                addEl(state.navigation, makeButton('checkConsistencyButton icon-button', 'checkConsistency', checkConsistency, btnOpts));
//                addEl(state.navigation, makeButton('checkConsistencyButton icon-button', 'showDbmsConsistencyState', showDbmsConsistencyState, btnOpts));
//                addEl(state.navigation, makeButton('clickAllTabsButton icon-button', 'clickAllTabs', TestUtils.clickThroughtHeaders, btnOpts));
//                addEl(state.navigation, makeButton('clickAllTabsButton icon-button', 'showDiff', TestUtils.showDiffExample, btnOpts));
                if (MODE === 'NIMS_Server') {
                    addEl(state.navigation, makeButton('logoutButton icon-button', 'logout', postLogout, btnOpts));
                }
                addEl(state.navigation, makeButton('refreshButton icon-button', 'refresh', () => state.currentView.refresh(), btnOpts));

                Utils.setFirstTab(state.containers, tabs[firstTab].viewRes);

                state.currentView.refresh();
                if (MODE === 'Standalone') {
                    addBeforeUnloadListener();
                    localAutoSave();
                }
//                FileUtils.makeNewBase();
//                state.currentView.refresh();
                //                                runTests();
            });
        });
    }
    
    function onBaseLoaded(err3) {
        if (err3) { Utils.handleError(err3); return; }
        consistencyCheck((checkResult) => {
            consistencyCheckAlert(checkResult);
            if(state.firstBaseLoad){
                onDatabaseLoad();
                state.firstBaseLoad = false;
            } else {
                state.currentView.refresh();
            }
        });
    }
    
    function initBaseLoadBtn(button, input, onBaseLoaded) {
        button.addEventListener('change', FileUtils.readSingleFile(onBaseLoaded), false);
        button.addEventListener('click', (e) => {
            input.value = '';
            input.click();
            //                    e.preventDefault(); // prevent navigation to "#"
        });
    }

    function makeL10nButton() {
        const l10nBtn = makeButton('toggleL10nButton', 'l10n', L10n.toggleL10n, btnOpts);
        const setIcon = () => {
            l10nBtn.style.backgroundImage = strFormat('url("./images/{0}.svg")', [getL10n('header-dictionary-icon')]);
        };
        L10n.onL10nChange(setIcon);
        setIcon();
        return l10nBtn;
    }

    function showDbmsConsistencyState() {
        consistencyCheck(checkRes => TestUtils.showModuleSchema(checkRes));
    }

    function checkConsistency() {
        consistencyCheck(checkRes => TestUtils.showConsistencyCheckAlert(checkRes));
    }

    function postLogout() {
        document.querySelector('#logoutForm button').click();
    }

    function makeButton(clazz, name, callback, opts) {
        const button = makeEl('button');
        addClass(button, clazz);
        if (opts.tooltip) {
            const delegate = () => {
                $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
            };
            L10n.onL10nChange(delegate);
            $(button).tooltip({
                title: L10n.getValue(`header-${name}`),
                placement: 'bottom'
            });
        }
        addClass(button, 'action-button');
        if (opts.className) {
            addClass(button, opts.className);
        }
        if (callback) {
            listen(button, 'click', callback);
        }
        return button;
    }

    function addBeforeUnloadListener() {
        window.onbeforeunload = (evt) => {
            makeBackup();
            const message = getL10n('utils-close-page-warning');
            if (typeof evt === 'undefined') {
                evt = window.event;
            }
            if (evt) {
                evt.returnValue = message;
            }
            return message;
        };
    }
    
    function readLocalBases() {
        if (!window.indexedDB) {
            Utils.alert(L10n.get('errors', 'indexeddb-is-not-found'));
            return Promise.resolve(null);
        }
        
        let counter = 0;
        let counters = [];
        while(!R.contains(counter, counters)) {
            counters.push(counter);
            counter = (counter + 1) % BACKUP_NUMBER;
        }
        
        return Promise.all(counters.map(counter => LocalBaseAPI.get('base' + counter))).then(bases => {
            bases = bases.filter(base => !R.isNil(base));
            if(bases.length === 0){
                return null;
            }
            
            bases.sort(CommonUtils.charOrdAFactory( base => -new Date(base.obj.Meta.saveTime).getTime()))
            return bases.map(R.prop('obj'));
        });
    }
    
    function localAutoSave() {
        if (!window.indexedDB) {
            return;
        }
        
        makeBackup();
        setInterval(makeBackup, BACKUP_INTERVAL); // 5 min
    }
    
    let counter = 0;
    function makeBackup() {
        console.log(counter + 1);
        counter = (counter + 1) % BACKUP_NUMBER;
        console.log('Starting autosave');
        
        DBMS.getDatabase((err, database) => {
            if (err) { Utils.handleError(err); return; }
            
            LocalBaseAPI.put('base' + counter, database).then(() => {
                console.log('Autosave OK ' + new Date());
//                LocalBaseAPI.get('base' + counter).then((database) => {
//                    console.log(database);
//                }).catch(Utils.handleError);
            }).catch(Utils.handleError);
        });
    }
    
})(this.PageManager = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 */

'use strict';

((exports, mode) => {
    const state = {};

    state.summary = {};

    if (mode === 'NIMS_Server' && PERMISSION_INFORMER_ENABLED) {
        exports.refresh = (callback) => {
            const request = $.ajax({
                url: '/getPermissionsSummary',
                dataType: 'text',
                method: 'GET',
                contentType: 'application/json;charset=utf-8',
                timeout: Constants.httpTimeout
            });

            request.done((data) => {
                state.summary = JSON.parse(data);
                if (callback) {
                    callback();
                } else {
                    exports.subscribe();
                }
                //        alert(data);
                //        alert(state.summary);
            });

            request.fail((errorInfo, textStatus, errorThrown) => {
                if (callback) {
                    callback(errorInfo.responseText || 'error');
                } else {
                    setTimeout(exports.subscribe, 500);
                }
            });
        };

        exports.subscribe = () => {
            const request = $.ajax({
                url: '/subscribeOnPermissionsUpdate',
                dataType: 'text',
                method: 'GET',
                contentType: 'application/json;charset=utf-8',
                timeout: Constants.httpTimeout
            });

            request.done((data) => {
                state.summary = JSON.parse(data);
                //        alert(data);
                //        alert(state.summary);
                exports.subscribe();
            });

            request.fail((errorInfo, textStatus, errorThrown) => {
                setTimeout(exports.subscribe, 500);
            });
        };

        exports.refresh();

        exports.isAdmin = (callback) => {
            callback(null, state.summary.isAdmin);
        };

        exports.isEditor = (callback) => {
            callback(null, state.summary.isEditor);
        };

        const isObjectEditableSync = (type, name) => {
            if (state.summary.isEditor) {
                return true;
            }
            if (state.summary.existEditor) {
                return false;
            }
            return state.summary.user[type].indexOf(name) !== -1;
        };

        exports.isEntityEditable = (type, entityName, callback) => {
            callback(null, isObjectEditableSync(type, entityName));
        };

        exports.getEntityNamesArray = R.curry((type, editableOnly, callback) => {
            const userEntities = state.summary.user[type];
            const allEntities = state.summary.all[type];
            const ownerMap = state.summary.ownerMaps[type];
            const names = allEntities.filter((name) => {
                if (editableOnly) {
                    return isObjectEditableSync(type, name);
                }
                return true;
            }).map(name => ({
                displayName: `${ownerMap[name]}. ${name}`,
                value: name,
                editable: isObjectEditableSync(type, name),
                isOwner: userEntities.indexOf(name) !== -1,
                hasOwner: ownerMap[name] !== '-'
            }));

            const name2str = a => a.displayName.toLowerCase();

            const entityCmp = CommonUtils.charOrdAFactoryBase('asc', (a, b) => {
                if (a.isOwner && b.isOwner) return name2str(a) > name2str(b);
                if (a.isOwner) return false;
                if (b.isOwner) return true;

                if (a.hasOwner && b.hasOwner) return name2str(a) > name2str(b);
                if (a.hasOwner) return false;
                if (b.hasOwner) return true;

                return name2str(a) > name2str(b);
            }, R.identity);

            //            names.sort(Utils.charOrdAObject);
            names.sort(entityCmp);

            callback(null, names);
        });

        exports.areAdaptationsEditable = (adaptations, callback) => {
            const map = {};
            const { isAdaptationRightsByStory } = state.summary;

            adaptations.forEach((elem) => {
                const key = `${elem.storyName}-${elem.characterName}`;
                if (isAdaptationRightsByStory) {
                    map[key] = isObjectEditableSync('story', elem.storyName);
                } else {
                    map[key] = isObjectEditableSync('character', elem.characterName);
                }
            });

            callback(null, map);
        };
    } else if (mode === 'Standalone') {
        exports.refresh = (callback) => {
            callback();
        };

        exports.isAdmin = (callback) => {
            callback(null, true);
        };

        exports.isEditor = (callback) => {
            callback(null, true);
        };

        exports.getEntityNamesArray = R.curry((type, editableOnly, callback) => {
            function processNames(err, names) {
                if (err) { Utils.handleError(err); return; }
                const newNames = [];
                names.forEach((name) => {
                    newNames.push({
                        displayName: name,
                        value: name,
                        editable: true
                    });
                });
                callback(null, newNames);
            }
            DBMS.getEntityNamesArray(type, processNames);
        });

        exports.isEntityEditable = (type, entityName, callback) => {
            callback(null, true);
        };

        exports.areAdaptationsEditable = (adaptations, callback) => {
            const map = {};
            adaptations.forEach((elem) => {
                map[`${elem.storyName}-${elem.characterName}`] = true;
            });

            callback(null, map);
        };
    }
})(this.PermissionInformer = {}, MODE);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2RibXMvY2FsbE5vdGlmaWNhdG9yLmpzIiwianMvZGJtcy9sb2NhbERCTVMuanMiLCJqcy9kYm1zL3Byb21pc2lmaWNhdG9yLmpzIiwianMvZGJtcy9yZW1vdGVEQk1TLmpzIiwiLi4vY29yZS9qcy9maWxlVXRpbHMuanMiLCIuLi9jb3JlL2pzL2wxMG4uanMiLCIuLi9jb3JlL2pzL2xvY2FsQXV0b1NhdmUuanMiLCIuLi9jb3JlL2pzL3Rlc3RVdGlscy5qcyIsIi4uL2NvcmUvanMvdWlVdGlscy5qcyIsIi4uL2NvcmUvanMvdXRpbHMuanMiLCJqcy9wYWdlTWFuYWdlci5qcyIsImpzL3Blcm1pc3Npb25JbmZvcm1lci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMURBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqVUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVjQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6WkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InNjcmlwdHMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypDb3B5cmlnaHQgMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc2hvd05vdGlmaWNhdGlvbiA9IHRydWU7XHJcbiAgICBjb25zdCBub3RpZmljYXRpb25UaW1lb3V0ID0gMjAwMDtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5vbkNhbGxTdGFydCA9ICgpID0+IHtcclxuICAgICAgICBpZiAoIXNob3dOb3RpZmljYXRpb24pIHJldHVybjtcclxuICAgICAgICBjb25zdCBub3RpZmljYXRpb25Cb3ggPSBjbGVhckVsKGdldEVsKCdkZWJ1Z05vdGlmaWNhdGlvbicpKTtcclxuICAgICAgICByZW1vdmVDbGFzcyhub3RpZmljYXRpb25Cb3gsICdoaWRkZW4nKTtcclxuICAgICAgICByZW1vdmVDbGFzcyhub3RpZmljYXRpb25Cb3gsICdvcGVyYXRpb25PSycpO1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG5vdGlmaWNhdGlvbkJveCwgJ29wZXJhdGlvbkZhaWwnKTtcclxuICAgICAgICBhZGRFbChub3RpZmljYXRpb25Cb3gsIG1ha2VUZXh0KEwxMG4uZ2V0KCdjb25zdGFudCcsICdzYXZpbmcnKSkpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5vbkNhbGxGaW5pc2hlZCA9IChlcnIpID0+IHtcclxuICAgICAgICBpZiAoIXNob3dOb3RpZmljYXRpb24pIHJldHVybjtcclxuICAgICAgICBpZihlcnIpIHtcclxuICAgICAgICAgICAgb25DYWxsRmFpbCgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG9uQ2FsbFN1Y2Nlc3MoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2FsbFN1Y2Nlc3MoKXtcclxuICAgICAgICBjb25zdCBub3RpZmljYXRpb25Cb3ggPSBnZXRFbCgnZGVidWdOb3RpZmljYXRpb24nKTtcclxuICAgICAgICBhZGRDbGFzcyhub3RpZmljYXRpb25Cb3gsICdvcGVyYXRpb25PSycpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwobm90aWZpY2F0aW9uQm94KSwgbWFrZVRleHQoTDEwbi5nZXQoJ2NvbnN0YW50JywgJ3NhdmluZy1zdWNjZXNzJykpKTtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgYWRkQ2xhc3Mobm90aWZpY2F0aW9uQm94LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfSwgbm90aWZpY2F0aW9uVGltZW91dCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DYWxsRmFpbCgpe1xyXG4gICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbkJveCA9IGdldEVsKCdkZWJ1Z05vdGlmaWNhdGlvbicpO1xyXG4gICAgICAgIGFkZENsYXNzKG5vdGlmaWNhdGlvbkJveCwgJ29wZXJhdGlvbkZhaWwnKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKG5vdGlmaWNhdGlvbkJveCksIG1ha2VUZXh0KEwxMG4uZ2V0KCdjb25zdGFudCcsICdzYXZpbmctZmFpbCcpKSk7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKG5vdGlmaWNhdGlvbkJveCwgJ2hpZGRlbicpO1xyXG4gICAgICAgIH0sIG5vdGlmaWNhdGlvblRpbWVvdXQpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBcclxufSkodGhpcy5DYWxsTm90aWZpY2F0b3IgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERhdGFiYXNlLCBNaWdyYXRvclxyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIGZ1bmMtbmFtZXMgKi9cclxuXHJcbmZ1bmN0aW9uIG1ha2VMb2NhbERCTVMoZnVsbFZlcnNpb24pIHtcclxuLy8gICAgaWYoIWZ1bGxWZXJzaW9uKXtcclxuLy8gICAgICAgIGZ1bmN0aW9uIExvY2FsREJNUygpe1xyXG4vLyAgICAgICAgfTtcclxuLy8gICAgICAgIHJldHVybiBMb2NhbERCTVM7XHJcbi8vICAgIH1cclxuICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2spIHtcclxuICAgICAgICBsaXN0ZW5lcnNbZXZlbnROYW1lXSA9IGxpc3RlbmVyc1tldmVudE5hbWVdIHx8IFtdO1xyXG4gICAgICAgIGxpc3RlbmVyc1tldmVudE5hbWVdLnB1c2goY2FsbGJhY2spO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG9wdHMgPSB7XHJcbiAgICAgICAgTWlncmF0b3IsXHJcbiAgICAgICAgQ29tbW9uVXRpbHMsXHJcbiAgICAgICAgQ1U6IENvbW1vblV0aWxzLFxyXG4gICAgICAgIFByb2plY3RVdGlscyxcclxuICAgICAgICBQVTogUHJvamVjdFV0aWxzLFxyXG4gICAgICAgIFByZWNvbmRpdGlvbixcclxuICAgICAgICBQQzogUHJlY29uZGl0aW9uLFxyXG4gICAgICAgIEV2ZW50RW1pdHRlcixcclxuICAgICAgICBSLFxyXG4gICAgICAgIEFqdixcclxuICAgICAgICBTY2hlbWEsXHJcbiAgICAgICAgRXJyb3JzLFxyXG4gICAgICAgIGFkZExpc3RlbmVyLFxyXG4gICAgICAgIENvbnN0YW50cyxcclxuICAgICAgICBkYm1zVXRpbHM6IHt9LFxyXG4gICAgICAgIGRhdGVGb3JtYXQsXHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIExvY2FsREJNUygpIHtcclxuICAgICAgICB0aGlzLl9pbml0KGxpc3RlbmVycyk7XHJcbiAgICB9XHJcblxyXG4gICAgTG9jYWxEQk1TLnByb3RvdHlwZS5nZXRTZXR0aW5ncyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAndXNlIHN0cmljdCc7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFiYXNlLlNldHRpbmdzO1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBmdW5jTGlzdCA9IHt9O1xyXG4gICAgY29uc3QgZnVuYyA9IFIuY3VycnkoKG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBiZWZvcmUgPSBSLmtleXMoTG9jYWxEQk1TLnByb3RvdHlwZSk7XHJcbiAgICAgICAgd2luZG93W25hbWVdKExvY2FsREJNUywgb3B0cyk7XHJcbiAgICAgICAgY29uc3QgYWZ0ZXIgPSBSLmtleXMoTG9jYWxEQk1TLnByb3RvdHlwZSk7XHJcbiAgICAgICAgY29uc3QgZGlmZiA9IFIuZGlmZmVyZW5jZShhZnRlciwgYmVmb3JlKTtcclxuICAgICAgICAvLyAgICAgICAgY29uc29sZS5sb2coYCR7bmFtZX0gJHtkaWZmfWApO1xyXG4gICAgICAgIGZ1bmNMaXN0W25hbWVdID0gUi56aXBPYmooZGlmZiwgUi5yZXBlYXQodHJ1ZSwgZGlmZi5sZW5ndGgpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIFsnYmFzZUFQSScsXHJcbiAgICAgICAgJ2NvbnNpc3RlbmN5Q2hlY2tBUEknLFxyXG4gICAgICAgICdzdGF0aXN0aWNzQVBJJyxcclxuICAgICAgICAncHJvZmlsZXNBUEknLFxyXG4gICAgICAgICdwcm9maWxlQmluZGluZ0FQSScsXHJcblxyXG4gICAgICAgICdwcm9maWxlVmlld0FQSScsXHJcblxyXG4gICAgICAgICdncm91cHNBUEknLFxyXG4gICAgICAgICdncm91cFNjaGVtYUFQSScsXHJcbiAgICAgICAgJ2ludmVzdGlnYXRpb25Cb2FyZEFQSScsXHJcbiAgICAgICAgJ3JlbGF0aW9uc0FQSScsXHJcbiAgICAgICAgJ2JyaWVmaW5nRXhwb3J0QVBJJyxcclxuXHJcbiAgICAgICAgJ3Byb2ZpbGVDb25maWd1cmVyQVBJJyxcclxuICAgICAgICAnZW50aXR5QVBJJyxcclxuICAgICAgICAnc3RvcnlCYXNlQVBJJyxcclxuICAgICAgICAnc3RvcnlFdmVudHNBUEknLFxyXG4gICAgICAgICdzdG9yeUNoYXJhY3RlcnNBUEknLFxyXG5cclxuICAgICAgICAnc3RvcnlWaWV3QVBJJyxcclxuICAgICAgICAnc3RvcnlBZGFwdGF0aW9uc0FQSScsXHJcbiAgICAgICAgJ2FjY2Vzc01hbmFnZXJBUEknLFxyXG4gICAgICAgICd0ZXh0U2VhcmNoQVBJJyxcclxuICAgICAgICAnZ2VhcnNBUEknLFxyXG4gICAgICAgICdzbGlkZXJzQVBJJyxcclxuICAgICAgICAnbG9nQVBJJ10ubWFwKGZ1bmMpO1xyXG5cclxuICAgIExvZ2dlci5hdHRhY2hMb2dDYWxscyhMb2NhbERCTVMsIFIsIGZhbHNlKTtcclxuXHJcbiAgICBjb25zdCBiYXNlQVBJTGlzdCA9IFIua2V5cyhSLm1lcmdlQWxsKFIudmFsdWVzKGZ1bmNMaXN0KSkpO1xyXG4gICAgY29uc3QgbG9nZ2VyQVBJTGlzdCA9IFIuZGlmZmVyZW5jZShSLmtleXMoUi5tZXJnZUFsbChSLnZhbHVlcyhMb2dnZXIuYXBpSW5mbykpKSwgTG9nZ2VyLm9mZmxpbmVJZ25vcmVMaXN0KTtcclxuXHJcbiAgICBjb25zdCBsb2dnZXJEaWZmID0gUi5zeW1tZXRyaWNEaWZmZXJlbmNlKGxvZ2dlckFQSUxpc3QsIGJhc2VBUElMaXN0KTtcclxuICAgIGlmIChsb2dnZXJEaWZmLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBMb2dnZXIgZGlmZjogJHtsb2dnZXJEaWZmfWApO1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYExvZ2dlZCBidXQgbm90IGluIGJhc2U6ICR7Ui5kaWZmZXJlbmNlKGxvZ2dlckFQSUxpc3QsIGJhc2VBUElMaXN0KX1gKTtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBJbiBiYXNlIGJ1dCBub3QgbG9nZ2VkOiAke1IuZGlmZmVyZW5jZShiYXNlQVBJTGlzdCwgbG9nZ2VyQVBJTGlzdCl9YCk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBUEkgcHJvY2Vzc29ycyBhcmUgaW5jb25zaXN0ZW50Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIExvY2FsREJNUztcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZUxvY2FsREJNU1dyYXBwZXIoZGJtcykge1xyXG5cclxuICAgIGZ1bmN0aW9uIExvY2FsREJNU1dyYXBwZXIoZGJtcykge1xyXG4gICAgICAgIHRoaXMuZGJtcyA9IGRibXM7XHJcbiAgICAgICAgdGhpcy5jbGVhclNldHRpbmdzKCk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIE9iamVjdC5rZXlzKGRibXMuX19wcm90b19fKS5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgTG9jYWxEQk1TV3JhcHBlci5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsICdnZXQnKSB8fCBDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsICdpcycpIHx8IFIuZXF1YWxzKG5hbWUsICdsb2cnKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kYm1zW25hbWVdLmFwcGx5KHRoaXMuZGJtcywgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrID0gYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoIC0gMTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goYXJndW1lbnRzW2ldKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgQ2FsbE5vdGlmaWNhdG9yLm9uQ2FsbFN0YXJ0KCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIENhbGxOb3RpZmljYXRvci5vbkNhbGxGaW5pc2hlZChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGJtc1tuYW1lXS5hcHBseSh0aGlzLmRibXMsIGFycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIFByb21pc2lmaWNhdG9yLnByb21pc2lmeShkYm1zLCBMb2NhbERCTVNXcmFwcGVyKTtcclxuXHJcbiAgICBMb2NhbERCTVNXcmFwcGVyLnByb3RvdHlwZS5jbGVhclNldHRpbmdzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuU2V0dGluZ3MgPSB7XHJcbiAgICAgICAgICAgIEJyaWVmaW5nUHJldmlldzoge30sXHJcbiAgICAgICAgICAgIFN0b3JpZXM6IHt9LFxyXG4gICAgICAgICAgICBQcm9maWxlRWRpdG9yOiB7fVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIExvY2FsREJNU1dyYXBwZXIucHJvdG90eXBlLmdldFNldHRpbmdzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLlNldHRpbmdzO1xyXG4gICAgfTtcclxuICAgIHJldHVybiBuZXcgTG9jYWxEQk1TV3JhcHBlcihkYm1zKTtcclxufSIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGV4cG9ydHMucHJvbWlzaWZ5ID0gKHNyYywgZHN0KSA9PiB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMoc3JjLl9fcHJvdG9fXykuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBkc3QucHJvdG90eXBlW25hbWUgKyAnUG0nXSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsICdnZXQnKSB8fCBDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsICdpcycpIHx8IFIuZXF1YWxzKG5hbWUsICdsb2cnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKGFyZ3VtZW50c1tpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goZnVuY3Rpb24oZXJyLCB2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7cmVqZWN0KGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGJtc1tuYW1lXS5hcHBseSh0aGlzLmRibXMsIGFycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXJyID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goYXJndW1lbnRzW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgQ2FsbE5vdGlmaWNhdG9yLm9uQ2FsbFN0YXJ0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChmdW5jdGlvbihlcnIsIHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDYWxsTm90aWZpY2F0b3Iub25DYWxsRmluaXNoZWQoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7cmVqZWN0KGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRibXNbbmFtZV0uYXBwbHkodGhpcy5kYm1zLCBhcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgXHJcbn0pKHRoaXMuUHJvbWlzaWZpY2F0b3IgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERhdGFiYXNlXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgZnVuYy1uYW1lcyxwcmVmZXItcmVzdC1wYXJhbXMgKi9cclxuXHJcblxyXG5mdW5jdGlvbiBtYWtlUmVtb3RlREJNUyhMb2NhbERCTVMpIHtcclxuICAgIGNvbnN0IHNob3dOb3RpZmljYXRpb24gPSB0cnVlO1xyXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uVGltZW91dCA9IDIwMDA7XHJcbiAgICAvL2NvbnN0IG5vdGlmaWNhdGlvblRpbWVvdXQgPSAxMDAwMDtcclxuICAgIGNvbnN0IHVybCA9ICcvJztcclxuXHJcbiAgICBmdW5jdGlvbiBSZW1vdGVEQk1TKCkge1xyXG4gICAgICAgIHRoaXMuY2xlYXJTZXR0aW5ncygpO1xyXG4gICAgfVxyXG5cclxuICAgIFJlbW90ZURCTVMuX3NpbXBsZUdldCA9IGZ1bmN0aW9uIChuYW1lLCBwYXJhbXMsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgbGV0IHBhcmFtU3RyID0gJyc7XHJcbiAgICAgICAgaWYgKHBhcmFtcykge1xyXG4gICAgICAgICAgICBwYXJhbVN0ciA9IGA/cGFyYW1zPSR7ZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KHBhcmFtcykpfWA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgdXJsOiB1cmwgKyBuYW1lICsgcGFyYW1TdHIsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCcsXHJcbiAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXHJcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04JyxcclxuICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICB0aW1lb3V0OiBDb25zdGFudHMuaHR0cFRpbWVvdXQsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJlcXVlc3QuZG9uZSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBKU09OLnBhcnNlKGRhdGEpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKChlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhKU09OLnBhcnNlKGVycm9ySW5mby5yZXNwb25zZVRleHQpKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8IHRleHRTdGF0dXMgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgUmVtb3RlREJNUy5fc2ltcGxlUHV0ID0gZnVuY3Rpb24gKG5hbWUsIGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9ICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybDogdXJsICsgbmFtZSxcclxuICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0JyxcclxuICAgICAgICAgICAgbWV0aG9kOiAnUFVUJyxcclxuICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnLFxyXG4gICAgICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeShkYXRhKSxcclxuICAgICAgICAgICAgdGltZW91dDogQ29uc3RhbnRzLmh0dHBUaW1lb3V0XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgQ2FsbE5vdGlmaWNhdG9yLm9uQ2FsbFN0YXJ0KCk7XHJcblxyXG4gICAgICAgIHJlcXVlc3QuZG9uZSgoZGF0YTIpID0+IHtcclxuICAgICAgICAgICAgQ2FsbE5vdGlmaWNhdG9yLm9uQ2FsbEZpbmlzaGVkKCk7XHJcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKChlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSA9PiB7XHJcbiAgICAgICAgICAgIENhbGxOb3RpZmljYXRvci5vbkNhbGxGaW5pc2hlZChlcnJvckluZm8pO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soSlNPTi5wYXJzZShlcnJvckluZm8ucmVzcG9uc2VUZXh0KSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCB8fCB0ZXh0U3RhdHVzIHx8ICdlcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuXHJcbiAgICBPYmplY3Qua2V5cyhMb2NhbERCTVMucHJvdG90eXBlKS5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgUmVtb3RlREJNUy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKGFyZ3VtZW50c1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICBpZihDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsIFwiX1wiKSl7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcgZm9yIGlubmVyIGZ1bmN0aW9uc1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICBpZiAoQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChuYW1lLCAnZ2V0JykgfHwgQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChuYW1lLCAnaXMnKSkge1xyXG4gICAgICAgICAgICAgICAgUmVtb3RlREJNUy5fc2ltcGxlR2V0KG5hbWUsIGFyciwgYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBSZW1vdGVEQk1TLl9zaW1wbGVQdXQobmFtZSwgYXJyLCBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgLy8gcHJvbWlzaWZpY2F0aW9uXHJcbiAgICBPYmplY3Qua2V5cyhMb2NhbERCTVMucHJvdG90eXBlKS5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgUmVtb3RlREJNUy5wcm90b3R5cGVbbmFtZSArICdQbSddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKGFyZ3VtZW50c1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICBpZihDb21tb25VdGlscy5zdGFydHNXaXRoKG5hbWUsIFwiX1wiKSl7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcgZm9yIGlubmVyIGZ1bmN0aW9uc1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChuYW1lLCAnZ2V0JykgfHwgQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChuYW1lLCAnaXMnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIFJlbW90ZURCTVMuX3NpbXBsZUdldChuYW1lLCBhcnIsIGZ1bmN0aW9uKGVyciwgdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7cmVqZWN0KGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBSZW1vdGVEQk1TLl9zaW1wbGVQdXQobmFtZSwgYXJyLCBmdW5jdGlvbihlcnIsIHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycikge3JlamVjdChlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIFJlbW90ZURCTVMucHJvdG90eXBlLmNsZWFyU2V0dGluZ3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdGhpcy5TZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgQnJpZWZpbmdQcmV2aWV3OiB7fSxcclxuICAgICAgICAgICAgU3Rvcmllczoge30sXHJcbiAgICAgICAgICAgIFByb2ZpbGVFZGl0b3I6IHt9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgUmVtb3RlREJNUy5wcm90b3R5cGUuZ2V0U2V0dGluZ3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuU2V0dGluZ3M7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIFJlbW90ZURCTVM7XHJcbn1cclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLm1ha2VOZXdCYXNlID0gKGNhbGxiYWNrKSA9PiAoKSA9PiB7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShnZXRMMTBuKCd1dGlscy1uZXctYmFzZS13YXJuaW5nJyksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShDb21tb25VdGlscy5jbG9uZShFbXB0eUJhc2UuZGF0YSksIGNhbGxiYWNrKTtcclxuLy8gICAgICAgICAgICBUZXN0VXRpbHMuYWRkR3JvdXBUZXN0aW5nRGF0YSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9wZW5IZWxwID0gKCkgPT4ge1xyXG4gICAgICAgIHdpbmRvdy5vcGVuKCdleHRyYXMvZG9jL25pbXMuaHRtbCcpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlYWRTaW5nbGVGaWxlID0gKGNhbGxiYWNrKSA9PiAoZXZ0KSA9PiB7XHJcbiAgICAgICAgLy8gUmV0cmlldmUgdGhlIGZpcnN0IChhbmQgb25seSEpIEZpbGUgZnJvbSB0aGUgRmlsZUxpc3Qgb2JqZWN0XHJcbiAgICAgICAgY29uc3QgZiA9IGV2dC50YXJnZXQuZmlsZXNbMF07XHJcblxyXG4gICAgICAgIGlmIChmKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgICAgICByLm9ubG9hZCA9IChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IGUudGFyZ2V0LnJlc3VsdDtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YWJhc2UgPSBKU09OLnBhcnNlKGNvbnRlbnRzKTtcclxuICAgICAgICAgICAgICAgICAgICBEQk1TLnNldERhdGFiYXNlKGRhdGFiYXNlLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByLnJlYWRBc1RleHQoZik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigndXRpbHMtYmFzZS1maWxlLWxvYWRpbmctZXJyb3InKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNhdmVGaWxlID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0RGF0YWJhc2UoKGVyciwgZGF0YWJhc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZXhwb3J0cy5qc29uMkZpbGUoZGF0YWJhc2UsIGV4cG9ydHMubWFrZUZpbGVOYW1lKGAke0JBU0VfRklMRV9OQU1FfV8ke2RhdGFiYXNlLk1ldGEubmFtZX1gLCAnanNvbicsIG5ldyBEYXRlKGRhdGFiYXNlLk1ldGEuc2F2ZVRpbWUpKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLm1ha2VGaWxlTmFtZSA9IChyb290LCBleHRlbnNpb24sIGRhdGUpID0+IHtcclxuICAgICAgICBkYXRlID0gZGF0ZSB8fCBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIGNvbnN0IHRpbWVTdHIgPSBkYXRlLmZvcm1hdCgnZGQtbW1tLXl5eXlfSEgtTU0tc3MnKTtcclxuICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGAke3Jvb3R9XyR7dGltZVN0cn1gO1xyXG4gICAgICAgIHJldHVybiBgJHtDb21tb25VdGlscy5zYW5pdGl6ZVN0cjJGaWxlTmFtZShmaWxlTmFtZSl9LiR7ZXh0ZW5zaW9ufWA7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuanNvbjJGaWxlID0gKHN0ciwgZmlsZU5hbWUpID0+IHtcclxuICAgICAgICBleHBvcnRzLnN0cjJGaWxlKEpTT04uc3RyaW5naWZ5KHN0ciwgbnVsbCwgJyAgJyksIGZpbGVOYW1lKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5zdHIyRmlsZSA9IChzdHIsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtzdHJdLCB7XHJcbiAgICAgICAgICAgIHR5cGU6ICd0ZXh0L3BsYWluO2NoYXJzZXQ9dXRmLTgnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUFzKGJsb2IsIGZpbGVOYW1lKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcHJlcHJvY2Vzc0NzdlN0cihzdHIpIHtcclxuICAgICAgICBpZiAoISh0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyB8fCBzdHIgaW5zdGFuY2VvZiBTdHJpbmcpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzdHI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCByZXN1bHQgPSBzdHIucmVwbGFjZSgvXCIvZywgJ1wiXCInKTtcclxuICAgICAgICBpZiAocmVzdWx0LnNlYXJjaCgvKFwifCx8XFxuKS9nKSA+PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IGBcIiR7cmVzdWx0fVwiYDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnRzLmFycjJkMkNzdiA9IChhcnIsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3N2ID0gYFxcdWZlZmYke2Fyci5tYXAoZGF0YUFycmF5ID0+IGRhdGFBcnJheS5tYXAocHJlcHJvY2Vzc0NzdlN0cikuam9pbignOycpKS5qb2luKCdcXG4nKX1gO1xyXG5cclxuICAgICAgICBjb25zdCBvdXQgPSBuZXcgQmxvYihbY3N2XSwge1xyXG4gICAgICAgICAgICB0eXBlOiAndGV4dC9jc3Y7Y2hhcnNldD11dGYtODsnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUFzKG91dCwgZXhwb3J0cy5tYWtlRmlsZU5hbWUoZmlsZU5hbWUsICdjc3YnKSk7XHJcbiAgICB9O1xyXG59KSh0aGlzLkZpbGVVdGlscyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgbm8tdmFyLHZhcnMtb24tdG9wICovXHJcblxyXG4oKGV4cG9ydHMsIERpY3Rpb25hcmllcykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBzdGF0ZS5pbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgc3RhdGUubDEwbkRlbGVnYXRlcyA9IFtdO1xyXG4gICAgc3RhdGUuZGljdGlvbmFyaWVzID0ge307XHJcbiAgICBzdGF0ZS5sYW5nID0gZGVmYXVsdExhbmc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChzdGF0ZS5pbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAgICBjb25zb2xlLmxvZyhuYXZpZ2F0b3IubGFuZ3VhZ2UpO1xyXG5cclxuICAgICAgICBzdGF0ZS5kaWN0aW9uYXJpZXMgPSBSLm1hcChwcm9jZXNzRGljdGlvbmFyeSwgRGljdGlvbmFyaWVzKTtcclxuXHJcbiAgICAgICAgLy8gICAgdmFyIGxhbmcgPSAobmF2aWdhdG9yLmxhbmd1YWdlcyA/IG5hdmlnYXRvci5sYW5ndWFnZXNbMF0gOiBuYXZpZ2F0b3IuYnJvd3Nlckxhbmd1YWdlKS5zcGxpdCgnLScpWzBdO1xyXG4gICAgICAgIC8vICAgIHZhciBsYW5nID0gJ3J1JztcclxuICAgICAgICAvLyAgICAgICAgdmFyIGxhbmcgPSBkZWZhdWx0TGFuZztcclxuICAgICAgICAvLyAgICAgICAgY29uc29sZS5sb2cobGFuZyk7XHJcblxyXG4gICAgICAgIGlmIChzdGF0ZS5kaWN0aW9uYXJpZXNbZGVmYXVsdExhbmddKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXNbZGVmYXVsdExhbmddO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMuZW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldEh0bWxMYW5nKGRlZmF1bHRMYW5nKTtcclxuICAgICAgICBleHBvcnRzLm9uTDEwbkNoYW5nZShleHBvcnRzLmxvY2FsaXplU3RhdGljKTtcclxuICAgICAgICBzdGF0ZS5pbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBwcm9jZXNzRGljdGlvbmFyeSA9IChkaWN0aW9uYXJ5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvY2Vzc2VkRGljdGlvbmFyeSA9IHt9O1xyXG4gICAgICAgIFIudG9QYWlycyhkaWN0aW9uYXJ5KS5mb3JFYWNoKChbc2VjdGlvbk5hbWUsIHNlY3Rpb25dKSA9PiB7XHJcbiAgICAgICAgICAgIFIudG9QYWlycyhzZWN0aW9uKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3NlZERpY3Rpb25hcnlbYCR7c2VjdGlvbk5hbWV9LSR7a2V5fWBdID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vICAgICAgICBmb3IgKGNvbnN0IHNlY3Rpb25OYW1lIGluIGRpY3Rpb25hcnkpIHtcclxuICAgICAgICAvLyAgICAgICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiBkaWN0aW9uYXJ5W3NlY3Rpb25OYW1lXSkge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgICAgIHByb2Nlc3NlZERpY3Rpb25hcnlbYCR7c2VjdGlvbk5hbWV9LSR7bmFtZX1gXSA9IGRpY3Rpb25hcnlbc2VjdGlvbk5hbWVdW25hbWVdO1xyXG4gICAgICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3NlZERpY3Rpb25hcnk7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBzZXRIdG1sTGFuZyA9IGxhbmcgPT4gc2V0QXR0cihkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaHRtbCcpWzBdLCAnbGFuZycsIGxhbmcpO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmdldExvY2FsZSA9ICgpID0+IHN0YXRlLmxhbmc7XHJcblxyXG4gICAgZXhwb3J0cy50b2dnbGVMMTBuID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChzdGF0ZS5sYW5nID09PSAncnUnKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMuZW47XHJcbiAgICAgICAgICAgIHN0YXRlLmxhbmcgPSAnZW4nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMucnU7XHJcbiAgICAgICAgICAgIHN0YXRlLmxhbmcgPSAncnUnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZXRIdG1sTGFuZyhzdGF0ZS5sYW5nKTtcclxuICAgICAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzLmZvckVhY2goKGRlbGVnYXRlKSA9PiB7XHJcbiAgICAgICAgICAgIGRlbGVnYXRlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuZ2V0TGFuZyA9ICgpID0+IHN0YXRlLmxhbmcudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICBleHBvcnRzLmZvcm1hdCA9IFIuY3VycnkoKG5hbWVzcGFjZSwgbmFtZSwgYXJncykgPT4gc3RyRm9ybWF0KGV4cG9ydHMuZ2V0KG5hbWVzcGFjZSwgbmFtZSksIGFyZ3MpKTtcclxuXHJcbiAgICBleHBvcnRzLmdldCA9IFIuY3VycnkoKG5hbWVzcGFjZSwgbmFtZSkgPT4gTDEwbi5nZXRWYWx1ZShgJHtuYW1lc3BhY2V9LSR7bmFtZX1gKSk7XHJcblxyXG4gICAgZXhwb3J0cy5nZXRWYWx1ZSA9IChuYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzdGF0ZS5kaWN0W25hbWVdO1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSBjb25zb2xlLmxvZyhgVmFsdWUgaXMgbm90IGZvdW5kOiAke25hbWV9YCk7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlIHx8IGAke25hbWV9OlJBIFJBLUFILUFILUFIIFJPTUEgUk9NQS1NQSBHQUdBIE9IIExBLUxBYDtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMuaGFzVmFsdWUgPSAobmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gc3RhdGUuZGljdFtuYW1lXTtcclxuICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5vbkwxMG5DaGFuZ2UgPSAoZGVsZWdhdGUpID0+IHtcclxuICAgICAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzLnB1c2goZGVsZWdhdGUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmxvY2FsaXplU3RhdGljID0gKGVsKSA9PiB7XHJcbiAgICAgICAgZWwgPSBlbCB8fCBkb2N1bWVudDtcclxuICAgICAgICBubDJhcnJheShxZWVzKGVsLCAnW2wxMG4taWRdJykpLm1hcChlbDIgPT5cclxuICAgICAgICAgICAgYWRkRWwoY2xlYXJFbChlbDIpLCBtYWtlVGV4dChleHBvcnRzLmdldFZhbHVlKGdldEF0dHIoZWwyLCAnbDEwbi1pZCcpKSkpKTtcclxuICAgICAgICBubDJhcnJheShxZWVzKGVsLCAnW2wxMG4tcGxhY2Vob2xkZXItaWRdJykpLm1hcChlbDIgPT5cclxuICAgICAgICAgICAgc2V0QXR0cihlbDIsICdwbGFjZWhvbGRlcicsIGV4cG9ydHMuZ2V0VmFsdWUoZ2V0QXR0cihlbDIsICdsMTBuLXBsYWNlaG9sZGVyLWlkJykpKSk7XHJcbiAgICAgICAgbmwyYXJyYXkocWVlcyhlbCwgJ1tsMTBuLXRpdGxlXScpKS5tYXAoZWwyID0+XHJcbiAgICAgICAgICAgIHNldEF0dHIoZWwyLCAndGl0bGUnLCBleHBvcnRzLmdldFZhbHVlKGdldEF0dHIoZWwyLCAnbDEwbi10aXRsZScpKSkpO1xyXG4gICAgfTtcclxufSkodGhpcy5MMTBuID0ge30sIERpY3Rpb25hcmllcyk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IGluZGV4ZWREQiAgICAgPSB3aW5kb3cuaW5kZXhlZERCIHx8IHdpbmRvdy5tb3pJbmRleGVkREIgfHwgd2luZG93LndlYmtpdEluZGV4ZWREQiB8fCB3aW5kb3cubXNJbmRleGVkREI7XHJcbiAgICBjb25zdCBJREJUcmFuc2FjdGlvbiAgPSB3aW5kb3cuSURCVHJhbnNhY3Rpb24gfHwgd2luZG93LndlYmtpdElEQlRyYW5zYWN0aW9uIHx8IHdpbmRvdy5tc0lEQlRyYW5zYWN0aW9uO1xyXG4gICAgY29uc3QgYmFzZU5hbWUgICAgICA9IFwiZmlsZXNCYXNlXCI7XHJcbiAgICBjb25zdCBzdG9yZU5hbWUgICAgID0gXCJmaWxlc1N0b3JlXCI7XHJcbiAgICBcclxuLy8gLy8gVGhpcyB3b3JrcyBvbiBhbGwgZGV2aWNlcy9icm93c2VycywgYW5kIHVzZXMgSW5kZXhlZERCU2hpbSBhcyBhIGZpbmFsIGZhbGxiYWNrIFxyXG4vLyAgICB2YXIgaW5kZXhlZERCID0gd2luZG93LmluZGV4ZWREQiB8fCB3aW5kb3cubW96SW5kZXhlZERCIHx8IHdpbmRvdy53ZWJraXRJbmRleGVkREIgfHwgd2luZG93Lm1zSW5kZXhlZERCIHx8IHdpbmRvdy5zaGltSW5kZXhlZERCO1xyXG4vL1xyXG4vLyAgICAvLyBPcGVuIChvciBjcmVhdGUpIHRoZSBkYXRhYmFzZVxyXG4vLyAgICB2YXIgb3BlbiA9IGluZGV4ZWREQi5vcGVuKFwiTXlEYXRhYmFzZVwiLCAxKTtcclxuLy9cclxuLy8gICAgLy8gQ3JlYXRlIHRoZSBzY2hlbWFcclxuLy8gICAgb3Blbi5vbnVwZ3JhZGVuZWVkZWQgPSBmdW5jdGlvbigpIHtcclxuLy8gICAgICAgIHZhciBkYiA9IG9wZW4ucmVzdWx0O1xyXG4vLyAgICAgICAgdmFyIHN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoXCJNeU9iamVjdFN0b3JlXCIsIHtrZXlQYXRoOiBcImlkXCJ9KTtcclxuLy8gICAgICAgIHZhciBpbmRleCA9IHN0b3JlLmNyZWF0ZUluZGV4KFwiTmFtZUluZGV4XCIsIFtcIm5hbWUubGFzdFwiLCBcIm5hbWUuZmlyc3RcIl0pO1xyXG4vLyAgICB9O1xyXG4vL1xyXG4vLyAgICBvcGVuLm9uc3VjY2VzcyA9IGZ1bmN0aW9uKCkge1xyXG4vLyAgICAgICAgLy8gU3RhcnQgYSBuZXcgdHJhbnNhY3Rpb25cclxuLy8gICAgICAgIHZhciBkYiA9IG9wZW4ucmVzdWx0O1xyXG4vLyAgICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oXCJNeU9iamVjdFN0b3JlXCIsIFwicmVhZHdyaXRlXCIpO1xyXG4vLyAgICAgICAgdmFyIHN0b3JlID0gdHgub2JqZWN0U3RvcmUoXCJNeU9iamVjdFN0b3JlXCIpO1xyXG4vLyAgICAgICAgdmFyIGluZGV4ID0gc3RvcmUuaW5kZXgoXCJOYW1lSW5kZXhcIik7XHJcbi8vXHJcbi8vICAgICAgICAvLyBBZGQgc29tZSBkYXRhXHJcbi8vICAgICAgICBzdG9yZS5wdXQoe2lkOiAxMjM0NSwgbmFtZToge2ZpcnN0OiBcIkpvaG5cIiwgbGFzdDogXCJEb2VcIn0sIGFnZTogNDJ9KTtcclxuLy8gICAgICAgIHN0b3JlLnB1dCh7aWQ6IDY3ODkwLCBuYW1lOiB7Zmlyc3Q6IFwiQm9iXCIsIGxhc3Q6IFwiU21pdGhcIn0sIGFnZTogMzV9KTtcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgLy8gUXVlcnkgdGhlIGRhdGFcclxuLy8gICAgICAgIHZhciBnZXRKb2huID0gc3RvcmUuZ2V0KDEyMzQ1KTtcclxuLy8gICAgICAgIHZhciBnZXRCb2IgPSBpbmRleC5nZXQoW1wiU21pdGhcIiwgXCJCb2JcIl0pO1xyXG4vL1xyXG4vLyAgICAgICAgZ2V0Sm9obi5vbnN1Y2Nlc3MgPSBmdW5jdGlvbigpIHtcclxuLy8gICAgICAgICAgICBjb25zb2xlLmxvZyhnZXRKb2huLnJlc3VsdC5uYW1lLmZpcnN0KTsgIC8vID0+IFwiSm9oblwiXHJcbi8vICAgICAgICB9O1xyXG4vL1xyXG4vLyAgICAgICAgZ2V0Qm9iLm9uc3VjY2VzcyA9IGZ1bmN0aW9uKCkge1xyXG4vLyAgICAgICAgICAgIGNvbnNvbGUubG9nKGdldEJvYi5yZXN1bHQubmFtZS5maXJzdCk7ICAgLy8gPT4gXCJCb2JcIlxyXG4vLyAgICAgICAgfTtcclxuLy9cclxuLy8gICAgICAgIC8vIENsb3NlIHRoZSBkYiB3aGVuIHRoZSB0cmFuc2FjdGlvbiBpcyBkb25lXHJcbi8vICAgICAgICB0eC5vbmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7XHJcbi8vICAgICAgICAgICAgZGIuY2xvc2UoKTtcclxuLy8gICAgICAgIH07XHJcbi8vICAgIH1cclxuICAgIFxyXG4gICAgZXhwb3J0cy50ZXN0ID0gKCkgPT4ge1xyXG4vLyAgICAgICAgY29uc29sZS5sb2coJzIzMjMyMjMnKTtcclxuLy8gICAgICAgIGV4cG9ydHMucHV0KCdiYXNlMScsIHtcclxuLy8gICAgICAgICAgICAnc2QnOjEyLFxyXG4vLyAgICAgICAgfSwgbG9nZXJyMik7XHJcbi8vICAgICAgICBleHBvcnRzLnB1dCgnYmFzZTInLCB7XHJcbi8vICAgICAgICAgICAgJ3NzZHNkZCc6MTY1NDY1NCxcclxuLy8gICAgICAgIH0sIGxvZ2VycjIpO1xyXG4vLyAgICAgICAgZXhwb3J0cy5nZXQoJ2Jhc2UxJywgKGVyciwgYmFzZSkgPT4ge1xyXG4vLyAgICAgICAgICAgIGlmKGVycikge2NvbnNvbGUubG9nKGVycik7IHJldHVybjt9XHJcbi8vICAgICAgICAgICAgY29uc29sZS5sb2coYmFzZSk7XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgICAgIGV4cG9ydHMuZ2V0KCdiYXNlMycsIChlcnIsIGJhc2UpID0+IHtcclxuLy8gICAgICAgICAgICBpZihlcnIpIHtjb25zb2xlLmxvZyhlcnIpOyByZXR1cm47fVxyXG4vLyAgICAgICAgICAgIGNvbnNvbGUubG9nKGJhc2UpO1xyXG4vLyAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGxvZ2VycihlcnIpe1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHZhciBsb2dlcnIyID0gKGVycikgPT4ge1xyXG4gICAgICAgIGlmKGVycikge2NvbnNvbGUubG9nKGVycik7IHJldHVybjt9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBjb25uZWN0REIoY2FsbGJhY2spe1xyXG4gICAgICAgIHZhciByZXF1ZXN0ID0gaW5kZXhlZERCLm9wZW4oYmFzZU5hbWUsIDEpO1xyXG4gICAgICAgIHJlcXVlc3Qub25lcnJvciA9IGNhbGxiYWNrO1xyXG4gICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVxdWVzdC5yZXN1bHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGZ1bmN0aW9uKGUpe1xyXG4gICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQucmVzdWx0LmNyZWF0ZU9iamVjdFN0b3JlKHN0b3JlTmFtZSwgeyBrZXlQYXRoOiBcImlkXCIgfSk7XHJcbiAgICAgICAgICAgIGNvbm5lY3REQihjYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBleHBvcnRzLmdldCA9IChpZCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgY29ubmVjdERCKGZ1bmN0aW9uKGVyciwgZGIpe1xyXG4gICAgICAgICAgICAgICAgaWYoZXJyKSB7cmVqZWN0KGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVxdWVzdCA9IGRiLnRyYW5zYWN0aW9uKFtzdG9yZU5hbWVdLCBcInJlYWRvbmx5XCIpLm9iamVjdFN0b3JlKHN0b3JlTmFtZSkuZ2V0KGlkKTtcclxuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9IHJlamVjdDtcclxuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0ID8gcmVxdWVzdC5yZXN1bHQgOiBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGV4cG9ydHMucHV0ID0gKGlkLCBvYmopID0+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgIGNvbm5lY3REQihmdW5jdGlvbihlcnIsIGRiKXtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge3JlamVjdChlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgdmFyIHJlcXVlc3QgPSBkYi50cmFuc2FjdGlvbihbc3RvcmVOYW1lXSwgXCJyZWFkd3JpdGVcIikub2JqZWN0U3RvcmUoc3RvcmVOYW1lKS5wdXQoe2lkLCBvYmp9KTtcclxuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9IHJlamVjdDtcclxuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuTG9jYWxCYXNlQVBJID0ge30pOyIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGV4cG9ydHMucnVuVGVzdHMgPSAoKSA9PiB7XHJcbiAgICAgICAgcXVlcnlFbCgnYm9keScpLnN0eWxlLm92ZXJmbG93ID0gJ2F1dG8nO1xyXG4gICAgICAgIHdpbmRvdy5SdW5UZXN0cygpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNob3dDb25zaXN0ZW5jeUNoZWNrQWxlcnQgPSAoY2hlY2tSZXMpID0+IHtcclxuICAgICAgICBpZiAoY2hlY2tSZXMgPT09IHVuZGVmaW5lZCB8fCBjaGVja1Jlcy5lcnJvcnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LWlzLW9rJykpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LXByb2JsZW0tZGV0ZWN0ZWQnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmNsaWNrVGhyb3VnaHRIZWFkZXJzID0gKCkgPT4ge1xyXG4gICAgICAgIGxldCB0YWJzID0gcXVlcnlFbHMoJyNuYXZpZ2F0aW9uIC5uYXZpZ2F0aW9uLWJ1dHRvbicpO1xyXG5cclxuICAgICAgICBsZXQgaW5kZXggPSAwO1xyXG4gICAgICAgIGxldCBzdWJUYWJzTnVtID0gMDtcclxuICAgICAgICBmdW5jdGlvbiBydW5DbGlja2VyKCkge1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPD0gdGFicy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICB0YWJzW2luZGV4XS5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHN1YlRhYnNOdW0gPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJUYWJzID0gcXVlcnlFbHMoJyNjb250ZW50QXJlYSAubmF2aWdhdGlvbi1idXR0b24nKTtcclxuICAgICAgICAgICAgICAgICAgICB0YWJzID0gUi5pbnNlcnRBbGwoaW5kZXggKyAxLCBzdWJUYWJzLCB0YWJzKTtcclxuICAgICAgICAgICAgICAgICAgICBzdWJUYWJzTnVtID0gc3ViVGFicy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHN1YlRhYnNOdW0tLTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGluZGV4Kys7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJ1bkNsaWNrZXIsIDUwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcnVuQ2xpY2tlcigpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNob3dNb2R1bGVTY2hlbWEgPSAoY2hlY2tSZXMpID0+IHtcclxuICAgICAgICBhZGRFbChxdWVyeUVsKCdib2R5JyksIHF1ZXJ5RWwoJy5jb25zaXN0ZW5jeS1jaGVjay1yZXN1bHQtZGlhbG9nJykpO1xyXG4gICAgICAgICQocXVlcnlFbCgnLmNvbnNpc3RlbmN5LWNoZWNrLXJlc3VsdC1kaWFsb2cnKSkubW9kYWwoJ3Nob3cnKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3ZnID0gZDMuc2VsZWN0KCcuaW1hZ2UtcGxhY2Ugc3ZnJyk7XHJcbiAgICAgICAgY29uc3Qgc3ZnR3JvdXAgPSBzdmcuYXBwZW5kKCdnJyk7XHJcbiAgICAgICAgY29uc3Qgcm9vdCA9IHN2Z0dyb3VwLmFwcGVuZCgnZycpO1xyXG5cclxuICAgICAgICAvLyBkZWZpbmUgYW4gYXJyb3cgaGVhZFxyXG4gICAgICAgIHN2Zy5hcHBlbmQoJ3N2ZzpkZWZzJylcclxuICAgICAgICAgICAgLmFwcGVuZCgnc3ZnOm1hcmtlcicpXHJcbiAgICAgICAgICAgIC5hdHRyKCdpZCcsICdlbmQnKVxyXG4gICAgICAgICAgICAuYXR0cigndmlld0JveCcsICcwIC01IDEwIDEwJylcclxuICAgICAgICAgICAgLmF0dHIoJ3JlZlgnLCAxMClcclxuICAgICAgICAgICAgLmF0dHIoJ3JlZlknLCAwKVxyXG4gICAgICAgICAgICAuYXR0cignbWFya2VyV2lkdGgnLCAzKSAvLyBtYXJrZXIgc2V0dGluZ3NcclxuICAgICAgICAgICAgLmF0dHIoJ21hcmtlckhlaWdodCcsIDUpXHJcbiAgICAgICAgICAgIC5hdHRyKCdvcmllbnQnLCAnYXV0bycpXHJcbiAgICAgICAgICAgIC5zdHlsZSgnZmlsbCcsICcjOTk5JylcclxuICAgICAgICAgICAgLnN0eWxlKCdzdHJva2Utb3BhY2l0eScsIDAuNikgLy8gYXJyb3doZWFkIGNvbG9yXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3N2ZzpwYXRoJylcclxuICAgICAgICAgICAgLmF0dHIoJ2QnLCAnTTAsLTVMMTAsMEwwLDUnKTtcclxuXHJcbiAgICAgICAgY29uc3Qgbm9kZURpY3QgPSBjaGVja1Jlcy5ub2Rlcy5yZWR1Y2UoKGRpY3QsIG5hbWUsIGkpID0+IHtcclxuICAgICAgICAgICAgZGljdFtuYW1lXSA9IGk7XHJcbiAgICAgICAgICAgIHJldHVybiBkaWN0O1xyXG4gICAgICAgIH0sIHt9KTtcclxuXHJcbiAgICAgICAgY29uc3Qgbm9kZVdpZHRoID0gMTcwO1xyXG4gICAgICAgIGNvbnN0IG5vZGVIZWlnaHQgPSAzMDtcclxuXHJcbiAgICAgICAgY29uc3QgbmFtZTJOb2RlID0gbmFtZSA9PiAoe1xyXG4gICAgICAgICAgICBpZDogbm9kZURpY3RbbmFtZV0sXHJcbiAgICAgICAgICAgIG5hbWUsXHJcbiAgICAgICAgICAgIHdpZHRoOiBub2RlV2lkdGgsXHJcbiAgICAgICAgICAgIGhlaWdodDogbm9kZUhlaWdodFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBwYWlyMkVkZ2UgPSAocGFpciwgaSkgPT4gKHtcclxuICAgICAgICAgICAgaWQ6IGkgKyBjaGVja1Jlcy5ub2Rlcy5sZW5ndGgsXHJcbiAgICAgICAgICAgIHNvdXJjZTogbm9kZURpY3RbcGFpclswXV0sXHJcbiAgICAgICAgICAgIHRhcmdldDogbm9kZURpY3RbcGFpclsxXV1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgZ3JhcGggPSB7XHJcbiAgICAgICAgICAgIG5vZGVzOiBjaGVja1Jlcy5ub2Rlcy5tYXAobmFtZTJOb2RlKSxcclxuICAgICAgICAgICAgbGlua3M6IGNoZWNrUmVzLmVkZ2VzLm1hcChwYWlyMkVkZ2UpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgbGF5b3V0ZXIgPSBrbGF5LmQzYWRhcHRlcigpO1xyXG4gICAgICAgIGNvbnN0IHdpZHRoID0gOTYwO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IDYwMDtcclxuXHJcbiAgICAgICAgbGF5b3V0ZXJcclxuICAgICAgICAgICAgLm5vZGVzKGdyYXBoLm5vZGVzKVxyXG4gICAgICAgICAgICAubGlua3MoZ3JhcGgubGlua3MpXHJcbiAgICAgICAgICAgIC5zaXplKFt3aWR0aCwgaGVpZ2h0XSlcclxuICAgICAgICAgICAgLnRyYW5zZm9ybUdyb3VwKHJvb3QpXHJcbiAgICAgICAgICAgIC5vcHRpb25zKHtcclxuICAgICAgICAgICAgICAgIGVkZ2VSb3V0aW5nOiAnT1JUSE9HT05BTCcsXHJcbiAgICAgICAgICAgICAgICBpbnRDb29yZGluYXRlczogZmFsc2VcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRlZmF1bHRQb3J0U2l6ZShbMiwgMl0pXHJcbiAgICAgICAgICAgIC5zdGFydCgpO1xyXG5cclxuICAgICAgICBjb25zdCBsaW5rID0gcm9vdC5zZWxlY3RBbGwoJy5saW5rJylcclxuICAgICAgICAgICAgLmRhdGEoZ3JhcGgubGlua3MpXHJcbiAgICAgICAgICAgIC5lbnRlcigpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3BhdGgnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAnbGluaycpXHJcbiAgICAgICAgICAgIC5hdHRyKCdkJywgJ00wIDAnKVxyXG4gICAgICAgICAgICAuYXR0cignbWFya2VyLWVuZCcsICd1cmwoI2VuZCknKTtcclxuXHJcbiAgICAgICAgLy8gd2UgZ3JvdXAgbm9kZXMgYWxvbmcgd2l0aCB0aGVpciBwb3J0c1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSByb290LnNlbGVjdEFsbCgnLm5vZGUnKVxyXG4gICAgICAgICAgICAuZGF0YShncmFwaC5ub2RlcylcclxuICAgICAgICAgICAgLmVudGVyKClcclxuICAgICAgICAgICAgLmFwcGVuZCgnZycpO1xyXG5cclxuICAgICAgICBub2RlLmFwcGVuZCgncmVjdCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsIChkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZXRhaWxzID0gY2hlY2tSZXMuZGV0YWlsc1tkLm5hbWVdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRldGFpbHMgPT09IHVuZGVmaW5lZCB8fCBkZXRhaWxzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnbm9kZSB2YWxpZCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ25vZGUgaW52YWxpZCc7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5hdHRyKCd3aWR0aCcsIG5vZGVXaWR0aClcclxuICAgICAgICAgICAgLmF0dHIoJ2hlaWdodCcsIG5vZGVIZWlnaHQpXHJcbiAgICAgICAgICAgIC5hdHRyKCdyeCcsIDUpXHJcbiAgICAgICAgICAgIC5hdHRyKCdyeScsIDUpXHJcbiAgICAgICAgICAgIC5hdHRyKCd4JywgMClcclxuICAgICAgICAgICAgLmF0dHIoJ3knLCAwKTtcclxuXHJcbiAgICAgICAgbm9kZS5hcHBlbmQoJ3RleHQnKVxyXG4gICAgICAgICAgICAuYXR0cigneCcsIG5vZGVXaWR0aCAvIDIpXHJcbiAgICAgICAgICAgIC5hdHRyKCd5Jywgbm9kZUhlaWdodCAvIDIpXHJcbiAgICAgICAgICAgIC5hdHRyKCdhbGlnbm1lbnQtYmFzZWxpbmUnLCAnbWlkZGxlJylcclxuICAgICAgICAgICAgLmF0dHIoJ3RleHQtYW5jaG9yJywgJ21pZGRsZScpXHJcbiAgICAgICAgICAgIC50ZXh0KGQgPT4gZC5uYW1lKVxyXG4gICAgICAgICAgICAuYXR0cignZm9udC1zaXplJywgJzRweCcpO1xyXG5cclxuICAgICAgICAvLyBwb3J0c1xyXG4gICAgICAgIGNvbnN0IHBvcnQgPSBub2RlLnNlbGVjdEFsbCgnLnBvcnQnKVxyXG4gICAgICAgICAgICAuZGF0YShkID0+IGQucG9ydHMpXHJcbiAgICAgICAgICAgIC5lbnRlcigpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3JlY3QnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAncG9ydCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCd3aWR0aCcsIDIpXHJcbiAgICAgICAgICAgIC5hdHRyKCdoZWlnaHQnLCAyKVxyXG4gICAgICAgICAgICAuYXR0cigneCcsIDApXHJcbiAgICAgICAgICAgIC5hdHRyKCd5JywgMCk7XHJcblxyXG4gICAgICAgIC8vIGFwcGx5IGxheW91dFxyXG4gICAgICAgIGxheW91dGVyLm9uKCdmaW5pc2gnLCAoZDIpID0+IHtcclxuICAgICAgICAvLyBhcHBseSBlZGdlIHJvdXRlc1xyXG4gICAgICAgICAgICBsaW5rLnRyYW5zaXRpb24oKS5hdHRyKCdkJywgKGQpID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBwYXRoID0gJyc7XHJcbiAgICAgICAgICAgICAgICBwYXRoICs9IGBNJHtkLnNvdXJjZVBvaW50Lnh9ICR7ZC5zb3VyY2VQb2ludC55fSBgO1xyXG4gICAgICAgICAgICAgICAgZC5iZW5kUG9pbnRzLmZvckVhY2goKGJwLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aCArPSBgTCR7YnAueH0gJHticC55fSBgO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBwYXRoICs9IGBMJHtkLnRhcmdldFBvaW50Lnh9ICR7ZC50YXJnZXRQb2ludC55fSBgO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gYXBwbHkgbm9kZSBwb3NpdGlvbnNcclxuICAgICAgICAgICAgbm9kZS50cmFuc2l0aW9uKClcclxuICAgICAgICAgICAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCBkID0+IGB0cmFuc2xhdGUoJHtkLnh9ICR7ZC55fSlgKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFwcGx5IHBvcnQgcG9zaXRpb25zXHJcbiAgICAgICAgICAgIHBvcnQudHJhbnNpdGlvbigpXHJcbiAgICAgICAgICAgICAgICAuYXR0cigneCcsIGQgPT4gZC54KVxyXG4gICAgICAgICAgICAgICAgLmF0dHIoJ3knLCBkID0+IGQueSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxheW91dGVyLnN0YXJ0KCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnNob3dEaWZmRXhhbXBsZSA9ICgpID0+IHtcclxuICAgICAgICBhZGRFbChxdWVyeUVsKCdib2R5JyksIHF1ZXJ5RWwoJy5zaG93LWRpZmYtZGlhbG9nJykpO1xyXG4gICAgICAgICQocXVlcnlFbCgnLnNob3ctZGlmZi1kaWFsb2cnKSkubW9kYWwoJ3Nob3cnKTtcclxuICAgICAgICBcclxuICAgICAgICBEQk1TLmdldExvZygwLCB7XHJcbiAgICAgICAgICAgIGFjdGlvbjpcInNldE1ldGFJbmZvXCIsXHJcbiAgICAgICAgICAgIGRhdGU6XCJcIixcclxuICAgICAgICAgICAgcGFyYW1zOlwiXCIsXHJcbiAgICAgICAgICAgIHN0YXR1czpcIk9LXCIsXHJcbiAgICAgICAgICAgIHVzZXI6XCJcIlxyXG4gICAgICAgIH0sIChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc3QgZWwgPSBjbGVhckVsKHF1ZXJ5RWwoJy5zaG93LWRpZmYtZGlhbG9nIC5jb250YWluZXItZmx1aWQnKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhZGRFbHMoZWwsIFIuYXBlcnR1cmUoMiwgZGF0YS5yZXF1ZXN0ZWRMb2cpLm1hcChwYWlyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJvdyA9IHFtdGUoJy5kaWZmLXJvdy10bXBsJyk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLmZpcnN0IC51c2VyJyksIG1ha2VUZXh0KHBhaXJbMF1bMV0pKTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcuZmlyc3QgLnRpbWUnKSwgbWFrZVRleHQobmV3IERhdGUocGFpclswXVsyXSkuZm9ybWF0KCd5eXl5L21tL2RkIGg6TU0nKSkpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlyc3RUZXh0ID0gSlNPTi5wYXJzZShwYWlyWzBdWzRdKVsxXTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcuZmlyc3QgLnRleHQnKSwgbWFrZVRleHQoZmlyc3RUZXh0KSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcubGFzdCAudXNlcicpLCBtYWtlVGV4dChwYWlyWzFdWzFdKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLmxhc3QgLnRpbWUnKSwgbWFrZVRleHQobmV3IERhdGUocGFpclsxXVsyXSkuZm9ybWF0KCd5eXl5L21tL2RkIGg6TU0nKSkpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFzdFRleHQgPSBKU09OLnBhcnNlKHBhaXJbMV1bNF0pWzFdO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5sYXN0IC50ZXh0JyksIG1ha2VUZXh0KGxhc3RUZXh0KSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vLy8gICAgICAgIGNvbnN0IGRpZmYgPSBKc0RpZmYuZGlmZkNoYXJzKHByZXZEYXRhWzRdIHx8ICcnLCByb3dEYXRhWzRdKTtcclxuICAgICAgICAgICAgICAgIC8vLy8gICAgICAgIGNvbnN0IGRpZmYgPSBKc0RpZmYuZGlmZldvcmRzKHByZXZEYXRhWzRdIHx8ICcnLCByb3dEYXRhWzRdKTtcclxuLy8gICAgICAgICAgICAgICAgY29uc3QgZGlmZiA9IEpzRGlmZi5kaWZmV29yZHNXaXRoU3BhY2UoZmlyc3RUZXh0LCBsYXN0VGV4dCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gSnNEaWZmLmRpZmZXb3Jkc1dpdGhTcGFjZShsYXN0VGV4dCwgZmlyc3RUZXh0KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVscyA9IGRpZmYubWFwKCBwYXJ0ID0+XHJcbiAgICAgICAgICAgICAgICAgICAgW3BhcnQudmFsdWUsIChwYXJ0LmFkZGVkID8gJ2FkZGVkJyA6IChwYXJ0LnJlbW92ZWQgPyAncmVtb3ZlZCcgOiAnc2FtZScpKV0pLm1hcChwYWlyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWRkQ2xhc3NlcyhhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQocGFpclswXSkpLCBbJ2xvZy1kaWZmJywgcGFpclsxXV0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHMocWVlKHJvdywgJy5kaWZmIC50ZXh0JyksIGVscyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHJldHVybiByb3c7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9KVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgY29uc3QgZ2V0QWxsU3Vic2V0cyA9IHRoZUFycmF5ID0+IHRoZUFycmF5LnJlZHVjZSgoc3Vic2V0cywgdmFsdWUpID0+IFxyXG4gICAgICAgIHN1YnNldHMuY29uY2F0KHN1YnNldHMubWFwKHNldCA9PiBbdmFsdWUsLi4uc2V0XSkpLFtbXV0pO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmFkZEdyb3VwVGVzdGluZ0RhdGEgPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlSXRlbSgnY2hhcmFjdGVyJywgJ3RleHQnLCAndGV4dCcsIDAsICgpID0+ICcnKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZVByb2ZpbGVJdGVtKCdjaGFyYWN0ZXInLCAnc3RyaW5nJywgJ3N0cmluZycsIDAsICgpID0+ICcnKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZVByb2ZpbGVJdGVtKCdjaGFyYWN0ZXInLCAnY2hlY2tib3gnLCAnY2hlY2tib3gnLCAwLCAoKSA9PiAnJyk7XHJcbiAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlSXRlbSgnY2hhcmFjdGVyJywgJ251bWJlcicsICdudW1iZXInLCAwLCAoKSA9PiAnJyk7XHJcbiAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlSXRlbSgnY2hhcmFjdGVyJywgJ2VudW0nLCAnZW51bScsIDAsICgpID0+ICcnKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZVByb2ZpbGVJdGVtKCdjaGFyYWN0ZXInLCAnbXVsdGlFbnVtJywgJ211bHRpRW51bScsIDAsICgpID0+ICcnKTtcclxuICAgICAgICBcclxuICAgICAgICBEQk1TLnVwZGF0ZURlZmF1bHRWYWx1ZShcImNoYXJhY3RlclwiLFwiZW51bVwiLFwiMSwyLDNcIiwgKCkgPT4gJycpO1xyXG4gICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKFwiY2hhcmFjdGVyXCIsXCJtdWx0aUVudW1cIixcIjEsMiwzLDRcIiwgKCkgPT4gJycpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1ha2VDaGFyID0gKG5hbWUsIHByb2ZpbGVJdGVtLCB2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmNyZWF0ZVByb2ZpbGUoXCJjaGFyYWN0ZXJcIiwgbmFtZSwgKCkgPT4gJycpO1xyXG4gICAgICAgICAgICBEQk1TLnVwZGF0ZVByb2ZpbGVGaWVsZChcImNoYXJhY3RlclwiLCBuYW1lLCBwcm9maWxlSXRlbSwgcHJvZmlsZUl0ZW0sIHZhbHVlLCAoKSA9PiAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IG1ha2VHcm91cCA9IChuYW1lLCBwcm9maWxlSXRlbSwgb2JqKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlR3JvdXAobmFtZSwgKCkgPT4gJycpO1xyXG4gICAgICAgICAgICBEQk1TLnNhdmVGaWx0ZXJUb0dyb3VwKG5hbWUsIFtSLm1lcmdlKG9iaiwge1widHlwZVwiOnByb2ZpbGVJdGVtLFwibmFtZVwiOlwicHJvZmlsZS1cIiArIHByb2ZpbGVJdGVtfSldLCAoKSA9PiAnJyk7XHJcbiAgICAgICAgfVxyXG4vLyAgICAgICAgXHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIGNvbnN0IGVudW1WYWx1ZXMgPSBbMSwyLDNdO1xyXG4vLyAgICAgICAgZW51bVZhbHVlcy5tYXAodmFsdWUgPT4gbWFrZUNoYXIoJ2NoYXIgZW51bSAnICsgdmFsdWUsICdlbnVtJywgU3RyaW5nKHZhbHVlKSkpO1xyXG4vLyAgICAgICAgZ2V0QWxsU3Vic2V0cyhlbnVtVmFsdWVzKS5tYXAoIGFyciA9PiB7XHJcbi8vICAgICAgICAgICAgY29uc3Qgb2JqID0gYXJyLnJlZHVjZSggKGFjYywgdmFsKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgIGFjY1tTdHJpbmcodmFsKV0gPSB0cnVlO1xyXG4vLyAgICAgICAgICAgICAgICByZXR1cm4gYWNjO1xyXG4vLyAgICAgICAgICAgIH0sIHt9KTtcclxuLy8gICAgICAgICAgICBtYWtlR3JvdXAoJ2dyb3VwIGVudW0gJyArIGFyci5qb2luKCcsJyksICdlbnVtJywge3NlbGVjdGVkT3B0aW9uczogb2JqfSk7XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgY29uc3QgbXVsdGlFbnVtQ29uZGl0aW9ucyA9IFsnZXZlcnknLCdlcXVhbCcsJ3NvbWUnXTtcclxuICAgICAgICAvLyBidWcgaW4gY29uZGl0aW9uIGNvbWJpbmF0aW9uIFxyXG4vLyAgICAgICAgWydldmVyeSddXHJcbi8vICAgICAgICBbJ2V2ZXJ5JywnZXF1YWwnXVxyXG4vLyAgICAgICAgWydldmVyeScsJ3NvbWUnXSAuLi5cclxuICAgICAgICBjb25zdCBtdWx0aUVudW1WYWx1ZXMgPSBbMSwyLDNdO1xyXG4gICAgICAgIGNvbnN0IG11bHRpRW51bVZhbHVlczIgPSBbMSwyLDMsNF07XHJcbiAgICAgICAgY29uc3QgbXVsdGlFbnVtQ29uZGl0aW9ucyA9IFsnZXZlcnknLCdlcXVhbCddO1xyXG4gICAgICAgIGdldEFsbFN1YnNldHMobXVsdGlFbnVtVmFsdWVzMikubWFwKHZhbHVlID0+IG1ha2VDaGFyKCdjaGFyIG11bHRpRW51bSAnICsgdmFsdWUuam9pbignLCcpLCAnbXVsdGlFbnVtJywgU3RyaW5nKHZhbHVlLmpvaW4oJywnKSkpKTtcclxuICAgICAgICBtdWx0aUVudW1Db25kaXRpb25zLm1hcChjb25kaXRpb24gPT4ge1xyXG4gICAgICAgICAgICBnZXRBbGxTdWJzZXRzKG11bHRpRW51bVZhbHVlcykubWFwKCBhcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gYXJyLnJlZHVjZSggKGFjYywgdmFsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWNjW1N0cmluZyh2YWwpXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICAgICAgICAgIH0sIHt9KTtcclxuICAgICAgICAgICAgICAgIG1ha2VHcm91cCgnZ3JvdXAgbXVsdGlFbnVtICcgKyBjb25kaXRpb24gKyAnICcgKyBhcnIuam9pbignLCcpLCAnbXVsdGlFbnVtJywge3NlbGVjdGVkT3B0aW9uczogb2JqLCBjb25kaXRpb259KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgY29uc3QgbnVtYmVycyA9IFswLDEsMiwzLDRdO1xyXG4vLyAgICAgICAgY29uc3Qgc3ViTnVtYmVycyA9IFsxLDIsM107XHJcbi8vICAgICAgICBjb25zdCBudW1iZXJDb25kaXRpb25zID0gWydncmVhdGVyJywnZXF1YWwnLCdsZXNzZXInXTtcclxuLy8gICAgICAgIG51bWJlcnMubWFwKHZhbHVlID0+IG1ha2VDaGFyKCdjaGFyIG51bWJlciAnICsgdmFsdWUsICdudW1iZXInLCAodmFsdWUpKSk7XHJcbi8vICAgICAgICBudW1iZXJDb25kaXRpb25zLm1hcChjb25kaXRpb24gPT4ge1xyXG4vLyAgICAgICAgICAgIHN1Yk51bWJlcnMubWFwKCBudW0gPT4ge1xyXG4vLyAgICAgICAgICAgICAgICBtYWtlR3JvdXAoJ2dyb3VwIG51bWJlciAnICsgY29uZGl0aW9uICsgJyAnICsgbnVtLCAnbnVtYmVyJywge251bSwgY29uZGl0aW9ufSk7XHJcbi8vICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgY29uc3QgY2hlY2tib3hlcyA9IFt0cnVlLCBmYWxzZV07XHJcbi8vICAgICAgICBjaGVja2JveGVzLm1hcCh2YWx1ZSA9PiBtYWtlQ2hhcignY2hhciBjaGVja2JveCAnICsgdmFsdWUsICdjaGVja2JveCcsIHZhbHVlKSk7XHJcbi8vICAgICAgICBnZXRBbGxTdWJzZXRzKGNoZWNrYm94ZXMpLm1hcCggYXJyID0+IHtcclxuLy8gICAgICAgICAgICBjb25zdCBvYmogPSBhcnIucmVkdWNlKCAoYWNjLCB2YWwpID0+IHtcclxuLy8gICAgICAgICAgICAgICAgYWNjW1N0cmluZyh2YWwpXSA9IHRydWU7XHJcbi8vICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XHJcbi8vICAgICAgICAgICAgfSwge30pO1xyXG4vLyAgICAgICAgICAgIG1ha2VHcm91cCgnZ3JvdXAgY2hlY2tib3ggJyArIGFyci5qb2luKCcsJyksICdjaGVja2JveCcsIHtzZWxlY3RlZE9wdGlvbnM6IG9ian0pO1xyXG4vLyAgICAgICAgfSk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIGNvbnN0IGNoYXJzID0gWydhJywnYicsJ2MnLCdkJ107XHJcbi8vICAgICAgICBjb25zdCBzdWJDaGFycyA9IFsnYScsJ2InLCdjJ107XHJcbi8vICAgICAgICBnZXRBbGxTdWJzZXRzKGNoYXJzKS5tYXAodmFsdWUgPT4gbWFrZUNoYXIoJ2NoYXIgc3RyaW5nICcgKyB2YWx1ZS5qb2luKCcnKSwgJ3N0cmluZycsIFN0cmluZyh2YWx1ZS5qb2luKCcnKSkpKTtcclxuLy8gICAgICAgIGdldEFsbFN1YnNldHMoY2hhcnMpLm1hcCh2YWx1ZSA9PiBtYWtlQ2hhcignY2hhciB0ZXh0ICcgKyB2YWx1ZS5qb2luKCcnKSwgJ3RleHQnLCBTdHJpbmcodmFsdWUuam9pbignJykpKSk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIGdldEFsbFN1YnNldHMoc3ViQ2hhcnMpLm1hcCggYXJyID0+IHtcclxuLy8gICAgICAgICAgICBtYWtlR3JvdXAoJ2dyb3VwIHN0cmluZyAnICsgYXJyLmpvaW4oJycpLCAnc3RyaW5nJywge3JlZ2V4U3RyaW5nOiBhcnIuam9pbignJyl9KTtcclxuLy8gICAgICAgIH0pO1xyXG4vLyAgICAgICAgZ2V0QWxsU3Vic2V0cyhzdWJDaGFycykubWFwKCBhcnIgPT4ge1xyXG4vLyAgICAgICAgICAgIG1ha2VHcm91cCgnZ3JvdXAgdGV4dCAnICsgYXJyLmpvaW4oJycpLCAndGV4dCcsIHtyZWdleFN0cmluZzogYXJyLmpvaW4oJycpfSk7XHJcbi8vICAgICAgICB9KTtcclxuICAgIH1cclxufSkodGhpcy5UZXN0VXRpbHMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIG5vLXZhcix2YXJzLW9uLXRvcCAqL1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLmNyZWF0ZU1vZGFsRGlhbG9nID0gKHJvb3QsIG9uQWN0aW9uLCBvcHRzKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29tbW9ucyA9ICcuZGlhbG9nLWNvbW1vbnMgJztcclxuICAgICAgICBjb25zdCBlbDIgPSB3cmFwRWwoJ2RpdicsIHF0ZShgJHtjb21tb25zfSAucmVxdWVzdC1kYXRhLWRpYWxvZy10bXBsYCkpO1xyXG4gICAgICAgIGNvbnN0IGVsID0gcWVlKGVsMiwgJy5tb2RhbCcpO1xyXG4gICAgICAgIGlmIChvcHRzLmRpYWxvZ0NsYXNzICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoZWwsIG9wdHMuZGlhbG9nQ2xhc3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBib2R5ID0gcWVlKGVsLCAnLm1vZGFsLWJvZHknKTtcclxuICAgICAgICBhZGRFbChib2R5LCBxdGUoYCR7Y29tbW9uc30gLiR7b3B0cy5ib2R5U2VsZWN0b3J9YCkpO1xyXG4gICAgICAgIGlmIChvcHRzLmJvZHkgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBSLnRvUGFpcnMob3B0cy5ib2R5KS5tYXAocGFpciA9PiBzZXRBdHRyKHFlZShib2R5LCBwYWlyWzBdKSwgJ2wxMG4taWQnLCBwYWlyWzFdKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRzLmluaXRCb2R5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgb3B0cy5pbml0Qm9keShib2R5KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYWRkRWwoYm9keSwgcXRlKGAke2NvbW1vbnN9IC5tb2RhbC1lcnJvci1ibG9ja2ApKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5tb2RhbC10aXRsZScpLCAnbDEwbi1pZCcsIG9wdHMuZGlhbG9nVGl0bGUpO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLm9uLWFjdGlvbi1idXR0b24nKSwgJ2wxMG4taWQnLCBvcHRzLmFjdGlvbkJ1dHRvblRpdGxlKTtcclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGVsKTtcclxuICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLm9uLWFjdGlvbi1idXR0b24nKSwgJ2NsaWNrJywgb25BY3Rpb24oZWwpKTtcclxuICAgICAgICBlbC5zaG93RGxnID0gKCkgPT4ge1xyXG4gICAgICAgICAgICBjbGVhckVycm9yKGVsKTtcclxuICAgICAgICAgICAgJChlbCkubW9kYWwoJ3Nob3cnKTtcclxuICAgICAgICAgICAgY29uc3QgZm9jdXNhYmxlID0gcWVlKGJvZHksICcuZm9jdXNhYmxlJyk7XHJcbiAgICAgICAgICAgIGlmKGZvY3VzYWJsZSAhPT0gbnVsbCl7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGZvY3VzYWJsZS5mb2N1cygpLCA1MDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBvbmVudGVyYWJsZSA9IHFlZXMoYm9keSwgJy5vbmVudGVyYWJsZScpO1xyXG4gICAgICAgIGlmKG9uZW50ZXJhYmxlLmxlbmd0aCAhPT0gMCl7XHJcbiAgICAgICAgICAgIG9uZW50ZXJhYmxlLmZvckVhY2gobGlzdGVuT25FbnRlcihSLl9fLCBvbkFjdGlvbihlbCkpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWwuaGlkZURsZyA9ICgpID0+ICQoZWwpLm1vZGFsKCdoaWRlJyk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5vbi1jYW5jZWwtYnV0dG9uJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgZWwuaGlkZURsZygpXHJcbiAgICAgICAgICAgIGlmKG9wdHMub25DYW5jZWwpIG9wdHMub25DYW5jZWwoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLm9uLWNsb3NlLWJ1dHRvbicpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGVsLmhpZGVEbGcoKVxyXG4gICAgICAgICAgICBpZihvcHRzLm9uQ2FuY2VsKSBvcHRzLm9uQ2FuY2VsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYWRkRWwocWUocm9vdCksIGVsKTtcclxuICAgICAgICByZXR1cm4gZWw7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdFRhYlBhbmVsID0gKHRhYkNsYXp6LCBjb250YWluZXJDbGF6eikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSBnZXRFbHMoY29udGFpbmVyQ2xhenopO1xyXG5cclxuICAgICAgICBsZXQgaTtcclxuICAgICAgICBmb3IgKGkgPSAxOyBpIDwgY29udGFpbmVycy5sZW5ndGg7IGkrKykgeyAvLyBkb24ndCBoaWRlIDFzdCBlbGVtZW50XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnNbaV0sICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRhYkJ1dHRvbnMgPSBnZXRFbHModGFiQ2xhenopO1xyXG5cclxuICAgICAgICBhZGRDbGFzcyh0YWJCdXR0b25zWzBdLCAnYWN0aXZlJyk7XHJcblxyXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCB0YWJCdXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGxpc3Rlbih0YWJCdXR0b25zW2ldLCAnY2xpY2snLCB0YWJCdXR0b25DbGljayh0YWJCdXR0b25zLCBjb250YWluZXJzKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgdGFiQnV0dG9uQ2xpY2sgPSAoYnV0dG9ucywgY29udGFpbmVycykgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oYnV0dG9uc1tpXSwgJ2FjdGl2ZScsIGV2ZW50LnRhcmdldC5pZCA9PT0gYnV0dG9uc1tpXS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29udGFpbmVycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBoaWRlRWwoY29udGFpbmVyc1tpXSwgYCR7ZXZlbnQudGFyZ2V0LmlkfUNvbnRhaW5lcmAgIT09IGNvbnRhaW5lcnNbaV0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5maWxsU2hvd0l0ZW1TZWxlY3RvciA9IChzZWxlY3RvciwgZGlzcGxheUFycmF5KSA9PiB7XHJcbiAgICAgICAgbGV0IGVsO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgZGlzcGxheUFycmF5Lmxlbmd0aCk7XHJcbiAgICAgICAgZGlzcGxheUFycmF5LmZvckVhY2goKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIGVsID0gc2V0UHJvcHMobWFrZUVsKCdvcHRpb24nKSwge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBoaWRlRWwoZWwsIHZhbHVlLmhpZGRlbik7XHJcbiAgICAgICAgICAgIGFkZEVsKHNlbGVjdG9yLCBhZGRFbChlbCwgbWFrZVRleHQodmFsdWUubmFtZSkpKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5maWxsU2hvd0l0ZW1TZWxlY3RvcjIgPSAoc2VsZWN0b3IsIG9wdGlvbkdyb3Vwcywgc2V0U2l6ZSkgPT4ge1xyXG4gICAgICAgIGxldCBlbCwgZ3JvdXBFbCwgY291bnRlciA9IDA7XHJcbiAgICAgICAgYWRkRWxzKHNlbGVjdG9yLCBvcHRpb25Hcm91cHMubWFwKChncm91cCkgPT4ge1xyXG4gICAgICAgICAgICBjb3VudGVyKys7XHJcbiAgICAgICAgICAgIGdyb3VwRWwgPSBzZXRBdHRyKG1ha2VFbCgnb3B0Z3JvdXAnKSwgJ2xhYmVsJywgZ3JvdXAuZGlzcGxheU5hbWUpO1xyXG4gICAgICAgICAgICBhZGRFbHMoZ3JvdXBFbCwgZ3JvdXAuYXJyYXkubWFwKChvcHRpb24pID0+IHtcclxuICAgICAgICAgICAgICAgIGVsID0gc2V0UHJvcHMobWFrZUVsKCdvcHRpb24nKSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGVsLCAndmFsdWUnLCBvcHRpb24ubmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb3VudGVyKys7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWRkRWwoZWwsIG1ha2VUZXh0KG9wdGlvbi5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIHJldHVybiBncm91cEVsO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBpZihzZXRTaXplKSB7XHJcbiAgICAgICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgY291bnRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbi8vICAgIGV4cG9ydHMuc2hvd1NlbGVjdGVkRWxzID0gY2xhc3NLZXkgPT4gKGV2ZW50KSA9PiB7XHJcbi8vICAgICAgICBjb25zdCB0MSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4vLyAgICAgICAgY29uc3QgZWwgPSBldmVudC50YXJnZXQ7XHJcbi8vICAgICAgICBsZXQgZWxzLCBpLCBqO1xyXG4vLyAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsLm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuLy8gICAgICAgICAgICBlbHMgPSBnZXRFbHMoY2xhc3NLZXkgKyBpKTtcclxuLy8gICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZWxzLmxlbmd0aDsgaisrKSB7XHJcbi8vICAgICAgICAgICAgICAgIGhpZGVFbChlbHNbal0sICFlbC5vcHRpb25zW2ldLnNlbGVjdGVkKTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9XHJcbi8vICAgICAgICBjb25zb2xlLmxvZygnc2hvd1NlbGVjdGVkRWxzIHRpbWUgJyArIChwZXJmb3JtYW5jZS5ub3coKSAtIHQxKSArICcgbXMnKTtcclxuLy8gICAgfTtcclxuLy8gICAgXHJcbi8vICAgIGV4cG9ydHMuc2hvd1NlbGVjdGVkRWxzMiA9IChyb290LCBjbGFzc0tleSkgPT4gKGV2ZW50KSA9PiB7XHJcbi8vICAgICAgICBjb25zdCB0MSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4vLyAgICAgICAgY29uc3QgZWwgPSBldmVudC50YXJnZXQ7XHJcbi8vICAgICAgICBsZXQgZWxzLCBpLCBqO1xyXG4vLyAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsLm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuLy8gICAgICAgICAgICBlbHMgPSBxdWVyeUVscyhyb290ICsgJyAuJyArIGNsYXNzS2V5ICsgaSk7XHJcbi8vICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGVscy5sZW5ndGg7IGorKykge1xyXG4vLyAgICAgICAgICAgICAgICBoaWRlRWwoZWxzW2pdLCAhZWwub3B0aW9uc1tpXS5zZWxlY3RlZCk7XHJcbi8vICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgfVxyXG4vLyAgICAgICAgY29uc29sZS5sb2coJ3Nob3dTZWxlY3RlZEVsczIgdGltZSAnICsgKHBlcmZvcm1hbmNlLm5vdygpIC0gdDEpICsgJyBtcycpO1xyXG4vLyAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnNob3dTZWxlY3RlZEVsczMgPSAocm9vdCwgY2xhc3NLZXksIGF0dHIpID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHQxID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcbiAgICAgICAgY29uc3QgZWwgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgbGV0IGksIGo7XHJcbiAgICAgICAgY29uc3QgbWFwID0ge307XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsLm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICAgICAgbWFwW2ldID0gZWwub3B0aW9uc1tpXS5zZWxlY3RlZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZWxzID0gcXVlcnlFbHMocm9vdCArICcgLicgKyBjbGFzc0tleSk7XHJcbiAgICAgICAgZWxzLmZvckVhY2goZWwyID0+IHtcclxuICAgICAgICAgICAgc2hvd0VsKGVsMiwgbWFwW2dldEF0dHIoZWwyLCBhdHRyKV0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdzaG93U2VsZWN0ZWRFbHMzIHRpbWUgJyArIChwZXJmb3JtYW5jZS5ub3coKSAtIHQxKSArICcgbXMnKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5pbml0U2VsZWN0b3JGaWx0ZXJzID0gKCkgPT4ge1xyXG4gICAgICAgIHF1ZXJ5RWxzKCdbc2VsZWN0b3ItZmlsdGVyXScpLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbCA9IHF1ZXJ5RWwoZ2V0QXR0cihlbCwgJ3NlbGVjdG9yLWZpbHRlcicpKTtcclxuICAgICAgICAgICAgZWwudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgc2V0QXR0cihlbCwgJ2wxMG4tcGxhY2Vob2xkZXItaWQnLCAnY29uc3RhbnQtZmlsdGVyJyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGVsLCAnZm9ybS1jb250cm9sIG1hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICBsaXN0ZW4oZWwsICdpbnB1dCcsIGZpbHRlck9wdGlvbnMoc2VsKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBmaWx0ZXJPcHRpb25zID0gc2VsID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGxldCB2YWwgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgbGV0IGksIG9wdDtcclxuLy8gICAgICAgIHZhbCA9IENvbW1vblV0aWxzLmdsb2JTdHJpbmdUb1JlZ2V4KHZhbC50cmltKCkudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgdmFsID0gdmFsLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgIG9wdCA9IHNlbC5vcHRpb25zW2ldO1xyXG4vLyAgICAgICAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IG9wdC5pbm5lckhUTUwudG9Mb3dlckNhc2UoKS5zZWFyY2godmFsKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IG9wdC5pbm5lckhUTUwudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbCkgIT09IC0xO1xyXG4gICAgICAgICAgICBpZiAoIWlzVmlzaWJsZSkge1xyXG4gICAgICAgICAgICAgICAgb3B0LnNlbGVjdGVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaGlkZUVsKG9wdCwgIWlzVmlzaWJsZSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ob3B0LCBcImhpZGRlblwiLCBvcHQuaW5uZXJIVE1MLnRvTG93ZXJDYXNlKCkuc2VhcmNoKHZhbCkgPT09IC0xKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2VsLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdjaGFuZ2UnKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdFBhbmVsVG9nZ2xlciA9IChlbCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGF0dHIgPSBnZXRBdHRyKGVsLCAncGFuZWwtdG9nZ2xlcicpO1xyXG4gICAgICAgIGFkZENsYXNzKGVsLCAnZXhwYW5kZWQnKTtcclxuICAgICAgICBjb25zdCBzZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGF0dHIpO1xyXG4gICAgICAgIGlmIChzZWwgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChgUGFuZWwgdG9nZ2xlciBpcyBicm9rZW46ICR7YXR0cn1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnY2xpY2snLCB0b2dnbGVQYW5lbChlbCwgc2VsKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdFBhbmVsVG9nZ2xlcnMgPSBlbCA9PiBxZWVzKGVsIHx8IGRvY3VtZW50LCAnW3BhbmVsLXRvZ2dsZXJdJykuZm9yRWFjaChleHBvcnRzLmluaXRQYW5lbFRvZ2dsZXIpO1xyXG5cclxuICAgIGV4cG9ydHMuYXR0YWNoUGFuZWxUb2dnbGVyID0gKGhlYWRlciwgY29udGVudCwgY2FsbGJhY2spID0+IHtcclxuICAgICAgICBhZGRDbGFzcyhoZWFkZXIsICdleHBhbmRlZCcpO1xyXG4gICAgICAgIGxpc3RlbihoZWFkZXIsICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGV2ZW50LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlUGFuZWwoaGVhZGVyLCBjb250ZW50KShldmVudCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRvZ2dsZVBhbmVsKGhlYWRlciwgY29udGVudCkoZXZlbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciB0b2dnbGVQYW5lbCA9IChlbCwgc2VsKSA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBpc0V4cGFuZGVkID0gaGFzQ2xhc3MoZWwsICdleHBhbmRlZCcpO1xyXG4gICAgICAgIHJlbW92ZUNsYXNzZXMoZWwsIFsnZXhwYW5kZWQnLCAnY29sbGFwc2VkJ10pO1xyXG4gICAgICAgIGFkZENsYXNzKGVsLCBpc0V4cGFuZGVkID8gJ2NvbGxhcHNlZCcgOiAnZXhwYW5kZWQnKTtcclxuICAgICAgICB0b2dnbGVDbGFzcyhzZWwsICdoaWRkZW4nKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlRXZlbnRUaW1lUGlja2VyID0gKG9wdHMpID0+IHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBSLmFwKFthZGRDbGFzcyhpbnB1dCldLCBvcHRzLmV4dHJhQ2xhc3Nlcyk7XHJcbiAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdldmVudFRpbWUnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG5cclxuICAgICAgICBpbnB1dC5ldmVudEluZGV4ID0gb3B0cy5pbmRleDtcclxuXHJcbiAgICAgICAgY29uc3QgcGlja2VyT3B0cyA9IHtcclxuICAgICAgICAgICAgbGFuZzogTDEwbi5nZXRMYW5nKCksXHJcbiAgICAgICAgICAgIG1hc2s6IHRydWUsXHJcbiAgICAgICAgICAgIHN0YXJ0RGF0ZTogbmV3IERhdGUob3B0cy5wcmVHYW1lRGF0ZSksXHJcbiAgICAgICAgICAgIGVuZERhdGU6IG5ldyBEYXRlKG9wdHMuZGF0ZSksXHJcbiAgICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWU6IG9wdHMub25DaGFuZ2VEYXRlVGltZUNyZWF0b3IoaW5wdXQpLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChvcHRzLmV2ZW50VGltZSAhPT0gJycpIHtcclxuICAgICAgICAgICAgcGlja2VyT3B0cy52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBpY2tlck9wdHMudmFsdWUgPSBvcHRzLmRhdGU7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnZGVmYXVsdERhdGUnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGpRdWVyeShpbnB1dCkuZGF0ZXRpbWVwaWNrZXIocGlja2VyT3B0cyk7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VFdmVudFRpbWVQaWNrZXIyID0gKGlucHV0LCBvcHRzKSA9PiB7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSBvcHRzLmV2ZW50VGltZTtcclxuXHJcbiAgICAgICAgaW5wdXQuZXZlbnRJbmRleCA9IG9wdHMuaW5kZXg7XHJcblxyXG4gICAgICAgIGNvbnN0IHBpY2tlck9wdHMgPSB7XHJcbiAgICAgICAgICAgIGxhbmc6IEwxMG4uZ2V0TGFuZygpLFxyXG4gICAgICAgICAgICBtYXNrOiB0cnVlLFxyXG4gICAgICAgICAgICBzdGFydERhdGU6IG5ldyBEYXRlKG9wdHMucHJlR2FtZURhdGUpLFxyXG4gICAgICAgICAgICBlbmREYXRlOiBuZXcgRGF0ZShvcHRzLmRhdGUpLFxyXG4gICAgICAgICAgICBvbkNoYW5nZURhdGVUaW1lOiBvcHRzLm9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yKGlucHV0KSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAob3B0cy5ldmVudFRpbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICAgIHBpY2tlck9wdHMudmFsdWUgPSBvcHRzLmV2ZW50VGltZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwaWNrZXJPcHRzLnZhbHVlID0gb3B0cy5kYXRlO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2RlZmF1bHREYXRlJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBqUXVlcnkoaW5wdXQpLmRhdGV0aW1lcGlja2VyKHBpY2tlck9wdHMpO1xyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH07XHJcblxyXG4gICAgLy8gYnVnIGFib3V0IHNldHRpbmcgMDkwMCB5ZWFycyBpbiBCcmFhdm9zIGdhbWUgaXMgZXZlbnQgZGF0ZS4gRml4ZWQgaW4gcHJvZHVjdGlvbi5cclxuICAgIC8vICBleHBvcnRzLm1ha2VFdmVudFRpbWVQaWNrZXIgPSBmdW5jdGlvbiAob3B0cykge1xyXG4gICAgLy8gICAgICB2YXIgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgIC8vICAgICAgUi5hcChbYWRkQ2xhc3MoaW5wdXQpXSwgb3B0cy5leHRyYUNsYXNzZXMpO1xyXG4gICAgLy8gICAgICBhZGRDbGFzcyhpbnB1dCwgXCJldmVudFRpbWVcIik7XHJcbiAgICAvLyAgICAgIGlucHV0LnZhbHVlID0gb3B0cy5ldmVudFRpbWU7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICBpbnB1dC5ldmVudEluZGV4ID0gb3B0cy5pbmRleDtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHZhciBwaWNrZXJPcHRzID0ge1xyXG4gICAgLy8gICAgICAgICAgbGFuZyA6IEwxMG4uZ2V0TGFuZygpLFxyXG4gICAgLy8gICAgICAgICAgbWFzayA6IHRydWUsXHJcbiAgICAvLyAgICAgICAgICBzdGFydERhdGUgOiBuZXcgRGF0ZShvcHRzLnByZUdhbWVEYXRlKSxcclxuICAgIC8vICAgICAgICAgIGVuZERhdGUgOiBuZXcgRGF0ZShvcHRzLmRhdGUpLFxyXG4gICAgLy8gICAgICAgICAgb25DaGFuZ2VEYXRlVGltZSA6IG9wdHMub25DaGFuZ2VEYXRlVGltZUNyZWF0b3IoaW5wdXQpLFxyXG4gICAgLy8gICAgICB9O1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgdmFyIHBpY2tlciA9IGpRdWVyeShpbnB1dCkuZGF0ZXRpbWVwaWNrZXIocGlja2VyT3B0cyk7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICB2YXIgdmFsdWU7XHJcbiAgICAvLyAgICAgIGlmIChvcHRzLmV2ZW50VGltZSAhPT0gXCJcIikge1xyXG4gICAgLy8gICAgICAgICAgdmFsdWUgPSBuZXcgRGF0ZShvcHRzLmV2ZW50VGltZSk7XHJcbiAgICAvLyAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICB2YWx1ZSA9IG9wdHMuZGF0ZTtcclxuICAgIC8vICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBcImRlZmF1bHREYXRlXCIpO1xyXG4gICAgLy8gICAgICB9XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICBwaWNrZXIudmFsdWUgPSB2YWx1ZTtcclxuICAgIC8vXHJcbiAgICAvL1xyXG4gICAgLy8gICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICAvLyAgfTtcclxuXHJcbiAgICBleHBvcnRzLmluaXRUZXh0QXJlYXMgPSAoc2VsKSA9PiB7XHJcbiAgICAgICAgUi5hcChbZXhwb3J0cy5hdHRhY2hUZXh0YXJlYVJlc2l6ZXJdLCBxdWVyeUVscyhzZWwpKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoVGV4dEFyZWFzID0gKHNlbCkgPT4ge1xyXG4gICAgICAgIFIuYXAoW2V4cG9ydHMucmVzaXplVGV4dGFyZWFdLCBxdWVyeUVscyhzZWwpLm1hcChlbCA9PiAoeyB0YXJnZXQ6IGVsIH0pKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuYXR0YWNoVGV4dGFyZWFSZXNpemVyID0gKGlucHV0KSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAna2V5ZG93bicsIGV4cG9ydHMucmVzaXplVGV4dGFyZWEpO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ3Bhc3RlJywgZXhwb3J0cy5yZXNpemVUZXh0YXJlYSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY3V0JywgZXhwb3J0cy5yZXNpemVUZXh0YXJlYSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgZXhwb3J0cy5yZXNpemVUZXh0YXJlYSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnZHJvcCcsIGV4cG9ydHMucmVzaXplVGV4dGFyZWEpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlc2l6ZVRleHRhcmVhID0gKGV2KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IGV2LnRhcmdldDtcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9ICcyNHB4JztcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9IGAke3RoYXQuc2Nyb2xsSGVpZ2h0ICsgMTJ9cHhgO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlc2l6ZVRleHRhcmVhMiA9ICh0aGF0KSA9PiB7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSAnMjRweCc7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSBgJHt0aGF0LnNjcm9sbEhlaWdodCArIDEyfXB4YDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5wb3B1bGF0ZUFkYXB0YXRpb25UaW1lSW5wdXQgPSAoaW5wdXQsIHN0b3J5TmFtZSwgZXZlbnQsIGNoYXJhY3Rlck5hbWUsIGlzRWRpdGFibGUpID0+IHtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCAnbm90RWRpdGFibGUnLCAhaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnRpbWU7XHJcbiAgICAgICAgaW5wdXQuZGF0YUtleSA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgb25DaGFuZ2VQZXJzb25hbFRpbWVEZWxlZ2F0ZSk7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgb25DaGFuZ2VQZXJzb25hbFRpbWVEZWxlZ2F0ZSA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5kYXRhS2V5KTtcclxuICAgICAgICBjb25zdCB0aW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgIERCTVMuc2V0RXZlbnRBZGFwdGF0aW9uUHJvcGVydHkoZGF0YUtleVswXSwgZGF0YUtleVsxXSwgZGF0YUtleVsyXSwgJ3RpbWUnLCB0aW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucG9wdWxhdGVSZWFkeUNoZWNrYm94ID0gKGRpdiwgaWQsIGNoZWNrZWQsIGlzRWRpdGFibGUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBxZWUoZGl2LCAnaW5wdXQnKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCAnbm90RWRpdGFibGUnLCAhaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgaW5wdXQuY2hlY2tlZCA9IGNoZWNrZWQ7XHJcbiAgICAgICAgaW5wdXQuaWQgPSBpZDtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCBjYWxsYmFjayk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZGl2LCAnbGFiZWwnKSwgJ2ZvcicsIGlucHV0LmlkKTtcclxuICAgICAgICByZXR1cm4gZGl2O1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9uQ2hhbmdlQWRhcHRhdGlvblJlYWR5U3RhdHVzMiA9IGNhbGxiYWNrID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5pZCk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSAhaGFzQ2xhc3MoZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICBEQk1TLnNldEV2ZW50QWRhcHRhdGlvblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sIGRhdGFLZXlbMl0sICdyZWFkeScsIHZhbHVlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oZXZlbnQudGFyZ2V0LCAnYnRuLXByaW1hcnknLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKHZhbHVlKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUGFuZWxDb3JlID0gKHRpdGxlLCBjb250ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGFuZWwgPSBhZGRDbGFzc2VzKG1ha2VFbCgnZGl2JyksIFsncGFuZWwnLCAncGFuZWwtZGVmYXVsdCddKTtcclxuICAgICAgICBjb25zdCBoMyA9IGFkZENsYXNzKGFkZEVsKG1ha2VFbCgnaDMnKSwgdGl0bGUpLCAncGFuZWwtdGl0bGUnKTtcclxuICAgICAgICBjb25zdCBhID0gc2V0QXR0cihtYWtlRWwoJ2EnKSwgJ2hyZWYnLCAnIy8nKTtcclxuICAgICAgICBzZXRBdHRyKGEsICdwYW5lbC10b2dnbGVyJywgJycpO1xyXG4gICAgICAgIGNvbnN0IGhlYWREaXYgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAncGFuZWwtaGVhZGluZycpO1xyXG4gICAgICAgIGFkZEVsKHBhbmVsLCBhZGRFbChoZWFkRGl2LCBhZGRFbChhLCBoMykpKTtcclxuICAgICAgICBjb25zdCBjb250ZW50RGl2ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3BhbmVsLWJvZHknKTtcclxuICAgICAgICBhZGRFbChwYW5lbCwgYWRkRWwoY29udGVudERpdiwgY29udGVudCkpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHBhbmVsLFxyXG4gICAgICAgICAgICBjb250ZW50RGl2LFxyXG4gICAgICAgICAgICBhXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUHJvZmlsZVRhYmxlID0gKHByb2ZpbGVTdHJ1Y3R1cmUsIHByb2ZpbGUpID0+IHtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBxbXRlKCcucHJvZmlsZS1lZGl0b3ItY29udGFpbmVyLXRtcGwnKTtcclxuICAgICAgICBhZGRDbGFzcyhjb250YWluZXIsICdwcm9maWxlLXRhYmxlJyk7XHJcbiAgICAgICAgbGV0IHZhbHVlO1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMoY29udGFpbmVyLCBwcm9maWxlU3RydWN0dXJlLmZpbHRlcihlbGVtZW50ID0+IGVsZW1lbnQuZG9FeHBvcnQpLm1hcCgoZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGVsZW1lbnQudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gYWRkQ2xhc3MobWFrZUVsKCdzcGFuJyksICdicmllZmluZ1RleHRTcGFuJyk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbCh2YWx1ZSwgbWFrZVRleHQocHJvZmlsZVtlbGVtZW50Lm5hbWVdKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IG1ha2VUZXh0KHByb2ZpbGVbZWxlbWVudC5uYW1lXSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBtYWtlVGV4dChjb25zdEwxMG4oQ29uc3RhbnRzW3Byb2ZpbGVbZWxlbWVudC5uYW1lXV0pKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtlbGVtZW50LnR5cGV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gcW10ZSgnLnByb2ZpbGUtZWRpdG9yLXJvdy10bXBsJyk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLW5hbWUnKSwgbWFrZVRleHQoZWxlbWVudC5uYW1lKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLWlucHV0JyksIHZhbHVlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJvdztcclxuICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZVRhYmxlUm93ID0gKGNvbDEsIGNvbDIpID0+IGFkZEVscyhtYWtlRWwoJ3RyJyksIFthZGRFbChtYWtlRWwoJ3RkJyksIGNvbDEpLCBhZGRFbChtYWtlRWwoJ3RkJyksIGNvbDIpXSk7XHJcblxyXG4gICAgZXhwb3J0cy5jaGVja0FuZEdldEVudGl0eVNldHRpbmcgPSAoc2V0dGluZ3NQYXRoLCBuYW1lcykgPT4ge1xyXG4gICAgICAgIGlmIChuYW1lcy5sZW5ndGggPT09IDApIHJldHVybiBudWxsO1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIGlmICghc2V0dGluZ3Nbc2V0dGluZ3NQYXRoXSkge1xyXG4gICAgICAgICAgICBzZXR0aW5nc1tzZXR0aW5nc1BhdGhdID0ge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogbmFtZXNbMF0udmFsdWVcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHsgbmFtZSB9ID0gc2V0dGluZ3Nbc2V0dGluZ3NQYXRoXTtcclxuICAgICAgICBjb25zdCByYXdOYW1lcyA9IG5hbWVzLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIGlmIChyYXdOYW1lcy5pbmRleE9mKG5hbWUpID09PSAtMSkge1xyXG4gICAgICAgICAgICBzZXR0aW5nc1tzZXR0aW5nc1BhdGhdLm5hbWUgPSBuYW1lc1swXS52YWx1ZTtcclxuICAgICAgICAgICAgbmFtZSA9IG5hbWVzWzBdLnZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmFtZTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy51cGRhdGVFbnRpdHlTZXR0aW5nID0gKHNldHRpbmdzUGF0aCwgbmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIGlmKHNldHRpbmdzW3NldHRpbmdzUGF0aF0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBzZXR0aW5nc1tzZXR0aW5nc1BhdGhdID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldHRpbmdzW3NldHRpbmdzUGF0aF0ubmFtZSA9IG5hbWU7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnNjcm9sbFRvID0gKGNvbnRhaW5lciwgZWxlbWVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRvbVJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IGNvbnRhaW5lci5zY3JvbGxUb3A7XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsQm90dG9tID0gY29udGFpbmVyLnNjcm9sbFRvcCArIGNvbnRhaW5lci5jbGllbnRIZWlnaHQ7XHJcbiAgICAgICAgY29uc3QgY29uZGl0aW9uID0gZWxlbWVudC5vZmZzZXRUb3AgPCBzY3JvbGxUb3AgfHwgKGVsZW1lbnQub2Zmc2V0VG9wICsgZG9tUmVjdC5oZWlnaHQpID4gc2Nyb2xsQm90dG9tO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKGNvbmRpdGlvbil7XHJcbiAgICAgICAgICAgIGNvbnN0IGZyb20gPSBjb250YWluZXIuc2Nyb2xsVG9wO1xyXG4gICAgICAgICAgICBjb25zdCB0byA9IGVsZW1lbnQub2Zmc2V0VG9wIC0gY29udGFpbmVyLmNsaWVudEhlaWdodC8yICsgZG9tUmVjdC5oZWlnaHQvMjtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFV0aWxzLmFuaW1hdGUoe1xyXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDUwMCxcclxuICAgICAgICAgICAgICAgIHRpbWluZzogVGltaW5nLm1ha2VFYXNlSW5PdXQoVGltaW5nLnBvbHkoNCkpLFxyXG4gICAgICAgICAgICAgICAgZHJhdzogZnVuY3Rpb24ocHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuc2Nyb2xsVG9wID0gZnJvbSArICh0byAtIGZyb20pICogcHJvZ3Jlc3M7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn0pKHRoaXMuVUkgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8vIFRPRE8gbmVlZCB0byBsaW50IHV0aWxzIHdpdGggTklNUyBmaXhlc1xyXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xyXG5cclxuY29uc3Qgc3RyRm9ybWF0ID0gUi5jdXJyeShDb21tb25VdGlscy5zdHJGb3JtYXQpO1xyXG5cclxuZnVuY3Rpb24gZ2V0TDEwbihrZXkpIHtcclxuICAgIHJldHVybiBMMTBuLmdldFZhbHVlKGtleSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnN0TDEwbihrZXkpIHtcclxuICAgIHJldHVybiBMMTBuLmdldFZhbHVlKGBjb25zdGFudC0ke2tleX1gKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNFbXB0eShvYmopIHtcclxuICAgIHJldHVybiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5sZW5ndGggPT09IDApO1xyXG59XHJcblxyXG5jb25zdCBhZGRDbGFzcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cChgKF58XFxcXHMpJHtjfShcXFxcc3wkKWAsICdnJyk7XHJcbiAgICBpZiAocmUudGVzdChvLmNsYXNzTmFtZSkpIHJldHVybiBvO1xyXG4gICAgby5jbGFzc05hbWUgPSAoYCR7by5jbGFzc05hbWV9ICR7Y31gKS5yZXBsYWNlKC9cXHMrL2csICcgJykucmVwbGFjZSgvKF4gfCAkKS9nLCAnJyk7XHJcbiAgICByZXR1cm4gbztcclxufSk7XHJcblxyXG5jb25zdCBhZGRDbGFzc2VzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgUi5hcChbYWRkQ2xhc3MobyldLCBjKTtcclxuICAgIHJldHVybiBvO1xyXG59KTtcclxuXHJcbmNvbnN0IGhhc0NsYXNzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAoXnxcXFxccykke2N9KFxcXFxzfCQpYCwgJ2cnKTtcclxuICAgIHJldHVybiAocmUudGVzdChvLmNsYXNzTmFtZSkpO1xyXG59KTtcclxuXHJcbmNvbnN0IHJlbW92ZUNsYXNzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAoXnxcXFxccykke2N9KFxcXFxzfCQpYCwgJ2cnKTtcclxuICAgIG8uY2xhc3NOYW1lID0gby5jbGFzc05hbWUucmVwbGFjZShyZSwgJyQxJykucmVwbGFjZSgvXFxzKy9nLCAnICcpLnJlcGxhY2UoLyheIHwgJCkvZywgJycpO1xyXG4gICAgcmV0dXJuIG87XHJcbn0pO1xyXG5cclxuY29uc3QgcmVtb3ZlQ2xhc3NlcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIFIuYXAoW3JlbW92ZUNsYXNzKG8pXSwgYyk7XHJcbiAgICByZXR1cm4gbztcclxufSk7XHJcblxyXG5jb25zdCB0b2dnbGVDbGFzcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIGlmIChoYXNDbGFzcyhvLCBjKSkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG8sIGMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBhZGRDbGFzcyhvLCBjKTtcclxuICAgIH1cclxufSk7XHJcblxyXG5jb25zdCBzZXRDbGFzc0J5Q29uZGl0aW9uID0gUi5jdXJyeSgobywgYywgY29uZGl0aW9uKSA9PiB7XHJcbiAgICBpZiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgYWRkQ2xhc3MobywgYyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG8sIGMpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG87XHJcbn0pO1xyXG5cclxuY29uc3Qgc2V0Q2xhc3NJZiA9IHNldENsYXNzQnlDb25kaXRpb247XHJcblxyXG5jb25zdCBzaG93RWwgPSAoZWwsIGNvbmRpdGlvbikgPT4gc2V0Q2xhc3NCeUNvbmRpdGlvbihlbCwgJ2hpZGRlbicsICFjb25kaXRpb24pO1xyXG5jb25zdCBoaWRlRWwgPSAoZWwsIGNvbmRpdGlvbikgPT4gc2V0Q2xhc3NCeUNvbmRpdGlvbihlbCwgJ2hpZGRlbicsIGNvbmRpdGlvbik7XHJcblxyXG5mdW5jdGlvbiBnZXRFbChpZCkge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcXVlcnlFbChzZWwpIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbCk7XHJcbn1cclxuXHJcbmNvbnN0IHFlID0gcXVlcnlFbDtcclxuXHJcbi8vIHF1ZXJ5IHRlbXBsYXRlIGVsZW1lbnRcclxuZnVuY3Rpb24gcXRlKHNlbCl7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWwpLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpO1xyXG59XHJcblxyXG4vLyBxdWVyeSBtYXRlcmlhbGl6ZSB0ZW1wbGF0ZSBlbGVtZW50XHJcbmZ1bmN0aW9uIHFtdGUoc2VsKXtcclxuICAgIHJldHVybiBhZGRFbChtYWtlRWwoJ2RpdicpLCBxdGUoc2VsKSkuZmlyc3RDaGlsZDtcclxufVxyXG5cclxuZnVuY3Rpb24gcXVlcnlFbHMoc2VsKSB7XHJcbiAgICByZXR1cm4gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWwpKTtcclxufVxyXG5cclxuY29uc3QgcWVzID0gcXVlcnlFbHM7XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVsRWwoZWwsIHNlbCkge1xyXG4gICAgcmV0dXJuIGVsLnF1ZXJ5U2VsZWN0b3Ioc2VsKTtcclxufVxyXG5cclxuY29uc3QgcWVlID0gUi5jdXJyeShxdWVyeUVsRWwpO1xyXG5cclxuZnVuY3Rpb24gcXVlcnlFbEVscyhlbCwgc2VsKSB7XHJcbiAgICByZXR1cm4gbmwyYXJyYXkoZWwucXVlcnlTZWxlY3RvckFsbChzZWwpKTtcclxufVxyXG5cclxuY29uc3QgcWVlcyA9IFIuY3VycnkocXVlcnlFbEVscyk7XHJcblxyXG5mdW5jdGlvbiBnZXRFbHMoY2xhenopIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXp6KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZUVsKGVsVGFnKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbFRhZyk7XHJcbn1cclxuXHJcbmNvbnN0IHdyYXBFbCA9IFIuY3VycnkoKGVsVGFnLCBlbCkgPT4ge1xyXG4gICAgcmV0dXJuIGFkZEVsKG1ha2VFbChlbFRhZyksIGVsKTtcclxufSlcclxuXHJcbmNvbnN0IHdyYXBFbHMgPSBSLmN1cnJ5KChlbFRhZywgZWxzKSA9PiB7XHJcbiAgICByZXR1cm4gYWRkRWxzKG1ha2VFbChlbFRhZyksIGVscyk7XHJcbn0pXHJcblxyXG5mdW5jdGlvbiBtYWtlVGV4dCh0ZXh0KSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7XHJcbn1cclxuXHJcbmNvbnN0IGFkZEVsID0gUi5jdXJyeSgocGFyZW50LCBjaGlsZCkgPT4ge1xyXG4gICAgcGFyZW50LmFwcGVuZENoaWxkKGNoaWxkKTtcclxuICAgIHJldHVybiBwYXJlbnQ7XHJcbn0pO1xyXG5jb25zdCBhZGRFbHMgPSBSLmN1cnJ5KChwYXJlbnQsIGNoaWxkcmVuKSA9PiB7XHJcbiAgICBSLmFwKFthZGRFbChwYXJlbnQpXSwgY2hpbGRyZW4pO1xyXG4gICAgcmV0dXJuIHBhcmVudDtcclxufSk7XHJcblxyXG5jb25zdCBtYWtlT3B0ID0gZnVuY3Rpb24gKGxhYmVsKSB7XHJcbiAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgYWRkRWwob3B0aW9uLCAobWFrZVRleHQobGFiZWwpKSk7XHJcbiAgICByZXR1cm4gb3B0aW9uO1xyXG59O1xyXG5cclxuY29uc3Qgc2V0QXR0ciA9IFIuY3VycnkoKGVsLCBuYW1lLCB2YWx1ZSkgPT4ge1xyXG4gICAgZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBzZXRTdHlsZSA9IFIuY3VycnkoKGVsLCBuYW1lLCB2YWx1ZSkgPT4ge1xyXG4gICAgZWwuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldEltcG9ydGFudFN0eWxlID0gUi5jdXJyeSgoZWwsIG5hbWUsIHZhbHVlKSA9PiB7XHJcbiAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSwgJ2ltcG9ydGFudCcpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGRlbEF0dHIoZWwsIG5hbWUpIHtcclxuICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTtcclxuICAgIHJldHVybiBlbDtcclxufVxyXG5cclxuY29uc3QgZ2V0QXR0ciA9IFIuY3VycnkoKGVsLCBuYW1lKSA9PiB7XHJcbiAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKG5hbWUpO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldFByb3AgPSBSLmN1cnJ5KChlbCwga2V5LCB2YWx1ZSkgPT4ge1xyXG4gICAgZWxba2V5XSA9IHZhbHVlO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldFByb3BzID0gUi5jdXJyeSgoZWwsIG1hcCkgPT4ge1xyXG4gICAgZm9yIChjb25zdCBrZXkgaW4gbWFwKSB7XHJcbiAgICAgICAgc2V0UHJvcChlbCwga2V5LCBtYXBba2V5XSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gY2xlYXJFbChlbCkge1xyXG4gICAgVXRpbHMucmVtb3ZlQ2hpbGRyZW4oZWwpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjbGVhckVscyhlbHMpe1xyXG4gICAgcmV0dXJuIGVscy5tYXAoY2xlYXJFbClcclxufVxyXG5cclxuZnVuY3Rpb24gcGFzc0VscyhzcmMsIGRzdCkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcmMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBhZGRFbChkc3QsIHNyYy5jaGlsZHJlbltpXSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IGxpc3RlbiA9IFIuY3VycnkoKGVsLCBldmVudCwgbGlzdGVuZXIpID0+IHtcclxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBsaXN0ZW5PbkVudGVyID0gUi5jdXJyeSgoZWwsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBsaXN0ZW4oZWwsICdrZXlkb3duJywgKGUpID0+IHtcclxuICAgICAgICBpZiAoZS5rZXlDb2RlID09PSAxMykge1xyXG4gICAgICAgICAgICBpZihlLmlBbU5vdEFsb25lKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09oIGRlYXIhJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZS5pQW1Ob3RBbG9uZSA9IHRydWU7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59KTtcclxuXHJcbmNvbnN0IGZpbGxTZWxlY3RvciA9IFIuY3VycnkoKHNlbCwgZGF0YSkgPT4gYWRkRWxzKHNlbCwgZGF0YS5tYXAoKGl0ZW0pID0+IHtcclxuICAgIGNvbnN0IG9wdCA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICBhZGRFbChvcHQsIG1ha2VUZXh0KGl0ZW0ubmFtZSkpO1xyXG4gICAgaWYgKGl0ZW0udmFsdWUgIT09IHVuZGVmaW5lZCkgeyBvcHQudmFsdWUgPSBpdGVtLnZhbHVlOyB9XHJcbiAgICBpZiAoaXRlbS5zZWxlY3RlZCAhPT0gdW5kZWZpbmVkKSB7IG9wdC5zZWxlY3RlZCA9IHRydWU7IH1cclxuICAgIGlmIChpdGVtLmNsYXNzTmFtZSAhPT0gdW5kZWZpbmVkKSB7IGFkZENsYXNzKG9wdCwgaXRlbS5jbGFzc05hbWUpOyB9XHJcbiAgICByZXR1cm4gb3B0O1xyXG59KSkpO1xyXG5cclxuZnVuY3Rpb24gbmwyYXJyYXkobm9kZUxpc3QpIHtcclxuICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChub2RlTGlzdCk7XHJcbn1cclxuXHJcbmNvbnN0IHJlbWFwUHJvcHMgPSBSLmN1cnJ5KChvdXRLZXlzLCBwaWNrS2V5cywgb2JqKSA9PiBSLmNvbXBvc2UoUi56aXBPYmoob3V0S2V5cyksIFIudmFsdWVzLCBSLnBpY2socGlja0tleXMpKShvYmopKTtcclxuXHJcbmNvbnN0IHJlbWFwUHJvcHM0U2VsZWN0MiA9IHJlbWFwUHJvcHMoWydpZCcsICd0ZXh0J10sIFsndmFsdWUnLCAnZGlzcGxheU5hbWUnXSk7XHJcbmNvbnN0IHJlbWFwUHJvcHM0U2VsZWN0ID0gcmVtYXBQcm9wcyhbJ3ZhbHVlJywgJ25hbWUnXSwgWyd2YWx1ZScsICdkaXNwbGF5TmFtZSddKTtcclxuXHJcbmNvbnN0IGdldFNlbGVjdDJEYXRhQ29tbW9uID0gUi5jdXJyeSgocHJlcGFyYXRvciwgb2JqKSA9PiBSLmNvbXBvc2UoUi56aXBPYmooWydkYXRhJ10pLCBSLmFwcGVuZChSLl9fLCBbXSksIFIubWFwKHByZXBhcmF0b3IpKShvYmopKTtcclxuXHJcbmNvbnN0IGdldFNlbGVjdDJEYXRhID0gZ2V0U2VsZWN0MkRhdGFDb21tb24ocmVtYXBQcm9wczRTZWxlY3QyKTtcclxuXHJcbmNvbnN0IG1ha2VTZWxlY3QyT3B0ID0gUi5jb21wb3NlKFIuemlwT2JqKFsnaWQnLCAndGV4dCddKSwgUi5yZXBlYXQoUi5fXywgMikpO1xyXG5jb25zdCBhcnIyU2VsZWN0MiA9IFIuY29tcG9zZShSLmFzc29jKCdkYXRhJywgUi5fXywge30pLCBSLm1hcChtYWtlU2VsZWN0Mk9wdCkpO1xyXG5jb25zdCBhcnIyU2VsZWN0ID0gUi5tYXAoUi5jb21wb3NlKFIuemlwT2JqKFsndmFsdWUnLCAnbmFtZSddKSwgUi5yZXBlYXQoUi5fXywgMikpKTtcclxuY29uc3QgY29uc3RBcnIyU2VsZWN0ID0gUi5tYXAoUi5jb21wb3NlKFIuemlwT2JqKFsndmFsdWUnLCAnbmFtZSddKSwgbmFtZSA9PiBbbmFtZSwgY29uc3RMMTBuKG5hbWUpXSkpO1xyXG5cclxuY29uc3QgZ2V0U2VsZWN0ZWRSYWRpbyA9IGZ1bmN0aW9uIChlbCwgcXVlcnkpIHtcclxuICAgIHJldHVybiBxdWVyeUVsRWxzKGVsLCBxdWVyeSkuZmluZChSLnByb3AoJ2NoZWNrZWQnKSk7XHJcbn07XHJcblxyXG5jb25zdCBkZWJ1Z0ludGVyY2VwdG9yID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50c1swXSkpO1xyXG4gICAgICAgIGNhbGxiYWNrKC4uLmFyZ3VtZW50cyk7XHJcbiAgICB9O1xyXG59O1xyXG5cclxuY29uc3QgVXRpbHMgPSB7fTtcclxuXHJcbi8qKiBvcHRzXHJcbiAgICB0b29sdGlwIC0gYWRkIHRvb2x0aXAgdG8gYnV0dG9uLCB1c2VkIGZvciBpY29uaWMgYnV0dG9uc1xyXG4gICAgaWQgLSBzZXQgYnV0dG9uIGlkXHJcbiAgICBtYWluUGFnZSAtIGVuYWJsZSB2aWV3IGFzIGZpcnN0IHBhZ2UgLSBkZXByZWNhdGVkLiBVc2UgVXRpbHMuc2V0Rmlyc3RUYWIgaW5zdGVhZFxyXG4gICAgdG9nZ2xlIC0gdG9nZ2xlIGNvbnRlbnQsIGFzc29jaWF0ZWQgd2l0aCBidXR0b25cclxuKi9cclxuVXRpbHMuYWRkVmlldyA9IGZ1bmN0aW9uIChjb250YWluZXJzLCBuYW1lLCB2aWV3LCBvcHRzMikge1xyXG4gICAgY29uc3Qgb3B0cyA9IG9wdHMyIHx8IHt9O1xyXG4gICAgdmlldy5pbml0KCk7XHJcbiAgICBjb25zdCBidXR0b25DbGFzcyA9ICduYXZpZ2F0aW9uLWJ1dHRvbic7XHJcbiAgICBjb250YWluZXJzLnJvb3Qudmlld3NbbmFtZV0gPSB2aWV3O1xyXG4gICAgY29uc3QgYnV0dG9uID0gbWFrZUVsKCdidXR0b24nKTtcclxuICAgIGZ1bmN0aW9uIGRlbGVnYXRlKCkge1xyXG4gICAgICAgICQoYnV0dG9uKS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJywgTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSk7XHJcbiAgICB9XHJcbiAgICBpZiAob3B0cy50b29sdGlwKSB7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZGVsZWdhdGUpO1xyXG4gICAgICAgICQoYnV0dG9uKS50b29sdGlwKHtcclxuICAgICAgICAgICAgdGl0bGU6IEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCksXHJcbiAgICAgICAgICAgIHBsYWNlbWVudDogJ2JvdHRvbSdcclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYWRkRWwoYnV0dG9uLCBtYWtlVGV4dChMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApKSk7XHJcbiAgICAgICAgc2V0QXR0cihidXR0b24sICdsMTBuLWlkJywgYGhlYWRlci0ke25hbWV9YCk7XHJcbiAgICB9XHJcbiAgICBhZGRDbGFzcyhidXR0b24sIGJ1dHRvbkNsYXNzKTtcclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgYC10ZXN0LSR7bmFtZX1gKTtcclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgYC10b2dnbGUtY2xhc3MtJHtuYW1lfWApO1xyXG4gICAgaWYgKG9wdHMuY2xhenopIHtcclxuICAgICAgICBhZGRDbGFzcyhidXR0b24sIG9wdHMuY2xhenopO1xyXG4gICAgfVxyXG4gICAgY29udGFpbmVycy5uYXZpZ2F0aW9uLmFwcGVuZENoaWxkKGJ1dHRvbik7XHJcblxyXG4gICAgY29uc3Qgb25DbGlja0RlbGVnYXRlID0gZnVuY3Rpb24gKHZpZXcyKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChldnQpIHtcclxuICAgICAgICAgICAgLy9UZXN0cy5ydW4oKTtcclxuICAgICAgICAgICAgY29uc3QgZWxlbXMgPSBjb250YWluZXJzLm5hdmlnYXRpb24uZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShidXR0b25DbGFzcyk7XHJcbiAgICAgICAgICAgIGlmIChvcHRzLnRvZ2dsZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWxzID0gZ2V0RWxzKGAtdG9nZ2xlLWNsYXNzLSR7bmFtZX1gKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2dC50YXJnZXQuaXNFcXVhbE5vZGUoZWxzW2ldKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0NsYXNzKGVsc1tpXSwgJ2FjdGl2ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc1tpXS5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBoYXNDbGFzcyhldnQudGFyZ2V0LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGVsZW1zW2ldLCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFvcHRzLnRvZ2dsZSB8fCAob3B0cy50b2dnbGUgJiYgIWlzQWN0aXZlKSkge1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoZXZ0LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG5cclxuICAgICAgICAgICAgICAgIHBhc3NFbHMoY29udGFpbmVycy5jb250ZW50LCBnZXRFbCgnd2FyZWhvdXNlJykpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5jb250ZW50LmFwcGVuZENoaWxkKHZpZXcyLmNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoY29udGFpbmVycy5jb250ZW50LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSB2aWV3MjtcclxuICAgICAgICAgICAgICAgIHZpZXcyLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGV2dC50YXJnZXQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgICAgIHBhc3NFbHMoY29udGFpbmVycy5jb250ZW50LCBnZXRFbCgnd2FyZWhvdXNlJykpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnMuY29udGVudCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25DbGlja0RlbGVnYXRlKHZpZXcpKTtcclxuXHJcbiAgICAvLyBkZXByZWNhdGVkLiBVc2UgVXRpbHMuc2V0Rmlyc3RUYWIgaW5zdGVhZFxyXG4gICAgaWYgKG9wdHMubWFpblBhZ2UpIHtcclxuICAgICAgICBVdGlscy5zZXRGaXJzdFRhYihjb250YWluZXJzLCB7YnV0dG9uLCB2aWV3fSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ge2J1dHRvbiwgdmlld307XHJcbn07XHJcblxyXG5VdGlscy5zZXRGaXJzdFRhYiA9IGZ1bmN0aW9uKGNvbnRhaW5lcnMsIG9wdHMpe1xyXG4gICAgYWRkQ2xhc3Mob3B0cy5idXR0b24sICdhY3RpdmUnKTtcclxuICAgIGNvbnRhaW5lcnMuY29udGVudC5hcHBlbmRDaGlsZChvcHRzLnZpZXcuY29udGVudCk7XHJcbiAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSBvcHRzLnZpZXc7XHJcbn1cclxuXHJcblV0aWxzLmFsZXJ0ID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcclxuICAgIHZleC5kaWFsb2cuYWxlcnQobWVzc2FnZSk7XHJcbn07XHJcblxyXG5jb25zdCBzZXRFcnJvciA9IChlbCwgZXJyKSA9PiBhZGRFbChjbGVhckVsKHFlZShlbCwgJy5lcnJvci1tc2cnKSksIG1ha2VUZXh0KFV0aWxzLmhhbmRsZUVycm9yTXNnKGVycikpKTtcclxuY29uc3QgY2xlYXJFcnJvciA9IChlbCkgPT4gY2xlYXJFbChxZWUoZWwsICcuZXJyb3ItbXNnJykpO1xyXG5cclxuVXRpbHMuY29uZmlybSA9IGZ1bmN0aW9uIChtZXNzYWdlLCBvbk9rLCBvbkNhbmNlbCkge1xyXG4gICAgdmV4LmRpYWxvZy5jb25maXJtKHtcclxuICAgICAgICBtZXNzYWdlLFxyXG4gICAgICAgIGNhbGxiYWNrOiAodmFsKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvbk9rKSBvbk9rKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob25DYW5jZWwpIG9uQ2FuY2VsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn07XHJcblxyXG5VdGlscy5yZW1vdmVDaGlsZHJlbiA9IGZ1bmN0aW9uIChteU5vZGUpIHtcclxuICAgIGlmICghbXlOb2RlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgd2hpbGUgKG15Tm9kZS5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgbXlOb2RlLnJlbW92ZUNoaWxkKG15Tm9kZS5maXJzdENoaWxkKTtcclxuICAgIH1cclxufTtcclxuXHJcblV0aWxzLnByb2Nlc3NFcnJvciA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKGFyZ3VtZW50c1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2soLi4uYXJyKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuVXRpbHMuaGFuZGxlRXJyb3JNc2cgPSBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICBjb25zdCBjaGVja0Vycm9yVHlwZSA9IFIuY3VycnkoKGVycjIsIG5hbWUpID0+IGVycjIgaW5zdGFuY2VvZiBFcnJvcnNbbmFtZV0gfHwgKGVycjIubmFtZSAmJiBlcnIyLm5hbWUgPT09IG5hbWUpKTtcclxuICAgIGlmIChSLmtleXMoRXJyb3JzKS5zb21lKGNoZWNrRXJyb3JUeXBlKGVycikpKSB7XHJcbiAgICAgICAgY29uc3QgcGFyYW1zID0gZXJyLnBhcmFtZXRlcnMubWFwKHZhbCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBMMTBuLmhhc1ZhbHVlKHZhbCkgPyBMMTBuLmdldFZhbHVlKHZhbCkgOiB2YWw7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHN0ckZvcm1hdChnZXRMMTBuKGVyci5tZXNzYWdlSWQpLCBwYXJhbXMpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIHJldHVybiBlcnIubWVzc2FnZTtcclxuICAgIH1cclxuICAgIHJldHVybiBlcnI7XHJcbn07XHJcblxyXG5VdGlscy5oYW5kbGVFcnJvciA9IGVyciA9PiBVdGlscy5hbGVydChVdGlscy5oYW5kbGVFcnJvck1zZyhlcnIpKTtcclxuXHJcblV0aWxzLmVuYWJsZUVsID0gUi5jdXJyeSgoZWwsIGNvbmRpdGlvbikgPT4ge1xyXG4gICAgY29uc3Qga2V5ID0gZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAndGV4dGFyZWEnID8gJ3JlYWRvbmx5JyA6ICdkaXNhYmxlZCc7XHJcbiAgICBpZiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGtleSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuVXRpbHMuZW5hYmxlID0gZnVuY3Rpb24gKHJvb3QsIGNsYXNzTmFtZSwgY29uZGl0aW9uKSB7XHJcbiAgICBubDJhcnJheShyb290LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKSkubWFwKFV0aWxzLmVuYWJsZUVsKFIuX18sIGNvbmRpdGlvbikpO1xyXG59O1xyXG5cclxuVXRpbHMuY2hhck9yZEFPYmplY3QgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLmRpc3BsYXlOYW1lLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuVXRpbHMucmVidWlsZFNlbGVjdG9yID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBuYW1lcykge1xyXG4gICAgY2xlYXJFbChzZWxlY3Rvcik7XHJcbiAgICBuYW1lcy5mb3JFYWNoKChuYW1lSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KG5hbWVJbmZvLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgb3B0aW9uLnZhbHVlID0gbmFtZUluZm8udmFsdWU7XHJcbiAgICAgICAgc2VsZWN0b3IuYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuVXRpbHMucmVidWlsZFNlbGVjdG9yQXJyID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBuYW1lcykge1xyXG4gICAgY2xlYXJFbChzZWxlY3Rvcik7XHJcbiAgICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgICAgICBvcHRpb24uYXBwZW5kQ2hpbGQobWFrZVRleHQobmFtZSkpO1xyXG4gICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICB9KTtcclxufTtcclxuXHJcbi8vIGZyb20gaHR0cHM6Ly9sZWFybi5qYXZhc2NyaXB0LnJ1L2pzLWFuaW1hdGlvblxyXG5VdGlscy5hbmltYXRlID0gKG9wdGlvbnMpID0+IHtcclxuICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uIGFuaW1hdGUodGltZSkge1xyXG4gICAgICAgIC8vIHRpbWVGcmFjdGlvbiBmcm9tIDAgdG8gMVxyXG4gICAgICAgIGxldCB0aW1lRnJhY3Rpb24gPSAodGltZSAtIHN0YXJ0KSAvIG9wdGlvbnMuZHVyYXRpb247XHJcbiAgICAgICAgaWYgKHRpbWVGcmFjdGlvbiA+IDEpIHRpbWVGcmFjdGlvbiA9IDE7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gY3VycmVudCBhbmltYXRpb24gc3RhdGVcclxuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG9wdGlvbnMudGltaW5nKHRpbWVGcmFjdGlvbilcclxuICAgICAgICBcclxuICAgICAgICBvcHRpb25zLmRyYXcocHJvZ3Jlc3MpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICh0aW1lRnJhY3Rpb24gPCAxKSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuY29uc3QgVGltaW5nID0ge307XHJcblxyXG4vLyBjYWxsIGV4YW1wbGVzXHJcbi8vdGltaW5nOiBUaW1pbmcubGluZWFyLFxyXG4vL3RpbWluZzogVGltaW5nLnF1YWQsXHJcbi8vdGltaW5nOiBUaW1pbmcuY2lyYyxcclxuLy90aW1pbmc6IFRpbWluZy5ib3VuY2UsXHJcbi8vdGltaW5nOiBUaW1pbmcubWFrZUVhc2VPdXQoVGltaW5nLmJvdW5jZSksXHJcbi8vdGltaW5nOiBUaW1pbmcubWFrZUVhc2VJbk91dChUaW1pbmcuYm91bmNlKSxcclxuLy90aW1pbmc6IFRpbWluZy5iYWNrKDMuNSksXHJcbi8vdGltaW5nOiBUaW1pbmcuZWxhc3RpYygxLjUpLFxyXG4vL3RpbWluZzogVGltaW5nLm1ha2VFYXNlSW5PdXQoVGltaW5nLnBvbHkoNCkpLFxyXG5cclxuVGltaW5nLmxpbmVhciA9ICh0aW1lRnJhY3Rpb24pID0+IHtcclxuICAgIHJldHVybiB0aW1lRnJhY3Rpb247XHJcbn1cclxuXHJcblRpbWluZy5xdWFkID0gKCBwcm9ncmVzcykgPT4ge1xyXG4gICAgcmV0dXJuIE1hdGgucG93KHByb2dyZXNzLCAyKVxyXG59XHJcblxyXG5UaW1pbmcucG9seSA9IFIuY3VycnkoKHgsIHByb2dyZXNzKSA9PiB7XHJcbiAgICByZXR1cm4gTWF0aC5wb3cocHJvZ3Jlc3MsIHgpXHJcbn0pXHJcblxyXG5UaW1pbmcuY2lyYyA9ICh0aW1lRnJhY3Rpb24pID0+IHtcclxuICAgIHJldHVybiAxIC0gTWF0aC5zaW4oTWF0aC5hY29zKHRpbWVGcmFjdGlvbikpXHJcbn1cclxuXHJcblRpbWluZy5iYWNrID0gUi5jdXJyeSgoeCwgdGltZUZyYWN0aW9uKSA9PiB7XHJcbiAgICByZXR1cm4gTWF0aC5wb3codGltZUZyYWN0aW9uLCAyKSAqICgoeCArIDEpICogdGltZUZyYWN0aW9uIC0geClcclxufSlcclxuXHJcblRpbWluZy5ib3VuY2UgPSAodGltZUZyYWN0aW9uKSA9PiB7XHJcbiAgICBmb3IgKHZhciBhID0gMCwgYiA9IDEsIHJlc3VsdDsgMTsgYSArPSBiLCBiIC89IDIpIHtcclxuICAgICAgICBpZiAodGltZUZyYWN0aW9uID49ICg3IC0gNCAqIGEpIC8gMTEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIC1NYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogdGltZUZyYWN0aW9uKSAvIDQsIDIpICsgTWF0aC5wb3coYiwgMilcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcblRpbWluZy5lbGFzdGljID0gKHgsIHRpbWVGcmFjdGlvbikgPT4ge1xyXG4gICAgcmV0dXJuIE1hdGgucG93KDIsIDEwICogKHRpbWVGcmFjdGlvbiAtIDEpKSAqIE1hdGguY29zKDIwICogTWF0aC5QSSAqIHggLyAzICogdGltZUZyYWN0aW9uKVxyXG59XHJcblxyXG5UaW1pbmcubWFrZUVhc2VPdXQgPSAodGltaW5nKSA9PiB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24odGltZUZyYWN0aW9uKSB7XHJcbiAgICAgICAgcmV0dXJuIDEgLSB0aW1pbmcoMSAtIHRpbWVGcmFjdGlvbik7XHJcbiAgICB9XHJcbn1cclxuXHJcblRpbWluZy5tYWtlRWFzZUluT3V0ID0gKHRpbWluZykgPT4ge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHRpbWVGcmFjdGlvbikge1xyXG4gICAgICAgIGlmICh0aW1lRnJhY3Rpb24gPCAuNSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGltaW5nKDIgKiB0aW1lRnJhY3Rpb24pIC8gMjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gKDIgLSB0aW1pbmcoMiAqICgxIC0gdGltZUZyYWN0aW9uKSkpIC8gMjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcblN0cmluZy5wcm90b3R5cGUuZW5kc1dpdGggPSBmdW5jdGlvbiAoc3VmZml4KSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbmRleE9mKHN1ZmZpeCwgdGhpcy5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7XHJcbn07XHJcblxyXG4vLyBmcm9tIGRhdGUgZm9ybWF0IHV0aWxzXHJcbi8vRm9yIGNvbnZlbmllbmNlLi4uXHJcbkRhdGUucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChtYXNrLCB1dGMpIHtcclxuICAgIHJldHVybiBkYXRlRm9ybWF0KHRoaXMsIG1hc2ssIHV0Yyk7XHJcbn07XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUsIDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG5VdGlscywgT3ZlcnZpZXcsIFByb2ZpbGVzLCBTdG9yaWVzLCBBZGFwdGF0aW9ucywgQnJpZWZpbmdzLCBUaW1lbGluZSwgU29jaWFsTmV0d29yaywgRmlsZVV0aWxzXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgc3RhdGUudmlld3MgPSB7fTtcclxuICAgIHN0YXRlLmZpcnN0QmFzZUxvYWQgPSBNT0RFID09PSAnU3RhbmRhbG9uZSc7XHJcbiAgICBcclxuICAgIGNvbnN0IEJBQ0tVUF9OVU1CRVIgPSA0O1xyXG4gICAgY29uc3QgQkFDS1VQX0lOVEVSVkFMID0gNjAwMDAqMTA7IC8vIDEwIG1pblxyXG5cclxuICAgIGNvbnN0IGJ0bk9wdHMgPSB7XHJcbiAgICAgICAgdG9vbHRpcDogdHJ1ZSxcclxuICAgICAgICBjbGFzc05hbWU6ICdtYWluTmF2QnV0dG9uJ1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBpbml0UGFnZSA9ICgpID0+IHtcclxuICAgICAgICBMMTBuLmluaXQoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSgoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCkpO1xyXG4gICAgICAgIFVJLmluaXRTZWxlY3RvckZpbHRlcnMoKTtcclxuICAgICAgICBVSS5pbml0UGFuZWxUb2dnbGVycygpO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoKTtcclxuICAgICAgICBmdW5jdGlvbiB1cGRhdGVEaWFsb2dzKCkge1xyXG4gICAgICAgICAgICB2ZXguZGlhbG9nLmJ1dHRvbnMuWUVTLnRleHQgPSBnZXRMMTBuKCdjb21tb24tb2snKTtcclxuICAgICAgICAgICAgdmV4LmRpYWxvZy5idXR0b25zLk5PLnRleHQgPSBnZXRMMTBuKCdjb21tb24tY2FuY2VsJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHVwZGF0ZURpYWxvZ3MoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSh1cGRhdGVEaWFsb2dzKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcHJvdG9FeHBhbmRlciA9IChhcnIpID0+IHtcclxuICAgICAgICBmdW5jdGlvbiBwcm90b0NhcnJpZXIoKSB7fVxyXG4gICAgICAgIGFyci5mb3JFYWNoKG5hbWUgPT4gKHByb3RvQ2Fycmllci5wcm90b3R5cGVbbmFtZV0gPSAoKCkgPT4gMSkpKTtcclxuICAgICAgICByZXR1cm4gcHJvdG9DYXJyaWVyO1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHBsYXllckFyciA9IFtcclxuICAgICAgICAnZ2V0UGxheWVyc09wdGlvbnMnLFxyXG4gICAgICAgICdnZXRXZWxjb21lVGV4dCcsXHJcbiAgICAgICAgJ2dldFBsYXllclByb2ZpbGVJbmZvJyxcclxuICAgICAgICAnY3JlYXRlQ2hhcmFjdGVyQnlQbGF5ZXInLFxyXG4gICAgICAgICd1cGRhdGVQcm9maWxlRmllbGQnLFxyXG4gICAgICAgICdnZXRSb2xlR3JpZEluZm8nXTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcblxyXG4gICAgZXhwb3J0cy5vblBsYXllclBhZ2VMb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIGluaXRQYWdlKCk7XHJcbiAgICAgICAgY29uc3QgUmVtb3RlREJNUyA9IG1ha2VSZW1vdGVEQk1TKHByb3RvRXhwYW5kZXIocGxheWVyQXJyKSk7XHJcbiAgICAgICAgd2luZG93LkRCTVMgPSBuZXcgUmVtb3RlREJNUygpO1xyXG4gICAgICAgIHN0YXRlSW5pdCgpO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ3BsYXllcicsIFBsYXllciwgeyBtYWluUGFnZTogdHJ1ZSB9KTtcclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnbmF2LXNlcGFyYXRvcicpKTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdhYm91dCcsIEFib3V0KTtcclxuICAgICAgICAvLyAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUwxMG5CdXR0b24oKSk7XHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignbG9nb3V0QnV0dG9uIGljb24tYnV0dG9uJywgJ2xvZ291dCcsIHBvc3RMb2dvdXQsIGJ0bk9wdHMpKTtcclxuICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMub25JbmRleFBhZ2VMb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIGluaXRQYWdlKCk7XHJcbiAgICAgICAgY29uc3QgUmVtb3RlREJNUyA9IG1ha2VSZW1vdGVEQk1TKHByb3RvRXhwYW5kZXIoWydnZXRQbGF5ZXJzT3B0aW9ucycsICdnZXRSb2xlR3JpZEluZm8nXSkpO1xyXG4gICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IFJlbW90ZURCTVMoKTtcclxuICAgICAgICBzdGF0ZUluaXQoKTtcclxuICAgICAgICBEQk1TLmdldFBsYXllcnNPcHRpb25zKChlcnIsIHBsYXllcnNPcHRpb25zKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICduYXYtc2VwYXJhdG9yJykpO1xyXG4gICAgICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdlbnRlcicsIEVudGVyLCB7IG1haW5QYWdlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICBpZiAocGxheWVyc09wdGlvbnMuYWxsb3dQbGF5ZXJDcmVhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnc2lnbi11cCcsIFNpZ25VcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnYWJvdXQnLCBBYm91dCk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUwxMG5CdXR0b24oKSk7XHJcbiAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMub25Pcmdhbml6ZXJQYWdlTG9hZCA9ICgpID0+IHtcclxuICAgICAgICBpbml0UGFnZSgpO1xyXG4gICAgICAgIGNvbnN0IExvY2FsREJNUyA9IG1ha2VMb2NhbERCTVModHJ1ZSk7XHJcbiAgICAgICAgaWYgKE1PREUgPT09ICdTdGFuZGFsb25lJykge1xyXG4gICAgICAgICAgICB3aW5kb3cuREJNUyA9IG5ldyBMb2NhbERCTVMoKTtcclxuICAgICAgICAgICAgd2luZG93LkRCTVMgPSBtYWtlTG9jYWxEQk1TV3JhcHBlcih3aW5kb3cuREJNUyk7XHJcbi8vICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShEZW1vQmFzZS5kYXRhLCBvbkJhc2VMb2FkZWQpO1xyXG4gICAgICAgICAgICBydW5CYXNlU2VsZWN0RGlhbG9nKCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChNT0RFID09PSAnTklNU19TZXJ2ZXInKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IFJlbW90ZURCTVMgPSBtYWtlUmVtb3RlREJNUyhMb2NhbERCTVMpO1xyXG4gICAgICAgICAgICB3aW5kb3cuREJNUyA9IG5ldyBSZW1vdGVEQk1TKCk7XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5Q2hlY2soKGNoZWNrUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zaXN0ZW5jeUNoZWNrQWxlcnQoY2hlY2tSZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgb25EYXRhYmFzZUxvYWQoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZnVuY3Rpb24gcnVuQmFzZVNlbGVjdERpYWxvZygpIHtcclxuICAgICAgICBjb25zdCBkYkRpYWxvZyA9IHF1ZXJ5RWwoJy5zZXQtZGF0YWJhc2UtZGlhbG9nJyk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnYm9keScpLCBkYkRpYWxvZyk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShkYkRpYWxvZywgJy5vbi1hY3Rpb24tYnV0dG9uJyksICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAkKGRiRGlhbG9nKS5tb2RhbCgnaGlkZScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJlYWRMb2NhbEJhc2VzKCkudGhlbigoYnJvd3NlckJhc2VzKSA9PiB7XHJcbiAgICAgICAgICAgIGFkZEVscyhxZWUoZGJEaWFsb2csICcubW9kYWwtYm9keSAuYmFja3VwLWJhc2VzJyksIChicm93c2VyQmFzZXMgfHwgW10pLm1hcCgoYmFzZSxpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBiYXNlU2VsZWN0ID0gcW10ZSgnLmJhY2t1cC1iYXNlLXRtcGwnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gcWVlKGJhc2VTZWxlY3QsICdpbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ3ZhbHVlJywgXCJicm93c2VyQmFja3VwXCIgKyBpKTsgXHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAnaWQnLCBcImRiU291cmNlQnJvd3NlckJhY2t1cFwiICsgaSk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC5iYXNlID0gYmFzZTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIocWVlKGJhc2VTZWxlY3QsICdsYWJlbCcpLCAnZm9yJywgXCJkYlNvdXJjZUJyb3dzZXJCYWNrdXBcIiArIGkpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGJhc2UuTWV0YS5zYXZlVGltZSkuZm9ybWF0KCdkZCBtbW0geXl5eSBISDpNTTpzcycpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwocWVlKGJhc2VTZWxlY3QsICcuYmFzZS1uYW1lJyksIG1ha2VUZXh0KGJhc2UuTWV0YS5uYW1lICsgJyAoJyArIGRhdGUgKyAnKScpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBiYXNlU2VsZWN0O1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBxZWUoZGJEaWFsb2csICdpbnB1dFtuYW1lPWRiU291cmNlXScpLmNoZWNrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBxZWUoZGJEaWFsb2csICcjZGJTb3VyY2VEZW1vQmFzZScpLmJhc2UgPSBDb21tb25VdGlscy5jbG9uZShEZW1vQmFzZS5kYXRhKTtcclxuICAgICAgICAgICAgcWVlKGRiRGlhbG9nLCAnI2RiU291cmNlRW1wdHlCYXNlJykuYmFzZSA9IENvbW1vblV0aWxzLmNsb25lKEVtcHR5QmFzZS5kYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShkYkRpYWxvZywgJy5kZW1vLWJhc2UtbmFtZScpLCBtYWtlVGV4dChEZW1vQmFzZS5kYXRhLk1ldGEubmFtZSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgZGlhbG9nT25CYXNlTG9hZCA9IGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgJChkYkRpYWxvZykubW9kYWwoJ2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIG9uQmFzZUxvYWRlZChlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpbml0QmFzZUxvYWRCdG4ocWVlKGRiRGlhbG9nLCAnLnVwbG9hZC1kYicpLCBxZWUoZGJEaWFsb2csICcudXBsb2FkLWRiIGlucHV0JyksIGRpYWxvZ09uQmFzZUxvYWQpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGlzdGVuKHFlZShkYkRpYWxvZywgJy5vbi1hY3Rpb24tYnV0dG9uJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJhc2UgPSBnZXRTZWxlY3RlZFJhZGlvKGRiRGlhbG9nLCAnaW5wdXRbbmFtZT1kYlNvdXJjZV0nKS5iYXNlO1xyXG4gICAgICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShiYXNlLCBkaWFsb2dPbkJhc2VMb2FkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGRiRGlhbG9nKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICQoZGJEaWFsb2cpLm1vZGFsKHtcclxuICAgICAgICAgICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KS5jYXRjaChlcnIgPT4gY29uc29sZS5lcnJvcihlcnIpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjb25zaXN0ZW5jeUNoZWNrQWxlcnQoY2hlY2tSZXN1bHQpIHtcclxuICAgICAgICBpZiAoY2hlY2tSZXN1bHQuZXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignb3ZlcnZpZXctY29uc2lzdGVuY3ktcHJvYmxlbS1kZXRlY3RlZCcpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ29uc2lzdGVuY3kgY2hlY2sgZGlkblxcJ3QgZmluZCBlcnJvcnMnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY29uc2lzdGVuY3lDaGVjayhjYWxsYmFjaykge1xyXG4gICAgICAgIERCTVMuZ2V0Q29uc2lzdGVuY3lDaGVja1Jlc3VsdCgoZXJyLCBjaGVja1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjaGVja1Jlc3VsdC5lcnJvcnMuZm9yRWFjaChDb21tb25VdGlscy5jb25zb2xlRXJyKTtcclxuICAgICAgICAgICAgY2FsbGJhY2soY2hlY2tSZXN1bHQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHN0YXRlSW5pdCgpIHtcclxuICAgICAgICBzdGF0ZS5uYXZpZ2F0aW9uID0gZ2V0RWwoJ25hdmlnYXRpb24nKTtcclxuICAgICAgICBzdGF0ZS5jb250YWluZXJzID0ge1xyXG4gICAgICAgICAgICByb290OiBzdGF0ZSxcclxuICAgICAgICAgICAgbmF2aWdhdGlvbjogc3RhdGUubmF2aWdhdGlvbixcclxuICAgICAgICAgICAgY29udGVudDogZ2V0RWwoJ2NvbnRlbnRBcmVhJylcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uRGF0YWJhc2VMb2FkKCkge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKChlcnIyLCBpc0FkbWluKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICQuZGF0ZXRpbWVwaWNrZXIuc2V0RGF0ZUZvcm1hdHRlcignbW9tZW50Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGJ1dHRvbjtcclxuICAgICAgICAgICAgICAgIHN0YXRlSW5pdCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHRhYnMgPSB7fTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0VGFiID0gJ092ZXJ2aWV3JztcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZGRWaWV3ID0gKGNvbnRhaW5lcnMsIGJ0bk5hbWUsIHZpZXdOYW1lLCBvcHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFic1t2aWV3TmFtZV0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3UmVzOiBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIGJ0bk5hbWUsIHdpbmRvd1t2aWV3TmFtZV0sIG9wdHMpXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnb3ZlcnZpZXcnLCAnT3ZlcnZpZXcnKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIGFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ3Byb2ZpbGVzJywgJ1Byb2ZpbGVzJyk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdjaGFyYWN0ZXJzJywgJ0NoYXJhY3RlcnMnKTtcclxuICAgICAgICAgICAgICAgIGFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ3BsYXllcnMnLCAnUGxheWVycycpO1xyXG4gICAgICAgICAgICAgICAgYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnc3RvcmllcycsICdTdG9yaWVzJyk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdhZGFwdGF0aW9ucycsICdBZGFwdGF0aW9ucycpO1xyXG4gICAgICAgICAgICAgICAgYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnYnJpZWZpbmdzJywgJ0JyaWVmaW5ncycpO1xyXG4gICAgICAgICAgICAgICAgYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAncmVsYXRpb25zJywgJ1JlbGF0aW9ucycpO1xyXG5cclxuICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICduYXYtc2VwYXJhdG9yJykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ3RpbWVsaW5lJywgJ1RpbWVsaW5lJywgeyBjbGF6ejogJ3RpbWVsaW5lQnV0dG9uIGljb24tYnV0dG9uJywgdG9vbHRpcDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIGFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ3NvY2lhbC1uZXR3b3JrJywgJ1NvY2lhbE5ldHdvcmsnLCB7IGNsYXp6OiAnc29jaWFsTmV0d29ya0J1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdwcm9maWxlLWZpbHRlcicsICdQcm9maWxlRmlsdGVyJywgeyBjbGF6ejogJ2ZpbHRlckJ1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdncm91cHMnLCAnR3JvdXBQcm9maWxlJywgeyBjbGF6ejogJ2dyb3Vwc0J1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICd0ZXh0U2VhcmNoJywgJ1RleHRTZWFyY2gnLCB7IGNsYXp6OiAndGV4dFNlYXJjaEJ1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdyb2xlR3JpZCcsICdSb2xlR3JpZCcsIHsgY2xheno6ICdyb2xlR3JpZEJ1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ25hdi1zZXBhcmF0b3InKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKE1PREUgPT09ICdOSU1TX1NlcnZlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICBhZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdhZG1pbnMnLCAnQWNjZXNzTWFuYWdlcicsIHsgY2xheno6ICdhY2Nlc3NNYW5hZ2VyQnV0dG9uIGljb24tYnV0dG9uJywgdG9vbHRpcDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ2xvZ1ZpZXdlcicsICdMb2dWaWV3ZXIyJywgeyBjbGF6ejogJ2xvZ1ZpZXdlckJ1dHRvbiBpY29uLWJ1dHRvbicsIHRvb2x0aXA6IHRydWUgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ25hdi1zZXBhcmF0b3InKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGlzQWRtaW4pIHtcclxuICAgICAgICAgICAgICAgICAgICBidXR0b24gPSBtYWtlQnV0dG9uKCdkYXRhTG9hZEJ1dHRvbiBpY29uLWJ1dHRvbicsICdvcGVuLWRhdGFiYXNlJywgbnVsbCwgYnRuT3B0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdmaWxlJztcclxuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEF0dHIoaW5wdXQsICd0YWJpbmRleCcsIC0xKTtcclxuICAgICAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kQ2hpbGQoaW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGluaXRCYXNlTG9hZEJ0bihidXR0b24sIGlucHV0LCBvbkJhc2VMb2FkZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGJ1dHRvbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignZGF0YVNhdmVCdXR0b24gaWNvbi1idXR0b24nLCAnc2F2ZS1kYXRhYmFzZScsIEZpbGVVdGlscy5zYXZlRmlsZSwgYnRuT3B0cykpO1xyXG4gICAgICAgICAgICAgICAgaWYgKE1PREUgPT09ICdTdGFuZGFsb25lJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ25ld0Jhc2VCdXR0b24gaWNvbi1idXR0b24nLCAnY3JlYXRlLWRhdGFiYXNlJywgRmlsZVV0aWxzLm1ha2VOZXdCYXNlKG9uQmFzZUxvYWRlZCksIGJ0bk9wdHMpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignbWFpbkhlbHBCdXR0b24gaWNvbi1idXR0b24nLCAnZG9jcycsIEZpbGVVdGlscy5vcGVuSGVscCwgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VMMTBuQnV0dG9uKCkpO1xyXG5cclxuLy8gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbigndGVzdEJ1dHRvbiBpY29uLWJ1dHRvbicsICd0ZXN0JywgVGVzdFV0aWxzLnJ1blRlc3RzLCBidG5PcHRzKSk7XHJcbi8vICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ2NoZWNrQ29uc2lzdGVuY3lCdXR0b24gaWNvbi1idXR0b24nLCAnY2hlY2tDb25zaXN0ZW5jeScsIGNoZWNrQ29uc2lzdGVuY3ksIGJ0bk9wdHMpKTtcclxuLy8gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignY2hlY2tDb25zaXN0ZW5jeUJ1dHRvbiBpY29uLWJ1dHRvbicsICdzaG93RGJtc0NvbnNpc3RlbmN5U3RhdGUnLCBzaG93RGJtc0NvbnNpc3RlbmN5U3RhdGUsIGJ0bk9wdHMpKTtcclxuLy8gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignY2xpY2tBbGxUYWJzQnV0dG9uIGljb24tYnV0dG9uJywgJ2NsaWNrQWxsVGFicycsIFRlc3RVdGlscy5jbGlja1Rocm91Z2h0SGVhZGVycywgYnRuT3B0cykpO1xyXG4vLyAgICAgICAgICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKCdjbGlja0FsbFRhYnNCdXR0b24gaWNvbi1idXR0b24nLCAnc2hvd0RpZmYnLCBUZXN0VXRpbHMuc2hvd0RpZmZFeGFtcGxlLCBidG5PcHRzKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoTU9ERSA9PT0gJ05JTVNfU2VydmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ2xvZ291dEJ1dHRvbiBpY29uLWJ1dHRvbicsICdsb2dvdXQnLCBwb3N0TG9nb3V0LCBidG5PcHRzKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKCdyZWZyZXNoQnV0dG9uIGljb24tYnV0dG9uJywgJ3JlZnJlc2gnLCAoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCksIGJ0bk9wdHMpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBVdGlscy5zZXRGaXJzdFRhYihzdGF0ZS5jb250YWluZXJzLCB0YWJzW2ZpcnN0VGFiXS52aWV3UmVzKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoTU9ERSA9PT0gJ1N0YW5kYWxvbmUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkQmVmb3JlVW5sb2FkTGlzdGVuZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2NhbEF1dG9TYXZlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIEZpbGVVdGlscy5tYWtlTmV3QmFzZSgpO1xyXG4vLyAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuVGVzdHMoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIG9uQmFzZUxvYWRlZChlcnIzKSB7XHJcbiAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgIGNvbnNpc3RlbmN5Q2hlY2soKGNoZWNrUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5Q2hlY2tBbGVydChjaGVja1Jlc3VsdCk7XHJcbiAgICAgICAgICAgIGlmKHN0YXRlLmZpcnN0QmFzZUxvYWQpe1xyXG4gICAgICAgICAgICAgICAgb25EYXRhYmFzZUxvYWQoKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmZpcnN0QmFzZUxvYWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBpbml0QmFzZUxvYWRCdG4oYnV0dG9uLCBpbnB1dCwgb25CYXNlTG9hZGVkKSB7XHJcbiAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIEZpbGVVdGlscy5yZWFkU2luZ2xlRmlsZShvbkJhc2VMb2FkZWQpLCBmYWxzZSk7XHJcbiAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgaW5wdXQuY2xpY2soKTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXZpZ2F0aW9uIHRvIFwiI1wiXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUwxMG5CdXR0b24oKSB7XHJcbiAgICAgICAgY29uc3QgbDEwbkJ0biA9IG1ha2VCdXR0b24oJ3RvZ2dsZUwxMG5CdXR0b24nLCAnbDEwbicsIEwxMG4udG9nZ2xlTDEwbiwgYnRuT3B0cyk7XHJcbiAgICAgICAgY29uc3Qgc2V0SWNvbiA9ICgpID0+IHtcclxuICAgICAgICAgICAgbDEwbkJ0bi5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSBzdHJGb3JtYXQoJ3VybChcIi4vaW1hZ2VzL3swfS5zdmdcIiknLCBbZ2V0TDEwbignaGVhZGVyLWRpY3Rpb25hcnktaWNvbicpXSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShzZXRJY29uKTtcclxuICAgICAgICBzZXRJY29uKCk7XHJcbiAgICAgICAgcmV0dXJuIGwxMG5CdG47XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0RibXNDb25zaXN0ZW5jeVN0YXRlKCkge1xyXG4gICAgICAgIGNvbnNpc3RlbmN5Q2hlY2soY2hlY2tSZXMgPT4gVGVzdFV0aWxzLnNob3dNb2R1bGVTY2hlbWEoY2hlY2tSZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjaGVja0NvbnNpc3RlbmN5KCkge1xyXG4gICAgICAgIGNvbnNpc3RlbmN5Q2hlY2soY2hlY2tSZXMgPT4gVGVzdFV0aWxzLnNob3dDb25zaXN0ZW5jeUNoZWNrQWxlcnQoY2hlY2tSZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwb3N0TG9nb3V0KCkge1xyXG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNsb2dvdXRGb3JtIGJ1dHRvbicpLmNsaWNrKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUJ1dHRvbihjbGF6eiwgbmFtZSwgY2FsbGJhY2ssIG9wdHMpIHtcclxuICAgICAgICBjb25zdCBidXR0b24gPSBtYWtlRWwoJ2J1dHRvbicpO1xyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgY2xhenopO1xyXG4gICAgICAgIGlmIChvcHRzLnRvb2x0aXApIHtcclxuICAgICAgICAgICAgY29uc3QgZGVsZWdhdGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAkKGJ1dHRvbikuYXR0cignZGF0YS1vcmlnaW5hbC10aXRsZScsIEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCkpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShkZWxlZ2F0ZSk7XHJcbiAgICAgICAgICAgICQoYnV0dG9uKS50b29sdGlwKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VtZW50OiAnYm90dG9tJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCAnYWN0aW9uLWJ1dHRvbicpO1xyXG4gICAgICAgIGlmIChvcHRzLmNsYXNzTmFtZSkge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhidXR0b24sIG9wdHMuY2xhc3NOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsIGNhbGxiYWNrKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGJ1dHRvbjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBhZGRCZWZvcmVVbmxvYWRMaXN0ZW5lcigpIHtcclxuICAgICAgICB3aW5kb3cub25iZWZvcmV1bmxvYWQgPSAoZXZ0KSA9PiB7XHJcbiAgICAgICAgICAgIG1ha2VCYWNrdXAoKTtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGdldEwxMG4oJ3V0aWxzLWNsb3NlLXBhZ2Utd2FybmluZycpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGV2dCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgICAgIGV2dCA9IHdpbmRvdy5ldmVudDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZXZ0KSB7XHJcbiAgICAgICAgICAgICAgICBldnQucmV0dXJuVmFsdWUgPSBtZXNzYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHJlYWRMb2NhbEJhc2VzKCkge1xyXG4gICAgICAgIGlmICghd2luZG93LmluZGV4ZWREQikge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChMMTBuLmdldCgnZXJyb3JzJywgJ2luZGV4ZWRkYi1pcy1ub3QtZm91bmQnKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBjb3VudGVyID0gMDtcclxuICAgICAgICBsZXQgY291bnRlcnMgPSBbXTtcclxuICAgICAgICB3aGlsZSghUi5jb250YWlucyhjb3VudGVyLCBjb3VudGVycykpIHtcclxuICAgICAgICAgICAgY291bnRlcnMucHVzaChjb3VudGVyKTtcclxuICAgICAgICAgICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSBCQUNLVVBfTlVNQkVSO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoY291bnRlcnMubWFwKGNvdW50ZXIgPT4gTG9jYWxCYXNlQVBJLmdldCgnYmFzZScgKyBjb3VudGVyKSkpLnRoZW4oYmFzZXMgPT4ge1xyXG4gICAgICAgICAgICBiYXNlcyA9IGJhc2VzLmZpbHRlcihiYXNlID0+ICFSLmlzTmlsKGJhc2UpKTtcclxuICAgICAgICAgICAgaWYoYmFzZXMubGVuZ3RoID09PSAwKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBiYXNlcy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeSggYmFzZSA9PiAtbmV3IERhdGUoYmFzZS5vYmouTWV0YS5zYXZlVGltZSkuZ2V0VGltZSgpKSlcclxuICAgICAgICAgICAgcmV0dXJuIGJhc2VzLm1hcChSLnByb3AoJ29iaicpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gbG9jYWxBdXRvU2F2ZSgpIHtcclxuICAgICAgICBpZiAoIXdpbmRvdy5pbmRleGVkREIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBtYWtlQmFja3VwKCk7XHJcbiAgICAgICAgc2V0SW50ZXJ2YWwobWFrZUJhY2t1cCwgQkFDS1VQX0lOVEVSVkFMKTsgLy8gNSBtaW5cclxuICAgIH1cclxuICAgIFxyXG4gICAgbGV0IGNvdW50ZXIgPSAwO1xyXG4gICAgZnVuY3Rpb24gbWFrZUJhY2t1cCgpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhjb3VudGVyICsgMSk7XHJcbiAgICAgICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSBCQUNLVVBfTlVNQkVSO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdTdGFydGluZyBhdXRvc2F2ZScpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIERCTVMuZ2V0RGF0YWJhc2UoKGVyciwgZGF0YWJhc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIExvY2FsQmFzZUFQSS5wdXQoJ2Jhc2UnICsgY291bnRlciwgZGF0YWJhc2UpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0F1dG9zYXZlIE9LICcgKyBuZXcgRGF0ZSgpKTtcclxuLy8gICAgICAgICAgICAgICAgTG9jYWxCYXNlQVBJLmdldCgnYmFzZScgKyBjb3VudGVyKS50aGVuKChkYXRhYmFzZSkgPT4ge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YWJhc2UpO1xyXG4vLyAgICAgICAgICAgICAgICB9KS5jYXRjaChVdGlscy5oYW5kbGVFcnJvcik7XHJcbiAgICAgICAgICAgIH0pLmNhdGNoKFV0aWxzLmhhbmRsZUVycm9yKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFxyXG59KSh0aGlzLlBhZ2VNYW5hZ2VyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMsIG1vZGUpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgc3RhdGUuc3VtbWFyeSA9IHt9O1xyXG5cclxuICAgIGlmIChtb2RlID09PSAnTklNU19TZXJ2ZXInICYmIFBFUk1JU1NJT05fSU5GT1JNRVJfRU5BQkxFRCkge1xyXG4gICAgICAgIGV4cG9ydHMucmVmcmVzaCA9IChjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9nZXRQZXJtaXNzaW9uc1N1bW1hcnknLFxyXG4gICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0JyxcclxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCcsXHJcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBDb25zdGFudHMuaHR0cFRpbWVvdXRcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXF1ZXN0LmRvbmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnN1bW1hcnkgPSBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBhbGVydChkYXRhKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBhbGVydChzdGF0ZS5zdW1tYXJ5KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXF1ZXN0LmZhaWwoKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycm9ySW5mby5yZXNwb25zZVRleHQgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZXhwb3J0cy5zdWJzY3JpYmUsIDUwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGV4cG9ydHMuc3Vic2NyaWJlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gJC5hamF4KHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9zdWJzY3JpYmVPblBlcm1pc3Npb25zVXBkYXRlJyxcclxuICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCcsXHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnLFxyXG4gICAgICAgICAgICAgICAgdGltZW91dDogQ29uc3RhbnRzLmh0dHBUaW1lb3V0XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVxdWVzdC5kb25lKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5zdW1tYXJ5ID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBhbGVydChkYXRhKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBhbGVydChzdGF0ZS5zdW1tYXJ5KTtcclxuICAgICAgICAgICAgICAgIGV4cG9ydHMuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmVxdWVzdC5mYWlsKChlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV4cG9ydHMuc3Vic2NyaWJlLCA1MDApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5pc0FkbWluID0gKGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHN0YXRlLnN1bW1hcnkuaXNBZG1pbik7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5pc0VkaXRvciA9IChjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBzdGF0ZS5zdW1tYXJ5LmlzRWRpdG9yKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCBpc09iamVjdEVkaXRhYmxlU3luYyA9ICh0eXBlLCBuYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZS5zdW1tYXJ5LmlzRWRpdG9yKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc3RhdGUuc3VtbWFyeS5leGlzdEVkaXRvcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5zdW1tYXJ5LnVzZXJbdHlwZV0uaW5kZXhPZihuYW1lKSAhPT0gLTE7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5pc0VudGl0eUVkaXRhYmxlID0gKHR5cGUsIGVudGl0eU5hbWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGlzT2JqZWN0RWRpdGFibGVTeW5jKHR5cGUsIGVudGl0eU5hbWUpKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBleHBvcnRzLmdldEVudGl0eU5hbWVzQXJyYXkgPSBSLmN1cnJ5KCh0eXBlLCBlZGl0YWJsZU9ubHksIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJFbnRpdGllcyA9IHN0YXRlLnN1bW1hcnkudXNlclt0eXBlXTtcclxuICAgICAgICAgICAgY29uc3QgYWxsRW50aXRpZXMgPSBzdGF0ZS5zdW1tYXJ5LmFsbFt0eXBlXTtcclxuICAgICAgICAgICAgY29uc3Qgb3duZXJNYXAgPSBzdGF0ZS5zdW1tYXJ5Lm93bmVyTWFwc1t0eXBlXTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZXMgPSBhbGxFbnRpdGllcy5maWx0ZXIoKG5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlZGl0YWJsZU9ubHkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNPYmplY3RFZGl0YWJsZVN5bmModHlwZSwgbmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfSkubWFwKG5hbWUgPT4gKHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBgJHtvd25lck1hcFtuYW1lXX0uICR7bmFtZX1gLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICBlZGl0YWJsZTogaXNPYmplY3RFZGl0YWJsZVN5bmModHlwZSwgbmFtZSksXHJcbiAgICAgICAgICAgICAgICBpc093bmVyOiB1c2VyRW50aXRpZXMuaW5kZXhPZihuYW1lKSAhPT0gLTEsXHJcbiAgICAgICAgICAgICAgICBoYXNPd25lcjogb3duZXJNYXBbbmFtZV0gIT09ICctJ1xyXG4gICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBuYW1lMnN0ciA9IGEgPT4gYS5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZW50aXR5Q21wID0gQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5QmFzZSgnYXNjJywgKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChhLmlzT3duZXIgJiYgYi5pc093bmVyKSByZXR1cm4gbmFtZTJzdHIoYSkgPiBuYW1lMnN0cihiKTtcclxuICAgICAgICAgICAgICAgIGlmIChhLmlzT3duZXIpIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGlmIChiLmlzT3duZXIpIHJldHVybiB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChhLmhhc093bmVyICYmIGIuaGFzT3duZXIpIHJldHVybiBuYW1lMnN0cihhKSA+IG5hbWUyc3RyKGIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGEuaGFzT3duZXIpIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGlmIChiLmhhc093bmVyKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmFtZTJzdHIoYSkgPiBuYW1lMnN0cihiKTtcclxuICAgICAgICAgICAgfSwgUi5pZGVudGl0eSk7XHJcblxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIG5hbWVzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG4gICAgICAgICAgICBuYW1lcy5zb3J0KGVudGl0eUNtcCk7XHJcblxyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBuYW1lcyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSA9IChhZGFwdGF0aW9ucywgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWFwID0ge307XHJcbiAgICAgICAgICAgIGNvbnN0IHsgaXNBZGFwdGF0aW9uUmlnaHRzQnlTdG9yeSB9ID0gc3RhdGUuc3VtbWFyeTtcclxuXHJcbiAgICAgICAgICAgIGFkYXB0YXRpb25zLmZvckVhY2goKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke2VsZW0uc3RvcnlOYW1lfS0ke2VsZW0uY2hhcmFjdGVyTmFtZX1gO1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzQWRhcHRhdGlvblJpZ2h0c0J5U3RvcnkpIHtcclxuICAgICAgICAgICAgICAgICAgICBtYXBba2V5XSA9IGlzT2JqZWN0RWRpdGFibGVTeW5jKCdzdG9yeScsIGVsZW0uc3RvcnlOYW1lKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWFwW2tleV0gPSBpc09iamVjdEVkaXRhYmxlU3luYygnY2hhcmFjdGVyJywgZWxlbS5jaGFyYWN0ZXJOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBtYXApO1xyXG4gICAgICAgIH07XHJcbiAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdTdGFuZGFsb25lJykge1xyXG4gICAgICAgIGV4cG9ydHMucmVmcmVzaCA9IChjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGV4cG9ydHMuaXNBZG1pbiA9IChjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBleHBvcnRzLmlzRWRpdG9yID0gKGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGV4cG9ydHMuZ2V0RW50aXR5TmFtZXNBcnJheSA9IFIuY3VycnkoKHR5cGUsIGVkaXRhYmxlT25seSwgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc05hbWVzKGVyciwgbmFtZXMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdOYW1lcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgbmFtZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld05hbWVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRhYmxlOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG5ld05hbWVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBEQk1TLmdldEVudGl0eU5hbWVzQXJyYXkodHlwZSwgcHJvY2Vzc05hbWVzKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5pc0VudGl0eUVkaXRhYmxlID0gKHR5cGUsIGVudGl0eU5hbWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGV4cG9ydHMuYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSA9IChhZGFwdGF0aW9ucywgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWFwID0ge307XHJcbiAgICAgICAgICAgIGFkYXB0YXRpb25zLmZvckVhY2goKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgICAgIG1hcFtgJHtlbGVtLnN0b3J5TmFtZX0tJHtlbGVtLmNoYXJhY3Rlck5hbWV9YF0gPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG1hcCk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufSkodGhpcy5QZXJtaXNzaW9uSW5mb3JtZXIgPSB7fSwgTU9ERSk7XHJcbiJdfQ==
