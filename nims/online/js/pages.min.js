"use strict";function FilterConfiguration(e){this.info=e,this.innerProfileSettings=CommonUtils.clone(e.innerProfileSettings),this.innerProfileSettings.forEach(function(e){CommonUtils.startsWith(e.name,"profile-")||(e.displayName=getL10n(e.displayName),e.value=""),e.canHide=e.name!=Constants.CHAR_NAME})}var About={};About.init=function(){About.content=getEl("aboutDiv")},About.refresh=function(){};var AccessManager={};AccessManager.init=function(){listen(getEl("createUserButton"),"click",AccessManager.createUser),listen(getEl("changePasswordButton"),"click",AccessManager.changePassword),listen(getEl("removeUserButton"),"click",AccessManager.removeUser),listen(getEl("assignPermissionButton"),"click",AccessManager.assignPermission),listen(getEl("removePermissionButton"),"click",AccessManager.removePermission),listen(getEl("newAdminButton"),"click",AccessManager.assignNewAdmin),listen(getEl("removeEditorButton"),"click",AccessManager.removeEditor),listen(getEl("newEditorButton"),"click",AccessManager.assignEditor),AccessManager.entities=["characters","stories","groups"];var e,t,i=document.getElementsByClassName("adaptationRights");for(e=0;e<i.length;e++)t=i[e],t.addEventListener("click",AccessManager.changeAdaptationRightsMode);AccessManager.content=getEl("accessManagerDiv")},AccessManager.refresh=function(){DBMS.getManagementInfo(function(e,t){return e?void Utils.handleError(e):void PermissionInformer.isAdmin(function(e,i){return e?void Utils.handleError(e):void PermissionInformer.isEditor(function(e,r){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!i,function(e,n){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!i,function(e,o){return e?void Utils.handleError(e):void PermissionInformer.getGroupNamesArray(!i,function(e,a){if(e)return void Utils.handleError(e);var s={characters:n,groups:a,stories:o};if(!i&&r)for(var l in s)s[l]=s[l].filter(R.prop("isOwner"));AccessManager.rebuildInterface(s,t),Utils.enable(AccessManager.content,"adminOnly",i),Utils.enable(AccessManager.content,"editorOrAdmin",i||r)})})})})})})},AccessManager.rebuildInterface=function(e,t){var i=t.usersInfo,r=Object.keys(i).sort(CommonUtils.charOrdA),n=[];n.push(getEl("passwordUserName")),n.push(getEl("userPermissionSelector")),n.push(getEl("newEditorSelector")),n.forEach(function(e){Utils.rebuildSelectorArr(e,r)});var o=r.slice(0);o.splice(r.indexOf(t.admin),1);var a=getEl("newAdminSelector");Utils.rebuildSelectorArr(a,o),a=getEl("userRemoveSelector"),Utils.rebuildSelectorArr(a,o),AccessManager.entities.forEach(function(t){Utils.rebuildSelector(getEl("permission-selector__"+t),e[t])}),addEl(clearEl(getEl("currentAdministrator")),makeText(t.admin));var s=clearEl(getEl("currentEditor"));t.editor&&addEl(s,makeText(t.editor)),getEl("adaptationRights"+t.adaptationRights).checked=!0,AccessManager.buildPermissionList(e,i)},AccessManager.buildPermissionList=function(e,t){function i(e){return addEl(makeEl("li"),makeText(e))}function r(e){return AccessManager.entities.reduce(function(t,r){return t.push(i(a[r])),t.push(addEls(makeEl("ol"),e[r].sort().map(i))),t},[])}var n=clearEl(getEl("permissionTable")),o=makeEl("ul");addEl(n,o),R.keys(e).forEach(function(t){e[t]=e[t].map(R.prop("value"))}),R.values(t).forEach(function(t){R.keys(t).forEach(function(i){e[i]=R.difference(e[i],t[i])})}),t[getL10n("admins-have-not-owner")]=e;var a={characters:getL10n("admins-characters"),stories:getL10n("admins-stories"),groups:getL10n("admins-groups")},s=Object.keys(t).sort(CommonUtils.charOrdA);addEls(o,s.reduce(function(e,n){return e.push(i(n)),e.push(addEls(makeEl("ol"),r(t[n]))),e},[]))},AccessManager.createUser=function(){var e=getEl("userNameInput"),t=e.value.trim();if(""===t)return void Utils.alert(getL10n("admins-user-name-is-not-specified"));var i=getEl("userPasswordInput"),r=i.value.trim();return""===r?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.isUserNameUsed(t,function(e,i){return e?void Utils.handleError(e):void(i?Utils.alert(getL10n("admins-user-already-exists")):DBMS.createUser(t,r,Utils.processError(AccessManager.refresh)))})},AccessManager.changePassword=function(){var e=getEl("passwordUserName").value.trim(),t=getEl("newPassword").value.trim();return""===t?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.changePassword(e,t,Utils.processError(AccessManager.refresh))},AccessManager.removeUser=function(){var e=getEl("userRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-user-remove"),[e]))&&DBMS.removeUser(e,Utils.processError(AccessManager.refresh))},AccessManager.getSelectedOptions=function(e){for(var t=getEl(e).selectedOptions,i=[],r=0;r<t.length;r++)i.push(t[r].value);return i},AccessManager.permissionAction=function(e){return function(){var t=getEl("userPermissionSelector").value.trim();if(""===t)return void Utils.alert(getL10n("admins-user-is-not-selected"));var i={};AccessManager.entities.forEach(function(e){i[e]=AccessManager.getSelectedOptions("permission-selector__"+e)}),DBMS[e](t,i,Utils.processError(AccessManager.refresh))}},AccessManager.removePermission=AccessManager.permissionAction("removePermission"),AccessManager.assignPermission=AccessManager.permissionAction("assignPermission"),AccessManager.assignNewAdmin=function(){var e=getEl("newAdminSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-admin-assigment"),[e]))&&DBMS.assignAdmin(e,Utils.processError(AccessManager.refresh))},AccessManager.removeEditor=function(){DBMS.removeEditor(Utils.processError(AccessManager.refresh))},AccessManager.assignEditor=function(){var e=getEl("newEditorSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-editor-assigment"),[e]))&&DBMS.assignEditor(e,Utils.processError(AccessManager.refresh))},AccessManager.changeAdaptationRightsMode=function(e){DBMS.changeAdaptationRightsMode(e.target.value,Utils.processError())};var BriefingExport={};BriefingExport.templates={},BriefingExport.init=function(){listen(getEl("makeDefaultTextBriefings"),"click",function(){BriefingExport.resolveTextTemplate(function(e){BriefingExport.makeTextBriefings("txt",e)})}),listen(getEl("makeCustomTextBriefings"),"click",function(){BriefingExport.makeTextBriefings(getEl("textTypeSelector").value,getEl("templateArea").value)});var e=getEl("docxBriefings");e.addEventListener("change",BriefingExport.readTemplateFile);for(var t=document.querySelectorAll("#briefingExportDiv input[name=exportSelection]"),i=0;i<t.length;i++)listen(t[i],"change",BriefingExport.onExportSelectionChange);getEl("exportSelectionAll").checked=!0,e=getEl("briefingNumberSelector"),Constants.briefingNumber.forEach(R.compose(addEl(e),makeOpt)),listen(e,"change",BriefingExport.onNumberSelectorChange),BriefingExport.briefingNumberSelector=e,BriefingExport.briefingIntervalSelector=getEl("briefingIntervalSelector"),BriefingExport.briefingMultiSelector=getEl("briefingMultiSelector"),getEl("makeBriefingsByTime ".trim()).addEventListener("click",BriefingExport.makeExport("templateByTime")),getEl("makeBriefingsByStory".trim()).addEventListener("click",BriefingExport.makeExport("templateByStory")),getEl("makeInventoryList   ".trim()).addEventListener("click",BriefingExport.makeExport("inventoryTemplate")),UI.initTabPanel("exportModeButton","exportContainer"),listen(getEl("previewTextOutput"),"click",BriefingExport.previewTextOutput),getEl("textBriefingPreviewArea").value="",listen(getEl("showRawData"),"click",BriefingExport.previewTextDataAsIs),listen(getEl("convertToDocxTemplate"),"click",BriefingExport.convertToDocxTemplate),listen(getEl("generateByDocxTemplate"),"click",BriefingExport.generateByDocxTemplate),BriefingExport.briefingSelector=getEl("briefingSelector"),BriefingExport.briefingMultiSelect=getEl("briefingMultiSelect"),BriefingExport.content=getEl("briefingExportDiv")},BriefingExport.refresh=function(){BriefingExport.resolveTextTemplate(function(e){getEl("templateArea").value=e,BriefingExport.onNumberSelectorChange()})},BriefingExport.resolveTextTemplate=function(e){DBMS.getAllProfileSettings(function(t,i){if(t)return void Utils.handleError(t);var r=R.compose(R.join(""),R.insert(1,R.__,["{{profileInfo-","}}\n"]),R.prop("name")),n=R.compose(R.equals(!0),R.prop("doExport")),o=i.filter(n).map(r).join("");e(R.replace(/\{0\}/g,o,TEXT_TEMPLATE))})},BriefingExport.onExportSelectionChange=function(e){var t="exportSelectionSpecific"===e.target.id,i="exportSelectionMultiple"===e.target.id;setClassByCondition(BriefingExport.briefingSelector,"hidden",!t),setClassByCondition(BriefingExport.briefingMultiSelect,"hidden",!i)},BriefingExport.getSelectedUsers=function(){var e=getSelectedRadio("#briefingExportDiv input[name=exportSelection]").id;switch(e){case"exportSelectionAll":return null;case"exportSelectionSpecific":return JSON.parse(BriefingExport.briefingIntervalSelector.selectedOptions[0].value);case"exportSelectionMultiple":for(var t=BriefingExport.briefingMultiSelector.selectedOptions,i={},r=0;r<t.length;r++)i[t[r].value]=!0;return i;default:Utils.alert("unexpected id: "+e)}return null},BriefingExport.onNumberSelectorChange=function(){var e,t,i,r=(clearEl(BriefingExport.briefingIntervalSelector),clearEl(BriefingExport.briefingMultiSelector)),n=Number(BriefingExport.briefingNumberSelector.value);PermissionInformer.getCharacterNamesArray(!1,function(o,a){if(o)return void Utils.handleError(o);if(a.length>0){e=arr2Chunks(a,n);var s=e.map(function(e){return t=1===e.length?e[0].displayName:e[0].displayName+" - "+e[e.length-1].displayName,i=JSON.stringify(e.reduce(function(e,t){return e[t.value]=!0,e},{})),{id:i,text:t}});$("#"+BriefingExport.briefingIntervalSelector.id).select2({data:s}),fillSelector(r,a.map(remapProps4Select))}})},BriefingExport.makeExport=function(e){return function(){BriefingExport.templates[e]||(BriefingExport.templates[e]=atob(templatesArr[e])),BriefingExport.exportDocxByTemplate(BriefingExport.templates[e])}},BriefingExport.getBriefingData=function(e){DBMS.getBriefingData(BriefingExport.getSelectedUsers(),function(t,i){return t?void Utils.handleError(t):void DBMS.getAllProfileSettings(function(t,r){if(t)return void Utils.handleError(t);var n=r.filter(function(e,t){return"checkbox"===e.type}).map(R.prop("name"));i.briefings.forEach(function(e){e.profileInfoArray.forEach(function(e){-1!=n.indexOf(e.itemName)&&(e.value=constL10n(Constants[e.value]),e.splittedText=[{string:e.value}])}),n.forEach(function(t){e["profileInfo-"+t]=constL10n(Constants[e["profileInfo-"+t]])})}),e(null,i)})})},BriefingExport.exportDocxByTemplate=function(e){BriefingExport.getBriefingData(function(t,i){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",e),BriefingExport.generateSingleDocx("Uint8Array",e))})},BriefingExport.convertToDocxTemplate=function(){var e=BriefingExport.makeDocxTemplate("blob");Utils.confirm(getL10n("briefings-save-file"))&&saveAs(e,"template.docx")},BriefingExport.generateByDocxTemplate=function(){BriefingExport.exportDocxByTemplate(BriefingExport.makeDocxTemplate("Uint8Array"))},BriefingExport.makeDocxTemplate=function(e){var t=getEl("templateArea").value,i=R.pipe(R.replace(/{{{/g,"{"),R.replace(/}}}/g,"}"),R.replace(/{{/g,"{"),R.replace(/}}/g,"}"));t=i(t).split("\n").map(function(e){return{string:e}}),BriefingExport.templates.genericTemplate||(BriefingExport.templates.genericTemplate=atob(templatesArr.genericTemplate));var r=new window.Docxgen(BriefingExport.templates.genericTemplate);return r.setData({splittedText:t}),r.render(),r.getZip().generate({type:e})},BriefingExport.previewTextDataAsIs=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=JSON.stringify(t,null,"  "))})},BriefingExport.previewTextOutput=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=BriefingExport.generateSingleTxt(getEl("templateArea").value,t))})},BriefingExport.makeTextBriefings=function(e,t){var i=BriefingExport.generateSingleTxt(t);BriefingExport.getBriefingData(function(t,r){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(r,e,function(e){var t=i(e);return new Blob([t],{type:"text/plain;charset=utf-8"})},i)})},BriefingExport.readTemplateFile=function(e){var t=e.target.files[0];if(t){var i=new FileReader;i.onload=function(e){var t=e.target.result;BriefingExport.getBriefingData(function(e,i){return e?void Utils.handleError(e):void BriefingExport.generateBriefings(i,"docx",BriefingExport.generateSingleDocx("blob",t),BriefingExport.generateSingleDocx("Uint8Array",t))})},i.readAsBinaryString(t)}else Utils.alert(getL10n("briefings-error-on-template-uploading"))};var updateStatus=function(e){var t=getEl("exportStatus");clearEl(t),t.appendChild(makeText(e))};BriefingExport.generateBriefings=function(e,t,i,r){var n,o,a=getEl("toSeparateFileCheckbox").checked,s="briefings";updateStatus(getL10n("briefings-save-preparing"));try{if(a){var l=new JSZip;l.generate();updateStatus(getL10n("briefings-start-saving"));var h=BriefingExport.makeArchiveData(e,r);for(var c in h)l.file(c+"."+t,h[c]);updateStatus(getL10n("briefings-archiving")),o=l.generate({type:"blob"}),updateStatus(getL10n("briefings-archive-is-ready")),BriefingExport.saveFile("briefings-save-archive",o,s+".zip")}else updateStatus(getL10n("briefings-start-saving")),n=i(e),updateStatus(getL10n("briefings-file-is-ready")),BriefingExport.saveFile("briefings-save-file",n,s+"."+t)}catch(d){Utils.alert(getL10n("briefings-error-on-generating-briefings")),console.log(d)}},BriefingExport.saveFile=function(e,t,i){Utils.confirm(getL10n(e))&&saveAs(t,i)},BriefingExport.makeArchiveData=function(e,t){var i={};return e.briefings.forEach(function(r,n){i[r.charName]=t({gameName:e.gameName,briefings:[r]}),updateStatus(strFormat(getL10n("briefings-save-status"),[n+1,e.briefings.length]))}),i},BriefingExport.generateSingleDocx=R.curry(function(e,t,i){var r=new window.Docxgen(t);r.setData(i),r.render();var n=r.getZip().generate({type:e});return n}),BriefingExport.generateSingleTxt=R.curry(function(e,t){try{return Mustache.render(e,t)}catch(i){throw Utils.alert(strFormat(getL10n("briefings-template-error"),[i.message])),i}}),function(e){var t;e.init=function(){$("#briefingCharacter").select2().on("change",i);var t=getEl("eventGroupingByStoryRadio");listen(t,"change",e.refresh),t.checked=!0,t=getEl("adaptationsModeRadio"),listen(t,"change",e.refresh),t.checked=!0,listen(getEl("eventGroupingByTimeRadio"),"change",e.refresh),listen(getEl("proofreadingModeRadio"),"change",e.refresh),listen(getEl("hideAllPanelsCheckbox"),"change",e.refresh),listen(getEl("disableHeadersCheckbox"),"change",e.refresh),e.content=getEl("briefingPreviewDiv")},e.refresh=function(){clearEl(getEl("briefingCharacter")),clearEl(getEl("briefingContent")),DBMS.getAllProfileSettings(function(e,i){return e?void Utils.handleError(e):(t=i,void PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);if(t.length>0){var i=DBMS.getSettings();i.BriefingPreview||(i.BriefingPreview={characterName:t[0].value});var r=i.BriefingPreview.characterName,n=t.map(R.prop("value"));-1===n.indexOf(r)&&(i.BriefingPreview.characterName=t[0].value,r=t[0].value);var o=getSelect2Data(t);$("#briefingCharacter").select2(o).val(r).trigger("change")}}))})};var i=function(e){n(e.target.value)},r=function(e){var t=DBMS.getSettings();t.BriefingPreview.characterName=e},n=function(e){r(e);var t=clearEl(getEl("briefingContent")),i=0,n={characterName:e},a=function(){i<o.length?(i++,o[i-1].load(n,a)):o.map(R.prop("make")).forEach(function(e){e(t,n)})};a()},o=[{name:"storyRights",load:function(e,t){PermissionInformer.getStoryNamesArray(!0,function(i,r){return i?void Utils.handleError(i):(e.userStoryNamesMap=R.indexBy(R.prop("value"),r),void t())})},make:function(e,t){}},{name:"profile",load:function(e,t){DBMS.getProfile(e.characterName,function(i,r){return i?void Utils.handleError(i):(e.profile=r,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("briefings-profile")),A(t.profile)))}},{name:"inventory",load:function(e,t){DBMS.getAllInventoryLists(e.characterName,function(i,r){return i?void Utils.handleError(i):(e.allInventoryLists=r,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("briefings-inventory")+" ("+t.allInventoryLists.length+")"),v(t.allInventoryLists,t.characterName,t.userStoryNamesMap)))}},{name:"groups",load:function(e,t){DBMS.getCharacterGroupTexts(e.characterName,function(i,r){return i?void Utils.handleError(i):(e.groupTexts=r,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("header-groups")+" ("+t.groupTexts.length+")"),g(t.groupTexts)))}},{name:"relations",load:function(e,t){DBMS.getAllProfiles(function(i,r){return i?void Utils.handleError(i):void DBMS.getRelationsSummary(e.characterName,function(i,n){return i?void Utils.handleError(i):void PermissionInformer.getCharacterNamesArray(!1,function(i,o){return i?void Utils.handleError(i):(e.relationsSummary=n,e.characterNamesArray=o,e.profiles=r,void t())})})})},make:function(e,t){var i=getL10n("header-relations")+" ("+R.keys(t.relationsSummary.directRelations).length+")";addEl(e,l(makeText(i),m(t.characterName,t.relationsSummary,t.characterNamesArray,t.profiles)))}},{name:"stories",load:function(e,t){t()},make:function(e,t){var i=getEl("eventGroupingByStoryRadio").checked;i?x(e,t.characterName,t.userStoryNamesMap):b(e,t.characterName,t.userStoryNamesMap)}}],a=function(){s(),Utils.enable(e.content,"notEditable",!1)},s=function(){R.ap([UI.resizeTextarea],nl2array(getEl("briefingContent").getElementsByTagName("textarea")).map(function(e){return{target:e}}))},l=function(e,t){var i=addClasses(makeEl("div"),["panel","panel-default"]),r=addClass(addEl(makeEl("h3"),e),"panel-title"),n=setAttr(makeEl("a"),"href","#/"),o=addClass(makeEl("div"),"panel-heading");addEl(i,addEl(o,addEl(n,r)));var a=addClass(makeEl("div"),"panel-body");setClassByCondition(a,"hidden",getEl("hideAllPanelsCheckbox").checked),addEl(i,addEl(a,t));var l=UI.togglePanel(a);return listen(n,"click",function(){l(),s()}),i},h=["character-name","direct-relation","reverse-relation","extra-info"],c=["character-name","direct-relation","extra-info"],d=function(e,t){return[addEl(addClass(makeEl("div"),"bold-cursive"),makeText(e)),makeText(t)]},u=R.curry(function(e,t,i,r,n,o){var a=addClass(makeEl("textarea"),"briefing-relation-area");a.value=r.directRelations[o]||"",listen(a,"change",function(e){DBMS.setCharacterRelation(n,o,e.target.value,Utils.processError())});var s;i?(s=addClass(makeEl("textarea"),"briefing-relation-area"),s.value=r.reverseRelations[o]||"",listen(s,"change",function(e){DBMS.setCharacterRelation(o,n,e.target.value,Utils.processError())})):s=makeEl("span");var l=r.knownCharacters[o],h=[addEl(makeEl("td"),makeText(o)),addEl(makeEl("td"),a)];i&&h.push(addEl(makeEl("td"),s));var c=[addClass(addEl(makeEl("div"),makeText(getL10n("briefings-where-meets"))),"bold-cursive"),addEl(makeEl("div"),makeText(void 0===l?"":R.keys(l).join(", "))),makeEl("br"),addEls(setAttr(makeEl("div"),"toCharacter",o),d(t.value,e[o][t.value]))];return h.push(addEls(makeEl("td"),c)),addEls(makeEl("tr"),h)}),f=function(e,t,i){var r=$("<select></select>"),n=$("<span></span>").append(r);addClass(r[0],"common-select");var o=(r.select2(getSelect2Data(t)),addEl(makeEl("button"),makeText(getL10n("common-add"))));return listen(o,"click",function(){i(r[0].value),t=t.filter(R.compose(R.not,R.equals(r[0].value),R.prop("value"))),clearEl(r[0]),r.select2(getSelect2Data(t))}),addEls(makeEl("div"),[addEl(makeEl("span"),makeText(e)),n[0],o])},p=function(e){var i=$("<select></select>"),r=$("<span></span>").append(i);addClasses(i[0],["common-select","profile-item-select"]);var n=i.select2(arr2Select2(t.map(R.prop("name")).sort()));return n.on("change",e),t[0]&&n.val(t[0].name).trigger("change"),{el:addEls(makeEl("div"),[addEl(makeEl("span"),makeText(getL10n("briefings-profile-item"))),r[0]]),select:i[0]}},m=function(e,t,i,r){i=i.filter(R.compose(R.not,R.equals(e),R.prop("value")));var n=R.union(R.keys(t.directRelations),R.keys(t.reverseRelations)).sort(),o=i.filter(R.compose(R.not,R.contains(R.__,n),R.prop("value"))),a=o.filter(R.compose(R.contains(R.__,R.keys(t.knownCharacters)),R.prop("value"))),s=o.filter(R.compose(R.not,R.contains(R.__,R.keys(t.knownCharacters)),R.prop("value"))),l=getEl("adaptationsModeRadio").checked,m=makeEl("tbody"),g=p(function(e){var t=nl2array(queryElEls(m,"[toCharacter]"));t.map(clearEl).forEach(function(t){var i=getAttr(t,"toCharacter"),n=e.target.value;addEls(t,d(n,r[i][n]))})}),v=u(r,g.select,l,t,e),y=R.compose(addEl(m),v),A=addEls(addClass(makeEl("div"),"entity-management relations-management"),[f(getL10n("briefings-known-characters"),a,y),f(getL10n("briefings-unknown-characters"),s,y),g.el]),b=l?h:c,E=addEl(makeEl("thead"),addEls(makeEl("tr"),b.map(function(e){return addEl(makeEl("th"),makeText(getL10n("briefings-"+e)))}))),x=addEls(addClasses(makeEl("table"),["table"]),[E,m]);return addEls(m,n.filter(function(e){return l?!0:void 0!==t.directRelations[e]}).map(v)),addEls(makeEl("div"),[A,x])},g=function(e){return addEls(makeEl("div"),e.map(function(e){var t=makeEl("div");addEl(t,addEl(makeEl("h4"),makeText(e.groupName)));var i=addEl(makeEl("textarea"),makeText(e.text));return setAttr(i,"disabled","disabled"),addClass(i,"briefingTextSpan"),addEl(t,i)}))},v=function(e,t,i){var r;return r=makeEl("tbody"),e.forEach(function(e){var n=makeEl("input");n.value=e.inventory,n.storyName=e.storyName,n.characterName=t,addClass(n,"inventoryInput"),i[e.storyName]||addClass(n,"notEditable"),n.addEventListener("change",k),addEl(r,y(makeText(e.storyName),n))}),addEl(addClasses(makeEl("table"),["table","table-striped"]),r)},y=function(e,t){return addEls(makeEl("tr"),[addEl(makeEl("td"),e),addEl(makeEl("td"),t)])},A=function(e){var i,r,n;return i=makeEl("tbody"),t.forEach(function(t){if(t.doExport){switch(r=makeText(t.name),t.type){case"text":n=addClass(makeEl("span"),"briefingTextSpan"),addEl(n,makeText(e[t.name]));break;case"enum":case"number":case"string":n=makeText(e[t.name]);break;case"checkbox":n=makeText(constL10n(Constants[e[t.name]]))}addEl(i,y(r,n))}}),addEl(addClasses(makeEl("table"),["table","table-striped"]),i)},b=function(e,t,i){DBMS.getCharacterEventsByTime(t,function(r,n){if(r)return void Utils.handleError(r);var o=n.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(o,function(r,o){if(r)return void Utils.handleError(r);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!0},h=5;addEls(e,R.splitEvery(h,n).map(function(e,i){var r,n=addEls(makeEl("div"),e.map(function(e,r){return s.index=i*h+1+r,_(e,t,s)}));return r=getEl("disableHeadersCheckbox").checked?makeText(strFormat(getL10n("briefings-events-header"),[i*h+1,i*h+e.length])):addEls(makeEl("div"),e.map(function(e){return w(e,!0)})),l(r,n)})),a()})})},E=function(e,t){var i;return i=getEl("disableHeadersCheckbox").checked?strFormat(getL10n("briefings-story-header"),[t+1]):e.storyName,makeText(i+" ("+e.events.length+")")},x=function(e,t,i){DBMS.getCharacterEventGroupsByStory(t,function(r,n){if(r)return void Utils.handleError(r);var o=n.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(o,function(r,o){if(r)return void Utils.handleError(r);var s={userStoryNamesMap:i,areAdaptationsEditable:o,showStoryName:!1};addEls(e,n.map(function(e,i){var r=addEls(makeEl("div"),e.events.map(function(e,i){return s.index=i+1,_(e,t,s)}));return l(E(e,i),r)})),a()})})},w=function(e,t){var i=addEl(makeEl("span"),makeText(strFormat("{0} {1}",[t?e.storyName+":":"",e.name]))),r=addClass(addEl(makeEl("span"),makeText(e.time)),"previewEventTime");return addEls(makeEl("div"),[r,i])},T=function(e,t,i){return getEl("disableHeadersCheckbox").checked?addEl(makeEl("h4"),makeText(strFormat(getL10n("briefings-event-header"),[i]))):addEl(makeEl("h4"),w(e,t))},_=function(e,t,i){var r=makeEl("div"),n=getEl("adaptationsModeRadio").checked,o=(e.text,e.characters[t].text),a=!!i.userStoryNamesMap[e.storyName],s=i.areAdaptationsEditable[e.storyName+"-"+t],l=""===o,h=[];h.push(T(e,i.showStoryName,i.index)),h.push(makeText(getL10n("briefings-subjective-time"))),h.push(UI.makeAdaptationTimeInput(e.storyName,e,t,s));var c;if(n||l){c=makeEl("textarea"),addClass(c,"briefingPersonalStory"),setClassByCondition(c,"notEditable",!a),c.value=e.text,c.eventIndex=e.index,c.storyName=e.storyName,listen(c,"change",M),S(c);var d=C(c,a),u=makeEl("div");addEls(u,[addEl(makeEl("h5"),makeText(getL10n("briefings-origin"))),d,c]),h.push(u)}if(n||!l){c=makeEl("textarea"),addClass(c,"briefingPersonalStory"),setClassByCondition(c,"notEditable",!s),c.value=e.characters[t].text,c.characterName=t,c.eventIndex=e.index,c.storyName=e.storyName,listen(c,"change",P),S(c);var f=makeEl("div");addEls(f,[addEl(makeEl("h5"),makeText(getL10n("briefings-adaptation"))),c,makeEl("br")]),h.push(f)}return addEls(r,h),r},S=function(e){listen(e,"keydown",UI.resizeTextarea),listen(e,"paste",UI.resizeTextarea),listen(e,"cut",UI.resizeTextarea),listen(e,"change",UI.resizeTextarea),listen(e,"drop",UI.resizeTextarea)},C=function(e,t){e.setAttribute("disabled","disabled");var i=addEl(makeEl("button"),makeText(getL10n("briefings-unlock-event-source")));return setClassByCondition(i,"notEditable",!t),listen(i,"click",function(){e.removeAttribute("disabled")}),i},k=function(e){var t=e.target;DBMS.updateCharacterInventory(t.storyName,t.characterName,t.value,Utils.processError())},M=function(e){var t=e.target.storyName,i=e.target.eventIndex,r=e.target.value;DBMS.setOriginEventText(t,i,r,Utils.processError())},P=function(e){var t=e.target.storyName,i=e.target.eventIndex,r=e.target.characterName,n=e.target.value;DBMS.setAdaptationEventText(t,i,r,n,Utils.processError())}}(this.BriefingPreview={});var Briefings={};Briefings.init=function(){var e=Briefings;e.views={};var t="briefingsNavigation",i="briefingsContent",r={root:e,navigation:getEl(t),content:getEl(i)};Utils.addView(r,"briefing-preview",BriefingPreview,{mainPage:!0}),Utils.addView(r,"briefing-export",BriefingExport),Briefings.content=getEl("briefingsDiv")},Briefings.refresh=function(){Briefings.currentView.refresh()};var CharacterFilter={};CharacterFilter.init=function(){listen(getEl("profileItemSelector"),"change",UI.showSelectedEls("-dependent")),listen(queryEl("#characterFilterDiv .create-entity-button"),"click",Groups.createGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .rename-entity-button"),"click",Groups.renameGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .remove-entity-button"),"click",Groups.removeGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .show-entity-button"),"click",CharacterFilter.loadFilterFromGroup),listen(queryEl("#characterFilterDiv .save-entity-button"),"click",CharacterFilter.saveFilterToGroup),listen(queryEl("#download-filter-table"),"click",CharacterFilter.downloadFilterTable),CharacterFilter.content=getEl("characterFilterDiv")},CharacterFilter.groupAreaRefresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(e){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(t){Groups.rebuildInterface("#characterFilterDiv",e);var i=getSelect2Data(t);clearEl(queryEl("#characterFilterDiv .save-entity-select")),$("#characterFilterDiv .save-entity-select").select2(i)}))}))},CharacterFilter.refresh=function(){CharacterFilter.sortKey=Constants.CHAR_NAME,CharacterFilter.sortDir="asc",CharacterFilter.inputItems={},CharacterFilter.checkboxes={};var e=clearEl(queryEl("#characterFilterDiv .filter-settings-panel"));addEl(e,addClass(makeEl("div"),"separator")),CharacterFilter.groupAreaRefresh(),FilterConfiguration.makeFilterConfiguration(function(t,i){if(t)return void Utils.handleError(t);CharacterFilter.filterConfiguration=i;var r=i.getAllProfileSettings();addEls(e,r.map(CharacterFilter.makeInput)),UI.fillShowItemSelector(clearEl(getEl("profileItemSelector")),CharacterFilter.getShowProfileItemNames(r)),addEl(clearEl(getEl("filterHead")),CharacterFilter.makeContentHeader(CharacterFilter.getHeaderProfileItemNames(r))),CharacterFilter.rebuildContent()})},CharacterFilter.getShowProfileItemNames=function(e){return R.map(R.prop("displayName"),e.filter(R.prop("canHide")))},CharacterFilter.getHeaderProfileItemNames=function(e){return R.map(R.pick(["name","displayName"]),e)},CharacterFilter.makePrintData=function(){var e=CharacterFilter.filterConfiguration.getDataArrays(CharacterFilter.makeFilterModel()),t=CommonUtils.charOrdAFactoryBase(CharacterFilter.sortDir,function(e){var t=CommonUtils.arr2map(e,"itemName"),i=t[CharacterFilter.sortKey],r=i.value;switch(i.type){case"text":case"string":case"enum":r=r.toLowerCase()}return r});return e.sort(t)},CharacterFilter.rebuildContent=function(){var e=CharacterFilter.makePrintData();addEl(clearEl(getEl("filterResultSize")),makeText(e.length)),addEls(clearEl(getEl("filterContent")),e.map(CharacterFilter.makeDataString)),UI.showSelectedEls("-dependent")({target:getEl("profileItemSelector")})},CharacterFilter.saveFilterToGroup=function(){var e=queryEl("#characterFilterDiv .save-entity-select").value.trim();PermissionInformer.isGroupEditable(e,function(t,i){return t?void Utils.handleError(t):i?void DBMS.saveFilterToGroup(e,CharacterFilter.makeFilterModel(),Utils.processError()):void Utils.alert(strFormat(getL10n("groups-group-editing-forbidden"),[e]))})},CharacterFilter.loadFilterFromGroup=function(){var e=queryEl("#characterFilterDiv .save-entity-select").value.trim();DBMS.getGroup(e,function(e,t){if(e)return void Utils.handleError(e);var i=CommonUtils.isFilterModelCompatibleWithProfiles(CharacterFilter.filterConfiguration.getBaseProfileSettings(),t.filterModel);return 0!=i.length?void Utils.alert(strFormat(getL10n("groups-base-filter-is-incompatible-with-page-profiles"),[i.join(",")])):(CharacterFilter.applyFilterModel(t.filterModel),void CharacterFilter.rebuildContent())})},CharacterFilter.downloadFilterTable=function(){function e(e){if(!("string"==typeof e||e instanceof String))return e;var t=e.replace(/"/g,'""');return t.search(/("|,|\n)/g)>=0&&(t='"'+t+'"'),t}for(var t=getEl("profileItemSelector"),i=[!0],r=0;r<t.options.length;r+=1)i[r+1]=t.options[r].selected;var n=CharacterFilter.makePrintData(),o="\ufeff"+n.map(function(t){return t.filter(function(e,t){return i[t]}).map(R.pipe(R.prop("value"),e)).join(";")}).join("\n"),a=new Blob([o],{type:"text/csv;charset=utf-8;"});saveAs(a,"table.csv")},CharacterFilter.applyFilterModel=function(e){var e=CommonUtils.arr2map(e,"name");Object.keys(CharacterFilter.inputItems).forEach(function(t){if(!t.endsWith(":numberInput")){var i,r=CharacterFilter.inputItems[t];if(CharacterFilter.checkboxes[t].checked!=(null!=e[t])&&CharacterFilter.checkboxes[t].click(),e[t]){var n=e[t];switch(r.selfInfo.type){case"enum":for(i=0;i<r.options.length;i+=1)r.options[i].selected=!!n.selectedOptions[r.options[i].value];break;case"checkbox":r.options[0].selected=n.selectedOptions["true"],r.options[1].selected=n.selectedOptions["false"];break;case"number":r.value=n.condition,CharacterFilter.inputItems[r.selfInfo.name+":numberInput"].value=n.num;break;case"text":case"string":r.value=n.regexString}}else switch(r.selfInfo.type){case"enum":case"checkbox":for(i=0;i<r.options.length;i+=1)r.options[i].selected=!0;break;case"number":CharacterFilter.inputItems[r.selfInfo.name+":numberInput"].value=0,r.value="ignore";break;case"text":case"string":r.value=""}}})},CharacterFilter.makeFilterModel=function(){var e=[];return Object.keys(CharacterFilter.inputItems).forEach(function(t){if(!t.endsWith(":numberInput")&&CharacterFilter.checkboxes[t].checked!==!1){var i,r,n,o,a=CharacterFilter.inputItems[t];
switch(a.selfInfo.type){case"enum":for(i={},o=0,n=0;n<a.options.length;n+=1)a.options[n].selected&&(i[a.options[n].value]=!0,o++);if(a.options.length==o)return;e.push({type:"enum",name:t,selectedOptions:i});break;case"checkbox":if(i={},a.options[0].selected&&a.options[1].selected)return;a.options[0].selected&&(i["true"]=!0),a.options[1].selected&&(i["false"]=!0),e.push({type:"checkbox",name:t,selectedOptions:i});break;case"number":if("ignore"===a.value)return;r=Number(CharacterFilter.inputItems[a.selfInfo.name+":numberInput"].value),e.push({type:"number",name:t,num:r,condition:a.value});break;case"text":case"string":if(""==a.value)return;e.push({type:a.selfInfo.type,name:t,regexString:a.value.toLowerCase()})}}}),e},CharacterFilter.makeDataString=function(e){var t,i,r,n=CharacterFilter.inputItems;return addEls(makeEl("tr"),e.map(function(e,o){return r=e.value,"checkbox"===e.type?r=constL10n(Constants[r]):"text"===e.type&&(i=r.toLowerCase().indexOf(n[e.itemName].value.toLowerCase()),r=r.substring(i-5,i+15)),t=addEl(makeEl("td"),makeText(r)),addClass(t,o-1+"-dependent"),t}))},CharacterFilter.makeContentHeader=function(e){return addEls(makeEl("tr"),e.map(function(e,t){var i=addEls(makeEl("th"),[makeText(e.displayName),makeEl("span")]);return i.info=e.name,addClass(i,t-1+"-dependent"),listen(i,"click",CharacterFilter.onSortChange),i}))},CharacterFilter.onSortChange=function(e){var t=e.target;if("span"===t.tagName.toLowerCase()&&(t=t.parentElement),CharacterFilter.sortKey===t.info)CharacterFilter.sortDir="asc"===CharacterFilter.sortDir?"desc":"asc",setClassByCondition(t,"sortDesc","desc"===CharacterFilter.sortDir),setClassByCondition(t,"sortAsc","asc"===CharacterFilter.sortDir);else{var i=getEl("filterHead");nl2array(i.getElementsByClassName("sortAsc")).forEach(removeClass(R.__,"sortAsc")),nl2array(i.getElementsByClassName("sortDesc")).forEach(removeClass(R.__,"sortDesc")),CharacterFilter.sortKey=t.info,CharacterFilter.sortDir="asc",addClass(t,"sortAsc")}CharacterFilter.rebuildContent()},CharacterFilter.makeInput=function(e){var t=makeEl("div"),i=makeEl("label"),r=makeEl("input");r.type="checkbox",r.checked=!1,addEl(i,r),addEl(i,makeText(e.displayName));var n=function(e,t){return function(i){setClassByCondition(t,"hidden",!i.target.checked),setClassByCondition(e,"flex-front-element",i.target.checked),CharacterFilter.rebuildContent()}};addEl(t,i);var o=makeEl("div");return addClass(o,"hidden"),addEl(t,o),listen(r,"click",n(t,o)),CharacterFilter.checkboxes[e.name]=r,addEl(o,CharacterFilter.makeFilter(e)),t},CharacterFilter.makeFilter=function(e){switch(e.type){case"text":case"string":return CharacterFilter.makeTextFilter(e);case"enum":return CharacterFilter.makeEnumFilter(e);case"number":return CharacterFilter.makeNumberFilter(e);case"checkbox":return CharacterFilter.makeCheckboxFilter(e)}},CharacterFilter.makeTextFilter=function(e){var t=makeEl("input");return t.selfInfo=e,t.value="",t.addEventListener("input",CharacterFilter.rebuildContent),CharacterFilter.inputItems[e.name]=t,t},CharacterFilter.makeCommonEnumFilter=function(e,t){var i=makeEl("select");return i.selfInfo=e,i.multiple="multiple",i.size=t.length,t.forEach(function(e){var t=makeEl("option");t.selected=!0,t.value=e.name,t.appendChild(makeText(e.displayName)),i.appendChild(t)}),i.addEventListener("change",CharacterFilter.rebuildContent),CharacterFilter.inputItems[e.name]=i,i},CharacterFilter.makeEnumFilter=function(e){var t=e.value.split(",").map(function(e){return{name:e,displayName:e}});return CharacterFilter.makeCommonEnumFilter(e,t)},CharacterFilter.makeCheckboxFilter=function(e){var t=[{name:Constants[!0],displayName:constL10n(Constants[!0])},{name:Constants[!1],displayName:constL10n(Constants[!1])}];return CharacterFilter.makeCommonEnumFilter(e,t)},CharacterFilter.makeNumberFilter=function(e){var t=makeEl("select");t.selfInfo=e,Constants.numberFilter.forEach(function(e){var i=makeEl("option");i.appendChild(makeText(constL10n(e))),i.value=e,t.appendChild(i)}),t.selectedIndex=0,CharacterFilter.inputItems[e.name]=t,t.addEventListener("change",CharacterFilter.rebuildContent);var i=makeEl("input");i.value=0,i.type="number",CharacterFilter.inputItems[e.name+":numberInput"]=i,i.addEventListener("input",CharacterFilter.rebuildContent);var r=makeEl("div");return addEl(r,t),addEl(r,i),r};var CharacterProfile={};CharacterProfile.init=function(){listen(getEl("bioEditorSelector"),"change",CharacterProfile.showProfileInfoDelegate),CharacterProfile.content=getEl("characterProfile")},CharacterProfile.refresh=function(){PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);var i=clearEl(getEl("bioEditorSelector"));t.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e.displayName)),t.value=e.value,i.appendChild(t)});var r=clearEl(getEl("profileContentDiv")),n=makeEl("table"),o=makeEl("tbody");n.appendChild(o),addClass(n,"table"),r.appendChild(n),CharacterProfile.inputItems={},DBMS.getAllProfileSettings(function(e,r){return e?void Utils.handleError(e):(r.forEach(function(e){CharacterProfile.appendInput(o,e)}),void CharacterProfile.applySettings(t,i))})})},CharacterProfile.applySettings=function(e,t){if(e.length>0){var i=e[0].value,r=DBMS.getSettings();r.CharacterProfile||(r.CharacterProfile={characterName:i});var n=r.CharacterProfile.characterName;-1===e.map(function(e){return e.value}).indexOf(n)&&(r.CharacterProfile.characterName=i,n=i),DBMS.getProfile(n,CharacterProfile.showProfileInfoCallback),t.value=n}},CharacterProfile.appendInput=function(e,t){var i=makeEl("tr"),r=makeEl("td");r.appendChild(makeText(t.name)),i.appendChild(r),r=makeEl("td");var n,o;switch(t.type){case"text":n=makeEl("textarea"),addClass(n,"profileTextInput");break;case"string":n=makeEl("input"),addClass(n,"profileStringInput");break;case"enum":n=makeEl("select"),o=t.value.split(","),o.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e)),n.appendChild(t)});break;case"number":n=makeEl("input"),n.type="number";break;case"checkbox":n=makeEl("input"),n.type="checkbox"}n.addEventListener("change",CharacterProfile.updateFieldValue(t.type)),n.selfName=t.name,addClass(n,"isCharacterEditable"),r.appendChild(n),CharacterProfile.inputItems[t.name]=n,i.appendChild(r),e.appendChild(i)},CharacterProfile.updateFieldValue=function(e){return function(t){var i,r=t.target.selfName,n=CharacterProfile.name;switch(e){case"text":case"string":case"enum":i=t.target.value;break;case"number":if(isNaN(t.target.value))return Utils.alert(getL10n("characters-not-a-number")),void(t.target.value=t.target.oldValue);i=Number(t.target.value);break;case"checkbox":i=t.target.checked}DBMS.updateProfileField(n,r,e,i,Utils.processError())}},CharacterProfile.showProfileInfoDelegate=function(e){var t=e.target.value.trim();DBMS.getProfile(t,CharacterProfile.showProfileInfoCallback)},CharacterProfile.showProfileInfoCallback=function(e,t){if(e)return void Utils.handleError(e);var i=t.name;PermissionInformer.isCharacterEditable(i,function(e,r){if(e)return void Utils.handleError(e);CharacterProfile.updateSettings(i),CharacterProfile.name=i;var n=CharacterProfile.inputItems;Object.keys(n).forEach(function(e){"checkbox"===n[e].type?n[e].checked=t[e]:n[e].value=t[e],n[e].oldValue=t[e],Utils.enable(CharacterProfile.content,"isCharacterEditable",r)})})},CharacterProfile.updateSettings=function(e){var t=DBMS.getSettings();t.CharacterProfile.characterName=e};var CharacterProfileConfigurer={};CharacterProfileConfigurer.init=function(){var e=clearEl(getEl("profileItemTypeSelector")),t=function(){CharacterProfileConfigurer.fillSelector(clearEl(e))};t(),L10n.onL10nChange(t),listen(getEl("createProfileItemButton"),"click",CharacterProfileConfigurer.createProfileItem),listen(getEl("moveProfileItemButton"),"click",CharacterProfileConfigurer.moveProfileItem),listen(getEl("removeProfileItemButton"),"click",CharacterProfileConfigurer.removeProfileItem),CharacterProfileConfigurer.content=getEl("characterProfileConfigurer")},CharacterProfileConfigurer.refresh=function(){var e=[];e.push(getEl("profileItemPositionSelector")),e.push(getEl("moveProfileItemPositionSelector")),DBMS.getAllProfileSettings(function(t,i){if(t)return void Utils.handleError(t);var r;e.forEach(function(e){clearEl(e);var t=function(t){addEl(e,addEl(makeEl("option"),makeText(t)))};i.forEach(function(e){t(strFormat(getL10n("common-set-item-before"),[e.name]))}),t(getL10n("common-set-item-as-last")),e.selectedIndex=i.length});var n=clearEl(getEl("profileConfigBlock"));i.forEach(function(e,t){addEl(n,CharacterProfileConfigurer.getInput(e,t+1))}),PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(CharacterProfileConfigurer.content,"adminOnly",t)});var o=[];o.push(getEl("moveProfileItemSelector")),o.push(getEl("removeProfileItemSelector")),o.forEach(function(e){clearEl(e),i.forEach(function(t,i){r=makeEl("option"),r.appendChild(makeText(t.name)),r.profileItemIndex=i,e.appendChild(r)})})})},CharacterProfileConfigurer.createProfileItem=function(){var e=getEl("profileItemNameInput").value.trim();CharacterProfileConfigurer.validateProfileItemName(e,function(){var t=getEl("profileItemTypeSelector").value.trim();if(!Constants.profileFieldTypes[t])return void Utils.alert(strFormat(getL10n("characters-unknown-profile-item-type"),[t]));var i=Constants.profileFieldTypes[t].value,r=getEl("profileItemPositionSelector"),n=r.value;DBMS.createProfileItem(e,t,i,n===getL10n("common-set-item-as-last"),r.selectedIndex,Utils.processError(CharacterProfileConfigurer.refresh))})},CharacterProfileConfigurer.moveProfileItem=function(){var e=getEl("moveProfileItemSelector").selectedOptions[0].profileItemIndex,t=getEl("moveProfileItemPositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("characters-profile-item-positions-are-equal")):void DBMS.moveProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.removeProfileItem=function(){var e=getEl("removeProfileItemSelector").selectedIndex,t=getEl("removeProfileItemSelector").value;Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-removing-profile-item"),[t]))&&DBMS.removeProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.fillSelector=function(e){var t=function(e,t){return setProp(addEl(makeEl("option"),makeText(t)),"value",e)};R.values(Constants.profileFieldTypes).forEach(function(i){addEl(e,t(i.name,constL10n(i.name)))})},CharacterProfileConfigurer.getInput=function(e,t){var i=makeEl("tr"),r=R.compose(addEl(i),function(e){return addEl(makeEl("td"),e)});r(addEl(makeEl("span"),makeText(t)));var n=setProps(makeEl("input"),{value:e.name,info:e.name});listen(n,"change",CharacterProfileConfigurer.renameProfileItem),addClass(n,"itemNameInput"),addClass(n,"adminOnly"),r(n);var o=makeEl("select");CharacterProfileConfigurer.fillSelector(o),setProps(o,{value:e.type,info:e.name,oldType:e.type}),listen(o,"change",CharacterProfileConfigurer.changeProfileItemType),addClass(o,"adminOnly"),r(o);var a="text"==e.type||"enum"==e.type;switch(n=a?makeEl("textarea"):makeEl("input"),setProps(n,{info:e.name,infoType:e.type,oldValue:e.value}),addClass(n,"adminOnly"),addClass(n,"profile-configurer-"+e.type),e.type){case"text":case"string":case"enum":n.value=e.value;break;case"number":n.type="number",n.value=e.value;break;case"checkbox":n.type="checkbox",n.checked=e.value}listen(n,"change",CharacterProfileConfigurer.updateDefaultValue),r(n);var n=setProps(makeEl("input"),{checked:e.doExport,info:e.name,type:"checkbox"});return listen(n,"change",CharacterProfileConfigurer.doExportChange),addClass(n,"adminOnly"),r(n),i},CharacterProfileConfigurer.updateDefaultValue=function(e){var t,i=e.target.info,r=e.target.infoType,n=e.target.oldValue;switch(r){case"text":case"string":case"number":case"enum":t=e.target.value;break;case"checkbox":t=e.target.checked}var o,a,s,l,h;switch(r){case"text":case"string":case"checkbox":DBMS.updateDefaultValue(i,t,Utils.processError());break;case"number":if(isNaN(t))return Utils.alert(getL10n("characters-not-a-number")),void(e.target.value=n);DBMS.updateDefaultValue(i,Number(t),Utils.processError());break;case"enum":if(""===t)return Utils.alert(getL10n("characters-enum-item-cant-be-empty")),void(e.target.value=n);if(o=n.split(","),a=t.split(","),a=a.map(function(e){return e.trim()}),s=[{}].concat(a).reduce(function(e,t){return e[t]=!0,e}),l=o.filter(function(e){return!s[e]}),0!==l.length)return Utils.confirm(strFormat(getL10n("characters-new-enum-values-remove-some-old-values"),[l.join(",")]))?(h=a.join(","),e.target.value=h,void DBMS.updateDefaultValue(i,h,Utils.processError())):void(e.target.value=n);h=a.join(","),e.target.value=h,DBMS.updateDefaultValue(i,h,Utils.processError())}},CharacterProfileConfigurer.doExportChange=function(e){DBMS.doExportProfileItemChange(e.target.info,e.target.checked,Utils.processError())},CharacterProfileConfigurer.renameProfileItem=function(e){var t=e.target.value.trim(),i=e.target.info;CharacterProfileConfigurer.validateProfileItemName(t,function(){DBMS.renameProfileItem(t,i,Utils.processError(CharacterProfileConfigurer.refresh))},function(){e.target.value=e.target.info})},CharacterProfileConfigurer.validateProfileItemName=function(e,t,i){if(""===e)return Utils.alert(getL10n("characters-profile-item-name-is-not-specified")),void(i&&i());if("name"===e)return Utils.alert(getL10n("characters-profile-item-name-cant-be-name")),void(i&&i());var r=function(){Utils.alert(getL10n("characters-such-name-already-used")),i&&i()};DBMS.isProfileItemNameUsed(e,function(e,i){return e?void Utils.handleError(e):void(i?r():t())})},CharacterProfileConfigurer.changeProfileItemType=function(e){if(Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-changing-profile-item-type"),[e.target.info]))){var t=e.target.value,i=e.target.info;DBMS.changeProfileItemType(i,t,Utils.processError(CharacterProfileConfigurer.refresh))}else e.target.value=e.target.oldType};var Characters={};Characters.init=function(){var e=Characters;e.views={};var t="charactersNavigation",i="charactersContent",r={root:e,navigation:getEl(t),content:getEl(i)};Utils.addView(r,"character-profile",CharacterProfile,{mainPage:!0}),Utils.addView(r,"character-profile-constructor",CharacterProfileConfigurer),listen(queryEl("#charactersDiv .create-entity-button"),"click",Characters.createCharacter),listen(queryEl("#charactersDiv .rename-entity-button"),"click",Characters.renameCharacter),listen(queryEl("#charactersDiv .remove-entity-button"),"click",Characters.removeCharacter),Characters.content=getEl("charactersDiv")},Characters.refresh=function(){PermissionInformer.getCharacterNamesArray(!0,Utils.processError(Characters.rebuildInterface))},Characters.rebuildInterface=function(e){var t=getSelect2Data(e);clearEl(queryEl("#charactersDiv .rename-entity-select")),$("#charactersDiv .rename-entity-select").select2(t),clearEl(queryEl("#charactersDiv .remove-entity-select")),$("#charactersDiv .remove-entity-select").select2(t),Characters.currentView.refresh()},Characters.createCharacter=function(){var e=queryEl("#charactersDiv .create-entity-input").value.trim();return""===e?void Utils.alert(getL10n("characters-character-name-is-not-specified")):void DBMS.isCharacterNameUsed(e,function(t,i){return t?void Utils.handleError(t):void(i?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[e])):DBMS.createCharacter(e,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(e),void Characters.refresh())})}))})},Characters.renameCharacter=function(){var e=queryEl("#charactersDiv .rename-entity-select").value.trim(),t=queryEl("#charactersDiv .rename-entity-input").value.trim();return""===t?void Utils.alert(getL10n("characters-new-character-name-is-not-specified")):e===t?void Utils.alert(getL10n("characters-names-are-the-same")):void DBMS.isCharacterNameUsed(t,function(i,r){return i?void Utils.handleError(i):void(r?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[t])):DBMS.renameCharacter(e,t,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(t),void Characters.refresh())})}))})},Characters.removeCharacter=function(){var e=queryEl("#charactersDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-character-removing"),[e]))&&DBMS.removeCharacter(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Characters.refresh()})})};var Chat={};Chat.init=function(){var e=getEl("sendMessageButton");e.addEventListener("click",Chat.onSubmit),Chat.subscribe(),Chat.content=getEl("chatDiv")},Chat.refresh=function(){},Chat.onSubmit=function(){var e=getEl("chatMessage"),t=$.ajax({url:"/publish",dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify({message:e.value})});return t.done(function(e){}),t.fail(function(e,t,i){alert(e.responseText)}),e.value="",!1},Chat.subscribe=function(){var e=$.ajax({url:"/subscribe",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});e.done(function(e){var t=makeEl("li");t.appendChild(makeText(e)),messages.appendChild(t),Chat.subscribe()}),e.fail(function(e,t,i){setTimeout(Chat.subscribe,500)})};var EventPresence={name:"EventPresence"};EventPresence.init=function(){listen(getEl("eventPresenceSelector"),"change",UI.showSelectedEls("-dependent")),EventPresence.content=getEl("eventPresenceDiv")},EventPresence.refresh=function(){var e=getEl("eventPresenceTableHead"),t=getEl("eventPresenceTable"),i=getEl("eventPresenceSelector");return void 0==Stories.CurrentStoryName?(clearEl(e),clearEl(t),void clearEl(i)):void PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(r,n){return r?void Utils.handleError(r):void PermissionInformer.getCharacterNamesArray(!1,function(r,o){return r?void Utils.handleError(r):void DBMS.getStoryCharacterNamesArray(Stories.CurrentStoryName,function(r,a){if(r)return void Utils.handleError(r);var s={};o.forEach(function(e){s[e.value]=e});var l=a.map(function(e){return s[e]});l.sort(Utils.charOrdAObject);var h=l.map(function(e){return e.displayName}),a=l.map(function(e){return e.value});DBMS.getStoryEvents(Stories.CurrentStoryName,function(r,o){return r?void Utils.handleError(r):(clearEl(e),clearEl(t),UI.fillShowItemSelector(clearEl(i),h,a),EventPresence.appendTableHeader(e,h),void o.forEach(function(e,i){EventPresence.appendTableInput(t,e,i,a),Utils.enable(EventPresence.content,"isStoryEditable",n)}))})})})})},EventPresence.appendTableHeader=function(e,t){var i=makeEl("tr");rAddEl(rAddEl(makeText(getL10n("stories-event")),makeEl("th")),i),t.forEach(function(e,t){rAddEl(rAddEl(makeText(e),rAddClass(t+"-dependent",makeEl("th"))),i)}),e.appendChild(i)},EventPresence.appendTableInput=function(e,t,i,r){var n=makeEl("tr"),o=makeEl("td");o.appendChild(makeText(t.name)),n.appendChild(o),r.forEach(function(e,r){o=addClass(makeEl("td"),"vertical-aligned-td"),addClass(o,r+"-dependent");var a=makeEl("input");addClass(a,"isStoryEditable"),a.type="checkbox",t.characters[e]&&(a.checked=!0),a.eventIndex=i,a.eventName=t.name,a.characterName=e,a.hasText=null!=t.characters[e]&&""!=t.characters[e].text,a.addEventListener("change",EventPresence.onChangeCharacterCheckbox);var s=i+e;setAttr(a,"id",s),addClass(a,"hidden"),addEl(o,a);var l=addClass(makeEl("label"),"checkbox-label");setAttr(l,"for",s),addEl(o,l),n.appendChild(o)}),e.appendChild(n)},EventPresence.onChangeCharacterCheckbox=function(e){e.target.checked?DBMS.addCharacterToEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.hasText?Utils.confirm(strFormat(getL10n("stories-remove-character-from-event-warning"),[e.target.characterName,e.target.eventName]))?DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.checked=!0:DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError())};var Events={};Events.init=function(){listen(getEl("events-storySelector"),"change",Events.updateAdaptationSelectorDelegate),listen(getEl("events-characterSelector"),"change",Events.showPersonalStoriesDelegate),listen(getEl("events-eventSelector"),"change",Events.showPersonalStoriesDelegate2),listen(getEl("finishedStoryCheckbox"),"change",Events.refresh),listen(getEl("adaptationFilterByCharacter"),"change",Events.updateFilter),listen(getEl("adaptationFilterByEvent"),"change",Events.updateFilter),Events.content=getEl("eventsDiv")},Events.getSelectedStoryName=function(e){var t=e.map(R.prop("storyName")),i=DBMS.getSettings();i.Events||(i.Events={storyName:t[0],characterNames:[],eventIndexes:[],selectedFilter:"adaptationFilterByCharacter"});var r=i.Events.storyName;return-1===t.indexOf(r)&&(i.Events.storyName=t[0],r=t[0]),r},Events.getNames=function(e,t,i){var r=e.map(R.prop(t)),n=DBMS.getSettings().Events[i],o=n.filter(function(e){return-1!==r.indexOf(e)});return Events.updateSettings(i,o),o},Events.getCharacterNames=function(e){return Events.getNames(e,"characterName","characterNames")},Events.getEventIndexes=function(e){return Events.getNames(e,"index","eventIndexes")},Events.refresh=function(){var e=clearEl(getEl("events-storySelector"));clearEl(getEl("events-characterSelector")),clearEl(getEl("events-eventSelector")),clearEl(getEl("personalStories")),PermissionInformer.getStoryNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void DBMS.getFilteredStoryNames(getEl("finishedStoryCheckbox").checked,function(t,r){if(t)return void Utils.handleError(t);if(!(r.length<=0)){var n=Events.getSelectedStoryName(r),o=CommonUtils.arr2map(i,"value");r.forEach(function(e){e.displayName=o[e.storyName].displayName,e.value=o[e.storyName].value}),r.sort(Utils.charOrdAObject);var a;r.forEach(function(t){a=addEl(makeEl("option"),makeText(t.displayName+Events.getSuffix(t))),setProp(a,"selected",t.value===n),setProp(a,"storyInfo",t.value),addEl(e,a)}),Events.updateAdaptationSelector(n)}})})},Events.updateAdaptationSelectorDelegate=function(e){var t=e.target.selectedOptions[0].storyInfo;Events.updateSettings("storyName",t),Events.updateSettings("characterNames",[]),Events.updateAdaptationSelector(t)},Events.updateAdaptationSelector=function(e){var t=clearEl(getEl("events-characterSelector")),i=clearEl(getEl("events-eventSelector"));PermissionInformer.getCharacterNamesArray(!1,function(r,n){return r?void Utils.handleError(r):void DBMS.getFilteredCharacterNames(e,getEl("finishedStoryCheckbox").checked,function(r,o){return r?void Utils.handleError(r):void DBMS.getFilteredEventNames(e,getEl("finishedStoryCheckbox").checked,function(r,a){if(r)return void Utils.handleError(r);var s=Events.getCharacterNames(o),l=Events.getEventIndexes(a),h=CommonUtils.arr2map(n,"value");o.forEach(function(e){e.displayName=h[e.characterName].displayName,e.value=h[e.characterName].value}),o.sort(Utils.charOrdAObject);var c;o.forEach(function(i){c=addEl(makeEl("option"),makeText(i.displayName+Events.getSuffix(i))),setProp(c,"selected",-1!==s.indexOf(i.value)),setProp(c,"storyInfo",e),setProp(c,"characterName",i.value),addEl(t,c)}),setAttr(t,"size",o.length),a.forEach(function(t){c=addEl(makeEl("option"),makeText(t.name+Events.getSuffix(t))),setProp(c,"selected",-1!==l.indexOf(t.index)),setProp(c,"storyInfo",e),setProp(c,"eventIndex222",t.index),addEl(i,c)}),setAttr(i,"size",a.length);var d=DBMS.getSettings().Events.selectedFilter;getEl(d).checked=!0,Events.updateFilter({target:{id:d}})})})})},Events.updateFilter=function(e){Events.updateSettings("selectedFilter",e.target.id);var t="adaptationFilterByCharacter"===e.target.id;if(setClassByCondition(getEl("events-characterSelectorDiv"),"hidden",!t),setClassByCondition(getEl("events-eventSelectorDiv"),"hidden",t),t)Events.showPersonalStoriesDelegate({target:getEl("events-characterSelector")});else{var i,r=getEl("events-characterSelector");if(0===r.options.length)return;var n=[];for(i=0;i<r.options.length;i+=1)n.push(r.options[i].characterName);Events.showPersonalStories(r.options[0].storyInfo,n,function(){Events.showPersonalStoriesDelegate2({target:getEl("events-eventSelector")})})}},Events.showPersonalStoriesDelegate=function(e){if(0!=e.target.selectedOptions.length){var t,i=e.target.selectedOptions[0],r=i.storyInfo,n=[],o=e.target;for(t=0;t<o.selectedOptions.length;t+=1)n.push(o.selectedOptions[t].characterName);Events.updateSettings("characterNames",n),Events.showPersonalStories(r,n)}},Events.showPersonalStoriesDelegate2=function(e){var t,i,r=[],n=getEl("events-eventSelector"),o=getEls("eventRow-dependent");for(t=0;t<o.length;t+=1)addClass(o[t],"hidden");for(t=0;t<n.selectedOptions.length;t+=1)i=n.selectedOptions[t].eventIndex222,removeClass(getEls(i+"-dependent")[0],"hidden"),r.push(i);Events.updateSettings("eventIndexes",r)},Events.showPersonalStories=function(e,t,i){DBMS.getMetaInfo(function(r,n){return r?void Utils.handleError(r):void DBMS.getEvents(e,t,function(r,o){return r?void Utils.handleError(r):void PermissionInformer.isStoryEditable(e,function(r,a){if(r)return void Utils.handleError(r);var s=t.map(function(t){return{characterName:t,storyName:e}});PermissionInformer.areAdaptationsEditable(s,function(r,s){return r?void Utils.handleError(r):(Events.buildAdaptationInterface(e,t,o,s,n),Utils.enable(Events.content,"isStoryEditable",a),Utils.enable(Events.content,"notEditable",!1),void(i&&i()))})})})})},Events.buildAdaptationInterface=function(e,t,i,r,n){var o,a,s,l,h,c,d,u,f=clearEl(getEl("personalStories"));R.ap([addEl(f)],i.map(function(i){return o=makeEl("div"),R.ap([addClass(o)],["eventMainPanelRow",i.index+"-dependent","eventRow-dependent"]),a=addClass(makeEl("div"),"eventMainPanelRow-left"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(a,c),addEl(d,addEl(makeEl("div"),makeText(i.name))),addEl(u,UI.makeEventTimePicker({eventTime:i.time,index:i.index,preGameDate:n.preGameDate,date:n.date,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:Events.onChangeDateTimeCreator(e)})),addEl(a,Events.makeOriginTextInput(e,i)),addEl(o,a),a=addClass(makeEl("div"),"eventMainPanelRow-right"),l=addClass(makeEl("div"),"events-eventsContainer"),R.ap([addEl(l)],t.filter(function(e){return i.characters[e]}).map(function(t){return s=addClass(makeEl("div"),"events-singleEventAdaptation"),c=addClass(makeEl("div"),"story-events-div-main"),d=addClass(makeEl("div"),"story-events-div-left"),u=addClass(makeEl("div"),"story-events-div-right"),addEl(c,d),addEl(c,u),addEl(s,c),h=r[e+"-"+t],addEl(d,makeText(t)),addEl(u,UI.makeAdaptationTimeInput(e,i,t,h)),addEl(s,Events.makeAdaptationTextInput(e,i,t,h)),addEl(s,Events.makeAdaptationReadyInput(e,i,t,h)),s})),addEl(o,addEl(a,l)),o}))},Events.onChangeDateTimeCreator=R.curry(function(e,t){return function(i,r){DBMS.updateEventProperty(e,t.eventIndex,"time",r.val(),Utils.processError()),StoryEvents.lastDate=r.val(),removeClass(t,"defaultDate")}}),Events.makeOriginTextInput=function(e,t){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventPersonalStory"),i.value=t.text,i.dataKey=JSON.stringify([e,t.index]),listen(i,"change",Events.onChangeOriginText),i},Events.makeAdaptationTextInput=function(e,t,i,r){var n=makeEl("textarea");return setClassByCondition(n,"notEditable",!r),addClass(n,"eventPersonalStory"),n.value=t.characters[i].text,n.dataKey=JSON.stringify([e,t.index,i]),listen(n,"change",Events.onChangeAdaptationText),n},Events.makeAdaptationReadyInput=function(e,t,i,r){var n=makeEl("div"),o=makeEl("input");return setClassByCondition(o,"notEditable",!r),o.type="checkbox",o.checked=t.characters[i].ready,o.dataKey=JSON.stringify([e,t.index,i]),o.id=t.index+"-"+e+"-"+i,listen(o,"change",Events.onChangeReadyStatus),addEl(n,o),addEl(n,setAttr(addEl(makeEl("label"),makeText(constL10n(Constants.finishedText))),"for",o.id)),n},Events.onChangeReadyStatus=function(e){var t=JSON.parse(e.target.dataKey),i=e.target.checked;DBMS.changeAdaptationReadyStatus(t[0],t[1],t[2],i,Utils.processError())},Events.onChangeOriginText=function(e){var t=JSON.parse(e.target.dataKey),i=e.target.value;DBMS.setOriginEventText(t[0],t[1],i,Utils.processError())},Events.onChangeAdaptationText=function(e){var t=JSON.parse(e.target.dataKey),i=e.target.value;DBMS.setAdaptationEventText(t[0],t[1],t[2],i,Utils.processError())},Events.getSuffix=function(e){return e.isEmpty?constL10n(Constants.emptySuffix):e.isFinished?constL10n(Constants.finishedSuffix):""},Events.updateSettings=function(e,t){var i=DBMS.getSettings();i.Events[e]=t},FilterConfiguration.makeFilterConfiguration=function(e){DBMS.getCharacterFilterInfo(function(t,i){if(t)return void Utils.handleError(t);var r=new FilterConfiguration(i);e(null,r)})},FilterConfiguration.prototype.getAllProfileSettings=function(){return this.innerProfileSettings},FilterConfiguration.prototype.getBaseProfileSettings=function(){return this.info.profileSettings},FilterConfiguration.prototype.getDataArrays=function(e){return CommonUtils.getDataArrays(this.info,e)};var GroupProfile={};GroupProfile.profileSettings=[{name:"filterModel",type:"container"},{name:"characterList",type:"container"},{name:"masterDescription",type:"text"},{name:"doExport",type:"checkbox"},{name:"characterDescription",type:"text"}],GroupProfile.init=function(){listen(queryEl(".group-profile-tab .entity-selector"),"change",GroupProfile.showProfileInfoDelegate);var e=clearEl(queryEl(".group-profile-tab .entity-profile"));GroupProfile.inputItems={},GroupProfile.profileSettings.forEach(function(t){t.displayName=getL10n("groups-"+t.name),addEl(e,GroupProfile.makeInput(t))}),GroupProfile.content=queryEl(".group-profile-tab")},GroupProfile.refresh=function(){PermissionInformer.getGroupNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);var i=clearEl(queryEl(".group-profile-tab .entity-selector"));fillSelector(i,t.map(remapProps4Select)),GroupProfile.applySettings(t,i)})},GroupProfile.applySettings=function(e,t){if(e.length>0){var i=e[0].value,r=DBMS.getSettings();r.GroupProfile||(r.GroupProfile={groupName:i});var n=r.GroupProfile.groupName;-1===e.map(function(e){return e.value}).indexOf(n)&&(r.GroupProfile.groupName=i,n=i),DBMS.getGroup(n,GroupProfile.showProfileInfoCallback),t.value=n}},GroupProfile.makeInput=function(e){var t,i=setAttr(makeEl("span"),"l10n-id","groups-"+e.name),r=addEl(makeEl("tr"),addEl(makeEl("td"),addEl(i,makeText(e.displayName))));switch(e.type){case"text":t=makeEl("textarea"),addClass(t,"profileTextInput"),t.addEventListener("change",GroupProfile.updateFieldValue(e.type));break;case"checkbox":t=makeEl("input"),t.type="checkbox",t.addEventListener("change",GroupProfile.updateFieldValue(e.type));break;case"container":t=makeEl("div"),t.type="container"}return t.selfName=e.name,addClass(t,"isGroupEditable"),GroupProfile.inputItems[e.name]=t,addEl(r,addEl(makeEl("td"),t))},GroupProfile.updateFieldValue=function(e){return function(t){var i,r=t.target.selfName,n=GroupProfile.name;switch(e){case"text":i=t.target.value;break;case"checkbox":i=t.target.checked}DBMS.updateGroupField(n,r,i,Utils.processError())}},GroupProfile.showProfileInfoDelegate=function(e){var t=e.target.value.trim();DBMS.getGroup(t,GroupProfile.showProfileInfoCallback)},GroupProfile.showProfileInfoCallback=function(e,t){if(e)return void Utils.handleError(e);var i=t.name;FilterConfiguration.makeFilterConfiguration(function(e,r){return e?void Utils.handleError(e):void PermissionInformer.isGroupEditable(i,function(e,n){if(e)return void Utils.handleError(e);
CharacterProfile.updateSettings(i),GroupProfile.name=i;var o=GroupProfile.inputItems;Object.keys(o).forEach(function(e){if("checkbox"===o[e].type)o[e].checked=t[e];else if("container"===o[e].type)if("filterModel"===e){var i=clearEl(o[e]),a=makeEl("table");addClass(a,"table");var s=makeEl("tbody");addEls(s,t.filterModel.map(GroupProfile.makeFilterItemString(r))),addEl(a,s),addEl(i,a)}else{var l=r.getDataArrays(t.filterModel).map(function(e){return e[0].value}).sort(),i=clearEl(o[e]);addEl(i,makeText(l.join(", "))),addEl(i,makeEl("br")),addEl(i,makeText(getL10n("groups-total")+l.length))}else o[e].value=t[e];o[e].oldValue=t[e],Utils.enable(GroupProfile.content,"isGroupEditable",n)})})})},GroupProfile.getHeaderDisplayName=function(e,t){return CommonUtils.arr2map(e.getAllProfileSettings(),"name")[t].displayName},GroupProfile.makeFilterItemString=R.curry(function(e,t){var i=makeEl("tr"),r=makeEl("td");addEl(i,r);var n=GroupProfile.getHeaderDisplayName(e,t.name);addEl(r,makeText(n));var o;switch(t.type){case"enum":o=strFormat("{0}",[Object.keys(t.selectedOptions).join(", ")]);break;case"checkbox":var a=[];t.selectedOptions["true"]&&a.push(getL10n("constant-yes")),t.selectedOptions["false"]&&a.push(getL10n("constant-no")),o=strFormat("{0}",[a.join(", ")]);break;case"number":o=strFormat("{0} {1}",[getL10n("constant-"+t.condition),t.num]);break;case"text":case"string":o=strFormat(getL10n("groups-text-contains"),[t.regexString])}return r=makeEl("td"),addEl(i,r),addEl(r,makeText(o)),i}),GroupProfile.updateSettings=function(e){var t=DBMS.getSettings();t.GroupProfile.groupName=e};var Groups={};Groups.init=function(){var e=Groups;e.views={};var t=".groups-tab .sub-tab-navigation",i=".groups-tab .sub-tab-content",r={root:e,navigation:queryEl(t),content:queryEl(i)};Utils.addView(r,"group-profile",GroupProfile,{mainPage:!0}),Utils.addView(r,"group-schema",GroupSchema),Utils.addView(r,"investigation-board",InvestigationBoard),listen(queryEl(".groups-tab .create-entity-button"),"click",Groups.createGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .rename-entity-button"),"click",Groups.renameGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .remove-entity-button"),"click",Groups.removeGroup(".groups-tab",Groups.refresh)),Groups.content=queryEl(".groups-tab")},Groups.refresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(e){Groups.rebuildInterface(".groups-tab",e),Groups.currentView.refresh()}))},Groups.rebuildInterface=function(e,t){var i=getSelect2Data(t);clearEl(queryEl(e+" .rename-entity-select")),$(e+" .rename-entity-select").select2(i),clearEl(queryEl(e+" .remove-entity-select")),$(e+" .remove-entity-select").select2(i)},Groups.createGroup=function(e,t){return function(){var i=queryEl(e+" .create-entity-input").value.trim();return""===i?void Utils.alert(getL10n("groups-group-name-is-not-specified")):void DBMS.isGroupNameUsed(i,function(e,r){return e?void Utils.handleError(e):r?void Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[i])):void DBMS.createGroup(i,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})})})}},Groups.renameGroup=function(e,t){return function(){var i=queryEl(e+" .rename-entity-select").value.trim(),r=queryEl(e+" .rename-entity-input").value.trim();return""===r?void Utils.alert(getL10n("groups-new-group-name-is-not-specified")):i===r?void Utils.alert(getL10n("groups-names-are-the-same")):void DBMS.isGroupNameUsed(r,function(e,n){return e?void Utils.handleError(e):void(n?Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[r])):DBMS.renameGroup(i,r,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})}))})}},Groups.removeGroup=function(e,t){return function(){var i=queryEl(e+" .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("groups-are-you-sure-about-group-removing"),[i]))&&DBMS.removeGroup(i,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})})}};var GroupSchema={};GroupSchema.init=function(){GroupSchema.content=queryEl(".group-schema-tab")},GroupSchema.refresh=function(){DBMS.getGroupSchemas(function(e,t){GroupSchema.redrawSchema(t.theory)})},GroupSchema.redrawSchema=function(e){var t=queryEl(".group-schema-tab .schema-container");GroupSchema.network&&GroupSchema.network.destroy(),e.edges=e.edges.map(function(e){return R.merge(e,{physics:!1})}),GroupSchema.network=new vis.Network(t,e,Constants.groupSchemaOpts)};var InvestigationBoard={};InvestigationBoard.init=function(){listen(queryEl(".investigation-board-tab .group-add-button"),"click",InvestigationBoard.addGroup),listen(queryEl(".investigation-board-tab .group-switch-button"),"click",InvestigationBoard.switchGroup),listen(queryEl(".investigation-board-tab .group-save-notes-button"),"click",InvestigationBoard.setGroupNotes),listen(queryEl(".investigation-board-tab .create-entity-button"),"click",InvestigationBoard.createResource),listen(queryEl(".investigation-board-tab .rename-entity-button"),"click",InvestigationBoard.renameResource),listen(queryEl(".investigation-board-tab .save-edge-button"),"click",InvestigationBoard.saveEdge),listen(queryEl(".investigation-board-tab .cancel-node-adding-button"),"click",InvestigationBoard.cancel(".board-add-node-popup")),listen(queryEl(".investigation-board-tab .cancel-resource-editing-button"),"click",InvestigationBoard.cancel(".board-edit-resource-popup")),listen(queryEl(".investigation-board-tab .cancel-group-editing-button"),"click",InvestigationBoard.cancel(".board-edit-group-popup")),listen(queryEl(".investigation-board-tab .cancel-add-edge-button"),"click",InvestigationBoard.cancel(".board-add-edge-popup")),InvestigationBoard.nodesDataset=new vis.DataSet,InvestigationBoard.edgesDataset=new vis.DataSet;var e={nodes:InvestigationBoard.nodesDataset,edges:InvestigationBoard.edgesDataset},t=queryEl(".investigation-board-tab .schema-container");InvestigationBoard.network=new vis.Network(t,e,Constants.investigationBoardOpts),InvestigationBoard.network.on("selectEdge",InvestigationBoard.showEdgeLabelEditor),InvestigationBoard.network.on("deselectEdge",InvestigationBoard.hideEdgeLabelEditor),InvestigationBoard.content=queryEl(".investigation-board-tab")},InvestigationBoard.refresh=function(e){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(t){DBMS.getInvestigationBoardData(function(i,r){var n=t.map(R.prop("value")),o=R.keys(r.groups),a=R.difference(n,o);clearEl(queryEl(".investigation-board-tab .group-add-select")),$(".investigation-board-tab .group-add-select").select2(arr2Select2(a)),clearEl(queryEl(".investigation-board-tab .group-switch-select")),$(".investigation-board-tab .group-switch-select").select2(arr2Select2(a)),e||InvestigationBoard.redrawBoard(r)})}))},InvestigationBoard.addNode=function(e,t){InvestigationBoard.showPopup(".board-add-node-popup",!0),InvestigationBoard.modifyArgs={newNode:e,callback:t}},InvestigationBoard.addGroup=function(){var e=queryEl(".investigation-board-tab .group-add-select").value.trim();DBMS.addBoardGroup(e,function(t){return t?void Utils.handleError(t):void InvestigationBoard.setNode(e,"groups")})},InvestigationBoard.createResource=function(){var e=queryEl(".investigation-board-tab .create-entity-input").value.trim();DBMS.createResource(e,function(t){return t?void Utils.handleError(t):void InvestigationBoard.setNode(e,"resources")})},InvestigationBoard.setNode=function(e,t){var i=InvestigationBoard.modifyArgs.newNode;"groups"===t?(i.originalLabel=e,i.originalNotes="",i.label=InvestigationBoard.makeDisplayLabel(i.originalLabel,i.originalNotes)):i.label=e,i.id=InvestigationBoard._makeRelNodeId(e,t),i.group=t,InvestigationBoard.showPopup(".board-add-node-popup",!1),InvestigationBoard.refresh(!0),InvestigationBoard.modifyArgs.callback(i)},InvestigationBoard.editNodeFun=function(e,t){InvestigationBoard.modifyArgs={editNode:e,callback:t},"groups"===e.group?InvestigationBoard.editGroup():InvestigationBoard.editResource()},InvestigationBoard.editGroup=function(){InvestigationBoard.showPopup(".board-edit-group-popup",!0),queryEl(".investigation-board-tab .group-notes-editor").value=InvestigationBoard.modifyArgs.editNode.originalNotes},InvestigationBoard.switchGroup=function(){var e=InvestigationBoard.modifyArgs.editNode,t=e.originalLabel,i=queryEl(".investigation-board-tab .group-switch-select").value.trim(),r=InvestigationBoard.modifyArgs.callback;DBMS.switchGroups(t,i,function(t){return t?void Utils.handleError(t):(e.originalLabel=i,e.label=InvestigationBoard.makeDisplayLabel(e.originalLabel,e.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),r(e),void InvestigationBoard.refresh(!0))})},InvestigationBoard.setGroupNotes=function(){var e=InvestigationBoard.modifyArgs.editNode,t=queryEl(".investigation-board-tab .group-notes-editor").value.trim(),i=InvestigationBoard.modifyArgs.callback;DBMS.setGroupNotes(e.originalLabel,t,function(r){return r?void Utils.handleError(r):(e.originalNotes=t,e.label=InvestigationBoard.makeDisplayLabel(e.originalLabel,e.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),i(e),void InvestigationBoard.refresh(!0))})},InvestigationBoard.editResource=function(){InvestigationBoard.showPopup(".board-edit-resource-popup",!0)},InvestigationBoard.renameResource=function(){var e=InvestigationBoard.modifyArgs.editNode,t=e.label,i=queryEl(".investigation-board-tab .rename-entity-input").value.trim(),r=InvestigationBoard.modifyArgs.callback;DBMS.renameResource(t,i,function(t){return t?void Utils.handleError(t):(e.label=i,InvestigationBoard.showPopup(".board-edit-resource-popup",!1),void r(e))})},InvestigationBoard.deleteNode=function(e,t){var i=InvestigationBoard.nodesDataset.get(e.nodes[0]),r="groups"===i.group?"removeBoardGroup":"removeResource",n="groups"===i.group?getL10n("investigation-board-confirm-group-node-removing"):getL10n("investigation-board-confirm-resource-node-removing"),o="groups"===i.group?i.originalLabel:i.label;Utils.confirm(strFormat(n,[o]))?DBMS[r](o,function(i){return i?(Utils.handleError(i),void t()):(InvestigationBoard.refresh(!0),void t(e))}):t()},InvestigationBoard.makeDisplayLabel=function(e,t){function i(e){return e.split("\n").map(R.splitEvery(20)).map(R.join("\n")).join("\n")}return i(e)+(""===t.trim()?"":"\n\n"+i(t))},InvestigationBoard._makeRelNodeId=function(e,t){return("groups"===t?"group-":"resource-")+e},InvestigationBoard.redrawBoard=function(e){function t(e){return{label:e,id:InvestigationBoard._makeRelNodeId(e,"resources")}}function i(e){return{originalLabel:e.name,originalNotes:e.notes,label:InvestigationBoard.makeDisplayLabel(e.name,e.notes),id:InvestigationBoard._makeRelNodeId(e.name,"groups")}}var r=[];r=r.concat(R.values(e.groups).map(i).map(R.merge({group:"groups"}))),r=r.concat(R.keys(e.resources).map(t).map(R.merge({group:"resources"}))),InvestigationBoard.nodesDataset.clear(),InvestigationBoard.nodesDataset.add(r);var n=[],n=R.flatten(R.keys(e.relations).map(function(t){return R.keys(e.relations[t]).map(function(i){return{from:t,to:i,label:e.relations[t][i]}})}));InvestigationBoard.edgesDataset.clear(),InvestigationBoard.edgesDataset.add(n);var o=CommonUtils.clone(Constants.investigationBoardOpts);o=R.merge(o,{locale:L10n.getLang(),locales:Constants.visLocales,manipulation:{addNode:InvestigationBoard.addNode,deleteNode:InvestigationBoard.deleteNode,editNode:InvestigationBoard.editNodeFun,addEdge:InvestigationBoard.addEdge,editEdge:!1,deleteEdge:InvestigationBoard.deleteEdge}}),InvestigationBoard.network.setOptions(o)},InvestigationBoard.showEdgeLabelEditor=function(e){if(0!==e.edges.length&&0===e.nodes.length){var t=InvestigationBoard.edgesDataset.get(e.edges[0]);InvestigationBoard.modifyArgs={edge:t,callback:function(e){e&&InvestigationBoard.edgesDataset.update(e)},editEdge:!0},queryEl(".investigation-board-tab .add-edge-label-input").value=t.label,InvestigationBoard.showPopup(".board-add-edge-popup",!0)}},InvestigationBoard.hideEdgeLabelEditor=function(e){InvestigationBoard.showPopup(".board-add-edge-popup",!1)},InvestigationBoard.addEdge=function(e,t){var i=InvestigationBoard.nodesDataset.get(e.from);return"resources"===i.group?(Utils.alert(getL10n("investigation-board-resource-node-cant-be-first")),void t()):(InvestigationBoard.modifyArgs={fromNode:InvestigationBoard.nodesDataset.get(e.from),toNode:InvestigationBoard.nodesDataset.get(e.to),callback:t},void InvestigationBoard.showPopup(".board-add-edge-popup",!0))},InvestigationBoard.saveEdge=function(){InvestigationBoard.modifyArgs.editEdge?InvestigationBoard.updateEdge():InvestigationBoard.createEdge()},InvestigationBoard.updateEdge=function(){var e=queryEl(".investigation-board-tab .add-edge-label-input").value.trim(),t=InvestigationBoard.modifyArgs.edge;DBMS.setEdgeLabel(t.from,t.to,e,function(i){return i?void Utils.handleError(i):(t.label=e,InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback(t))})},InvestigationBoard.createEdge=function(){var e=InvestigationBoard.modifyArgs.fromNode,t=InvestigationBoard.modifyArgs.toNode,i=queryEl(".investigation-board-tab .add-edge-label-input").value.trim();DBMS.addEdge(e.id,t.id,i,function(r){return r?void Utils.handleError(r):(InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback({from:e.id,to:t.id,label:i}))})},InvestigationBoard.deleteEdge=function(e,t){var i=InvestigationBoard.edgesDataset.get(e.edges[0]);DBMS.removeEdge(i.from,i.to,function(i){return i?(Utils.handleError(i),void t()):void t(e)})},InvestigationBoard.cancel=function(e){return function(){InvestigationBoard.showPopup(e,!1),InvestigationBoard.modifyArgs.callback()}},InvestigationBoard.showPopup=R.curry(function(e,t){setClassByCondition(queryEl(".investigation-board-tab "+e),"hidden",!t)});var LogViewer={};LogViewer.init=function(){listen(getEl("logPageSelector"),"change",function(e){DBMS.getLog(Number(e.target.value),LogViewer.dataRecieved)}),LogViewer.content=getEl("logViewerDiv")},LogViewer.refresh=function(){getEl("logPageSelector").selectedIndex=0,DBMS.getLog(0,LogViewer.dataRecieved)},LogViewer.dataRecieved=function(e,t){if(e)return void Utils.handleError(e);var i=getEl("logPageSelector"),r=i.selectedIndex;clearEl(i);for(var n=[],o=0;o<t.logSize;o++)n.push({name:o+1,value:String(o),selected:r==o});fillSelector(i,n);var a=clearEl(getEl("logData"));R.ap([addEl(a)],t.requestedLog.map(LogViewer.makeRow))},LogViewer.makeRow=function(e){var t=makeEl("tr"),i=function(e){addEl(t,addEl(makeEl("td"),makeText(e)))};return i(e[0]),i(new Date(e[2]).format("yyyy/mm/dd HH:MM:ss")),i(e[1]),i(e[3]),i(e[4]),t};var LogViewer2={};LogViewer2.init=function(){var e=LogViewer2;e.views={};var t=".log-viewer2-tab .sub-tab-navigation",i=".log-viewer2-tab .sub-tab-content",r={root:e,navigation:queryEl(t),content:queryEl(i)};Utils.addView(r,"logViewer",LogViewer,{mainPage:!0}),Utils.addView(r,"about",About),LogViewer2.content=queryEl(".log-viewer2-tab")},LogViewer2.refresh=function(){LogViewer2.currentView.refresh()};var MasterStory={};MasterStory.init=function(){listen(getEl("masterStoryArea"),"change",MasterStory.updateMasterStory),MasterStory.content=getEl("masterStoryDiv2")},MasterStory.refresh=function(){var e=getEl("masterStoryArea"),t=Stories.CurrentStoryName;t?DBMS.getMasterStory(t,function(t,i){return t?void Utils.handleError(t):void(e.value=i)}):e.value=""},MasterStory.updateMasterStory=function(){var e=getEl("masterStoryArea");DBMS.updateMasterStory(Stories.CurrentStoryName,e.value,Utils.processError())};var statisticKeys=["storyNumber","characterNumber","eventsNumber","userNumber","textCharacterNumber","lastEvent","firstEvent"],Overview={};Overview.Charts={},Overview.init=function(){Overview.name=getEl("gameNameInput"),Overview.name.addEventListener("change",Overview.updateName),Overview.lastSaveTime=getEl("lastSaveTime"),Overview.date=getEl("gameDatePicker");var e={lang:L10n.getLang(),mask:!0,onChangeDateTime:Overview.updateTime};jQuery(Overview.date).datetimepicker(e),Overview.preDate=getEl("preGameDatePicker"),e={lang:L10n.getLang(),mask:!0,onChangeDateTime:Overview.updatePreGameDate},jQuery(Overview.preDate).datetimepicker(e),L10n.onL10nChange(function(){jQuery(Overview.date).datetimepicker({lang:L10n.getLang()}),jQuery(Overview.preDate).datetimepicker({lang:L10n.getLang()})}),Overview.descr=getEl("gameDescription"),Overview.descr.addEventListener("change",Overview.updateDescr),UI.initTabPanel("overviewInfoButton","overviewContainer"),Overview.content=getEl("overviewDiv")},Overview.makeChart=function(e,t,i){Overview.Charts[e]&&Overview.Charts[e].destroy(),i.forEach(function(e,t){Constants.colorPalette[t]&&(e.color=Constants.colorPalette[t].color.background,e.highlight=Constants.colorPalette[t].color.hover.background)});var r=t.getContext("2d");Overview.Charts[e]=new Chart(r).Doughnut(i,{animateRotate:!1,tooltipTemplate:"<%if (label){%><%=label%><%}%>"})},Overview.makeHistogram=function(e,t){var i=null;t.forEach(function(e){e&&(null===i||e.value>i)&&(i=e.value)}),t.forEach(function(e){e&&(e.normValue=(e.value-0)/(i-0)*.9+.1)});var r;t.forEach(function(t){r=null===t?makeEl("div"):addEl(makeEl("div"),makeText(t.value)),addClass(r,"bar"),t&&(r.style.height=100*t.normValue+"%",$(r).tooltip({title:t.tip})),addEl(e,r)})},Overview.refresh=function(){PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(Overview.content,"adminOnly",t)}),DBMS.getMetaInfo(function(e,t){return e?void Utils.handleError(e):void DBMS.getStatistics(function(e,i){if(e)return void Utils.handleError(e);Overview.name.value=t.name,Overview.date.value=t.date,Overview.preDate.value=t.preGameDate,Overview.descr.value=t.description,addEl(clearEl(Overview.lastSaveTime),makeText(new Date(t.saveTime).format("yyyy/mm/dd HH:MM:ss"))),i.lastEvent=""!==i.lastEvent?new Date(i.lastEvent).format("yyyy/mm/dd h:MM"):"",i.firstEvent=""!==i.firstEvent?new Date(i.firstEvent).format("yyyy/mm/dd h:MM"):"",statisticKeys.forEach(function(e){Overview.updateStatisticValue(i,e)}),addEl(clearEl(getEl("generalCompleteness")),makeText(strFormat(getL10n("overview-general-completeness-value"),i.generalCompleteness))),addEl(clearEl(getEl("storyCompleteness")),makeText(strFormat(getL10n("overview-story-completeness-value"),i.storyCompleteness))),Overview.makeHistogram(clearEl(getEl("storyEventsHist")),i.storyEventsHist),Overview.makeHistogram(clearEl(getEl("storyCharactersHist")),i.storyCharactersHist),Overview.makeHistogram(clearEl(getEl("eventCompletenessHist")),i.eventCompletenessHist),Overview.makeHistogram(clearEl(getEl("characterSymbolsHist")),i.characterSymbolsHist),Overview.makeHistogram(clearEl(getEl("characterStoriesHist")),i.characterStoriesHist),Overview.makeChart("characterChart",getEl("characterChart"),i.characterChartData),Overview.makeChart("storyChart",getEl("storyChart"),i.storyChartData),Overview.makeChart("groupChart",getEl("groupChart"),i.groupChartData);var r,n,o=clearEl(getEl("profileDiagrams")),a=addEl(o),s=function(e){return r=makeEl("div"),addEl(r,addEl(makeEl("h4"),makeText(e.name))),addEl(r,e.bar),r},l=function(e){return n=setAttr(setAttr(makeEl("canvas"),"width","300"),"height","100"),Overview.makeChart(e.name,n,e.prepared),R.zipObj(["name","bar"],[e.name,n])},h=function(e){return n=makeEl("div"),addClass(n,"overviewHist"),Overview.makeHistogram(n,e.prepared),R.zipObj(["name","bar"],[e.name,n])},c=R.compose(a,s,l,Overview.prepareChart),d=R.compose(a,s,h,Overview.prepareHist),u=function(e){return e.data=R.fromPairs(R.toPairs(e.data).map(function(e){return e[0]=constL10n(Constants[e[0]]),e})),e},f=R.compose(c,u),p=R.cond([[R.compose(R.equals("enum"),R.prop("type")),c],[R.compose(R.equals("checkbox"),R.prop("type")),f],[R.T,d]]);i.profileCharts.forEach(p)})})},Overview.prepareChart=function(e){var t=R.sum(R.values(e.data));e.prepared=[];for(var i in e.data)e.prepared.push(R.zipObj(["value","label"],[e.data[i],Overview.makeChartLabel(t,i,e.data[i])]));return e},Overview.prepareHist=function(e){e.prepared=[];var t=e.data.step;e.data=e.data.groups;for(var i=R.apply(Math.min,R.keys(e.data)),r=R.apply(Math.max,R.keys(e.data)),n=i;r+1>n;n++)e.data[n]?e.prepared.push({value:e.data[n],label:n*t+"-"+(n*t+(t-1)),tip:n*t+"-"+(n*t+(t-1))}):e.prepared.push(null);return e},Overview.makeChartLabel=R.curry(function(e,t,i){return[t,": ",(i/e*100).toFixed(0),"% (",i,"/",e,")"].join("")}),Overview.updateStatisticValue=function(e,t){addEl(clearEl(getEl(t)),makeText(e[t]))},Overview.updateName=function(e){DBMS.setMetaInfo("name",e.target.value,Utils.processError())},Overview.updateTime=function(e,t){DBMS.setMetaInfo("date",t.val(),Utils.processError())},Overview.updatePreGameDate=function(e,t){DBMS.setMetaInfo("preGameDate",t.val(),Utils.processError())},Overview.updateDescr=function(e){DBMS.setMetaInfo("description",e.target.value,Utils.processError())};var Stories={};Stories.init=function(){Stories.left={views:{}},Stories.right={views:{}};var e={root:Stories.left,navigation:queryEl(".stories-navigation-container .left-side"),content:queryEl(".stories-content-container .left-side")};Utils.addView(e,"master-story",MasterStory,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),e={root:Stories.right,navigation:queryEl(".stories-navigation-container .right-side"),content:queryEl(".stories-content-container .right-side")},Utils.addView(e,"master-story",MasterStory,{toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),listen(queryEl("#storiesDiv .create-entity-button"),"click",Stories.createStory),listen(queryEl("#storiesDiv .rename-entity-button"),"click",Stories.renameStory),listen(queryEl("#storiesDiv .remove-entity-button"),"click",Stories.removeStory),$("#storySelector").select2().on("change",Stories.onStorySelectorChangeDelegate),Stories.content=getEl("storiesDiv")},Stories.chainRefresh=function(){(Stories.left.currentView&&"EventPresence"===Stories.left.currentView.name||Stories.right.currentView&&"EventPresence"===Stories.right.currentView.name)&&EventPresence.refresh()},Stories.refresh=function(){var e=["#storiesDiv .rename-entity-select","#storiesDiv .remove-entity-select"];clearEl(getEl("storySelector"));e.forEach(R.compose(clearEl,queryEl)),PermissionInformer.getStoryNamesArray(!1,function(t,i){return t?void Utils.handleError(t):void PermissionInformer.getStoryNamesArray(!0,function(t,r){if(t)return void Utils.handleError(t);if(r.length>0){var n=getSelect2Data(r);e.forEach(function(e){$(e).select2(n)})}if(i.length>0){var o=Stories.getSelectedStoryName(i),n=getSelect2Data(i);$("#storySelector").select2(n).val(o).trigger("change"),Stories.onStorySelectorChange(o)}else Stories.onStorySelectorChange();Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh()})})},Stories.getSelectedStoryName=function(e){var t=DBMS.getSettings();t.Stories||(t.Stories={storyName:e[0].value});var i=t.Stories.storyName;return-1===e.map(function(e){return e.value}).indexOf(i)&&(t.Stories.storyName=e[0].value,i=e[0].value),i},Stories.createStory=function(){var e=queryEl("#storiesDiv .create-entity-input").value.trim();return""===e?void Utils.alert(getL10n("stories-story-name-is-not-specified")):void DBMS.isStoryExist(e,function(t,i){return t?void Utils.handleError(t):void(i?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[e])):DBMS.createStory(e,function(t){return t?void Utils.handleError(t):(Stories.updateSettings(e),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.renameStory=function(){var e=queryEl("#storiesDiv .rename-entity-select").value.trim(),t=queryEl("#storiesDiv .rename-entity-input").value.trim();return""===t?void Utils.alert(getL10n("stories-new-story-name-is-not-specified")):e===t?void Utils.alert(getL10n("stories-names-are-the-same")):void DBMS.isStoryExist(t,function(i,r){return i?void Utils.handleError(i):void(r?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[t])):DBMS.renameStory(e,t,function(e){return e?void Utils.handleError(e):(Stories.updateSettings(t),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.removeStory=function(){var e=queryEl("#storiesDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("stories-are-you-sure-about-story-removing"),[e]))&&DBMS.removeStory(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()})})},Stories.onStorySelectorChangeDelegate=function(e){var t=e.target.value;Stories.onStorySelectorChange(t)},Stories.onStorySelectorChange=function(e){Stories.CurrentStoryName=e,e?(Stories.updateSettings(e),PermissionInformer.isStoryEditable(e,function(e,t){return e?void Utils.handleError(e):(Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh(),void Utils.enable(Stories.content,"isStoryEditable",t))})):(Stories.updateSettings(null),Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh())},Stories.updateSettings=function(e){var t=DBMS.getSettings();t.Stories.storyName=e};var StoryCharacters={};StoryCharacters.init=function(){var e=getEl("storyCharactersAddButton");e.addEventListener("click",StoryCharacters.addCharacter),e=getEl("storyCharactersSwitchButton"),e.addEventListener("click",StoryCharacters.switchCharacters),e=getEl("storyCharactersRemoveButton"),e.addEventListener("click",StoryCharacters.removeCharacter),StoryCharacters.ExternalCharacterSelectors=[getEl("storyCharactersAddSelector"),getEl("storyCharactersToSelector")],StoryCharacters.InternalCharacterSelectors=[getEl("storyCharactersRemoveSelector"),getEl("storyCharactersFromSelector")],StoryCharacters.content=getEl("storyCharactersDiv")},StoryCharacters.refresh=function(){StoryCharacters.ExternalCharacterSelectors.forEach(clearEl),StoryCharacters.InternalCharacterSelectors.forEach(clearEl),clearEl(getEl("story-characterActivityTableHead")),clearEl(getEl("story-characterActivityTable")),clearEl(getEl("storyCharactersTableHead")),clearEl(getEl("storyCharactersTable")),Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void DBMS.getStoryCharacters(Stories.CurrentStoryName,function(e,r){return e?void Utils.handleError(e):(StoryCharacters.rebuildInterface(i,r),Utils.enable(StoryCharacters.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryCharacters.rebuildInterface=function(e,t){var i=[],r=[];e.filter(function(e){return!t[e.value]}).forEach(function(e){i.push(e)}),e.filter(function(e){return t[e.value]}).forEach(function(e){r.push(e)}),i.sort(Utils.charOrdAObject),r.sort(Utils.charOrdAObject);var n=getSelect2Data(i),o=getSelect2Data(r);StoryCharacters.ExternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(n)}),StoryCharacters.InternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(o)});var a=clearEl(getEl("story-characterActivityTableHead")),s=clearEl(getEl("story-characterActivityTable"));addEl(a,StoryCharacters.getCharacterHeader([getL10n("stories-name")].concat(Constants.characterActivityTypes.map(constL10n)))),r.forEach(function(e){addEl(s,StoryCharacters.getCharacterActivity(e,t[e.value]))}),a=clearEl(getEl("storyCharactersTableHead")),s=clearEl(getEl("storyCharactersTable")),addEl(a,StoryCharacters.getCharacterHeader([getL10n("stories-name"),getL10n("stories-inventory")])),r.forEach(function(e){addEl(s,StoryCharacters.getCharacterInput(e,t[e.value]))})},StoryCharacters.addCharacter=function(){var e=getEl("storyCharactersAddSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void DBMS.addStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh))},StoryCharacters.switchCharacters=function(){var e=getEl("storyCharactersFromSelector").value.trim(),t=getEl("storyCharactersToSelector").value.trim();return""===e||""===t?void Utils.alert(getL10n("stories-one-of-switch-characters-is-not-specified")):void DBMS.switchStoryCharacters(Stories.CurrentStoryName,e,t,Utils.processError(StoryCharacters.refresh))},StoryCharacters.removeCharacter=function(){var e=getEl("storyCharactersRemoveSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void(Utils.confirm(strFormat(getL10n("stories-remove-character-from-story-warning"),[e]))&&DBMS.removeStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh)))},StoryCharacters.getCharacterHeader=function(e){var t=makeEl("tr");return e.forEach(function(e){addEl(t,addEl(makeEl("th"),makeText(e)))}),t},StoryCharacters.getCharacterInput=function(e,t){var i=makeEl("tr"),r=makeEl("td");r.appendChild(makeText(e.displayName)),i.appendChild(r),r=makeEl("td");var n=makeEl("input");return n.value=t.inventory,n.characterName=t.name,addClass(n,"inventoryInput"),addClass(n,"isStoryEditable"),n.addEventListener("change",StoryCharacters.updateCharacterInventory),r.appendChild(n),i.appendChild(r),i},StoryCharacters.updateCharacterInventory=function(e){DBMS.updateCharacterInventory(Stories.CurrentStoryName,e.target.characterName,e.target.value,Utils.processError())},StoryCharacters.getCharacterActivity=function(e,t){var i=makeEl("tr"),r=makeEl("td");r.appendChild(makeText(e.displayName)),i.appendChild(r);var n;return addEls(i,Constants.characterActivityTypes.map(function(e){r=addClass(makeEl("td"),"vertical-aligned-td"),n=makeEl("input"),addClass(n,"isStoryEditable"),n.type="checkbox",t.activity[e]&&(n.checked=!0),n.characterName=t.name,n.activityType=e,n.addEventListener("change",StoryCharacters.onChangeCharacterActivity),setAttr(n,"id",t.name+e),addClass(n,"hidden"),addEl(r,n);var i=addClass(makeEl("label"),"checkbox-label");return setAttr(i,"for",t.name+e),addEl(r,i)})),i},StoryCharacters.onChangeCharacterActivity=function(e){DBMS.onChangeCharacterActivity(Stories.CurrentStoryName,e.target.characterName,e.target.activityType,e.target.checked,Utils.processError())};var StoryEvents={};StoryEvents.init=function(){var e=getEl("createEventButton");e.addEventListener("click",StoryEvents.createEvent),e=getEl("moveEventButton"),e.addEventListener("click",StoryEvents.moveEvent),e=getEl("cloneEventButton"),e.addEventListener("click",StoryEvents.cloneEvent),e=getEl("mergeEventButton"),e.addEventListener("click",StoryEvents.mergeEvents),e=getEl("removeEventButton"),e.addEventListener("click",StoryEvents.removeEvent),StoryEvents.content=getEl("storyEventsDiv")},StoryEvents.refresh=function(){StoryEvents.clearInterface(),void 0!==Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void DBMS.getMetaInfo(function(e,i){return e?void Utils.handleError(e):void DBMS.getStoryEvents(Stories.CurrentStoryName,function(e,r){return e?void Utils.handleError(e):(StoryEvents.rebuildInterface(r,i),Utils.enable(StoryEvents.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryEvents.clearInterface=function(){clearEl(getEl("eventBlockHead")),clearEl(getEl("eventBlock"));var e=nl2array(document.querySelectorAll(".eventPositionSelector"));
R.ap([clearEl],e);var t=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],t)},StoryEvents.rebuildInterface=function(e,t){var i=clearEl(getEl("eventBlockHead")),r=clearEl(getEl("eventBlock"));addEl(i,StoryEvents.getEventHeader());var n,o,a=R.curry(function(e,t){addEl(e,addEl(makeEl("option"),makeText(t)))}),s=nl2array(document.querySelectorAll(".eventPositionSelector"));R.ap([clearEl],s),s.forEach(function(t){o=a(t),e.forEach(function(e){o(strFormat(getL10n("common-set-item-before"),[e.name]))}),o(getL10n("common-set-item-as-last")),t.selectedIndex=e.length}),R.ap([addEl(r)],e.map(function(e,i){return StoryEvents.appendEventInput(e,i,t.date,t.preGameDate)})),StoryEvents.eventsLength=e.length;var l=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],l),e.forEach(function(e,t){l.forEach(function(i){n=makeEl("option"),n.appendChild(makeText(e.name)),n.eventIndex=t,i.appendChild(n)})})},StoryEvents.createEvent=function(){var e=getEl("eventNameInput"),t=e.value.trim(),i=getEl("eventTextInput"),r=getEl("positionSelector"),n=i.value.trim();return""===t?void Utils.alert(getL10n("stories-event-name-is-not-specified")):""===n?void Utils.alert(getL10n("stories-event-text-is-empty")):void DBMS.createEvent(Stories.CurrentStoryName,t,n,r.value===getL10n("common-set-item-as-last"),r.selectedIndex,function(t){return t?void Utils.handleError(t):(e.value="",i.value="",void StoryEvents.refresh())})},StoryEvents.moveEvent=function(){var e=getEl("moveEventSelector").selectedOptions[0].eventIndex,t=getEl("movePositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("stories-event-positions-are-the-same")):void DBMS.moveEvent(Stories.CurrentStoryName,e,t,Utils.processError(StoryEvents.refresh))},StoryEvents.cloneEvent=function(){var e=getEl("cloneEventSelector").selectedIndex;DBMS.cloneEvent(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.mergeEvents=function(){var e=getEl("mergeEventSelector").selectedIndex;return StoryEvents.eventsLength==e+1?void Utils.alert(getL10n("stories-cant-merge-last-event")):void DBMS.mergeEvents(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.removeEvent=function(){var e=getEl("removeEventSelector");Utils.confirm(strFormat(getL10n("stories-remove-event-warning"),[e.value]))&&DBMS.removeEvent(Stories.CurrentStoryName,e.selectedIndex,Utils.processError(StoryEvents.refresh))},StoryEvents.getEventHeader=function(){var e=makeEl("tr");return addEl(e,addEl(makeEl("th"),makeText("№"))),addEl(e,addEl(makeEl("th"),makeText(getL10n("stories-event")))),e},StoryEvents.appendEventInput=function(e,t,i,r){var n=makeEl("tr");addEl(n,addEl(makeEl("td"),addEl(makeEl("span"),makeText(t+1))));var o=makeEl("td"),a=addClass(makeEl("div"),"story-events-div-main"),s=addClass(makeEl("div"),"story-events-div-left"),l=addClass(makeEl("div"),"story-events-div-right");return addEl(a,s),addEl(a,l),addEl(o,a),addEl(s,StoryEvents.makeEventNameInput(e,t)),addEl(l,UI.makeEventTimePicker({eventTime:e.time,index:t,preGameDate:r,date:i,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:StoryEvents.onChangeDateTimeCreator})),addEl(o,StoryEvents.makeEventTextInput(e,t)),addEl(n,o),n},StoryEvents.makeEventNameInput=function(e,t){var i=makeEl("input");return addClass(i,"isStoryEditable"),i.value=e.name,i.eventIndex=t,i.addEventListener("change",StoryEvents.updateEventName),i},StoryEvents.makeEventTextInput=function(e,t){var i=makeEl("textarea");return addClass(i,"isStoryEditable"),addClass(i,"eventText"),i.value=e.text,i.eventIndex=t,i.addEventListener("change",StoryEvents.updateEventText),i},StoryEvents.onChangeDateTimeCreator=function(e){return function(t,i){DBMS.updateEventProperty(Stories.CurrentStoryName,e.eventIndex,"time",i.val(),Utils.processError()),StoryEvents.lastDate=i.val(),removeClass(e,"defaultDate")}},StoryEvents.updateEventName=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-name-is-not-specified")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"name",t.value,Utils.processError(StoryEvents.refresh))},StoryEvents.updateEventText=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-text-is-empty")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"text",t.value,Utils.processError())},function(e){e.init=function(){},e.refresh=function(){}}(this.Template={});var Timeline={};Timeline.init=function(){var e=getEl("timelineStorySelector");e.addEventListener("change",Timeline.onStorySelectorChangeDelegate);var t=getEl("timelineContainer");Timeline.TimelineDataset=new vis.DataSet,Timeline.TagDataset=new vis.DataSet;var i={orientation:"top",showCurrentTime:!1},r=new vis.Timeline(t,null,i);r.setGroups(Timeline.TagDataset),r.setItems(Timeline.TimelineDataset),Timeline.timelineComponent=r,Timeline.content=getEl("timelineDiv")},Timeline.refresh=function(){var e=getEl("timelineStorySelector");clearEl(e);var t;DBMS.getMetaInfo(function(i,r){if(i)return void Utils.handleError(i);Timeline.postDate=r.date,Timeline.preDate=r.preGameDate;var n=new Date(Timeline.postDate),o=new Date(Timeline.preDate);n.setFullYear(n.getFullYear()+1),o.setFullYear(o.getFullYear()-1),Timeline.timelineComponent.setOptions({end:n,start:o}),PermissionInformer.getStoryNamesArray(!1,function(i,r){return i?void Utils.handleError(i):(r.forEach(function(i){t=makeEl("option"),t.appendChild(makeText(i.displayName)),t.value=i.value,e.appendChild(t)}),void(0!=r.length&&Timeline.onStorySelectorChange([r[0].value])))})})},Timeline.onStorySelectorChangeDelegate=function(e){for(var t=e.target.selectedOptions,i=[],r=0;r<t.length;r++)i.push(t[r].value);Timeline.onStorySelectorChange(i)},Timeline.onStorySelectorChange=function(e){Timeline.TagDataset.clear(),Timeline.TimelineDataset.clear();var t;DBMS.getEventGroupsForStories(e,function(i,r){return i?void Utils.handleError(i):(r.forEach(function(e){t=e.storyName,Timeline.TagDataset.add({id:t,content:t});var i=e.events;i.forEach(function(e){var i=Timeline.postDate;e.time&&(i=e.time),Timeline.TimelineDataset.add({content:e.name,start:i,group:t,storyName:t,eventIndex:e.index})})}),void(e[0]&&(Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-end-date"),start:new Date(Timeline.postDate),group:e[0],className:"importantItem",editable:!1}),Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-start-date"),start:new Date(Timeline.preDate),group:e[0],className:"importantItem",editable:!1}))))})};var NetworkSubsetsSelector={};NetworkSubsetsSelector.init=function(){listen(getEl("networkSubsetsSelector"),"change",NetworkSubsetsSelector.onNetworkSubsetsChange)},NetworkSubsetsSelector.refresh=function(e){NetworkSubsetsSelector.parent=e;var t,i=clearEl(getEl("networkSubsetsSelector")),r=!0;Constants.objectSubsets.forEach(function(e){t=makeEl("option"),t.appendChild(makeText(constL10n(e))),t.value=e,r&&(t.selected=!0,r=!1),i.appendChild(t)}),i=clearEl(getEl("networkCharacterSelector")),Object.keys(NetworkSubsetsSelector.parent.Characters).map(function(e){return NetworkSubsetsSelector.parent.Characters[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,i.appendChild(t)}),i=clearEl(getEl("networkStorySelector")),Object.keys(NetworkSubsetsSelector.parent.Stories).map(function(e){return NetworkSubsetsSelector.parent.Stories[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,i.appendChild(t)})},NetworkSubsetsSelector.getStoryNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Stories);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var i,r={};for(i=0;i<e.selectedOptions.length;i+=1)r[e.selectedOptions[i].value]=!0;var n,o,a=[],s=function(e){return r[e]};return Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){n=NetworkSubsetsSelector.parent.Stories[e],o=Object.keys(n.characters),o.some(s)&&a.push(e)}),a}e=getEl("networkStorySelector");var i,a=[];for(i=0;i<e.selectedOptions.length;i+=1)a.push(e.selectedOptions[i].value);return a},NetworkSubsetsSelector.getCharacterNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Characters);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var i,r={},n={};for(i=0;i<e.selectedOptions.length;i+=1)r[e.selectedOptions[i].value]=!0;var o,a,s,l,h=function(e){return r[e]};Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){o=NetworkSubsetsSelector.parent.Stories[e],a=Object.keys(o.characters),a.some(h)&&o.events.forEach(function(e){s=Object.keys(e.characters),s.some(h)&&s.forEach(function(e){h(e)||(n[e]=!0)})})});var c=Object.keys(r).concat(Object.keys(n));return c}e=getEl("networkStorySelector");var i,d=[],u={};for(i=0;i<e.selectedOptions.length;i+=1)d.push(e.selectedOptions[i].value);var o;return d.forEach(function(e){o=NetworkSubsetsSelector.parent.Stories[e];for(l in o.characters)u[l]=!0}),Object.keys(u)},NetworkSubsetsSelector.onNetworkSubsetsChange=function(e){var t=e.target.value,i=getEl("networkCharacterDiv"),r=getEl("networkStoryDiv");setClassByCondition(i,"hidden",t!==Constants.objectSubsets[1]),setClassByCondition(r,"hidden",t!==Constants.objectSubsets[2])};var SocialNetwork={};SocialNetwork.colorMap={},SocialNetwork.activityColors={active:"red",follower:"blue",defensive:"green",passive:"grey"},SocialNetwork.generatedColors=[],SocialNetwork.focusOptions={scale:1.2,offset:{x:0,y:0},animation:{duration:1e3,easingFunction:"easeInOutQuad"}},SocialNetwork.fixedColors={storyColor:{color:{background:"rgb(255,255,0)",border:"rgb(255,168,3)"}},noGroup:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}},thirdDegreeNode:{color:{background:"rgba(200,200,200,0.5)",border:"rgba(200,200,200,0.5)"}},secondDegreeNode:{color:{background:"rgba(150,150,150,0.75)",border:"rgba(150,150,150,0.75)"}},firstDegreeNode:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}}},SocialNetwork.init=function(){SocialNetwork.highlightActive=!0,NetworkSubsetsSelector.init(),listen(getEl("networkNodeGroupSelector"),"change",function(e){SocialNetwork.updateNodes(e.target.value)}),listen(getEl("drawNetworkButton"),"click",SocialNetwork.onDrawNetwork),$("#nodeFocusSelector").select2().on("change",SocialNetwork.onNodeFocus);var e=getEl("networkSelector");e.addEventListener("change",SocialNetwork.onNetworkSelectorChangeDelegate),e=getEl("activitySelector"),e.addEventListener("change",SocialNetwork.onActivitySelectorChangeDelegate);var t,i;Constants.characterActivityTypes.forEach(function(r){i=makeEl("option"),i.appendChild(makeText(constL10n(r))),t=i.style,t.color=SocialNetwork.activityColors[r],i.activity=r,e.appendChild(i)}),SocialNetwork.selectedActivities={},SocialNetwork.network,SocialNetwork.highlightActive=!1;var r=function(){var e=clearEl(getEl("socialNetworkWarning"));addEl(e,makeText(getL10n("social-network-require-resources-warning")));var t=makeEl("button");addEl(t,makeText(getL10n("social-network-remove-resources-warning"))),addEl(e,t),t.addEventListener("click",function(){addClass(e,"hidden")})};r(),L10n.onL10nChange(r),SocialNetwork.nodeSort=CommonUtils.charOrdAFactory(function(e){return e.label.toLowerCase()}),SocialNetwork.content=getEl("socialNetworkDiv")},SocialNetwork.refresh=function(){var e,t=clearEl(getEl("networkSelector"));Constants.networks.forEach(function(i){e=makeEl("option"),e.appendChild(makeText(constL10n(i))),e.value=i,t.appendChild(e)}),t.value=Constants.networks[0],t=clearEl(getEl("networkNodeGroupSelector")),PermissionInformer.getCharacterNamesArray(!1,function(e,i){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!1,function(e,r){return e?void Utils.handleError(e):void DBMS.getAllProfiles(function(e,n){return e?void Utils.handleError(e):(SocialNetwork.Characters=n,i.forEach(function(e){n[e.value].displayName=e.displayName}),void DBMS.getAllStories(function(e,i){return e?void Utils.handleError(e):(SocialNetwork.Stories=i,r.forEach(function(e){i[e.value].displayName=e.displayName}),void DBMS.getAllProfileSettings(function(e,i){return e?void Utils.handleError(e):void DBMS.getMetaInfo(function(e,r){if(e)return void Utils.handleError(e);SocialNetwork.metaInfo=r;var n=i.filter(function(e){return"enum"===e.type||"checkbox"===e.type}),o=[{name:Constants.noGroup,displayName:constL10n(Constants.noGroup)}].concat(n.map(function(e){return{name:e.name,displayName:e.name}}));o.forEach(function(e){var i=makeEl("option");i.appendChild(makeText(e.displayName)),i.value=e.name,t.appendChild(i)}),SocialNetwork.groupColors={},SocialNetwork.groupLists={noGroup:["noGroup"]};for(var a in SocialNetwork.fixedColors)SocialNetwork.groupColors[a]=SocialNetwork.fixedColors[a];n.forEach(function(e){if("enum"===e.type){var t=[];e.value.split(",").forEach(function(i,r){SocialNetwork.groupColors[e.name+"."+i.trim()]=Constants.colorPalette[r],t.push(e.name+"."+i.trim())}),SocialNetwork.groupLists[e.name]=t}else"checkbox"===e.type&&(e.value?(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[0],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[1]):(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[1],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[0]),SocialNetwork.groupLists[e.name]=[e.name+".true",e.name+".false"])}),NetworkSubsetsSelector.refresh(SocialNetwork)})}))}))})})})},SocialNetwork.refreshLegend=function(e){var t=getEl("colorLegend");clearEl(t);var i;SocialNetwork.groupLists[e].forEach(function(e){i=makeEl("div"),i.appendChild(makeText("noGroup"===e?constL10n("noGroup"):e)),i.style.backgroundColor=SocialNetwork.groupColors[e].color.background,i.style.border="solid 2px "+SocialNetwork.groupColors[e].color.border,t.appendChild(i)}),-1!==["characterPresenceInStory","characterActivityInStory"].indexOf(SocialNetwork.selectedNetwork)&&(i=makeEl("div"),i.appendChild(makeText(getL10n("social-network-story"))),i.style.backgroundColor=SocialNetwork.fixedColors.storyColor.color.background,i.style.border="solid 2px "+SocialNetwork.fixedColors.storyColor.color.border,t.appendChild(i))},SocialNetwork.updateNodes=function(e){SocialNetwork.refreshLegend(e);var t;NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var r=SocialNetwork.Characters[i];t="noGroup"===e?e:e+"."+r[e],SocialNetwork.nodesDataset.update({id:r.name,group:t})})},SocialNetwork.onActivitySelectorChangeDelegate=function(e){SocialNetwork.selectedActivities={};var t;for(t=0;t<e.target.selectedOptions.length;t+=1)SocialNetwork.selectedActivities[e.target.selectedOptions[t].activity]=!0},SocialNetwork.onNetworkSelectorChangeDelegate=function(e){var t=e.target.value,i=getEl("activityBlock");setClassByCondition(i,"hidden","characterActivityInStory"!==t)},SocialNetwork.onNodeFocus=function(e){SocialNetwork.network.focus(e.target.value,SocialNetwork.focusOptions)},SocialNetwork.onDrawNetwork=function(){SocialNetwork.onNetworkSelectorChange(getEl("networkSelector").value)},SocialNetwork.onNetworkSelectorChange=function(e){switch(SocialNetwork.selectedNetwork=e,SocialNetwork.nodes=[],SocialNetwork.edges=[],e){case"simpleNetwork":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getSimpleEdges();break;case"socialRelations":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getDetailedEdges();break;case"characterPresenceInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getStoryEdges();break;case"characterActivityInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getActivityEdges()}SocialNetwork.refreshLegend(getEl("networkNodeGroupSelector").value),clearEl(getEl("nodeFocusSelector")),SocialNetwork.nodes.sort(SocialNetwork.nodeSort);var t=getSelect2DataCommon(remapProps(["id","text"],["id","label"]),SocialNetwork.nodes);$("#nodeFocusSelector").select2(t),SocialNetwork.nodesDataset=new vis.DataSet(SocialNetwork.nodes),SocialNetwork.edgesDataset=new vis.DataSet(SocialNetwork.edges),SocialNetwork.redrawAll()},SocialNetwork.getCharacterNodes=function(){var e=getEl("networkNodeGroupSelector").value,t=[];return NetworkSubsetsSelector.getCharacterNames().forEach(function(i){var r=SocialNetwork.Characters[i];t.push({id:r.name,label:r.name.split(" ").join("\n"),group:"noGroup"===e?constL10n("noGroup"):e+"."+r[e]})}),t},SocialNetwork.getStoryNodes=function(){var e=NetworkSubsetsSelector.getStoryNames().map(function(e){return{id:"St:"+e,label:e.split(" ").join("\n"),value:Object.keys(SocialNetwork.Stories[e].characters).length,title:Object.keys(SocialNetwork.Stories[e].characters).length,group:"storyColor"}});return e},SocialNetwork.getActivityEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var i=SocialNetwork.Stories[t];for(var r in i.characters)for(var n in i.characters[r].activity)SocialNetwork.selectedActivities[n]&&e.push({from:"St:"+t,to:r,color:SocialNetwork.activityColors[n],width:2,hoverWidth:4})}return e},SocialNetwork.getStoryEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var i=SocialNetwork.Stories[t];for(var r in i.characters)e.push({from:"St:"+t,to:r,color:"grey"})}return e},SocialNetwork.getSimpleEdges=function(){var e=[],t={};for(var i in SocialNetwork.Stories){var r=SocialNetwork.Stories[i];r.events.forEach(function(r){for(var n in r.characters)for(var o in r.characters)n===o||t[i+n+o]||t[i+o+n]||(t[i+n+o]=!0,e.push({from:n,to:o,color:"grey"}))})}return e},SocialNetwork.getEventDetails=function(){return R.flatten(R.values(SocialNetwork.Stories).map(function(e){return e.events.map(function(t){return{eventName:t.name,storyName:e.name,time:t.time,characters:R.keys(t.characters)}})}))},SocialNetwork.getDetailedEdges=function(){var e={};return R.values(SocialNetwork.Stories).forEach(function(t){t.events.forEach(function(i){var r=R.keys(i.characters).sort();r.forEach(function(i,n){r.forEach(function(r,o){if(!(o>=n)){var a=i+r;e[a]||(e[a]={from:i,to:r,title:{}}),e[a].title[t.name]=!0}})})})}),R.values(e).map(function(e){var t=R.keys(e.title).sort().join(", "),i=R.keys(e.title).length;return{from:e.from,to:e.to,title:i+": "+t,value:i,color:"grey"}})},SocialNetwork.redrawAll=function(){var e=getEl("socialNetworkContainer"),t={nodes:SocialNetwork.nodesDataset,edges:SocialNetwork.edgesDataset};SocialNetwork.network&&SocialNetwork.network.destroy();var i=CommonUtils.clone(Constants.socialNetworkOpts);i.groups=SocialNetwork.groupColors,SocialNetwork.network=new vis.Network(e,t,i),SocialNetwork.network.on("click",SocialNetwork.neighbourhoodHighlight)},SocialNetwork.neighbourhoodHighlight=function(e){var t=SocialNetwork.nodesDataset.get({returnType:"Object"}),i=SocialNetwork.network,r=SocialNetwork.nodesDataset;if(e.nodes.length>0){SocialNetwork.highlightActive=!0;var n,o,a=e.nodes[0],s=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var h=i.getConnectedNodes(a),c=[];for(n=1;s>n;n++)for(o=0;o<h.length;o++)c=c.concat(i.getConnectedNodes(h[o]));for(n=0;n<c.length;n++)t[c[n]].color="rgba(150,150,150,0.75)",void 0!==t[c[n]].hiddenLabel&&(t[c[n]].label=t[c[n]].hiddenLabel,t[c[n]].hiddenLabel=void 0);for(n=0;n<h.length;n++)t[h[n]].color=void 0,void 0!==t[h[n]].hiddenLabel&&(t[h[n]].label=t[h[n]].hiddenLabel,t[h[n]].hiddenLabel=void 0);t[a].color=void 0,void 0!==t[a].hiddenLabel&&(t[a].label=t[a].hiddenLabel,t[a].hiddenLabel=void 0)}else if(e.edges.length>0){SocialNetwork.highlightActive=!0;var n,o,d=e.edges[0],s=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var u=i.getConnectedNodes(d),f=[];for(n=1;s>n;n++)for(o=0;o<u.length;o++)f=f.concat(i.getConnectedNodes(u[o]));for(n=0;n<f.length;n++)t[f[n]].color="rgba(150,150,150,0.75)",void 0!==t[f[n]].hiddenLabel&&(t[f[n]].label=t[f[n]].hiddenLabel,t[f[n]].hiddenLabel=void 0);for(n=0;n<u.length;n++)t[u[n]].color=void 0,void 0!==t[u[n]].hiddenLabel&&(t[u[n]].label=t[u[n]].hiddenLabel,t[u[n]].hiddenLabel=void 0)}else if(SocialNetwork.highlightActive===!0){for(var l in t)t[l].color=void 0,void 0!==t[l].hiddenLabel&&(t[l].label=t[l].hiddenLabel,t[l].hiddenLabel=void 0);SocialNetwork.highlightActive=!1}var p=[];for(l in t)t.hasOwnProperty(l)&&p.push(t[l]);r.update(p)},function(e){function t(){var e=new Stats;return e.setMode(0),addEl(clearEl(getEl("Stats-output")),e.domElement),e}function i(){h=new THREE.WebGLRenderer,h.setClearColor(new THREE.Color(15658734,1)),addEl(clearEl(getEl("WebGL-output")),h.domElement),d=t(),c=new function(){this.rotationSpeed=.08,this.zScale=f,this.planeScale=10,this.cameraZ=120,this.outputObjects=function(){console.log(l.children)}};var e=new dat.GUI({autoPlace:!1});e.add(c,"rotationSpeed",0,.5),e.add(c,"zScale",1,100),e.add(c,"planeScale",1,100),e.add(c,"cameraZ",-500,500),e.add(c,"outputObjects"),addEl(getEl("gui-settings-output"),e.domElement)}function r(e,t,i,r,o){function m(e){e.minTime=R.reduce(R.min,1/0,e.events.map(R.prop("scaledTime"))),e.maxTime=R.reduce(R.max,-(1/0),e.events.map(R.prop("scaledTime")))}function g(e){return e.startsWith("St:")?x[e.substring(3)]:E[e]}function v(){d.update(),e.storePositions(),P?t.get().forEach(function(e){var t=l.getObjectByName(String("cyl-"+e.id));t&&(t.position.x=e.x/10,t.position.y=-e.y/10)}):(console.log(t.get()),console.log(i.get()),t.get().forEach(function(e){var t=g(e.id);if(t){var i=t.maxTime-t.minTime,r=(t.maxTime+t.minTime)/2;a(e.x/10,-e.y/10,r*f,i,.5,String("cyl-"+e.id))}}),P=!0),l.traverse(function(e){if(e instanceof THREE.Mesh&&e.name.startsWith("cyl-")){var t=g(e.name.substring(4));e.position.z=(t.maxTime+t.minTime)/2*c.zScale,e.scale.y=c.zScale}});var r=Date.now(),n=.005;s.position.x=50*Math.sin(r*c.rotationSpeed*n),s.position.y=50*Math.cos(r*c.rotationSpeed*n),s.position.z=c.cameraZ,s.lookAt(new THREE.Vector3(0,0,0)),requestAnimationFrame(v),h.render(l,s)}var y=new Date(o.preGameDate).getTime(),A=new Date(o.date).getTime(),b=A-y;console.log(y),console.log(A),console.log(b);var E={},x={};r.forEach(function(e){""===e.time&&(e.time=o.date),e.scaledTime=(new Date(e.time).getTime()-y)/b,console.log(e.scaledTime),x[e.storyName]=x[e.storyName]||{events:[]},x[e.storyName].events.push(e),e.characters.forEach(function(t){E[t]=E[t]||{events:[]},E[t].events.push(e)})}),console.log(x),console.log(E),R.values(x).forEach(m),R.values(E).forEach(m),console.log(x),console.log(E);var w=n();l=new THREE.Scene,s=new THREE.PerspectiveCamera(45,w.width/w.height,.1,1e3);var T=new THREE.AxisHelper(20);l.add(T);var _=new THREE.PlaneGeometry(60,20,1,1),S=new THREE.MeshBasicMaterial({color:16777215,opacity:0}),C=new THREE.Mesh(_,S);C.rotation.x=-.5*Math.PI,C.position.x=15,C.position.y=0,C.position.z=0,l.add(C),s.position.copy(u),s.lookAt(new THREE.Vector3(0,0,0)),s.position.add(new THREE.Vector3(0,-100,0)),s.lookAt(new THREE.Vector3(0,0,0));var k=new THREE.AmbientLight(789516);l.add(k);var M=new THREE.SpotLight(16777215);M.position.copy(p),l.add(M);var P=!1;v()}function n(){var e=getComputedStyle(getEl("socialNetworkContainer")),t=.75*e.width.split("px").join(""),i=.75*e.height.split("px").join("");return h.setSize(t,i),{width:t,height:i}}function o(){if(s&&h){var e=n();s.aspect=e.width/e.height,s.updateProjectionMatrix()}}function a(e,t,i,r,n,o){var a=new THREE.CylinderGeometry(n,n,r,32),s=new THREE.MeshLambertMaterial({color:7829503}),h=new THREE.Mesh(a,s);h.name=o,h.position.x=e,h.position.y=t,h.position.z=i,h.rotation.x=-.5*Math.PI,l.add(h)}var s,l,h,c,d,u=new THREE.Vector3(0,0,60).multiplyScalar(2.5),f=25,p=new THREE.Vector3(0,0,50);e.init=i,e.refresh=r,window.addEventListener("resize",o,!1)}(this.TimelinedNetwork={});