/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.-tab ';
    const state = {};

    exports.init = () => {
        //exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };
})(this.Template = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    state.entities = ['characters', 'stories', 'groups', 'players'];

    const root = '.organizer-management-tab ';

    let removePermission, assignPermission;

    exports.init = () => {
        const createUserDialog = UI.createModalDialog(root, createUser, {
            bodySelector: 'create-organizer-body',
            dialogTitle: 'admins-creating-user',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.user`), 'click', () => createUserDialog.showDlg());
        
        const changePasswordDialog = UI.createModalDialog(root, changePassword, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'admins-enter-new-password',
            actionButtonTitle: 'common-replace',
        });
        listen(qe(`${root}.user.change-password`), 'click', () => {
            qee(changePasswordDialog, '.entity-input').value = '';
            changePasswordDialog.showDlg();
        });
        
        listen(queryEl(`${root}.remove-user-button`), 'click', removeOrganizer);

        listen(queryEl(`${root}.assign-permission-button`), 'click', assignPermission);
        listen(queryEl(`${root}.remove-permission-button`), 'click', removePermission);
        listen(queryEl(`${root}.assign-admin-button`), 'click', assignNewAdmin);
        listen(queryEl(`${root}.remove-editor-button`), 'click', removeEditor);
        listen(queryEl(`${root}.assign-editor-button`), 'click', assignEditor);
        
        state.entities.forEach(type => {
            listen(queryEl(`${root} .entity-filter.${type}`), 'input', filterList(`.entity-list.${type}`));
        });

        queryElEls(queryEl(root), '.adaptationRights').map(listen(R.__, 'click', changeAdaptationRightsMode));
        
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getManagementInfo((err, managementInfo) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                PermissionInformer.isEditor((err3, isEditor) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, characterNames) => {
                        if (err4) { Utils.handleError(err4); return; }
                        PermissionInformer.getEntityNamesArray('story', false, (err5, storyNames) => {
                            if (err5) { Utils.handleError(err5); return; }
                            PermissionInformer.getEntityNamesArray('group', false, (err6, groupNames) => {
                                if (err6) { Utils.handleError(err6); return; }
                                PermissionInformer.getEntityNamesArray('player', false, (err7, playerNames) => {
                                    if (err7) { Utils.handleError(err7); return; }
                                    const names = {
                                        characters: characterNames,
                                        groups: groupNames,
                                        stories: storyNames,
                                        players: playerNames,
                                    };
                                    if (!isAdmin && isEditor) {
                                        R.keys(names).forEach((entity) => {
                                            names[entity] = names[entity].filter(R.prop('isOwner'));
                                        });
                                    }
                                    rebuildInterface(names, managementInfo, isAdmin);
                                    Utils.enable(exports.content, 'adminOnly', isAdmin);
                                    Utils.enable(exports.content, 'editorOrAdmin', isAdmin || isEditor);
                                });
                            });
                        });
                    });
                });
            });
        });
    };

    function rebuildInterface(names, managementInfo, isAdmin) {
        const { usersInfo } = managementInfo;

        const userNames = Object.keys(usersInfo).sort(CommonUtils.charOrdA);

        const selectors = [];
        selectors.push(queryEl(`${root}.change-password-user-select`));
//        selectors.push(queryEl(`${root}.user-permission-select`));
//        selectors.push(queryEl(`${root}.assign-editor-select`));

        const data = arr2Select2(userNames)
        selectors.forEach((selector) => {
            clearEl(selector);
            $(selector).select2(data);
//            Utils.rebuildSelectorArr(selector, userNames);
        });
        
        Utils.rebuildSelectorArr(queryEl(`${root}.user-permission-select`), userNames);

        const clone = userNames.slice(0);
        clone.splice(userNames.indexOf(managementInfo.admin), 1);
//        let selector = queryEl(`${root}.assign-admin-select`);
//        Utils.rebuildSelectorArr(selector, clone);
        
//        const data = getSelect2Data(allGroupNames);
//        clearEl(queryEl(`${root}.save-entity-select`));
//        $(`${root}.save-entity-select`).select2(data);

//        selector = queryEl(`${root}.remove-user-select`);
//        Utils.rebuildSelectorArr(selector, clone);

        state.entities.forEach((entity) => {
            Utils.rebuildSelector(queryEl(`${root}.permission-selector__${entity}`), names[entity]);
        });

        addEl(clearEl(queryEl(`${root}.current-admin-label`)), makeText(managementInfo.admin));

        const span = clearEl(queryEl(`${root}.current-editor-label`));
        if (managementInfo.editor) {
            addEl(span, makeText(managementInfo.editor));
        }

        getEl(`adaptationRights${managementInfo.adaptationRights}`).checked = true;

        state.entities.forEach((entity) => {
//            Utils.rebuildSelector(queryEl(`${root}.permission-selector__${entity}`), names[entity]);
            addEls(
                clearEl(queryEl(`${root} .entity-list.${entity}`)),
                names[entity].map(entity2el(isAdmin, entity))
            );
        });
        
        addEls(
            clearEl(queryEl(`${root} .entity-list.users`)),
            userNames.map(user2el)
        );
        buildPermissionList(names, usersInfo);
    }
    
    const entity2el = R.curry((isAdmin, type, name) => {
        const el = qmte(`.profile-item-tmpl`);
        el.profileName = name.value;
        addEl(qee(el, '.primary-name'), makeText(name.displayName));
        const btn = qee(el, '[role=button]');
        setAttr(btn, 'profile-name', name.value);
        setAttr(btn, 'primary-name', name.displayName);
        setAttr(btn, 'button-type', 'entity');
        setAttr(btn, 'profile-type', type);
        if(name.isOwner || isAdmin){
            listen(btn, 'dragstart', onDragStart);
            listen(btn, 'drop', onDrop);
            listen(btn, 'dragover', allowDrop);
            listen(btn, 'dragenter', handleDragEnter);
            listen(btn, 'dragleave', handleDragLeave);
            listen(btn, 'click', e => toggleClass(btn, 'btn-primary'));
        } else {
            Utils.enableEl(btn, false);
        }
        return el;
    });
    
    const user2el = R.curry((name) => {
        const el = wrapEl('div', qte(`.profile-item-tmpl`));
//        el.profileName = name.value;
        addEl(qee(el, '.primary-name'), makeText(name));
        setAttr(el, 'profile-name', name);
        setAttr(el, 'button-type', 'user');
//        setAttr(el, 'primary-name', name.displayName);
//        setAttr(el, 'profile-type', type);
        listen(el, 'dragstart', onDragStart);
        listen(el, 'drop', onDrop);
        listen(el, 'dragover', allowDrop);
        listen(el, 'dragenter', handleDragEnter);
        listen(el, 'dragleave', handleDragLeave);
        return el;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function(event) {
        if(getAttr(this, 'button-type') === 'entity'){
            addClass(this, 'btn-primary');
        }
        console.log(`onDragStart ${this.profileName}`);
        event.dataTransfer.setData('data', JSON.stringify({
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
            buttonType: getAttr(this, 'button-type'),
        }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function(event) {
        removeClass(this, 'over');
        console.log(`onDrop ${this.profileName}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        const thatData = JSON.parse(event.dataTransfer.getData('data'));
        if (thatData.type === getAttr(this, 'profile-type')) {
            return;
        }
        const type1 = getAttr(this, 'button-type');
        const type2 = thatData.buttonType;
        
        if(type1 !== type2){
            const userName = type1 === 'user' ? getAttr(this, 'profile-name') : thatData.name;
//            const entityBtn =  type1 === 'user' ? 
            
//            console.log(user);
            const btns = qes(`${root} .rights-panel .btn-primary[role=button]`);
            const selected = btns.map( btn => ({
                type: getAttr(btn, 'profile-type'),
                name: getAttr(btn, 'profile-name'),
            }));
            const names = R.mapObjIndexed(arr => arr.map(R.prop('name')), R.groupBy(R.prop('type'), selected));
            btns.forEach(btn => removeClass(btn, 'btn-primary'))
            
            DBMS['assignPermission'](userName, names, Utils.processError(exports.refresh));
//            DBMS[action](userName, names, Utils.processError(exports.refresh));
//        };
//    }
//
//    removePermission = permissionAction('removePermission');
//    assignPermission = permissionAction('assignPermission');
        }

//        createBinding([thatData, {
//            name: getAttr(this, 'profile-name'),
//            type: getAttr(this, 'profile-type'),
//        }]);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function(event) {
        console.log(`allowDrop ${this.profileName}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    function buildPermissionList(names, usersInfo) {
        const permissionTable = clearEl(queryEl(`${root}.permission-table`));
        const treeRoot = makeEl('ul');
        addEl(permissionTable, treeRoot);

        R.keys(names).forEach((entity) => {
            names[entity] = names[entity].map(R.prop('value'));
        });

        R.values(usersInfo).forEach((userInfo) => {
            R.keys(userInfo).forEach((entity) => {
                names[entity] = R.difference(names[entity], userInfo[entity]);
            });
        });

        usersInfo[getL10n('admins-have-not-owner')] = names;

        const headers = {
            characters: getL10n('admins-characters'),
            stories: getL10n('admins-stories'),
            groups: getL10n('admins-groups'),
            players: getL10n('admins-players'),
        };

        function liMaker(text) {
            return addEl(makeEl('li'), makeText(text));
        }

        function makeEntityLists(userInfo) {
            return state.entities.reduce((result, entity) => {
                result.push(liMaker(headers[entity]));
                result.push(addEls(makeEl('ol'), userInfo[entity].sort(CommonUtils.charOrdA).map(liMaker)));
                return result;
            }, []);
        }

        const userNames = Object.keys(usersInfo).sort(CommonUtils.charOrdA);
        addEls(treeRoot, userNames.reduce((result, userName) => {
            result.push(liMaker(userName));
            result.push(addEls(makeEl('ol'), makeEntityLists(usersInfo[userName])));
            return result;
        }, []));
    }

    function createUser(dialog) {
        return () => {
            const userNameInput = qee(dialog,`.create-user-name-input`);
            const userPasswordInput = qee(dialog,`.create-user-password-input`);
            DBMS.createOrganizer(userNameInput.value.trim(), userPasswordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    userNameInput.value = '';
                    userPasswordInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function changePassword(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const newPassword = toInput.value;
            const userName = queryEl(`${root}.change-password-user-select`).value.trim();
            DBMS.changeOrganizerPassword(userName, newPassword, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }


    function changeOrganizerPassword() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        const passwordInput = queryEl(`${root}.change-password-password-input`);
        DBMS.changeOrganizerPassword(userName, passwordInput.value, Utils.processError(() => {
            queryEl(`${root}.change-password-password-input`).value = '';
            exports.refresh();
        }));
    }

    function removeOrganizer() {
//        const name = queryEl(`${root}.remove-user-select`).value.trim();
        const name = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-user-remove'), [name]), () => {
            DBMS.removeOrganizer(name, Utils.processError(exports.refresh));
        });
    }

    const getSelectedOptions = sel => nl2array(queryEl(sel).selectedOptions).map(opt => opt.value);

    function permissionAction(action) {
        return () => {
            const userName = queryEl(`${root}.user-permission-select`).value.trim();

            // TODO remove this check
            if (userName === '') {
                Utils.alert(getL10n('admins-user-is-not-selected'));
                return;
            }

            const names = {};
            state.entities.forEach((entity) => {
                names[entity] = getSelectedOptions(`${root}.permission-selector__${entity}`);
            });

            DBMS[action](userName, names, Utils.processError(exports.refresh));
        };
    }

    removePermission = permissionAction('removePermission');
    assignPermission = permissionAction('assignPermission');

    function assignNewAdmin() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-admin-assignment'), [userName]), () => {
            DBMS.assignAdmin(userName, Utils.processError(exports.refresh));
        });
    }
    function removeEditor() {
        DBMS.removeEditor(Utils.processError(exports.refresh));
    }
    function assignEditor() {
        const userName = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-editor-assignment'), [userName]), () => {
            DBMS.assignEditor(userName, Utils.processError(exports.refresh));
        });
    }
    function changeAdaptationRightsMode(event) {
        DBMS.changeAdaptationRightsMode(event.target.value, Utils.processError());
    }
    
    // eslint-disable-next-line no-var,vars-on-top
    var filterList = sel => (event) => {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} ${sel} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            hideEl(el, !isVisible);
        });
    };
})(this.OrganizerManagement = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    const root = '.player-management-tab ';

    exports.init = () => {
        const createUserDialog = UI.createModalDialog(root, createUser, {
            bodySelector: 'create-organizer-body',
            dialogTitle: 'admins-creating-player',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.player`), 'click', () => createUserDialog.showDlg());
        
        const createPlayerAccountDialog = UI.createModalDialog(root, createUserAccount, {
            bodySelector: 'create-player-account-body',
            dialogTitle: 'admins-creating-player-account',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create.player-account`), 'click', () => createPlayerAccountDialog.showDlg());
        
        const changePasswordDialog = UI.createModalDialog(root, changePassword, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'admins-enter-new-password',
            actionButtonTitle: 'common-replace',
        });
        listen(qe(`${root}.user.change-password`), 'click', () => {
            qee(changePasswordDialog, '.entity-input').value = '';
            changePasswordDialog.showDlg();
        });
        
        
//        listen(queryEl(`${root}.create-user-button`), 'click', createUser);
//        listen(queryEl(`${root}.create-login-button`), 'click', createLogin);
//        listen(queryEl(`${root}.change-password-button`), 'click', changePassword);
        listen(queryEl(`${root}.remove-user-button`), 'click', removeUser);
        listen(queryEl(`${root}.welcome-text-area`), 'change', setWelcomeText);
        queryElEls(queryEl(root), '.playerOptions').map(listen(R.__, 'change', setPlayerOption));
        
        $(`${root}.change-password-user-select`).select2().on('change', (event) => {
            const player = event.target.value;
            const yourPlayers = state.playerNames.filter(R.prop('isOwner')).map(R.prop('value'));
            const isPlayerEditable = R.contains(player, yourPlayers);
            Utils.enableEl(qe(`${root}.user.change-password`), isPlayerEditable);
            Utils.enableEl(qe(`${root}.remove-user-button`), isPlayerEditable);
        });


        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('player', false, (err, playerNames) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getPlayerLoginsArray((err2, playerLogins) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getWelcomeText((err3, text) => {
                    if (err3) { Utils.handleError(err3); return; }
                    DBMS.getPlayersOptions((err4, playersOptions) => {
                        if (err4) { Utils.handleError(err4); return; }
                        PermissionInformer.isAdmin((err5, isAdmin) => {
                            if (err5) { Utils.handleError(err5); return; }
                            // eslint-disable-next-line prefer-destructuring
                            R.toPairs(playersOptions).map(pair => (getEl(pair[0]).checked = pair[1]));
    
                            queryEl(`${root}.welcome-text-area`).value = text;
                            const playerHasLogin = R.compose(R.contains(R.__, playerLogins), R.prop('value'));
                            const hasLoginObj = R.groupBy(playerHasLogin, playerNames);
                            
                            state.playerNames = playerNames;
                            
                            const noAccounts = (hasLoginObj.false || []);
                            noAccounts.sort(Utils.charOrdAObject);
                            $(clearEl(queryEl(`${root}.create-login-name-select`))).select2(getSelect2Data(noAccounts));
    //                        fillSelector(clearEl(queryEl(`${root}.create-login-name-select`)), (hasLoginObj.false || [])
    //                            .sort(Utils.charOrdAObject).map(remapProps4Select));
                            const hasAccounts = (hasLoginObj.true || []);
//                            hasAccounts.sort(Utils.charOrdAObject);
                            $(clearEl(queryEl(`${root}.change-password-user-select`))).select2(getSelect2Data(hasAccounts));
                            
                            Utils.enable(exports.content, 'adminOnly', isAdmin);
                            
                            Utils.enableEl(qe(`${root}.change-password-user-select`), hasAccounts.length > 0);
                            Utils.enableEl(qe(`${root}.user.change-password`), hasAccounts.length > 0);
                            Utils.enableEl(qe(`${root}.remove-user-button`), hasAccounts.length > 0);
    //                        fillSelector(clearEl(queryEl(`${root}.change-password-user-select`)), (hasLoginObj.true || [])
    //                            .sort(Utils.charOrdAObject).map(remapProps4Select));
    //                        fillSelector(clearEl(queryEl(`${root}.remove-user-select`)), (hasLoginObj.true || [])
//                            .sort(Utils.charOrdAObject).map(remapProps4Select));
                        });
                    });
                });
            });
        });
    };

    function createUser(dialog) {
        return () => {
            const userNameInput = qee(dialog,`.create-user-name-input`);
            const userPasswordInput = qee(dialog,`.create-user-password-input`);
            DBMS.createPlayer(userNameInput.value.trim(), userPasswordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        userNameInput.value = '';
                        userPasswordInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }
    
    function createUserAccount(dialog) {
        return () => {
            const userNameSelect = qee(dialog,`.create-login-name-select`);
            const passwordInput = qee(dialog,`.create-login-password-input`);
            DBMS.createPlayerLogin(userNameSelect.value, passwordInput.value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    passwordInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function createLogin() {
        const userNameSelect = queryEl(`${root}.create-login-name-select`);
        const passwordInput = queryEl(`${root}.create-login-password-input`);
        DBMS.createPlayerLogin(userNameSelect.value, passwordInput.value, Utils.processError(() => {
            passwordInput.value = '';
            exports.refresh();
        }));
    }

//    function changePassword() {
//        const userNameSelect = queryEl(`${root}.change-password-user-select`);
//        const passwordInput = queryEl(`${root}.change-password-password-input`);
//        DBMS.changePlayerPassword(userNameSelect.value, passwordInput.value, Utils.processError(() => {
//            passwordInput.value = '';
//            exports.refresh();
//        }));
//    }
    
    function changePassword(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const newPassword = toInput.value;
            const userName = queryEl(`${root}.change-password-user-select`).value.trim();
            DBMS.changePlayerPassword(userName, newPassword, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeUser() {
        const name = queryEl(`${root}.change-password-user-select`).value.trim();
        Utils.confirm(strFormat(getL10n('admins-confirm-user-account-remove'), [name]), () => {
            DBMS.removePlayerLogin(name, Utils.processError(exports.refresh));
        });
//        const userNameSelect = queryEl(`${root}.change-password-user-select`);
//        DBMS.removePlayerLogin(userNameSelect.value, Utils.processError(exports.refresh));
    }

    function setWelcomeText(event) {
        DBMS.setWelcomeText(event.target.value, Utils.processError());
    }

    function setPlayerOption(event) {
        DBMS.setPlayerOption(event.target.value, event.target.checked, Utils.processError());
    }
})(this.PlayerManagement = {});

/*Copyright 2015, 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.adaptations-tab ';

    exports.init = () => {
        listen(getEl('events-storySelector'), 'change', updateAdaptationSelectorDelegate);
        listen(getEl('events-characterSelector'), 'change', showPersonalStoriesByCharacters);
        listen(getEl('events-eventSelector'), 'change', showPersonalStoriesByEvents);
        listen(getEl('finishedStoryCheckbox'), 'change', exports.refresh);
        queryEls('.adaptations-tab input[name=adaptationFilter]').map(listen(R.__, 'change', updateFilter));
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        const selector = clearEl(getEl('events-storySelector'));
        clearEl(getEl('events-characterSelector'));
        clearEl(getEl('events-eventSelector'));
        clearEl(getEl('personalStories'));

        PermissionInformer.getEntityNamesArray('story', false, (err, allStoryNames) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getFilteredStoryNames(getEl('finishedStoryCheckbox').checked, (err2, storyNames) => {
                if (err2) { Utils.handleError(err2); return; }
                
                showEl(qe(`${root} .alert`), storyNames.length === 0);
                showEl(qe(`${root} .adaptations-content`), storyNames.length !== 0);
                
                if (storyNames.length <= 0) { return; }

                const selectedStoryName = getSelectedStoryName(storyNames);

                const filteredArr = R.indexBy(R.prop('storyName'), storyNames);
                
                const storyNames2 = allStoryNames.filter(story => R.contains(story.value, R.keys(filteredArr))).map( story => {
                    const elem = filteredArr[story.value];
                    elem.displayName = story.displayName;
                    elem.value = story.value;
                    return elem;
                });

                let option;
                storyNames2.forEach((storyName) => {
                    option = addEl(makeEl('option'), (makeText(storyName.displayName)));
                    addClass(option, getIconClass(storyName));
                    setProp(option, 'selected', storyName.value === selectedStoryName);
                    setProp(option, 'storyInfo', storyName.value);
                    addEl(selector, option);
                });
                setAttr(selector, 'size', Math.min(storyNames2.length, 10));
                showPersonalStories(selectedStoryName);
            });
        });
    };

    function updateAdaptationSelectorDelegate(event) {
        clearEl(getEl('personalStories'));
        const storyName = event.target.selectedOptions[0].storyInfo;
        updateSettings('storyName', storyName);
        updateSettings('characterNames', null);
        updateSettings('eventIndexes', null);
        showPersonalStories(storyName);
    }

    function updateAdaptationSelector(story, allCharacters) {
        const characterSelector = clearEl(getEl('events-characterSelector'));
        const eventSelector = clearEl(getEl('events-eventSelector'));

        let characterArray = getStoryCharacterCompleteness(story);
        let eventArray = getStoryEventCompleteness(story);

        const showOnlyUnfinishedStories = getEl('finishedStoryCheckbox').checked;
        if (showOnlyUnfinishedStories) {
            characterArray = characterArray.filter(elem => !elem.isFinished || elem.isEmpty);
            eventArray = eventArray.filter(elem => !elem.isFinished || elem.isEmpty);
        }

        const characterNames = getCharacterNames(characterArray);
        const eventIndexes = getEventIndexes(eventArray);

        const map = CommonUtils.arr2map(allCharacters, 'value');

        characterArray.forEach((elem) => {
            elem.displayName = map[elem.characterName].displayName;
            elem.value = map[elem.characterName].value;
        });

        characterArray.sort(Utils.charOrdAObject);

        let option;
        characterArray.forEach((elem) => {
            option = addEl(makeEl('option'), (makeText(elem.displayName)));
            addClass(option, getIconClass(elem));
            setProp(option, 'selected', characterNames.indexOf(elem.value) !== -1);
            setProp(option, 'storyInfo', story.name);
            setProp(option, 'characterName', elem.value);
            addEl(characterSelector, option);
        });
        setAttr(characterSelector, 'size', characterArray.length);

        eventArray.forEach((elem) => {
            option = addEl(makeEl('option'), (makeText(elem.name)));
            addClass(option, getIconClass(elem));
            setProp(option, 'selected', eventIndexes.indexOf(elem.index) !== -1);
            setProp(option, 'storyInfo', story.name);
            setProp(option, 'eventIndex222', elem.index);
            addEl(eventSelector, option);
        });
        setAttr(eventSelector, 'size', eventArray.length);

        const { selectedFilter } = DBMS.getSettings().Adaptations;
        getEl(selectedFilter).checked = true;
        updateFilter({
            target: {
                id: selectedFilter
            }
        });
    }

    function updateFilter(event) {
        updateSettings('selectedFilter', event.target.id);
        const byCharacter = event.target.id === 'adaptationFilterByCharacter';
        hideEl(getEl('events-characterSelectorDiv'), !byCharacter);
        hideEl(getEl('events-eventSelectorDiv'), byCharacter);
        if (byCharacter) {
            showPersonalStoriesByCharacters();
        } else {
            showPersonalStoriesByEvents();
        }
    }

    function showPersonalStoriesByCharacters() {
        const eventRows = queryElEls(exports.content, '.eventRow-dependent');
        eventRows.map(removeClass(R.__, 'hidden'));
        nl2array(queryElEls(exports.content, 'div[dependent-on-character]')).map(addClass(R.__, 'hidden'));

        const characterNames = nl2array(getEl('events-characterSelector').selectedOptions).map(opt => opt.characterName);
        characterNames.forEach(name => queryElEls(exports.content, `div[dependent-on-character="${name}"]`).map(removeClass(R.__, 'hidden')));
        eventRows.map(row => hideEl(row, R.intersection(row.dependsOnCharacters, characterNames).length === 0));
        
        updateSettings('characterNames', characterNames);
    }

    function showPersonalStoriesByEvents() {
        queryElEls(exports.content, 'div[dependent-on-character]').map(removeClass(R.__, 'hidden'));
        queryElEls(exports.content, '.eventRow-dependent').map(addClass(R.__, 'hidden'));

        const eventIndexes = nl2array(getEl('events-eventSelector').selectedOptions).map(opt => opt.eventIndex222);
        eventIndexes.forEach(index => removeClass(getEls(`${index}-dependent`)[0], 'hidden'));
        updateSettings('eventIndexes', eventIndexes);
    }

    function getStoryCharacterCompleteness(story) {
        return R.keys(story.characters).map(elem => ({
            characterName: elem,
            isFinished: _isStoryFinishedForCharacter(story, elem),
            isEmpty: _isStoryEmptyForCharacter(story, elem)
        }));
    }

    function _isStoryEmptyForCharacter(story, characterName) {
        return story.events.every(event => event.characters[characterName] === undefined);
    }

    function _isStoryFinishedForCharacter(story, characterName) {
        return story.events.filter(event => event.characters[characterName] !== undefined)
            .every(event => event.characters[characterName].ready === true);
    }

    function getStoryEventCompleteness(story) {
        return story.events.map((event, i) => ({
            name: event.name,
            index: i,
            isFinished: _isEventReady(event),
            isEmpty: Object.keys(event.characters).length === 0
        }));
    }

    function _isEventReady(event) {
        return R.values(event.characters).every(character => character.ready);
    }

    function showPersonalStories(storyName) {
        DBMS.getMetaInfo((err, metaInfo) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getStory(storyName, (err2, story) => {
                if (err2) { Utils.handleError(err2); return; }
                PermissionInformer.isEntityEditable('story', storyName, (err3, isStoryEditable) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, allCharacters) => {
                        if (err4) { Utils.handleError(err4); return; }

                        const characterNames = R.keys(story.characters);
                        const adaptations = characterNames.map(characterName => ({
                            characterName,
                            storyName
                        }));
                        PermissionInformer.areAdaptationsEditable(adaptations, (err5, areAdaptationsEditable) => {
                            if (err5) { Utils.handleError(err5); return; }
                            story.events.forEach((item, i) => (item.index = i));
                            buildAdaptationInterface(
                                storyName, characterNames, story.events, areAdaptationsEditable,
                                metaInfo
                            );
                            updateAdaptationSelector(story, allCharacters);
                            Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                            Utils.enable(exports.content, 'notEditable', false);
                        });
                    });
                });
            });
        });
    }

    function buildAdaptationInterface(storyName, characterNames, events, areAdaptationsEditable, metaInfo) {
        const div = clearEl(getEl('personalStories'));
        if(events.length === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-events-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        if(characterNames.length === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-characters-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        const adaptationsNum = R.flatten(events.map(event => R.keys(event.characters))).length;
        if(adaptationsNum === 0) {
            const alert = qmte('.alert-block-tmpl');
            addEl(alert, makeText(L10n.get('advices', 'no-adaptations-in-story')));
            addClass(alert, 'margin-bottom-8');
            addEl(div, alert);
        }
        
        addEls(div, events.map((event) => {
            const row = qmte(`${root} .adaptation-row-tmpl`);
            addClass(row, `${event.index}-dependent`);
            row.dependsOnCharacters = R.keys(event.characters);
            addEl(qee(row, '.eventMainPanelRow-left'), exports.makeOriginCard(event, metaInfo, storyName, {

                showTimeInput: true,
                showTextInput: true,
                cardTitle: event.name
            }));
            addEls(qee(row, '.events-eventsContainer'), characterNames
                .filter(characterName => event.characters[characterName])
                .map((characterName) => {
                    const isEditable = areAdaptationsEditable[`${storyName}-${characterName}`];
                    return exports.makeAdaptationCard(isEditable, event, storyName, characterName, {
                        showFinishedButton: true,
                        showTimeInput: true,
                        showTextInput: true,
                        cardTitle: characterName
                    });
                }));

            return row;
        }));
    }

    exports.makeOriginCard = (event, metaInfo, storyName, opts) => {
        const card = qmte(`${root} .origin-tmpl`);
        addEl(qee(card, '.card-title'), makeText(opts.cardTitle));
        const textInput = qee(card, '.text-input');
        const timeInput = qee(card, '.time-input');
        const lockButton = qee(card, 'button.locked');

        if (opts.showTimeInput === true) {
            UI.makeEventTimePicker2(timeInput, {
                eventTime: event.time,
                index: event.index,
                preGameDate: metaInfo.preGameDate,
                date: metaInfo.date,
                onChangeDateTimeCreator: onChangeDateTimeCreator(storyName)
            });
        } else {
            addClass(timeInput, 'hidden');
        }

        if (opts.showTextInput === true) {
            textInput.value = event.text;
            textInput.dataKey = JSON.stringify([storyName, event.index]);
            listen(textInput, 'change', onChangeOriginText);
        } else {
            addClass(textInput, 'hidden');
        }

        if (opts.showLockButton === true) {
            listen(lockButton, 'click', onOriginLockClick(timeInput, textInput));
            Utils.enableEl(timeInput, false);
            Utils.enableEl(textInput, false);
            L10n.localizeStatic(card);
        } else {
            addClass(lockButton, 'hidden');
        }

        return card;
    };

    function onOriginLockClick(timeInput, textInput) {
        return (event) => {
            const { target } = event;
            const isLocked = hasClass(target, 'btn-primary');
            setClassByCondition(target, 'btn-primary', !isLocked);
            setClassByCondition(target, 'locked', !isLocked);
            setClassByCondition(target, 'unlocked', isLocked);
            Utils.enableEl(timeInput, isLocked);
            Utils.enableEl(textInput, isLocked);
        };
    }

    exports.makeAdaptationCard = R.curry((isEditable, event, storyName, characterName, opts) => {
        const card = qmte(`${root} .adaptation-tmpl`);
        setAttr(card, 'dependent-on-character', characterName);

        addEl(qee(card, '.card-title'), makeText(opts.cardTitle));
        const textInput = qee(card, '.text-input');
        const timeInput = qee(card, '.time-input');
        const finishedButton = qee(card, 'button.finished');
        const id = JSON.stringify([storyName, event.index, characterName]);

        if (opts.showTimeInput === true) {
            UI.populateAdaptationTimeInput(timeInput, storyName, event, characterName, isEditable);
        } else {
            addClass(timeInput, 'hidden');
        }

        if (opts.showTextInput === true) {
            setClassByCondition(textInput, 'notEditable', !isEditable);
            textInput.value = event.characters[characterName].text;
            textInput.dataKey = JSON.stringify([storyName, event.index, characterName]);
            listen(textInput, 'change', onChangeAdaptationText);
        } else {
            addClass(textInput, 'hidden');
        }

        if (opts.showFinishedButton === true) {
            const isFinished = event.characters[characterName].ready;
            setClassByCondition(finishedButton, 'notEditable', !isEditable);
            setClassIf(finishedButton, 'btn-primary', isFinished);
            finishedButton.id = id;
            const enableInputs = (value) => {
                Utils.enableEl(textInput, !value);
                Utils.enableEl(timeInput, !value);
            };
            enableInputs(isFinished);
            listen(finishedButton, 'click', UI.onChangeAdaptationReadyStatus2(enableInputs));
            L10n.localizeStatic(card);
        } else {
            addClass(finishedButton, 'hidden');
        }

        return card;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onChangeDateTimeCreator = R.curry((storyName, myInput) => (dp, input) => {
        DBMS.setEventOriginProperty(storyName, myInput.eventIndex, 'time', input.val(), Utils.processError());
        removeClass(myInput, 'defaultDate');
    });

    function onChangeOriginText(event) {
        const dataKey = JSON.parse(event.target.dataKey);
        const text = event.target.value;
        DBMS.setEventOriginProperty(dataKey[0], dataKey[1], 'text', text, Utils.processError());
    }

    function onChangeAdaptationText(event) {
        const dataKey = JSON.parse(event.target.dataKey);
        const text = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'text', text, Utils.processError());
    }

    function getIconClass(object) {
        if (object.isEmpty) return 'fa-icon empty select-icon-padding';
        if (object.isFinished) return 'fa-icon finished select-icon-padding';
        return 'fa-icon finished transparent-icon select-icon-padding';
    }

    function updateSettings(name, value) {
        const settings = DBMS.getSettings();
        settings.Adaptations[name] = value;
    }

    function getSelectedStoryName(storyNames) {
        const storyNamesOnly = storyNames.map(R.prop('storyName'));

        const settings = DBMS.getSettings();
        if (!settings.Adaptations) {
            settings.Adaptations = {
                storyName: storyNamesOnly[0],
                characterNames: null,
                eventIndexes: null,
                selectedFilter: 'adaptationFilterByCharacter'
            };
        }
        let { storyName } = settings.Adaptations;
        if (storyNamesOnly.indexOf(storyName) === -1) {
            // eslint-disable-next-line prefer-destructuring
            settings.Adaptations.storyName = storyNamesOnly[0];
            // eslint-disable-next-line prefer-destructuring
            storyName = storyNamesOnly[0];
        }
        return storyName;
    }

    function getNames(nameObjectArray, nameObjectProperty, settingsProperty) {
        const namesOnly = nameObjectArray.map(R.prop(nameObjectProperty));
        const names = DBMS.getSettings().Adaptations[settingsProperty];
        let existingNames;
        if (names === null) {
            existingNames = namesOnly;
        } else {
            existingNames = names.filter(name => namesOnly.indexOf(name) !== -1);
        }

        updateSettings(settingsProperty, existingNames);
        return existingNames;
    }

    function getCharacterNames(characterArray) {
        return getNames(characterArray, 'characterName', 'characterNames');
    }

    function getEventIndexes(eventArray) {
        return getNames(eventArray, 'index', 'eventIndexes');
    }
})(this.Adaptations = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.briefing-export-tab ';

    state.templates = {};
    state.customDocxTemplate = null;

    let generateSingleDocx, generateSingleTxt, refreshStorySetSelect, refreshCharacterSetSelect;

    exports.init = () => {
//        listen(getEl('makeDefaultTextBriefings'), 'click', () => {
//            resolveTextTemplate((textTemplate) => {
//                makeTextBriefings('txt', generateSingleTxt(textTemplate));
//            });
//        });

        listen(getEl('makeCustomTextBriefings'), 'click', () => {
            makeTextBriefings(getEl('textTypeSelector').value, generateSingleTxt(getEl('templateArea').value));
        });
        listen(getEl('makeMarkdownBriefings'), 'click', () => {
            makeTextBriefings('html', R.compose(data => markdownit('commonmark').render(data), generateSingleTxt(getEl('templateArea').value)));
        });

        listen(getEl('docxBriefings'), 'change', readTemplateFile);
        listen(getEl('docxBriefings'), 'focus', (e) => {
            e.target.value = '';
            state.customDocxTemplate = null;
        });

        listen(getEl('makeDocxBriefings'), 'click', () => {
            if (state.customDocxTemplate === null) {
                Utils.alert(getL10n('briefings-custom-docx-template-is-missing'));
            } else {
                exportDocxByTemplate(state.customDocxTemplate);
            }
        });


        let els = queryElEls(document, `${root} input[name=exportCharacterSelection]`);
        els.map(listen(R.__, 'change', onCharacterSelectionChange));
        getEl('exportAllCharacters').checked = true;

        els = queryElEls(document, `${root} input[name=exportStorySelection]`);
        els.map(listen(R.__, 'change', onStorySelectionChange));
        getEl('exportAllStories').checked = true;

        const el = getEl('briefingNumberSelector');
        Constants.briefingNumber.forEach(R.compose(addEl(el), makeOpt));
        listen(el, 'change', refreshCharacterRangeSelect);

        state.briefingNumberSelector = el;
        state.briefingIntervalSelector = getEl('briefingIntervalSelector');
        state.characterSetSelector = getEl('characterSetSelector');
        state.storySetSelector = getEl('storySetSelector');

        getEl('makeBriefingsByTime '.trim()).addEventListener('click', makeExport('templateByTime'));
        getEl('makeBriefingsByStory'.trim()).addEventListener('click', makeExport('templateByStory'));
        getEl('makeInventoryList   '.trim()).addEventListener('click', makeExport('inventoryTemplate'));

        UI.initTabPanel('exportModeButton', 'exportContainer');

        listen(getEl('previewTextOutput'), 'click', previewTextOutput);
        getEl('textBriefingPreviewArea').value = '';

        listen(getEl('showRawData'), 'click', previewTextDataAsIs);

        listen(getEl('convertToDocxTemplate'), 'click', convertToDocxTemplate);
        listen(getEl('generateByDocxTemplate'), 'click', generateByDocxTemplate);

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        resolveTextTemplate((textTemplate) => {
            getEl('templateArea').value = textTemplate;
            refreshCharacterRangeSelect();
            refreshCharacterSetSelect();
            refreshStorySetSelect();
        });
    };

    function resolveTextTemplate(callback) {
        DBMS.getProfileStructure('character', (err, profileSettings) => {
            if (err) { Utils.handleError(err); return; }
            const func = R.compose(R.join(''), R.insert(1, R.__, ['{{profileInfo-', '}}\n']), R.prop('name'));
            const filter = R.compose(R.equals(true), R.prop('doExport'));
            const value = profileSettings.filter(filter).map(func).join('');

            callback(R.replace(/\{0\}/g, value, TEXT_TEMPLATE));
        });
    }

    function onCharacterSelectionChange(event) {
        const exportCharacterRange = event.target.id === 'exportCharacterRange';
        const exportCharacterSet = event.target.id === 'exportCharacterSet';
        hideEl(getEl('characterRangeSelect'), !exportCharacterRange);
        hideEl(getEl('characterSetSelect'), !exportCharacterSet);
    }

    function onStorySelectionChange(event) {
        const exportStorySet = event.target.id === 'exportStorySet';
        hideEl(getEl('storySetSelect'), !exportStorySet);
    }

    function getSelectedUsers() {
        const { id } = getSelectedRadio(qe(root), 'input[name=exportCharacterSelection]');
        switch (id) {
        case 'exportAllCharacters':
            return null;
        case 'exportCharacterRange':
            return JSON.parse(state.briefingIntervalSelector.selectedOptions[0].value);
        case 'exportCharacterSet':
            return nl2array(state.characterSetSelector.selectedOptions).map(opt => opt.value);
        default:
            Utils.alert(`unexpected id: ${id}`);
        }
        return null;
    }

    function getSelectedStories() {
        const { id } = getSelectedRadio(qe(root), 'input[name=exportStorySelection]');
        switch (id) {
        case 'exportAllStories':
            return null;
        case 'exportStorySet':
            return nl2array(state.storySetSelector.selectedOptions).map(opt => opt.value);
        default:
            Utils.alert(`unexpected id: ${id}`);
        }
        return null;
    }

    function refreshCharacterRangeSelect() {
        const selector = clearEl(state.briefingIntervalSelector);
        const num = Number(state.briefingNumberSelector.value);

        let chunks;
        PermissionInformer.getEntityNamesArray('character', false, (err, names) => {
            if (err) { Utils.handleError(err); return; }
            if (names.length > 0) {
                chunks = R.splitEvery(num, names);
                const data = chunks.map(chunk => ({
                    id: JSON.stringify(chunk.map(nameInfo => nameInfo.value)),
                    text: chunk.length === 1 ? chunk[0].displayName :
                        `${chunk[0].displayName} - ${chunk[chunk.length - 1].displayName}`
                }));

                $(`#${state.briefingIntervalSelector.id}`).select2({ data });
            }
        });
    }


    function refreshSetSelect(entityType, selectorName) {
        const multiSel = clearEl(state[selectorName]);
        PermissionInformer.getEntityNamesArray(entityType, false, (err, names) => {
            if (err) { Utils.handleError(err); return; }
            if (names.length > 0) {
                fillSelector(multiSel, names.map(remapProps4Select));
                setAttr(multiSel, 'size', names.length > 15 ? 15 : names.length);
            }
        });
    }

    refreshStorySetSelect = () => refreshSetSelect('story', 'storySetSelector');
    refreshCharacterSetSelect = () => refreshSetSelect('character', 'characterSetSelector');

    function makeExport(type) {
        return () => {
            if (!state.templates[type]) {
                state.templates[type] = atob(templatesArr[type]);
            }
            exportDocxByTemplate(state.templates[type]);
        };
    }

    function postprocessCheckboxes(briefingData, profileStructure, prefix, arrName) {
        const checkboxNames = profileStructure.filter(item => item.type === 'checkbox').map(R.prop('name'));
        briefingData.briefings.forEach((charData) => {
            if (charData[arrName] === undefined) return;
            charData[arrName].forEach((element) => {
                if (checkboxNames.indexOf(element.itemName) !== -1) {
                    element.value = constL10n(Constants[element.value]);
                    element.splittedText = [{ string: element.value }];
                }
            });
            checkboxNames.forEach((name) => {
                charData[prefix + name] = constL10n(Constants[charData[prefix + name]]);
            });
        });
    }

    function getBriefingData(callback) {
        DBMS.getBriefingData(getSelectedUsers(), getSelectedStories(), getEl('exportOnlyFinishedStories').checked, (err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            // some postprocessing
            DBMS.getProfileStructure('character', (err2, characterProfileStructure) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileStructure('player', (err3, playerProfileStructure) => {
                    if (err3) { Utils.handleError(err3); return; }
                    postprocessCheckboxes(briefingData, characterProfileStructure, 'profileInfo-', 'profileInfoArray');
                    postprocessCheckboxes(briefingData, playerProfileStructure, 'playerInfo-', 'playerInfoArray');
                    callback(null, briefingData);
                });
            });
        });
    }

    function exportDocxByTemplate(template) {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            generateBriefings(briefingData, 'docx', generateSingleDocx('blob', template), generateSingleDocx('Uint8Array', template));
        });
    }

    function convertToDocxTemplate() {
        const docxTemplate = makeDocxTemplate('blob');
        Utils.confirm(getL10n('briefings-save-file'), () => {
            saveAs(docxTemplate, FileUtils.makeFileName('template', 'docx'));
        });
    }

    function generateByDocxTemplate() {
        exportDocxByTemplate(makeDocxTemplate('Uint8Array'));
    }

    function makeDocxTemplate(type) {
        let template = getEl('templateArea').value;

        const replaceBrackets = R.pipe(R.replace(/{{{/g, '{'), R.replace(/}}}/g, '}'), R.replace(/{{/g, '{'), R.replace(/}}/g, '}'));
        template = replaceBrackets(template).split('\n').map(string => ({ string }));

        if (!state.templates.genericTemplate) {
            state.templates.genericTemplate = atob(templatesArr.genericTemplate);
        }

        const doc = new window.Docxgen(state.templates.genericTemplate);
        doc.setData({
            splittedText: template
        });
        doc.render();
        return doc.getZip().generate({
            type
        });
    }
    function previewTextDataAsIs() {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            getEl('textBriefingPreviewArea').value = JSON.stringify(briefingData, null, '  ');
        });
    }

    function previewTextOutput() {
        getBriefingData((err, data) => {
            if (err) { Utils.handleError(err); return; }
            getEl('textBriefingPreviewArea').value = generateSingleTxt(getEl('templateArea').value, data);
        });
    }

    function makeTextBriefings(fileType, delegate) {
        getBriefingData((err, briefingData) => {
            if (err) { Utils.handleError(err); return; }
            generateBriefings(briefingData, fileType, (data) => {
                const result = delegate(data);
                return new Blob([result], {
                    type: 'text/plain;charset=utf-8'
                });
            }, delegate);
        });
    }

    function readTemplateFile(evt) {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                state.customDocxTemplate = e.target.result;
                Utils.alert(getL10n('briefings-template-is-loaded'));
            };
            r.readAsBinaryString(f);
        } else {
            Utils.alert(getL10n('briefings-error-on-template-uploading'));
        }
    }

    function updateStatus(text) {
        const exportStatus = getEl('exportStatus');
        clearEl(exportStatus);
        exportStatus.appendChild(makeText(text));
    }

    function generateBriefings(briefingData, fileType, oneFileDelegate, separateFileDelegate) {
        const toSeparateFiles = getEl('toSeparateFileCheckbox').checked;

        const fileName = 'characterSheets';

        let out, archive;
        updateStatus(getL10n('briefings-save-preparing'));
        try {
            if (toSeparateFiles) {
                const zip = new JSZip();
                const content = zip.generate();
                updateStatus(getL10n('briefings-start-saving'));

                const res = makeArchiveData(briefingData, separateFileDelegate);
                R.keys(res).forEach((key) => {
                    zip.file(`${key}.${fileType}`, res[key]);
                });

                updateStatus(getL10n('briefings-archiving'));
                archive = zip.generate({ type: 'blob' });
                updateStatus(getL10n('briefings-archive-is-ready'));
                saveFile('briefings-save-archive', archive, fileName, 'zip');
            } else {
                updateStatus(getL10n('briefings-start-saving'));
                out = oneFileDelegate(briefingData);
                updateStatus(getL10n('briefings-file-is-ready'));
                saveFile('briefings-save-file', out, fileName, fileType);
            }
        } catch (err) {
            Utils.alert(getL10n('briefings-error-on-generating-briefings'));
            console.log(err);
        }
    }

    function saveFile(msgKey, out, fileName, extension) {
        Utils.confirm(getL10n(msgKey), () => {
            saveAs(out, FileUtils.makeFileName(fileName, extension));
        });
    }

    function makeArchiveData(briefingData, generateSingleDelegate) {
        const res = {};
        briefingData.briefings.forEach((briefing, i) => {
            res[briefing.charName] = generateSingleDelegate({
                gameName: briefingData.gameName,
                briefings: [briefing]
            });
            updateStatus(strFormat(getL10n('briefings-save-status'), [i + 1, briefingData.briefings.length]));
        });
        return res;
    }

    generateSingleDocx = R.curry((type, template, data) => {
        const doc = new window.Docxgen(template);
        doc.setData(data);
        doc.render(); // apply them (replace all occurences of {first_name} by
        // Hipp, ...)
        const out = doc.getZip().generate({
            type
        });
        return out;
    });

    generateSingleTxt = R.curry((template, data) => {
        try {
            return Mustache.render(template, data);
        } catch (err) {
            Utils.alert(strFormat(getL10n('briefings-template-error'), [err.message]));
            throw err;
        }
    });
})(this.BriefingExport = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '#briefingPreviewDiv ';
    const settingsPath = 'BriefingPreview';
    const l10n = L10n.get('briefings');

    exports.init = () => {
        $('#briefingCharacter').select2().on('change', buildContentDelegate);

        let button = getEl('eventGroupingByStoryRadio');
        listen(button, 'change', exports.refresh);
        button.checked = true;

        button = getEl('adaptationsModeRadio');
        listen(button, 'change', exports.refresh);
        button.checked = true;

        listen(getEl('eventGroupingByTimeRadio'), 'change', exports.refresh);
        listen(getEl('proofreadingModeRadio'), 'change', exports.refresh);
        listen(getEl('hideAllPanelsCheckbox'), 'change', exports.refresh);
        listen(getEl('disableHeadersCheckbox'), 'change', exports.refresh);

        getEl('hideAllPanelsCheckbox').checked = true;
        
//        listen(getEl('contentArea'), 'scroll', updateGutterScrollPos);
//        listen(getEl('contentArea'), 'resize', rebuildGutter);
        
        initPanelsArr();

        exports.content = getEl('briefingPreviewDiv');
    };
    
//    function updateGutterScrollPos (){
//        let doc = getEl('contentArea');
//        let position = qe(`${root} .gutter-scroll-position`);
//        position.style.top = (doc.scrollTop)/doc.scrollHeight*100 + '%';
//        position.style.height = (doc.clientHeight)/doc.scrollHeight*100 + '%';
//    }
//    
//    function rebuildGutter() {
//        let doc = getEl('contentArea');
//        const gutter = clearEl(qe(`${root} .gutter`));
//        const scrollPos = addClass(makeEl('div'), 'gutter-scroll-position');
//        addEl(gutter, scrollPos);
//        updateGutterScrollPos();
//        
//        const btn = makeEl('button');
//        btn.style.top = '0%';
////        const title = qee(panel, '.panel-title').innerHTML.trim();
//        setAttr(btn, 'title', l10n('to-page-top'));
//        listen(btn, 'click', () => {
//            doc.scrollTop = 0;
////            panel.scrollIntoView();
//        });
//        addEl(gutter, btn);
//        
//        const panels = qees(doc, '#briefingContent > .panel');
//        addEls(gutter, panels.map(panel => {
//            const btn = makeEl('button');
//            btn.style.top = (panel.offsetTop)/doc.scrollHeight*100 + '%';
//            
//            const panelTitle = qee(panel, '.panel-title');
//            const title = panelTitle.innerText || panelTitle.textContent;
//            setAttr(btn, 'title', title);
//            listen(btn, 'click', () => {
//                doc.scrollTop = panel.offsetTop - 40;
////                panel.scrollIntoView();
//            });
//            return btn;
//        }));
//        
//    }

    exports.refresh = () => {
        clearEl(getEl('briefingCharacter'));
        clearEl(getEl('briefingContent'));

        DBMS.getProfileStructure('character', (err, characterProfileStructure) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getProfileStructure('player', (err2, playerProfileStructure) => {
                if (err2) { Utils.handleError(err2); return; }
                state.characterProfileStructure = characterProfileStructure;
                state.playerProfileStructure = playerProfileStructure;
                PermissionInformer.getEntityNamesArray('character', false, (err3, names) => {
                    if (err3) { Utils.handleError(err3); return; }
                    
                    showEl(qe(`${root} .alert`), names.length === 0);
                    showEl(qe(`${root} > div > div > .panel`), names.length !== 0);
                    showEl(qe(`${root} #briefingCharacter`), names.length !== 0);
                    
                    if (names.length > 0) {
                        const characterName = UI.checkAndGetEntitySetting(settingsPath, names);
                        const data = getSelect2Data(names);
                        // this call trigger buildContent
                        $('#briefingCharacter').select2(data).val(characterName).trigger('change');
                    }
                });
            });
        });
    };

    function buildContentDelegate(event) {
        buildContent(event.target.value);
    }

    function buildContent(characterName) {
        UI.updateEntitySetting(settingsPath, characterName);
        const content = clearEl(getEl('briefingContent'));
        let index = 0;
        const data = {
            characterName
        };
        function buildContentInner() {
            if (index < state.panels.length) {
                index++;
                state.panels[index - 1].load(data, buildContentInner);
            } else {
                state.panels.map(R.prop('make')).forEach((make) => {
                    make(content, data);
                });
//                rebuildGutter();
            }
        }
        buildContentInner();
    }

    function getFlags() {
        return {
            isAdaptationsMode: getEl('adaptationsModeRadio').checked,
            isGroupingByStory: getEl('eventGroupingByStoryRadio').checked,
            disableHeaders: getEl('disableHeadersCheckbox').checked,
            hideAllPanels: getEl('hideAllPanelsCheckbox').checked
        };
    }

    function initPanelsArr(){
        state.panels = [{
            name: 'storyRights',
            load(data, callback) {
                PermissionInformer.getEntityNamesArray('story', true, (err, userStoryNames) => {
                    if (err) { Utils.handleError(err); return; }
                    data.userStoryNamesMap = R.indexBy(R.prop('value'), userStoryNames);
                    callback();
                });
            },
            make(el, data) {}
        }, {
            name: 'characterProfile',
            load(data, callback) {
                DBMS.getProfile('character', data.characterName, (err, profile) => {
                    if (err) { Utils.handleError(err); return; }
                    data.profile = profile;
                    callback();
                });
            },
            make(el, data) {
                const label = strFormat(getL10n('briefings-character-profile'), [data.characterName]);
                addEl(el, makePanel(
                    makeText(label),
                    UI.makeProfileTable(state.characterProfileStructure, data.profile), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'playerProfile',
            load(data, callback) {
                DBMS.getProfileBinding('character', data.characterName, (err, binding) => {
                    if (err) { Utils.handleError(err); return; }
                    if (binding[1] === '') {
                        callback();
                    } else {
                        DBMS.getProfile('player', binding[1], (err2, playerProfile) => {
                            if (err2) { Utils.handleError(err2); return; }
                            data.playerProfile = playerProfile;
                            // eslint-disable-next-line prefer-destructuring
                            data.playerName = binding[1];
                            callback();
                        });
                    }
                });
            },
            make(el, data) {
                if (data.playerProfile) {
                    const label = strFormat(getL10n('briefings-player-profile'), [data.playerName]);
                    addEl(el, makePanel(
                        makeText(label),
                        UI.makeProfileTable(state.playerProfileStructure, data.playerProfile), getFlags().hideAllPanels
                    ));
                }
            }
        }, {
            name: 'inventory',
            load(data, callback) {
                DBMS.getAllInventoryLists(data.characterName, (err, allInventoryLists) => {
                    if (err) { Utils.handleError(err); return; }
                    data.allInventoryLists = allInventoryLists.sort(CommonUtils.charOrdAFactory(R.compose(R.toLower, R.prop('storyName'))));
                    callback();
                });
            },
            make(el, data) {
                addEl(el, makePanel(
                        makeText(`${getL10n('briefings-inventory')} (${data.allInventoryLists.length})`),
                        makeInventoryContent(
                                data.allInventoryLists,
                                data.characterName, data.userStoryNamesMap
                        ), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'groups',
            load(data, callback) {
                DBMS.getCharacterGroupTexts(data.characterName, (err, groupTexts) => {
                    if (err) { Utils.handleError(err); return; }
                    data.groupTexts = groupTexts;
                    callback();
                });
            },
            make(el, data) {
                addEl(el, makePanel(
                        makeText(`${getL10n('header-groups')} (${data.groupTexts.length})`),
                        makeGroupContent(data.groupTexts), getFlags().hideAllPanels
                ));
            }
        }, {
            name: 'relations',
            load: Relations.load,
            make(el, data) {
                const label = `${getL10n('header-relations')} (${data.relationsSummary.relations.length})`;
                const content = RelationsPreview.makeRelationsContent(
                        data, getFlags().isAdaptationsMode,
                        state.characterProfileStructure, exports.refresh
                );
                addEl(el, makePanel(makeText(label), content, getFlags().hideAllPanels));
            }
        }, {
            name: 'stories',
            load(data, callback) {
                callback();
            },
            make(el, data) {
                const flags = getFlags();
                if (flags.isGroupingByStory) {
                    showEventsByStory(el, data.characterName, data.userStoryNamesMap, flags);
                } else {
                    showEventsByTime(el, data.characterName, data.userStoryNamesMap, flags);
                }
            }
        }];
    }

    function onBuildContentFinish() {
        UI.initTextAreas(`${root} #briefingContent textarea`);
        UI.refreshTextAreas(`${root} #briefingContent textarea`);
        Utils.enable(exports.content, 'notEditable', false);
    }


    function makePanel(title, content, hideAllPanels) {
        const panelInfo = UI.makePanelCore(title, content);
        UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv, (event, togglePanel) => {
            togglePanel();
//            rebuildGutter();
            UI.refreshTextAreas(`${root} #briefingContent textarea`);
        });
        if (hideAllPanels) {
            panelInfo.a.click();
        }
        return panelInfo.panel;
    }

    function makeGroupContent(groupTexts) {
        return addEls(makeEl('div'), groupTexts.map((groupText) => {
            const div = makeEl('div');
            addEl(div, addEl(makeEl('h4'), makeText(groupText.groupName)));
            const span = addEl(makeEl('textarea'), makeText(groupText.text));
            setAttr(span, 'disabled', 'disabled');
            addClasses(span, ['briefingTextSpan', 'form-control']);
            return addEl(div, span);
        }));
    }

    function makeInventoryContent(allInventoryLists, characterName, userStoryNamesMap) {
        const container = qmte('.profile-editor-container-tmpl');
        return addEls(container, allInventoryLists.map((elem) => {
            const input = makeEl('input');
            input.value = elem.inventory;
            input.storyName = elem.storyName;
            input.characterName = characterName;
            addClasses(input, ['inventoryInput', 'form-control']);
            if (!userStoryNamesMap[elem.storyName]) {
                addClass(input, 'notEditable');
            }
            listen(input, 'change', updateCharacterInventory);

            const row = qmte('.profile-editor-row-tmpl');
            addEl(qee(row, '.profile-item-name'), makeText(elem.storyName));
            addEl(qee(row, '.profile-item-input'), input);
            return row;
        }));
    }

    function showEventsByTime(content, characterName, userStoryNamesMap, flags) {
        DBMS.getCharacterEventsByTime(characterName, (err, allEvents) => {
            if (err) { Utils.handleError(err); return; }
            const adaptations = allEvents.map(event => ({
                characterName,
                storyName: event.storyName
            }));

            PermissionInformer.areAdaptationsEditable(adaptations, (err2, areAdaptationsEditable) => {
                if (err2) { Utils.handleError(err2); return; }

                DBMS.getMetaInfo((err3, metaInfo) => {
                    if (err3) { Utils.handleError(err3); return; }

                    const opts = {
                        userStoryNamesMap,
                        areAdaptationsEditable,
                        showStoryName: true,
                        metaInfo
                    };

                    const splitConstant = 5;

                    addEls(content, R.splitEvery(splitConstant, allEvents).map((subPart, i) => {
                        const eventContent = addEls(makeEl('div'), subPart.map((event, j) => {
                            opts.index = (i * splitConstant) + 1 + j;
                            return showEvent(event, characterName, opts, flags);
                        }));

                        let name;
                        if (flags.disableHeaders) {
                            name = makeText(strFormat(getL10n('briefings-events-header'), [(i * splitConstant) + 1, (i * splitConstant) + subPart.length]));
                        } else {
                            name = addEls(makeEl('div'), subPart.map(event => getEventHeaderDiv(event, true)));
                        }
                        return makePanel(name, eventContent, flags.hideAllPanels);
                    }));
                    onBuildContentFinish();
                });
            });
        });
    }

    function getStoryHeader(elem, i, disableHeaders) {
        let name;
        if (disableHeaders) {
            name = strFormat(getL10n('briefings-story-header'), [i + 1]);
        } else {
            name = elem.storyName;
        }
        return makeText(`${name} (${elem.events.length})`);
    }

    function showEventsByStory(content, characterName, userStoryNamesMap, flags) {
        DBMS.getCharacterEventGroupsByStory(characterName, (err, eventGroups) => {
            if (err) { Utils.handleError(err); return; }
            const adaptations = eventGroups.map(elem => ({
                characterName,
                storyName: elem.storyName
            }));
            PermissionInformer.areAdaptationsEditable(adaptations, (err2, areAdaptationsEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getMetaInfo((err3, metaInfo) => {
                    if (err3) { Utils.handleError(err3); return; }
                    const opts = {
                        userStoryNamesMap,
                        areAdaptationsEditable,
                        showStoryName: false,
                        metaInfo
                    };

                    addEls(content, eventGroups.map((elem, i) => {
                        const storyContent = addEls(makeEl('div'), elem.events.map((event, j) => {
                            opts.index = j + 1;
                            return showEvent(event, characterName, opts, flags);
                        }));
                        return makePanel(
                            getStoryHeader(elem, i, flags.disableHeaders), storyContent,
                            flags.hideAllPanels
                        );
                    }));
                    onBuildContentFinish();
                });
            });
        });
    }

    function getEventHeaderDiv(event, showStoryName) {
        const eventName = addEl(makeEl('span'), makeText(strFormat('{0} {1}', [showStoryName ? `${event.storyName}:` : '', event.name])));
        const eventTime = addClass(addEl(makeEl('span'), makeText(event.time)), 'previewEventTime');
        return addEls(makeEl('div'), [eventTime, eventName]);
    }

    function showEvent(event, characterName, opts, flags) {
        const { isAdaptationsMode } = flags;
        const showAll = isAdaptationsMode;
        const storyName = event.storyName;
        const isStoryEditable = opts.userStoryNamesMap[storyName] !== undefined;
        const showAdaptationText = event.characters[characterName].text !== '';
        const showSubjectiveTime = event.characters[characterName].time !== '';

        const eventDiv = qmte('.adaptation-row-tmpl');
        const originCard = Adaptations.makeOriginCard(event, opts.metaInfo, event.storyName, {
            cardTitle: flags.disableHeaders ? L10n.format('briefings', 'event-header', [opts.index]) : event.name,
            showTimeInput: showAll || !showSubjectiveTime,
            showLockButton: true,
            showTextInput: showAll || !showAdaptationText
        });
        if(!isStoryEditable){
            qees(originCard, '.isStoryEditable').forEach(addClass(R.__, 'notEditable'));
        }
        addEl(qee(eventDiv, '.eventMainPanelRow-left'), originCard);
        const isEditable = opts.areAdaptationsEditable[`${event.storyName}-${characterName}`];
        const adaptationsCard = Adaptations.makeAdaptationCard(
            isEditable, event,
            event.storyName, characterName, {
                cardTitle: '',
                showTimeInput: showAll || showSubjectiveTime,
                showFinishedButton: true,
                showTextInput: showAll || showAdaptationText
            }
        );
        addEl(qee(eventDiv, '.eventMainPanelRow-left'), adaptationsCard);
        return eventDiv;
    }

    function updateCharacterInventory(event) {
        const {
            storyName, characterName, value
        } = event.target;
        DBMS.updateCharacterInventory(storyName, characterName, value, Utils.processError());
    }
})(this.BriefingPreview = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.relations-tab ';
    const state = {};
    const settingsPath = 'Relations';

    exports.init = () => {
        $(`${root} .character-select`).select2().on('change', buildContent);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        clearEl(queryEl(`${root} .character-select`));
        clearEl(queryEl(`${root} .panel-body`));

        DBMS.getProfileStructure('character', (err, characterProfileStructure) => {
            if (err) { Utils.handleError(err); return; }
            state.characterProfileStructure = characterProfileStructure;
            PermissionInformer.getEntityNamesArray('character', false, (err3, names) => {
                if (err3) { Utils.handleError(err3); return; }
                
                showEl(qe(`${root} .alert`), names.length < 2);
                showEl(qe(`${root} > .panel`), names.length > 1);
                
                if (names.length > 0) {
                    const characterName = UI.checkAndGetEntitySetting(settingsPath, names);
                    const data = getSelect2Data(names);
                    // this call trigger buildContent
                    $(`${root} .character-select`).select2(data).val(characterName).trigger('change');
                }
            });
        });
    };

    function buildContent(event) {
        clearEl(queryEl(`${root} .panel-body`));
        const characterName = event.target.value;
        UI.updateEntitySetting(settingsPath, characterName);
        state.data = {};
        state.data.characterName = characterName;
        exports.load(state.data, buildContentInner);
    }

    function buildContentInner() {
        const content = RelationsPreview.makeRelationsContent(
            state.data, true, state.characterProfileStructure,
            exports.refresh
        );
        addEl(queryEl(`${root} .panel-body`), content);
        UI.initTextAreas(`${root} .panel-body textarea`);
        UI.refreshTextAreas(`${root} .panel-body textarea`);
    }

    exports.load = (data, callback) => {
        DBMS.getAllProfiles('character', (err, profiles) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getRelationsSummary(data.characterName, (err2, relationsSummary) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getExtendedProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err4, characterNamesArray) => {
                        if (err4) { Utils.handleError(err4); return; }
                        data.relationsSummary = relationsSummary;
                        data.characterNamesArray = characterNamesArray;
                        data.profiles = profiles;
                        data.profileBindings = R.fromPairs(profileBindings);
                        callback();
                    });
                });
            });
        });
    };
})(this.Relations = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const relationTableHeader = ['character-name', 'direct-relation', 'relation-origin', 'reverse-relation'];
    const partialTableHeader = ['character-name', 'direct-relation'];

    let makeNewRow;
    const l10n = L10n.get('briefings');

    const findRel = R.curry((fromCharacter, toCharacter, relations) => {
        const findFunc = R.curry((fromCharacter2, toCharacter2, rel) =>
            rel[fromCharacter2] !== undefined && rel[toCharacter2] !== undefined);
        return R.find(findFunc(fromCharacter, toCharacter), relations);
    });

    exports.makeRelationsContent = (data, isAdaptationsMode, profileSettings, externalRefresh) => {
        const {
            characterName, relationsSummary, profiles, profileBindings
        } = data;
        let { characterNamesArray } = data;

        characterNamesArray = characterNamesArray.filter(R.compose(R.not, R.equals(characterName), R.prop('value')));

        const get2ndCharName = ProjectUtils.get2ndRelChar(characterName);
        const showCharacters = relationsSummary.relations.map(get2ndCharName).sort(CommonUtils.charOrdA);
        const noRelsList = characterNamesArray.filter(R.compose(R.not, R.contains(R.__, showCharacters), R.prop('value')));
        const predicate = R.compose(R.contains(R.__, R.keys(relationsSummary.knownCharacters)), R.prop('value'));
        const [knownNoRels, unknownNoRels] = R.partition(predicate, noRelsList);

        const relationTmpl = wrapEl('div', qte('.relation-tmpl'));
        const qe = qee(relationTmpl);
        const content = qe('.relation-content');
        const getProfileItemSelect = () => qe('.profile-item-select');

        makeProfileItemSelector(qe('.profile-item-select'), profileSettings, refreshProfileItem(content, profiles));

        const makeRow = makeNewRow(
            profiles, getProfileItemSelect, isAdaptationsMode, relationsSummary.knownCharacters, profileBindings,
            externalRefresh, characterName
        );

        // filling header - need table body for callbacks
        const makeRowCallback = R.compose(addEl(content), makeRow);
        addEl(qe('.known-characters-label'), makeText(l10n('known-characters')));
        const knownBtn = addEl(qe('.add-known-character-relation'), makeText(getL10n('common-add')));
        addEl(qe('.unknown-characters-label'), makeText(l10n('unknown-characters')));
        const unknownBtn = addEl(qe('.add-unknown-character-relation'), makeText(getL10n('common-add')));
        addEl(qe('.profile-item-label'), makeText(l10n('profile-item')));
        fillCharSelector(qe('.known-characters-select'), knownBtn, knownNoRels, characterName, makeRowCallback);
        fillCharSelector(qe('.unknown-characters-select'), unknownBtn, unknownNoRels, characterName, makeRowCallback);

        // filling table
        const toCharacterFilter = toCharacter => (isAdaptationsMode ? true :
            !R.isEmpty(findRel(characterName, toCharacter, relationsSummary.relations)[characterName]));
        const findRelTmp = findRel(characterName, R.__, relationsSummary.relations);
        addEls(content, showCharacters.filter(toCharacterFilter).map(toChar => makeRow(toChar, findRelTmp(toChar))));
        return relationTmpl;
    };

    function refreshProfileItem(content, profiles) {
        return (event) => {
            const dataArr = queryElEls(content, '[toCharacter]');
            dataArr.forEach((el) => {
                const char = getAttr(el, 'toCharacter');
                const selectedName = event.target.value;
                fillProfileItemContent(el, selectedName, profiles[char][selectedName]);
            });
        };
    }

    function makeProfileItemSelector(select1, profileSettings, refresh) {
        select1 = $(select1);
        const tmpSelect = select1.select2(arr2Select2(profileSettings.map(R.prop('name')).sort()));

        select1.select2({ width: 'style' });
        tmpSelect.on('change', refresh);
        if (profileSettings[0]) {
            tmpSelect.val(profileSettings[0].name).trigger('change');
        }
    }

    makeNewRow = R.curry((
        profiles, getProfileItemSelect, isAdaptationsMode, knownCharacters, profileBindings,
        externalRefresh, fromCharacter, toCharacter, rel
    ) => {
        const stories = knownCharacters[toCharacter];
        const row = qmte('.relation-row-tmpl');
        const qe = qee(row);
        addEl(qe('.to-character-name'), makeText(`${toCharacter}/${profileBindings[toCharacter]}`));
        addEl(qe('.where-meets-label'), makeText(l10n('where-meets')));
        addEl(qe('.where-meets-content'), makeText(stories === undefined ? '' : R.keys(stories).join(', ')));
        setAttr(qe('[toCharacter]'), 'toCharacter', toCharacter);
        fillProfileItemContent(row, getProfileItemSelect().value, profiles[toCharacter][getProfileItemSelect().value]);
        listen(qe('button.remove'), 'click', (event) => {
            Utils.confirm(strFormat(l10n('are-you-sure-about-relation-removing'), [`${`${fromCharacter}-${toCharacter}`}`]), () => {
                DBMS.removeCharacterRelation(fromCharacter, toCharacter, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    externalRefresh();
                });
            });
        });

        const directText = qe('.direct textarea');
        directText.value = rel[fromCharacter];
        setAttr(directText, 'placeholder', L10n.format('briefings', 'relation-from-to', [fromCharacter, toCharacter]));
        listen(directText, 'change', (event) => {
            DBMS.setCharacterRelationText(
                fromCharacter, toCharacter, fromCharacter, event.target.value,
                Utils.processError()
            );
        });

        Constants.relationEssences.forEach((name) => {
            const btn = qe(`.${name}`);
            $(btn).tooltip({
                title: L10n.format('briefings', `${name}`, [fromCharacter, toCharacter]),
                placement: 'top'
            });
            let attrName = name;
            if (rel.starter !== fromCharacter) {
                if (name === 'starterToEnder') attrName = 'enderToStarter';
                if (name === 'enderToStarter') attrName = 'starterToEnder';
            }
            setClassByCondition(btn, 'btn-primary', rel.essence.indexOf(attrName) !== -1);
            listen(btn, 'click', (event) => {
                DBMS.setRelationEssenceStatus(fromCharacter, toCharacter, attrName, !hasClass(event.target, 'btn-primary'), (err) => {
                    if (err) { Utils.handleError(err); return; }
                    toggleClass(event.target, 'btn-primary');
                });
            });
        });

        const originText = qe('.origin textarea');
        originText.value = rel.origin;
        setAttr(originText, 'placeholder', l10n('relation-origin'));
        listen(originText, 'change', (event) => {
            DBMS.setOriginRelationText(fromCharacter, toCharacter, event.target.value, Utils.processError());
        });

        const reverseText = qe('.reverse textarea');
        reverseText.value = rel[toCharacter];
        setAttr(reverseText, 'placeholder', L10n.format('briefings', 'relation-from-to', [toCharacter, fromCharacter]));
        listen(reverseText, 'change', (event) => {
            DBMS.setCharacterRelationText(
                fromCharacter, toCharacter, toCharacter,
                event.target.value, Utils.processError()
            );
        });

        const directChecked = rel.starter === fromCharacter ? rel.starterTextReady : rel.enderTextReady;
        fillFinishedButton(
            qe('.direct .finished'), JSON.stringify([fromCharacter, toCharacter]), fromCharacter,
            toCharacter, fromCharacter, directChecked, directText
        );

        const reverseChecked = rel.starter === toCharacter ? rel.starterTextReady : rel.enderTextReady;
        fillFinishedButton(
            qe('.reverse .finished'), JSON.stringify([toCharacter, fromCharacter]), fromCharacter,
            toCharacter, toCharacter, reverseChecked, reverseText
        );

        if (!isAdaptationsMode) {
            removeClass(qe('.direct'), 'col-xs-3');
            addClass(qe('.direct'), 'col-xs-9');
            addClass(qe('.origin'), 'hidden');
            addClass(qe('.reverse'), 'hidden');
        }
        L10n.localizeStatic(row);

        return row;
    });

    function fillFinishedButton(button, id, fromCharacter, toCharacter, character, checked, textarea) {
        setClassIf(button, 'btn-primary', checked);
        Utils.enableEl(textarea, !checked);
        button.id = id;
        listen(button, 'click', (event) => {
            const newValue = !hasClass(button, 'btn-primary');
            setClassByCondition(button, 'btn-primary', newValue);
            Utils.enableEl(textarea, !newValue);
            DBMS.setRelationReadyStatus(fromCharacter, toCharacter, character, newValue, Utils.processError());
        });
    }

    function fillProfileItemContent(el, profileItemName, profileItemValue) {
        addEl(clearEl(qee(el, '.profile-item-name')), makeText(profileItemName));
        addEl(clearEl(qee(el, '.profile-item-value')), makeText(profileItemValue));
    }

    function fillCharSelector(select1, button, data, fromCharacter, makeRowCallback) {
        select1 = $(select1);
        const tmpSelect = select1.select2(getSelect2Data(data));
        select1.select2({ width: 'style' });
        listen(button, 'click', () => {
            const toCharacter = select1[0].value;
            DBMS.createCharacterRelation(fromCharacter, toCharacter, (err) => {
                if (err) { Utils.handleError(err); return; }
                DBMS.getCharacterRelation(fromCharacter, toCharacter, (err2, rel) => {
                    if (err2) { Utils.handleError(err2); return; }
                    makeRowCallback(select1[0].value, rel);
                    data = data.filter(R.compose(R.not, R.equals(select1[0].value), R.prop('value')));
                    clearEl(select1[0]);
                    select1.select2(getSelect2Data(data));
                });
            });
        });
    }
})(this.RelationsPreview = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.gears-tab';
    const state = {};
    const l10n = L10n.get('gears');
    state.nodesDataset = new vis.DataSet();
    state.edgesDataset = new vis.DataSet();
    
    exports.init = () => {
        state.addNodeDialog = UI.createModalDialog(root, updateNode, {
            bodySelector: 'add-or-edit-node-body',
            dialogTitle: 'gears-add-node',
            actionButtonTitle: 'common-save',
            onCancel: onNodeCancel
        });
        
        state.editNodeDialog = UI.createModalDialog(root, updateNode, {
            bodySelector: 'add-or-edit-node-body',
            dialogTitle: 'gears-edit-node',
            actionButtonTitle: 'common-save',
            onCancel: onNodeCancel
        });
        
        state.renameEdgeDialog = UI.createModalDialog(root, renameEdge, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'gears-rename-edge',
            actionButtonTitle: 'common-save',
        });
        
        const configureNetworkDialog = UI.createModalDialog(root, (dialog) => () => dialog.hideDlg(), {
            bodySelector: 'config-inner-body',
            dialogTitle: 'gears-configure-network',
            actionButtonTitle: 'common-close',
        });
        
        addClass(qee(configureNetworkDialog, '.modal-dialog'), 'gears-config-dialog');
        
        queryEl(`${root} .custom-physics-settings`).value = '';
        
//        document.querySelector('.nodesText').value = charExample;
//        setAttr(document.querySelector('.nodesText'),'rows', charExample.split('\n').length);
//        document.querySelector('.edgesText').value = edgesExample;
//        setAttr(document.querySelector('.edgesText'),'rows', edgesExample.split('\n').length);
        
        listen(qe(`${root} .draw-button`), 'click', exports.refresh);
        listen(qe(`${root} .get-image-button`), 'click', getImage);
        listen(qe(`${root} .download-button`), 'click', downloadCsv);
        listen(qe(`${root} .download-json-button`), 'click', downloadJSON);
        listen(qe(`${root} .download-graphml-button`), 'click', downloadYED);
        listen(qe(`${root} .clear-button`), 'click', clearNetwork);
        
        listen(queryEl(`${root} .physics-settings-button`), 'click', () => configureNetworkDialog.showDlg());
        
        listen(queryEl(`${root} .search-node`), 'change', onNodeFocus);
        
        listen(queryEl(`${root} .custom-physics-settings-button`), 'click', () => {
            const options = queryEl(`${root} .custom-physics-settings`).value;
            if(options.trim() === ''){
                return;
            }
            if(CommonUtils.startsWith(options, 'var options = ')){
                options = options.substring('var options = '.length);
            }
            try{
                options = JSON.parse(options);
            }catch(e){
                console.error(e);
                Utils.alert(l10n('error-on-settings-loading'));
                return;
            }
            state.network.setOptions(options);
        });
        
        queryEl(`${root} .physics-enabled-checkbox`).checked = false;
        listen(queryEl(`${root} .physics-enabled-checkbox`), 'change', (event) => {
            DBMS.setGearsPhysicsEnabled(event.target.checked, (err) => {
                if (err) { Utils.handleError(err); return; }
                state.network.setOptions({
                    "physics": {
                        "enabled": event.target.checked,
                        "minVelocity": 0.75
                    }
                })
            });
        });
        
        queryEl(`${root} .show-notes-checkbox`).checked = false;
        listen(queryEl(`${root} .show-notes-checkbox`), 'change', (event) => {
            DBMS.setGearsShowNotesEnabled(event.target.checked, (err) => {
                if (err) { Utils.handleError(err); return; }
                exports.refresh();
            });
        });
        
        queryEl(`${root} .big-picture-checkbox`).checked = false;
        listen(queryEl(`${root} .big-picture-checkbox`), 'change', (event) => {
            setClassByCondition(queryEl(`${root} .mynetwork > div`),'big-picture',event.target.checked);
        });
        
        state.nodesDataset.on('*', () => {
            fillSearchSelect();
        });
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getAllGearsData((err, data) => {
            if (err) { Utils.handleError(err); return; }
            queryEl(`${root} .show-notes-checkbox`).checked = data.settings.showNotes;
            queryEl(`${root} .physics-enabled-checkbox`).checked = data.settings.physicsEnabled;
            
            data.nodes.forEach(node => {
                node.label = makeLabel(node.name, node.notes);
            });
            state.nodesDataset.clear();
            state.nodesDataset.add(data.nodes);
            state.edgesDataset.clear();
            state.edgesDataset.add(data.edges);
            drawNetwork();
        });
    };
    
    // create a network
    function drawNetwork() {
      const container = qe(`${root} .mynetwork`);
      clearEl(queryEl(`${root} .configInner`));
      const options = {
        locale: L10n.getLocale(),
        locales: Constants.visLocales,
        manipulation: {
            addNode: function (data, callback) {
                data.label = '';
                data.name = '';
                
                qee(state.addNodeDialog, '.node-id').value = data.id;
                qee(state.addNodeDialog, '.node-name').value = data.name;
                qee(state.addNodeDialog, '.node-group').value = '';
                qee(state.addNodeDialog, '.node-notes').value = '';
                
                state.nodeData = data;
                state.nodeCallback = callback;
                
                state.addNodeDialog.showDlg();
            },
            editNode: function (data, callback) {
                qee(state.editNodeDialog, '.node-id').value = data.id;
                qee(state.editNodeDialog, '.node-name').value = data.name;
                qee(state.editNodeDialog, '.node-group').value = data.group;
                qee(state.editNodeDialog, '.node-notes').value = data.notes;
                
                state.nodeData = data;
                state.nodeCallback = function(data) {
                    callback(data);
                }.bind(this);
                
                state.editNodeDialog.showDlg();
            },
            addEdge: function (data, callback) {
                data.arrows ='to';
                data.label ='';
                if (data.from == data.to) {
                    Utils.confirm(l10n('do-you-want-to-connect-node-to-itself'), () => {
                        callback(data);
                    }, () => callback());
                }
                else {
                  callback(data);
                }
            },
            editEdge:function (data, callback) {
                callback(data);
                storeData();
            },
            deleteNode:function (data, callback) {
                callback(data);
                storeData();
            },
            deleteEdge:function (data, callback) {
                callback(data);
                storeData();
            },
        },
        physics: {
          enabled: queryEl(`${root} .physics-enabled-checkbox`).checked,
          stabilization: false
        },
        "edges": {
          "smooth": {
            "type": "discrete",
            "forceDirection": "none"
          }
        },
        configure: {
          filter:function (option, path) {
            if (path.indexOf('physics') !== -1) {
              return true;
            }
            if (path.indexOf('smooth') !== -1 || option === 'smooth') {
              return true;
            }
            return false;
          },
          container: qe(`${root} .configInner`)
        }
      };
      const data = {
        nodes: state.nodesDataset,
        edges: state.edgesDataset
      };
      state.network = new vis.Network(container, data, options);
      state.network.on('selectEdge', showEdgeLabelEditor);
      state.network.on('dragEnd', (params) => storeData());
      state.network.on('stabilized', (params) => storeData());
    }
    
    function storeData(callback){
        DBMS.setGearsData(exportNetwork(), (err) => {
            if (err) { Utils.handleError(err); return; }
            if(callback) callback();
        });
    }
    
    function exportNetwork() {
        state.network.storePositions();
        const nodePositions = state.network.getPositions();
        
        console.log(nodePositions);
        const nodes = R.clone(state.nodesDataset.get());
        const edges = state.edgesDataset.get();
        nodes.forEach(node => delete node.color);
        return {
            nodes,
            edges
        };
    }
    
    function importNetwork(data) {
        const {nodes, edges} = data;
        state.nodesDataset.clear();
        state.edgesDataset.clear();
        state.nodesDataset.update(nodes);
        state.edgesDataset.update(edges);
    }

    function showEdgeLabelEditor(params) {
        if (params.edges.length !== 0 && params.nodes.length === 0) {
            const edge = state.edgesDataset.get(params.edges[0]);
            qee(state.renameEdgeDialog, '.entity-input').value = edge.label || '';
            state.edgeData = edge;
            state.edgeCallback = (edge) => state.edgesDataset.update(edge);
            state.renameEdgeDialog.showDlg();
        }
    }

    function makeLabel(name, notes){
      let label = prepareStr(name); 
      if(queryEl(`${root} .show-notes-checkbox`).checked){
        label += (notes.trim() !== '' ? ('\n\n' + prepareStr(notes)) : '');
      }
      return label;
    }

    function prepareStr(text) {
        const maxStrLength = 30;
        return text.split('\n').map((str, i, strings) => {
            let counter = 0;
            const words = str.split(' ');
            return words.reduce((acc, word) => {
                if((counter + word.length + 1) <=  maxStrLength) {
                    acc += word + ' ';
                    counter += word.length + 1;
                } else {
                    acc += '\n' + word + ' ';
                    counter = 0;
                }
                return acc;
            }, '');
        }).join('\n');
        
        
//        return text.split('\n').map(R.splitEvery(30)).map(R.join('-\n')).join('\n');
    }


    function getImage(event){
      const canvas = document.querySelector("canvas");
      
      const context = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      
      context.globalCompositeOperation = "destination-over";
      context.fillStyle = "#ffffff";
      context.fillRect(0,0,w,h);
      
      setAttr(event.target, 'download', FileUtils.makeFileName('gears','png'));
      
      const img    = canvas.toDataURL("image/png");
      const link = document.querySelector(".link");
      event.target.href = img;
      drawNetwork();
    }

    function clearNetwork(){
        Utils.confirm(l10n('confirm-clearing'), () => {
            state.nodesDataset.clear();
            state.edgesDataset.clear();
            storeData(exports.refresh);
        });
    }

    function updateNodeTextArea(){
      document.querySelector('.nodesText').value = state.nodesDataset.map((node) => [node.name, node.group, node.notes].join('\t')).join('\n');
    }

    function updateEdgeTextArea(){
      document.querySelector('.edgesText').value = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
          state.nodesDataset.get(edge.to).name].join('\t')).join('\n');
    }

    function fillSearchSelect(){
      const arr = state.nodesDataset.map((node) => ({name: node.name, value: node.id}));
      arr.sort(CommonUtils.charOrdAFactory(a => a.name.toLowerCase()));
      fillSelector(clearEl(queryEl('.search-node')), arr);
    }

    function downloadCsv() {
        const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
        const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
          state.nodesDataset.get(edge.to).name]);
          
        FileUtils.arr2d2Csv(arr.concat([['']]).concat(arr2), 'gears');
    }

    function downloadJSON() {
      const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
      const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
        state.nodesDataset.get(edge.to).name]);
        
      const out = new Blob([JSON.stringify({nodes: arr, edges: arr2}, null, '  ')], {
          type: 'application/json;charset=utf-8;'
      });
      saveAs(out, FileUtils.makeFileName('gears', 'json'));
    }

    function downloadYED() {
      const arr = state.nodesDataset.map((node) => [node.name, node.group, node.notes]);
      const arr2 = state.edgesDataset.map((edge) => [state.nodesDataset.get(edge.from).name, edge.label, 
        state.nodesDataset.get(edge.to).name]);
      
      const groups = {};
      let index = 1;
      state.nodesDataset.map(node => {
        if(groups[node.group] === undefined){
          groups[node.group] = index;
          index++;
        }
      });
        
      const nodes = state.nodesDataset.map(node => {
        const colors = Constants.colorPalette[groups[node.group]-1].color;
        return CommonUtils.strFormat(Constants.yedNodeTmpl, [node.id, node.label, colors.background, colors.border]);
      }).join('\n');
      
      const edges = state.edgesDataset.map(edge => {
        return CommonUtils.strFormat(Constants.yedEdgeTmpl, [edge.id, edge.label || '', edge.from, edge.to]);
      }).join('\n');
      const out = new Blob([CommonUtils.strFormat(Constants.yedGmlBase, [nodes, edges])], {
          type: 'text/xml;charset=utf-8;'
      });
      saveAs(out, FileUtils.makeFileName('gears', 'graphml'));
    }

    function onNodeFocus(event) {
        state.network.focus(event.target.value, Constants.snFocusOptions);
    }

    function renameEdge(dialog) {
        return () => {
            if(state.edgeData){
                const toInput = qee(dialog, '.entity-input');
                const label = toInput.value.trim();
                const edge = state.edgeData;
                edge.label = label;
                toInput.value = '';
                state.edgeCallback(edge);
                state.edgeData = null;
                state.edgeCallback = null;
                storeData();
                dialog.hideDlg();
            }
        }
    }
    
    function updateNode(dialog) {
        return () => {
            if( state.nodeData ){
                let data = state.nodeData;
                data.id = qee(dialog, '.node-id').value;
                data.name = qee(dialog, '.node-name').value;
                data.group = qee(dialog, '.node-group').value;
                data.notes = qee(dialog, '.node-notes').value;
                data.label = makeLabel(data.name, data.notes);
                data.shape = 'box';
                
                const extraFields = R.difference(R.keys(data), Constants.gearsNodeRequiredFields);
                data = R.omit(extraFields, data);
                
                state.nodeCallback(data);
                
                state.nodeData = null;
                state.nodeCallback = null;
                storeData(exports.refresh);
                dialog.hideDlg();
            }
        };
    }
    
    function onNodeCancel() {
        if( state.nodeData ){
            state.nodeCallback(null);
            state.nodeData = null;
            state.nodeCallback = null;
        }
    }
})(this.Gears = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

function AddFilterConditionDialog(root) {
    this.dialog = UI.createModalDialog(root, this.onAction.bind(this), {
        bodySelector: 'add-filter-condition-body',
        dialogTitle: 'groups-add-filter-condition',
        actionButtonTitle: 'common-ok',
    });
    listen(qee(this.dialog, `.profile-item-selector`), 'change', this.onProfileItemSelect.bind(this));
}

AddFilterConditionDialog.prototype.showDlg = function(groups, callback){
    this.callback = callback;
    this.items = R.indexBy(R.prop('name'), R.unnest(groups.map(R.prop('array'))));
    
    const selector = qee(this.dialog, `.profile-item-selector`);
    UI.fillShowItemSelector2(
        clearEl(selector),
        groups,
        false
    );
    selector.options[0].selected = true;
    
    this.onProfileItemSelect({target: selector});
    
    this.dialog.showDlg();
    // to set dialog title
//    setAttr(qee(el, '.modal-title'), 'l10n-id', opts.dialogTitle);
    
}

AddFilterConditionDialog.prototype.onAction = function (dialog){
    return function () {
        console.log(this.getFilterModelItem());
        this.callback(this.getFilterModelItem());
        dialog.hideDlg();
    }.bind(this);
} 

AddFilterConditionDialog.prototype.getFilterModelItem = function () {
    const opt = qee(this.dialog, `.profile-item-selector`).selectedOptions[0];
    const item = this.items[opt.value];
    
    const filterItem = {
        type: item.type,
        name: item.name
    };
    
    const conditionContainer = (qee(this.dialog, '.condition'));
    const valueContainer = (qee(this.dialog, '.value'));
    
    let arr;
    switch (item.type) {
    case 'enum':
    case 'checkbox':
        arr = nl2array(qee(valueContainer, 'select').selectedOptions).map(R.prop('value'));
        filterItem.selectedOptions = R.zipObj(arr, R.repeat(true, arr.length));
        break;
    case 'number':
        filterItem.condition = qee(conditionContainer, 'select').value;
        filterItem.num = Number(qee(valueContainer, 'input').value);
        
//        if (inputItem.value === 'ignore') { return; }
//        num = Number(state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value);
//        model.push({
//            type, name: inputItemName, num, condition: inputItem.value
//        });
        break;
    case 'multiEnum':
        filterItem.condition = qee(conditionContainer, 'select').value;
        arr = nl2array(qee(valueContainer, 'select').selectedOptions).map(R.prop('value'));
        filterItem.selectedOptions = R.zipObj(arr, R.repeat(true, arr.length));
//        if (inputItem.value === 'ignore') { return; }
//        selectedOptions = {};
//        select2 = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
//        arr = nl2array(select2.selectedOptions).map(R.prop('value'));
//        model.push({
//            type,
//            name: inputItemName,
//            condition: inputItem.value,
//            selectedOptions: R.zipObj(arr, R.repeat(true, arr.length))
//        });
        break;
    case 'text':
    case 'string':
        filterItem.regexString = qee(valueContainer, 'input').value.toLowerCase();
//        model.push({ type, name: inputItemName, regexString: inputItem.value.toLowerCase() });
        break;
    default:
        throw new Error(`Unexpected type ${type}`);
    }
    return filterItem;
}

AddFilterConditionDialog.prototype.onProfileItemSelect = function (event) {
    const opt = event.target.selectedOptions[0];
    const item = this.items[opt.value];
    console.log(item);
    
    const conditionContainer = clearEl(qee(this.dialog, '.condition'));
    switch (item.type) {
    case 'text':
    case 'string':
        addEl(conditionContainer, qmte('.text-condition-tmpl'));
        break;
    case 'enum':
    case 'checkbox':
        addEl(conditionContainer, qmte('.enum-condition-tmpl'));
        break;
    case 'multiEnum':
        addEl(conditionContainer, qmte('.multienum-condition-tmpl'));
        break;
    case 'number':
        addEl(conditionContainer, qmte('.number-condition-tmpl'));
        break;
    default:
        throw new Error(`Unexpected type ${item.type}`);
    }
    
    const valueContainer = clearEl(qee(this.dialog, '.value'));
    let valueInput, values;
    switch (item.type) {
    case 'text':
    case 'string':
        addEl(valueContainer, qmte('.text-value-tmpl'));
        break;
    case 'checkbox':
        addEl(valueContainer, qmte('.checkbox-value-tmpl'));
        break;
    case 'enum':
    case 'multiEnum':
        valueInput = qmte('.enum-value-tmpl');
        values = item.value.split(',');
        values.sort(CommonUtils.charOrdA);
        values = arr2Select(values);
        valueInput.size = values.length;

        fillSelector(valueInput, values.map((value) => {
            value.selected = true;
            return value;
        }));
        addEl(valueContainer, valueInput);
        break;
    case 'number':
        addEl(valueContainer, qmte('.number-value-tmpl'));
        break;
    default:
        throw new Error(`Unexpected type ${item.type}`);
    }
    L10n.localizeStatic(this.dialog);
//    console.log(item);
}
/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

function FilterConfiguration(info) {
    this.info = info;
    function populateProfileItems(item) {
        if (!CommonUtils.startsWith(item.name, Constants.CHAR_PREFIX) &&
            !CommonUtils.startsWith(item.name, Constants.PLAYER_PREFIX)) {
            item.displayName = getL10n(item.displayName);
            item.value = '';
        }
    }
    this.groupedProfileFilterItems = CommonUtils.clone(info.groupedProfileFilterItems);
    this.groupedProfileFilterItems.map(R.prop('profileFilterItems')).map(R.map(populateProfileItems));
}

FilterConfiguration.makeFilterConfiguration = function (callback) {
    DBMS.getProfileFilterInfo((err, info) => {
        if (err) { Utils.handleError(err); return; }
        const filterConfiguration = new FilterConfiguration(info);
        callback(null, filterConfiguration);
    });
};

FilterConfiguration.prototype.getProfileFilterItems = function () {
    return R.flatten(this.groupedProfileFilterItems.map(R.prop('profileFilterItems')));
};

FilterConfiguration.prototype.getProfileItemSource = function (name) {
    let source;
    this.groupedProfileFilterItems.forEach( (el) => {
        const arr = el.profileFilterItems.map(R.prop('name'));
        if(R.contains(name, arr)){
            source = el.name;
        }
    });
    return source;
};

FilterConfiguration.prototype.getName2SourceMapping = function () {
    return this.groupedProfileFilterItems.reduce( (acc, group) => {
        group.profileFilterItems.forEach( item => acc[item.name] = group.name);
        return acc;
    }, {});
};

FilterConfiguration.prototype.getName2DisplayNameMapping = function () {
    return this.groupedProfileFilterItems.reduce( (acc, group) => {
        group.profileFilterItems.forEach( item => acc[item.name] = item.displayName);
        return acc;
    }, {});
};

FilterConfiguration.prototype.getGroupedProfileFilterItems = function () {
    return this.groupedProfileFilterItems;
};

FilterConfiguration.prototype.getGroupsForSelect = function() {
    return this.groupedProfileFilterItems.map((group) => ({
        displayName: getL10n(`profile-filter-${group.name}`),
        array: group.profileFilterItems
    }));
}

FilterConfiguration.prototype.getBaseProfileSettings = function () {
    return {
        characters: this.info.characters.profileStructure,
        players: this.info.players.profileStructure
    };
};

FilterConfiguration.prototype.getDataArrays = function (filterModel) {
    return ProjectUtils.getDataArrays(this.info, filterModel);
};

FilterConfiguration.prototype.haveProfiles = function () {
    return R.keys(this.info.characters.profiles).length > 0 || R.keys(this.info.players.profiles).length > 0;
};

FilterConfiguration.prototype.haveProfileStructures = function () {
    return this.info.characters.profileStructure.length > 0 || this.info.players.profileStructure.length > 0;
};

FilterConfiguration.prototype.haveData = function () {
    return this.haveProfiles() && this.haveProfileStructures();
};

FilterConfiguration.prototype.getProfileIds = function (filterModel) {
    const offset = this.groupedProfileFilterItems[0].profileFilterItems.length;
    return this.getDataArrays(filterModel).map(dataArray => `${dataArray[0].value || ''}/${dataArray[offset].value || ''}`).sort();
};

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.group-profile-tab ';
    const l10n = L10n.get('groups');
    const settingsPath = 'GroupProfile';

    exports.init = () => {
        const createGroupDialog = UI.createModalDialog(root, exports.createGroup(true, exports.refresh), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-group-name',
            actionButtonTitle: 'common-create',
        });
        listen(qe(`${root}.create`), 'click', () => createGroupDialog.showDlg());

        state.renameGroupDialog = UI.createModalDialog(root, renameGroup, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-new-group-name',
            actionButtonTitle: 'common-rename',
        });

        const tbody = clearEl(queryEl(`${root} .entity-profile`));

        state.inputItems = {};

        Constants.groupProfileStructure.forEach((profileSettings) => {
            profileSettings.displayName = getL10n(`groups-${profileSettings.name}`);
            addEl(tbody, makeInput(profileSettings));
        });

        listen(queryEl(`${root} .entity-filter`), 'input', filterOptions);

        exports.content = queryEl(`${root}`);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('group', false, (err, groupNames) => {
            if (err) { Utils.handleError(err); return; }
            
            showEl(qe(`${root} .alert`), groupNames.length === 0);
            showEl(qe(`${root} .col-xs-9`), groupNames.length !== 0);
            Utils.enableEl(qe(`${root} .entity-filter`), groupNames.length !== 0);
            
            addEls(clearEl(queryEl(`${root} .entity-list`)), groupNames.map((name, i, arr) => {
                const el = wrapEl('div', qte('.entity-item-tmpl'));
                addEl(qee(el, '.primary-name'), makeText(name.displayName));
                setAttr(el, 'primary-name', name.displayName);
                setAttr(el, 'profile-name', name.value);
                listen(qee(el, '.select-button'), 'click', showProfileInfoDelegate2(name.value));
                setAttr(qee(el, '.rename'), 'title', l10n('rename-entity'));
                const removeBtn = qee(el, '.remove');
                setAttr(removeBtn, 'title', l10n('remove-entity'));
                if(i+1 < arr.length){
                    removeBtn.nextName = arr[i+1].value;
                }
                if(i > 0){
                    removeBtn.prevName = arr[i-1].value;
                }
                if (name.editable) {
                    listen(qee(el, '.rename'), 'click', () => {
                        qee(state.renameGroupDialog, '.entity-input').value = name.value;
                        state.renameGroupDialog.fromName = name.value;
                        state.renameGroupDialog.showDlg();
                    });
                    listen(removeBtn, 'click', GroupProfile.removeGroup(() => name.value, exports.refresh, removeBtn));
                } else {
                    setAttr(qee(el, '.rename'), 'disabled', 'disabled');
                    setAttr(removeBtn, 'disabled', 'disabled');
                }
                return el;
            }));

            showProfileInfoDelegate2(UI.checkAndGetEntitySetting(settingsPath, groupNames))();
        });
    };

    function makeInput(profileItemConfig) {
        let input;
        switch (profileItemConfig.type) {
        case 'text':
            input = makeEl('textarea');
            addClass(input, 'profileTextInput form-control');
            input.addEventListener('change', updateFieldValue(profileItemConfig.type));
            break;
        case 'checkbox':
            input = makeEl('input');
            input.type = 'checkbox';
            addClass(input, 'form-control');
            input.addEventListener('change', updateFieldValue(profileItemConfig.type));
            break;
        case 'container':
            input = makeEl('div');
            input.type = 'container';
            break;
        default:
            throw new Error(`Unexpected type ${profileItemConfig.type}`);
        }
        input.selfName = profileItemConfig.name;
        addClass(input, 'isGroupEditable');
        state.inputItems[profileItemConfig.name] = input;

        const row = qmte('.profile-editor-row-tmpl');
        addEl(qee(row, '.profile-item-name'), makeText(profileItemConfig.displayName));
        setAttr(qee(row, '.profile-item-name'), 'l10n-id', `groups-${profileItemConfig.name}`);
        addEl(qee(row, '.profile-item-input'), input);
        return row;
    }

    function updateFieldValue(type) {
        return (event) => {
            const fieldName = event.target.selfName;
            const groupName = state.name;

            let value;
            switch (type) {
            case 'text':
                // eslint-disable-next-line prefer-destructuring
                value = event.target.value;
                DBMS.updateGroupField(groupName, fieldName, value, Utils.processError());
                break;
            case 'checkbox':
                value = event.target.checked;
                DBMS.doExportGroup(groupName, value, Utils.processError());
                break;
            default:
                throw new Error(`Unexpected type ${type}`);
            }
        };
    }

    function showProfileInfoDelegate2(name) {
        return () => {
            queryEls(`${root} [profile-name] .select-button`).map(removeClass(R.__, 'btn-primary'));
            if(name !== null){
                UI.updateEntitySetting(settingsPath, name);
                const el = queryEl(`${root} [profile-name="${name}"] .select-button`);
                addClass(el, 'btn-primary');
                
                const parentEl = el.parentElement.parentElement;
                const entityList = queryEl(`${root} .entity-list`);
                UI.scrollTo(entityList, parentEl);
                
                DBMS.getGroup(name, showProfileInfoCallback);
            }
        };
    }

    function showProfileInfoCallback(err, group) {
        if (err) { Utils.handleError(err); return; }
        const { name } = group;
        FilterConfiguration.makeFilterConfiguration((err1, filterConfiguration) => {
            if (err1) { Utils.handleError(err1); return; }

            PermissionInformer.isEntityEditable('group', name, (err2, isGroupEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                updateSettings(name);
                
                const name2DisplayName = filterConfiguration.getName2DisplayNameMapping();
                
                const name2Source = filterConfiguration.getName2SourceMapping();

                state.name = name;
                const { inputItems } = state;
                Object.keys(inputItems).forEach((inputName) => {
                    if (inputItems[inputName].type === 'checkbox') {
                        inputItems[inputName].checked = group[inputName];
                    } else if (inputItems[inputName].type === 'container') {
                        if (inputName === 'filterModel') {
                            const table = qmte(`${root} .group-filter-template`);
                            const datas = group.filterModel.map(exports.makeFilterItemString(name2DisplayName, name2Source));
                            addEls(qee(table, 'tbody'), datas.map(data2row));
                            L10n.localizeStatic(table);
                            addEl(clearEl(inputItems[inputName]), table);
                        } else if (inputName === 'characterList') {
                            const data = filterConfiguration.getProfileIds(group.filterModel);
                            const inputItem = clearEl(inputItems[inputName]);
                            addEls(inputItem, [makeText(data.join(', ')), makeEl('br'), makeText(getL10n('groups-total') + data.length)]);
                        } else {
                            throw new Error(`Unexpected container: ${inputName}`);
                        }
                    } else if (inputItems[inputName].type === 'textarea') {
                        inputItems[inputName].value = group[inputName];
                    } else {
                        throw new Error(`Unexpected input type: ${inputItems[inputName].type}`);
                    }
                    inputItems[inputName].oldValue = group[inputName];
                    Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
                });
            });
        });
    }

    // eslint-disable-next-line no-var,vars-on-top
    exports.makeFilterItemString = R.curry((name2DisplayName, name2Source, filterItem) => {
        const displayName = name2DisplayName[filterItem.name];
        const source = name2Source[filterItem.name];
        let condition, arr, value;
        switch (filterItem.type) {
        case 'enum':
            condition = getL10n(`groups-one-from`);
            value = Object.keys(filterItem.selectedOptions).join(', ');
            break;
        case 'checkbox':
            arr = [];
            if (filterItem.selectedOptions.true) { arr.push(getL10n('constant-yes')); }
            if (filterItem.selectedOptions.false) { arr.push(getL10n('constant-no')); }
            condition = getL10n(`groups-one-from`);
            value = arr.join(', ');
            break;
        case 'number':
            condition = getL10n(`constant-${filterItem.condition}`);
            value = filterItem.num;
            break;
        case 'multiEnum':
            condition = getL10n(`constant-${filterItem.condition}`);
            value = Object.keys(filterItem.selectedOptions).join(', ');
            break;
        case 'text':
        case 'string':
            condition = getL10n('groups-text-contains');
            value = filterItem.regexString;
            break;
        default:
            throw new Error(`Unexpected type ${filterItem.type}`);
        }
        const title = getL10n(`profile-filter-${source}`) + ', ' + getL10n(`constant-${filterItem.type}`);
        return {displayName, title, condition, value};
    });
    
    function data2row(data){
        const {displayName, title, condition, value} = data;
        const row = qmte(`${root} .group-filter-row-template`);
        addEl(qee(row, '.profile-item'), makeText(displayName));
        setAttr(qee(row, '.profile-item'), 'title', title);
        addEl(qee(row, '.condition'), makeText(condition));
        addEl(qee(row, '.value'), makeText(value));
        return row;
    }

    function updateSettings(name) {
        const settings = DBMS.getSettings();
        settings.GroupProfile.groupName = name;
    }

    function filterOptions(event) {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            hideEl(el, !isVisible);
        });

        if (queryEl(`${root} .hidden[primary-name] .select-button.btn-primary`) !== null ||
            queryEl(`${root} [primary-name] .select-button.btn-primary`) === null) {
            const els2 = queryEls(`${root} [primary-name]`).filter(R.pipe(hasClass(R.__, 'hidden'), R.not));
            showProfileInfoDelegate2(els2.length > 0 ? getAttr(els2[0], 'profile-name') : null)();
        } else {
            //            queryEl(`${root} [primary-name] .select-button.btn-primary`).scrollIntoView();
        }
    }

    exports.createGroup = (updateSettingsFlag, refresh) => dialog => () => {
        const input = qee(dialog, '.entity-input');
        const name = input.value.trim();

        DBMS.createGroup(name, (err) => {
            if (err) {
                setError(dialog, err);
            } else {
                if (updateSettingsFlag) {
                    UI.updateEntitySetting(settingsPath, name);
                }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    input.value = '';
                    dialog.hideDlg();
                    refresh();
                });
            }
        });
    };

    function renameGroup(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const { fromName } = dialog;
            const toName = toInput.value.trim();

            DBMS.renameGroup(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, toName);
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    exports.removeGroup = (callback, refresh, btn) => () => {
        const name = callback();

        Utils.confirm(strFormat(getL10n('groups-are-you-sure-about-group-removing'), [name]), () => {
            DBMS.removeGroup(name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    if(btn.nextName !== undefined){
                        UI.updateEntitySetting(settingsPath, btn.nextName);
                    } else if(btn.prevName !== undefined) {
                        UI.updateEntitySetting(settingsPath, btn.prevName);
                    }
                    refresh();
                });
            });
        });
    };
})(this.GroupProfile = {});

/*Copyright 2016-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const rootTab = '.group-schema-tab';

    exports.init = () => {
        exports.content = queryEl(rootTab);
    };

    exports.refresh = () => {
        DBMS.getGroupSchemas((err, schemas) => {
//            redrawSchema(schemas.theory);
            redrawSchema2(schemas.theory, 'theory');
            redrawSchema2(schemas.practice, 'practice');
        });
    };

    function redrawSchema(graph) {
        const container = queryEl(`${rootTab} .schema-container`);

        if (state.network) {
            state.network.destroy();
        }
        graph.edges = graph.edges.map(edge => R.merge(edge, {
            physics: false,
        }));

        state.network = new vis.Network(container, graph, Constants.groupSchemaOpts);
    }
    
    function redrawSchema2(graphData, className) {
        clearEl(queryEl(`${rootTab} svg.${className}`));
        const svg = d3.select(`${rootTab} svg.${className}`);
        const svgGroup = svg.append('g');
        const root = svgGroup.append('g');

        // define an arrow head
        svg.append('svg:defs')
            .append('svg:marker')
            .attr('id', 'end')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 10)
            .attr('refY', 0)
            .attr('markerWidth', 3) // marker settings
            .attr('markerHeight', 5)
            .attr('orient', 'auto')
            .style('fill', '#999')
            .style('stroke-opacity', 0.6) // arrowhead color
            .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5');
        
        const nodeDict = graphData.nodes.reduce((dict, node, i) => {
            dict[node.id] = i;
            return dict;
        }, {});

        const nodeWidth = 170;
        const nodeHeight = 20;

        const name2Node = obj => ({
            id: nodeDict[obj.id],
            name: obj.id,
            title: obj.title,
            label: obj.label,
            width: nodeWidth,
            height: nodeHeight
        });

        const pair2Edge = (obj, i) => ({
            id: i + graphData.nodes.length,
            source: nodeDict[obj.to],
            target: nodeDict[obj.from]
        });

        const graph = {
            nodes: graphData.nodes.map(name2Node),
            links: graphData.edges.map(pair2Edge)
        };

        const layouter = klay.d3adapter();
        const width = 960;
        const height = 400;

        layouter
            .nodes(graph.nodes)
            .links(graph.links)
            .size([width, height])
            .transformGroup(root)
            .options({
                edgeRouting: 'ORTHOGONAL',
                "direction": "RIGHT",
                intCoordinates: false
            })
            .defaultPortSize([2, 2])
            .start();

        const link = root.selectAll('.link')
            .data(graph.links)
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', 'M0 0')
            .attr('marker-end', 'url(#end)');

        // we group nodes along with their ports
        const node = root.selectAll('.node')
            .data(graph.nodes)
            .enter()
            .append('g');

        node.append('rect')
            .attr('class', (d) => {
                return 'node valid';
//                const details = checkRes.details[d.name];
//                if (details === undefined || details.length === 0) {
//                    return 'node valid';
//                }
//                return 'node invalid';
            })
            .attr('width', nodeWidth)
            .attr('height', nodeHeight)
            .attr('title', 'link')
            .attr('rx', 5)
            .attr('ry', 5)
            .attr('x', 0)
            .attr('y', 0);
        
        node.append('title').text(d => d.title)

        node.append('text')
            .attr('x', nodeWidth / 2)
            .attr('y', nodeHeight / 2)
            .attr('alignment-baseline', 'middle')
            .attr('text-anchor', 'middle')
//            .text(d => d.name)
            .text(d => d.label)
            .attr('font-size', '4px');

        // ports
        const port = node.selectAll('.port')
            .data(d => d.ports)
            .enter()
            .append('rect')
            .attr('class', 'port')
            .attr('width', 2)
            .attr('height', 2)
            .attr('x', 0)
            .attr('y', 0);

        // apply layout
        layouter.on('finish', (d2) => {
        // apply edge routes
            link.transition().attr('d', (d) => {
                let path = '';
                path += `M${d.sourcePoint.x} ${d.sourcePoint.y} `;
                d.bendPoints.forEach((bp, i) => {
                    path += `L${bp.x} ${bp.y} `;
                });
                path += `L${d.targetPoint.x} ${d.targetPoint.y} `;
                return path;
            });

            // apply node positions
            node.transition()
                .attr('transform', d => `translate(${d.x} ${d.y})`);

            // apply port positions
            port.transition()
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        layouter.start();
    };
})(this.GroupSchema = {});

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    const root = '.investigation-board-tab ';

    exports.init = () => {
        listen(queryEl(`${root}.group-add-button`), 'click', addGroup);
        listen(queryEl(`${root}.group-switch-button`), 'click', switchGroup);
        listen(queryEl(`${root}.group-save-notes-button`), 'click', setGroupNotes);

        listen(queryEl(`${root}.create-entity-button`), 'click', createResource);
        listen(queryEl(`${root}.rename-entity-button`), 'click', renameResource);

        listen(queryEl(`${root}.save-edge-button`), 'click', updateEdge);

        listen(queryEl(`${root}.cancel-node-adding-button`), 'click', cancel('.board-add-node-popup'));
        listen(queryEl(`${root}.cancel-resource-editing-button`), 'click', cancel('.board-edit-resource-popup'));
        listen(queryEl(`${root}.cancel-group-editing-button`), 'click', cancel('.board-edit-group-popup'));
        listen(queryEl(`${root}.cancel-add-edge-button`), 'click', cancel('.board-add-edge-popup'));

        state.nodesDataset = new vis.DataSet();
        state.edgesDataset = new vis.DataSet();

        const data = {
            nodes: state.nodesDataset,
            edges: state.edgesDataset
        };

        const container = queryEl(`${root}.schema-container`);
        state.network = new vis.Network(container, data, Constants.investigationBoardOpts);
        state.network.on('selectEdge', showEdgeLabelEditor);
        state.network.on('deselectEdge', hideEdgeLabelEditor);

        exports.content = queryEl(root);
    };

    exports.refresh = (softRefresh) => {
        PermissionInformer.getEntityNamesArray('group', false, Utils.processError((groupNames) => {
            DBMS.getInvestigationBoardData((err, ibData) => {
                const allGroupNames = groupNames.map(R.prop('value'));
                const ibGroupNames = R.keys(ibData.groups);
                const freeGroupNames = R.difference(allGroupNames, ibGroupNames);

                clearEl(queryEl(`${root}.group-add-select`));
                $(`${root}.group-add-select`).select2(arr2Select2(freeGroupNames));

                clearEl(queryEl(`${root}.group-switch-select`));
                $(`${root}.group-switch-select`).select2(arr2Select2(freeGroupNames));

                if (!softRefresh) {
                    redrawBoard(ibData);
                }
            });
        }));
    };

    function addNode(node, callback) {
        showPopup('.board-add-node-popup', true);
        state.modifyArgs = {
            newNode: node,
            callback
        };
    }

    function addGroup() {
        const name = queryEl(`${root}.group-add-select`).value.trim();
        DBMS.addBoardGroup(name, (err) => {
            if (err) { Utils.handleError(err); return; }
            setNode(name, 'groups');
        });
    }

    function createResource() {
        const input = queryEl(`${root}.create-entity-input`);
        const name = input.value.trim();
        DBMS.createResource(name, (err) => {
            if (err) { Utils.handleError(err); return; }
            input.value = '';
            setNode(name, 'resources');
        });
    }

    function setNode(nodeName, group) {
        const node = state.modifyArgs.newNode;
        if (group === 'groups') {
            node.originalLabel = nodeName;
            node.originalNotes = '';
            node.label = makeDisplayLabel(node.originalLabel, node.originalNotes);
        } else {
            node.label = nodeName;
        }
        node.id = _makeRelNodeId(nodeName, group);
        node.group = group;
        showPopup('.board-add-node-popup', false);
        exports.refresh(true);
        state.modifyArgs.callback(node);
    }

    function editNodeFun(node, callback) {
        state.modifyArgs = {
            editNode: node,
            callback
        };

        if (node.group === 'groups') {
            editGroup();
        } else {
            showPopup('.board-edit-resource-popup', true);
        }
    }

    function editGroup() {
        showPopup('.board-edit-group-popup', true);
        queryEl(`${root}.group-notes-editor`).value = state.modifyArgs.editNode.originalNotes;
    }

    function switchGroup() {
        const node = state.modifyArgs.editNode;
        const fromName = node.originalLabel;
        const toName = queryEl(`${root}.group-switch-select`).value.trim();
        const { callback } = state.modifyArgs;

        DBMS.switchGroups(fromName, toName, (err) => {
            if (err) { Utils.handleError(err); return; }
            node.originalLabel = toName;
            node.label = makeDisplayLabel(node.originalLabel, node.originalNotes);
            showPopup('.board-edit-group-popup', false);
            callback(node);
            exports.refresh(true);
        });
    }

    function setGroupNotes() {
        const node = state.modifyArgs.editNode;
        const notes = queryEl(`${root}.group-notes-editor`).value.trim();
        const { callback } = state.modifyArgs;

        DBMS.setGroupNotes(node.originalLabel, notes, (err) => {
            if (err) { Utils.handleError(err); return; }
            node.originalNotes = notes;
            node.label = makeDisplayLabel(node.originalLabel, node.originalNotes);
            showPopup('.board-edit-group-popup', false);
            callback(node);
            exports.refresh(true);
        });
    }

    function renameResource() {
        const node = state.modifyArgs.editNode;
        const fromName = node.label;
        const toName = queryEl(`${root}.rename-entity-input`).value.trim();
        const { callback } = state.modifyArgs;

        DBMS.renameResource(fromName, toName, (err) => {
            if (err) { Utils.handleError(err); return; }

            node.label = toName;
            showPopup('.board-edit-resource-popup', false);
            callback(node);
        });
    }

    function deleteNode(data, callback) {
        const node = state.nodesDataset.get(data.nodes[0]);
        const funcName = node.group === 'groups' ? 'removeBoardGroup' : 'removeResource';
        const msg = node.group === 'groups' ? getL10n('investigation-board-confirm-group-node-removing') :
            getL10n('investigation-board-confirm-resource-node-removing');

        const label = node.group === 'groups' ? node.originalLabel : node.label;
        Utils.confirm(strFormat(msg, [label]), () => {
            DBMS[funcName](label, (err) => {
                if (err) { Utils.handleError(err); callback(); return; }
                exports.refresh(true);
                callback(data);
            });
        }, callback);
    }

    function prepareStr(str) {
        return str.split('\n').map(R.splitEvery(20)).map(R.join('\n')).join('\n');
    }

    function makeDisplayLabel(label, notes) {
        return prepareStr(label) + (notes.trim() === '' ? '' : (`\n\n${prepareStr(notes)}`));
    }

    function _makeRelNodeId(name, type) {
        return (type === 'groups' ? 'group-' : 'resource-') + name;
    }

    function redrawBoard(ibData) {
        let nodes = [];
        function makeResourceNode(name) {
            return {
                label: name,
                id: _makeRelNodeId(name, 'resources')
            };
        }
        function makeGroupNode(node) {
            return {
                originalLabel: node.name,
                originalNotes: node.notes,
                label: makeDisplayLabel(node.name, node.notes),
                id: _makeRelNodeId(node.name, 'groups')
            };
        }

        nodes = nodes.concat(R.values(ibData.groups).map(makeGroupNode).map(R.merge({ group: 'groups' })));
        nodes = nodes.concat(R.keys(ibData.resources).map(makeResourceNode).map(R.merge({ group: 'resources' })));

        state.nodesDataset.clear();
        state.nodesDataset.add(nodes);

        const edges = R.flatten(R.keys(ibData.relations).map(rel1 => R.keys(ibData.relations[rel1]).map(rel2 => ({
            from: rel1,
            to: rel2,
            label: ibData.relations[rel1][rel2],
            //                id: rel1 + '-' + rel2
        }))));

        state.edgesDataset.clear();
        state.edgesDataset.add(edges);

        let opts = CommonUtils.clone(Constants.investigationBoardOpts);
        opts = R.merge(opts, {
            locale: L10n.getLang(),
            locales: Constants.visLocales,
            manipulation: {
                addNode,
                deleteNode,
                editNode: editNodeFun,
                addEdge: createEdge,
                editEdge: false,
                deleteEdge,
            },
            //        configure: true
        });

        state.network.setOptions(opts);
    }

    function showEdgeLabelEditor(params) {
        if (params.edges.length !== 0 && params.nodes.length === 0) {
            const edge = state.edgesDataset.get(params.edges[0]);
            state.modifyArgs = {
                edge,
                callback(edge2) {
                    if (edge2) {
                        state.edgesDataset.update(edge2);
                    }
                },
                editEdge: true
            };
            queryEl(`${root}.add-edge-label-input`).value = edge.label;
            showPopup('.board-add-edge-popup', true);
        }
    }
    function hideEdgeLabelEditor(params) {
        showPopup('.board-add-edge-popup', false);
    }

    function createEdge(data, callback) {
        const fromNode = state.nodesDataset.get(data.from);
        const toNode = state.nodesDataset.get(data.to);

        DBMS.addEdge(fromNode.id, toNode.id, (err) => {
            if (err) { callback(); Utils.handleError(err); return; }

            const edge = {
                from: fromNode.id,
                to: toNode.id,
                label: '',
            };
            callback(edge);

            const items = state.edgesDataset.get({
                filter(item) {
                    return item.from === fromNode.id && item.to === toNode.id;
                }
            });

            showEdgeLabelEditor({ edges: [items[0].id], nodes: [] });
        });
    }

    function updateEdge() {
        const input = queryEl(`${root}.add-edge-label-input`);
        const label = input.value.trim();
        const { edge } = state.modifyArgs;
        DBMS.setEdgeLabel(edge.from, edge.to, label, (err) => {
            if (err) { Utils.handleError(err); return; }

            edge.label = label;
            showPopup('.board-add-edge-popup', false);
            input.value = '';
            state.modifyArgs.callback(edge);
        });
    }

    function deleteEdge(data, callback) {
        const edge = state.edgesDataset.get(data.edges[0]);
        DBMS.removeEdge(edge.from, edge.to, (err) => {
            if (err) { Utils.handleError(err); callback(); return; }
            callback(data);
        });
    }

    function cancel(selector) {
        return () => {
            showPopup(selector, false);
            state.modifyArgs.callback();
        };
    }

    function showPopup(selector, show) {
        hideEl(queryEl(root + selector), !show);
    }
})(this.InvestigationBoard = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.profile-filter-tab ';

    exports.init = () => {
        const createGroupDialog = UI.createModalDialog(root, GroupProfile.createGroup(false, exports.refresh), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-group-name',
            actionButtonTitle: 'common-create',
        });

        const renameGroupDialog = UI.createModalDialog(root, renameGroup(`${root}.save-entity-select`), {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'groups-enter-new-group-name',
            actionButtonTitle: 'common-rename',
        });
        
//        state.addFilterConditionDialog = new AddFilterConditionDialog(root);
//        listen(qe(`${root}.create.filter-condition`), 'click', onAddFilterCondition);

        listen(queryEl(`${root}#profile-filter-columns .profile-item-selector`), 'change', UI.showSelectedEls3(root, 'dependent', 'dependent-index'));
        
//        Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
//        listen queryEl(`${root}.save-entity-select`)
        
        $(`${root}.save-entity-select`).select2().on('change', (event) => {
            const group = event.target.value;
            const userGroups = state.userGroupNames.map(R.prop('value'));
            const isGroupEditable = R.contains(group, userGroups);
            Utils.enable(exports.content, 'isGroupEditable', isGroupEditable);
        });

        listen(queryEl(`${root}.show-entity-button`), 'click', loadFilterFromGroup);
        listen(queryEl(`${root}.save-entity-button`), 'click', saveFilterToGroup);
        listen(queryEl(`${root}.download-filter-table`), 'click', downloadFilterTable);

        listen(qe(`${root}.create.group`), 'click', () => createGroupDialog.showDlg());
        listen(qe(`${root}.rename.group`), 'click', () => {
            qee(renameGroupDialog, '.entity-input').value = queryEl(`${root}.save-entity-select`).value;
            renameGroupDialog.showDlg();
        });
        listen(queryEl(`${root}.remove.group`), 'click', GroupProfile.removeGroup(() => 
            queryEl(`${root}.save-entity-select`).value, exports.refresh));

        exports.content = queryEl(root);
    };
    
    exports.refresh = () => {
        state.sortKey = Constants.CHAR_NAME;
        state.sortDir = 'asc';
        state.inputItems = {};
        state.checkboxes = {};
        state.curFilterModel = [];

        const filterSettingsDiv = clearEl(queryEl(`${root}.filter-settings-panel`));
        addEl(filterSettingsDiv, addClass(makeEl('div'), 'separator'));

        groupAreaRefresh();

        FilterConfiguration.makeFilterConfiguration((err, filterConfiguration) => {
            if (err) { Utils.handleError(err); return; }

            state.filterConfiguration = filterConfiguration;
            
            showEl(qe(`${root} .alert.no-characters`), !filterConfiguration.haveProfiles());
            showEl(qe(`${root} .alert.no-players`), !filterConfiguration.haveProfiles());
            showEl(qe(`${root} .alert.no-character-profile`), !filterConfiguration.haveProfileStructures());
            showEl(qe(`${root} .alert.no-player-profile`), !filterConfiguration.haveProfileStructures());
            showEl(qe(`${root} .profile-filter-container .panel`), filterConfiguration.haveData());
            
            const groupedProfileFilterItems = filterConfiguration.getGroupedProfileFilterItems();
            addEls(filterSettingsDiv, R.flatten(groupedProfileFilterItems.map(item => R.concat(item.profileFilterItems.map(makeInput), [addClass(makeEl('div'), 'filterSeparator')]))));

            UI.fillShowItemSelector2(
                clearEl(queryEl(`${root}#profile-filter-columns .profile-item-selector`)),
                filterConfiguration.getGroupsForSelect(),
                true
            );

            addEl(
                clearEl(queryEl(`${root}.filter-head`)),
                makeContentHeader(getHeaderProfileItemNames(filterConfiguration.getProfileFilterItems()))
            );

            rebuildContent();
        });
    };
    
    function onAddFilterCondition() {
        state.addFilterConditionDialog.showDlg(state.filterConfiguration.getGroupsForSelect(), setFilterModelItem);
    }
    
    function setFilterModelItem (filterModelItem) {
        const index = R.findIndex(R.propEq('name', filterModelItem.name), state.curFilterModel);
        if(index === -1){
            state.curFilterModel.push(filterModelItem);
        } else {
            state.curFilterModel[index] = filterModelItem;
        }
    }
    
    function groupAreaRefresh() {
        PermissionInformer.getEntityNamesArray('group', true, Utils.processError((userGroupNames) => {
            PermissionInformer.getEntityNamesArray('group', false, Utils.processError((allGroupNames) => {
                
                Utils.enableEl(qe(`${root}.rename.group`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.remove.group`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.show-entity-button`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.save-entity-button`), allGroupNames.length > 0);
                Utils.enableEl(qe(`${root}.save-entity-select`), allGroupNames.length > 0);
                
                state.userGroupNames = userGroupNames;
                state.allGroupNames = allGroupNames;
                const data = getSelect2Data(allGroupNames);
                clearEl(queryEl(`${root}.save-entity-select`));
                $(`${root}.save-entity-select`).select2(data);
            }));
        }));
    }

    function getHeaderProfileItemNames(profileSettings) {
        return R.map(R.pick(['name', 'displayName', 'type']), profileSettings);
    }

    function makePrintData() {
        const dataArrays = state.filterConfiguration.getDataArrays(makeFilterModel());

        const sortFunc = CommonUtils.charOrdAFactoryBase(state.sortDir, (a, b) => a > b, (a) => {
            const map = CommonUtils.arr2map(a, 'itemName');
            const item = map[state.sortKey];
            let { value } = item;
            if (value === undefined) return value;
            switch (item.type) {
            case 'text':
            case 'string':
            case 'enum':
            case 'multiEnum':
                value = value.toLowerCase();
                break;
            case 'checkbox':
            case 'number':
                break;
            default:
                throw new Error(`Unexpected type ${item.type}`);
            }
            return value;
        });
        return dataArrays.sort(sortFunc);
    }

    function rebuildContent() {
        const dataArrays = makePrintData();
        addEl(clearEl(queryEl(`${root}.filter-result-size`)), makeText(dataArrays.length));
        addEls(clearEl(queryEl(`${root}.filter-content`)), dataArrays.map(makeDataString));
        UI.showSelectedEls3(root, 'dependent', 'dependent-index')({ target: queryEl(`${root}#profile-filter-columns .profile-item-selector`) });
    }

    function saveFilterToGroup() {
        const groupName = queryEl(`${root}.save-entity-select`).value;
        PermissionInformer.isEntityEditable('group', groupName, (err, isGroupEditable) => {
            if (err) { Utils.handleError(err); return; }
            if (!isGroupEditable) {
                Utils.alert(strFormat(getL10n('groups-group-editing-forbidden'), [groupName]));
                return;
            }
            DBMS.saveFilterToGroup(groupName, makeFilterModel(), Utils.processError());
        });
    }

    function loadFilterFromGroup() {
        const groupName = queryEl(`${root}.save-entity-select`).value;
        DBMS.getGroup(groupName, (err, group) => {
            if (err) { Utils.handleError(err); return; }
            const conflictTypes =
                ProjectUtils.isFilterModelCompatibleWithProfiles(
                    state.filterConfiguration.getBaseProfileSettings(),
                    group.filterModel
                );
            if (conflictTypes.length !== 0) {
                Utils.alert(strFormat(getL10n('groups-base-filter-is-incompatible-with-page-profiles'), [conflictTypes.join(',')]));
                return;
            }
            applyFilterModel(group.filterModel);
            rebuildContent();
        });
    }

    function downloadFilterTable() {
        const el = queryEl(`${root}#profile-filter-columns .profile-item-selector`);
        const selected = [];
        for (let i = 0; i < el.options.length; i += 1) {
            selected[i] = el.options[i].selected;
        }

        const dataArrays = makePrintData();
        const cleanArrays = dataArrays.map(dataArray => dataArray.filter((item, index) => selected[index]).map(R.prop('value')));

        FileUtils.arr2d2Csv(cleanArrays, 'profileFilter');
    }

    function applyFilterModel(filterModel) {
        filterModel = CommonUtils.arr2map(filterModel, 'name');

        Object.keys(state.inputItems).forEach((inputItemName) => {
            if (inputItemName.endsWith(':numberInput') || inputItemName.endsWith(':multiEnumInput')) {
                return;
            }

            const inputItem = state.inputItems[inputItemName];
            let selectedOptions, regex, num, i, counter;

            if (state.checkboxes[inputItemName].checked !== (filterModel[inputItemName] !== undefined)) {
                state.checkboxes[inputItemName].click();
            }
            if (!filterModel[inputItemName]) {
                let select;
                switch (inputItem.selfInfo.type) {
                case 'enum':
                case 'checkbox':
                    for (i = 0; i < inputItem.options.length; i += 1) {
                        inputItem.options[i].selected = true;
                    }
                    break;
                case 'number':
                    state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value = 0;
                    inputItem.value = 'ignore';
                    break;
                case 'multiEnum':
                    select = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                    for (i = 0; i < select.options.length; i += 1) {
                        select.options[i].selected = true;
                    }
                    inputItem.value = 'ignore';
                    break;
                case 'text':
                case 'string':
                    inputItem.value = '';
                    break;
                default:
                    throw new Error(`Unexpected type ${inputItem.selfInfo.type}`);
                }
            } else {
                const modelItem = filterModel[inputItemName];
                let select;
                switch (inputItem.selfInfo.type) {
                case 'enum':
                    for (i = 0; i < inputItem.options.length; i += 1) {
                        inputItem.options[i].selected = !!modelItem.selectedOptions[inputItem.options[i].value];
                    }
                    break;
                case 'checkbox':
                    inputItem.options[0].selected = modelItem.selectedOptions.true;
                    inputItem.options[1].selected = modelItem.selectedOptions.false;
                    break;
                case 'number':
                    inputItem.value = modelItem.condition;
                    state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value = modelItem.num;
                    break;
                case 'multiEnum':
                    inputItem.value = modelItem.condition;
                    select = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                    for (i = 0; i < select.options.length; i += 1) {
                        select.options[i].selected = !!modelItem.selectedOptions[select.options[i].value];
                    }
                    break;
                case 'text':
                case 'string':
                    inputItem.value = modelItem.regexString;
                    break;
                default:
                    throw new Error(`Unexpected type ${inputItem.selfInfo.type}`);
                }
            }
        });
    }

    function makeFilterModel() {
        const model = [];
        Object.keys(state.inputItems).forEach((inputItemName) => {
            if (inputItemName.endsWith(':numberInput') || inputItemName.endsWith(':multiEnumInput')) {
                return;
            }
            if (state.checkboxes[inputItemName].checked === false) {
                return;
            }
            const inputItem = state.inputItems[inputItemName];
            let selectedOptions, regex, num, i, arr;
            const { type } = inputItem.selfInfo;

            let select2;
            switch (type) {
            case 'enum':
                arr = nl2array(inputItem.selectedOptions).map(R.prop('value'));
                model.push({ type, name: inputItemName, selectedOptions: R.zipObj(arr, R.repeat(true, arr.length)) });
                break;
            case 'checkbox':
                selectedOptions = {};
                if (inputItem.options[0].selected) { selectedOptions.true = true; }
                if (inputItem.options[1].selected) { selectedOptions.false = true; }
                model.push({ type, name: inputItemName, selectedOptions });
                break;
            case 'number':
                if (inputItem.value === 'ignore') { return; }
                num = Number(state.inputItems[`${inputItem.selfInfo.name}:numberInput`].value);
                model.push({
                    type, name: inputItemName, num, condition: inputItem.value
                });
                break;
            case 'multiEnum':
                if (inputItem.value === 'ignore') { return; }
                selectedOptions = {};
                select2 = state.inputItems[`${inputItem.selfInfo.name}:multiEnumInput`];
                arr = nl2array(select2.selectedOptions).map(R.prop('value'));
                model.push({
                    type,
                    name: inputItemName,
                    condition: inputItem.value,
                    selectedOptions: R.zipObj(arr, R.repeat(true, arr.length))
                });
                break;
            case 'text':
            case 'string':
                model.push({ type, name: inputItemName, regexString: inputItem.value.toLowerCase() });
                break;
            default:
                throw new Error(`Unexpected type ${type}`);
            }
        });
        return model;
    }

    function makeDataString(dataArray) {
        const { inputItems } = state;
        return addEls(makeEl('tr'), dataArray.map((valueInfo, i) => {
            let regex, pos, displayValue;
            const { value } = valueInfo;
            if (value === undefined) {
                displayValue = constL10n('notAvailable');
            } else if (valueInfo.type === 'checkbox') {
                displayValue = constL10n(Constants[value]);
            } else if (valueInfo.type === 'text') {
                pos = value.toLowerCase().indexOf(inputItems[valueInfo.itemName].value.toLowerCase());
                displayValue = value.substring(pos - 5, pos + 15);
            } else if (R.contains(valueInfo.type, ['number', 'enum', 'multiEnum', 'string'])) {
                displayValue = value;
            } else {
                throw new Error(`Unexpected valueInfo.type: ${valueInfo.type}`);
            }
            const td = addEl(setClassByCondition(makeEl('td'), 'lightGrey', value === undefined), makeText(displayValue));
            addClasses(td, [`dependent-${i}`, 'dependent', valueInfo.type === 'number' ? 'text-align-right' : 'text-align-left']);
            setAttr(td, 'dependent-index', i);
            return td;
        }));
    }

    function makeContentHeader(profileItemNames) {
        return addEls(makeEl('tr'), profileItemNames.map((elem, i) => {
            const td = addEls(makeEl('th'), [makeText(`${elem.displayName} `)]);
            td.info = elem.name;
            addClasses(td, [`dependent-${i}`, 'dependent', 'sorting', elem.type === 'number' ? 'text-align-right' : 'text-align-left']);
            setAttr(td, 'dependent-index', i);
            listen(td, 'click', onSortChange);
            return td;
        }));
    }

    function onSortChange(event) {
        let { target } = event;
        if (target.tagName.toLowerCase() === 'span') {
            target = target.parentElement;
        }

        if (state.sortKey === target.info) {
            state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
            setClassByCondition(target, 'sortDesc', state.sortDir === 'desc');
            setClassByCondition(target, 'sortAsc', state.sortDir === 'asc');
        } else {
            const filterHead = queryEl(`${root}.filter-head`);
            nl2array(filterHead.getElementsByClassName('sortAsc')).forEach(removeClass(R.__, 'sortAsc'));
            nl2array(filterHead.getElementsByClassName('sortDesc')).forEach(removeClass(R.__, 'sortDesc'));

            state.sortKey = target.info;
            state.sortDir = 'asc';
            addClass(target, 'sortAsc');
        }
        rebuildContent();
    }

    function makeInput(profileItemConfig) {
        const el = qmte(`${root} .filter-item-tmpl`);
        const checkbox = qee(el, 'input[type="checkbox"]');
        const id = "filter-item-" + profileItemConfig.displayName;
        checkbox.checked = false;
        checkbox.id = id;
        addEl(qee(el, '.filter-item-name'), makeText(profileItemConfig.displayName));
        setAttr(qee(el, 'label'), 'for', id);
        
        const inputContainer = qee(el, '.filter-item-container');
        listen(checkbox, 'click', toggleContent(el, inputContainer));
        state.checkboxes[profileItemConfig.name] = checkbox;
        
        addEl(inputContainer, makeFilter(profileItemConfig));
        return el;
    }
    
    function toggleContent(itemContainer, inputContainer) {
        return (event) => {
            hideEl(inputContainer, !event.target.checked);
            setClassByCondition(itemContainer, 'flex-front-element', event.target.checked);
            rebuildContent();
        };
    }

    function makeFilter(profileItemConfig) {
        switch (profileItemConfig.type) {
        case 'text':
        case 'string':
            return makeTextFilter(profileItemConfig);
        case 'enum':
            return makeEnumFilter(profileItemConfig);
        case 'multiEnum':
            return makeMultiEnumFilter(profileItemConfig);
        case 'number':
            return makeNumberFilter(profileItemConfig);
        case 'checkbox':
            return makeCheckboxFilter(profileItemConfig);
        default:
            throw new Error(`Unexpected type ${profileItemConfig.type}`);
        }
    }

    function makeTextFilter(profileItemConfig) {
        const input = qmte(`${root} .text-filter-tmpl`);
        input.selfInfo = profileItemConfig;
        input.value = '';
        input.addEventListener('input', rebuildContent);
        state.inputItems[profileItemConfig.name] = input;
        return input;
    }

    function makeCommonEnumFilter(profileItemConfig, values) {
        const selector = qmte(`${root} .common-enum-filter-tmpl`);
        selector.selfInfo = profileItemConfig;
        selector.size = values.length;

        fillSelector(selector, values.map((value) => {
            value.selected = true;
            return value;
        }));
        selector.addEventListener('change', rebuildContent);
        state.inputItems[profileItemConfig.name] = selector;
        return selector;
    }

    function makeEnumFilter(profileItemConfig) {
        const values = arr2Select(profileItemConfig.value.split(','));
        return makeCommonEnumFilter(profileItemConfig, values);
    }

    function makeCheckboxFilter(profileItemConfig) {
        const values = [{
            value: Constants.true,
            name: constL10n(Constants.true)
        }, {
            value: Constants.false,
            name: constL10n(Constants.false)
        }];
        return makeCommonEnumFilter(profileItemConfig, values);
    }

    function makeMultiEnumFilter(profileItemConfig) {
        const filter = qmte(`${root} .multi-enum-filter-tmpl`);
        const selector = qee(filter, '.multi-enum-filter-type');
        selector.selfInfo = profileItemConfig;

        Constants.multiEnumFilter.forEach((value) => {
            const option = makeEl('option');
            option.appendChild(makeText(constL10n(value)));
            option.value = value;
            selector.appendChild(option);
        });
        selector.selectedIndex = 0;
        state.inputItems[profileItemConfig.name] = selector;
        selector.addEventListener('change', rebuildContent);

        const selector2 = qee(filter, '.multi-enum-filter-content');
        const values = arr2Select(profileItemConfig.value.split(','));
        fillSelector(selector2, values.map((value) => {
            value.selected = true;
            return value;
        }));
        selector2.size = values.length;

        state.inputItems[`${profileItemConfig.name}:multiEnumInput`] = selector2;
        selector2.addEventListener('change', rebuildContent);
        return filter;
    }

    function makeNumberFilter(profileItemConfig) {
        const filter = qmte(`${root} .number-filter-tmpl`);
        const selector = qee(filter, 'select');
        selector.selfInfo = profileItemConfig;

        Constants.numberFilter.forEach((value) => {
            const option = makeEl('option');
            option.appendChild(makeText(constL10n(value)));
            option.value = value;
            selector.appendChild(option);
        });
        selector.selectedIndex = 0;
        state.inputItems[profileItemConfig.name] = selector;
        selector.addEventListener('change', rebuildContent);

        const input = qee(filter, 'input');
        input.value = 0;
        state.inputItems[`${profileItemConfig.name}:numberInput`] = input;
        input.addEventListener('input', rebuildContent);
        return filter;
    }

    function renameGroup(selector) {
        return dialog => () => {
            const toInput = qee(dialog, '.entity-input');
            const fromName = queryEl(selector).value;
            const toName = toInput.value.trim();

            DBMS.renameGroup(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        toInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }
})(this.ProfileFilter = {});

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    exports.init = () => {
        exports.content = getEl('aboutDiv');
    };

    exports.refresh = () => {
    };
})(this.About = {});

/*Copyright 2016 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.log-viewer-tab ';

    exports.init = () => {
        const pagination = clearEl(queryEl(`${root}.pagination`));
        addEls(pagination, R.range(0, 20).map((num) => {
            const a = setAttr(makeEl('a'), 'href', '#');
            const li = addEl(makeEl('li'), a);
            li.num = num;
            addEl(a, makeText(num + 1));
            listen(a, 'click', () => {
                getData({ target: { value: num } });
                const prevActive = queryEl(`${root}.pagination li.active`);
                if (prevActive !== null) {
                    removeClass(prevActive, 'active');
                }
                addClass(li, 'active');
            });
            return li;
        }));

        listen(queryEl(`${root}button.clear-filter`), 'click', () => {
            queryEls(`${root}input[filter]`).forEach(el => (el.value = ''));
            exports.refresh();
        });

        queryEls(`${root}input[filter]`).forEach(listen(R.__, 'input', exports.refresh));

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        queryEls(`${root}.pagination li a`)[0].click();
    };

    function dataRecieved(err, data) {
        if (err) { Utils.handleError(err); return; }
        addEl(clearEl(queryEl(`${root}.result-number`)), makeText(L10n.format('log-viewer', 'total', [data.max])));

        const container = clearEl(queryEl(`${root}.log-data`));
        queryEls(`${root}.pagination li`).forEach(li => hideEl(li, li.num > data.logSize - 1));
        R.ap([addEl(container)], data.requestedLog.map(makeRow));
    }

    function getData(event) {
        const filter = R.fromPairs(queryEls(`${root}input[filter]`).map(el => [getAttr(el, 'filter'), el.value]));
        DBMS.getLog(Number(event.target.value), filter, dataRecieved);
    }

    function makeRow(rowData) {
        const addText = (text) => {
            return addEl(makeEl('td'), addEl(makeEl('span'), makeText(text)));
        };
        return addEls(makeEl('tr'), [
            addText(`${rowData[0]}`),
            addText(new Date(rowData[2]).format('yyyy/mm/dd HH:MM:ss')),
            addText(rowData[1]),
            addText(rowData[3]),
            
            addEls(makeEl('td'), JSON.parse(rowData[4]).map(item => {
                return addEl(addClass(makeEl('div'), 'log-param'), makeText(R.is(Object, item) ? JSON.stringify(item) : item));
            })),
            addEls(makeEl('td'), JSON.parse(rowData[5]).map(item => {
                return addEl(addClass(makeEl('div'), 'log-param'), makeText(R.is(Object, item) ? JSON.stringify(item) : item));
            })),
        ]);
    }
})(this.LogViewer = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, StoryCharacters
 */

'use strict';

((exports) => {
    const state = {};

    exports.init = () => {
        listen(getEl('networkSubsetsSelector'), 'change', onNetworkSubsetsChange);
    };

    exports.refresh = (parent) => {
        state.parent = parent;

        let selector = fillSelector(clearEl(getEl('networkSubsetsSelector')), constArr2Select(Constants.objectSubsets));
        [selector.value] = Constants.objectSubsets;
        onNetworkSubsetsChange({ target: selector });

        selector = fillSelector(
            clearEl(getEl('networkCharacterSelector')),
            state.parent.characterNames.sort(Utils.charOrdAObject).map(remapProps4Select)
        );
        setAttr(selector, 'size', selector.options.length > 15 ? 15 : selector.options.length);
        selector = fillSelector(
            clearEl(getEl('networkStorySelector')),
            state.parent.storyNames.sort(Utils.charOrdAObject).map(remapProps4Select)
        );
        setAttr(selector, 'size', selector.options.length > 15 ? 15 : selector.options.length);
    };

    exports.getStoryNames = () => {
        const { value } = getEl('networkSubsetsSelector');

        if (Constants.objectSubsets[0] === value) { // all objects
            return state.parent.storyNames.map(R.prop('value'));
        } else if (Constants.objectSubsets[1] === value) { // "selected characters"
            const primaryCharacters = nl2array(getEl('networkCharacterSelector').selectedOptions).map(R.prop('value'));
            const isPrimaryCharacter = R.contains(R.__, primaryCharacters);
            return R.values(state.parent.Stories)
                .filter(story => R.keys(story.characters).some(isPrimaryCharacter)).map(R.prop('name'));
        } else if (Constants.objectSubsets[2] === value) { //"selected stories"
            return nl2array(getEl('networkStorySelector').selectedOptions).map(R.prop('value'));
        }
        throw new Error(`Unexpected subsets selector: ${value}`);
    };

    exports.getCharacterNames = () => {
        const { value } = getEl('networkSubsetsSelector');

        if (Constants.objectSubsets[0] === value) { // all objects
            return state.parent.characterNames.map(R.prop('value'));
        } else if (Constants.objectSubsets[1] === value) { // "selected characters"
            // returns character and his neighbours
            const primaryCharacters = nl2array(getEl('networkCharacterSelector').selectedOptions).map(R.prop('value'));
            const isPrimaryCharacter = R.contains(R.__, primaryCharacters);
            const secondaryCharacters = R.values(state.parent.Stories)
                .filter(story => R.keys(story.characters).some(isPrimaryCharacter))
                .map(story => story.events.filter(event => R.keys(event.characters).some(isPrimaryCharacter))
                    .map(event => R.keys(event.characters).filter(name => !isPrimaryCharacter(name))));
            return primaryCharacters.concat(R.uniq(R.flatten(secondaryCharacters)));
        } else if (Constants.objectSubsets[2] === value) { //"selected stories"
            const stories = nl2array(getEl('networkStorySelector').selectedOptions).map(R.prop('value'));
            return R.uniq(R.flatten(stories.map(storyName => R.keys(state.parent.Stories[storyName].characters))));
        }
        throw new Error(`Unexpected subsets selector: ${value}`);
    };

    function onNetworkSubsetsChange(event) {
        const selectedSubset = event.target.value;
        hideEl(getEl('networkCharacterDiv'),  selectedSubset !== Constants.objectSubsets[1]);
        hideEl(getEl('networkStoryDiv'), selectedSubset !== Constants.objectSubsets[2]);
    }
})(this.NetworkSubsetsSelector = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, StoryCharacters
 */

'use strict';

((exports) => {
    const state = {};

    const STORY_PREFIX = 'St:';
    const CHAR_PREFIX = 'Ch:';
    const PROFILE_GROUP = 'prof-';
    const FILTER_GROUP = 'filter-';

    exports.init = () => {
        NetworkSubsetsSelector.init();

        listen(getEl('networkNodeGroupSelector'), 'change', colorNodes);
        listen(getEl('showPlayerNamesCheckbox'), 'change', updateNodeLabels);
        listen(getEl('drawNetworkButton'), 'click', onDrawNetwork);
        $('#nodeFocusSelector').select2().on('change', onNodeFocus);
        listen(getEl('networkSelector'), 'change', onNetworkSelectorChangeDelegate);

        queryEls('#activityBlock button').forEach(listen(R.__, 'click', event => toggleClass(event.target, 'btn-primary')));
        queryEls('#relationsBlock button').forEach(listen(R.__, 'click', event => toggleClass(event.target, 'btn-primary')));

        //        state.network;
        state.highlightActive = false;

        initWarning();
        L10n.onL10nChange(initWarning);

        //    TimelinedNetwork.init();

        exports.content = getEl('socialNetworkDiv');
    };

    function initWarning() {
        const warning = clearEl(getEl('socialNetworkWarning'));
        const button = addEl(makeEl('button'), makeText(getL10n('social-network-remove-resources-warning')));
        addEls(warning, [makeText(getL10n('social-network-require-resources-warning')), button]);
        listen(button, 'click', () => addClass(warning, 'hidden'));
    }

    const nodeSort = CommonUtils.charOrdAFactory(a => a.label.toLowerCase());

    exports.refresh = () => {
        let selector = fillSelector(clearEl(getEl('networkSelector')), constArr2Select(Constants.networks));
        [selector.value] = Constants.networks;
        onNetworkSelectorChangeDelegate({ target: selector });

        selector = clearEl(getEl('networkNodeGroupSelector'));

        PermissionInformer.getEntityNamesArray('character', false, (err1, characterNames) => { // subset selector
            if (err1) { Utils.handleError(err1); return; }
            PermissionInformer.getEntityNamesArray('story', false, (err2, storyNames) => { // subset selector
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getAllProfiles('character', (err3, profiles) => { // node coloring
                    if (err3) { Utils.handleError(err3); return; }
                    DBMS.getAllStories((err4, stories) => { // contains most part of SN data
                        if (err4) { Utils.handleError(err4); return; }
                        DBMS.getProfileStructure('character', (err5, profileStructure) => { // node coloring
                            if (err5) { Utils.handleError(err5); return; }
                            DBMS.getProfileBindings((err6, profileBindings) => { // node coloring
                                if (err6) { Utils.handleError(err6); return; }
                                DBMS.getGroupCharacterSets((err7, groupCharacterSets) => { // node coloring
                                    if (err7) { Utils.handleError(err7); return; }
                                    DBMS.getMetaInfo((err8, metaInfo) => { // timelined network
                                        if (err8) { Utils.handleError(err8); return; }
                                        DBMS.getRelations((err9, relations) => { // relations
                                            if (err9) { Utils.handleError(err9); return; }

                                            state.Stories = stories;
                                            state.Characters = profiles;
                                            state.profileBindings = profileBindings;
                                            state.groupCharacterSets = groupCharacterSets;
                                            state.metaInfo = metaInfo;
                                            state.relations = relations;

                                            const checkboxes = profileStructure.filter(element =>
                                                R.equals(element.type, 'checkbox'));
                                            R.values(profiles).forEach((profile) => {
                                                checkboxes.map(item => (profile[item.name] =
                                                    constL10n(Constants[profile[item.name]])));
                                            });

                                            const colorGroups = profileStructure.filter(element =>
                                                R.contains(element.type, ['enum', 'checkbox']));
                                            const defaultColorGroup = {
                                                value: Constants.noGroup,
                                                name: constL10n(Constants.noGroup)
                                            };

                                            const profileLabel = strFormat(getL10n('social-network-profile-group'));
                                            const filterLabel = strFormat(getL10n('social-network-filter-group'));

                                            const profileGroups = colorGroups.map(group => group.name).map(name =>
                                                ({ value: PROFILE_GROUP + name, name: profileLabel([name]) }));
                                            const filterGroups = R.keys(groupCharacterSets).map(name =>
                                                ({ value: FILTER_GROUP + name, name: filterLabel([name]) }));
                                            fillSelector(
                                                selector,
                                                [defaultColorGroup].concat(profileGroups).concat(filterGroups)
                                            );

                                            initGroupColors(colorGroups);

                                            NetworkSubsetsSelector.refresh({
                                                characterNames,
                                                storyNames,
                                                Stories: stories
                                            });
                                            //                            onDrawNetwork();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    };

    function initGroupColors(colorGroups) {
        state.groupColors = R.clone(Constants.snFixedColors);
        state.groupLists = {};

        colorGroups.forEach((group) => {
            if (group.type === 'enum') {
                state.groupLists[PROFILE_GROUP + group.name] = group.value.split(',').map((subGroupName, i) => {
                    state.groupColors[`${PROFILE_GROUP + group.name}.${subGroupName.trim()}`] =
                        Constants.colorPalette[i+2];
                    return `${PROFILE_GROUP + group.name}.${subGroupName.trim()}`;
                });
            } else if (group.type === 'checkbox') {
                const trueName = constL10n(Constants.true);
                const falseName = constL10n(Constants.false);
                state.groupColors[`${PROFILE_GROUP + group.name}.${trueName}`] =
                    Constants.colorPalette[group.value ? 0+2 : 1+2];
                state.groupColors[`${PROFILE_GROUP + group.name}.${falseName}`] =
                    Constants.colorPalette[group.value ? 1+2 : 0+2];
                state.groupLists[PROFILE_GROUP + group.name] =
                    [`${PROFILE_GROUP + group.name}.${trueName}`, `${PROFILE_GROUP + group.name}.${falseName}`];
            } else {
                throw new Error(`Unexpected profile item type: ${group.type}`);
            }
        });
    }

    function makeLegendItem(label, color) {
        const colorDiv = addEl(makeEl('div'), makeText(label));
        colorDiv.style.backgroundColor = color.background;
        colorDiv.style.border = `solid 2px ${color.border}`;
        return colorDiv;
    }

    function refreshLegend(groupName) {
        const colorLegend = clearEl(getEl('colorLegend'));
        let els = [];

        if (groupName === 'noGroup') {
            els.push(makeLegendItem(constL10n('noGroup'), Constants.snFixedColors.noGroup.color));
        } else if (CommonUtils.startsWith(groupName, PROFILE_GROUP)) {
            els = els.concat(state.groupLists[groupName].map(value =>
                makeLegendItem(value.substring(PROFILE_GROUP.length), state.groupColors[value].color)));
        } else if (CommonUtils.startsWith(groupName, FILTER_GROUP)) {
            els.push(makeLegendItem(constL10n('noGroup'), Constants.snFixedColors.noGroup.color));
            els.push(makeLegendItem(constL10n('fromGroup'), Constants.snFixedColors.fromGroup.color));
        } else {
            throw new Error(`Unexpected group name/type: ${groupName}`);
        }

        if (['characterPresenceInStory', 'characterActivityInStory'].indexOf(state.selectedNetwork) !== -1) {
            els.push(makeLegendItem(getL10n('social-network-story'), Constants.snFixedColors.storyColor.color));
        }
        addEls(colorLegend, els);
    }

    function colorNodes(event) {
        const groupName = event.target.value;
        refreshLegend(groupName);
        if (state.nodesDataset === undefined) return;

        NetworkSubsetsSelector.getCharacterNames().forEach((characterName) => {
            state.nodesDataset.update({
                id: CHAR_PREFIX + characterName,
                group: getNodeGroup(characterName, groupName)
            });
        });
    }

    function getNodeGroup(characterName, groupName) {
        if (groupName === 'noGroup') {
            return groupName;
        } else if (CommonUtils.startsWith(groupName, PROFILE_GROUP)) {
            const character = state.Characters[characterName];
            return `${groupName}.${character[groupName.substring(PROFILE_GROUP.length)]}`;
        } else if (CommonUtils.startsWith(groupName, FILTER_GROUP)) {
            return state.groupCharacterSets[groupName.substring(FILTER_GROUP.length)][characterName] ? 'fromGroup' : 'noGroup';
        }
        throw new Error(`Unexpected group name: ${groupName}`);
    }

    function updateNodeLabels() {
        if (state.nodesDataset === undefined) return;
        const showPlayer = getEl('showPlayerNamesCheckbox').checked;
        const allNodes = state.nodesDataset.get({
            returnType: 'Object'
        });

        R.values(allNodes).filter(node => node.type === 'character').forEach((node) => {
            const label = makeCharacterNodeLabel(showPlayer, node.originName);
            if (node.label !== undefined) {
                node.label = label;
            } else if (node.hiddenLabel !== undefined) {
                node.hiddenLabel = label;
            } else {
                console.log(`Suspicious node: ${JSON.stringify(node)}`);
            }
        });

        state.nodesDataset.update(R.values(allNodes));
    }

    function onNetworkSelectorChangeDelegate(event) {
        hideEl(getEl('activityBlock'), event.target.value !== 'characterActivityInStory');
        queryEls('#activityBlock button').forEach(el => addClass(el, 'btn-primary'));
        hideEl(getEl('relationsBlock'), event.target.value !== 'characterRelations');
        queryEls('#relationsBlock button').forEach(el => addClass(el, 'btn-primary'));
    }

    function onNodeFocus(event) {
        state.network.focus(event.target.value, Constants.snFocusOptions);
    }

    function onDrawNetwork() {
        onNetworkSelectorChange(getEl('networkSelector').value);
    //    TimelinedNetwork.refresh(state.network, state.nodesDataset,
    //            state.edgesDataset, getEventDetails(), state.metaInfo);
    }

    function onNetworkSelectorChange(selectedNetwork) {
        state.selectedNetwork = selectedNetwork;
        let nodes = [];
        let edges = [];

        switch (selectedNetwork) {
        case 'socialRelations':
            nodes = getCharacterNodes();
            edges = getDetailedEdges();
            break;
        case 'characterPresenceInStory':
            nodes = getCharacterNodes().concat(getStoryNodes());
            edges = getStoryEdges();
            break;
        case 'characterActivityInStory':
            nodes = getCharacterNodes().concat(getStoryNodes());
            edges = getActivityEdges();
            break;
        case 'characterRelations':
            nodes = getCharacterNodes();
            edges = getRelationEdges();
            break;
        default:
            throw new Error(`Unexpected network type: ${selectedNetwork}`);
        }

        refreshLegend(getEl('networkNodeGroupSelector').value);

        clearEl(getEl('nodeFocusSelector'));
        nodes.sort(nodeSort);

        const data = getSelect2DataCommon(remapProps(['id', 'text'], ['id', 'originName']), nodes);
        $('#nodeFocusSelector').select2(data);

        state.nodesDataset = new vis.DataSet(nodes);
        state.edgesDataset = new vis.DataSet(edges);

        redrawAll();
    }

    function makeCharacterNodeLabel(showPlayer, characterName) {
        const label = characterName.split(' ').join('\n');
        if (showPlayer) {
            const player = state.profileBindings[characterName] || '';
            return `${label}/\n${player}`;
        }
        return label;
    }

    function getCharacterNodes() {
        const groupName = getEl('networkNodeGroupSelector').value;
        const showPlayer = getEl('showPlayerNamesCheckbox').checked;
        return NetworkSubsetsSelector.getCharacterNames().map((characterName) => {
            const profile = state.Characters[characterName];
            return {
                id: CHAR_PREFIX + characterName,
                label: makeCharacterNodeLabel(showPlayer, characterName),
                type: 'character',
                originName: characterName,
                group: groupName === 'noGroup' ? constL10n('noGroup') : `${groupName}.${profile[groupName]}`
            };
        });
    }

    function getStoryNodes() {
        const nodes = NetworkSubsetsSelector.getStoryNames().map(name => ({
            id: STORY_PREFIX + name,
            label: name.split(' ').join('\n'),
            value: Object.keys(state.Stories[name].characters).length,
            title: Object.keys(state.Stories[name].characters).length,
            group: 'storyColor',
            type: 'story',
            originName: name,
        }));
        return nodes;
    }

    function getActivityEdges() {
        const selectedActivities = queryEls('#activityBlock button.btn-primary').map(getAttr(R.__, 'data-value'));
        const stories = state.Stories;
        return R.flatten(R.keys(stories).map(name => R.keys(stories[name].characters)
            .map(char1 => R.keys(stories[name].characters[char1].activity).filter(R.contains(R.__, selectedActivities))
                .map(activity => ({
                    from: STORY_PREFIX + name,
                    to: CHAR_PREFIX + char1,
                    color: Constants.snActivityColors[activity],
                    width: 2,
                    hoverWidth: 4
                })))));
    }

    function getRelationEdges() {
        const selectedRelations = queryEls('#relationsBlock button.btn-primary').map(getAttr(R.__, 'data-value'));
        const { relations } = state;
        const checked = R.contains(R.__, selectedRelations);
        return R.flatten(relations.map((rel) => {
            const arr = [];
            const { starter } = rel;
            const { ender } = rel;
            const edgeTmpl = {
                from: CHAR_PREFIX + starter,
                to: CHAR_PREFIX + ender,
                color: Constants.snRelationColors.neutral,
                width: 2,
                hoverWidth: 4
            };
            if (rel.essence.length === 0) {
                if (checked('neutral')) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.neutral,
                    }));
                }
            } else {
                if (checked('allies') && R.contains('allies', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.allies,
                    }));
                }
                if (checked('directional') && R.contains('starterToEnder', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.starterToEnder,
                        arrows: 'to'
                    }));
                }
                if (checked('directional') && R.contains('enderToStarter', rel.essence)) {
                    arr.push(R.merge(edgeTmpl, {
                        color: Constants.snRelationColors.enderToStarter,
                        arrows: 'from'
                    }));
                }
            }
            return arr;
        }));
    }

    function getStoryEdges() {
        return R.flatten(R.keys(state.Stories).map(name => R.keys(state.Stories[name].characters).map(char1 => ({
            from: STORY_PREFIX + name,
            to: CHAR_PREFIX + char1,
            color: 'grey'
        }))));
    }

    function getEventDetails() {
        return R.flatten(R.values(state.Stories).map(story => story.events.map(event => ({
            eventName: event.name,
            storyName: story.name,
            time: event.time,
            characters: R.keys(event.characters)
        }))));
    }

    function getDetailedEdges() {
        const edgesCheck = {};
        R.values(state.Stories).forEach((story) => {
            story.events.forEach((event) => {
                const charNames = R.keys(event.characters).sort();
                charNames.forEach((char1, i) => {
                    charNames.forEach((char2, j) => {
                        if (i <= j) {
                            return;
                        }
                        const key = char1 + char2;
                        if (!edgesCheck[key]) {
                            edgesCheck[key] = {
                                from: CHAR_PREFIX + char1,
                                to: CHAR_PREFIX + char2,
                                title: {},
                            };
                        }
                        edgesCheck[key].title[story.name] = true;
                    });
                });
            });
        });

        return R.values(edgesCheck).map((edgeInfo) => {
            const title = R.keys(edgeInfo.title).sort().join(', ');
            const value = R.keys(edgeInfo.title).length;
            return {
                from: edgeInfo.from,
                to: edgeInfo.to,
                title: `${value}: ${title}`,
                value,
                color: 'grey'
            };
        });
    }

    function redrawAll() {
        const container = getEl('socialNetworkContainer');

        const data = {
            nodes: state.nodesDataset,
            edges: state.edgesDataset
        }; // Note: data is coming from ./datasources/WorldCup2014.js

        if (state.network) {
            state.network.destroy();
        }

        const opts = CommonUtils.clone(Constants.socialNetworkOpts);
        opts.groups = state.groupColors;

        state.network = new vis.Network(container, data, opts);

        state.network.on('click', neighbourhoodHighlight);
    }

    function hideLabel(node) {
        if (node.hiddenLabel === undefined) {
            node.hiddenLabel = node.label;
            node.label = undefined;
        }
    }
    function showLabel(node) {
        if (node.hiddenLabel !== undefined) {
            node.label = node.hiddenLabel;
            node.hiddenLabel = undefined;
        }
    }

    function highlightNodes(network, allNodes, zeroDegreeNodes, firstDegreeNodes) {
        // get the second degree nodes
        const secondDegreeNodes = R.uniq(R.flatten(firstDegreeNodes.map(id => network.getConnectedNodes(id))));
        // mark all nodes as hard to read.
        R.values(allNodes).forEach((node) => {
            node.color = 'rgba(200,200,200,0.5)';
            hideLabel(node);
        });
        // all second degree nodes get a different color and their label back
        secondDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = 'rgba(150,150,150,0.75)';
            showLabel(node);
        });
        // all first degree nodes get their own color and their label back
        firstDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = undefined;
            showLabel(node);
        });
        // the main node gets its own color and its label back.
        zeroDegreeNodes.map(id => allNodes[id]).forEach((node) => {
            node.color = undefined;
            showLabel(node);
        });
    }

    function neighbourhoodHighlight(params) {
        // get a JSON object
        const allNodes = state.nodesDataset.get({
            returnType: 'Object'
        });

        const { network } = state;
        if (params.nodes.length > 0) {
            state.highlightActive = true;
            const selectedNode = params.nodes[0];
            const zeroDegreeNodes = [selectedNode];
            const firstDegreeNodes = network.getConnectedNodes(selectedNode);
            highlightNodes(network, allNodes, zeroDegreeNodes, firstDegreeNodes);
        } else if (params.edges.length > 0) {
            state.highlightActive = true;
            const selectedEdge = params.edges[0];
            const firstDegreeNodes = network.getConnectedNodes(selectedEdge);
            highlightNodes(network, allNodes, [], firstDegreeNodes);
        } else if (state.highlightActive === true) {
            // reset all nodes
            R.values(allNodes).forEach((node) => {
                node.color = undefined;
                showLabel(node);
            });
            state.highlightActive = false;
        }

        // transform the object into an array
        state.nodesDataset.update(R.values(allNodes));
    }
})(this.SocialNetwork = {});

//"use strict";
//
//(function(exports){
//
////    var cameraInitPos = new THREE.Vector3(-30, 40, 30).multiplyScalar(2.5);
////    var cameraInitPos = new THREE.Vector3(0, 40, 40).multiplyScalar(2.5);
////    var cameraInitPos = new THREE.Vector3(0, 0, 40).multiplyScalar(2.5);
//    var cameraInitPos = new THREE.Vector3(0, 0, 60).multiplyScalar(2.5);
//    var basicZScale = 25;
//    var spotLightInitPos = new THREE.Vector3(0, 0, 50);
//
//    // three.js
//    var camera;
//    var scene;
//    var renderer;
//    var controls;
//    var stats;
//
//    function initStats() {
//        var stats = new Stats();
//        stats.setMode(0); // 0: fps, 1: ms
//        addEl(clearEl(getEl("Stats-output")), stats.domElement);
//        return stats;
//    };
//
//    function init(){
//        // create a render and set the size
//        renderer = new THREE.WebGLRenderer();
//        renderer.setClearColor(new THREE.Color(0xEEEEEE, 1.0));
//        addEl(clearEl(getEl("WebGL-output")), renderer.domElement);
//
//        stats = initStats();
//
//        controls = new function () {
//            this.rotationSpeed = 0.08;
////            this.bouncingSpeed = 0.03;
//            this.zScale = basicZScale;
//            this.planeScale = 10;
//            this.cameraZ = 120;
////            this.cameraRotX = 0;
////            this.cameraRotY = 0;
////            this.cameraRotZ = 0;
//
//            this.outputObjects = function () {
//                console.log(scene.children);
//            }
//        };
//
//
//        var gui = new dat.GUI({ autoPlace: false });
//        gui.add(controls, 'rotationSpeed', 0, 0.5);
////        gui.add(controls, 'bouncingSpeed', 0, 0.5);
//        gui.add(controls, 'zScale', 1, 100);
//        gui.add(controls, 'planeScale', 1, 100);
//        gui.add(controls, 'cameraZ', -500, 500);
////        gui.add(controls, 'cameraRotX', -1, 1);
////        gui.add(controls, 'cameraRotY', -1, 1);
////        gui.add(controls, 'cameraRotZ', -1, 1);
//
//        gui.add(controls, 'outputObjects');
//
//        addEl(getEl('gui-settings-output'), gui.domElement);
//    //    renderer.shadowMapEnabled = true;
//    };
//
//    var isFirstRefresh = true;
//
//    // once everything is loaded, we run our Three.js stuff.
//    function refresh(network, nodes, edges, eventDetails, metaInfo) {
//
//        var lowerTimeBoundary = new Date(metaInfo.preGameDate).getTime();
//        var upperTimeBoundary = new Date(metaInfo.date).getTime();
//        var timeDiff = upperTimeBoundary - lowerTimeBoundary;
//        console.log(lowerTimeBoundary);
//        console.log(upperTimeBoundary);
//        console.log(timeDiff);
//
//        var characterEvents = {};
//        var storyEvents = {};
//        eventDetails.forEach(function(eventInfo){
//            if(eventInfo.time === ''){
//                eventInfo.time = metaInfo.date;
//            }
//            eventInfo.scaledTime = (new Date(eventInfo.time).getTime() - lowerTimeBoundary) / timeDiff;
//            console.log(eventInfo.scaledTime);
//            storyEvents[eventInfo.storyName] = storyEvents[eventInfo.storyName] || {events: []};
//            storyEvents[eventInfo.storyName].events.push(eventInfo);
//            eventInfo.characters.forEach(function(character){
//                characterEvents[character] = characterEvents[character] || {events: []};
//                characterEvents[character].events.push(eventInfo);
//            });
//        });
//        console.log(storyEvents);
//        console.log(characterEvents);
//        function fillMinMax(objInfo){
//            objInfo.minTime = R.reduce(R.min, Infinity, objInfo.events.map(R.prop('scaledTime')));
//            objInfo.maxTime = R.reduce(R.max, -Infinity, objInfo.events.map(R.prop('scaledTime')));
//        }
//        R.values(storyEvents).forEach(fillMinMax);
//        R.values(characterEvents).forEach(fillMinMax);
//        console.log(storyEvents);
//        console.log(characterEvents);
//
//        var sizes = updateRendererSize();
////        if(isFirstRefresh){
//        // create a scene, that will hold all our elements such as objects, cameras and lights.
//        scene = new THREE.Scene();
//
//        // create a camera, which defines where we're looking at.
//        camera = new THREE.PerspectiveCamera(45, sizes.width / sizes.height, 0.1, 1000);
//
////        var orbitControls = new THREE.OrbitControls(camera);
//////        orbitControls.autoRotate = true;
////        var clock = new THREE.Clock();
//
//        // show axes in the screen
//        var axes = new THREE.AxisHelper(20);
//        scene.add(axes);
//
//        // create the ground plane
//        var planeGeometry = new THREE.PlaneGeometry(60, 20, 1, 1);
//        var planeMaterial = new THREE.MeshBasicMaterial({color: 0xffffff, opacity: 0});
//        var plane = new THREE.Mesh(planeGeometry, planeMaterial);
//        //    plane.receiveShadow = true;
//
//        // rotate and position the plane
//        plane.rotation.x = -0.5 * Math.PI;
//        plane.position.x = 15;
//        plane.position.y = 0;
//        plane.position.z = 0;
//
//        // add the plane to the scene
//        scene.add(plane);
//
//        // position and point the camera to the center of the scene
//        camera.position.copy(cameraInitPos);
//        camera.lookAt(new THREE.Vector3(0, 0, 0));
//        camera.position.add(new THREE.Vector3(0, -100, 0));
//        camera.lookAt(new THREE.Vector3(0, 0, 0));
////        camera.rotation.z =  Math.PI;
////        camera.lookAt(scene.position);
//
////        camera.rotateOnAxis(cameraInitPos.normalize() , 0.6);
////        camera.rotation.z = 0.75 * Math.PI;
//
////        camera.position.x = -30;
////        camera.position.y = 40;
////        camera.position.z = 30;
//
//        // add subtle ambient lighting
//        var ambientLight = new THREE.AmbientLight(0x0c0c0c);
//        scene.add(ambientLight);
//
//        // add spotlight for the shadows
//        var spotLight = new THREE.SpotLight(0xffffff);
//        spotLight.position.copy(spotLightInitPos);
//        //    spotLight.castShadow = true;
//        scene.add(spotLight);
////            isFirstRefresh = false;
////        }
//
//        // call the render function
//        var step = 0;
//
//        var isInitialized = false;
////        if(isFirstRefresh){
//            render();
////            isFirstRefresh = false;
////        }
////        network.storePositions();
//
//        function getEventInfo(id){
//            if(id.startsWith('St:')){
//                return storyEvents[id.substring(3)];
//            } else {
//                return characterEvents[id];
//            }
//        };
//
//        function render() {
//            stats.update();
//            network.storePositions();
//            if(!isInitialized){
//                console.log(nodes.get());
//                console.log(edges.get());
//                nodes.get().forEach(function(node){
//                    var eventInfo = getEventInfo(node.id);
//
//                    if(eventInfo){
//                        var height = eventInfo.maxTime - eventInfo.minTime;
//                        var z = (eventInfo.maxTime + eventInfo.minTime)/2;
//                        addCylinder(node.x/10,-node.y/10, z*basicZScale, height, 0.5, String('cyl-' + node.id));
////                        addCylinder(0,0,0, 2, 0.5, String('cyl-' + node.id));
////                        addCylinder(node.x/10,-node.y/10, -5, height, 3, String(node.id + '0'));
//                    }
////                    addCylinder(node.x/10,-node.y/10, 4, String(node.id + '1-top'));
//                });
//
//                isInitialized = true;
//            } else {
//                nodes.get().forEach(function(node){
//                    var cyl = scene.getObjectByName(String('cyl-' + node.id));
//                    if(cyl){
//                        cyl.position.x = node.x/10;
//                        cyl.position.y = -node.y/10;
//                    }
////                    cyl = scene.getObjectByName(String(node.id + '1-top'));
////                    cyl.position.x = node.x/10;
////                    cyl.position.y = -node.y/10;
//                });
//            }
//
//            scene.traverse(function (e) {
//                if (e instanceof THREE.Mesh && e.name.startsWith('cyl-')) {
////                    e.position.y = controls.zScale;
//                    var eventInfo = getEventInfo(e.name.substring(4));
////                    if(eventInfo){
//                        e.position.z = (eventInfo.maxTime + eventInfo.minTime)/2 * controls.zScale;
////                        e.setHeight((eventInfo.maxTime - eventInfo.minTime) * controls.zScale);
////                    } else {
////                        console.log(e.name);
////                    }
//                    e.scale.y = controls.zScale;
//                }
//            });
//
//            var nowTime = Date.now();
//            var multip = 0.005;
//            camera.position.x = 50*Math.sin(nowTime*controls.rotationSpeed*multip);
//            camera.position.y = 50*Math.cos(nowTime*controls.rotationSpeed*multip);
//            camera.position.z = controls.cameraZ;
//            camera.lookAt(new THREE.Vector3(0, 0, 0));
////            scene.traverse(function (e) {
////                if (e instanceof THREE.Mesh && e.name.endsWith('1-top')) {
//////                    e.position.y = controls.zScale;
////                    e.position.z = controls.zScale;
////                }
////            });
//
////            var delta = clock.getDelta();
////            orbitControls.update(delta);
//
////            camera.rotateOnAxis(cameraInitPos.normalize() , controls.cameraRotX);
////            camera.rotateOnAxis(camera.getWorldDirection().normalize() , controls.cameraRotX);
////            camera.rotation.copy(new THREE.Vector3(controls.cameraRotX,
////                controls.cameraRotY, controls.cameraRotZ).multiplyScalar(Math.PI));
////            camera.rotation.x = controls.cameraRotX * Math.PI;
//
//            // render using requestAnimationFrame
//            requestAnimationFrame(render);
//            renderer.render(scene, camera);
//        }
//
//    }
//
//    function updateRendererSize(){
//        var styles = getComputedStyle(getEl('socialNetworkContainer'));
//        var width = styles.width.split('px').join('') * 0.75;
//        var height = styles.height.split('px').join('') * 0.75;
//        renderer.setSize(width, height);
//        return {
//            width: width,
//            height: height,
//        }
//    }
//    function onResize() {
//        if(camera && renderer){
//            var sizes = updateRendererSize();
//            camera.aspect = sizes.width / sizes.height;
//            camera.updateProjectionMatrix();
//        }
//    }
//
//    function addCylinder(x, y, z, height, radius, id) {
//
//        var geometry = new THREE.CylinderGeometry( radius, radius, height, 32 );
//        var material = new THREE.MeshLambertMaterial( {color: 0x7777ff} );
//        var cylinder = new THREE.Mesh( geometry, material );
//        cylinder.name = id;
//
//        cylinder.position.x = x;
//        cylinder.position.y = y;
//        cylinder.position.z = z;
//        cylinder.rotation.x = -0.5 * Math.PI;
////        cylinder.position.y = z;
////        cylinder.position.z = y;
//
//    //    cylinder.position.x = 40;
//
//        scene.add( cylinder );
//
//    };
//
//    exports.init = init;
//    exports.refresh = refresh;
////    window.onload = init;
//
//    // listen to the resize events
//    window.addEventListener('resize', onResize, false);
//
//
//})(this['TimelinedNetwork']={});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 jQuery, DBMS
 */

'use strict';


((exports) => {
    const defaultHists = ['storyEventsHist', 'storyCharactersHist', 'eventCompletenessHist',
        'characterSymbolsHist', 'characterStoriesHist'];
    const entityCharts = ['characterChart', 'playerChart', 'storyChart', 'groupChart'];

    const statisticKeys = [
        'characterNumber',
        'playerNumber',
        'storyNumber',
        'groupNumber',
        'eventsNumber',
        'userNumber',
        'textCharacterNumber',
        'lastEvent',
        'firstEvent',
    ];

    const root = '.overview-tab ';
    const state = {};

    state.Charts = {};

    exports.init = () => {
        state.name = getEl('gameNameInput');
        state.name.addEventListener('change', updateName);

        state.lastSaveTime = getEl('lastSaveTime');

        state.date = getEl('gameDatePicker');

        let opts = {
            lang: L10n.getLang(),
            mask: true,
            onChangeDateTime: updateTime
        };

        jQuery(state.date).datetimepicker(opts);

        state.preDate = getEl('preGameDatePicker');

        opts = {
            lang: L10n.getLang(),
            mask: true,
            onChangeDateTime: updatePreGameDate
        };

        jQuery(state.preDate).datetimepicker(opts);

        L10n.onL10nChange(() => {
            jQuery(state.date).datetimepicker({
                lang: L10n.getLang()
            });
            jQuery(state.preDate).datetimepicker({
                lang: L10n.getLang()
            });
        });

        state.descr = queryEl(`${root}.game-description-area`);
        state.descr.addEventListener('change', updateDescr);
        
        const gearsContainer = qee(queryEl(root), '#gears');
        addEl(gearsContainer, qe('.gears-tab'));
        Gears.init();
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === "class") {
                    if(hasClass(gearsContainer, 'active')) {
                        Gears.refresh();
                    }
                }
            });
        });
        observer.observe(gearsContainer, {
            attributes: true
        });
        
        const slidersContainer = qee(queryEl(root), '#sliders');
        addEl(slidersContainer, qe('.sliders-tab'));
        Sliders.init();

        exports.content = queryEl(root);
    };
    
    exports.refresh = () => {
        Gears.refresh();
        Sliders.refresh();
        PermissionInformer.isAdmin((err, isAdmin) => {
            if (err) { Utils.handleError(err); return; }
            Utils.enable(exports.content, 'adminOnly', isAdmin);
        });
        
        Promise.all( [DBMS.getMetaInfoPm(), DBMS.getStatisticsPm()] ).then(updateOverviewTab).catch(Utils.handleError);
    };

    function makeChart(id, canvas, data) {
        if (state.Charts[id]) {
            state.Charts[id].destroy();
        }

        const labels = [];
        const dataset = {
            data: [],
            backgroundColor: [],
            hoverBackgroundColor: []
        };
        data.forEach((item, i) => {
            if (Constants.colorPalette[i]) {
                labels.push(item.label);
                dataset.data.push(item.value);
                dataset.backgroundColor.push(Constants.colorPalette[i].color.background);
                dataset.hoverBackgroundColor.push(Constants.colorPalette[i].color.hover.background);
            }
        });

        const ctx = canvas.getContext('2d');
        state.Charts[id] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [dataset]
            },
            options: {
                animation: {
                    animateRotate: false
                },
                responsive: false,
                legend: {
                    display: false,
                },
                tooltips: {
                    enabled: false,
                    custom: customTooltips
                }
            },
        });
    }

    function makeHistogram(place, data) {
        let max = null;
        data.forEach((barData) => {
            if (barData) {
                if (max === null || barData.value > max) {
                    max = barData.value;
                }
            }
        });
        data.forEach((barData) => {
            if (barData) {
                // barData.normValue = (barData.value - min)/(max-min);
                //      barData.normValue = (barData.value - 0)/(max-0);
                barData.normValue = (((barData.value - 0) / (max - 0)) * 0.9) + 0.1;
            }
        });

        let div;
        data.forEach((barData) => {
            div = barData === null ? makeEl('div') : addEl(makeEl('div'), makeText(barData.value));
            addClass(div, 'bar');
            if (barData) {
                div.style.height = `${barData.normValue * 100}%`;
                $(div).tooltip({
                    title: barData.tip,
                });
            }

            addEl(place, div);
        });
    }

    function updateOverviewTab(results) {
        const [metaInfo, statistics] = results;
        state.name.value = metaInfo.name;
        state.date.value = metaInfo.date;
        state.preDate.value = metaInfo.preGameDate;
        state.descr.value = metaInfo.description;
        addEl(clearEl(state.lastSaveTime), makeText(new Date(metaInfo.saveTime).format('yyyy/mm/dd HH:MM:ss')));
        
        statistics.lastEvent = statistics.lastEvent !== '' ? new Date(statistics.lastEvent).format('yyyy/mm/dd h:MM') : '';
        statistics.firstEvent = statistics.firstEvent !== '' ? new Date(statistics.firstEvent).format('yyyy/mm/dd h:MM') : '';
        
        statisticKeys.forEach((key) => {
            updateStatisticValue(statistics, key);
        });
        
        addEl(clearEl(getEl('generalCompleteness')), makeText(strFormat(getL10n('overview-general-completeness-value'), statistics.generalCompleteness)));
        addEl(clearEl(getEl('storyCompleteness')), makeText(strFormat(getL10n('overview-story-completeness-value'), statistics.storyCompleteness)));
        addEl(clearEl(getEl('relationCompleteness')), makeText(strFormat(getL10n('overview-relation-completeness-value'), statistics.relationCompleteness)));
        
        defaultHists.forEach((histName) => {
            makeHistogram(clearEl(queryEl(`${root}.${histName}`)), statistics[histName]);
        });
        
        entityCharts.forEach((entityChart) => {
            makeChart(entityChart, queryEl(`${root}.${entityChart}`), statistics[entityChart]);
        });
        
        const symbolChartData = R.toPairs(localizeConsts(statistics.textCharactersCount)).map(pair => ({
            value: pair[1],
            label: makeChartLabel(statistics.textCharacterNumber, pair[0], pair[1])
        }));
        makeChart('symbolChart', queryEl(`${root}.symbolChart`), symbolChartData);
        
        const bindingChartData = R.toPairs(localizeConsts(statistics.bindingStats)).map(pair => ({
            value: pair[1],
            label: [pair[0], ': ', pair[1]].join('')
        }));
        makeChart('bindingChart', queryEl(`${root}.bindingChart`), bindingChartData);
        
        let barData, barDiv, bar;
        
        function makeContainer(obj) {
            barDiv = makeEl('div');
            addClass(barDiv, 'col-xs-3');
            addEl(barDiv, addEl(makeEl('h4'), makeText(obj.name)));
            addEl(barDiv, obj.bar);
            return barDiv;
        }
        function buildChart(info) {
            bar = setAttr(setAttr(makeEl('canvas'), 'width', '300'), 'height', '100');
            const data = R.zipObj(['name', 'bar'], [info.name, bar]);
            const container = makeContainer(data);
            makeChart(info.id, bar, info.prepared);
            return container;
        }
        
        function buildHist(info) {
            bar = addClass(makeEl('div'), 'overviewHist');
            const data = R.zipObj(['name', 'bar'], [info.name, bar]);
            const container = makeContainer(data);
            makeHistogram(bar, info.prepared);
            return container;
        }
        
        const innerMakeChart = R.compose(buildChart, prepareChart);
        const innerMakeHist = R.compose(buildHist, prepareHist);
        
        function localizeCheckboxes(info) {
            info.data = R.fromPairs(R.toPairs(info.data).map((val) => {
                val[0] = constL10n(Constants[val[0]]);
                return val;
            }));
            return info;
        }
        
        const makeCheckboxChart = R.compose(innerMakeChart, localizeCheckboxes);
        
        const fn = R.cond([
            [R.compose(R.equals('enum'), R.prop('type')), innerMakeChart],
            [R.compose(R.equals('checkbox'), R.prop('type')), makeCheckboxChart],
            [R.T, innerMakeHist],
            ]);
        
        showEl(qe(`${root} .alert.character`), statistics.profileCharts.characterCharts.length === 0);
        statistics.profileCharts.characterCharts.map(fn)
            .map(addEl(clearEl(queryEl(`${root}.characterProfileDiagrams`))));
        showEl(qe(`${root} .alert.player`), statistics.profileCharts.playerCharts.length === 0);
        statistics.profileCharts.playerCharts.map(fn)
            .map(addEl(clearEl(queryEl(`${root}.playerProfileDiagrams`))));
    }
    
    function localizeConsts(info) {
        info = R.fromPairs(R.toPairs(info).map((val) => {
            val[0] = constL10n(val[0]);
            return val;
        }));
        return info;
    }

    function prepareChart(info) {
        const total = R.sum(R.values(info.data));
        info.prepared = R.keys(info.data).map(key => R.zipObj(['value', 'label'], [info.data[key], makeChartLabel(total, key, info.data[key])]));
        return info;
    }

    function prepareHist(info) {
        info.prepared = [];
        const { step } = info.data;
        info.data = info.data.groups;
        const min = R.apply(Math.min, R.keys(info.data));
        const max = R.apply(Math.max, R.keys(info.data));

        for (let i = min; i < max + 1; i++) {
            if (info.data[i]) {
                info.prepared.push({
                    value: info.data[i],
                    label: `${i * step}-${(i * step) + (step - 1)}`,
                    tip: `${i * step}-${(i * step) + (step - 1)}`
                });
            } else {
                info.prepared.push(null);
            }
        }
        return info;
    }

    // eslint-disable-next-line no-var,vars-on-top
    var makeChartLabel = R.curry((total, key, value) =>
        [key, ': ', ((value / total) * 100).toFixed(0), '% (', value, '/', total, ')'].join(''));

    function updateStatisticValue(statistics, key) {
        addEl(clearEl(getEl(key)), makeText(statistics[key]));
    }

    function updateName(event) {
        DBMS.setMetaInfoStringPm('name', event.target.value).catch(Utils.handleError);
    }
    function updateTime(dp, input) {
        DBMS.setMetaInfoDate('date', input.val(), Utils.processError());
    }
    function updatePreGameDate(dp, input) {
        DBMS.setMetaInfoDate('preGameDate', input.val(), Utils.processError());
    }
    function updateDescr(event) {
        DBMS.setMetaInfoString('description', event.target.value, Utils.processError());
    }

    function customTooltips(tooltip) {
        // Tooltip Element
        let tooltipEl = document.getElementById('chartjs-tooltip');

        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'chartjs-tooltip';
            tooltipEl.innerHTML = '<table></table>';
            document.body.appendChild(tooltipEl);
        }

        // Hide if no tooltip
        if (tooltip.opacity === 0) {
            tooltipEl.style.opacity = 0;
            return;
        }

        // Set caret Position
        tooltipEl.classList.remove('above', 'below', 'no-transform');
        if (tooltip.yAlign) {
            tooltipEl.classList.add(tooltip.yAlign);
        } else {
            tooltipEl.classList.add('no-transform');
        }

        function getBody(bodyItem) {
            return bodyItem.lines;
        }

        // Set Text
        if (tooltip.body) {
            const titleLines = tooltip.title || [];
            const bodyLines = tooltip.body.map(getBody);

            let innerHtml = '<thead>';

            titleLines.forEach((title) => {
                innerHtml += `<tr><th>${title}</th></tr>`;
            });
            innerHtml += '</thead><tbody>';

            bodyLines.forEach((body, i) => {
                const colors = tooltip.labelColors[i];
                let style = `background:${colors.backgroundColor}`;
                style += `; border-color:${colors.borderColor}`;
                style += '; border-width: 2px';
                const span = `<span class="chartjs-tooltip-key" style="${style}"></span>`;
                innerHtml += `<tr><td>${span}${body}</td></tr>`;
            });
            innerHtml += '</tbody>';

            const tableRoot = tooltipEl.querySelector('table');
            tableRoot.innerHTML = innerHtml;
        }

        const position = this._chart.canvas.getBoundingClientRect();

        //        // Display, position, and set styles for font
        tooltipEl.style.opacity = 1;
        tooltipEl.style.left = `${position.left + tooltip.caretX}px`;
        tooltipEl.style.top = `${position.top + tooltip.caretY}px`;
        //        tooltipEl.style.fontFamily = tooltip._fontFamily;
        //        tooltipEl.style.fontSize = tooltip.fontSize;
        //        tooltipEl.style.fontStyle = tooltip._fontStyle;
        tooltipEl.style.padding = `${tooltip.yPadding}px ${tooltip.xPadding}px`;
    }
})(this.Overview = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.profile-binding-tab ';

    exports.init = () => {
        listen(queryEl(`${root}.create-binding-button`), 'click', createBinding);
        listen(queryEl(`${root}.remove-binding-button`), 'click', removeBinding);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', false, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', false, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }

                    const bondedCharacterList = R.keys(profileBindings);
                    const bondedPlayerList = R.values(profileBindings);
                    const filter = list => R.compose(R.not, R.contains(R.__, list), R.prop('value'));

                    fillSelector(
                        clearEl(queryEl(`${root}.character-selector`)),
                        characterNames.filter(filter(bondedCharacterList)).map(remapProps4Select)
                    );
                    fillSelector(
                        clearEl(queryEl(`${root}.player-selector`)),
                        playerNames.filter(filter(bondedPlayerList)).map(remapProps4Select)
                    );
                    const bindings = R.toPairs(profileBindings).map(binding => ({
                        name: R.join('/', binding),
                        value: JSON.stringify(binding)
                    }));
                    bindings.sort(CommonUtils.charOrdAFactory(R.prop('name')));
                    fillSelector(clearEl(queryEl(`${root}.binding-selector`)), bindings);
                });
            });
        });
    };

    function createBinding() {
        const characterName = queryEl(`${root}.character-selector`).value;
        const playerName = queryEl(`${root}.player-selector`).value;

        if (characterName === '' || playerName === '') {
            Utils.alert(getL10n('binding-character-or-player-not-selected'));
            return;
        }

        DBMS.createBinding(characterName, playerName, Utils.processError(exports.refresh));
    }

    function removeBinding() {
        const bindingVal = queryEl(`${root}.binding-selector`).value;

        if (bindingVal === '') {
            Utils.alert(getL10n('binding-binding-is-not-selected'));
            return;
        }
        const binding = JSON.parse(bindingVal);

        DBMS.removeBinding(binding[0], binding[1], Utils.processError(exports.refresh));
    }
})(this.ProfileBinding = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';


// Character profile already ha field 'name'
// I had some choices:
// 1. remove this field at all
// 2. Add one more object to divide special values (name) and user defined values
// 3. Prohibit to make field - name
// 1. This field is used in many places
// 2. - too complex way
// 3. simple and lesser complexity, I choose this way

((exports) => {
    const tabRoot = '.profile-configurer-tab ';
    const characterPanel = `${tabRoot}.character-profile-panel `;
    const playerPanel = `${tabRoot}.player-profile-panel `;

    exports.init = () => {
        const sel = clearEl(queryEl(`${characterPanel}.create-entity-type-select`));
        const fillMainSel = () => { fillItemTypesSel(clearEl(sel)); };
        fillMainSel();
        L10n.onL10nChange(fillMainSel);
        const sel2 = clearEl(queryEl(`${playerPanel}.create-entity-type-select`));
        const fillMainSel2 = () => { fillItemTypesSel(clearEl(sel2)); };
        fillMainSel2();
        L10n.onL10nChange(fillMainSel2);

        listen(queryEl(`${characterPanel}.create-entity-button`), 'click', createProfileItem('character', characterPanel));
        listen(queryEl(`${characterPanel}.move-entity-button`), 'click', moveProfileItem('character', characterPanel));
        listen(queryEl(`${characterPanel}.remove-entity-button`), 'click', removeProfileItem('character', characterPanel));

        listen(queryEl(`${playerPanel}.create-entity-button`), 'click', createProfileItem('player', playerPanel));
        listen(queryEl(`${playerPanel}.move-entity-button`), 'click', moveProfileItem('player', playerPanel));
        listen(queryEl(`${playerPanel}.remove-entity-button`), 'click', removeProfileItem('player', playerPanel));

        exports.content = queryEl(tabRoot);
    };

    exports.refresh = () => {
        refreshPanel('character', characterPanel);
        refreshPanel('player', playerPanel);
    };

    function refreshPanel(type, root) {
        DBMS.getProfileStructure(type, (err, allProfileSettings) => {
            if (err) { Utils.handleError(err); return; }

            const arr = allProfileSettings.map(R.compose(strFormat(getL10n('common-set-item-before')), R.append(R.__, []), R.prop('name')));
            arr.push(getL10n('common-set-item-as-last'));
            const positionSelectors = [queryEl(`${root}.create-entity-position-select`),
                queryEl(`${root}.move-entity-position-select`)];
            positionSelectors.map(clearEl).map(fillSelector(R.__, arr2Select(arr))).map(setProp(R.__, 'selectedIndex', allProfileSettings.length));

            const table = clearEl(queryEl(`${root}.profile-config-container`));

            try {
                addEls(table, allProfileSettings.map(getInput(type)));
            } catch (err1) {
                Utils.handleError(err1); return;
            }

            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                Utils.enable(exports.content, 'adminOnly', isAdmin);
            });

            const selectorArr = [queryEl(`${root}.move-entity-select`), queryEl(`${root}.remove-entity-select`)];
            selectorArr.map(clearEl).map(fillSelector(R.__, arr2Select(allProfileSettings.map(R.prop('name')))));
        });
    }

    function createProfileItem(type, root) {
        return () => {
            const input = queryEl(`${root}.create-entity-input`);
            const name = input.value.trim();
            const itemType = queryEl(`${root}.create-entity-type-select`).value.trim();
            const positionSelector = queryEl(`${root}.create-entity-position-select`);

            DBMS.createProfileItem(type, name, itemType, positionSelector.selectedIndex, Utils.processError(() => {
                input.value = '';
                exports.refresh();
            }));
        };
    }

    function moveProfileItem(type, root) {
        return () => {
            const { index } = queryEl(`${root}.move-entity-select`).selectedOptions[0];
            const newIndex = queryEl(`${root}.move-entity-position-select`).selectedIndex;
            DBMS.moveProfileItem(type, index, newIndex, Utils.processError(exports.refresh));
        };
    }

    function removeProfileItem(type, root) {
        return () => {
            const selector = queryEl(`${root}.remove-entity-select`);
            const index = selector.selectedIndex;
            const name = selector.value;

            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-removing-profile-item'), [name]), () => {
                DBMS.removeProfileItem(type, index, name, Utils.processError(exports.refresh));
            });
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var fillItemTypesSel = sel => fillSelector(sel, constArr2Select(R.keys(Constants.profileFieldTypes)));
    const fillPlayerAccessSel = sel => fillSelector(sel, constArr2Select(Constants.playerAccessTypes));

    // eslint-disable-next-line no-var,vars-on-top
    var getInput = R.curry((type, profileSettings, index) => { // throws InternalError
        index++;
        const els = [];

        els.push(addEl(makeEl('span'), makeText(index)));

        let input = setProps(makeEl('input'), {
            value: profileSettings.name,
            info: profileSettings.name
        });
        listen(input, 'change', renameProfileItem(type));
        addClass(input, 'itemNameInput');
        els.push(input);

        let sel = makeEl('select');
        fillItemTypesSel(sel);
        setProps(sel, {
            value: profileSettings.type,
            info: profileSettings.name,
            oldType: profileSettings.type
        });
        listen(sel, 'change', changeProfileItemType(type));
        els.push(sel);

        switch (profileSettings.type) {
        case 'text':
        case 'enum':
        case 'multiEnum':
            input = makeEl('textarea');
            input.value = profileSettings.value;
            break;
        case 'string':
            input = makeEl('input');
            input.value = profileSettings.value;
            break;
        case 'number':
            input = makeEl('input');
            input.type = 'number';
            input.value = profileSettings.value;
            break;
        case 'checkbox':
            input = makeEl('input');
            input.type = 'checkbox';
            input.checked = profileSettings.value;
            break;
        default:
            throw new Errors.InternalError('errors-unexpected-switch-argument', [profileSettings.type]);
        }

        setProps(input, {
            info: profileSettings.name,
            infoType: profileSettings.type,
            oldValue: profileSettings.value
        });
        addClass(input, `profile-configurer-${profileSettings.type}`);
        listen(input, 'change', updateDefaultValue(type));
        els.push(input);

        input = setProps(makeEl('input'), {
            checked: profileSettings.doExport,
            info: profileSettings.name,
            type: 'checkbox'
        });
        listen(input, 'change', doExportChange(type));
        els.push(input);

        sel = makeEl('select');
        fillPlayerAccessSel(sel);
        setProps(sel, {
            value: profileSettings.playerAccess,
            info: profileSettings.name,
            oldValue: profileSettings.playerAccess,
        });
        listen(sel, 'change', changeProfileItemPlayerAccess(type));
        els.push(sel);

        input = setProps(makeEl('input'), {
            checked: profileSettings.showInRoleGrid,
            info: profileSettings.name,
            type: 'checkbox'
        });
        listen(input, 'change', showInRoleGridChange(type));
        els.push(input);

        return addEls(makeEl('tr'), els.map(el => addEl(makeEl('td'), addClass(el, 'adminOnly'))));
    });

    function updateDefaultValue(type) {
        return (event) => {
            const name = event.target.info;
            const itemType = event.target.infoType;
            const { oldValue } = event.target;

            const value = itemType === 'checkbox' ? event.target.checked : event.target.value;

            let newOptions, missedValues, newValue, updateEnum;

            switch (itemType) {
            case 'text':
            case 'string':
            case 'checkbox':
                DBMS.updateDefaultValue(type, name, value, Utils.processError());
                break;
            case 'number':
                if (Number.isNaN(value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    event.target.value = oldValue;
                    return;
                }
                DBMS.updateDefaultValue(type, name, Number(value), Utils.processError());
                break;
            case 'multiEnum':
            case 'enum':
                if (value === '' && itemType === 'enum') {
                    Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                    event.target.value = oldValue;
                    return;
                }
                newOptions = value.split(',').map(R.trim);
                missedValues = oldValue.trim() === '' ? [] : R.difference(oldValue.split(','), newOptions);

                updateEnum = () => {
                    newValue = newOptions.join(',');
                    event.target.value = newValue;
                    event.target.oldValue = newValue;
                    DBMS.updateDefaultValue(type, name, newValue, Utils.processError());
                };

                if (missedValues.length !== 0) {
                    Utils.confirm(strFormat(getL10n('profiles-new-enum-values-remove-some-old-values'), [missedValues.join(',')]), updateEnum, () => {
                        event.target.value = oldValue;
                    });
                } else {
                    updateEnum();
                }
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [itemType]));
            }
        };
    }

    function doExportChange(type) {
        return (event) => {
            DBMS.doExportProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function showInRoleGridChange(type) {
        return (event) => {
            DBMS.showInRoleGridProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function renameProfileItem(type) {
        return (event) => {
            const newName = event.target.value.trim();
            const oldName = event.target.info;

            DBMS.renameProfileItem(type, newName, oldName, (err) => {
                if (err) {
                    event.target.value = event.target.info;
                    Utils.handleError(err);
                    return;
                }
                exports.refresh();
            });
        };
    }

    function changeProfileItemType(type) {
        return (event) => {
            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-changing-profile-item-type'), [event.target.info]), () => {
                const newType = event.target.value;
                const name = event.target.info;
                DBMS.changeProfileItemType(type, name, newType, Utils.processError(exports.refresh));
            }, () => {
                event.target.value = event.target.oldType;
            });
        };
    }

    function changeProfileItemPlayerAccess(type) {
        return (event) => {
            const playerAccessType = event.target.value;
            const name = event.target.info;
            DBMS.changeProfileItemPlayerAccess(type, name, playerAccessType, (err) => {
                if (err) {
                    event.target.value = event.target.oldValue;
                    Utils.processError()(err);
                }
            });
        };
    }
})(this.ProfileConfigurer = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {
        character: {},
        player: {}
    };
    const root = '.profile-editor-tab ';
    const characterSelector = `${root}.character-profile-selector`;
    const playerSelector = `${root}.player-profile-selector`;
    const characterProfileDiv = `${root}.character-profile-div`;
    const playerProfileDiv = `${root}.player-profile-div`;
    const characterReportDiv = `${root}.character-report-div tbody`;
    let profileEditorCore;

    exports.init = () => {
        $(characterSelector).select2().on('select2:select', showProfileInfoDelegate2('character'));
        $(playerSelector).select2().on('select2:select', showProfileInfoDelegate2('player'));
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        clearEl(queryEl(characterReportDiv));
        refreshPanel('character', characterSelector, characterProfileDiv, () => {
            refreshPanel('player', playerSelector, playerProfileDiv, () => {
                applySettings('character', characterSelector, characterProfileDiv);
            });
        });
    };

    function refreshPanel(type, selector, profileDiv, callback) {
        PermissionInformer.getEntityNamesArray(type, false, (err, names) => {
            if (err) { Utils.handleError(err); return; }

            names.push({ displayName: '', value: '', editable: false });

            clearEl(queryEl(selector));
            $(selector).select2(getSelect2Data(names));
            state[type].names = names;

            DBMS.getProfileStructure(type, (err2, allProfileSettings) => {
                if (err2) { Utils.handleError(err2); return; }
                profileEditorCore.initProfileStructure(profileDiv, type, allProfileSettings, callback);
            });
        });
    }

    function applySettings(type, selector, profileDiv) {
        const { names } = state[type];
        if (names.length > 0) {
            const name = names[0].value;
            const settings = DBMS.getSettings();
            if (!settings.ProfileEditor) {
                settings.ProfileEditor = {};
                settings.ProfileEditor[type] = name;
            }
            let profileName = settings.ProfileEditor[type];
            if (names.map(nameInfo => nameInfo.value).indexOf(profileName) === -1) {
                settings.ProfileEditor[type] = name;
                profileName = name;
            }
            showProfileInfoDelegate2(type)({ target: { value: profileName } });
        }
    }

    function selectProfiles(charName, playerName) {
        showProfileInfoDelegate('character', characterProfileDiv, charName);
        showProfileInfoDelegate('player', playerProfileDiv, playerName);
        $(characterSelector).select2().val(charName).trigger('change');
        $(playerSelector).select2().val(playerName).trigger('change');
    }

    function showProfileInfoDelegate2(type) {
        return (event) => {
            const name = event.target.value.trim();
            if (name === '') {
                selectProfiles('', '');
                return;
            }
            DBMS.getProfileBinding(type, name, (err, binding) => {
                if (err) { Utils.handleError(err); return; }
                selectProfiles(binding[0], binding[1]);
            });
        };
    }

    function showProfileInfoDelegate(type, profileDiv, name) {
        updateSettings(type, name);
        if (name === '') {
            addClass(queryEl(profileDiv), 'hidden');
            if (type === 'character') {
                addClass(queryEl(characterReportDiv), 'hidden');
            }
            return;
        }
        DBMS.getProfile(type, name, (err, profile) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isEntityEditable(type, name, (err2, isCharacterEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                profileEditorCore.fillProfileInformation(profileDiv, type, profile, () => isCharacterEditable);

                if (type === 'character') {
                    DBMS.getCharacterReport(name, (err3, characterReport) => {
                        if (err3) { Utils.handleError(err3); return; }
                        removeClass(queryEl(characterReportDiv), 'hidden');
                        addEls(
                            clearEl(queryEl(characterReportDiv)),
                            characterReport.map(CharacterReports.makeStoryReportRow)
                        );
                    });
                }
            });
        });
    }

    function updateSettings(type, name) {
        const settings = DBMS.getSettings();
        settings.ProfileEditor[type] = name;
    }
})(this.ProfileEditor = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

/* eslint-disable func-names */

'use strict';

((exports) => {
    exports.makeProfileEditorCore = () => {
        const innerExports = {};

        const root = '.profile-editor-core-tmpl';

        const state = {
            character: {},
            player: {}
        };

        innerExports.initProfileStructure = (profileDiv, type, profileStructure, callback) => {
            const container = qte(`${root} .profile-editor-container-tmpl`);
            addEl(clearEl(queryEl(profileDiv)), container);
            state[type].inputItems = {};
            state[type].profileStructure = profileStructure;

            if(profileStructure.length === 0){
                const alert = qmte('.alert-block-tmpl');
                addEl(alert, makeText(L10n.get('advices', `empty-${type}-profile-structure`)));
                addEl(queryEl(profileDiv), alert);
                if (callback) callback();
                return;
            }
            try {
                addEls(qee(queryEl(profileDiv), '.insertion-point'), profileStructure.map(appendInput(type)));
            } catch (err) {
                Utils.handleError(err); return;
            }

            if (callback) callback();
        };

        // eslint-disable-next-line no-var,vars-on-top
        var appendInput = R.curry((type, profileItemConfig) => {
            const itemInput = new ProfileItemInput(type, profileItemConfig);
            state[type].inputItems[profileItemConfig.name] = itemInput;
            const row = qte(`${root} .profile-editor-row-tmpl`);
            addEl(qee(row, '.profile-item-name'), makeText(profileItemConfig.name));
            addEl(qee(row, '.profile-item-input'), itemInput.dom);
            return row;
        });

        innerExports.fillProfileInformation = (profileDiv, type, profile, isEditable) => {
            removeClass(queryEl(profileDiv), 'hidden');
            R.values(state[type].inputItems).forEach((itemInput) => {
                if (itemInput.type === 'multiEnum') {
                    itemInput.multiEnumSelect.prop('disabled', !isEditable(itemInput.name, state[type].profileStructure));
                } else {
                    Utils.enableEl(itemInput.dom, isEditable(itemInput.name, state[type].profileStructure));
                }
            });

            state[type].name = profile.name;
            Object.values(state[type].inputItems).forEach((item) => {
                item.showFieldValue(profile);
            });
        };

        function ProfileItemInput(profileType, profileItemConfig) {
            let input, sel;
            switch (profileItemConfig.type) {
            case 'text':
                input = makeEl('textarea');
                addClass(input, 'profileTextInput');
                break;
            case 'string':
                input = makeEl('input');
                addClass(input, 'profileStringInput');
                break;
            case 'enum':
                input = makeEl('select');
                addClass(input, 'profileSelectInput');
                const toNameObj = R.compose(R.zipObj(['name']), R.append(R.__, []));
                fillSelector(input, R.sort(CommonUtils.charOrdA, profileItemConfig.value.split(',')).map(toNameObj));
                break;
            case 'number':
                input = makeEl('input');
                input.type = 'number';
                break;
            case 'checkbox':
                input = makeEl('input');
                input.type = 'checkbox';
                break;
            case 'multiEnum':
                this.multiEnumSelect = $('<select></select>');
                setAttr(this.multiEnumSelect[0], 'style', 'width: 100%;');
                addClass(this.multiEnumSelect[0], 'common-select');
                addClass(this.multiEnumSelect[0], 'profileStringInput');
                [input] = $('<span></span>').append(this.multiEnumSelect);
                setAttr(this.multiEnumSelect[0], 'multiple', 'multiple');

                sel = this.multiEnumSelect.select2(arr2Select2(R.sort(CommonUtils.charOrdA, profileItemConfig.value.split(','))));
                sel.on('change', this.updateFieldValue.bind(this));
                break;
            default:
                throw new Errors.InternalError('errors-unexpected-switch-argument', [profileItemConfig.type]);
            }

            if (profileItemConfig.type !== 'multiEnum') {
                listen(input, 'change', this.updateFieldValue.bind(this));
                addClass(input, 'form-control');
            }

            this.dom = input;
            this.type = profileItemConfig.type;
            this.profileType = profileType;
            this.name = profileItemConfig.name;
        }

        ProfileItemInput.prototype.showFieldValue = function (profile) {
            if (this.type === 'checkbox') {
                this.dom.checked = profile[this.name];
            } else if (this.type === 'multiEnum') {
                this.multiEnumSelect.val(profile[this.name] === '' ? null : profile[this.name].split(',')).trigger('change');
            } else {
                this.dom.value = profile[this.name];
            }
            this.oldValue = profile[this.name];
        };

        ProfileItemInput.prototype.updateFieldValue = function (event) {
            const fieldName = this.name;
            const profileName = state[this.profileType].name;
            if (this.multiEnumSelect && this.multiEnumSelect.prop('disabled')) {
                return; // we need to trigger change event on multiEnumSelect to update selection.
                // It may be disabled so it has false positive call.
            }

            let value, val;
            switch (this.type) {
            case 'text':
            case 'string':
            case 'enum':
                val = this.dom.value;
                value = val;
                break;
            case 'number':
                if (Number.isNaN(this.dom.value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    this.dom.value = this.oldValue;
                    return;
                }
                value = Number(this.dom.value);
                break;
            case 'checkbox':
                value = this.dom.checked;
                break;
            case 'multiEnum':
                value = this.multiEnumSelect.val().join(',');
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [this.type]));
                return;
            }
            DBMS.updateProfileField(this.profileType, profileName, fieldName, this.type, value, Utils.processError());
        };

        return innerExports;
    };
})(this.ProfileEditorCore = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, ProfileEditor, ProfileConfigurer, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const tabRoot = '.profiles-tab ';
    const characterRoot = `${tabRoot}.character-profile-panel `;
    const playerRoot = `${tabRoot}.player-profile-panel `;

    exports.init = () => {
        state.views = {};
        const nav = `${tabRoot}.sub-tab-navigation`;
        const content = `${tabRoot}.sub-tab-content`;
        const containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, 'profile-editor', ProfileEditor, { mainPage: true });
        Utils.addView(containers, 'profile-constructor', ProfileConfigurer);
        Utils.addView(containers, 'profile-binding', ProfileBinding);

        listen(queryEl(`${characterRoot}.create-entity-button`), 'click', createProfile('character', characterRoot));
        listen(queryEl(`${characterRoot}.rename-entity-button`), 'click', renameProfile('character', characterRoot));
        listen(queryEl(`${characterRoot}.remove-entity-button`), 'click', removeProfile('character', characterRoot));

        listen(queryEl(`${playerRoot}.create-entity-button`), 'click', createProfile('player', playerRoot));
        listen(queryEl(`${playerRoot}.rename-entity-button`), 'click', renameProfile('player', playerRoot));
        listen(queryEl(`${playerRoot}.remove-entity-button`), 'click', removeProfile('player', playerRoot));

        exports.content = queryEl(tabRoot);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', true, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', true, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                rebuildInterface(characterRoot, characterNames);
                rebuildInterface(playerRoot, playerNames);
                state.currentView.refresh();
            });
        });
    };

    function rebuildInterface(root, names) {
        const data = getSelect2Data(names);

        clearEl(queryEl(`${root}.rename-entity-select`));
        $(`${root}.rename-entity-select`).select2(data);

        clearEl(queryEl(`${root}.remove-entity-select`));
        $(`${root}.remove-entity-select`).select2(data);
    }

    function createProfile(type, root) {
        return () => {
            const input = queryEl(`${root}.create-entity-input`);
            const name = input.value.trim();

            DBMS.createProfile(type, name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    if (state.currentView.updateSettings) {
                        state.currentView.updateSettings(name);
                    }
                    input.value = '';
                    exports.refresh();
                });
            });
        };
    }

    function renameProfile(type, root) {
        return () => {
            const toInput = queryEl(`${root}.rename-entity-input`);
            const fromName = queryEl(`${root}.rename-entity-select`).value.trim();
            const toName = toInput.value.trim();

            DBMS.renameProfile(type, fromName, toName, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    toInput.value = '';
                    if (state.currentView.updateSettings) {
                        state.currentView.updateSettings(type, toName);
                    }
                    exports.refresh();
                });
            });
        };
    }

    function removeProfile(type, root) {
        return () => {
            const name = queryEl(`${root}.remove-entity-select`).value.trim();

            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-character-removing'), [name]), () => {
                DBMS.removeProfile(type, name, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        exports.refresh();
                    });
                });
            });
        };
    }
})(this.Profiles = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.character-reports-tmpl';

    exports.makeStoryReportRow = (storyInfo) => {
        const act = storyInfo.activity;
        const completeness = makeCompletenessLabel(storyInfo.finishedAdaptations, storyInfo.totalAdaptations);
        const color = getCompletenessColor(storyInfo.finishedAdaptations, storyInfo.totalAdaptations);
        const row = qte(`${root} .story-report-row-tmpl`);
        const qe = qee(row);
        L10n.localizeStatic(row);
        addEl(qe('.story-name'), makeText(storyInfo.storyName));
        setClassByCondition(qe('.activity-active'), 'active-item-in-report', act.active);
        setClassByCondition(qe('.activity-follower'), 'active-item-in-report', act.follower);
        setClassByCondition(qe('.activity-defensive'), 'active-item-in-report', act.defensive);
        setClassByCondition(qe('.activity-passive'), 'active-item-in-report', act.passive);
        addEl(qe('.completeness'), makeText(completeness));
        setStyle(qe('.completeness'), 'background-color', color);
        addEl(qe('.meets'), makeText(storyInfo.meets.join(', ')));
        addEl(qe('.inventory'), makeText(storyInfo.inventory));
        return row;
    };

    exports.makeRelationReportRow = R.curry((characterName, rel) => {
        const row = qte(`${root} .relation-report-row-tmpl`);
        const qe = qee(row);
        L10n.localizeStatic(row);
        const secondCharacter = ProjectUtils.get2ndRelChar(characterName, rel);
        addEl(qe('.character-name'), makeText(secondCharacter));
        const isStarter = rel.starter === characterName;

        if (isStarter) {
            setAttr(
                qe('.direction-starterToEnder'), 'title',
                L10n.format('briefings', 'starterToEnder', [characterName, secondCharacter])
            );
            setAttr(
                qe('.direction-enderToStarter'), 'title',
                L10n.format('briefings', 'enderToStarter', [secondCharacter, characterName])
            );
        } else {
            setAttr(
                qe('.direction-starterToEnder'), 'title',
                L10n.format('briefings', 'starterToEnder', [secondCharacter, characterName])
            );
            setAttr(
                qe('.direction-enderToStarter'), 'title',
                L10n.format('briefings', 'enderToStarter', [characterName, secondCharacter])
            );
        }

        setClassByCondition(
            qe('.direction-starterToEnder'), 'active-item-in-report',
            R.contains(isStarter ? 'starterToEnder' : 'enderToStarter', rel.essence)
        );
        setClassByCondition(qe('.direction-allies'), 'active-item-in-report', R.contains('allies', rel.essence));
        setClassByCondition(
            qe('.direction-enderToStarter'), 'active-item-in-report',
            R.contains(!isStarter ? 'starterToEnder' : 'enderToStarter', rel.essence)
        );

        const finished = isStarter ? rel.starterTextReady : rel.enderTextReady;

        addEl(qe('.completeness'), makeText(L10n.get('constant', finished ? 'finished' : 'unfinished')));
        setClassByCondition(qe('.completeness'), 'relation-finished', finished);
        setClassByCondition(qe('.completeness'), 'relation-unfinished', !finished);

        addEl(qe('.origin'), makeText(rel.origin));
        return row;
    });

    function makeCompletenessLabel(value, total) {
        return strFormat('{0} ({1}/{2})', [total === 0 ? '-' : `${((value / total) * 100).toFixed(0)}%`, value, total]);
    }

    function getCompletenessColor(value, total) {
        if (total === 0) { return 'transparent'; }
        function calc(b, a, part) {
            return ((a * part) + ((1 - part) * b)).toFixed(0);
        }

        let p = value / total;
        if (p < 0.5) {
            p *= 2;
            return strFormat('rgba({0},{1},{2}, 1)', [calc(251, 255, p), calc(126, 255, p), calc(129, 0, p)]); // red to yellow mapping
        }
        p = (p - 0.5) * 2;
        return strFormat('rgba({0},{1},{2}, 1)', [calc(255, 123, p), calc(255, 225, p), calc(0, 65, p)]); // yellow to green mapping
    }
})(this.CharacterReports = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.profile-binding2-tab ';
    const l10n = L10n.get('binding');

    exports.init = () => {
        listen(queryEl(`${root} .character-filter`), 'input', filterList('.character-list'));
        listen(queryEl(`${root} .player-filter`), 'input', filterList('.player-list'));
        listen(queryEl(`${root} .binding-filter`), 'input', filterList('.binding-list'));

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray('character', false, (err, characterNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('player', false, (err2, playerNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(characterNames, playerNames, profileBindings);
                });
            });
        });
    };

    function rebuildInterface(characterNames, playerNames, profileBindings) {
        const bondedCharacterList = R.keys(profileBindings);
        const bondedPlayerList = R.values(profileBindings);
        const filter = list => R.compose(R.not, R.contains(R.__, list), R.prop('value'));
        
        showEl(queryEl(`${root} .alert.no-character`), characterNames.length === 0);
        Utils.enableEl(queryEl(`${root} .character-filter`), characterNames.length !== 0);
        showEl(queryEl(`${root} .character-list`), characterNames.length !== 0);
        
        showEl(queryEl(`${root} .alert.no-player`), playerNames.length === 0);
        Utils.enableEl(queryEl(`${root} .player-filter`), playerNames.length !== 0);
        showEl(queryEl(`${root} .player-list`), playerNames.length !== 0);
        
        Utils.enableEl(queryEl(`${root} .binding-filter`), R.keys(profileBindings).length !== 0);

        addEls(
            clearEl(queryEl(`${root} .entity-list.character-list`)),
            characterNames.filter(filter(bondedCharacterList)).map(profile2el('character'))
        );

        addEls(
            clearEl(queryEl(`${root} .entity-list.player-list`)),
            playerNames.filter(filter(bondedPlayerList)).map(profile2el('player'))
        );

        const bindings = R.toPairs(profileBindings).map(binding => ({
            name: R.join('/', binding),
            value: binding
        }));
        bindings.sort(CommonUtils.charOrdAFactory(R.prop('name')));

        addEls(clearEl(queryEl(`${root} .entity-list.binding-list`)), bindings.map(binding2el));
    }

    const profile2el = R.curry((type, name) => {
        const el = qmte(`${root} .profile-item-tmpl`);
        el.profileName = name.value;
        const btn = qee(el, '[role=button]');
        addEl(qee(el, '.primary-name'), makeText(name.displayName));
        setAttr(btn, 'profile-name', name.value);
        setAttr(btn, 'primary-name', name.displayName);
        setAttr(btn, 'profile-type', type);
        listen(btn, 'dragstart', onDragStart);
        listen(btn, 'drop', onDrop);
        listen(btn, 'dragover', allowDrop);
        listen(btn, 'dragenter', handleDragEnter);
        listen(btn, 'dragleave', handleDragLeave);
        return el;
    });

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function(event) {
        console.log(`onDragStart ${this.profileName}`);
        event.dataTransfer.setData('data', JSON.stringify({
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
        }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function(event) {
        removeClass(this, 'over');
        console.log(`onDrop ${this.profileName}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        const thatData = JSON.parse(event.dataTransfer.getData('data'));
        if (thatData.type === getAttr(this, 'profile-type')) {
            return;
        }

        createBinding([thatData, {
            name: getAttr(this, 'profile-name'),
            type: getAttr(this, 'profile-type'),
        }]);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function(event) {
        console.log(`allowDrop ${this.profileName}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    function binding2el(binding) {
        const el = wrapEl('div', qte(`${root} .binding-item-tmpl`));
        addEl(qee(el, '.primary-name'), makeText(binding.name));
        setAttr(el, 'primary-name', binding.name);
        setAttr(qee(el, '.unlink'), 'title', l10n('unlink-binding'));
        listen(qee(el, '.unlink'), 'click', () => removeBinding(binding.value));
        return el;
    }

    // eslint-disable-next-line no-var,vars-on-top
    var filterList = sel => (event) => {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} ${sel} [primary-name]`);
        els.forEach((el) => {
            const isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            showEl(el, isVisible);
        });
    };

    function createBinding(pair) {
        const characterName = pair[0].type === 'character' ? pair[0].name : pair[1].name;
        const playerName = pair[0].type === 'player' ? pair[0].name : pair[1].name;
        DBMS.createBinding(characterName, playerName, Utils.processError(exports.refresh));
    }

    function removeBinding(binding) {
        DBMS.removeBinding(binding[0], binding[1], Utils.processError(exports.refresh));
    }
})(this.ProfileBinding2 = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';


// Character/Player profiles already have field 'name'
// I had some choices:
// 1. remove this field at all
// 2. Add one more object to divide special values (name) and user defined values
// 3. Prohibit to make field - name
// 1. This field is used in many places
// 2. - too complex way
// 3. simple and lesser complexity, I choose this way

function ProfileConfigurerTmpl(exports, opts) {
    const { tabType } = opts;

    const tmplRoot = '.profile-configurer2-tab-tmpl';
    const tabRoot = `.profile-configurer2-tab.${`${tabType}-type`} `;
    const profilePanel = `${tabRoot}.profile-panel `;
    const l10n = L10n.get('profiles');
    const state = {};

    exports.init = () => {
        const el = queryEl(tmplRoot).cloneNode(true);

        addClasses(el, ['profile-configurer2-tab', `${`${tabType}-type`}`]);
        removeClass(el, 'profile-configurer2-tab-tmpl');
        addEl(queryEl('.tab-container'), el);

        const createProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            createProfileItem, {
                bodySelector: 'create-profile-item-body',
                dialogTitle: 'profiles-create-profile-item',
                actionButtonTitle: 'common-create',
                initBody: (body) => {
                    const sel = clearEl(qee(body, '.create-entity-type-select'));
                    const fillMainSel = () => { fillItemTypesSel(clearEl(sel)); };
                    fillMainSel();
                    L10n.onL10nChange(fillMainSel);
                }
            }
        );

        state.renameProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            renameProfileItem, {
                bodySelector: 'modal-prompt-body',
                dialogTitle: 'profiles-enter-new-profile-item-name',
                actionButtonTitle: 'common-rename',
            }
        );

        state.moveProfileItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            moveProfileItem, {
                bodySelector: 'move-profile-item-body',
                dialogTitle: 'profiles-new-profile-item-position',
                actionButtonTitle: 'common-move',
            }
        );
        
        state.renameEnumItemDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            renameEnumValue, {
                bodySelector: 'rename-enum-value-tmpl',
                dialogTitle: 'profiles-rename-enum-item',
                actionButtonTitle: 'common-rename',
                initBody: (body) => {
                    const renameSelect = clearEl(qee(body, '.renamed-value-select'));
                    const renameInput = clearEl(qee(body, '.enum-value-name-input'));
                    listen(renameSelect, 'change', () => {
                        renameInput.value = renameSelect.value;
                    });
                }
            }
        );
        
        state.enumEditorDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            updateEnumValues, {
                bodySelector: 'enum-dialog-editor-tmpl',
                dialogTitle: 'profiles-enum-editor',
                actionButtonTitle: 'common-save',
                initBody: (body) => {
                    const addedValuesArea = qee(body, '.new-enum-values');
                    const removedValuesArea = qee(body, '.removed-enum-values');
                    const inputArea = qee(body, '.enum-value-input');
                    const defaultValueSelect = qee(body, '.default-value-select');
                    listen(inputArea, 'input', () => {
                        const newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
                        const addedValues = R.sort(CommonUtils.charOrdA, R.difference(newVals, inputArea.srcList));
                        addEls(clearEl(addedValuesArea), enumList2Els(addedValues));
                        const removedValues = R.sort(CommonUtils.charOrdA, R.difference(inputArea.srcList, newVals));
                        addEls(clearEl(removedValuesArea), enumList2Els(removedValues));
                        
                        let defaultValue = defaultValueSelect.value;
                        clearEl(defaultValueSelect);
                        
                        if(newVals.length === 0){
                            return;
                        }
                        
                        if(!R.contains(defaultValue, newVals)){
                            defaultValue = newVals[0];
                        }
                        fillSelector(defaultValueSelect, arr2Select(newVals));
                        qee(defaultValueSelect, `[value="${defaultValue}"]`).selected = true;
                    });
                }
            }
        );
        
        state.multiEnumEditorDialog = UI.createModalDialog(
            `.profile-configurer2-tab.${`${tabType}-type`}`,
            updateEnumValues, {
                bodySelector: 'multi-enum-dialog-editor-tmpl',
                dialogTitle: 'profiles-multi-enum-editor',
                actionButtonTitle: 'common-save',
                initBody: (body) => {
                    const addedValuesArea = qee(body, '.new-enum-values');
                    const removedValuesArea = qee(body, '.removed-enum-values');
                    const inputArea = qee(body, '.enum-value-input');
                    listen(inputArea, 'input', () => {
                        const newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
                        const addedValues = R.sort(CommonUtils.charOrdA, R.difference(newVals, inputArea.srcList));
                        addEls(clearEl(addedValuesArea), enumList2Els(addedValues));
                        const removedValues = R.sort(CommonUtils.charOrdA, R.difference(inputArea.srcList, newVals));
                        addEls(clearEl(removedValuesArea), enumList2Els(removedValues));
                    });
                }
            }
        );

        setAttr(qee(el, '.panel h3'), 'l10n-id', `profiles-${opts.panelName}`);
        setAttr(qee(el, '.alert'), 'l10n-id', `advices-empty-${tabType}-profile-structure`);
        L10n.localizeStatic(el);

        setAttr(qee(el, '.panel a'), 'panel-toggler', `${tabRoot}.profile-panel`);
        UI.initPanelTogglers(el);

        listen(qe(`${tabRoot}.create`), 'click', () => createProfileItemDialog.showDlg());
        exports.content = el;
    };

    exports.refresh = () => {
        refreshPanel(tabType, profilePanel);
    };

    function refreshPanel(type, root) {
        DBMS.getProfileStructure(type, (err, allProfileSettings) => {
            if (err) { Utils.handleError(err); return; }
            
            hideEl(queryEl(`${tabRoot} .alert`), allProfileSettings.length !== 0);
            hideEl(queryEl(`${tabRoot} table`), allProfileSettings.length === 0);

            const arr = allProfileSettings.map(R.compose(strFormat(getL10n('common-set-item-before')), R.append(R.__, []), R.prop('name')));
            arr.push(getL10n('common-set-item-as-last'));

            const positionSelectors = [queryEl(`${tabRoot} .create-entity-position-select`),
                queryEl(`${tabRoot} .move-entity-position-select`)];
            positionSelectors.map(clearEl).map(fillSelector(R.__, arr2Select(arr))).map(setProp(R.__, 'selectedIndex', allProfileSettings.length));

            const table = clearEl(queryEl(`${root}.profile-config-container`));

            try {
                addEls(table, allProfileSettings.map(getInput(type)));
            } catch (err1) {
                Utils.handleError(err1); return;
            }

            PermissionInformer.isAdmin((err2, isAdmin) => {
                if (err2) { Utils.handleError(err2); return; }
                Utils.enable(exports.content, 'adminOnly', isAdmin);
            });
        });
    }

    function createProfileItem(dialog) {
        return () => {
            const input = qee(dialog, '.create-entity-name-input');
            const name = input.value.trim();
            const itemType = qee(dialog, '.create-entity-type-select').value.trim();
            const { selectedIndex } = qee(dialog, '.create-entity-position-select');

            DBMS.createProfileItem(tabType, name, itemType, selectedIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    input.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    // eslint-disable-next-line no-var,vars-on-top
    var fillItemTypesSel = sel => fillSelector(sel, constArr2Select(R.keys(Constants.profileFieldTypes)));
    const fillPlayerAccessSel = sel => fillSelector(sel, constArr2Select(Constants.playerAccessTypes));

    // eslint-disable-next-line no-var,vars-on-top
    var getInput = R.curry((type, profileSettings, index) => { // throws InternalError
        const row = qte(`${tabRoot} .profile-configurer-row-tmpl`);
        L10n.localizeStatic(row);
        addEl(qee(row, '.item-position'), makeText(index + 1));
        addEl(qee(row, '.item-name'), makeText(profileSettings.name));

        const itemType = qee(row, '.item-type');
        fillItemTypesSel(itemType);
        itemType.value = profileSettings.type;
        itemType.info = profileSettings.name;
        itemType.oldType = profileSettings.type;
        listen(itemType, 'change', changeProfileItemType(type));

        let input, addDefaultListener = true;
        switch (profileSettings.type) {
        case 'text':
            input = makeEl('textarea');
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'enum':
            input = qmte(`${tabRoot} .enum-value-editor-tmpl`);
            const list = profileSettings.value.split(',');
            const defaultValue = list[0];
            list.sort(CommonUtils.charOrdA);
            
            addEls(qee(input, '.text'), enumList2Els(list, defaultValue));
            
            listen(qee(input, '.btn.add'), 'click', () => {
                addEls(clearEl(qee(state.enumEditorDialog, '.initial-value')), enumList2Els(list, defaultValue));
                const inputArea = qee(state.enumEditorDialog, '.enum-value-input');
                inputArea.value = list.join(',');
                inputArea.srcList = list;
                inputArea.defaultValue = defaultValue;
                
                const defaultValueSelect = clearEl(qee(state.enumEditorDialog, '.default-value-select'));
                fillSelector(defaultValueSelect, arr2Select(list));
                qee(defaultValueSelect, `[value="${defaultValue}"]`).selected = true;
                state.enumEditorDialog.itemName = profileSettings.name;
                state.enumEditorDialog.showDlg();
            });
            
            listen(qee(input, '.btn.rename'), 'click', () => {
                const renameSelect = clearEl(qee(state.renameEnumItemDialog, '.renamed-value-select'));
                fillSelector(renameSelect, arr2Select(list));
                
                if(list.length > 0){
                    qee(state.renameEnumItemDialog, '.enum-value-name-input').value = list[0]; 
                }
                
                state.renameEnumItemDialog.itemName = profileSettings.name;
                state.renameEnumItemDialog.showDlg();
            });
            
            L10n.localizeStatic(input);
            addDefaultListener = false;
            break;
        case 'multiEnum':
            input = qmte(`${tabRoot} .enum-value-editor-tmpl`);
            const list2 = profileSettings.value.split(',');
            list2.sort(CommonUtils.charOrdA);
            
            addEls(qee(input, '.text'), enumList2Els(list2));
            
            listen(qee(input, '.btn.add'), 'click', () => {
                addEls(clearEl(qee(state.multiEnumEditorDialog, '.initial-value')), enumList2Els(list2));
                const inputArea = qee(state.multiEnumEditorDialog, '.enum-value-input');
                inputArea.value = list2.join(',');
                inputArea.srcList = list2;
                state.multiEnumEditorDialog.itemName = profileSettings.name;
                state.multiEnumEditorDialog.showDlg();
            });
            
            listen(qee(input, '.btn.rename'), 'click', () => {
                const renameSelect = clearEl(qee(state.renameEnumItemDialog, '.renamed-value-select'));
                fillSelector(renameSelect, arr2Select(list2));
                
                if(list2.length > 0){
                    qee(state.renameEnumItemDialog, '.enum-value-name-input').value = list2[0]; 
                }
                
                state.renameEnumItemDialog.itemName = profileSettings.name;
                state.renameEnumItemDialog.showDlg();
            });
            
            L10n.localizeStatic(input);
            addDefaultListener = false;
            break;
        case 'string':
            input = makeEl('input');
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'number':
            input = makeEl('input');
            input.type = 'number';
            addClass(input, 'hidden');
            input.value = profileSettings.value;
            break;
        case 'checkbox':
            input = makeEl('input');
            setAttr(input, 'title', l10n('default-value'));
            input.type = 'checkbox';
            input.checked = profileSettings.value;
            break;
        default:
            throw new Errors.InternalError('errors-unexpected-switch-argument', [profileSettings.type]);
        }

        setProps(input, {
            info: profileSettings.name,
            infoType: profileSettings.type,
            oldValue: profileSettings.value
        });
        if(addDefaultListener){
            addClasses(input, [`profile-configurer-${profileSettings.type}`, 'adminOnly', 'form-control']);
            listen(input, 'change', updateDefaultValue(type));
        }
        addEl(qee(row, '.item-default-value-container'), input);

        setClassIf(qee(row, '.print'), 'btn-primary', profileSettings.doExport);
        listen(qee(row, '.print'), 'click', (e) => {
            DBMS.doExportProfileItemChange(type, profileSettings.name, !hasClass(e.target, 'btn-primary'), (err) => {
                if (err) { Utils.handleError(err); return; }
                toggleClass(e.target, 'btn-primary');
            });
        });

        const playerAccess = qee(row, '.player-access');
        fillPlayerAccessSel(playerAccess);
        playerAccess.value = profileSettings.playerAccess;
        playerAccess.info = profileSettings.name;
        playerAccess.oldValue = profileSettings.playerAccess;
        listen(playerAccess, 'change', changeProfileItemPlayerAccess(type));

        const showInRoleGrid = qee(row, '.show-in-role-grid');
        showInRoleGrid.checked = profileSettings.showInRoleGrid;
        showInRoleGrid.info = profileSettings.name;
        listen(showInRoleGrid, 'change', showInRoleGridChange(type));

        listen(qee(row, '.move'), 'click', () => {
            state.currentIndex = index;
            state.moveProfileItemDialog.showDlg();
        });

        listen(qee(row, '.rename-profile-item'), 'click', () => {
            qee(state.renameProfileItemDialog, '.entity-input').value = profileSettings.name;
            state.renameProfileItemDialog.fromName = profileSettings.name;
            state.renameProfileItemDialog.showDlg();
        });

        listen(qee(row, '.remove'), 'click', () => {
            Utils.confirm(L10n.format('profiles', 'are-you-sure-about-removing-profile-item', [profileSettings.name]), () => {
                DBMS.removeProfileItem(type, index, profileSettings.name, Utils.processError(exports.refresh));
            });
        });

        return row;
    });
    
    function enumList2Els(list, defaultValue){
        return R.splitEvery(4, list.map(val => {
            const span = addEl(makeEl('span'), makeText(val));
            if(defaultValue !== undefined && val === defaultValue){
                addClass(span, 'bold');
                setAttr(span, 'title', l10n('default-value'));
            }
            addClass(span, 'margin-right-16 enum-item');
            return span;
        })).map(arr => addEls(makeEl('div'), arr));
    }

    function updateDefaultValue(type) {
        return (event) => {
            const name = event.target.info;
            const itemType = event.target.infoType;
            const { oldValue } = event.target;

            const value = itemType === 'checkbox' ? event.target.checked : event.target.value;

            let newOptions, missedValues, newValue, updateEnum;

            switch (itemType) {
            case 'text':
            case 'string':
            case 'checkbox':
                DBMS.updateDefaultValue(type, name, value, Utils.processError());
                break;
            case 'number':
                if (Number.isNaN(value)) {
                    Utils.alert(getL10n('profiles-not-a-number'));
                    event.target.value = oldValue;
                    return;
                }
                DBMS.updateDefaultValue(type, name, Number(value), Utils.processError());
                break;
            case 'multiEnum':
            case 'enum':
                if (value === '' && itemType === 'enum') {
                    Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                    event.target.value = oldValue;
                    return;
                }
                newOptions = value.split(',').map(R.trim);
                missedValues = oldValue.trim() === '' ? [] : R.difference(oldValue.split(','), newOptions);

                updateEnum = () => {
                    newValue = newOptions.join(',');
                    event.target.value = newValue;
                    event.target.oldValue = newValue;
                    DBMS.updateDefaultValue(type, name, newValue, Utils.processError());
                };

                if (missedValues.length !== 0) {
                    Utils.confirm(strFormat(getL10n('profiles-new-enum-values-remove-some-old-values'), [missedValues.join(',')]), updateEnum, () => {
                        event.target.value = oldValue;
                    });
                } else {
                    updateEnum();
                }
                break;
            default:
                Utils.handleError(new Errors.InternalError('errors-unexpected-switch-argument', [itemType]));
            }
        };
    }

    function showInRoleGridChange(type) {
        return (event) => {
            DBMS.showInRoleGridProfileItemChange(type, event.target.info, event.target.checked, Utils.processError());
        };
    }

    function renameProfileItem(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const oldName = dialog.fromName;
            const newName = toInput.value.trim();

            DBMS.renameProfileItem(tabType, newName, oldName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function moveProfileItem(dialog) {
        return () => {
            const index = state.currentIndex;
            const newIndex = queryEl(`${tabRoot}.move-entity-position-select`).selectedIndex;
            DBMS.moveProfileItem(tabType, index, newIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function updateEnumValues(dialog) {
        return () => {
            const name = dialog.itemName;
            const inputArea = qee(dialog, '.enum-value-input');
            const defaultValueSelect = qee(dialog, '.default-value-select');
            
            if (inputArea.value.trim() === '') {
                Utils.alert(getL10n('profiles-enum-item-cant-be-empty'));
                return;
            }
            let newVals = inputArea.value.split(',').map(R.trim).filter(R.pipe(R.equals(''), R.not));
            if(defaultValueSelect){
                const defaultValue = defaultValueSelect.value;
                newVals = R.without([defaultValue], newVals);
                newVals = R.prepend(defaultValue, newVals);
            }
            
            DBMS.updateDefaultValue(tabType, name, newVals.join(','), (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function renameEnumValue(dialog) {
        return () => {
            const name = dialog.itemName;
            const renameSelect = qee(dialog, '.renamed-value-select');
            const renameInput = qee(dialog, '.enum-value-name-input');
            
            DBMS.renameEnumValue(tabType, name, renameSelect.value.trim(), renameInput.value.trim(), (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function changeProfileItemType(type) {
        return (event) => {
            Utils.confirm(strFormat(getL10n('profiles-are-you-sure-about-changing-profile-item-type'), [event.target.info]), () => {
                const newType = event.target.value;
                const name = event.target.info;
                DBMS.changeProfileItemType(type, name, newType, Utils.processError(exports.refresh));
            }, () => {
                event.target.value = event.target.oldType;
            });
        };
    }

    function changeProfileItemPlayerAccess(type) {
        return (event) => {
            const playerAccessType = event.target.value;
            const name = event.target.info;
            DBMS.changeProfileItemPlayerAccess(type, name, playerAccessType, (err) => {
                if (err) {
                    event.target.value = event.target.oldValue;
                    Utils.processError()(err);
                }
            });
        };
    }
}

ProfileConfigurerTmpl(this.CharacterConfigurer = {}, {
    tabType: 'character',
    panelName: 'characters-profile-structure',
});

ProfileConfigurerTmpl(this.PlayerConfigurer = {}, {
    tabType: 'player',
    panelName: 'players-profile-structure',
});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

function ProfileEditorTmpl(exports, opts) {
    const { firstType, secondType, settingsPath } = opts;

    const tmplRoot = '.profile-editor2-tab-tmpl';
    const root = `.profile-editor2-tab.${`${firstType}-type`} `;
    const state = {};
    const l10n = L10n.get('profiles');
    let profileEditorCore;
    const profilePanel = `${root}.profile-panel`;
    const reportByStories = `${root}.report-by-stories`;
    const reportByRelations = `${root}.report-by-relations`;
    const profileDiv = `${root}.profile-div`;
    const reportByStoriesDiv = `${root}.report-by-stories-div tbody`;
    const reportByRelationsDiv = `${root}.report-by-relations-div tbody`;
    const alertBlock = `${root}.alert-block`;

    exports.init = () => {
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        const el = queryEl(tmplRoot).cloneNode(true);

        addClasses(el, ['profile-editor2-tab', `${`${firstType}-type`}`]);
        removeClass(el, 'profile-editor2-tab-tmpl');
        addEl(queryEl('.tab-container'), el);

        const createCharacterDialog = UI.createModalDialog(
            `.profile-editor2-tab.${`${firstType}-type`}`,
            createProfile, {
                bodySelector: 'modal-prompt-body',
                dialogTitle: `profiles-${opts.createMsg}`,
                actionButtonTitle: 'common-create',
            }
        );
        listen(queryEl(`${root} .create`), 'click', () => createCharacterDialog.showDlg());
        state.renameCharacterDialog = UI.createModalDialog(`.${`${firstType}-type`}`, renameProfile, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: `profiles-${opts.renameMsg}`,
            actionButtonTitle: 'common-rename',
        });

        hideEl(qee(el, '.report-by-stories'), firstType === 'player');
        hideEl(qee(el, '.report-by-relations'), firstType === 'player');
        setAttr(qee(el, '.entity-filter'), 'l10n-placeholder-id', `profiles-${opts.filterPlaceholder}`);
        setAttr(qee(el, '.profile-panel h3'), 'l10n-id', `profiles-${opts.panelName}`);
        setAttr(qee(el, '.create'), 'l10n-title', `profiles-${opts.createProfile}`);
        setAttr(qee(el, '.alert-block'), 'l10n-id', `advices-no-${firstType}`);
        L10n.localizeStatic(el);

        setAttr(qee(el, '.report-by-stories a'), 'panel-toggler', `${root}.report-by-stories-div`);
        setAttr(qee(el, '.report-by-relations a'), 'panel-toggler', `${root}.report-by-relations-div`);
        setAttr(qee(el, '.profile-panel a'), 'panel-toggler', `${root}.profile-div`);
        UI.initPanelTogglers(el);

        exports.content = el;
        listen(queryEl(`${root} .entity-filter`), 'input', filterOptions);
    };

    exports.refresh = () => {
        PermissionInformer.getEntityNamesArray(firstType, false, (err, primaryNames) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray(secondType, false, (err2, secondaryNames) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getProfileBindings((err3, profileBindings) => {
                    if (err3) { Utils.handleError(err3); return; }
                    profileBindings = opts.processBindings(profileBindings);
                    Utils.enableEl(queryEl(`${root}.entity-filter`), primaryNames.length > 0);
                    rebuildInterface(primaryNames, secondaryNames, profileBindings);
                });
            });
        });
    };

    function rebuildInterface(primaryNames, secondaryNames, profileBindings) {
        const secDict = R.indexBy(R.prop('value'), secondaryNames);
        addEls(clearEl(queryEl(`${root} .entity-list`)), primaryNames.map((name, i, arr) => {
            const el = wrapEl('div', qte(`${root} .entity-item-tmpl`));
            addEl(qee(el, '.primary-name'), makeText(name.displayName));
            setAttr(el, 'primary-name', name.displayName);
            setAttr(el, 'profile-name', name.value);
            if (profileBindings[name.value] !== undefined) {
                const secondaryName = secDict[profileBindings[name.value]].displayName;
                addEl(qee(el, '.secondary-name'), makeText(secondaryName));
                setAttr(el, 'secondary-name', secondaryName);
            }
            listen(qee(el, '.select-button'), 'click', () => selectProfile(name.value));
            setAttr(qee(el, '.rename'), 'title', l10n(opts.renameProfile));
            const removeBtn = qee(el, '.remove');
            setAttr(removeBtn, 'title', l10n(opts.removeProfile));
            if(i+1 < arr.length){
                removeBtn.nextName = arr[i+1].value;
            }
            if(i > 0){
                removeBtn.prevName = arr[i-1].value;
            }
            if (name.editable) {
                listen(qee(el, '.rename'), 'click', () => {
                    qee(state.renameCharacterDialog, '.entity-input').value = name.value;
                    state.renameCharacterDialog.fromName = name.value;
                    state.renameCharacterDialog.showDlg();
                });
                listen(removeBtn, 'click', removeProfile(firstType, name.value, removeBtn));
            } else {
                setAttr(qee(el, '.rename'), 'disabled', 'disabled');
                setAttr(removeBtn, 'disabled', 'disabled');
            }
            return el;
        }));

        const callback = () => {
            selectProfile(UI.checkAndGetEntitySetting(settingsPath, primaryNames));
        };
        DBMS.getProfileStructure(firstType, (err2, allProfileSettings) => {
            if (err2) { Utils.handleError(err2); return; }
            profileEditorCore.initProfileStructure(profileDiv, firstType, allProfileSettings, callback);
        });
    }

    function selectProfile(name) {
        hideEl(queryEl(profilePanel), name === null);
        hideEl(queryEl(reportByStories), name === null || firstType === 'player');
        hideEl(queryEl(reportByRelations), name === null || firstType === 'player');
        hideEl(queryEl(alertBlock), name !== null);
        
        if(name === null){
            return;
        }
        
        UI.updateEntitySetting(settingsPath, name);
        queryEls(`${root} [profile-name] .select-button`).map(removeClass(R.__, 'btn-primary'));
        const el = queryEl(`${root} [profile-name="${name}"] .select-button`);
        addClass(el, 'btn-primary');
        
        const parentEl = el.parentElement.parentElement;
        const entityList = queryEl(`${root} .entity-list`);
        UI.scrollTo(entityList, parentEl);
        
        DBMS.getProfile(firstType, name, (err, profile) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.isEntityEditable(firstType, name, (err2, isProfileEditable) => {
                if (err2) { Utils.handleError(err2); return; }
                removeClass(queryEl(profileDiv), 'hidden');
                profileEditorCore.fillProfileInformation(profileDiv, firstType, profile, () => isProfileEditable);

                if (firstType === 'character') {
                    DBMS.getCharacterReport(name, (err3, characterReport) => {
                        if (err3) { Utils.handleError(err3); return; }
                        DBMS.getRelationsSummary(name, (err4, relationsSummary) => {
                            if (err4) { Utils.handleError(err4); return; }
                            
                            hideEl(queryEl(`${reportByStories} .alert`), characterReport.length !== 0);
                            hideEl(queryEl(`${reportByStories} table`), characterReport.length === 0);
                            
                            if(characterReport.length !== 0){
                                removeClass(queryEl(reportByStoriesDiv), 'hidden');
                                addEls(
                                        clearEl(queryEl(reportByStoriesDiv)),
                                        characterReport.map(CharacterReports.makeStoryReportRow)
                                );
                            }
                            
                            hideEl(queryEl(`${reportByRelations} .alert`), relationsSummary.relations.length !== 0);
                            hideEl(queryEl(`${reportByRelations} table`), relationsSummary.relations.length === 0);
                            
                            if(relationsSummary.relations.length !== 0){
                                removeClass(queryEl(reportByRelationsDiv), 'hidden');
                                relationsSummary.relations.sort(CommonUtils.charOrdAFactory(rel =>
                                        ProjectUtils.get2ndRelChar(name, rel).toLowerCase()));
                                
                                addEls(clearEl(queryEl(reportByRelationsDiv)), relationsSummary.relations
                                        .map(CharacterReports.makeRelationReportRow(name)));
                            }
                        });
                    });
                }
            });
        });
    }

    function filterOptions(event) {
        const str = event.target.value.toLowerCase();

        const els = queryEls(`${root} [primary-name]`);
        els.forEach((el) => {
            let isVisible = getAttr(el, 'primary-name').toLowerCase().indexOf(str) !== -1;
            if (!isVisible && getAttr(el, 'secondary-name') !== null) {
                isVisible = getAttr(el, 'secondary-name').toLowerCase().indexOf(str) !== -1;
            }
            hideEl(el, !isVisible);
        });

        if (queryEl(`${root} .hidden[primary-name] .select-button.btn-primary`) !== null ||
            queryEl(`${root} [primary-name] .select-button.btn-primary`) === null) {
            const els2 = queryEls(`${root} [primary-name]`).filter(R.pipe(hasClass(R.__, 'hidden'), R.not));
            selectProfile(els2.length > 0 ? getAttr(els2[0], 'profile-name') : null);
        } else {
            //            queryEl(`${root} [primary-name] .select-button.btn-primary`).scrollIntoView();
        }
    }

    function createProfile(dialog) {
        return () => {
            const input = qee(dialog, '.entity-input');
            const value = input.value.trim();

            DBMS.createProfile(firstType, value, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, value);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        input.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function renameProfile(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const { fromName } = dialog;
            const toName = toInput.value.trim();

            DBMS.renameProfile(firstType, fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    UI.updateEntitySetting(settingsPath, toName);
                    toInput.value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeProfile(type, name, btn) {
        return () => {
            Utils.confirm(strFormat(l10n(opts.removeMsg), [name]), () => {
                DBMS.removeProfile(type, name, (err) => {
                    if (err) { Utils.handleError(err); return; }
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        if(btn.nextName !== undefined){
                            UI.updateEntitySetting(settingsPath, btn.nextName);
                        } else if(btn.prevName !== undefined) {
                            UI.updateEntitySetting(settingsPath, btn.prevName);
                        }
                        
                        exports.refresh();
                    });
                });
            });
        };
    }
}

ProfileEditorTmpl(this.CharacterEditor = {}, {
    firstType: 'character',
    secondType: 'player',
    settingsPath: 'Characters',
    processBindings: R.identity,
    createMsg: 'enter-character-name',
    renameMsg: 'enter-new-character-name',
    removeMsg: 'are-you-sure-about-character-removing',
    filterPlaceholder: 'find-character',
    panelName: 'character-profile',
    createProfile: 'create-character',
    renameProfile: 'rename-character',
    removeProfile: 'remove-character',
});

ProfileEditorTmpl(this.PlayerEditor = {}, {
    firstType: 'player',
    secondType: 'character',
    settingsPath: 'Players',
    processBindings: R.invertObj,
    createMsg: 'enter-player-name',
    renameMsg: 'enter-new-player-name',
    removeMsg: 'are-you-sure-about-player-removing',
    filterPlaceholder: 'find-player',
    panelName: 'player-profile',
    createProfile: 'create-player',
    renameProfile: 'rename-player',
    removeProfile: 'remove-player',
});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.role-grid-tab ';
    let groupingOrder;
    let profilesData;
    let buttons;
    const l10n = L10n.get('role-grid');

    exports.init = () => {
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getRoleGridInfo((err, data2) => {
            if (err) { Utils.handleError(err); return; }
            groupingOrder = [];
            buttons = [];
            
            showEl(qe(`${root} .alert.no-character-profile`), data2.characterProfileStructure.length === 0);
            showEl(qe(`${root} .alert.no-characters`), data2.profileData.length === 0);
            
            showEl(qe(`${root} > .container-fluid`), data2.profileData.length !== 0 && data2.characterProfileStructure.length !== 0);

            // hack - dynamically replace checkbox with enum
            const checkboxes = data2.characterProfileStructure.filter(el => el.type === 'checkbox').map(R.prop('name'));
            data2.characterProfileStructure = data2.characterProfileStructure.map((el) => {
                if (el.type === 'checkbox') {
                    return {
                        doExport: el.doExport,
                        name: el.name,
                        playerAccess: el.playerAccess,
                        showInRoleGrid: el.showInRoleGrid,
                        type: 'enum',
                        value: [L10n.get('constant', 'yes'), L10n.get('constant', 'no')].join(','),
                    };
                }
                return el;
            });
            profilesData = data2;
            data2.profileData.forEach((el) => {
                checkboxes.forEach((name) => {
                    el.character[name] = L10n.get('constant', el.character[name] === true ? 'yes' : 'no');
                });
            });

            const sorter = CommonUtils.charOrdAFactory(a => a.toLowerCase());
            const filter = el => el.type === 'enum';
            const groupingItems = profilesData.characterProfileStructure.filter(filter).map(R.prop('name')).sort(sorter);

            addEls(clearEl(queryEl(`${root}.button-container`)), groupingItems.map((item, i) => {
                const button = addEl(makeEl('a'), makeText(item));
                button.item = item;
                setAttr(button, 'draggable', 'true');
                setAttr(button, 'role', 'button');
                setAttr(button, 'href', '#');
                setAttr(button, 'order', i + 1);
                setStyle(button, 'order', i + 1);
                addClasses(button, ['btn', 'btn-default']);
                listen(button, 'dragstart', onDragStart);
                listen(button, 'drop', onDrop);
                listen(button, 'dragover', allowDrop);
                listen(button, 'dragenter', handleDragEnter);
                listen(button, 'dragleave', handleDragLeave);
                listen(button, 'click', () => {
                    toggleClass(button, 'btn-primary');
                    drawList();
                });
                buttons.push(button);
                return button;
            }));

            drawList();
            //            drawPlainPanelList();
        });
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDragStart = function (event){
        console.log(`onDragStart ${this.item}`);
        event.dataTransfer.setData('data', JSON.stringify({ item: this.item, order: getAttr(this, 'order') }));
        event.dataTransfer.effectAllowed = 'move';
    };

    // eslint-disable-next-line no-var,vars-on-top
    var onDrop = function (event) {
        console.log(`onDrop ${this.item}${event.dataTransfer.getData('data')}`);
        if (event.stopPropagation) {
            event.stopPropagation(); // stops the browser from redirecting.
        }
        updateButtons(JSON.parse(event.dataTransfer.getData('data')), { item: this.item, order: getAttr(this, 'order') });
    };

    // eslint-disable-next-line no-var,vars-on-top
    var allowDrop = function (event) {
        console.log(`allowDrop ${this.item}`);
        event.preventDefault();
    };

    function handleDragEnter(event) {
        addClass(this, 'over');
    }

    function handleDragLeave(event) {
        removeClass(this, 'over');
    }

    // eslint-disable-next-line no-var,vars-on-top
    var updateButtons = (dragStarter, dragReceiver) => {
        const startOrder = Number(dragStarter.order) - 1;
        const receiveOrder = Number(dragReceiver.order) - 1;
        const button = buttons.splice(startOrder, 1)[0];
        buttons = R.insert(receiveOrder, button, buttons);
        buttons.forEach((button2, i) => {
            setAttr(button2, 'order', i + 1);
            setStyle(button2, 'order', i + 1);
        });
        drawList();
    };

    // eslint-disable-next-line no-var,vars-on-top
    var drawList = () => {
        groupingOrder = buttons.filter(hasClass(R.__, 'btn-primary')).map(R.prop('item'));
        drawGroupedList((groupingOrder.length > 0) ? getTreeByUserSelect() : getTreeByAlphabet());
        //        (groupingOrder.length > 0) ? drawGroupedList() : drawPlainPanelList();
    };

    // eslint-disable-next-line no-var,vars-on-top
    var getTreeByAlphabet = () =>
        //        var groups = R.groupBy((profile) => {
        //            return profile.characterName[0];
        //        }, profilesData.profileData);
        //
        //        var structures = R.toPairs(groups).map(pair => ({
        //            key: pair[0],
        //            lastKeyPart: pair[0],
        //            groups: pair[1]
        //        }));
        //
        //        structures.sort(CommonUtils.charOrdAFactory(R.prop('key')));
        //        return structures;
        [{
            key: l10n('all-characters'),
            lastKeyPart: l10n('all-characters'),
            groups: profilesData.profileData
        }];

    // eslint-disable-next-line no-var,vars-on-top
    var getTreeByUserSelect = () => {
        const groups = R.groupBy(profile => groupingOrder.map(name => profile.character[name]).join('/'), profilesData.profileData);

        const groupingItemInfo = R.indexBy(R.prop('name'), profilesData.characterProfileStructure.filter(el => R.contains(el.name, groupingOrder)));

        return [{
            key: l10n('all-characters'),
            lastKeyPart: l10n('all-characters'),
            children: makeGroupTree(groups, groupingItemInfo, 0, [])
        }];
    };

    //            var filter = el => el.type === 'enum' || el.type === 'checkbox';

    // eslint-disable-next-line no-var,vars-on-top
    var drawGroupedList = (structures) => {
        //        structures = [{
        //            "key": l10n('all-characters'),
        //            "lastKeyPart": l10n('all-characters'),
        //            "children": structures
        //        }];
        //        console.log(JSON.stringify(structures));

        structures.forEach(calcSize);

        // addEl(queryEl(root + '.group-content'), addEls(addClasses(makeEl('ul'), ['remove-ul-dots', 'zero-padding']),
        // makeGroupTree(groups, groupingItemInfo, 0, [])));
        addEl(clearEl(queryEl(`${root}.group-content`)), addEls(addClasses(
            makeEl('ul'),
            ['remove-ul-dots', 'zero-padding']
        ), R.flatten(structures.map(renderGroupStructure))));
    };

    const makeHeader = (text, characterNum, playerNum) => {
        const characterBadge = addEl(addClass(makeEl('span'), 'badge'), makeText(`${characterNum} / ${playerNum}`));
        setAttr(characterBadge, 'title', L10n.format('role-grid', 'badge-title', [characterNum, playerNum]));
        //        const playerBadge = addEl(addClass(makeEl('span'), 'badge'), makeText(playerNum));

        const h3 = addEls(addClass(makeEl('h3'), 'panel-title'), [makeText(` ${text} `), characterBadge]);
        const a = setAttr(makeEl('a'), 'href', '#/');
        setAttr(a, 'tree-panel-toggler', '');
        const heading = addEl(addClass(makeEl('div'), 'panel-heading'), addEls(a, [h3]));
        return addEl(addClasses(makeEl('div'), ['panel', 'panel-default', 'inline-panel']), heading);
        // var heading = addEl(addClass(makeEl('div'), 'panel-heading'),
        //      addEl(addClass(makeEl('h3'), 'panel-title'), makeText(text)));
        // return addEl(addClasses(makeEl('div'), ['panel', 'panel-default']), heading);
    };

    // eslint-disable-next-line no-var,vars-on-top
    var calcSize = (el) => {
        if (el.children) {
            el.children.forEach(calcSize);
            el.characterNum = R.sum(el.children.map(R.prop('characterNum')));
            el.playerNum = R.sum(el.children.map(R.prop('playerNum')));
        } else { // groups
            el.characterNum = el.groups.length;
            el.playerNum = el.groups.filter(R.pipe(R.prop('playerName'), R.isNil, R.not)).length;
        }
    };

    // eslint-disable-next-line no-var,vars-on-top
    var renderGroupStructure = (el) => {
        //        return R.flatten(structure.map(el => {
        let domChildren, header;
        if (el.children) {
            domChildren = addEls(addClass(makeEl('ul'), 'remove-ul-dots'), R.flatten(el.children.map(renderGroupStructure)));
            header = makeHeader(el.lastKeyPart, el.characterNum, el.playerNum);
            UI.attachPanelToggler(queryElEl(header, 'a'), domChildren);
            return R.concat([addEl(makeEl('li'), header)], [domChildren]);
        } // groups
        //            var panelList = makePanelList(el.groups).map(addClasses(R.__,['inline-panel']));
        const panelList = makePanelList(el.groups).map(addClasses(R.__, ['inline-panel', 'col-xs-6']));
        //            var panelList = makePanelList(el.groups).map(addClasses(R.__,['inline-panel', 'col-xs-4']));
        const row = addClass(makeEl('div'), 'row');
        const container = addEl(addClass(makeEl('div'), 'list-content-padding container-fluid'), row);
        domChildren = addEls(row, panelList);
        header = makeHeader(el.key, el.characterNum, el.playerNum);
        UI.attachPanelToggler(queryElEl(header, 'a'), container);
        return R.concat([addEl(makeEl('li'), header)], [container]);
        // var container = addClass(makeEl('div'), 'list-content-padding container-fluid');
        // domChildren = addEls(container, panelList);
        // return R.concat([addEl(makeEl('li'), makeHeader(el.key, el.characterNum, el.playerNum))], [domChildren]);


        //        }));
    };

    // eslint-disable-next-line no-var,vars-on-top
    var makeGroupTree = (groups, groupingItemInfo, index, key) => {
        const arr = groupingItemInfo[groupingOrder[index]].value.split(',').map((name) => {
            const nextKey = R.concat(key, [name]);
            //            var nextKey = R.concat(key, [groupingOrder[index] + ': ' + name]);
            const lastKeyPart = `${groupingOrder[index]}: ${name}`;
            //            var domChildren;
            if (groupingOrder.length !== index + 1) {
                const children = makeGroupTree(groups, groupingItemInfo, index + 1, nextKey);
                if (children === null) {
                    return null;
                }
                //                domChildren = [addEls(addClass(makeEl('ul'), 'remove-ul-dots'), children)];
                return {
                    key: nextKey.join(' / '),
                    lastKeyPart,
                    children
                };
            }
            const fullKey = nextKey.join('/');
            if (groups[fullKey] === undefined) {
                return null;
            }
            // domChildren = [addEls(addClass(makeEl('div'), 'list-content-padding'), makePanelList(groups[fullKey]))];
            return {
                key: nextKey.join(' / '),
                lastKeyPart,
                groups: groups[fullKey]
            };

            //            return R.concat([addEl(makeEl('li'), makeHeader(name))], domChildren);
            //            return R.concat([addEl(makeEl('li'), makeHeader(nextKey.join(' / ')))], domChildren);
            //            return {
            //                name: nextKey.join(' / '),
            //                children:
            //            }
        }).filter(el => el !== null);
        return arr.length === 0 ? null : arr;
        //        if(arr.length === 0){
        //            return null;
        //        } else {
        //            return R.flatten(arr);
        //        }
    };

    const drawPlainPanelList = () => {
        addEls(clearEl(queryEl(`${root}.group-content`)), makePanelList(profilesData.profileData));
    };

    // eslint-disable-next-line no-var,vars-on-top
    var makePanelList = profileArray =>
        profileArray.sort(CommonUtils.charOrdAFactory(a => a.characterName.toLowerCase())).map((profileData) => {
            const tables = [UI.makeProfileTable(profilesData.characterProfileStructure, profileData.character)];
            let title = profileData.characterName;
            if (profileData.playerName !== undefined) {
                tables.push(UI.makeProfileTable(profilesData.playerProfileStructure, profileData.player));
                title += `/${profileData.playerName}`;
            }

            const panelInfo = UI.makePanelCore(makeText(title), addEls(makeEl('div'), tables));
            UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv, (event, togglePanel) => {
                queryEls(`${root}.group-content .expanded[panel-toggler]`).filter(el =>
                    !el.contains(event.target)).forEach(el => el.click());
                togglePanel();
            });
            panelInfo.a.click();

            return panelInfo.panel;
        });
})(this.RoleGrid = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.enter-tab ';

    exports.init = () => {
        $(document.forms['login-form']).on('submit', submit);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {

    };

    function submit() {
        const form = $(this);

        $('.error', form).html('');
        //        $(":submit", form).button("loading");

        const request = $.ajax({
            url: '/login',
            method: 'POST',
            data: form.serialize(),
            complete() {
                $(':submit', form).button('reset');
            },
            //             statusCode : {
            //                 200 : function() {
            //                 },
            //                 403 : function(jqXHR) {
            //                     var error = JSON.parse(jqXHR.responseText);
            //                     $('.error', form).html(error.message);
            //                 }
            //             }
        });
        request.done((data) => {
            //             //window.location.href = "/chat";
            //             window.location.href = "/nims.html";
            window.location.href = '/page.html';
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            let msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch (err) {
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
            //             var error = JSON.parse(jqXHR.responseText);
            //             $('.error', form).html(error.message);
            //            $('.error', form).html(textStatus);
            $('.error', form).html(msg);
        });

        return false;
    }
})(this.Enter = {});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.player-tab ';
    const characterProfileDiv = `${root}.character-profile-div`;
    const playerProfileDiv = `${root}.player-profile-div`;
    const playerHeader = `${root}.player-profile-header`;
    const characterHeader = `${root}.character-profile-header`;

    let profileEditorCore;

    exports.init = () => {
        profileEditorCore = ProfileEditorCore.makeProfileEditorCore();
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getWelcomeText((err, text) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getPlayerProfileInfo((err2, profileInfo) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getPlayersOptions((err3, playersOptions) => {
                    if (err3) { Utils.handleError(err3); return; }
                    buildInterface(text, profileInfo, playersOptions);
                });
            });
        });
    };

    function isEditable(profileName, profileStructure) {
        return R.find(R.propEq('name', profileName), profileStructure).playerAccess === 'write';
    }

    function buildInterface(text, profileInfo, playersOptions) {
        profileEditorCore.initProfileStructure(playerProfileDiv, 'player', profileInfo.player.profileStructure);
        profileEditorCore.fillProfileInformation(playerProfileDiv, 'player', profileInfo.player.profile, isEditable);
        addEl(clearEl(queryEl(playerHeader)), makeText(strFormat(getL10n('briefings-player-profile'), [profileInfo.player.profile.name])));

        if (profileInfo.character === undefined) {
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [''])));
            const el = clearEl(queryEl(characterProfileDiv));
            if (playersOptions.allowCharacterCreation) {
                const label = addEl(makeEl('div'), makeText(getL10n('profiles-player-has-no-character-and-can-create-it')));
                addClass(label, 'margin-bottom-8');
                const input = setAttr(makeEl('input'), 'placeholder', getL10n('profiles-character-name'));
                addClass(input, 'form-control margin-bottom-8');
                const button = addEl(makeEl('button'), makeText(getL10n('common-create')));
                addClass(button, 'btn btn-default');
                listen(button, 'click', () => {
                    DBMS.createCharacterByPlayer(input.value.trim(), Utils.processError(exports.refresh));
                });
                addEls(el, [label, input, button]);
            } else {
                addEl(el, addEl(makeEl('span'), makeText(getL10n('profiles-player-has-no-character-and-cant-create-it'))));
            }
        } else {
            profileEditorCore.initProfileStructure(characterProfileDiv, 'character', profileInfo.character.profileStructure);
            profileEditorCore.fillProfileInformation(characterProfileDiv, 'character', profileInfo.character.profile, isEditable);
            addEl(clearEl(queryEl(characterHeader)), makeText(strFormat(getL10n('briefings-character-profile'), [profileInfo.character.profile.name])));
        }

        queryEl(`${root}.welcome-text-area`).value = text;
    }
})(this.Player = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */


'use strict';

((exports) => {
    const root = '.sign-up-tab ';

    exports.init = () => {
        $(document.forms['sign-up-form']).on('submit', submit);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
    };

    function submit() {
        const form = $(this);

        $('.error', form).html('');
        $(':submit', form).button('loading');

        const request = $.ajax({
            url: '/signUp',
            method: 'POST',
            data: form.serialize(),
            complete() {
                $(':submit', form).button('reset');
            },
        });
        request.done((data) => {
            form.html(getL10n('entrance-sign-up-success')).addClass('alert-success');
        });

        request.fail((errorInfo, textStatus, errorThrown) => {
            let msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch (err) {
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
            $('.error', form).html(msg);
        });

        return false;
    }
})(this.SignUp = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.sliders-tab ';
    const state = {};
    state.sliders = [];
    
    exports.init = () => {
        const createSliderDialog = UI.createModalDialog(root, createSlider, {
            bodySelector: 'create-slider-body',
            dialogTitle: 'sliders-create-slider',
            actionButtonTitle: 'common-create',
        });
        
        state.editSliderDialog = UI.createModalDialog(root, editSlider, {
            bodySelector: 'create-slider-body',
            dialogTitle: 'sliders-edit-slider',
            actionButtonTitle: 'common-save',
        });
        
        state.moveSliderDialog = UI.createModalDialog(root, moveSlider, {
            bodySelector: 'move-slider-body',
            dialogTitle: 'sliders-move-slider',
            actionButtonTitle: 'common-move',
        });
        
        listen(qe(`${root} .create`), 'click', () => createSliderDialog.showDlg());
        
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getSliderDataPm().then(createSliders).catch(Utils.handleError);
    };
    
    function createSliders(model) {
        const positions = model.map( info => {return {name: strFormat(L10n.get('common', 'set-item-before'), [info.name])}});
        positions.push({name: L10n.get('common', 'set-item-as-last')});
        fillSelector(clearEl(qe(`${root} .move-slider-pos-select`)), positions);
        
        addEls(clearEl(queryEl('.mixer-panel .panel-body')), model.map( makeSliderBackbone )) ;
        
        clearEls(state.sliders);
        
        state.sliders = model.map( (sl, i) => {
            const slider = new Slider('.mixer-panel .panel-body input[pos="' + i + '"]', {
                max: 10,
                min: -10,
                orientation: 'vertical',
                reversed: true,
                tooltip: 'always',
                value: sl.value,
                formatter: function(value) {
                    return Math.abs(value);
                },
            });
            slider.on('change', (event) => {
                DBMS.updateSliderValuePm(i, event.newValue).catch(Utils.handleError);
            });
            return slider;
        });
    }
    
    var makeSliderBackbone = (sl, i) => {
        const el = qmte(`${root} .slider-container-tmpl`);
        setAttr(qee(el, 'input'), 'pos', i);
        addEl(qee(el, '.slider-name'), makeText(sl.name));
        addEl(qee(el, '.slider-top'), makeText(sl.top));
        addEl(qee(el, '.slider-bottom'), makeText(sl.bottom));
        
        listen(qee(el, 'button.move'), 'click', () => {
            state.moveSliderDialog.currentIndex = i;
            state.moveSliderDialog.showDlg();
        });
        listen(qee(el, 'button.rename'), 'click', () => {
            qee(state.editSliderDialog, '.slider-name').value = sl.name;
            qee(state.editSliderDialog, '.slider-top').value = sl.top;
            qee(state.editSliderDialog, '.slider-bottom').value = sl.bottom;
            state.editSliderDialog.pos = i;
            state.editSliderDialog.showDlg();
        });
        listen(qee(el, 'button.remove'), 'click', () => {
            Utils.confirm(L10n.format('sliders', 'are-you-sure-about-removing-slider', [sl.name]), () => {
                DBMS.removeSlider(i, Utils.processError(exports.refresh));
            })
        });
        L10n.localizeStatic(el);
        return el;
    };
    
    function createSlider(dialog) {
        return () => {
            const name = qee(dialog, '.slider-name').value.trim();
            const top = qee(dialog, '.slider-top').value.trim();
            const bottom = qee(dialog, '.slider-bottom').value.trim();
            DBMS.createSlider(name, top, bottom, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    qee(dialog, '.slider-name').value = '';
                    qee(dialog, '.slider-top').value = '';
                    qee(dialog, '.slider-bottom').value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }
    
    function editSlider(dialog) {
        return () => {
            const name = qee(dialog, '.slider-name').value.trim();
            const top = qee(dialog, '.slider-top').value.trim();
            const bottom = qee(dialog, '.slider-bottom').value.trim();
            const pos = dialog.pos;
            DBMS.updateSliderNaming(pos, name, top, bottom, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    qee(dialog, '.slider-name').value = '';
                    qee(dialog, '.slider-top').value = '';
                    qee(dialog, '.slider-bottom').value = '';
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        }
    }
    
    function moveSlider(dialog) {
        return () => {
            var index = dialog.currentIndex;
            var pos = qee(dialog, '.move-slider-pos-select').selectedIndex;
            
            DBMS.moveSlider(index, pos, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            })
        }
    }
})(this.Sliders = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, Stories
 */

'use strict';

((exports) => {
    const state = {};
    exports.name = 'EventPresence';
    const root = '#eventPresenceDiv ';

    exports.init = () => {
        listen(getEl('eventPresenceSelector'), 'change', UI.showSelectedEls3(root, 'dependent', 'dependent-index'));
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        const tableHead = getEl('eventPresenceTableHead');
        const table = getEl('eventPresenceTable');
        const characterSelector = getEl('eventPresenceSelector');

        if (Stories.getCurrentStoryName() === undefined) {
            clearEl(tableHead);
            clearEl(table);
            clearEl(characterSelector);
            return;
        }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('character', false, (err2, allCharacters) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryCharacterNamesArray(Stories.getCurrentStoryName(), (err3, characterArray) => {
                    if (err3) { Utils.handleError(err3); return; }
                    const map = {};
                    allCharacters.forEach((elem) => {
                        map[elem.value] = elem;
                    });
                    const dataArray = characterArray.map(elem => map[elem]);

                    dataArray.sort(Utils.charOrdAObject);

                    const displayArray = dataArray.map(elem => elem.displayName);
                    characterArray = dataArray.map(elem => elem.value);

                    DBMS.getStoryEvents(Stories.getCurrentStoryName(), (err4, events) => {
                        if (err4) { Utils.handleError(err4); return; }

                        clearEl(tableHead);
                        clearEl(table);
                        
                        showEl(queryEl(`${root} .alert.no-characters`), characterArray.length === 0);
                        showEl(queryEl(`${root} .alert.no-events`), events.length === 0);
                        showEl(queryEl(`${root} .panel-body`), events.length !== 0 && characterArray.length !== 0);
                        
                        UI.fillShowItemSelector(
                            clearEl(characterSelector),
                            displayArray.map(name => ({ name, hidden: false }))
                        );

                        appendTableHeader(tableHead, displayArray);
                        events.forEach((event, i) => {
                            appendTableInput(table, event, i, characterArray);
                            Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                        });
                    });
                });
            });
        });
    };

    function appendTableHeader(table, characterArray) {
        const eventName = addEl(makeEl('th'), makeText(getL10n('stories-event')));
        const els = characterArray.map((characterName, i) => {
            const th = addEl(makeEl('th'), makeText(characterName));
            addClass(th, `dependent`);
            setAttr(th, 'dependent-index', i);
            return th;
        });
        addEl(table, addEls(makeEl('tr'), R.concat([eventName], els)));
    }

    function appendTableInput(table, event, i, characterArray) {
        const tr = makeEl('tr');
        let td = makeEl('td');
        td.appendChild(makeText(event.name));
        tr.appendChild(td);

        addEls(tr, characterArray.map((character, j) => {
            const td = qmte(`${root} .event-presence-cell`);
            addClass(td, `dependent`);
            setAttr(td, 'dependent-index', j);
            const input = qee(td, 'input');
            const label = qee(td, 'label');
            if (event.characters[character]) {
                input.checked = true;
            }
            input.eventIndex = i;
            input.eventName = event.name;
            input.characterName = character;
            input.hasText = event.characters[character] !== undefined && event.characters[character].text !== '';
            input.addEventListener('change', onChangeCharacterCheckbox);
            
            const span = qee(td, 'span');
            if(event.characters[character] !== undefined){
                if(event.characters[character].ready){
                    addClass(span, 'finished');
                    setAttr(span, 'title', L10n.get('adaptations', 'adaptation-finished'));
                } else if(input.hasText) {
                    addClass(span, 'in-progress');
                    setAttr(span, 'title', L10n.get('adaptations', 'adaptation-in-progress'));
                }
            }
            
            const id = i + character;
            setAttr(input, 'id', id);
            setAttr(label, 'for', id);
            return td;
        }));

        table.appendChild(tr);
    }

    function onChangeCharacterCheckbox(event) {
        if (event.target.checked) {
            DBMS.addCharacterToEvent(
                Stories.getCurrentStoryName(),
                event.target.eventIndex, event.target.characterName, Utils.processError()
            );
        } else if (!event.target.hasText) {
            DBMS.removeCharacterFromEvent(
                Stories.getCurrentStoryName(),
                event.target.eventIndex, event.target.characterName, Utils.processError()
            );
        } else {
            Utils.confirm(strFormat(
                getL10n('stories-remove-character-from-event-warning'),
                [event.target.characterName, event.target.eventName]
            ), () => {
                DBMS.removeCharacterFromEvent(
                    Stories.getCurrentStoryName(),
                    event.target.eventIndex, event.target.characterName, Utils.processError()
                );
            }, () => {
                event.target.checked = true;
            });
        }
    }
})(this.EventPresence = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS, StoryEvents, StoryCharacters, EventPresence
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.stories-tab ';

    exports.init = () => {
        const createStoryDialog = UI.createModalDialog(root, createStory, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'stories-enter-story-name',
            actionButtonTitle: 'common-create',
        });

        const renameStoryDialog = UI.createModalDialog(root, renameStory, {
            bodySelector: 'modal-prompt-body',
            dialogTitle: 'stories-enter-new-story-name',
            actionButtonTitle: 'common-rename',
        });

        state.left = { views: {} };
        state.right = { views: {} };
        let containers = {
            root: state.left,
            navigation: queryEl('.stories-navigation-container .left-side'),
            content: queryEl('.stories-content-container .left-side')
        };
        Utils.addView(containers, 'writer-story', WriterStory, { mainPage: true, toggle: true });
        Utils.addView(containers, 'story-events', StoryEvents, { toggle: true });
        Utils.addView(containers, 'story-characters', StoryCharacters, { toggle: true });
        Utils.addView(containers, 'event-presence', EventPresence, { toggle: true });
        containers = {
            root: state.right,
            navigation: queryEl('.stories-navigation-container .right-side'),
            content: queryEl('.stories-content-container .right-side')
        };
        Utils.addView(containers, 'writer-story', WriterStory, { toggle: true });
        Utils.addView(containers, 'story-events', StoryEvents, { mainPage: true, toggle: true });
        Utils.addView(containers, 'story-characters', StoryCharacters, { toggle: true });
        Utils.addView(containers, 'event-presence', EventPresence, { toggle: true });

        listen(queryEl(`${root}.remove.story`), 'click', removeStory);

        listen(qe(`${root}.create.story`), 'click', () => createStoryDialog.showDlg());
        listen(qe(`${root}.rename.story`), 'click', () => {
            qee(renameStoryDialog, '.entity-input').value = queryEl(`${root}#storySelector`).value.trim();
            renameStoryDialog.showDlg();
        });

        listen(qe(`${root}.create.event`), 'click', () => StoryEvents.createEventDialog.showDlg());
        listen(qe(`${root}.add.character`), 'click', () => StoryCharacters.addCharacterDialog.showDlg());

        $('#storySelector').select2().on('change', onStorySelectorChangeDelegate);

        exports.content = queryEl(root);
    };

    exports.chainRefresh = () => {
        if ((state.left.currentView && state.left.currentView.name === 'EventPresence') ||
            (state.right.currentView && state.right.currentView.name === 'EventPresence')) {
            EventPresence.refresh();
        }
    };

    exports.refresh = () => {
        const storySelector = clearEl(getEl('storySelector'));

        PermissionInformer.getEntityNamesArray('story', false, (err, allStoryNames) => {
            if (err) { Utils.handleError(err); return; }
            const data = getSelect2Data(allStoryNames);
            
            Utils.enableEl(qe(`${root}.rename.story`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.remove.story`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.create.event`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}.add.character`), allStoryNames.length > 0);
            Utils.enableEl(qe(`${root}#storySelector`), allStoryNames.length > 0);
            
            showEl(qe(`${root}.alert`), allStoryNames.length === 0);
            showEl(qe(`${root}.stories-main-container`), allStoryNames.length !== 0);
            
            if (allStoryNames.length > 0) {
                const storyName = getSelectedStoryName(allStoryNames);
                $('#storySelector').select2(data).val(storyName).trigger('change');
                onStorySelectorChange(storyName);
            } else {
                $('#storySelector').select2(data);
                onStorySelectorChange();
            }

            R.values(state.left.views).forEach(view => view.refresh());
            if (state.left.currentView)state.left.currentView.refresh();
            if (state.right.currentView)state.right.currentView.refresh();
        });
    };

    function getSelectedStoryName(storyNames) {
        const settings = DBMS.getSettings();
        if (!settings.Stories) {
            settings.Stories = {
                storyName: storyNames[0].value
            };
        }
        let { storyName } = settings.Stories;
        if (storyNames.map(nameInfo => nameInfo.value).indexOf(storyName) === -1) {
            settings.Stories.storyName = storyNames[0].value;
            storyName = storyNames[0].value;
        }
        return storyName;
    }

    function createStory(dialog) {
        return () => {
            const input = qee(dialog, '.entity-input');
            const storyName = input.value.trim();

            DBMS.createStory(storyName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    updateSettings(storyName);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        input.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function renameStory(dialog) {
        return () => {
            const toInput = qee(dialog, '.entity-input');
            const fromName = queryEl(`${root}#storySelector`).value.trim();
            const toName = toInput.value.trim();

            DBMS.renameStory(fromName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    updateSettings(toName);
                    PermissionInformer.refresh((err2) => {
                        if (err2) { Utils.handleError(err2); return; }
                        toInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    });
                }
            });
        };
    }

    function removeStory() {
        const name = queryEl(`${root}#storySelector`).value.trim();

        Utils.confirm(strFormat(getL10n('stories-are-you-sure-about-story-removing'), [name]), () => {
            DBMS.removeStory(name, (err) => {
                if (err) { Utils.handleError(err); return; }
                PermissionInformer.refresh((err2) => {
                    if (err2) { Utils.handleError(err2); return; }
                    exports.refresh();
                });
            });
        });
    }

    function onStorySelectorChangeDelegate(event) {
        const storyName = event.target.value;
        onStorySelectorChange(storyName);
    }

    function onStorySelectorChange(storyName) {
        state.CurrentStoryName = storyName;

        if (storyName) {
            updateSettings(storyName);
            PermissionInformer.isEntityEditable('story', storyName, (err, isStoryEditable) => {
                if (err) { Utils.handleError(err); return; }
                if (state.left.currentView)state.left.currentView.refresh();
                if (state.right.currentView)state.right.currentView.refresh();
                Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
            });
        } else { // when there are no stories at all
            updateSettings(null);
            if (state.left.currentView)state.left.currentView.refresh();
            if (state.right.currentView)state.right.currentView.refresh();
        }
    }

    exports.getCurrentStoryName = () => state.CurrentStoryName;

    function updateSettings(storyName) {
        const settings = DBMS.getSettings();
        settings.Stories.storyName = storyName;
    }
})(this.Stories = {});

/*Copyright 2015-2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.story-characters-tab ';
    const superRoot = '.stories-tab ';
    let initialized = false;

    exports.init = () => {
        if (initialized) return;
        exports.addCharacterDialog = UI.createModalDialog(superRoot, addCharacter, {
            bodySelector: 'modal-add-character-body',
            dialogTitle: 'stories-add-character-title',
            actionButtonTitle: 'common-add',
        });

        //        listen(qe(`${root}.add.character`), 'click', () => addCharacterDialog.showDlg());

        state.switchCharacterDialog = UI.createModalDialog(root, switchCharacters, {
            bodySelector: 'modal-switch-event-body',
            dialogTitle: 'stories-switch-character-title',
            actionButtonTitle: 'common-replace',
        });
        state.ExternalCharacterSelectors = [queryEl(`${superRoot}.storyCharactersAddSelector`),
            queryEl(`${root}.storyCharactersToSelector`)];

        exports.content = queryEl(root);
        initialized = true;
    };

    exports.refresh = () => {
        state.ExternalCharacterSelectors.forEach(clearEl);

        clearEl(queryEl(`${root}.storyCharactersTable`));

        if (!Stories.getCurrentStoryName()) { return; }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            PermissionInformer.getEntityNamesArray('character', false, (err2, allCharacters) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryCharacters(Stories.getCurrentStoryName(), (err3, localCharacters) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(allCharacters, localCharacters);
                    Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                    Stories.chainRefresh();
                });
            });
        });
    };

    function rebuildInterface(allCharacters, localCharacters) {
        const addArray = [];
        const removeArray = [];

        allCharacters.filter(nameInfo => !localCharacters[nameInfo.value]).forEach((nameInfo) => {
            addArray.push(nameInfo);
        });

        allCharacters.filter(nameInfo => localCharacters[nameInfo.value]).forEach((nameInfo) => {
            removeArray.push(nameInfo);
        });

        addArray.sort(Utils.charOrdAObject);
        removeArray.sort(Utils.charOrdAObject);

        const addData = getSelect2Data(addArray);
        const removeData = getSelect2Data(removeArray);

        state.ExternalCharacterSelectors.forEach((selector) => {
            $(selector).select2(addData);
        });

        const table = clearEl(queryEl(`${root}.storyCharactersTable`));
        
        showEl(qe(`${root} table`), R.keys(localCharacters).length !== 0 );
        showEl(qe(`${root} .alert`), R.keys(localCharacters).length === 0 );
        
        removeArray.forEach((removeValue) => {
            addEl(table, getCharacterInput(removeValue, localCharacters[removeValue.value]));
        });
    }

    function addCharacter(dialog) {
        return () => {
            const characterName = queryEl(`${superRoot}.storyCharactersAddSelector`).value.trim();
            DBMS.addStoryCharacter(Stories.getCurrentStoryName(), characterName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function switchCharacters(dialog) {
        return () => {
            const toName = queryEl(`${root}.storyCharactersToSelector`).value.trim();
            DBMS.switchStoryCharacters(Stories.getCurrentStoryName(), dialog.characterName, toName, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function removeCharacter(characterName) {
        return () => {
            Utils.confirm(strFormat(getL10n('stories-remove-character-from-story-warning'), [characterName]), () => {
                DBMS.removeStoryCharacter(
                    Stories.getCurrentStoryName(),
                    characterName, Utils.processError(exports.refresh)
                );
            });
        };
    }

    function getCharacterInput(characterMeta, character) {
        const el = wrapEl('tr', qte(`${root} .story-character-row-tmpl`));
        L10n.localizeStatic(el);
        const qe = qee(el);

        addEl(qe('.character-name'), makeText(characterMeta.displayName));

        let input = qe('.inventoryInput');
        input.value = character.inventory;
        input.characterName = character.name;
        listen(input, 'change', updateCharacterInventory);

        Constants.characterActivityTypes.forEach((activityType) => {
            input = qe(`.${activityType} input`);
            if (character.activity[activityType]) {
                input.checked = true;
            }
            input.characterName = character.name;
            input.activityType = activityType;
            listen(input, 'change', onChangeCharacterActivity);
            setAttr(input, 'id', character.name + activityType);
            setAttr(qe(`.${activityType} label`), 'for', character.name + activityType);
        });

        listen(qe('.replace.character'), 'click', () => {
            state.switchCharacterDialog.characterName = character.name;
            state.switchCharacterDialog.showDlg();
        });
        listen(qe('.remove.character'), 'click', removeCharacter(character.name));
        return el;
    }

    function updateCharacterInventory(event) {
        DBMS.updateCharacterInventory(
            Stories.getCurrentStoryName(),
            event.target.characterName, event.target.value, Utils.processError()
        );
    }

    function onChangeCharacterActivity(event) {
        DBMS.onChangeCharacterActivity(
            Stories.getCurrentStoryName(), event.target.characterName,
            event.target.activityType, event.target.checked, Utils.processError()
        );
    }
})(this.StoryCharacters = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.story-events-tab ';
    let initialized = false;

    exports.init = () => {
        if (initialized) return;
        exports.createEventDialog = UI.createModalDialog('.stories-tab ', createEvent, {
            bodySelector: 'create-event-body',
            dialogTitle: 'stories-event-creation',
            actionButtonTitle: 'common-create',
        });

        //        listen(qe(`${root}.create.event`), 'click', () => createEventDialog.showDlg());

        state.moveEventDialog = UI.createModalDialog(root, moveEvent, {
            bodySelector: 'move-event-body',
            dialogTitle: 'stories-move-event',
            actionButtonTitle: 'common-move',
        });
        exports.content = qe(root);
        initialized = true;
    };

    exports.refresh = () => {
        clearInterface();
        if (Stories.getCurrentStoryName() === undefined) {
            return;
        }

        PermissionInformer.isEntityEditable('story', Stories.getCurrentStoryName(), (err, isStoryEditable) => {
            if (err) { Utils.handleError(err); return; }
            DBMS.getMetaInfo((err2, metaInfo) => {
                if (err2) { Utils.handleError(err2); return; }
                DBMS.getStoryEvents(Stories.getCurrentStoryName(), (err3, events) => {
                    if (err3) { Utils.handleError(err3); return; }
                    rebuildInterface(events, metaInfo);
                    Utils.enable(exports.content, 'isStoryEditable', isStoryEditable);
                    Stories.chainRefresh();
                });
            });
        });
    };

    function clearInterface() {
        clearEl(getEl('eventBlock'));
        const positionSelectors = nl2array(document.querySelectorAll('.eventPositionSelector'));
        R.ap([clearEl], positionSelectors);
        const selectorArr = nl2array(document.querySelectorAll('.eventEditSelector'));
        R.ap([clearEl], selectorArr);
    }

    function rebuildInterface(events, metaInfo) {
        // event part
        const table = clearEl(getEl('eventBlock'));
        
        showEl(table, events.length !== 0 );
        showEl(qe(`${root} .alert`), events.length === 0 );

        // refresh position selector
        const addOpt = R.curry((sel, text) => {
            addEl(sel, addEl(makeEl('option'), makeText(text)));
        });

        let option, addOptLoc;
        const positionSelectors = nl2array(document.querySelectorAll('.eventPositionSelector'));
        R.ap([clearEl], positionSelectors);
        positionSelectors.forEach((positionSelector) => {
            addOptLoc = addOpt(positionSelector);

            events.forEach((event) => {
                addOptLoc(strFormat(getL10n('common-set-item-before'), [event.name]));
            });

            addOptLoc(getL10n('common-set-item-as-last'));

            positionSelector.selectedIndex = events.length;
        });

        state.eventsLength = events.length;

        R.ap([addEl(table)], events.map((event, i, events2) =>
            appendEventInput(event, i, events2, metaInfo.date, metaInfo.preGameDate)));

        // refresh swap selector
        const selectorArr = nl2array(document.querySelectorAll('.eventEditSelector'));
        R.ap([clearEl], selectorArr);

        events.forEach((event, i) => {
            selectorArr.forEach((selector) => {
                option = makeEl('option');
                option.appendChild(makeText(event.name));
                option.eventIndex = i;
                selector.appendChild(option);
            });
        });
    }

    function createEvent(dialog) {
        return () => {
            const eventNameInput = qee(dialog, '.eventNameInput');
            const eventName = eventNameInput.value.trim();
            const positionSelector = qee(dialog, '.positionSelector');

            DBMS.createEvent(
                Stories.getCurrentStoryName(), eventName, positionSelector.selectedIndex,
                (err) => {
                    if (err) {
                        setError(dialog, err);
                    } else {
                        eventNameInput.value = '';
                        dialog.hideDlg();
                        exports.refresh();
                    }
                }
            );
        };
    }

    function appendEventInput(event, index, events, date, preGameDate) {
        const el = wrapEl('tr', qte(`${root} .event-tmpl`));
        L10n.localizeStatic(el);
        const qe = qee(el);
        addEl(qe('.event-number'), makeText(index + 1));
        const nameInput = qe('.event-name-input');
        nameInput.value = event.name;
        nameInput.eventIndex = index;
        listen(nameInput, 'change', updateEventName);

        const textInput = qe('.event-text');
        textInput.value = event.text;
        textInput.eventIndex = index;
        listen(textInput, 'change', updateEventText);

        UI.makeEventTimePicker2(qe('.event-time'), {
            eventTime: event.time,
            index,
            preGameDate,
            date,
            onChangeDateTimeCreator
        });

        listen(qee(el, '.move'), 'click', () => {
            state.moveEventDialog.index = index;
            state.moveEventDialog.showDlg();
        });

        listen(qee(el, '.clone'), 'click', cloneEvent(index));
        if (state.eventsLength === index + 1) {
            setAttr(qee(el, '.merge'), 'disabled', 'disabled');
        } else {
            listen(qee(el, '.merge'), 'click', mergeEvents(index, event.name, events[index + 1].name));
        }
        listen(qee(el, '.remove'), 'click', removeEvent(event.name, index));

        return el;
    }

    function moveEvent(dialog) {
        return () => {
            const newIndex = queryEl('.movePositionSelector').selectedIndex;

            Utils.processError(exports.refresh);
            DBMS.moveEvent(Stories.getCurrentStoryName(), dialog.index, newIndex, (err) => {
                if (err) {
                    setError(dialog, err);
                } else {
                    dialog.hideDlg();
                    exports.refresh();
                }
            });
        };
    }

    function cloneEvent(index) {
        return () => {
            DBMS.cloneEvent(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
        };
    }

    function mergeEvents(index, firstName, secondName) {
        return () => {
            if (state.eventsLength === index + 1) {
                Utils.alert(getL10n('stories-cant-merge-last-event'));
                return;
            }

            Utils.confirm(L10n.format('stories', 'confirm-event-merge', [firstName, secondName]), () => {
                DBMS.mergeEvents(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
            });
        };
    }

    function removeEvent(name, index) {
        return () => {
            Utils.confirm(strFormat(getL10n('stories-remove-event-warning'), [name]), () => {
                DBMS.removeEvent(Stories.getCurrentStoryName(), index, Utils.processError(exports.refresh));
            });
        };
    }

    function getEventHeader() {
        const tr = makeEl('tr');
        addEl(tr, addEl(makeEl('th'), makeText('')));
        addEl(tr, addEl(makeEl('th'), makeText(getL10n('stories-event'))));
        return tr;
    }

    function onChangeDateTimeCreator(myInput) {
        return (dp, input) => {
            DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), myInput.eventIndex, 'time', input.val(), Utils.processError());
            //            StoryEvents.lastDate = input.val();
            removeClass(myInput, 'defaultDate');
        };
    }

    function updateEventName(event) {
        const input = event.target;
        DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), input.eventIndex, 'name', input.value, Utils.processError(exports.refresh));
    }

    function updateEventText(event) {
        const input = event.target;
        DBMS.setEventOriginProperty(Stories.getCurrentStoryName(), input.eventIndex, 'text', input.value, Utils.processError());
    }
})(this.StoryEvents = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};

    exports.init = () => {
        listen(getEl('writerStoryArea'), 'change', updateWriterStory);
        exports.content = getEl('writerStoryDiv2');
    };

    exports.refresh = () => {
        const storyArea = getEl('writerStoryArea');
        const storyName = Stories.getCurrentStoryName();

        if (storyName) {
            DBMS.getWriterStory(storyName, (err, story) => {
                if (err) { Utils.handleError(err); return; }
                storyArea.value = story;
            });
        } else {
            storyArea.value = '';
        }
    };

    function updateWriterStory() {
        const storyArea = getEl('writerStoryArea');
        DBMS.setWriterStory(Stories.getCurrentStoryName(), storyArea.value, Utils.processError());
    }
})(this.WriterStory = {});

/*Copyright 2018 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, BriefingPreview, BriefingExport
 */

'use strict';

function RoutingTabTmpl(exports, opts) {
    const state = {};
    const tmplRoot = '.tab-routing-tmpl';

    exports.init = () => {
        const el = queryEl(tmplRoot).cloneNode(true);
        removeClass(el, 'tab-routing-tmpl');
        addEl(queryEl('.tab-container'), el);
        state.views = {};
        const containers = {
            root: state,
            navigation: qee(el, '.sub-tab-navigation'),
            content: qee(el, '.sub-tab-content')
        };
        const tabs = R.indexBy(R.prop('viewName'), opts.tabs.map(tab => ({
            viewName: tab.viewName,
            viewRes: Utils.addView(containers, tab.btnName, window[tab.viewName])
        })));

        Utils.setFirstTab(containers, tabs[opts.firstTab].viewRes);
        exports.content = el;
    };

    exports.refresh = () => {
        state.currentView.refresh();
    };
}

RoutingTabTmpl(this.Briefings = {}, {
    firstTab: 'BriefingPreview',
    tabs: [{
        btnName: 'briefing-preview',
        viewName: 'BriefingPreview'
    }, {
        btnName: 'briefing-export',
        viewName: 'BriefingExport'
    }]
});

RoutingTabTmpl(this.Characters = {}, {
    firstTab: 'CharacterEditor',
    tabs: [{
        btnName: 'filling-profile',
        viewName: 'CharacterEditor'
    }, {
        btnName: 'changing-profile-structure',
        viewName: 'CharacterConfigurer'
    }, {
        btnName: 'binding-characters-and-players',
        viewName: 'ProfileBinding2'
    }]
});

RoutingTabTmpl(this.Players = {}, {
    firstTab: 'PlayerEditor',
    tabs: [{
        btnName: 'filling-profile',
        viewName: 'PlayerEditor'
    }, {
        btnName: 'changing-profile-structure',
        viewName: 'PlayerConfigurer'
    }, {
        btnName: 'binding-characters-and-players',
        viewName: 'ProfileBinding2'
    }]
});

RoutingTabTmpl(this.LogViewer2 = {}, {
    firstTab: 'LogViewer',
    tabs: [{
        btnName: 'logViewer',
        viewName: 'LogViewer'
    }, {
        btnName: 'group-schema',
        viewName: 'GroupSchema'
    }, {
        btnName: 'investigation-board',
        viewName: 'InvestigationBoard'
    }, {
        btnName: 'about',
        viewName: 'About'
    }]
});

RoutingTabTmpl(this.AccessManager = {}, {
    firstTab: 'OrganizerManagement',
    tabs: [{
        btnName: 'organizerManagement',
        viewName: 'OrganizerManagement'
    }, {
        btnName: 'playerManagement',
        viewName: 'PlayerManagement'
    }]
});

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const root = '.text-search-tab ';

    exports.init = () => {
        listen(queryEl(`${root}.text-search-button`), 'click', findTexts);
        listenOnEnter(queryEl(`${root}.text-search-input`), findTexts);
        exports.content = queryEl(root);
    };

    exports.refresh = () => {
    };

    function findTexts() {
        const selectedTextTypes = queryElEls(queryEl(root), `${root}.textSearchTypeRadio`)
            .filter(el => el.checked).map(el => el.value);
        const searchStr = queryEl(`${root}.text-search-input`).value;
        const caseSensitive = getEl('caseSensitiveTextSearch').checked;
        DBMS.getTexts(searchStr, selectedTextTypes, caseSensitive, (err, texts) => {
            if (err) { Utils.handleError(err); return; }
            const text2panel = text =>
                makePanel(
                    makeText(`${getL10n(`text-search-${text.textType}`)} (${text.result.length})`),
                    makePanelContent(text, searchStr, caseSensitive)
                );
            addEls(clearEl(queryEl(`${root}.result-panel`)), texts.map(text2panel));
        });
    }

    function makePanelContent(textsInfo, searchStr, caseSensitive) {
        textsInfo.result.sort(CommonUtils.charOrdAFactory(R.prop('name')));
        return addEls(makeEl('div'), textsInfo.result.map((textInfo) => {
            const head = addEl(makeEl('div'), makeText(textInfo.name));
            const body = addClass(makeEl('div'), textInfo.type === 'text' ? 'text-body' : 'string-body');
            const regex = new RegExp(CommonUtils.escapeRegExp(searchStr), caseSensitive ? 'g' : 'gi');
            body.innerHTML = textInfo.text.replace(regex, '<span>$&</span>');
            return addEls(addClass(makeEl('div'), 'text-card'), [head, body]);
        }));
    }

    function makePanel(title, content) {
        const panelInfo = UI.makePanelCore(title, content);
        UI.attachPanelToggler(panelInfo.a, panelInfo.contentDiv);
        panelInfo.a.click();
        return panelInfo.panel;
    }
})(this.TextSearch = {});

/*Copyright 2015 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

/*global
 Utils, DBMS
 */

'use strict';

((exports) => {
    const state = {};
    const root = '.timeline-tab';

    exports.init = () => {
        listen(getEl('timelineStorySelector'), 'change', onStorySelectorChangeDelegate);

        state.TimelineDataset = new vis.DataSet();
        state.TagDataset = new vis.DataSet();

        queryEls(`${root} input[name=timelineFilter]`).map(listen(R.__, 'change', refreshTimeline));
        getEl('timelineFilterByStory').checked = true;

        // specify options
        const options = {
            orientation: 'top',
            showCurrentTime: false,
            //        editable : {
            //            updateTime : true
            //        },
            //        onMove : function (item, callback) {
            //            if (item.storyName) {
            //                DBMS.setEventTime(item.storyName, item.eventIndex, item.start, function(err){
            //                    if(err) {Utils.handleError(err); return;}
            //                    callback(item);
            //                });
            //            }
            //        },
            //        multiselect : true
        };

        const timeline = new vis.Timeline(getEl('timelineContainer'), null, options);
        timeline.setGroups(state.TagDataset);
        timeline.setItems(state.TimelineDataset);
        state.timelineComponent = timeline;

        exports.content = queryEl(root);
    };

    exports.refresh = () => {
        DBMS.getMetaInfo((err, metaInfo) => {
            if (err) { Utils.handleError(err); return; }

            state.postDate = metaInfo.date;
            state.preDate = metaInfo.preGameDate;

            const endDate = new Date(state.postDate);
            const startDate = new Date(state.preDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            startDate.setFullYear(startDate.getFullYear() - 1);

            state.timelineComponent.setOptions({
                end: endDate,
                start: startDate,
            });

            DBMS.getEventsTimeInfo((err1, eventsTimeInfo) => {
                if (err1) { Utils.handleError(err1); return; }
                state.eventsTimeInfo = eventsTimeInfo;
                state.eventsByStories = R.groupBy(R.prop('storyName'), eventsTimeInfo);
                state.eventsByCharacters = R.uniq(R.flatten(eventsTimeInfo.map(event => event.characters)));
                state.eventsByCharacters = R.zipObj(
                    state.eventsByCharacters,
                    R.ap([R.clone], R.repeat([], state.eventsByCharacters.length))
                );
                eventsTimeInfo.forEach(event => event.characters.forEach(character =>
                    state.eventsByCharacters[character].push(event)));

                PermissionInformer.getEntityNamesArray('story', false, (err2, allStoryNames) => {
                    if (err2) { Utils.handleError(err2); return; }
                    PermissionInformer.getEntityNamesArray('character', false, (err3, allCharacterNames) => {
                        if (err3) { Utils.handleError(err3); return; }
                        suffixy(allStoryNames, state.eventsByStories);
                        state.allStoryNames = allStoryNames;
                        suffixy(allCharacterNames, state.eventsByCharacters);
                        state.allCharacterNames = allCharacterNames;
                        refreshTimeline();
                    });
                });
            });
        });
    };

    function suffixy(entityNames, data) {
        entityNames.forEach((nameInfo) => {
            nameInfo.hasEvents = data[nameInfo.value] !== undefined;
        });
    }

    function refreshTimeline() {
        const selectorValues = getEl('timelineFilterByStory').checked ? state.allStoryNames : state.allCharacterNames;

        const selector = clearEl(getEl('timelineStorySelector'));
        fillSelector(selector, selectorValues.map(obj => ({
            name: obj.displayName,
            value: obj.value,
            className: obj.hasEvents ?
                'fa-icon finished transparent-icon select-icon-padding' :
                'fa-icon empty icon-padding select-icon-padding'
        })));
        setAttr(selector, 'size', selectorValues.length > 15 ? 15 : selectorValues.length);

        if (selectorValues.length !== 0) {
            selector.options[0].selected = true;
            onStorySelectorChange([selectorValues[0].value]);
        }
    }

    function onStorySelectorChangeDelegate(event) {
        onStorySelectorChange(nl2array(event.target.selectedOptions).map(opt => opt.value));
    }

    const prepareLabel = label => `<span class="timeline-label">${label}</span>`;

    function onStorySelectorChange(entityNames) {
        state.TagDataset.clear();
        state.TimelineDataset.clear();

        state.TagDataset.add(entityNames.map(entityName => R.always({ id: entityName, content: entityName })()));

        const byStory = getEl('timelineFilterByStory').checked;
        const data = byStory ? state.eventsByStories : state.eventsByCharacters;
        entityNames = R.intersection(entityNames, R.keys(data));
        const usedData = R.pick(entityNames, data);
        fillTimelines(usedData);
        const events = R.uniq(R.flatten(R.values(usedData))
                .map(event => {
                    event.time = new Date(event.time !== '' ? event.time : state.postDate);
                    event.characters.sort(CommonUtils.charOrdA);
                    return event;
                }));
        
        events.sort(CommonUtils.charOrdAFactory(R.prop('time')));
        
        addEls(clearEl(queryEl(`${root} .timeline-list`)), events.map(event => {
            const row = qmte(`${root} .timeline-event-tmpl`);
            addEl(qee(row, '.time'), makeText(event.time.format('yyyy/mm/dd h:MM')));
            addEl(qee(row, '.story-name'), makeText(event.storyName));
            addEl(qee(row, '.event-name'), makeText(event.name));
            addEl(qee(row, '.characters'), makeText(event.characters.join(', ')));
            return row;
        }));

        if (entityNames[0]) {
            state.TimelineDataset.add({
                content: prepareLabel(L10n.getValue('overview-pre-game-end-date')),
                start: new Date(state.postDate),
                group: entityNames[0],
                className: 'importantItem',
                editable: false
            });
            state.TimelineDataset.add({
                content: prepareLabel(L10n.getValue('overview-pre-game-start-date')),
                start: new Date(state.preDate),
                group: entityNames[0],
                className: 'importantItem',
                editable: false
            });
        }
    }
    
    function fillTimelines(usedData) {
        state.TimelineDataset.add(R.flatten(R.toPairs(usedData).map((pair) => {
            const entityName = pair[0];
            return pair[1].map(event => ({
                content: prepareLabel(event.name),
                start: event.time !== '' ? event.time : state.postDate,
                group: entityName
            }));
        })));
    }
})(this.Timeline = {});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL3RlbXBsYXRlLmpzIiwianMvcGFnZXMvYWNjZXNzTWFuYWdlci9vcmdhbml6ZXJNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvYWNjZXNzTWFuYWdlci9wbGF5ZXJNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvYWRhcHRhdGlvbnMvYWRhcHRhdGlvbnMuanMiLCJqcy9wYWdlcy9icmllZmluZ3MvYnJpZWZpbmdFeHBvcnQuanMiLCJqcy9wYWdlcy9icmllZmluZ3MvYnJpZWZpbmdQcmV2aWV3LmpzIiwianMvcGFnZXMvYnJpZWZpbmdzL3JlbGF0aW9ucy5qcyIsImpzL3BhZ2VzL2JyaWVmaW5ncy9yZWxhdGlvbnNQcmV2aWV3LmpzIiwianMvcGFnZXMvZ2VhcnMvZ2VhcnMuanMiLCJqcy9wYWdlcy9ncm91cHMvQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLmpzIiwianMvcGFnZXMvZ3JvdXBzL0ZpbHRlckNvbmZpZ3VyYXRpb24uanMiLCJqcy9wYWdlcy9ncm91cHMvZ3JvdXBQcm9maWxlLmpzIiwianMvcGFnZXMvZ3JvdXBzL2dyb3VwU2NoZW1hLmpzIiwianMvcGFnZXMvZ3JvdXBzL2ludmVzdGlnYXRpb25Cb2FyZC5qcyIsImpzL3BhZ2VzL2dyb3Vwcy9wcm9maWxlRmlsdGVyLmpzIiwianMvcGFnZXMvbG9ncy9hYm91dC5qcyIsImpzL3BhZ2VzL2xvZ3MvbG9nVmlld2VyLmpzIiwianMvcGFnZXMvbmV0d29yay9uZXR3b3JrU3Vic2V0c1NlbGVjdG9yLmpzIiwianMvcGFnZXMvbmV0d29yay9zb2NpYWxOZXR3b3JrLmpzIiwianMvcGFnZXMvbmV0d29yay90aW1lbGluZWROZXR3b3JrLmpzIiwianMvcGFnZXMvb3ZlcnZpZXcvb3ZlcnZpZXcuanMiLCJqcy9wYWdlcy9wcm9maWxlcy9wcm9maWxlQmluZGluZy5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzL3Byb2ZpbGVDb25maWd1cmVyLmpzIiwianMvcGFnZXMvcHJvZmlsZXMvcHJvZmlsZUVkaXRvci5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzL3Byb2ZpbGVFZGl0b3JDb3JlLmpzIiwianMvcGFnZXMvcHJvZmlsZXMvcHJvZmlsZXMuanMiLCJqcy9wYWdlcy9wcm9maWxlczIvY2hhcmFjdGVyUmVwb3J0cy5qcyIsImpzL3BhZ2VzL3Byb2ZpbGVzMi9wcm9maWxlQmluZGluZzIuanMiLCJqcy9wYWdlcy9wcm9maWxlczIvcHJvZmlsZUNvbmZpZ3VyZXIyLmpzIiwianMvcGFnZXMvcHJvZmlsZXMyL3Byb2ZpbGVFZGl0b3IyLmpzIiwianMvcGFnZXMvcHJvZmlsZXMyL3JvbGVHcmlkLmpzIiwianMvcGFnZXMvc2VydmVyU3BlY2lmaWMvZW50ZXIuanMiLCJqcy9wYWdlcy9zZXJ2ZXJTcGVjaWZpYy9wbGF5ZXIuanMiLCJqcy9wYWdlcy9zZXJ2ZXJTcGVjaWZpYy9zaWduLXVwLmpzIiwianMvcGFnZXMvc2xpZGVycy9zbGlkZXJzLmpzIiwianMvcGFnZXMvc3Rvcmllcy9ldmVudFByZXNlbmNlLmpzIiwianMvcGFnZXMvc3Rvcmllcy9zdG9yaWVzLmpzIiwianMvcGFnZXMvc3Rvcmllcy9zdG9yeUNoYXJhY3RlcnMuanMiLCJqcy9wYWdlcy9zdG9yaWVzL3N0b3J5RXZlbnRzLmpzIiwianMvcGFnZXMvc3Rvcmllcy93cml0ZXJTdG9yeS5qcyIsImpzL3BhZ2VzL3RhYlJvdXRpbmcvdGFiUm91dGluZy5qcyIsImpzL3BhZ2VzL3RleHRTZWFyY2gvdGV4dFNlYXJjaC5qcyIsImpzL3BhZ2VzL3RpbWVsaW5lL3RpbWVsaW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbGFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMxTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDamNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqWUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyY0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsT0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdiQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbFZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDampCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdGhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5U0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25VQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0lBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkxBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2S0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JqQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25VQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9EQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbktBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ROQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsSEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoicGFnZXMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuLXRhYiAnO1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgLy9leHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcblxyXG4gICAgfTtcclxufSkodGhpcy5UZW1wbGF0ZSA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIHN0YXRlLmVudGl0aWVzID0gWydjaGFyYWN0ZXJzJywgJ3N0b3JpZXMnLCAnZ3JvdXBzJywgJ3BsYXllcnMnXTtcclxuXHJcbiAgICBjb25zdCByb290ID0gJy5vcmdhbml6ZXItbWFuYWdlbWVudC10YWIgJztcclxuXHJcbiAgICBsZXQgcmVtb3ZlUGVybWlzc2lvbiwgYXNzaWduUGVybWlzc2lvbjtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3JlYXRlVXNlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGNyZWF0ZVVzZXIsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLW9yZ2FuaXplci1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdhZG1pbnMtY3JlYXRpbmctdXNlcicsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS51c2VyYCksICdjbGljaycsICgpID0+IGNyZWF0ZVVzZXJEaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBjaGFuZ2VQYXNzd29yZERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGNoYW5nZVBhc3N3b3JkLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdhZG1pbnMtZW50ZXItbmV3LXBhc3N3b3JkJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tcmVwbGFjZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LnVzZXIuY2hhbmdlLXBhc3N3b3JkYCksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcWVlKGNoYW5nZVBhc3N3b3JkRGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGNoYW5nZVBhc3N3b3JkRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUtdXNlci1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlT3JnYW5pemVyKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uYXNzaWduLXBlcm1pc3Npb24tYnV0dG9uYCksICdjbGljaycsIGFzc2lnblBlcm1pc3Npb24pO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS1wZXJtaXNzaW9uLWJ1dHRvbmApLCAnY2xpY2snLCByZW1vdmVQZXJtaXNzaW9uKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5hc3NpZ24tYWRtaW4tYnV0dG9uYCksICdjbGljaycsIGFzc2lnbk5ld0FkbWluKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUtZWRpdG9yLWJ1dHRvbmApLCAnY2xpY2snLCByZW1vdmVFZGl0b3IpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmFzc2lnbi1lZGl0b3ItYnV0dG9uYCksICdjbGljaycsIGFzc2lnbkVkaXRvcik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUuZW50aXRpZXMuZm9yRWFjaCh0eXBlID0+IHtcclxuICAgICAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1maWx0ZXIuJHt0eXBlfWApLCAnaW5wdXQnLCBmaWx0ZXJMaXN0KGAuZW50aXR5LWxpc3QuJHt0eXBlfWApKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcXVlcnlFbEVscyhxdWVyeUVsKHJvb3QpLCAnLmFkYXB0YXRpb25SaWdodHMnKS5tYXAobGlzdGVuKFIuX18sICdjbGljaycsIGNoYW5nZUFkYXB0YXRpb25SaWdodHNNb2RlKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0TWFuYWdlbWVudEluZm8oKGVyciwgbWFuYWdlbWVudEluZm8pID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzQWRtaW4oKGVycjIsIGlzQWRtaW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VkaXRvcigoZXJyMywgaXNFZGl0b3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyNCwgY2hhcmFjdGVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjQpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNCk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnc3RvcnknLCBmYWxzZSwgKGVycjUsIHN0b3J5TmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI1KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjUpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdncm91cCcsIGZhbHNlLCAoZXJyNiwgZ3JvdXBOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI2KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjYpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgncGxheWVyJywgZmFsc2UsIChlcnI3LCBwbGF5ZXJOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI3KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyczogY2hhcmFjdGVyTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHM6IGdyb3VwTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9yaWVzOiBzdG9yeU5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyczogcGxheWVyTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNBZG1pbiAmJiBpc0VkaXRvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUi5rZXlzKG5hbWVzKS5mb3JFYWNoKChlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lc1tlbnRpdHldID0gbmFtZXNbZW50aXR5XS5maWx0ZXIoUi5wcm9wKCdpc093bmVyJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVidWlsZEludGVyZmFjZShuYW1lcywgbWFuYWdlbWVudEluZm8sIGlzQWRtaW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnYWRtaW5Pbmx5JywgaXNBZG1pbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdlZGl0b3JPckFkbWluJywgaXNBZG1pbiB8fCBpc0VkaXRvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlYnVpbGRJbnRlcmZhY2UobmFtZXMsIG1hbmFnZW1lbnRJbmZvLCBpc0FkbWluKSB7XHJcbiAgICAgICAgY29uc3QgeyB1c2Vyc0luZm8gfSA9IG1hbmFnZW1lbnRJbmZvO1xyXG5cclxuICAgICAgICBjb25zdCB1c2VyTmFtZXMgPSBPYmplY3Qua2V5cyh1c2Vyc0luZm8pLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG5cclxuICAgICAgICBjb25zdCBzZWxlY3RvcnMgPSBbXTtcclxuICAgICAgICBzZWxlY3RvcnMucHVzaChxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApKTtcclxuLy8gICAgICAgIHNlbGVjdG9ycy5wdXNoKHF1ZXJ5RWwoYCR7cm9vdH0udXNlci1wZXJtaXNzaW9uLXNlbGVjdGApKTtcclxuLy8gICAgICAgIHNlbGVjdG9ycy5wdXNoKHF1ZXJ5RWwoYCR7cm9vdH0uYXNzaWduLWVkaXRvci1zZWxlY3RgKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBhcnIyU2VsZWN0Mih1c2VyTmFtZXMpXHJcbiAgICAgICAgc2VsZWN0b3JzLmZvckVhY2goKHNlbGVjdG9yKSA9PiB7XHJcbiAgICAgICAgICAgIGNsZWFyRWwoc2VsZWN0b3IpO1xyXG4gICAgICAgICAgICAkKHNlbGVjdG9yKS5zZWxlY3QyKGRhdGEpO1xyXG4vLyAgICAgICAgICAgIFV0aWxzLnJlYnVpbGRTZWxlY3RvckFycihzZWxlY3RvciwgdXNlck5hbWVzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBVdGlscy5yZWJ1aWxkU2VsZWN0b3JBcnIocXVlcnlFbChgJHtyb290fS51c2VyLXBlcm1pc3Npb24tc2VsZWN0YCksIHVzZXJOYW1lcyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNsb25lID0gdXNlck5hbWVzLnNsaWNlKDApO1xyXG4gICAgICAgIGNsb25lLnNwbGljZSh1c2VyTmFtZXMuaW5kZXhPZihtYW5hZ2VtZW50SW5mby5hZG1pbiksIDEpO1xyXG4vLyAgICAgICAgbGV0IHNlbGVjdG9yID0gcXVlcnlFbChgJHtyb290fS5hc3NpZ24tYWRtaW4tc2VsZWN0YCk7XHJcbi8vICAgICAgICBVdGlscy5yZWJ1aWxkU2VsZWN0b3JBcnIoc2VsZWN0b3IsIGNsb25lKTtcclxuICAgICAgICBcclxuLy8gICAgICAgIGNvbnN0IGRhdGEgPSBnZXRTZWxlY3QyRGF0YShhbGxHcm91cE5hbWVzKTtcclxuLy8gICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKSk7XHJcbi8vICAgICAgICAkKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnNlbGVjdDIoZGF0YSk7XHJcblxyXG4vLyAgICAgICAgc2VsZWN0b3IgPSBxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS11c2VyLXNlbGVjdGApO1xyXG4vLyAgICAgICAgVXRpbHMucmVidWlsZFNlbGVjdG9yQXJyKHNlbGVjdG9yLCBjbG9uZSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmVudGl0aWVzLmZvckVhY2goKGVudGl0eSkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5yZWJ1aWxkU2VsZWN0b3IocXVlcnlFbChgJHtyb290fS5wZXJtaXNzaW9uLXNlbGVjdG9yX18ke2VudGl0eX1gKSwgbmFtZXNbZW50aXR5XSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5jdXJyZW50LWFkbWluLWxhYmVsYCkpLCBtYWtlVGV4dChtYW5hZ2VtZW50SW5mby5hZG1pbikpO1xyXG5cclxuICAgICAgICBjb25zdCBzcGFuID0gY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmN1cnJlbnQtZWRpdG9yLWxhYmVsYCkpO1xyXG4gICAgICAgIGlmIChtYW5hZ2VtZW50SW5mby5lZGl0b3IpIHtcclxuICAgICAgICAgICAgYWRkRWwoc3BhbiwgbWFrZVRleHQobWFuYWdlbWVudEluZm8uZWRpdG9yKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBnZXRFbChgYWRhcHRhdGlvblJpZ2h0cyR7bWFuYWdlbWVudEluZm8uYWRhcHRhdGlvblJpZ2h0c31gKS5jaGVja2VkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgc3RhdGUuZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5KSA9PiB7XHJcbi8vICAgICAgICAgICAgVXRpbHMucmVidWlsZFNlbGVjdG9yKHF1ZXJ5RWwoYCR7cm9vdH0ucGVybWlzc2lvbi1zZWxlY3Rvcl9fJHtlbnRpdHl9YCksIG5hbWVzW2VudGl0eV0pO1xyXG4gICAgICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1saXN0LiR7ZW50aXR5fWApKSxcclxuICAgICAgICAgICAgICAgIG5hbWVzW2VudGl0eV0ubWFwKGVudGl0eTJlbChpc0FkbWluLCBlbnRpdHkpKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGFkZEVscyhcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdC51c2Vyc2ApKSxcclxuICAgICAgICAgICAgdXNlck5hbWVzLm1hcCh1c2VyMmVsKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgYnVpbGRQZXJtaXNzaW9uTGlzdChuYW1lcywgdXNlcnNJbmZvKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3QgZW50aXR5MmVsID0gUi5jdXJyeSgoaXNBZG1pbiwgdHlwZSwgbmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsID0gcW10ZShgLnByb2ZpbGUtaXRlbS10bXBsYCk7XHJcbiAgICAgICAgZWwucHJvZmlsZU5hbWUgPSBuYW1lLnZhbHVlO1xyXG4gICAgICAgIGFkZEVsKHFlZShlbCwgJy5wcmltYXJ5LW5hbWUnKSwgbWFrZVRleHQobmFtZS5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgIGNvbnN0IGJ0biA9IHFlZShlbCwgJ1tyb2xlPWJ1dHRvbl0nKTtcclxuICAgICAgICBzZXRBdHRyKGJ0biwgJ3Byb2ZpbGUtbmFtZScsIG5hbWUudmFsdWUpO1xyXG4gICAgICAgIHNldEF0dHIoYnRuLCAncHJpbWFyeS1uYW1lJywgbmFtZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgc2V0QXR0cihidG4sICdidXR0b24tdHlwZScsICdlbnRpdHknKTtcclxuICAgICAgICBzZXRBdHRyKGJ0biwgJ3Byb2ZpbGUtdHlwZScsIHR5cGUpO1xyXG4gICAgICAgIGlmKG5hbWUuaXNPd25lciB8fCBpc0FkbWluKXtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdzdGFydCcsIG9uRHJhZ1N0YXJ0KTtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2Ryb3AnLCBvbkRyb3ApO1xyXG4gICAgICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ292ZXInLCBhbGxvd0Ryb3ApO1xyXG4gICAgICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ2VudGVyJywgaGFuZGxlRHJhZ0VudGVyKTtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2RyYWdsZWF2ZScsIGhhbmRsZURyYWdMZWF2ZSk7XHJcbiAgICAgICAgICAgIGxpc3RlbihidG4sICdjbGljaycsIGUgPT4gdG9nZ2xlQ2xhc3MoYnRuLCAnYnRuLXByaW1hcnknKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwoYnRuLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBjb25zdCB1c2VyMmVsID0gUi5jdXJyeSgobmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCdkaXYnLCBxdGUoYC5wcm9maWxlLWl0ZW0tdG1wbGApKTtcclxuLy8gICAgICAgIGVsLnByb2ZpbGVOYW1lID0gbmFtZS52YWx1ZTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcucHJpbWFyeS1uYW1lJyksIG1ha2VUZXh0KG5hbWUpKTtcclxuICAgICAgICBzZXRBdHRyKGVsLCAncHJvZmlsZS1uYW1lJywgbmFtZSk7XHJcbiAgICAgICAgc2V0QXR0cihlbCwgJ2J1dHRvbi10eXBlJywgJ3VzZXInKTtcclxuLy8gICAgICAgIHNldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnLCBuYW1lLmRpc3BsYXlOYW1lKTtcclxuLy8gICAgICAgIHNldEF0dHIoZWwsICdwcm9maWxlLXR5cGUnLCB0eXBlKTtcclxuICAgICAgICBsaXN0ZW4oZWwsICdkcmFnc3RhcnQnLCBvbkRyYWdTdGFydCk7XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnZHJvcCcsIG9uRHJvcCk7XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnZHJhZ292ZXInLCBhbGxvd0Ryb3ApO1xyXG4gICAgICAgIGxpc3RlbihlbCwgJ2RyYWdlbnRlcicsIGhhbmRsZURyYWdFbnRlcik7XHJcbiAgICAgICAgbGlzdGVuKGVsLCAnZHJhZ2xlYXZlJywgaGFuZGxlRHJhZ0xlYXZlKTtcclxuICAgICAgICByZXR1cm4gZWw7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgb25EcmFnU3RhcnQgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIGlmKGdldEF0dHIodGhpcywgJ2J1dHRvbi10eXBlJykgPT09ICdlbnRpdHknKXtcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGhpcywgJ2J0bi1wcmltYXJ5Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUubG9nKGBvbkRyYWdTdGFydCAke3RoaXMucHJvZmlsZU5hbWV9YCk7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLnNldERhdGEoJ2RhdGEnLCBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgIG5hbWU6IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtbmFtZScpLFxyXG4gICAgICAgICAgICB0eXBlOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLXR5cGUnKSxcclxuICAgICAgICAgICAgYnV0dG9uVHlwZTogZ2V0QXR0cih0aGlzLCAnYnV0dG9uLXR5cGUnKSxcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAnbW92ZSc7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkRyb3AgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKHRoaXMsICdvdmVyJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYG9uRHJvcCAke3RoaXMucHJvZmlsZU5hbWV9JHtldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpfWApO1xyXG4gICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHtcclxuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIHN0b3BzIHRoZSBicm93c2VyIGZyb20gcmVkaXJlY3RpbmcuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRoYXREYXRhID0gSlNPTi5wYXJzZShldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpKTtcclxuICAgICAgICBpZiAodGhhdERhdGEudHlwZSA9PT0gZ2V0QXR0cih0aGlzLCAncHJvZmlsZS10eXBlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0eXBlMSA9IGdldEF0dHIodGhpcywgJ2J1dHRvbi10eXBlJyk7XHJcbiAgICAgICAgY29uc3QgdHlwZTIgPSB0aGF0RGF0YS5idXR0b25UeXBlO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKHR5cGUxICE9PSB0eXBlMil7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJOYW1lID0gdHlwZTEgPT09ICd1c2VyJyA/IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtbmFtZScpIDogdGhhdERhdGEubmFtZTtcclxuLy8gICAgICAgICAgICBjb25zdCBlbnRpdHlCdG4gPSAgdHlwZTEgPT09ICd1c2VyJyA/IFxyXG4gICAgICAgICAgICBcclxuLy8gICAgICAgICAgICBjb25zb2xlLmxvZyh1c2VyKTtcclxuICAgICAgICAgICAgY29uc3QgYnRucyA9IHFlcyhgJHtyb290fSAucmlnaHRzLXBhbmVsIC5idG4tcHJpbWFyeVtyb2xlPWJ1dHRvbl1gKTtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBidG5zLm1hcCggYnRuID0+ICh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBnZXRBdHRyKGJ0biwgJ3Byb2ZpbGUtdHlwZScpLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogZ2V0QXR0cihidG4sICdwcm9maWxlLW5hbWUnKSxcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lcyA9IFIubWFwT2JqSW5kZXhlZChhcnIgPT4gYXJyLm1hcChSLnByb3AoJ25hbWUnKSksIFIuZ3JvdXBCeShSLnByb3AoJ3R5cGUnKSwgc2VsZWN0ZWQpKTtcclxuICAgICAgICAgICAgYnRucy5mb3JFYWNoKGJ0biA9PiByZW1vdmVDbGFzcyhidG4sICdidG4tcHJpbWFyeScpKVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgREJNU1snYXNzaWduUGVybWlzc2lvbiddKHVzZXJOYW1lLCBuYW1lcywgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4vLyAgICAgICAgICAgIERCTVNbYWN0aW9uXSh1c2VyTmFtZSwgbmFtZXMsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuLy8gICAgICAgIH07XHJcbi8vICAgIH1cclxuLy9cclxuLy8gICAgcmVtb3ZlUGVybWlzc2lvbiA9IHBlcm1pc3Npb25BY3Rpb24oJ3JlbW92ZVBlcm1pc3Npb24nKTtcclxuLy8gICAgYXNzaWduUGVybWlzc2lvbiA9IHBlcm1pc3Npb25BY3Rpb24oJ2Fzc2lnblBlcm1pc3Npb24nKTtcclxuICAgICAgICB9XHJcblxyXG4vLyAgICAgICAgY3JlYXRlQmluZGluZyhbdGhhdERhdGEsIHtcclxuLy8gICAgICAgICAgICBuYW1lOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLW5hbWUnKSxcclxuLy8gICAgICAgICAgICB0eXBlOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLXR5cGUnKSxcclxuLy8gICAgICAgIH1dKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGFsbG93RHJvcCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGFsbG93RHJvcCAke3RoaXMucHJvZmlsZU5hbWV9YCk7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gaGFuZGxlRHJhZ0VudGVyKGV2ZW50KSB7XHJcbiAgICAgICAgYWRkQ2xhc3ModGhpcywgJ292ZXInKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVEcmFnTGVhdmUoZXZlbnQpIHtcclxuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGJ1aWxkUGVybWlzc2lvbkxpc3QobmFtZXMsIHVzZXJzSW5mbykge1xyXG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25UYWJsZSA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5wZXJtaXNzaW9uLXRhYmxlYCkpO1xyXG4gICAgICAgIGNvbnN0IHRyZWVSb290ID0gbWFrZUVsKCd1bCcpO1xyXG4gICAgICAgIGFkZEVsKHBlcm1pc3Npb25UYWJsZSwgdHJlZVJvb3QpO1xyXG5cclxuICAgICAgICBSLmtleXMobmFtZXMpLmZvckVhY2goKGVudGl0eSkgPT4ge1xyXG4gICAgICAgICAgICBuYW1lc1tlbnRpdHldID0gbmFtZXNbZW50aXR5XS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgUi52YWx1ZXModXNlcnNJbmZvKS5mb3JFYWNoKCh1c2VySW5mbykgPT4ge1xyXG4gICAgICAgICAgICBSLmtleXModXNlckluZm8pLmZvckVhY2goKGVudGl0eSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbmFtZXNbZW50aXR5XSA9IFIuZGlmZmVyZW5jZShuYW1lc1tlbnRpdHldLCB1c2VySW5mb1tlbnRpdHldKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHVzZXJzSW5mb1tnZXRMMTBuKCdhZG1pbnMtaGF2ZS1ub3Qtb3duZXInKV0gPSBuYW1lcztcclxuXHJcbiAgICAgICAgY29uc3QgaGVhZGVycyA9IHtcclxuICAgICAgICAgICAgY2hhcmFjdGVyczogZ2V0TDEwbignYWRtaW5zLWNoYXJhY3RlcnMnKSxcclxuICAgICAgICAgICAgc3RvcmllczogZ2V0TDEwbignYWRtaW5zLXN0b3JpZXMnKSxcclxuICAgICAgICAgICAgZ3JvdXBzOiBnZXRMMTBuKCdhZG1pbnMtZ3JvdXBzJyksXHJcbiAgICAgICAgICAgIHBsYXllcnM6IGdldEwxMG4oJ2FkbWlucy1wbGF5ZXJzJyksXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gbGlNYWtlcih0ZXh0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRFbChtYWtlRWwoJ2xpJyksIG1ha2VUZXh0KHRleHQpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIG1ha2VFbnRpdHlMaXN0cyh1c2VySW5mbykge1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGUuZW50aXRpZXMucmVkdWNlKChyZXN1bHQsIGVudGl0eSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobGlNYWtlcihoZWFkZXJzW2VudGl0eV0pKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFkZEVscyhtYWtlRWwoJ29sJyksIHVzZXJJbmZvW2VudGl0eV0uc29ydChDb21tb25VdGlscy5jaGFyT3JkQSkubWFwKGxpTWFrZXIpKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICB9LCBbXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB1c2VyTmFtZXMgPSBPYmplY3Qua2V5cyh1c2Vyc0luZm8pLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgIGFkZEVscyh0cmVlUm9vdCwgdXNlck5hbWVzLnJlZHVjZSgocmVzdWx0LCB1c2VyTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChsaU1ha2VyKHVzZXJOYW1lKSk7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGFkZEVscyhtYWtlRWwoJ29sJyksIG1ha2VFbnRpdHlMaXN0cyh1c2Vyc0luZm9bdXNlck5hbWVdKSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH0sIFtdKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlVXNlcihkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZUlucHV0ID0gcWVlKGRpYWxvZyxgLmNyZWF0ZS11c2VyLW5hbWUtaW5wdXRgKTtcclxuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkSW5wdXQgPSBxZWUoZGlhbG9nLGAuY3JlYXRlLXVzZXItcGFzc3dvcmQtaW5wdXRgKTtcclxuICAgICAgICAgICAgREJNUy5jcmVhdGVPcmdhbml6ZXIodXNlck5hbWVJbnB1dC52YWx1ZS50cmltKCksIHVzZXJQYXNzd29yZElucHV0LnZhbHVlLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyTmFtZUlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlclBhc3N3b3JkSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBjaGFuZ2VQYXNzd29yZChkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgbmV3UGFzc3dvcmQgPSB0b0lucHV0LnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBEQk1TLmNoYW5nZU9yZ2FuaXplclBhc3N3b3JkKHVzZXJOYW1lLCBuZXdQYXNzd29yZCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlT3JnYW5pemVyUGFzc3dvcmQoKSB7XHJcbiAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBjb25zdCBwYXNzd29yZElucHV0ID0gcXVlcnlFbChgJHtyb290fS5jaGFuZ2UtcGFzc3dvcmQtcGFzc3dvcmQtaW5wdXRgKTtcclxuICAgICAgICBEQk1TLmNoYW5nZU9yZ2FuaXplclBhc3N3b3JkKHVzZXJOYW1lLCBwYXNzd29yZElucHV0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKCkgPT4ge1xyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC1wYXNzd29yZC1pbnB1dGApLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVPcmdhbml6ZXIoKSB7XHJcbi8vICAgICAgICBjb25zdCBuYW1lID0gcXVlcnlFbChgJHtyb290fS5yZW1vdmUtdXNlci1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ2FkbWlucy1jb25maXJtLXVzZXItcmVtb3ZlJyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5yZW1vdmVPcmdhbml6ZXIobmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGdldFNlbGVjdGVkT3B0aW9ucyA9IHNlbCA9PiBubDJhcnJheShxdWVyeUVsKHNlbCkuc2VsZWN0ZWRPcHRpb25zKS5tYXAob3B0ID0+IG9wdC52YWx1ZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gcGVybWlzc2lvbkFjdGlvbihhY3Rpb24pIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0udXNlci1wZXJtaXNzaW9uLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFRPRE8gcmVtb3ZlIHRoaXMgY2hlY2tcclxuICAgICAgICAgICAgaWYgKHVzZXJOYW1lID09PSAnJykge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYWRtaW5zLXVzZXItaXMtbm90LXNlbGVjdGVkJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBuYW1lcyA9IHt9O1xyXG4gICAgICAgICAgICBzdGF0ZS5lbnRpdGllcy5mb3JFYWNoKChlbnRpdHkpID0+IHtcclxuICAgICAgICAgICAgICAgIG5hbWVzW2VudGl0eV0gPSBnZXRTZWxlY3RlZE9wdGlvbnMoYCR7cm9vdH0ucGVybWlzc2lvbi1zZWxlY3Rvcl9fJHtlbnRpdHl9YCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgREJNU1thY3Rpb25dKHVzZXJOYW1lLCBuYW1lcywgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlUGVybWlzc2lvbiA9IHBlcm1pc3Npb25BY3Rpb24oJ3JlbW92ZVBlcm1pc3Npb24nKTtcclxuICAgIGFzc2lnblBlcm1pc3Npb24gPSBwZXJtaXNzaW9uQWN0aW9uKCdhc3NpZ25QZXJtaXNzaW9uJyk7XHJcblxyXG4gICAgZnVuY3Rpb24gYXNzaWduTmV3QWRtaW4oKSB7XHJcbiAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdhZG1pbnMtY29uZmlybS1hZG1pbi1hc3NpZ25tZW50JyksIFt1c2VyTmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuYXNzaWduQWRtaW4odXNlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUVkaXRvcigpIHtcclxuICAgICAgICBEQk1TLnJlbW92ZUVkaXRvcihVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBhc3NpZ25FZGl0b3IoKSB7XHJcbiAgICAgICAgY29uc3QgdXNlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdhZG1pbnMtY29uZmlybS1lZGl0b3ItYXNzaWdubWVudCcpLCBbdXNlck5hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmFzc2lnbkVkaXRvcih1c2VyTmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gY2hhbmdlQWRhcHRhdGlvblJpZ2h0c01vZGUoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLmNoYW5nZUFkYXB0YXRpb25SaWdodHNNb2RlKGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZmlsdGVyTGlzdCA9IHNlbCA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBzdHIgPSBldmVudC50YXJnZXQudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZWxzID0gcXVlcnlFbHMoYCR7cm9vdH0gJHtzZWx9IFtwcmltYXJ5LW5hbWVdYCk7XHJcbiAgICAgICAgZWxzLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IGdldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc3RyKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIGhpZGVFbChlbCwgIWlzVmlzaWJsZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG59KSh0aGlzLk9yZ2FuaXplck1hbmFnZW1lbnQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgY29uc3Qgcm9vdCA9ICcucGxheWVyLW1hbmFnZW1lbnQtdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVVzZXJEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjcmVhdGVVc2VyLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2NyZWF0ZS1vcmdhbml6ZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnYWRtaW5zLWNyZWF0aW5nLXBsYXllcicsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS5wbGF5ZXJgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlVXNlckRpYWxvZy5zaG93RGxnKCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVBsYXllckFjY291bnREaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjcmVhdGVVc2VyQWNjb3VudCwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdjcmVhdGUtcGxheWVyLWFjY291bnQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnYWRtaW5zLWNyZWF0aW5nLXBsYXllci1hY2NvdW50JyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uY3JlYXRlLnBsYXllci1hY2NvdW50YCksICdjbGljaycsICgpID0+IGNyZWF0ZVBsYXllckFjY291bnREaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBjaGFuZ2VQYXNzd29yZERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIGNoYW5nZVBhc3N3b3JkLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdhZG1pbnMtZW50ZXItbmV3LXBhc3N3b3JkJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tcmVwbGFjZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LnVzZXIuY2hhbmdlLXBhc3N3b3JkYCksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcWVlKGNoYW5nZVBhc3N3b3JkRGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGNoYW5nZVBhc3N3b3JkRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBcclxuLy8gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS11c2VyLWJ1dHRvbmApLCAnY2xpY2snLCBjcmVhdGVVc2VyKTtcclxuLy8gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1sb2dpbi1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlTG9naW4pO1xyXG4vLyAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLWJ1dHRvbmApLCAnY2xpY2snLCBjaGFuZ2VQYXNzd29yZCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLXVzZXItYnV0dG9uYCksICdjbGljaycsIHJlbW92ZVVzZXIpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LndlbGNvbWUtdGV4dC1hcmVhYCksICdjaGFuZ2UnLCBzZXRXZWxjb21lVGV4dCk7XHJcbiAgICAgICAgcXVlcnlFbEVscyhxdWVyeUVsKHJvb3QpLCAnLnBsYXllck9wdGlvbnMnKS5tYXAobGlzdGVuKFIuX18sICdjaGFuZ2UnLCBzZXRQbGF5ZXJPcHRpb24pKTtcclxuICAgICAgICBcclxuICAgICAgICAkKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnNlbGVjdDIoKS5vbignY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBsYXllciA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgeW91clBsYXllcnMgPSBzdGF0ZS5wbGF5ZXJOYW1lcy5maWx0ZXIoUi5wcm9wKCdpc093bmVyJykpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICBjb25zdCBpc1BsYXllckVkaXRhYmxlID0gUi5jb250YWlucyhwbGF5ZXIsIHlvdXJQbGF5ZXJzKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0udXNlci5jaGFuZ2UtcGFzc3dvcmRgKSwgaXNQbGF5ZXJFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnJlbW92ZS11c2VyLWJ1dHRvbmApLCBpc1BsYXllckVkaXRhYmxlKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgncGxheWVyJywgZmFsc2UsIChlcnIsIHBsYXllck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIERCTVMuZ2V0UGxheWVyTG9naW5zQXJyYXkoKGVycjIsIHBsYXllckxvZ2lucykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRXZWxjb21lVGV4dCgoZXJyMywgdGV4dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBEQk1TLmdldFBsYXllcnNPcHRpb25zKChlcnI0LCBwbGF5ZXJzT3B0aW9ucykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI0KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKChlcnI1LCBpc0FkbWluKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNSkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI1KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIudG9QYWlycyhwbGF5ZXJzT3B0aW9ucykubWFwKHBhaXIgPT4gKGdldEVsKHBhaXJbMF0pLmNoZWNrZWQgPSBwYWlyWzFdKSk7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0ud2VsY29tZS10ZXh0LWFyZWFgKS52YWx1ZSA9IHRleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbGF5ZXJIYXNMb2dpbiA9IFIuY29tcG9zZShSLmNvbnRhaW5zKFIuX18sIHBsYXllckxvZ2lucyksIFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYXNMb2dpbk9iaiA9IFIuZ3JvdXBCeShwbGF5ZXJIYXNMb2dpbiwgcGxheWVyTmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5wbGF5ZXJOYW1lcyA9IHBsYXllck5hbWVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub0FjY291bnRzID0gKGhhc0xvZ2luT2JqLmZhbHNlIHx8IFtdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vQWNjb3VudHMuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5jcmVhdGUtbG9naW4tbmFtZS1zZWxlY3RgKSkpLnNlbGVjdDIoZ2V0U2VsZWN0MkRhdGEobm9BY2NvdW50cykpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1sb2dpbi1uYW1lLXNlbGVjdGApKSwgKGhhc0xvZ2luT2JqLmZhbHNlIHx8IFtdKVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpLm1hcChyZW1hcFByb3BzNFNlbGVjdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzQWNjb3VudHMgPSAoaGFzTG9naW5PYmoudHJ1ZSB8fCBbXSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0FjY291bnRzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCkpKS5zZWxlY3QyKGdldFNlbGVjdDJEYXRhKGhhc0FjY291bnRzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdhZG1pbk9ubHknLCBpc0FkbWluKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCksIGhhc0FjY291bnRzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0udXNlci5jaGFuZ2UtcGFzc3dvcmRgKSwgaGFzQWNjb3VudHMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW1vdmUtdXNlci1idXR0b25gKSwgaGFzQWNjb3VudHMubGVuZ3RoID4gMCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCkpLCAoaGFzTG9naW5PYmoudHJ1ZSB8fCBbXSlcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zb3J0KFV0aWxzLmNoYXJPcmRBT2JqZWN0KS5tYXAocmVtYXBQcm9wczRTZWxlY3QpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5yZW1vdmUtdXNlci1zZWxlY3RgKSksIChoYXNMb2dpbk9iai50cnVlIHx8IFtdKVxyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCkubWFwKHJlbWFwUHJvcHM0U2VsZWN0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVVc2VyKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJOYW1lSW5wdXQgPSBxZWUoZGlhbG9nLGAuY3JlYXRlLXVzZXItbmFtZS1pbnB1dGApO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyUGFzc3dvcmRJbnB1dCA9IHFlZShkaWFsb2csYC5jcmVhdGUtdXNlci1wYXNzd29yZC1pbnB1dGApO1xyXG4gICAgICAgICAgICBEQk1TLmNyZWF0ZVBsYXllcih1c2VyTmFtZUlucHV0LnZhbHVlLnRyaW0oKSwgdXNlclBhc3N3b3JkSW5wdXQudmFsdWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlck5hbWVJbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyUGFzc3dvcmRJbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gY3JlYXRlVXNlckFjY291bnQoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdXNlck5hbWVTZWxlY3QgPSBxZWUoZGlhbG9nLGAuY3JlYXRlLWxvZ2luLW5hbWUtc2VsZWN0YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhc3N3b3JkSW5wdXQgPSBxZWUoZGlhbG9nLGAuY3JlYXRlLWxvZ2luLXBhc3N3b3JkLWlucHV0YCk7XHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlUGxheWVyTG9naW4odXNlck5hbWVTZWxlY3QudmFsdWUsIHBhc3N3b3JkSW5wdXQudmFsdWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZUxvZ2luKCkge1xyXG4gICAgICAgIGNvbnN0IHVzZXJOYW1lU2VsZWN0ID0gcXVlcnlFbChgJHtyb290fS5jcmVhdGUtbG9naW4tbmFtZS1zZWxlY3RgKTtcclxuICAgICAgICBjb25zdCBwYXNzd29yZElucHV0ID0gcXVlcnlFbChgJHtyb290fS5jcmVhdGUtbG9naW4tcGFzc3dvcmQtaW5wdXRgKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZVBsYXllckxvZ2luKHVzZXJOYW1lU2VsZWN0LnZhbHVlLCBwYXNzd29yZElucHV0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKCkgPT4ge1xyXG4gICAgICAgICAgICBwYXNzd29yZElucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbi8vICAgIGZ1bmN0aW9uIGNoYW5nZVBhc3N3b3JkKCkge1xyXG4vLyAgICAgICAgY29uc3QgdXNlck5hbWVTZWxlY3QgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApO1xyXG4vLyAgICAgICAgY29uc3QgcGFzc3dvcmRJbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXBhc3N3b3JkLWlucHV0YCk7XHJcbi8vICAgICAgICBEQk1TLmNoYW5nZVBsYXllclBhc3N3b3JkKHVzZXJOYW1lU2VsZWN0LnZhbHVlLCBwYXNzd29yZElucHV0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKCkgPT4ge1xyXG4vLyAgICAgICAgICAgIHBhc3N3b3JkSW5wdXQudmFsdWUgPSAnJztcclxuLy8gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuLy8gICAgICAgIH0pKTtcclxuLy8gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBjaGFuZ2VQYXNzd29yZChkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgbmV3UGFzc3dvcmQgPSB0b0lucHV0LnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyTmFtZSA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBEQk1TLmNoYW5nZVBsYXllclBhc3N3b3JkKHVzZXJOYW1lLCBuZXdQYXNzd29yZCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVVc2VyKCkge1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdhZG1pbnMtY29uZmlybS11c2VyLWFjY291bnQtcmVtb3ZlJyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5yZW1vdmVQbGF5ZXJMb2dpbihuYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfSk7XHJcbi8vICAgICAgICBjb25zdCB1c2VyTmFtZVNlbGVjdCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0YCk7XHJcbi8vICAgICAgICBEQk1TLnJlbW92ZVBsYXllckxvZ2luKHVzZXJOYW1lU2VsZWN0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2V0V2VsY29tZVRleHQoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLnNldFdlbGNvbWVUZXh0KGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNldFBsYXllck9wdGlvbihldmVudCkge1xyXG4gICAgICAgIERCTVMuc2V0UGxheWVyT3B0aW9uKGV2ZW50LnRhcmdldC52YWx1ZSwgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxufSkodGhpcy5QbGF5ZXJNYW5hZ2VtZW50ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuYWRhcHRhdGlvbnMtdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZXZlbnRzLXN0b3J5U2VsZWN0b3InKSwgJ2NoYW5nZScsIHVwZGF0ZUFkYXB0YXRpb25TZWxlY3RvckRlbGVnYXRlKTtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2V2ZW50cy1jaGFyYWN0ZXJTZWxlY3RvcicpLCAnY2hhbmdlJywgc2hvd1BlcnNvbmFsU3Rvcmllc0J5Q2hhcmFjdGVycyk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdldmVudHMtZXZlbnRTZWxlY3RvcicpLCAnY2hhbmdlJywgc2hvd1BlcnNvbmFsU3Rvcmllc0J5RXZlbnRzKTtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2ZpbmlzaGVkU3RvcnlDaGVja2JveCcpLCAnY2hhbmdlJywgZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICBxdWVyeUVscygnLmFkYXB0YXRpb25zLXRhYiBpbnB1dFtuYW1lPWFkYXB0YXRpb25GaWx0ZXJdJykubWFwKGxpc3RlbihSLl9fLCAnY2hhbmdlJywgdXBkYXRlRmlsdGVyKSk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gY2xlYXJFbChnZXRFbCgnZXZlbnRzLXN0b3J5U2VsZWN0b3InKSk7XHJcbiAgICAgICAgY2xlYXJFbChnZXRFbCgnZXZlbnRzLWNoYXJhY3RlclNlbGVjdG9yJykpO1xyXG4gICAgICAgIGNsZWFyRWwoZ2V0RWwoJ2V2ZW50cy1ldmVudFNlbGVjdG9yJykpO1xyXG4gICAgICAgIGNsZWFyRWwoZ2V0RWwoJ3BlcnNvbmFsU3RvcmllcycpKTtcclxuXHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3N0b3J5JywgZmFsc2UsIChlcnIsIGFsbFN0b3J5TmFtZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRGaWx0ZXJlZFN0b3J5TmFtZXMoZ2V0RWwoJ2ZpbmlzaGVkU3RvcnlDaGVja2JveCcpLmNoZWNrZWQsIChlcnIyLCBzdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnRgKSwgc3RvcnlOYW1lcy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hZGFwdGF0aW9ucy1jb250ZW50YCksIHN0b3J5TmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKHN0b3J5TmFtZXMubGVuZ3RoIDw9IDApIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRTdG9yeU5hbWUgPSBnZXRTZWxlY3RlZFN0b3J5TmFtZShzdG9yeU5hbWVzKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZEFyciA9IFIuaW5kZXhCeShSLnByb3AoJ3N0b3J5TmFtZScpLCBzdG9yeU5hbWVzKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3RvcnlOYW1lczIgPSBhbGxTdG9yeU5hbWVzLmZpbHRlcihzdG9yeSA9PiBSLmNvbnRhaW5zKHN0b3J5LnZhbHVlLCBSLmtleXMoZmlsdGVyZWRBcnIpKSkubWFwKCBzdG9yeSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWxlbSA9IGZpbHRlcmVkQXJyW3N0b3J5LnZhbHVlXTtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtLmRpc3BsYXlOYW1lID0gc3RvcnkuZGlzcGxheU5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHN0b3J5LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG9wdGlvbjtcclxuICAgICAgICAgICAgICAgIHN0b3J5TmFtZXMyLmZvckVhY2goKHN0b3J5TmFtZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbiA9IGFkZEVsKG1ha2VFbCgnb3B0aW9uJyksIChtYWtlVGV4dChzdG9yeU5hbWUuZGlzcGxheU5hbWUpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3Mob3B0aW9uLCBnZXRJY29uQ2xhc3Moc3RvcnlOYW1lKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0UHJvcChvcHRpb24sICdzZWxlY3RlZCcsIHN0b3J5TmFtZS52YWx1ZSA9PT0gc2VsZWN0ZWRTdG9yeU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc3RvcnlJbmZvJywgc3RvcnlOYW1lLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICBhZGRFbChzZWxlY3Rvciwgb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihzZWxlY3RvciwgJ3NpemUnLCBNYXRoLm1pbihzdG9yeU5hbWVzMi5sZW5ndGgsIDEwKSk7XHJcbiAgICAgICAgICAgICAgICBzaG93UGVyc29uYWxTdG9yaWVzKHNlbGVjdGVkU3RvcnlOYW1lKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUFkYXB0YXRpb25TZWxlY3RvckRlbGVnYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgY2xlYXJFbChnZXRFbCgncGVyc29uYWxTdG9yaWVzJykpO1xyXG4gICAgICAgIGNvbnN0IHN0b3J5TmFtZSA9IGV2ZW50LnRhcmdldC5zZWxlY3RlZE9wdGlvbnNbMF0uc3RvcnlJbmZvO1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdzdG9yeU5hbWUnLCBzdG9yeU5hbWUpO1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdjaGFyYWN0ZXJOYW1lcycsIG51bGwpO1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdldmVudEluZGV4ZXMnLCBudWxsKTtcclxuICAgICAgICBzaG93UGVyc29uYWxTdG9yaWVzKHN0b3J5TmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlQWRhcHRhdGlvblNlbGVjdG9yKHN0b3J5LCBhbGxDaGFyYWN0ZXJzKSB7XHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyU2VsZWN0b3IgPSBjbGVhckVsKGdldEVsKCdldmVudHMtY2hhcmFjdGVyU2VsZWN0b3InKSk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRTZWxlY3RvciA9IGNsZWFyRWwoZ2V0RWwoJ2V2ZW50cy1ldmVudFNlbGVjdG9yJykpO1xyXG5cclxuICAgICAgICBsZXQgY2hhcmFjdGVyQXJyYXkgPSBnZXRTdG9yeUNoYXJhY3RlckNvbXBsZXRlbmVzcyhzdG9yeSk7XHJcbiAgICAgICAgbGV0IGV2ZW50QXJyYXkgPSBnZXRTdG9yeUV2ZW50Q29tcGxldGVuZXNzKHN0b3J5KTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2hvd09ubHlVbmZpbmlzaGVkU3RvcmllcyA9IGdldEVsKCdmaW5pc2hlZFN0b3J5Q2hlY2tib3gnKS5jaGVja2VkO1xyXG4gICAgICAgIGlmIChzaG93T25seVVuZmluaXNoZWRTdG9yaWVzKSB7XHJcbiAgICAgICAgICAgIGNoYXJhY3RlckFycmF5ID0gY2hhcmFjdGVyQXJyYXkuZmlsdGVyKGVsZW0gPT4gIWVsZW0uaXNGaW5pc2hlZCB8fCBlbGVtLmlzRW1wdHkpO1xyXG4gICAgICAgICAgICBldmVudEFycmF5ID0gZXZlbnRBcnJheS5maWx0ZXIoZWxlbSA9PiAhZWxlbS5pc0ZpbmlzaGVkIHx8IGVsZW0uaXNFbXB0eSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lcyA9IGdldENoYXJhY3Rlck5hbWVzKGNoYXJhY3RlckFycmF5KTtcclxuICAgICAgICBjb25zdCBldmVudEluZGV4ZXMgPSBnZXRFdmVudEluZGV4ZXMoZXZlbnRBcnJheSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG1hcCA9IENvbW1vblV0aWxzLmFycjJtYXAoYWxsQ2hhcmFjdGVycywgJ3ZhbHVlJyk7XHJcblxyXG4gICAgICAgIGNoYXJhY3RlckFycmF5LmZvckVhY2goKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgZWxlbS5kaXNwbGF5TmFtZSA9IG1hcFtlbGVtLmNoYXJhY3Rlck5hbWVdLmRpc3BsYXlOYW1lO1xyXG4gICAgICAgICAgICBlbGVtLnZhbHVlID0gbWFwW2VsZW0uY2hhcmFjdGVyTmFtZV0udmFsdWU7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNoYXJhY3RlckFycmF5LnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpO1xyXG5cclxuICAgICAgICBsZXQgb3B0aW9uO1xyXG4gICAgICAgIGNoYXJhY3RlckFycmF5LmZvckVhY2goKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgb3B0aW9uID0gYWRkRWwobWFrZUVsKCdvcHRpb24nKSwgKG1ha2VUZXh0KGVsZW0uZGlzcGxheU5hbWUpKSk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKG9wdGlvbiwgZ2V0SWNvbkNsYXNzKGVsZW0pKTtcclxuICAgICAgICAgICAgc2V0UHJvcChvcHRpb24sICdzZWxlY3RlZCcsIGNoYXJhY3Rlck5hbWVzLmluZGV4T2YoZWxlbS52YWx1ZSkgIT09IC0xKTtcclxuICAgICAgICAgICAgc2V0UHJvcChvcHRpb24sICdzdG9yeUluZm8nLCBzdG9yeS5uYW1lKTtcclxuICAgICAgICAgICAgc2V0UHJvcChvcHRpb24sICdjaGFyYWN0ZXJOYW1lJywgZWxlbS52YWx1ZSk7XHJcbiAgICAgICAgICAgIGFkZEVsKGNoYXJhY3RlclNlbGVjdG9yLCBvcHRpb24pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNldEF0dHIoY2hhcmFjdGVyU2VsZWN0b3IsICdzaXplJywgY2hhcmFjdGVyQXJyYXkubGVuZ3RoKTtcclxuXHJcbiAgICAgICAgZXZlbnRBcnJheS5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICAgICAgICAgIG9wdGlvbiA9IGFkZEVsKG1ha2VFbCgnb3B0aW9uJyksIChtYWtlVGV4dChlbGVtLm5hbWUpKSk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKG9wdGlvbiwgZ2V0SWNvbkNsYXNzKGVsZW0pKTtcclxuICAgICAgICAgICAgc2V0UHJvcChvcHRpb24sICdzZWxlY3RlZCcsIGV2ZW50SW5kZXhlcy5pbmRleE9mKGVsZW0uaW5kZXgpICE9PSAtMSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnc3RvcnlJbmZvJywgc3RvcnkubmFtZSk7XHJcbiAgICAgICAgICAgIHNldFByb3Aob3B0aW9uLCAnZXZlbnRJbmRleDIyMicsIGVsZW0uaW5kZXgpO1xyXG4gICAgICAgICAgICBhZGRFbChldmVudFNlbGVjdG9yLCBvcHRpb24pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNldEF0dHIoZXZlbnRTZWxlY3RvciwgJ3NpemUnLCBldmVudEFycmF5Lmxlbmd0aCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRGaWx0ZXIgfSA9IERCTVMuZ2V0U2V0dGluZ3MoKS5BZGFwdGF0aW9ucztcclxuICAgICAgICBnZXRFbChzZWxlY3RlZEZpbHRlcikuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgdXBkYXRlRmlsdGVyKHtcclxuICAgICAgICAgICAgdGFyZ2V0OiB7XHJcbiAgICAgICAgICAgICAgICBpZDogc2VsZWN0ZWRGaWx0ZXJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUZpbHRlcihldmVudCkge1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKCdzZWxlY3RlZEZpbHRlcicsIGV2ZW50LnRhcmdldC5pZCk7XHJcbiAgICAgICAgY29uc3QgYnlDaGFyYWN0ZXIgPSBldmVudC50YXJnZXQuaWQgPT09ICdhZGFwdGF0aW9uRmlsdGVyQnlDaGFyYWN0ZXInO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnZXZlbnRzLWNoYXJhY3RlclNlbGVjdG9yRGl2JyksICFieUNoYXJhY3Rlcik7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCdldmVudHMtZXZlbnRTZWxlY3RvckRpdicpLCBieUNoYXJhY3Rlcik7XHJcbiAgICAgICAgaWYgKGJ5Q2hhcmFjdGVyKSB7XHJcbiAgICAgICAgICAgIHNob3dQZXJzb25hbFN0b3JpZXNCeUNoYXJhY3RlcnMoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzaG93UGVyc29uYWxTdG9yaWVzQnlFdmVudHMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd1BlcnNvbmFsU3Rvcmllc0J5Q2hhcmFjdGVycygpIHtcclxuICAgICAgICBjb25zdCBldmVudFJvd3MgPSBxdWVyeUVsRWxzKGV4cG9ydHMuY29udGVudCwgJy5ldmVudFJvdy1kZXBlbmRlbnQnKTtcclxuICAgICAgICBldmVudFJvd3MubWFwKHJlbW92ZUNsYXNzKFIuX18sICdoaWRkZW4nKSk7XHJcbiAgICAgICAgbmwyYXJyYXkocXVlcnlFbEVscyhleHBvcnRzLmNvbnRlbnQsICdkaXZbZGVwZW5kZW50LW9uLWNoYXJhY3Rlcl0nKSkubWFwKGFkZENsYXNzKFIuX18sICdoaWRkZW4nKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWVzID0gbmwyYXJyYXkoZ2V0RWwoJ2V2ZW50cy1jaGFyYWN0ZXJTZWxlY3RvcicpLnNlbGVjdGVkT3B0aW9ucykubWFwKG9wdCA9PiBvcHQuY2hhcmFjdGVyTmFtZSk7XHJcbiAgICAgICAgY2hhcmFjdGVyTmFtZXMuZm9yRWFjaChuYW1lID0+IHF1ZXJ5RWxFbHMoZXhwb3J0cy5jb250ZW50LCBgZGl2W2RlcGVuZGVudC1vbi1jaGFyYWN0ZXI9XCIke25hbWV9XCJdYCkubWFwKHJlbW92ZUNsYXNzKFIuX18sICdoaWRkZW4nKSkpO1xyXG4gICAgICAgIGV2ZW50Um93cy5tYXAocm93ID0+IGhpZGVFbChyb3csIFIuaW50ZXJzZWN0aW9uKHJvdy5kZXBlbmRzT25DaGFyYWN0ZXJzLCBjaGFyYWN0ZXJOYW1lcykubGVuZ3RoID09PSAwKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdXBkYXRlU2V0dGluZ3MoJ2NoYXJhY3Rlck5hbWVzJywgY2hhcmFjdGVyTmFtZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQZXJzb25hbFN0b3JpZXNCeUV2ZW50cygpIHtcclxuICAgICAgICBxdWVyeUVsRWxzKGV4cG9ydHMuY29udGVudCwgJ2RpdltkZXBlbmRlbnQtb24tY2hhcmFjdGVyXScpLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnaGlkZGVuJykpO1xyXG4gICAgICAgIHF1ZXJ5RWxFbHMoZXhwb3J0cy5jb250ZW50LCAnLmV2ZW50Um93LWRlcGVuZGVudCcpLm1hcChhZGRDbGFzcyhSLl9fLCAnaGlkZGVuJykpO1xyXG5cclxuICAgICAgICBjb25zdCBldmVudEluZGV4ZXMgPSBubDJhcnJheShnZXRFbCgnZXZlbnRzLWV2ZW50U2VsZWN0b3InKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChvcHQgPT4gb3B0LmV2ZW50SW5kZXgyMjIpO1xyXG4gICAgICAgIGV2ZW50SW5kZXhlcy5mb3JFYWNoKGluZGV4ID0+IHJlbW92ZUNsYXNzKGdldEVscyhgJHtpbmRleH0tZGVwZW5kZW50YClbMF0sICdoaWRkZW4nKSk7XHJcbiAgICAgICAgdXBkYXRlU2V0dGluZ3MoJ2V2ZW50SW5kZXhlcycsIGV2ZW50SW5kZXhlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U3RvcnlDaGFyYWN0ZXJDb21wbGV0ZW5lc3Moc3RvcnkpIHtcclxuICAgICAgICByZXR1cm4gUi5rZXlzKHN0b3J5LmNoYXJhY3RlcnMpLm1hcChlbGVtID0+ICh7XHJcbiAgICAgICAgICAgIGNoYXJhY3Rlck5hbWU6IGVsZW0sXHJcbiAgICAgICAgICAgIGlzRmluaXNoZWQ6IF9pc1N0b3J5RmluaXNoZWRGb3JDaGFyYWN0ZXIoc3RvcnksIGVsZW0pLFxyXG4gICAgICAgICAgICBpc0VtcHR5OiBfaXNTdG9yeUVtcHR5Rm9yQ2hhcmFjdGVyKHN0b3J5LCBlbGVtKVxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBfaXNTdG9yeUVtcHR5Rm9yQ2hhcmFjdGVyKHN0b3J5LCBjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0b3J5LmV2ZW50cy5ldmVyeShldmVudCA9PiBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdID09PSB1bmRlZmluZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIF9pc1N0b3J5RmluaXNoZWRGb3JDaGFyYWN0ZXIoc3RvcnksIGNoYXJhY3Rlck5hbWUpIHtcclxuICAgICAgICByZXR1cm4gc3RvcnkuZXZlbnRzLmZpbHRlcihldmVudCA9PiBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgIC5ldmVyeShldmVudCA9PiBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnJlYWR5ID09PSB0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTdG9yeUV2ZW50Q29tcGxldGVuZXNzKHN0b3J5KSB7XHJcbiAgICAgICAgcmV0dXJuIHN0b3J5LmV2ZW50cy5tYXAoKGV2ZW50LCBpKSA9PiAoe1xyXG4gICAgICAgICAgICBuYW1lOiBldmVudC5uYW1lLFxyXG4gICAgICAgICAgICBpbmRleDogaSxcclxuICAgICAgICAgICAgaXNGaW5pc2hlZDogX2lzRXZlbnRSZWFkeShldmVudCksXHJcbiAgICAgICAgICAgIGlzRW1wdHk6IE9iamVjdC5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpLmxlbmd0aCA9PT0gMFxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBfaXNFdmVudFJlYWR5KGV2ZW50KSB7XHJcbiAgICAgICAgcmV0dXJuIFIudmFsdWVzKGV2ZW50LmNoYXJhY3RlcnMpLmV2ZXJ5KGNoYXJhY3RlciA9PiBjaGFyYWN0ZXIucmVhZHkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQZXJzb25hbFN0b3JpZXMoc3RvcnlOYW1lKSB7XHJcbiAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyLCBtZXRhSW5mbykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBEQk1TLmdldFN0b3J5KHN0b3J5TmFtZSwgKGVycjIsIHN0b3J5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSgnc3RvcnknLCBzdG9yeU5hbWUsIChlcnIzLCBpc1N0b3J5RWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyNCwgYWxsQ2hhcmFjdGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI0KTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lcyA9IFIua2V5cyhzdG9yeS5jaGFyYWN0ZXJzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRhcHRhdGlvbnMgPSBjaGFyYWN0ZXJOYW1lcy5tYXAoY2hhcmFjdGVyTmFtZSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3J5TmFtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5hcmVBZGFwdGF0aW9uc0VkaXRhYmxlKGFkYXB0YXRpb25zLCAoZXJyNSwgYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjUpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNSk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcnkuZXZlbnRzLmZvckVhY2goKGl0ZW0sIGkpID0+IChpdGVtLmluZGV4ID0gaSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVpbGRBZGFwdGF0aW9uSW50ZXJmYWNlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZXMsIHN0b3J5LmV2ZW50cywgYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhSW5mb1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUFkYXB0YXRpb25TZWxlY3RvcihzdG9yeSwgYWxsQ2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNTdG9yeUVkaXRhYmxlJywgaXNTdG9yeUVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdub3RFZGl0YWJsZScsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYnVpbGRBZGFwdGF0aW9uSW50ZXJmYWNlKHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZXMsIGV2ZW50cywgYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSwgbWV0YUluZm8pIHtcclxuICAgICAgICBjb25zdCBkaXYgPSBjbGVhckVsKGdldEVsKCdwZXJzb25hbFN0b3JpZXMnKSk7XHJcbiAgICAgICAgaWYoZXZlbnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBhbGVydCA9IHFtdGUoJy5hbGVydC1ibG9jay10bXBsJyk7XHJcbiAgICAgICAgICAgIGFkZEVsKGFsZXJ0LCBtYWtlVGV4dChMMTBuLmdldCgnYWR2aWNlcycsICduby1ldmVudHMtaW4tc3RvcnknKSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhhbGVydCwgJ21hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICBhZGRFbChkaXYsIGFsZXJ0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYoY2hhcmFjdGVyTmFtZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFsZXJ0ID0gcW10ZSgnLmFsZXJ0LWJsb2NrLXRtcGwnKTtcclxuICAgICAgICAgICAgYWRkRWwoYWxlcnQsIG1ha2VUZXh0KEwxMG4uZ2V0KCdhZHZpY2VzJywgJ25vLWNoYXJhY3RlcnMtaW4tc3RvcnknKSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhhbGVydCwgJ21hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICBhZGRFbChkaXYsIGFsZXJ0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYWRhcHRhdGlvbnNOdW0gPSBSLmZsYXR0ZW4oZXZlbnRzLm1hcChldmVudCA9PiBSLmtleXMoZXZlbnQuY2hhcmFjdGVycykpKS5sZW5ndGg7XHJcbiAgICAgICAgaWYoYWRhcHRhdGlvbnNOdW0gPT09IDApIHtcclxuICAgICAgICAgICAgY29uc3QgYWxlcnQgPSBxbXRlKCcuYWxlcnQtYmxvY2stdG1wbCcpO1xyXG4gICAgICAgICAgICBhZGRFbChhbGVydCwgbWFrZVRleHQoTDEwbi5nZXQoJ2FkdmljZXMnLCAnbm8tYWRhcHRhdGlvbnMtaW4tc3RvcnknKSkpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhhbGVydCwgJ21hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICBhZGRFbChkaXYsIGFsZXJ0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgYWRkRWxzKGRpdiwgZXZlbnRzLm1hcCgoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gcW10ZShgJHtyb290fSAuYWRhcHRhdGlvbi1yb3ctdG1wbGApO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhyb3csIGAke2V2ZW50LmluZGV4fS1kZXBlbmRlbnRgKTtcclxuICAgICAgICAgICAgcm93LmRlcGVuZHNPbkNoYXJhY3RlcnMgPSBSLmtleXMoZXZlbnQuY2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcuZXZlbnRNYWluUGFuZWxSb3ctbGVmdCcpLCBleHBvcnRzLm1ha2VPcmlnaW5DYXJkKGV2ZW50LCBtZXRhSW5mbywgc3RvcnlOYW1lLCB7XHJcblxyXG4gICAgICAgICAgICAgICAgc2hvd1RpbWVJbnB1dDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHNob3dUZXh0SW5wdXQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBjYXJkVGl0bGU6IGV2ZW50Lm5hbWVcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBhZGRFbHMocWVlKHJvdywgJy5ldmVudHMtZXZlbnRzQ29udGFpbmVyJyksIGNoYXJhY3Rlck5hbWVzXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGNoYXJhY3Rlck5hbWUgPT4gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXSlcclxuICAgICAgICAgICAgICAgIC5tYXAoKGNoYXJhY3Rlck5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0VkaXRhYmxlID0gYXJlQWRhcHRhdGlvbnNFZGl0YWJsZVtgJHtzdG9yeU5hbWV9LSR7Y2hhcmFjdGVyTmFtZX1gXTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5tYWtlQWRhcHRhdGlvbkNhcmQoaXNFZGl0YWJsZSwgZXZlbnQsIHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93RmluaXNoZWRCdXR0b246IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dUaW1lSW5wdXQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dUZXh0SW5wdXQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhcmRUaXRsZTogY2hhcmFjdGVyTmFtZVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJvdztcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlT3JpZ2luQ2FyZCA9IChldmVudCwgbWV0YUluZm8sIHN0b3J5TmFtZSwgb3B0cykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNhcmQgPSBxbXRlKGAke3Jvb3R9IC5vcmlnaW4tdG1wbGApO1xyXG4gICAgICAgIGFkZEVsKHFlZShjYXJkLCAnLmNhcmQtdGl0bGUnKSwgbWFrZVRleHQob3B0cy5jYXJkVGl0bGUpKTtcclxuICAgICAgICBjb25zdCB0ZXh0SW5wdXQgPSBxZWUoY2FyZCwgJy50ZXh0LWlucHV0Jyk7XHJcbiAgICAgICAgY29uc3QgdGltZUlucHV0ID0gcWVlKGNhcmQsICcudGltZS1pbnB1dCcpO1xyXG4gICAgICAgIGNvbnN0IGxvY2tCdXR0b24gPSBxZWUoY2FyZCwgJ2J1dHRvbi5sb2NrZWQnKTtcclxuXHJcbiAgICAgICAgaWYgKG9wdHMuc2hvd1RpbWVJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBVSS5tYWtlRXZlbnRUaW1lUGlja2VyMih0aW1lSW5wdXQsIHtcclxuICAgICAgICAgICAgICAgIGV2ZW50VGltZTogZXZlbnQudGltZSxcclxuICAgICAgICAgICAgICAgIGluZGV4OiBldmVudC5pbmRleCxcclxuICAgICAgICAgICAgICAgIHByZUdhbWVEYXRlOiBtZXRhSW5mby5wcmVHYW1lRGF0ZSxcclxuICAgICAgICAgICAgICAgIGRhdGU6IG1ldGFJbmZvLmRhdGUsXHJcbiAgICAgICAgICAgICAgICBvbkNoYW5nZURhdGVUaW1lQ3JlYXRvcjogb25DaGFuZ2VEYXRlVGltZUNyZWF0b3Ioc3RvcnlOYW1lKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0aW1lSW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dUZXh0SW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgdGV4dElucHV0LnZhbHVlID0gZXZlbnQudGV4dDtcclxuICAgICAgICAgICAgdGV4dElucHV0LmRhdGFLZXkgPSBKU09OLnN0cmluZ2lmeShbc3RvcnlOYW1lLCBldmVudC5pbmRleF0pO1xyXG4gICAgICAgICAgICBsaXN0ZW4odGV4dElucHV0LCAnY2hhbmdlJywgb25DaGFuZ2VPcmlnaW5UZXh0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0ZXh0SW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dMb2NrQnV0dG9uID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgIGxpc3Rlbihsb2NrQnV0dG9uLCAnY2xpY2snLCBvbk9yaWdpbkxvY2tDbGljayh0aW1lSW5wdXQsIHRleHRJbnB1dCkpO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbCh0aW1lSW5wdXQsIGZhbHNlKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGV4dElucHV0LCBmYWxzZSk7XHJcbiAgICAgICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoY2FyZCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3MobG9ja0J1dHRvbiwgJ2hpZGRlbicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNhcmQ7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uT3JpZ2luTG9ja0NsaWNrKHRpbWVJbnB1dCwgdGV4dElucHV0KSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB7IHRhcmdldCB9ID0gZXZlbnQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzTG9ja2VkID0gaGFzQ2xhc3ModGFyZ2V0LCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbih0YXJnZXQsICdidG4tcHJpbWFyeScsICFpc0xvY2tlZCk7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGFyZ2V0LCAnbG9ja2VkJywgIWlzTG9ja2VkKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbih0YXJnZXQsICd1bmxvY2tlZCcsIGlzTG9ja2VkKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwodGltZUlucHV0LCBpc0xvY2tlZCk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHRleHRJbnB1dCwgaXNMb2NrZWQpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlQWRhcHRhdGlvbkNhcmQgPSBSLmN1cnJ5KChpc0VkaXRhYmxlLCBldmVudCwgc3RvcnlOYW1lLCBjaGFyYWN0ZXJOYW1lLCBvcHRzKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY2FyZCA9IHFtdGUoYCR7cm9vdH0gLmFkYXB0YXRpb24tdG1wbGApO1xyXG4gICAgICAgIHNldEF0dHIoY2FyZCwgJ2RlcGVuZGVudC1vbi1jaGFyYWN0ZXInLCBjaGFyYWN0ZXJOYW1lKTtcclxuXHJcbiAgICAgICAgYWRkRWwocWVlKGNhcmQsICcuY2FyZC10aXRsZScpLCBtYWtlVGV4dChvcHRzLmNhcmRUaXRsZSkpO1xyXG4gICAgICAgIGNvbnN0IHRleHRJbnB1dCA9IHFlZShjYXJkLCAnLnRleHQtaW5wdXQnKTtcclxuICAgICAgICBjb25zdCB0aW1lSW5wdXQgPSBxZWUoY2FyZCwgJy50aW1lLWlucHV0Jyk7XHJcbiAgICAgICAgY29uc3QgZmluaXNoZWRCdXR0b24gPSBxZWUoY2FyZCwgJ2J1dHRvbi5maW5pc2hlZCcpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gSlNPTi5zdHJpbmdpZnkoW3N0b3J5TmFtZSwgZXZlbnQuaW5kZXgsIGNoYXJhY3Rlck5hbWVdKTtcclxuXHJcbiAgICAgICAgaWYgKG9wdHMuc2hvd1RpbWVJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBVSS5wb3B1bGF0ZUFkYXB0YXRpb25UaW1lSW5wdXQodGltZUlucHV0LCBzdG9yeU5hbWUsIGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBpc0VkaXRhYmxlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0aW1lSW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dUZXh0SW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbih0ZXh0SW5wdXQsICdub3RFZGl0YWJsZScsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICAgICAgdGV4dElucHV0LnZhbHVlID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS50ZXh0O1xyXG4gICAgICAgICAgICB0ZXh0SW5wdXQuZGF0YUtleSA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgICAgIGxpc3Rlbih0ZXh0SW5wdXQsICdjaGFuZ2UnLCBvbkNoYW5nZUFkYXB0YXRpb25UZXh0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0ZXh0SW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzLnNob3dGaW5pc2hlZEJ1dHRvbiA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCBpc0ZpbmlzaGVkID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS5yZWFkeTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihmaW5pc2hlZEJ1dHRvbiwgJ25vdEVkaXRhYmxlJywgIWlzRWRpdGFibGUpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0lmKGZpbmlzaGVkQnV0dG9uLCAnYnRuLXByaW1hcnknLCBpc0ZpbmlzaGVkKTtcclxuICAgICAgICAgICAgZmluaXNoZWRCdXR0b24uaWQgPSBpZDtcclxuICAgICAgICAgICAgY29uc3QgZW5hYmxlSW5wdXRzID0gKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbCh0ZXh0SW5wdXQsICF2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbCh0aW1lSW5wdXQsICF2YWx1ZSk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGVuYWJsZUlucHV0cyhpc0ZpbmlzaGVkKTtcclxuICAgICAgICAgICAgbGlzdGVuKGZpbmlzaGVkQnV0dG9uLCAnY2xpY2snLCBVSS5vbkNoYW5nZUFkYXB0YXRpb25SZWFkeVN0YXR1czIoZW5hYmxlSW5wdXRzKSk7XHJcbiAgICAgICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoY2FyZCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoZmluaXNoZWRCdXR0b24sICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjYXJkO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIG9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yID0gUi5jdXJyeSgoc3RvcnlOYW1lLCBteUlucHV0KSA9PiAoZHAsIGlucHV0KSA9PiB7XHJcbiAgICAgICAgREJNUy5zZXRFdmVudE9yaWdpblByb3BlcnR5KHN0b3J5TmFtZSwgbXlJbnB1dC5ldmVudEluZGV4LCAndGltZScsIGlucHV0LnZhbCgpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MobXlJbnB1dCwgJ2RlZmF1bHREYXRlJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBvbkNoYW5nZU9yaWdpblRleHQoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBkYXRhS2V5ID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQuZGF0YUtleSk7XHJcbiAgICAgICAgY29uc3QgdGV4dCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBEQk1TLnNldEV2ZW50T3JpZ2luUHJvcGVydHkoZGF0YUtleVswXSwgZGF0YUtleVsxXSwgJ3RleHQnLCB0ZXh0LCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFuZ2VBZGFwdGF0aW9uVGV4dChldmVudCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGFLZXkgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC5kYXRhS2V5KTtcclxuICAgICAgICBjb25zdCB0ZXh0ID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgIERCTVMuc2V0RXZlbnRBZGFwdGF0aW9uUHJvcGVydHkoZGF0YUtleVswXSwgZGF0YUtleVsxXSwgZGF0YUtleVsyXSwgJ3RleHQnLCB0ZXh0LCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0SWNvbkNsYXNzKG9iamVjdCkge1xyXG4gICAgICAgIGlmIChvYmplY3QuaXNFbXB0eSkgcmV0dXJuICdmYS1pY29uIGVtcHR5IHNlbGVjdC1pY29uLXBhZGRpbmcnO1xyXG4gICAgICAgIGlmIChvYmplY3QuaXNGaW5pc2hlZCkgcmV0dXJuICdmYS1pY29uIGZpbmlzaGVkIHNlbGVjdC1pY29uLXBhZGRpbmcnO1xyXG4gICAgICAgIHJldHVybiAnZmEtaWNvbiBmaW5pc2hlZCB0cmFuc3BhcmVudC1pY29uIHNlbGVjdC1pY29uLXBhZGRpbmcnO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVNldHRpbmdzKG5hbWUsIHZhbHVlKSB7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBEQk1TLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgc2V0dGluZ3MuQWRhcHRhdGlvbnNbbmFtZV0gPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTZWxlY3RlZFN0b3J5TmFtZShzdG9yeU5hbWVzKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlOYW1lc09ubHkgPSBzdG9yeU5hbWVzLm1hcChSLnByb3AoJ3N0b3J5TmFtZScpKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBEQk1TLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgaWYgKCFzZXR0aW5ncy5BZGFwdGF0aW9ucykge1xyXG4gICAgICAgICAgICBzZXR0aW5ncy5BZGFwdGF0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgIHN0b3J5TmFtZTogc3RvcnlOYW1lc09ubHlbMF0sXHJcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJOYW1lczogbnVsbCxcclxuICAgICAgICAgICAgICAgIGV2ZW50SW5kZXhlczogbnVsbCxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkRmlsdGVyOiAnYWRhcHRhdGlvbkZpbHRlckJ5Q2hhcmFjdGVyJ1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgeyBzdG9yeU5hbWUgfSA9IHNldHRpbmdzLkFkYXB0YXRpb25zO1xyXG4gICAgICAgIGlmIChzdG9yeU5hbWVzT25seS5pbmRleE9mKHN0b3J5TmFtZSkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xyXG4gICAgICAgICAgICBzZXR0aW5ncy5BZGFwdGF0aW9ucy5zdG9yeU5hbWUgPSBzdG9yeU5hbWVzT25seVswXTtcclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1kZXN0cnVjdHVyaW5nXHJcbiAgICAgICAgICAgIHN0b3J5TmFtZSA9IHN0b3J5TmFtZXNPbmx5WzBdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RvcnlOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldE5hbWVzKG5hbWVPYmplY3RBcnJheSwgbmFtZU9iamVjdFByb3BlcnR5LCBzZXR0aW5nc1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgbmFtZXNPbmx5ID0gbmFtZU9iamVjdEFycmF5Lm1hcChSLnByb3AobmFtZU9iamVjdFByb3BlcnR5KSk7XHJcbiAgICAgICAgY29uc3QgbmFtZXMgPSBEQk1TLmdldFNldHRpbmdzKCkuQWRhcHRhdGlvbnNbc2V0dGluZ3NQcm9wZXJ0eV07XHJcbiAgICAgICAgbGV0IGV4aXN0aW5nTmFtZXM7XHJcbiAgICAgICAgaWYgKG5hbWVzID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGV4aXN0aW5nTmFtZXMgPSBuYW1lc09ubHk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZXhpc3RpbmdOYW1lcyA9IG5hbWVzLmZpbHRlcihuYW1lID0+IG5hbWVzT25seS5pbmRleE9mKG5hbWUpICE9PSAtMSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB1cGRhdGVTZXR0aW5ncyhzZXR0aW5nc1Byb3BlcnR5LCBleGlzdGluZ05hbWVzKTtcclxuICAgICAgICByZXR1cm4gZXhpc3RpbmdOYW1lcztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRDaGFyYWN0ZXJOYW1lcyhjaGFyYWN0ZXJBcnJheSkge1xyXG4gICAgICAgIHJldHVybiBnZXROYW1lcyhjaGFyYWN0ZXJBcnJheSwgJ2NoYXJhY3Rlck5hbWUnLCAnY2hhcmFjdGVyTmFtZXMnKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRFdmVudEluZGV4ZXMoZXZlbnRBcnJheSkge1xyXG4gICAgICAgIHJldHVybiBnZXROYW1lcyhldmVudEFycmF5LCAnaW5kZXgnLCAnZXZlbnRJbmRleGVzJyk7XHJcbiAgICB9XHJcbn0pKHRoaXMuQWRhcHRhdGlvbnMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5icmllZmluZy1leHBvcnQtdGFiICc7XHJcblxyXG4gICAgc3RhdGUudGVtcGxhdGVzID0ge307XHJcbiAgICBzdGF0ZS5jdXN0b21Eb2N4VGVtcGxhdGUgPSBudWxsO1xyXG5cclxuICAgIGxldCBnZW5lcmF0ZVNpbmdsZURvY3gsIGdlbmVyYXRlU2luZ2xlVHh0LCByZWZyZXNoU3RvcnlTZXRTZWxlY3QsIHJlZnJlc2hDaGFyYWN0ZXJTZXRTZWxlY3Q7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4vLyAgICAgICAgbGlzdGVuKGdldEVsKCdtYWtlRGVmYXVsdFRleHRCcmllZmluZ3MnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4vLyAgICAgICAgICAgIHJlc29sdmVUZXh0VGVtcGxhdGUoKHRleHRUZW1wbGF0ZSkgPT4ge1xyXG4vLyAgICAgICAgICAgICAgICBtYWtlVGV4dEJyaWVmaW5ncygndHh0JywgZ2VuZXJhdGVTaW5nbGVUeHQodGV4dFRlbXBsYXRlKSk7XHJcbi8vICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdtYWtlQ3VzdG9tVGV4dEJyaWVmaW5ncycpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1ha2VUZXh0QnJpZWZpbmdzKGdldEVsKCd0ZXh0VHlwZVNlbGVjdG9yJykudmFsdWUsIGdlbmVyYXRlU2luZ2xlVHh0KGdldEVsKCd0ZW1wbGF0ZUFyZWEnKS52YWx1ZSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnbWFrZU1hcmtkb3duQnJpZWZpbmdzJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgbWFrZVRleHRCcmllZmluZ3MoJ2h0bWwnLCBSLmNvbXBvc2UoZGF0YSA9PiBtYXJrZG93bml0KCdjb21tb25tYXJrJykucmVuZGVyKGRhdGEpLCBnZW5lcmF0ZVNpbmdsZVR4dChnZXRFbCgndGVtcGxhdGVBcmVhJykudmFsdWUpKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZG9jeEJyaWVmaW5ncycpLCAnY2hhbmdlJywgcmVhZFRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdkb2N4QnJpZWZpbmdzJyksICdmb2N1cycsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGUudGFyZ2V0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIHN0YXRlLmN1c3RvbURvY3hUZW1wbGF0ZSA9IG51bGw7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnbWFrZURvY3hCcmllZmluZ3MnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc3RhdGUuY3VzdG9tRG9jeFRlbXBsYXRlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdicmllZmluZ3MtY3VzdG9tLWRvY3gtdGVtcGxhdGUtaXMtbWlzc2luZycpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGV4cG9ydERvY3hCeVRlbXBsYXRlKHN0YXRlLmN1c3RvbURvY3hUZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIGxldCBlbHMgPSBxdWVyeUVsRWxzKGRvY3VtZW50LCBgJHtyb290fSBpbnB1dFtuYW1lPWV4cG9ydENoYXJhY3RlclNlbGVjdGlvbl1gKTtcclxuICAgICAgICBlbHMubWFwKGxpc3RlbihSLl9fLCAnY2hhbmdlJywgb25DaGFyYWN0ZXJTZWxlY3Rpb25DaGFuZ2UpKTtcclxuICAgICAgICBnZXRFbCgnZXhwb3J0QWxsQ2hhcmFjdGVycycpLmNoZWNrZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICBlbHMgPSBxdWVyeUVsRWxzKGRvY3VtZW50LCBgJHtyb290fSBpbnB1dFtuYW1lPWV4cG9ydFN0b3J5U2VsZWN0aW9uXWApO1xyXG4gICAgICAgIGVscy5tYXAobGlzdGVuKFIuX18sICdjaGFuZ2UnLCBvblN0b3J5U2VsZWN0aW9uQ2hhbmdlKSk7XHJcbiAgICAgICAgZ2V0RWwoJ2V4cG9ydEFsbFN0b3JpZXMnKS5jaGVja2VkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgY29uc3QgZWwgPSBnZXRFbCgnYnJpZWZpbmdOdW1iZXJTZWxlY3RvcicpO1xyXG4gICAgICAgIENvbnN0YW50cy5icmllZmluZ051bWJlci5mb3JFYWNoKFIuY29tcG9zZShhZGRFbChlbCksIG1ha2VPcHQpKTtcclxuICAgICAgICBsaXN0ZW4oZWwsICdjaGFuZ2UnLCByZWZyZXNoQ2hhcmFjdGVyUmFuZ2VTZWxlY3QpO1xyXG5cclxuICAgICAgICBzdGF0ZS5icmllZmluZ051bWJlclNlbGVjdG9yID0gZWw7XHJcbiAgICAgICAgc3RhdGUuYnJpZWZpbmdJbnRlcnZhbFNlbGVjdG9yID0gZ2V0RWwoJ2JyaWVmaW5nSW50ZXJ2YWxTZWxlY3RvcicpO1xyXG4gICAgICAgIHN0YXRlLmNoYXJhY3RlclNldFNlbGVjdG9yID0gZ2V0RWwoJ2NoYXJhY3RlclNldFNlbGVjdG9yJyk7XHJcbiAgICAgICAgc3RhdGUuc3RvcnlTZXRTZWxlY3RvciA9IGdldEVsKCdzdG9yeVNldFNlbGVjdG9yJyk7XHJcblxyXG4gICAgICAgIGdldEVsKCdtYWtlQnJpZWZpbmdzQnlUaW1lICcudHJpbSgpKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG1ha2VFeHBvcnQoJ3RlbXBsYXRlQnlUaW1lJykpO1xyXG4gICAgICAgIGdldEVsKCdtYWtlQnJpZWZpbmdzQnlTdG9yeScudHJpbSgpKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG1ha2VFeHBvcnQoJ3RlbXBsYXRlQnlTdG9yeScpKTtcclxuICAgICAgICBnZXRFbCgnbWFrZUludmVudG9yeUxpc3QgICAnLnRyaW0oKSkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBtYWtlRXhwb3J0KCdpbnZlbnRvcnlUZW1wbGF0ZScpKTtcclxuXHJcbiAgICAgICAgVUkuaW5pdFRhYlBhbmVsKCdleHBvcnRNb2RlQnV0dG9uJywgJ2V4cG9ydENvbnRhaW5lcicpO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ3ByZXZpZXdUZXh0T3V0cHV0JyksICdjbGljaycsIHByZXZpZXdUZXh0T3V0cHV0KTtcclxuICAgICAgICBnZXRFbCgndGV4dEJyaWVmaW5nUHJldmlld0FyZWEnKS52YWx1ZSA9ICcnO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ3Nob3dSYXdEYXRhJyksICdjbGljaycsIHByZXZpZXdUZXh0RGF0YUFzSXMpO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2NvbnZlcnRUb0RvY3hUZW1wbGF0ZScpLCAnY2xpY2snLCBjb252ZXJ0VG9Eb2N4VGVtcGxhdGUpO1xyXG4gICAgICAgIGxpc3RlbihnZXRFbCgnZ2VuZXJhdGVCeURvY3hUZW1wbGF0ZScpLCAnY2xpY2snLCBnZW5lcmF0ZUJ5RG9jeFRlbXBsYXRlKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIHJlc29sdmVUZXh0VGVtcGxhdGUoKHRleHRUZW1wbGF0ZSkgPT4ge1xyXG4gICAgICAgICAgICBnZXRFbCgndGVtcGxhdGVBcmVhJykudmFsdWUgPSB0ZXh0VGVtcGxhdGU7XHJcbiAgICAgICAgICAgIHJlZnJlc2hDaGFyYWN0ZXJSYW5nZVNlbGVjdCgpO1xyXG4gICAgICAgICAgICByZWZyZXNoQ2hhcmFjdGVyU2V0U2VsZWN0KCk7XHJcbiAgICAgICAgICAgIHJlZnJlc2hTdG9yeVNldFNlbGVjdCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZXNvbHZlVGV4dFRlbXBsYXRlKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdjaGFyYWN0ZXInLCAoZXJyLCBwcm9maWxlU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc3QgZnVuYyA9IFIuY29tcG9zZShSLmpvaW4oJycpLCBSLmluc2VydCgxLCBSLl9fLCBbJ3t7cHJvZmlsZUluZm8tJywgJ319XFxuJ10pLCBSLnByb3AoJ25hbWUnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlciA9IFIuY29tcG9zZShSLmVxdWFscyh0cnVlKSwgUi5wcm9wKCdkb0V4cG9ydCcpKTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBwcm9maWxlU2V0dGluZ3MuZmlsdGVyKGZpbHRlcikubWFwKGZ1bmMpLmpvaW4oJycpO1xyXG5cclxuICAgICAgICAgICAgY2FsbGJhY2soUi5yZXBsYWNlKC9cXHswXFx9L2csIHZhbHVlLCBURVhUX1RFTVBMQVRFKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFyYWN0ZXJTZWxlY3Rpb25DaGFuZ2UoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBleHBvcnRDaGFyYWN0ZXJSYW5nZSA9IGV2ZW50LnRhcmdldC5pZCA9PT0gJ2V4cG9ydENoYXJhY3RlclJhbmdlJztcclxuICAgICAgICBjb25zdCBleHBvcnRDaGFyYWN0ZXJTZXQgPSBldmVudC50YXJnZXQuaWQgPT09ICdleHBvcnRDaGFyYWN0ZXJTZXQnO1xyXG4gICAgICAgIGhpZGVFbChnZXRFbCgnY2hhcmFjdGVyUmFuZ2VTZWxlY3QnKSwgIWV4cG9ydENoYXJhY3RlclJhbmdlKTtcclxuICAgICAgICBoaWRlRWwoZ2V0RWwoJ2NoYXJhY3RlclNldFNlbGVjdCcpLCAhZXhwb3J0Q2hhcmFjdGVyU2V0KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblN0b3J5U2VsZWN0aW9uQ2hhbmdlKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3QgZXhwb3J0U3RvcnlTZXQgPSBldmVudC50YXJnZXQuaWQgPT09ICdleHBvcnRTdG9yeVNldCc7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCdzdG9yeVNldFNlbGVjdCcpLCAhZXhwb3J0U3RvcnlTZXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFNlbGVjdGVkVXNlcnMoKSB7XHJcbiAgICAgICAgY29uc3QgeyBpZCB9ID0gZ2V0U2VsZWN0ZWRSYWRpbyhxZShyb290KSwgJ2lucHV0W25hbWU9ZXhwb3J0Q2hhcmFjdGVyU2VsZWN0aW9uXScpO1xyXG4gICAgICAgIHN3aXRjaCAoaWQpIHtcclxuICAgICAgICBjYXNlICdleHBvcnRBbGxDaGFyYWN0ZXJzJzpcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgY2FzZSAnZXhwb3J0Q2hhcmFjdGVyUmFuZ2UnOlxyXG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzdGF0ZS5icmllZmluZ0ludGVydmFsU2VsZWN0b3Iuc2VsZWN0ZWRPcHRpb25zWzBdLnZhbHVlKTtcclxuICAgICAgICBjYXNlICdleHBvcnRDaGFyYWN0ZXJTZXQnOlxyXG4gICAgICAgICAgICByZXR1cm4gbmwyYXJyYXkoc3RhdGUuY2hhcmFjdGVyU2V0U2VsZWN0b3Iuc2VsZWN0ZWRPcHRpb25zKS5tYXAob3B0ID0+IG9wdC52YWx1ZSk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoYHVuZXhwZWN0ZWQgaWQ6ICR7aWR9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFNlbGVjdGVkU3RvcmllcygpIHtcclxuICAgICAgICBjb25zdCB7IGlkIH0gPSBnZXRTZWxlY3RlZFJhZGlvKHFlKHJvb3QpLCAnaW5wdXRbbmFtZT1leHBvcnRTdG9yeVNlbGVjdGlvbl0nKTtcclxuICAgICAgICBzd2l0Y2ggKGlkKSB7XHJcbiAgICAgICAgY2FzZSAnZXhwb3J0QWxsU3Rvcmllcyc6XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIGNhc2UgJ2V4cG9ydFN0b3J5U2V0JzpcclxuICAgICAgICAgICAgcmV0dXJuIG5sMmFycmF5KHN0YXRlLnN0b3J5U2V0U2VsZWN0b3Iuc2VsZWN0ZWRPcHRpb25zKS5tYXAob3B0ID0+IG9wdC52YWx1ZSk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoYHVuZXhwZWN0ZWQgaWQ6ICR7aWR9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hDaGFyYWN0ZXJSYW5nZVNlbGVjdCgpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IGNsZWFyRWwoc3RhdGUuYnJpZWZpbmdJbnRlcnZhbFNlbGVjdG9yKTtcclxuICAgICAgICBjb25zdCBudW0gPSBOdW1iZXIoc3RhdGUuYnJpZWZpbmdOdW1iZXJTZWxlY3Rvci52YWx1ZSk7XHJcblxyXG4gICAgICAgIGxldCBjaHVua3M7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyLCBuYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY2h1bmtzID0gUi5zcGxpdEV2ZXJ5KG51bSwgbmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGNodW5rcy5tYXAoY2h1bmsgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogSlNPTi5zdHJpbmdpZnkoY2h1bmsubWFwKG5hbWVJbmZvID0+IG5hbWVJbmZvLnZhbHVlKSksXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogY2h1bmsubGVuZ3RoID09PSAxID8gY2h1bmtbMF0uZGlzcGxheU5hbWUgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtjaHVua1swXS5kaXNwbGF5TmFtZX0gLSAke2NodW5rW2NodW5rLmxlbmd0aCAtIDFdLmRpc3BsYXlOYW1lfWBcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgICAgICAgICAkKGAjJHtzdGF0ZS5icmllZmluZ0ludGVydmFsU2VsZWN0b3IuaWR9YCkuc2VsZWN0Mih7IGRhdGEgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaFNldFNlbGVjdChlbnRpdHlUeXBlLCBzZWxlY3Rvck5hbWUpIHtcclxuICAgICAgICBjb25zdCBtdWx0aVNlbCA9IGNsZWFyRWwoc3RhdGVbc2VsZWN0b3JOYW1lXSk7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoZW50aXR5VHlwZSwgZmFsc2UsIChlcnIsIG5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGlmIChuYW1lcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IobXVsdGlTZWwsIG5hbWVzLm1hcChyZW1hcFByb3BzNFNlbGVjdCkpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihtdWx0aVNlbCwgJ3NpemUnLCBuYW1lcy5sZW5ndGggPiAxNSA/IDE1IDogbmFtZXMubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZnJlc2hTdG9yeVNldFNlbGVjdCA9ICgpID0+IHJlZnJlc2hTZXRTZWxlY3QoJ3N0b3J5JywgJ3N0b3J5U2V0U2VsZWN0b3InKTtcclxuICAgIHJlZnJlc2hDaGFyYWN0ZXJTZXRTZWxlY3QgPSAoKSA9PiByZWZyZXNoU2V0U2VsZWN0KCdjaGFyYWN0ZXInLCAnY2hhcmFjdGVyU2V0U2VsZWN0b3InKTtcclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlRXhwb3J0KHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXN0YXRlLnRlbXBsYXRlc1t0eXBlXSkge1xyXG4gICAgICAgICAgICAgICAgc3RhdGUudGVtcGxhdGVzW3R5cGVdID0gYXRvYih0ZW1wbGF0ZXNBcnJbdHlwZV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGV4cG9ydERvY3hCeVRlbXBsYXRlKHN0YXRlLnRlbXBsYXRlc1t0eXBlXSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwb3N0cHJvY2Vzc0NoZWNrYm94ZXMoYnJpZWZpbmdEYXRhLCBwcm9maWxlU3RydWN0dXJlLCBwcmVmaXgsIGFyck5hbWUpIHtcclxuICAgICAgICBjb25zdCBjaGVja2JveE5hbWVzID0gcHJvZmlsZVN0cnVjdHVyZS5maWx0ZXIoaXRlbSA9PiBpdGVtLnR5cGUgPT09ICdjaGVja2JveCcpLm1hcChSLnByb3AoJ25hbWUnKSk7XHJcbiAgICAgICAgYnJpZWZpbmdEYXRhLmJyaWVmaW5ncy5mb3JFYWNoKChjaGFyRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY2hhckRhdGFbYXJyTmFtZV0gPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBjaGFyRGF0YVthcnJOYW1lXS5mb3JFYWNoKChlbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tib3hOYW1lcy5pbmRleE9mKGVsZW1lbnQuaXRlbU5hbWUpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSBjb25zdEwxMG4oQ29uc3RhbnRzW2VsZW1lbnQudmFsdWVdKTtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNwbGl0dGVkVGV4dCA9IFt7IHN0cmluZzogZWxlbWVudC52YWx1ZSB9XTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNoZWNrYm94TmFtZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY2hhckRhdGFbcHJlZml4ICsgbmFtZV0gPSBjb25zdEwxMG4oQ29uc3RhbnRzW2NoYXJEYXRhW3ByZWZpeCArIG5hbWVdXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEJyaWVmaW5nRGF0YShjYWxsYmFjaykge1xyXG4gICAgICAgIERCTVMuZ2V0QnJpZWZpbmdEYXRhKGdldFNlbGVjdGVkVXNlcnMoKSwgZ2V0U2VsZWN0ZWRTdG9yaWVzKCksIGdldEVsKCdleHBvcnRPbmx5RmluaXNoZWRTdG9yaWVzJykuY2hlY2tlZCwgKGVyciwgYnJpZWZpbmdEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIC8vIHNvbWUgcG9zdHByb2Nlc3NpbmdcclxuICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdjaGFyYWN0ZXInLCAoZXJyMiwgY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdwbGF5ZXInLCAoZXJyMywgcGxheWVyUHJvZmlsZVN0cnVjdHVyZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBwb3N0cHJvY2Vzc0NoZWNrYm94ZXMoYnJpZWZpbmdEYXRhLCBjaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLCAncHJvZmlsZUluZm8tJywgJ3Byb2ZpbGVJbmZvQXJyYXknKTtcclxuICAgICAgICAgICAgICAgICAgICBwb3N0cHJvY2Vzc0NoZWNrYm94ZXMoYnJpZWZpbmdEYXRhLCBwbGF5ZXJQcm9maWxlU3RydWN0dXJlLCAncGxheWVySW5mby0nLCAncGxheWVySW5mb0FycmF5Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgYnJpZWZpbmdEYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBleHBvcnREb2N4QnlUZW1wbGF0ZSh0ZW1wbGF0ZSkge1xyXG4gICAgICAgIGdldEJyaWVmaW5nRGF0YSgoZXJyLCBicmllZmluZ0RhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZ2VuZXJhdGVCcmllZmluZ3MoYnJpZWZpbmdEYXRhLCAnZG9jeCcsIGdlbmVyYXRlU2luZ2xlRG9jeCgnYmxvYicsIHRlbXBsYXRlKSwgZ2VuZXJhdGVTaW5nbGVEb2N4KCdVaW50OEFycmF5JywgdGVtcGxhdGUpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjb252ZXJ0VG9Eb2N4VGVtcGxhdGUoKSB7XHJcbiAgICAgICAgY29uc3QgZG9jeFRlbXBsYXRlID0gbWFrZURvY3hUZW1wbGF0ZSgnYmxvYicpO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oZ2V0TDEwbignYnJpZWZpbmdzLXNhdmUtZmlsZScpLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHNhdmVBcyhkb2N4VGVtcGxhdGUsIEZpbGVVdGlscy5tYWtlRmlsZU5hbWUoJ3RlbXBsYXRlJywgJ2RvY3gnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2VuZXJhdGVCeURvY3hUZW1wbGF0ZSgpIHtcclxuICAgICAgICBleHBvcnREb2N4QnlUZW1wbGF0ZShtYWtlRG9jeFRlbXBsYXRlKCdVaW50OEFycmF5JykpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VEb2N4VGVtcGxhdGUodHlwZSkge1xyXG4gICAgICAgIGxldCB0ZW1wbGF0ZSA9IGdldEVsKCd0ZW1wbGF0ZUFyZWEnKS52YWx1ZTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVwbGFjZUJyYWNrZXRzID0gUi5waXBlKFIucmVwbGFjZSgve3t7L2csICd7JyksIFIucmVwbGFjZSgvfX19L2csICd9JyksIFIucmVwbGFjZSgve3svZywgJ3snKSwgUi5yZXBsYWNlKC99fS9nLCAnfScpKTtcclxuICAgICAgICB0ZW1wbGF0ZSA9IHJlcGxhY2VCcmFja2V0cyh0ZW1wbGF0ZSkuc3BsaXQoJ1xcbicpLm1hcChzdHJpbmcgPT4gKHsgc3RyaW5nIH0pKTtcclxuXHJcbiAgICAgICAgaWYgKCFzdGF0ZS50ZW1wbGF0ZXMuZ2VuZXJpY1RlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnRlbXBsYXRlcy5nZW5lcmljVGVtcGxhdGUgPSBhdG9iKHRlbXBsYXRlc0Fyci5nZW5lcmljVGVtcGxhdGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZG9jID0gbmV3IHdpbmRvdy5Eb2N4Z2VuKHN0YXRlLnRlbXBsYXRlcy5nZW5lcmljVGVtcGxhdGUpO1xyXG4gICAgICAgIGRvYy5zZXREYXRhKHtcclxuICAgICAgICAgICAgc3BsaXR0ZWRUZXh0OiB0ZW1wbGF0ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRvYy5yZW5kZXIoKTtcclxuICAgICAgICByZXR1cm4gZG9jLmdldFppcCgpLmdlbmVyYXRlKHtcclxuICAgICAgICAgICAgdHlwZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gcHJldmlld1RleHREYXRhQXNJcygpIHtcclxuICAgICAgICBnZXRCcmllZmluZ0RhdGEoKGVyciwgYnJpZWZpbmdEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGdldEVsKCd0ZXh0QnJpZWZpbmdQcmV2aWV3QXJlYScpLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoYnJpZWZpbmdEYXRhLCBudWxsLCAnICAnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwcmV2aWV3VGV4dE91dHB1dCgpIHtcclxuICAgICAgICBnZXRCcmllZmluZ0RhdGEoKGVyciwgZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBnZXRFbCgndGV4dEJyaWVmaW5nUHJldmlld0FyZWEnKS52YWx1ZSA9IGdlbmVyYXRlU2luZ2xlVHh0KGdldEVsKCd0ZW1wbGF0ZUFyZWEnKS52YWx1ZSwgZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVRleHRCcmllZmluZ3MoZmlsZVR5cGUsIGRlbGVnYXRlKSB7XHJcbiAgICAgICAgZ2V0QnJpZWZpbmdEYXRhKChlcnIsIGJyaWVmaW5nRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBnZW5lcmF0ZUJyaWVmaW5ncyhicmllZmluZ0RhdGEsIGZpbGVUeXBlLCAoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZGVsZWdhdGUoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJsb2IoW3Jlc3VsdF0sIHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAndGV4dC9wbGFpbjtjaGFyc2V0PXV0Zi04J1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sIGRlbGVnYXRlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZWFkVGVtcGxhdGVGaWxlKGV2dCkge1xyXG4gICAgICAgIC8vIFJldHJpZXZlIHRoZSBmaXJzdCAoYW5kIG9ubHkhKSBGaWxlIGZyb20gdGhlIEZpbGVMaXN0IG9iamVjdFxyXG4gICAgICAgIGNvbnN0IGYgPSBldnQudGFyZ2V0LmZpbGVzWzBdO1xyXG5cclxuICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgICBjb25zdCByID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgICAgICAgci5vbmxvYWQgPSAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuY3VzdG9tRG9jeFRlbXBsYXRlID0gZS50YXJnZXQucmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYnJpZWZpbmdzLXRlbXBsYXRlLWlzLWxvYWRlZCcpKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgci5yZWFkQXNCaW5hcnlTdHJpbmcoZik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYnJpZWZpbmdzLWVycm9yLW9uLXRlbXBsYXRlLXVwbG9hZGluZycpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlU3RhdHVzKHRleHQpIHtcclxuICAgICAgICBjb25zdCBleHBvcnRTdGF0dXMgPSBnZXRFbCgnZXhwb3J0U3RhdHVzJyk7XHJcbiAgICAgICAgY2xlYXJFbChleHBvcnRTdGF0dXMpO1xyXG4gICAgICAgIGV4cG9ydFN0YXR1cy5hcHBlbmRDaGlsZChtYWtlVGV4dCh0ZXh0KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2VuZXJhdGVCcmllZmluZ3MoYnJpZWZpbmdEYXRhLCBmaWxlVHlwZSwgb25lRmlsZURlbGVnYXRlLCBzZXBhcmF0ZUZpbGVEZWxlZ2F0ZSkge1xyXG4gICAgICAgIGNvbnN0IHRvU2VwYXJhdGVGaWxlcyA9IGdldEVsKCd0b1NlcGFyYXRlRmlsZUNoZWNrYm94JykuY2hlY2tlZDtcclxuXHJcbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSAnY2hhcmFjdGVyU2hlZXRzJztcclxuXHJcbiAgICAgICAgbGV0IG91dCwgYXJjaGl2ZTtcclxuICAgICAgICB1cGRhdGVTdGF0dXMoZ2V0TDEwbignYnJpZWZpbmdzLXNhdmUtcHJlcGFyaW5nJykpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmICh0b1NlcGFyYXRlRmlsZXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHppcCA9IG5ldyBKU1ppcCgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHppcC5nZW5lcmF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlU3RhdHVzKGdldEwxMG4oJ2JyaWVmaW5ncy1zdGFydC1zYXZpbmcnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzID0gbWFrZUFyY2hpdmVEYXRhKGJyaWVmaW5nRGF0YSwgc2VwYXJhdGVGaWxlRGVsZWdhdGUpO1xyXG4gICAgICAgICAgICAgICAgUi5rZXlzKHJlcykuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoYCR7a2V5fS4ke2ZpbGVUeXBlfWAsIHJlc1trZXldKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhnZXRMMTBuKCdicmllZmluZ3MtYXJjaGl2aW5nJykpO1xyXG4gICAgICAgICAgICAgICAgYXJjaGl2ZSA9IHppcC5nZW5lcmF0ZSh7IHR5cGU6ICdibG9iJyB9KTtcclxuICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhnZXRMMTBuKCdicmllZmluZ3MtYXJjaGl2ZS1pcy1yZWFkeScpKTtcclxuICAgICAgICAgICAgICAgIHNhdmVGaWxlKCdicmllZmluZ3Mtc2F2ZS1hcmNoaXZlJywgYXJjaGl2ZSwgZmlsZU5hbWUsICd6aXAnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhnZXRMMTBuKCdicmllZmluZ3Mtc3RhcnQtc2F2aW5nJykpO1xyXG4gICAgICAgICAgICAgICAgb3V0ID0gb25lRmlsZURlbGVnYXRlKGJyaWVmaW5nRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB1cGRhdGVTdGF0dXMoZ2V0TDEwbignYnJpZWZpbmdzLWZpbGUtaXMtcmVhZHknKSk7XHJcbiAgICAgICAgICAgICAgICBzYXZlRmlsZSgnYnJpZWZpbmdzLXNhdmUtZmlsZScsIG91dCwgZmlsZU5hbWUsIGZpbGVUeXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdicmllZmluZ3MtZXJyb3Itb24tZ2VuZXJhdGluZy1icmllZmluZ3MnKSk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNhdmVGaWxlKG1zZ0tleSwgb3V0LCBmaWxlTmFtZSwgZXh0ZW5zaW9uKSB7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShnZXRMMTBuKG1zZ0tleSksICgpID0+IHtcclxuICAgICAgICAgICAgc2F2ZUFzKG91dCwgRmlsZVV0aWxzLm1ha2VGaWxlTmFtZShmaWxlTmFtZSwgZXh0ZW5zaW9uKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUFyY2hpdmVEYXRhKGJyaWVmaW5nRGF0YSwgZ2VuZXJhdGVTaW5nbGVEZWxlZ2F0ZSkge1xyXG4gICAgICAgIGNvbnN0IHJlcyA9IHt9O1xyXG4gICAgICAgIGJyaWVmaW5nRGF0YS5icmllZmluZ3MuZm9yRWFjaCgoYnJpZWZpbmcsIGkpID0+IHtcclxuICAgICAgICAgICAgcmVzW2JyaWVmaW5nLmNoYXJOYW1lXSA9IGdlbmVyYXRlU2luZ2xlRGVsZWdhdGUoe1xyXG4gICAgICAgICAgICAgICAgZ2FtZU5hbWU6IGJyaWVmaW5nRGF0YS5nYW1lTmFtZSxcclxuICAgICAgICAgICAgICAgIGJyaWVmaW5nczogW2JyaWVmaW5nXVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdXBkYXRlU3RhdHVzKHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3Mtc2F2ZS1zdGF0dXMnKSwgW2kgKyAxLCBicmllZmluZ0RhdGEuYnJpZWZpbmdzLmxlbmd0aF0pKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG5cclxuICAgIGdlbmVyYXRlU2luZ2xlRG9jeCA9IFIuY3VycnkoKHR5cGUsIHRlbXBsYXRlLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZG9jID0gbmV3IHdpbmRvdy5Eb2N4Z2VuKHRlbXBsYXRlKTtcclxuICAgICAgICBkb2Muc2V0RGF0YShkYXRhKTtcclxuICAgICAgICBkb2MucmVuZGVyKCk7IC8vIGFwcGx5IHRoZW0gKHJlcGxhY2UgYWxsIG9jY3VyZW5jZXMgb2Yge2ZpcnN0X25hbWV9IGJ5XHJcbiAgICAgICAgLy8gSGlwcCwgLi4uKVxyXG4gICAgICAgIGNvbnN0IG91dCA9IGRvYy5nZXRaaXAoKS5nZW5lcmF0ZSh7XHJcbiAgICAgICAgICAgIHR5cGVcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gb3V0O1xyXG4gICAgfSk7XHJcblxyXG4gICAgZ2VuZXJhdGVTaW5nbGVUeHQgPSBSLmN1cnJ5KCh0ZW1wbGF0ZSwgZGF0YSkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNdXN0YWNoZS5yZW5kZXIodGVtcGxhdGUsIGRhdGEpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLXRlbXBsYXRlLWVycm9yJyksIFtlcnIubWVzc2FnZV0pKTtcclxuICAgICAgICAgICAgdGhyb3cgZXJyO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59KSh0aGlzLkJyaWVmaW5nRXhwb3J0ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgcm9vdCA9ICcjYnJpZWZpbmdQcmV2aWV3RGl2ICc7XHJcbiAgICBjb25zdCBzZXR0aW5nc1BhdGggPSAnQnJpZWZpbmdQcmV2aWV3JztcclxuICAgIGNvbnN0IGwxMG4gPSBMMTBuLmdldCgnYnJpZWZpbmdzJyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgICQoJyNicmllZmluZ0NoYXJhY3RlcicpLnNlbGVjdDIoKS5vbignY2hhbmdlJywgYnVpbGRDb250ZW50RGVsZWdhdGUpO1xyXG5cclxuICAgICAgICBsZXQgYnV0dG9uID0gZ2V0RWwoJ2V2ZW50R3JvdXBpbmdCeVN0b3J5UmFkaW8nKTtcclxuICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2hhbmdlJywgZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICBidXR0b24uY2hlY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIGJ1dHRvbiA9IGdldEVsKCdhZGFwdGF0aW9uc01vZGVSYWRpbycpO1xyXG4gICAgICAgIGxpc3RlbihidXR0b24sICdjaGFuZ2UnLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgIGJ1dHRvbi5jaGVja2VkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdldmVudEdyb3VwaW5nQnlUaW1lUmFkaW8nKSwgJ2NoYW5nZScsIGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdwcm9vZnJlYWRpbmdNb2RlUmFkaW8nKSwgJ2NoYW5nZScsIGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdoaWRlQWxsUGFuZWxzQ2hlY2tib3gnKSwgJ2NoYW5nZScsIGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdkaXNhYmxlSGVhZGVyc0NoZWNrYm94JyksICdjaGFuZ2UnLCBleHBvcnRzLnJlZnJlc2gpO1xyXG5cclxuICAgICAgICBnZXRFbCgnaGlkZUFsbFBhbmVsc0NoZWNrYm94JykuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgXHJcbi8vICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2NvbnRlbnRBcmVhJyksICdzY3JvbGwnLCB1cGRhdGVHdXR0ZXJTY3JvbGxQb3MpO1xyXG4vLyAgICAgICAgbGlzdGVuKGdldEVsKCdjb250ZW50QXJlYScpLCAncmVzaXplJywgcmVidWlsZEd1dHRlcik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaW5pdFBhbmVsc0FycigpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnYnJpZWZpbmdQcmV2aWV3RGl2Jyk7XHJcbiAgICB9O1xyXG4gICAgXHJcbi8vICAgIGZ1bmN0aW9uIHVwZGF0ZUd1dHRlclNjcm9sbFBvcyAoKXtcclxuLy8gICAgICAgIGxldCBkb2MgPSBnZXRFbCgnY29udGVudEFyZWEnKTtcclxuLy8gICAgICAgIGxldCBwb3NpdGlvbiA9IHFlKGAke3Jvb3R9IC5ndXR0ZXItc2Nyb2xsLXBvc2l0aW9uYCk7XHJcbi8vICAgICAgICBwb3NpdGlvbi5zdHlsZS50b3AgPSAoZG9jLnNjcm9sbFRvcCkvZG9jLnNjcm9sbEhlaWdodCoxMDAgKyAnJSc7XHJcbi8vICAgICAgICBwb3NpdGlvbi5zdHlsZS5oZWlnaHQgPSAoZG9jLmNsaWVudEhlaWdodCkvZG9jLnNjcm9sbEhlaWdodCoxMDAgKyAnJSc7XHJcbi8vICAgIH1cclxuLy8gICAgXHJcbi8vICAgIGZ1bmN0aW9uIHJlYnVpbGRHdXR0ZXIoKSB7XHJcbi8vICAgICAgICBsZXQgZG9jID0gZ2V0RWwoJ2NvbnRlbnRBcmVhJyk7XHJcbi8vICAgICAgICBjb25zdCBndXR0ZXIgPSBjbGVhckVsKHFlKGAke3Jvb3R9IC5ndXR0ZXJgKSk7XHJcbi8vICAgICAgICBjb25zdCBzY3JvbGxQb3MgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnZ3V0dGVyLXNjcm9sbC1wb3NpdGlvbicpO1xyXG4vLyAgICAgICAgYWRkRWwoZ3V0dGVyLCBzY3JvbGxQb3MpO1xyXG4vLyAgICAgICAgdXBkYXRlR3V0dGVyU2Nyb2xsUG9zKCk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIGNvbnN0IGJ0biA9IG1ha2VFbCgnYnV0dG9uJyk7XHJcbi8vICAgICAgICBidG4uc3R5bGUudG9wID0gJzAlJztcclxuLy8vLyAgICAgICAgY29uc3QgdGl0bGUgPSBxZWUocGFuZWwsICcucGFuZWwtdGl0bGUnKS5pbm5lckhUTUwudHJpbSgpO1xyXG4vLyAgICAgICAgc2V0QXR0cihidG4sICd0aXRsZScsIGwxMG4oJ3RvLXBhZ2UtdG9wJykpO1xyXG4vLyAgICAgICAgbGlzdGVuKGJ0biwgJ2NsaWNrJywgKCkgPT4ge1xyXG4vLyAgICAgICAgICAgIGRvYy5zY3JvbGxUb3AgPSAwO1xyXG4vLy8vICAgICAgICAgICAgcGFuZWwuc2Nyb2xsSW50b1ZpZXcoKTtcclxuLy8gICAgICAgIH0pO1xyXG4vLyAgICAgICAgYWRkRWwoZ3V0dGVyLCBidG4pO1xyXG4vLyAgICAgICAgXHJcbi8vICAgICAgICBjb25zdCBwYW5lbHMgPSBxZWVzKGRvYywgJyNicmllZmluZ0NvbnRlbnQgPiAucGFuZWwnKTtcclxuLy8gICAgICAgIGFkZEVscyhndXR0ZXIsIHBhbmVscy5tYXAocGFuZWwgPT4ge1xyXG4vLyAgICAgICAgICAgIGNvbnN0IGJ0biA9IG1ha2VFbCgnYnV0dG9uJyk7XHJcbi8vICAgICAgICAgICAgYnRuLnN0eWxlLnRvcCA9IChwYW5lbC5vZmZzZXRUb3ApL2RvYy5zY3JvbGxIZWlnaHQqMTAwICsgJyUnO1xyXG4vLyAgICAgICAgICAgIFxyXG4vLyAgICAgICAgICAgIGNvbnN0IHBhbmVsVGl0bGUgPSBxZWUocGFuZWwsICcucGFuZWwtdGl0bGUnKTtcclxuLy8gICAgICAgICAgICBjb25zdCB0aXRsZSA9IHBhbmVsVGl0bGUuaW5uZXJUZXh0IHx8IHBhbmVsVGl0bGUudGV4dENvbnRlbnQ7XHJcbi8vICAgICAgICAgICAgc2V0QXR0cihidG4sICd0aXRsZScsIHRpdGxlKTtcclxuLy8gICAgICAgICAgICBsaXN0ZW4oYnRuLCAnY2xpY2snLCAoKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgIGRvYy5zY3JvbGxUb3AgPSBwYW5lbC5vZmZzZXRUb3AgLSA0MDtcclxuLy8vLyAgICAgICAgICAgICAgICBwYW5lbC5zY3JvbGxJbnRvVmlldygpO1xyXG4vLyAgICAgICAgICAgIH0pO1xyXG4vLyAgICAgICAgICAgIHJldHVybiBidG47XHJcbi8vICAgICAgICB9KSk7XHJcbi8vICAgICAgICBcclxuLy8gICAgfVxyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdicmllZmluZ0NoYXJhY3RlcicpKTtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdicmllZmluZ0NvbnRlbnQnKSk7XHJcblxyXG4gICAgICAgIERCTVMuZ2V0UHJvZmlsZVN0cnVjdHVyZSgnY2hhcmFjdGVyJywgKGVyciwgY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVTdHJ1Y3R1cmUoJ3BsYXllcicsIChlcnIyLCBwbGF5ZXJQcm9maWxlU3RydWN0dXJlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlID0gY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnBsYXllclByb2ZpbGVTdHJ1Y3R1cmUgPSBwbGF5ZXJQcm9maWxlU3RydWN0dXJlO1xyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyMywgbmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydGApLCBuYW1lcy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSA+IGRpdiA+IGRpdiA+IC5wYW5lbGApLCBuYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAjYnJpZWZpbmdDaGFyYWN0ZXJgKSwgbmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lID0gVUkuY2hlY2tBbmRHZXRFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgbmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGEobmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGNhbGwgdHJpZ2dlciBidWlsZENvbnRlbnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI2JyaWVmaW5nQ2hhcmFjdGVyJykuc2VsZWN0MihkYXRhKS52YWwoY2hhcmFjdGVyTmFtZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBidWlsZENvbnRlbnREZWxlZ2F0ZShldmVudCkge1xyXG4gICAgICAgIGJ1aWxkQ29udGVudChldmVudC50YXJnZXQudmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGJ1aWxkQ29udGVudChjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGNoYXJhY3Rlck5hbWUpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBjbGVhckVsKGdldEVsKCdicmllZmluZ0NvbnRlbnQnKSk7XHJcbiAgICAgICAgbGV0IGluZGV4ID0gMDtcclxuICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICBjaGFyYWN0ZXJOYW1lXHJcbiAgICAgICAgfTtcclxuICAgICAgICBmdW5jdGlvbiBidWlsZENvbnRlbnRJbm5lcigpIHtcclxuICAgICAgICAgICAgaWYgKGluZGV4IDwgc3RhdGUucGFuZWxzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgaW5kZXgrKztcclxuICAgICAgICAgICAgICAgIHN0YXRlLnBhbmVsc1tpbmRleCAtIDFdLmxvYWQoZGF0YSwgYnVpbGRDb250ZW50SW5uZXIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc3RhdGUucGFuZWxzLm1hcChSLnByb3AoJ21ha2UnKSkuZm9yRWFjaCgobWFrZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG1ha2UoY29udGVudCwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICAgICAgcmVidWlsZEd1dHRlcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJ1aWxkQ29udGVudElubmVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RmxhZ3MoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaXNBZGFwdGF0aW9uc01vZGU6IGdldEVsKCdhZGFwdGF0aW9uc01vZGVSYWRpbycpLmNoZWNrZWQsXHJcbiAgICAgICAgICAgIGlzR3JvdXBpbmdCeVN0b3J5OiBnZXRFbCgnZXZlbnRHcm91cGluZ0J5U3RvcnlSYWRpbycpLmNoZWNrZWQsXHJcbiAgICAgICAgICAgIGRpc2FibGVIZWFkZXJzOiBnZXRFbCgnZGlzYWJsZUhlYWRlcnNDaGVja2JveCcpLmNoZWNrZWQsXHJcbiAgICAgICAgICAgIGhpZGVBbGxQYW5lbHM6IGdldEVsKCdoaWRlQWxsUGFuZWxzQ2hlY2tib3gnKS5jaGVja2VkXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBpbml0UGFuZWxzQXJyKCl7XHJcbiAgICAgICAgc3RhdGUucGFuZWxzID0gW3tcclxuICAgICAgICAgICAgbmFtZTogJ3N0b3J5UmlnaHRzJyxcclxuICAgICAgICAgICAgbG9hZChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3N0b3J5JywgdHJ1ZSwgKGVyciwgdXNlclN0b3J5TmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEudXNlclN0b3J5TmFtZXNNYXAgPSBSLmluZGV4QnkoUi5wcm9wKCd2YWx1ZScpLCB1c2VyU3RvcnlOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7fVxyXG4gICAgICAgIH0sIHtcclxuICAgICAgICAgICAgbmFtZTogJ2NoYXJhY3RlclByb2ZpbGUnLFxyXG4gICAgICAgICAgICBsb2FkKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGUoJ2NoYXJhY3RlcicsIGRhdGEuY2hhcmFjdGVyTmFtZSwgKGVyciwgcHJvZmlsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9maWxlID0gcHJvZmlsZTtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIG1ha2UoZWwsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1jaGFyYWN0ZXItcHJvZmlsZScpLCBbZGF0YS5jaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChlbCwgbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VUZXh0KGxhYmVsKSxcclxuICAgICAgICAgICAgICAgICAgICBVSS5tYWtlUHJvZmlsZVRhYmxlKHN0YXRlLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUsIGRhdGEucHJvZmlsZSksIGdldEZsYWdzKCkuaGlkZUFsbFBhbmVsc1xyXG4gICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdwbGF5ZXJQcm9maWxlJyxcclxuICAgICAgICAgICAgbG9hZChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlQmluZGluZygnY2hhcmFjdGVyJywgZGF0YS5jaGFyYWN0ZXJOYW1lLCAoZXJyLCBiaW5kaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1sxXSA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGUoJ3BsYXllcicsIGJpbmRpbmdbMV0sIChlcnIyLCBwbGF5ZXJQcm9maWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBsYXllclByb2ZpbGUgPSBwbGF5ZXJQcm9maWxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1kZXN0cnVjdHVyaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBsYXllck5hbWUgPSBiaW5kaW5nWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIG1ha2UoZWwsIGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhLnBsYXllclByb2ZpbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3MtcGxheWVyLXByb2ZpbGUnKSwgW2RhdGEucGxheWVyTmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVsKGVsLCBtYWtlUGFuZWwoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VUZXh0KGxhYmVsKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgVUkubWFrZVByb2ZpbGVUYWJsZShzdGF0ZS5wbGF5ZXJQcm9maWxlU3RydWN0dXJlLCBkYXRhLnBsYXllclByb2ZpbGUpLCBnZXRGbGFncygpLmhpZGVBbGxQYW5lbHNcclxuICAgICAgICAgICAgICAgICAgICApKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHtcclxuICAgICAgICAgICAgbmFtZTogJ2ludmVudG9yeScsXHJcbiAgICAgICAgICAgIGxvYWQoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0QWxsSW52ZW50b3J5TGlzdHMoZGF0YS5jaGFyYWN0ZXJOYW1lLCAoZXJyLCBhbGxJbnZlbnRvcnlMaXN0cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5hbGxJbnZlbnRvcnlMaXN0cyA9IGFsbEludmVudG9yeUxpc3RzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIuY29tcG9zZShSLnRvTG93ZXIsIFIucHJvcCgnc3RvcnlOYW1lJykpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChlbCwgbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlVGV4dChgJHtnZXRMMTBuKCdicmllZmluZ3MtaW52ZW50b3J5Jyl9ICgke2RhdGEuYWxsSW52ZW50b3J5TGlzdHMubGVuZ3RofSlgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZUludmVudG9yeUNvbnRlbnQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5hbGxJbnZlbnRvcnlMaXN0cyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNoYXJhY3Rlck5hbWUsIGRhdGEudXNlclN0b3J5TmFtZXNNYXBcclxuICAgICAgICAgICAgICAgICAgICAgICAgKSwgZ2V0RmxhZ3MoKS5oaWRlQWxsUGFuZWxzXHJcbiAgICAgICAgICAgICAgICApKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHtcclxuICAgICAgICAgICAgbmFtZTogJ2dyb3VwcycsXHJcbiAgICAgICAgICAgIGxvYWQoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0Q2hhcmFjdGVyR3JvdXBUZXh0cyhkYXRhLmNoYXJhY3Rlck5hbWUsIChlcnIsIGdyb3VwVGV4dHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEuZ3JvdXBUZXh0cyA9IGdyb3VwVGV4dHM7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChlbCwgbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlVGV4dChgJHtnZXRMMTBuKCdoZWFkZXItZ3JvdXBzJyl9ICgke2RhdGEuZ3JvdXBUZXh0cy5sZW5ndGh9KWApLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYWtlR3JvdXBDb250ZW50KGRhdGEuZ3JvdXBUZXh0cyksIGdldEZsYWdzKCkuaGlkZUFsbFBhbmVsc1xyXG4gICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIG5hbWU6ICdyZWxhdGlvbnMnLFxyXG4gICAgICAgICAgICBsb2FkOiBSZWxhdGlvbnMubG9hZCxcclxuICAgICAgICAgICAgbWFrZShlbCwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBgJHtnZXRMMTBuKCdoZWFkZXItcmVsYXRpb25zJyl9ICgke2RhdGEucmVsYXRpb25zU3VtbWFyeS5yZWxhdGlvbnMubGVuZ3RofSlgO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IFJlbGF0aW9uc1ByZXZpZXcubWFrZVJlbGF0aW9uc0NvbnRlbnQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEsIGdldEZsYWdzKCkuaXNBZGFwdGF0aW9uc01vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUsIGV4cG9ydHMucmVmcmVzaFxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKGVsLCBtYWtlUGFuZWwobWFrZVRleHQobGFiZWwpLCBjb250ZW50LCBnZXRGbGFncygpLmhpZGVBbGxQYW5lbHMpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHtcclxuICAgICAgICAgICAgbmFtZTogJ3N0b3JpZXMnLFxyXG4gICAgICAgICAgICBsb2FkKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBtYWtlKGVsLCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmbGFncyA9IGdldEZsYWdzKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MuaXNHcm91cGluZ0J5U3RvcnkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzaG93RXZlbnRzQnlTdG9yeShlbCwgZGF0YS5jaGFyYWN0ZXJOYW1lLCBkYXRhLnVzZXJTdG9yeU5hbWVzTWFwLCBmbGFncyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3dFdmVudHNCeVRpbWUoZWwsIGRhdGEuY2hhcmFjdGVyTmFtZSwgZGF0YS51c2VyU3RvcnlOYW1lc01hcCwgZmxhZ3MpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfV07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25CdWlsZENvbnRlbnRGaW5pc2goKSB7XHJcbiAgICAgICAgVUkuaW5pdFRleHRBcmVhcyhgJHtyb290fSAjYnJpZWZpbmdDb250ZW50IHRleHRhcmVhYCk7XHJcbiAgICAgICAgVUkucmVmcmVzaFRleHRBcmVhcyhgJHtyb290fSAjYnJpZWZpbmdDb250ZW50IHRleHRhcmVhYCk7XHJcbiAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ25vdEVkaXRhYmxlJywgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlUGFuZWwodGl0bGUsIGNvbnRlbnQsIGhpZGVBbGxQYW5lbHMpIHtcclxuICAgICAgICBjb25zdCBwYW5lbEluZm8gPSBVSS5tYWtlUGFuZWxDb3JlKHRpdGxlLCBjb250ZW50KTtcclxuICAgICAgICBVSS5hdHRhY2hQYW5lbFRvZ2dsZXIocGFuZWxJbmZvLmEsIHBhbmVsSW5mby5jb250ZW50RGl2LCAoZXZlbnQsIHRvZ2dsZVBhbmVsKSA9PiB7XHJcbiAgICAgICAgICAgIHRvZ2dsZVBhbmVsKCk7XHJcbi8vICAgICAgICAgICAgcmVidWlsZEd1dHRlcigpO1xyXG4gICAgICAgICAgICBVSS5yZWZyZXNoVGV4dEFyZWFzKGAke3Jvb3R9ICNicmllZmluZ0NvbnRlbnQgdGV4dGFyZWFgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoaGlkZUFsbFBhbmVscykge1xyXG4gICAgICAgICAgICBwYW5lbEluZm8uYS5jbGljaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGFuZWxJbmZvLnBhbmVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VHcm91cENvbnRlbnQoZ3JvdXBUZXh0cykge1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKCdkaXYnKSwgZ3JvdXBUZXh0cy5tYXAoKGdyb3VwVGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkaXYgPSBtYWtlRWwoJ2RpdicpO1xyXG4gICAgICAgICAgICBhZGRFbChkaXYsIGFkZEVsKG1ha2VFbCgnaDQnKSwgbWFrZVRleHQoZ3JvdXBUZXh0Lmdyb3VwTmFtZSkpKTtcclxuICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGFkZEVsKG1ha2VFbCgndGV4dGFyZWEnKSwgbWFrZVRleHQoZ3JvdXBUZXh0LnRleHQpKTtcclxuICAgICAgICAgICAgc2V0QXR0cihzcGFuLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3NlcyhzcGFuLCBbJ2JyaWVmaW5nVGV4dFNwYW4nLCAnZm9ybS1jb250cm9sJ10pO1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkRWwoZGl2LCBzcGFuKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUludmVudG9yeUNvbnRlbnQoYWxsSW52ZW50b3J5TGlzdHMsIGNoYXJhY3Rlck5hbWUsIHVzZXJTdG9yeU5hbWVzTWFwKSB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gcW10ZSgnLnByb2ZpbGUtZWRpdG9yLWNvbnRhaW5lci10bXBsJyk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhjb250YWluZXIsIGFsbEludmVudG9yeUxpc3RzLm1hcCgoZWxlbSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBlbGVtLmludmVudG9yeTtcclxuICAgICAgICAgICAgaW5wdXQuc3RvcnlOYW1lID0gZWxlbS5zdG9yeU5hbWU7XHJcbiAgICAgICAgICAgIGlucHV0LmNoYXJhY3Rlck5hbWUgPSBjaGFyYWN0ZXJOYW1lO1xyXG4gICAgICAgICAgICBhZGRDbGFzc2VzKGlucHV0LCBbJ2ludmVudG9yeUlucHV0JywgJ2Zvcm0tY29udHJvbCddKTtcclxuICAgICAgICAgICAgaWYgKCF1c2VyU3RvcnlOYW1lc01hcFtlbGVtLnN0b3J5TmFtZV0pIHtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnbm90RWRpdGFibGUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCB1cGRhdGVDaGFyYWN0ZXJJbnZlbnRvcnkpO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gcW10ZSgnLnByb2ZpbGUtZWRpdG9yLXJvdy10bXBsJyk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcucHJvZmlsZS1pdGVtLW5hbWUnKSwgbWFrZVRleHQoZWxlbS5zdG9yeU5hbWUpKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0taW5wdXQnKSwgaW5wdXQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93RXZlbnRzQnlUaW1lKGNvbnRlbnQsIGNoYXJhY3Rlck5hbWUsIHVzZXJTdG9yeU5hbWVzTWFwLCBmbGFncykge1xyXG4gICAgICAgIERCTVMuZ2V0Q2hhcmFjdGVyRXZlbnRzQnlUaW1lKGNoYXJhY3Rlck5hbWUsIChlcnIsIGFsbEV2ZW50cykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCBhZGFwdGF0aW9ucyA9IGFsbEV2ZW50cy5tYXAoZXZlbnQgPT4gKHtcclxuICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICBzdG9yeU5hbWU6IGV2ZW50LnN0b3J5TmFtZVxyXG4gICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuYXJlQWRhcHRhdGlvbnNFZGl0YWJsZShhZGFwdGF0aW9ucywgKGVycjIsIGFyZUFkYXB0YXRpb25zRWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldE1ldGFJbmZvKChlcnIzLCBtZXRhSW5mbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlclN0b3J5TmFtZXNNYXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZUFkYXB0YXRpb25zRWRpdGFibGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dTdG9yeU5hbWU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFJbmZvXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BsaXRDb25zdGFudCA9IDU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFkZEVscyhjb250ZW50LCBSLnNwbGl0RXZlcnkoc3BsaXRDb25zdGFudCwgYWxsRXZlbnRzKS5tYXAoKHN1YlBhcnQsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnRDb250ZW50ID0gYWRkRWxzKG1ha2VFbCgnZGl2JyksIHN1YlBhcnQubWFwKChldmVudCwgaikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5pbmRleCA9IChpICogc3BsaXRDb25zdGFudCkgKyAxICsgajtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzaG93RXZlbnQoZXZlbnQsIGNoYXJhY3Rlck5hbWUsIG9wdHMsIGZsYWdzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFncy5kaXNhYmxlSGVhZGVycykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG1ha2VUZXh0KHN0ckZvcm1hdChnZXRMMTBuKCdicmllZmluZ3MtZXZlbnRzLWhlYWRlcicpLCBbKGkgKiBzcGxpdENvbnN0YW50KSArIDEsIChpICogc3BsaXRDb25zdGFudCkgKyBzdWJQYXJ0Lmxlbmd0aF0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBhZGRFbHMobWFrZUVsKCdkaXYnKSwgc3ViUGFydC5tYXAoZXZlbnQgPT4gZ2V0RXZlbnRIZWFkZXJEaXYoZXZlbnQsIHRydWUpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQYW5lbChuYW1lLCBldmVudENvbnRlbnQsIGZsYWdzLmhpZGVBbGxQYW5lbHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICBvbkJ1aWxkQ29udGVudEZpbmlzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFN0b3J5SGVhZGVyKGVsZW0sIGksIGRpc2FibGVIZWFkZXJzKSB7XHJcbiAgICAgICAgbGV0IG5hbWU7XHJcbiAgICAgICAgaWYgKGRpc2FibGVIZWFkZXJzKSB7XHJcbiAgICAgICAgICAgIG5hbWUgPSBzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLXN0b3J5LWhlYWRlcicpLCBbaSArIDFdKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuYW1lID0gZWxlbS5zdG9yeU5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBtYWtlVGV4dChgJHtuYW1lfSAoJHtlbGVtLmV2ZW50cy5sZW5ndGh9KWApO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dFdmVudHNCeVN0b3J5KGNvbnRlbnQsIGNoYXJhY3Rlck5hbWUsIHVzZXJTdG9yeU5hbWVzTWFwLCBmbGFncykge1xyXG4gICAgICAgIERCTVMuZ2V0Q2hhcmFjdGVyRXZlbnRHcm91cHNCeVN0b3J5KGNoYXJhY3Rlck5hbWUsIChlcnIsIGV2ZW50R3JvdXBzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IGFkYXB0YXRpb25zID0gZXZlbnRHcm91cHMubWFwKGVsZW0gPT4gKHtcclxuICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICBzdG9yeU5hbWU6IGVsZW0uc3RvcnlOYW1lXHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmFyZUFkYXB0YXRpb25zRWRpdGFibGUoYWRhcHRhdGlvbnMsIChlcnIyLCBhcmVBZGFwdGF0aW9uc0VkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldE1ldGFJbmZvKChlcnIzLCBtZXRhSW5mbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyU3RvcnlOYW1lc01hcCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJlQWRhcHRhdGlvbnNFZGl0YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1N0b3J5TmFtZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFJbmZvXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYWRkRWxzKGNvbnRlbnQsIGV2ZW50R3JvdXBzLm1hcCgoZWxlbSwgaSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdG9yeUNvbnRlbnQgPSBhZGRFbHMobWFrZUVsKCdkaXYnKSwgZWxlbS5ldmVudHMubWFwKChldmVudCwgaikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5pbmRleCA9IGogKyAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNob3dFdmVudChldmVudCwgY2hhcmFjdGVyTmFtZSwgb3B0cywgZmxhZ3MpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUGFuZWwoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRTdG9yeUhlYWRlcihlbGVtLCBpLCBmbGFncy5kaXNhYmxlSGVhZGVycyksIHN0b3J5Q29udGVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWdzLmhpZGVBbGxQYW5lbHNcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgb25CdWlsZENvbnRlbnRGaW5pc2goKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRFdmVudEhlYWRlckRpdihldmVudCwgc2hvd1N0b3J5TmFtZSkge1xyXG4gICAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChzdHJGb3JtYXQoJ3swfSB7MX0nLCBbc2hvd1N0b3J5TmFtZSA/IGAke2V2ZW50LnN0b3J5TmFtZX06YCA6ICcnLCBldmVudC5uYW1lXSkpKTtcclxuICAgICAgICBjb25zdCBldmVudFRpbWUgPSBhZGRDbGFzcyhhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQoZXZlbnQudGltZSkpLCAncHJldmlld0V2ZW50VGltZScpO1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKCdkaXYnKSwgW2V2ZW50VGltZSwgZXZlbnROYW1lXSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0V2ZW50KGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBvcHRzLCBmbGFncykge1xyXG4gICAgICAgIGNvbnN0IHsgaXNBZGFwdGF0aW9uc01vZGUgfSA9IGZsYWdzO1xyXG4gICAgICAgIGNvbnN0IHNob3dBbGwgPSBpc0FkYXB0YXRpb25zTW9kZTtcclxuICAgICAgICBjb25zdCBzdG9yeU5hbWUgPSBldmVudC5zdG9yeU5hbWU7XHJcbiAgICAgICAgY29uc3QgaXNTdG9yeUVkaXRhYmxlID0gb3B0cy51c2VyU3RvcnlOYW1lc01hcFtzdG9yeU5hbWVdICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgY29uc3Qgc2hvd0FkYXB0YXRpb25UZXh0ID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS50ZXh0ICE9PSAnJztcclxuICAgICAgICBjb25zdCBzaG93U3ViamVjdGl2ZVRpbWUgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnRpbWUgIT09ICcnO1xyXG5cclxuICAgICAgICBjb25zdCBldmVudERpdiA9IHFtdGUoJy5hZGFwdGF0aW9uLXJvdy10bXBsJyk7XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luQ2FyZCA9IEFkYXB0YXRpb25zLm1ha2VPcmlnaW5DYXJkKGV2ZW50LCBvcHRzLm1ldGFJbmZvLCBldmVudC5zdG9yeU5hbWUsIHtcclxuICAgICAgICAgICAgY2FyZFRpdGxlOiBmbGFncy5kaXNhYmxlSGVhZGVycyA/IEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCAnZXZlbnQtaGVhZGVyJywgW29wdHMuaW5kZXhdKSA6IGV2ZW50Lm5hbWUsXHJcbiAgICAgICAgICAgIHNob3dUaW1lSW5wdXQ6IHNob3dBbGwgfHwgIXNob3dTdWJqZWN0aXZlVGltZSxcclxuICAgICAgICAgICAgc2hvd0xvY2tCdXR0b246IHRydWUsXHJcbiAgICAgICAgICAgIHNob3dUZXh0SW5wdXQ6IHNob3dBbGwgfHwgIXNob3dBZGFwdGF0aW9uVGV4dFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmKCFpc1N0b3J5RWRpdGFibGUpe1xyXG4gICAgICAgICAgICBxZWVzKG9yaWdpbkNhcmQsICcuaXNTdG9yeUVkaXRhYmxlJykuZm9yRWFjaChhZGRDbGFzcyhSLl9fLCAnbm90RWRpdGFibGUnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFkZEVsKHFlZShldmVudERpdiwgJy5ldmVudE1haW5QYW5lbFJvdy1sZWZ0JyksIG9yaWdpbkNhcmQpO1xyXG4gICAgICAgIGNvbnN0IGlzRWRpdGFibGUgPSBvcHRzLmFyZUFkYXB0YXRpb25zRWRpdGFibGVbYCR7ZXZlbnQuc3RvcnlOYW1lfS0ke2NoYXJhY3Rlck5hbWV9YF07XHJcbiAgICAgICAgY29uc3QgYWRhcHRhdGlvbnNDYXJkID0gQWRhcHRhdGlvbnMubWFrZUFkYXB0YXRpb25DYXJkKFxyXG4gICAgICAgICAgICBpc0VkaXRhYmxlLCBldmVudCxcclxuICAgICAgICAgICAgZXZlbnQuc3RvcnlOYW1lLCBjaGFyYWN0ZXJOYW1lLCB7XHJcbiAgICAgICAgICAgICAgICBjYXJkVGl0bGU6ICcnLFxyXG4gICAgICAgICAgICAgICAgc2hvd1RpbWVJbnB1dDogc2hvd0FsbCB8fCBzaG93U3ViamVjdGl2ZVRpbWUsXHJcbiAgICAgICAgICAgICAgICBzaG93RmluaXNoZWRCdXR0b246IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93VGV4dElucHV0OiBzaG93QWxsIHx8IHNob3dBZGFwdGF0aW9uVGV4dFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBhZGRFbChxZWUoZXZlbnREaXYsICcuZXZlbnRNYWluUGFuZWxSb3ctbGVmdCcpLCBhZGFwdGF0aW9uc0NhcmQpO1xyXG4gICAgICAgIHJldHVybiBldmVudERpdjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVDaGFyYWN0ZXJJbnZlbnRvcnkoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICAgIHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZSwgdmFsdWVcclxuICAgICAgICB9ID0gZXZlbnQudGFyZ2V0O1xyXG4gICAgICAgIERCTVMudXBkYXRlQ2hhcmFjdGVySW52ZW50b3J5KHN0b3J5TmFtZSwgY2hhcmFjdGVyTmFtZSwgdmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxufSkodGhpcy5CcmllZmluZ1ByZXZpZXcgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnJlbGF0aW9ucy10YWIgJztcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCBzZXR0aW5nc1BhdGggPSAnUmVsYXRpb25zJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgJChgJHtyb290fSAuY2hhcmFjdGVyLXNlbGVjdGApLnNlbGVjdDIoKS5vbignY2hhbmdlJywgYnVpbGRDb250ZW50KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5jaGFyYWN0ZXItc2VsZWN0YCkpO1xyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAucGFuZWwtYm9keWApKTtcclxuXHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdjaGFyYWN0ZXInLCAoZXJyLCBjaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIHN0YXRlLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUgPSBjaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlO1xyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgZmFsc2UsIChlcnIzLCBuYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0YCksIG5hbWVzLmxlbmd0aCA8IDIpO1xyXG4gICAgICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9ID4gLnBhbmVsYCksIG5hbWVzLmxlbmd0aCA+IDEpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWUgPSBVSS5jaGVja0FuZEdldEVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBuYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGdldFNlbGVjdDJEYXRhKG5hbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGNhbGwgdHJpZ2dlciBidWlsZENvbnRlbnRcclxuICAgICAgICAgICAgICAgICAgICAkKGAke3Jvb3R9IC5jaGFyYWN0ZXItc2VsZWN0YCkuc2VsZWN0MihkYXRhKS52YWwoY2hhcmFjdGVyTmFtZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBidWlsZENvbnRlbnQoZXZlbnQpIHtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLnBhbmVsLWJvZHlgKSk7XHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyTmFtZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBVSS51cGRhdGVFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgY2hhcmFjdGVyTmFtZSk7XHJcbiAgICAgICAgc3RhdGUuZGF0YSA9IHt9O1xyXG4gICAgICAgIHN0YXRlLmRhdGEuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlck5hbWU7XHJcbiAgICAgICAgZXhwb3J0cy5sb2FkKHN0YXRlLmRhdGEsIGJ1aWxkQ29udGVudElubmVyKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBidWlsZENvbnRlbnRJbm5lcigpIHtcclxuICAgICAgICBjb25zdCBjb250ZW50ID0gUmVsYXRpb25zUHJldmlldy5tYWtlUmVsYXRpb25zQ29udGVudChcclxuICAgICAgICAgICAgc3RhdGUuZGF0YSwgdHJ1ZSwgc3RhdGUuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSxcclxuICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoXHJcbiAgICAgICAgKTtcclxuICAgICAgICBhZGRFbChxdWVyeUVsKGAke3Jvb3R9IC5wYW5lbC1ib2R5YCksIGNvbnRlbnQpO1xyXG4gICAgICAgIFVJLmluaXRUZXh0QXJlYXMoYCR7cm9vdH0gLnBhbmVsLWJvZHkgdGV4dGFyZWFgKTtcclxuICAgICAgICBVSS5yZWZyZXNoVGV4dEFyZWFzKGAke3Jvb3R9IC5wYW5lbC1ib2R5IHRleHRhcmVhYCk7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5sb2FkID0gKGRhdGEsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRBbGxQcm9maWxlcygnY2hhcmFjdGVyJywgKGVyciwgcHJvZmlsZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRSZWxhdGlvbnNTdW1tYXJ5KGRhdGEuY2hhcmFjdGVyTmFtZSwgKGVycjIsIHJlbGF0aW9uc1N1bW1hcnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0RXh0ZW5kZWRQcm9maWxlQmluZGluZ3MoKGVycjMsIHByb2ZpbGVCaW5kaW5ncykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgZmFsc2UsIChlcnI0LCBjaGFyYWN0ZXJOYW1lc0FycmF5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI0KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjQpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5yZWxhdGlvbnNTdW1tYXJ5ID0gcmVsYXRpb25zU3VtbWFyeTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5jaGFyYWN0ZXJOYW1lc0FycmF5ID0gY2hhcmFjdGVyTmFtZXNBcnJheTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wcm9maWxlcyA9IHByb2ZpbGVzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnByb2ZpbGVCaW5kaW5ncyA9IFIuZnJvbVBhaXJzKHByb2ZpbGVCaW5kaW5ncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG59KSh0aGlzLlJlbGF0aW9ucyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3QgcmVsYXRpb25UYWJsZUhlYWRlciA9IFsnY2hhcmFjdGVyLW5hbWUnLCAnZGlyZWN0LXJlbGF0aW9uJywgJ3JlbGF0aW9uLW9yaWdpbicsICdyZXZlcnNlLXJlbGF0aW9uJ107XHJcbiAgICBjb25zdCBwYXJ0aWFsVGFibGVIZWFkZXIgPSBbJ2NoYXJhY3Rlci1uYW1lJywgJ2RpcmVjdC1yZWxhdGlvbiddO1xyXG5cclxuICAgIGxldCBtYWtlTmV3Um93O1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdicmllZmluZ3MnKTtcclxuXHJcbiAgICBjb25zdCBmaW5kUmVsID0gUi5jdXJyeSgoZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIHJlbGF0aW9ucykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZpbmRGdW5jID0gUi5jdXJyeSgoZnJvbUNoYXJhY3RlcjIsIHRvQ2hhcmFjdGVyMiwgcmVsKSA9PlxyXG4gICAgICAgICAgICByZWxbZnJvbUNoYXJhY3RlcjJdICE9PSB1bmRlZmluZWQgJiYgcmVsW3RvQ2hhcmFjdGVyMl0gIT09IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgcmV0dXJuIFIuZmluZChmaW5kRnVuYyhmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciksIHJlbGF0aW9ucyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VSZWxhdGlvbnNDb250ZW50ID0gKGRhdGEsIGlzQWRhcHRhdGlvbnNNb2RlLCBwcm9maWxlU2V0dGluZ3MsIGV4dGVybmFsUmVmcmVzaCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgY2hhcmFjdGVyTmFtZSwgcmVsYXRpb25zU3VtbWFyeSwgcHJvZmlsZXMsIHByb2ZpbGVCaW5kaW5nc1xyXG4gICAgICAgIH0gPSBkYXRhO1xyXG4gICAgICAgIGxldCB7IGNoYXJhY3Rlck5hbWVzQXJyYXkgfSA9IGRhdGE7XHJcblxyXG4gICAgICAgIGNoYXJhY3Rlck5hbWVzQXJyYXkgPSBjaGFyYWN0ZXJOYW1lc0FycmF5LmZpbHRlcihSLmNvbXBvc2UoUi5ub3QsIFIuZXF1YWxzKGNoYXJhY3Rlck5hbWUpLCBSLnByb3AoJ3ZhbHVlJykpKTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2V0Mm5kQ2hhck5hbWUgPSBQcm9qZWN0VXRpbHMuZ2V0Mm5kUmVsQ2hhcihjaGFyYWN0ZXJOYW1lKTtcclxuICAgICAgICBjb25zdCBzaG93Q2hhcmFjdGVycyA9IHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zLm1hcChnZXQybmRDaGFyTmFtZSkuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSk7XHJcbiAgICAgICAgY29uc3Qgbm9SZWxzTGlzdCA9IGNoYXJhY3Rlck5hbWVzQXJyYXkuZmlsdGVyKFIuY29tcG9zZShSLm5vdCwgUi5jb250YWlucyhSLl9fLCBzaG93Q2hhcmFjdGVycyksIFIucHJvcCgndmFsdWUnKSkpO1xyXG4gICAgICAgIGNvbnN0IHByZWRpY2F0ZSA9IFIuY29tcG9zZShSLmNvbnRhaW5zKFIuX18sIFIua2V5cyhyZWxhdGlvbnNTdW1tYXJ5Lmtub3duQ2hhcmFjdGVycykpLCBSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIGNvbnN0IFtrbm93bk5vUmVscywgdW5rbm93bk5vUmVsc10gPSBSLnBhcnRpdGlvbihwcmVkaWNhdGUsIG5vUmVsc0xpc3QpO1xyXG5cclxuICAgICAgICBjb25zdCByZWxhdGlvblRtcGwgPSB3cmFwRWwoJ2RpdicsIHF0ZSgnLnJlbGF0aW9uLXRtcGwnKSk7XHJcbiAgICAgICAgY29uc3QgcWUgPSBxZWUocmVsYXRpb25UbXBsKTtcclxuICAgICAgICBjb25zdCBjb250ZW50ID0gcWUoJy5yZWxhdGlvbi1jb250ZW50Jyk7XHJcbiAgICAgICAgY29uc3QgZ2V0UHJvZmlsZUl0ZW1TZWxlY3QgPSAoKSA9PiBxZSgnLnByb2ZpbGUtaXRlbS1zZWxlY3QnKTtcclxuXHJcbiAgICAgICAgbWFrZVByb2ZpbGVJdGVtU2VsZWN0b3IocWUoJy5wcm9maWxlLWl0ZW0tc2VsZWN0JyksIHByb2ZpbGVTZXR0aW5ncywgcmVmcmVzaFByb2ZpbGVJdGVtKGNvbnRlbnQsIHByb2ZpbGVzKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG1ha2VSb3cgPSBtYWtlTmV3Um93KFxyXG4gICAgICAgICAgICBwcm9maWxlcywgZ2V0UHJvZmlsZUl0ZW1TZWxlY3QsIGlzQWRhcHRhdGlvbnNNb2RlLCByZWxhdGlvbnNTdW1tYXJ5Lmtub3duQ2hhcmFjdGVycywgcHJvZmlsZUJpbmRpbmdzLFxyXG4gICAgICAgICAgICBleHRlcm5hbFJlZnJlc2gsIGNoYXJhY3Rlck5hbWVcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBmaWxsaW5nIGhlYWRlciAtIG5lZWQgdGFibGUgYm9keSBmb3IgY2FsbGJhY2tzXHJcbiAgICAgICAgY29uc3QgbWFrZVJvd0NhbGxiYWNrID0gUi5jb21wb3NlKGFkZEVsKGNvbnRlbnQpLCBtYWtlUm93KTtcclxuICAgICAgICBhZGRFbChxZSgnLmtub3duLWNoYXJhY3RlcnMtbGFiZWwnKSwgbWFrZVRleHQobDEwbigna25vd24tY2hhcmFjdGVycycpKSk7XHJcbiAgICAgICAgY29uc3Qga25vd25CdG4gPSBhZGRFbChxZSgnLmFkZC1rbm93bi1jaGFyYWN0ZXItcmVsYXRpb24nKSwgbWFrZVRleHQoZ2V0TDEwbignY29tbW9uLWFkZCcpKSk7XHJcbiAgICAgICAgYWRkRWwocWUoJy51bmtub3duLWNoYXJhY3RlcnMtbGFiZWwnKSwgbWFrZVRleHQobDEwbigndW5rbm93bi1jaGFyYWN0ZXJzJykpKTtcclxuICAgICAgICBjb25zdCB1bmtub3duQnRuID0gYWRkRWwocWUoJy5hZGQtdW5rbm93bi1jaGFyYWN0ZXItcmVsYXRpb24nKSwgbWFrZVRleHQoZ2V0TDEwbignY29tbW9uLWFkZCcpKSk7XHJcbiAgICAgICAgYWRkRWwocWUoJy5wcm9maWxlLWl0ZW0tbGFiZWwnKSwgbWFrZVRleHQobDEwbigncHJvZmlsZS1pdGVtJykpKTtcclxuICAgICAgICBmaWxsQ2hhclNlbGVjdG9yKHFlKCcua25vd24tY2hhcmFjdGVycy1zZWxlY3QnKSwga25vd25CdG4sIGtub3duTm9SZWxzLCBjaGFyYWN0ZXJOYW1lLCBtYWtlUm93Q2FsbGJhY2spO1xyXG4gICAgICAgIGZpbGxDaGFyU2VsZWN0b3IocWUoJy51bmtub3duLWNoYXJhY3RlcnMtc2VsZWN0JyksIHVua25vd25CdG4sIHVua25vd25Ob1JlbHMsIGNoYXJhY3Rlck5hbWUsIG1ha2VSb3dDYWxsYmFjayk7XHJcblxyXG4gICAgICAgIC8vIGZpbGxpbmcgdGFibGVcclxuICAgICAgICBjb25zdCB0b0NoYXJhY3RlckZpbHRlciA9IHRvQ2hhcmFjdGVyID0+IChpc0FkYXB0YXRpb25zTW9kZSA/IHRydWUgOlxyXG4gICAgICAgICAgICAhUi5pc0VtcHR5KGZpbmRSZWwoY2hhcmFjdGVyTmFtZSwgdG9DaGFyYWN0ZXIsIHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zKVtjaGFyYWN0ZXJOYW1lXSkpO1xyXG4gICAgICAgIGNvbnN0IGZpbmRSZWxUbXAgPSBmaW5kUmVsKGNoYXJhY3Rlck5hbWUsIFIuX18sIHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zKTtcclxuICAgICAgICBhZGRFbHMoY29udGVudCwgc2hvd0NoYXJhY3RlcnMuZmlsdGVyKHRvQ2hhcmFjdGVyRmlsdGVyKS5tYXAodG9DaGFyID0+IG1ha2VSb3codG9DaGFyLCBmaW5kUmVsVG1wKHRvQ2hhcikpKSk7XHJcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uVG1wbDtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaFByb2ZpbGVJdGVtKGNvbnRlbnQsIHByb2ZpbGVzKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhQXJyID0gcXVlcnlFbEVscyhjb250ZW50LCAnW3RvQ2hhcmFjdGVyXScpO1xyXG4gICAgICAgICAgICBkYXRhQXJyLmZvckVhY2goKGVsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFyID0gZ2V0QXR0cihlbCwgJ3RvQ2hhcmFjdGVyJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RlZE5hbWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBmaWxsUHJvZmlsZUl0ZW1Db250ZW50KGVsLCBzZWxlY3RlZE5hbWUsIHByb2ZpbGVzW2NoYXJdW3NlbGVjdGVkTmFtZV0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VQcm9maWxlSXRlbVNlbGVjdG9yKHNlbGVjdDEsIHByb2ZpbGVTZXR0aW5ncywgcmVmcmVzaCkge1xyXG4gICAgICAgIHNlbGVjdDEgPSAkKHNlbGVjdDEpO1xyXG4gICAgICAgIGNvbnN0IHRtcFNlbGVjdCA9IHNlbGVjdDEuc2VsZWN0MihhcnIyU2VsZWN0Mihwcm9maWxlU2V0dGluZ3MubWFwKFIucHJvcCgnbmFtZScpKS5zb3J0KCkpKTtcclxuXHJcbiAgICAgICAgc2VsZWN0MS5zZWxlY3QyKHsgd2lkdGg6ICdzdHlsZScgfSk7XHJcbiAgICAgICAgdG1wU2VsZWN0Lm9uKCdjaGFuZ2UnLCByZWZyZXNoKTtcclxuICAgICAgICBpZiAocHJvZmlsZVNldHRpbmdzWzBdKSB7XHJcbiAgICAgICAgICAgIHRtcFNlbGVjdC52YWwocHJvZmlsZVNldHRpbmdzWzBdLm5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtYWtlTmV3Um93ID0gUi5jdXJyeSgoXHJcbiAgICAgICAgcHJvZmlsZXMsIGdldFByb2ZpbGVJdGVtU2VsZWN0LCBpc0FkYXB0YXRpb25zTW9kZSwga25vd25DaGFyYWN0ZXJzLCBwcm9maWxlQmluZGluZ3MsXHJcbiAgICAgICAgZXh0ZXJuYWxSZWZyZXNoLCBmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgcmVsXHJcbiAgICApID0+IHtcclxuICAgICAgICBjb25zdCBzdG9yaWVzID0ga25vd25DaGFyYWN0ZXJzW3RvQ2hhcmFjdGVyXTtcclxuICAgICAgICBjb25zdCByb3cgPSBxbXRlKCcucmVsYXRpb24tcm93LXRtcGwnKTtcclxuICAgICAgICBjb25zdCBxZSA9IHFlZShyb3cpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcudG8tY2hhcmFjdGVyLW5hbWUnKSwgbWFrZVRleHQoYCR7dG9DaGFyYWN0ZXJ9LyR7cHJvZmlsZUJpbmRpbmdzW3RvQ2hhcmFjdGVyXX1gKSk7XHJcbiAgICAgICAgYWRkRWwocWUoJy53aGVyZS1tZWV0cy1sYWJlbCcpLCBtYWtlVGV4dChsMTBuKCd3aGVyZS1tZWV0cycpKSk7XHJcbiAgICAgICAgYWRkRWwocWUoJy53aGVyZS1tZWV0cy1jb250ZW50JyksIG1ha2VUZXh0KHN0b3JpZXMgPT09IHVuZGVmaW5lZCA/ICcnIDogUi5rZXlzKHN0b3JpZXMpLmpvaW4oJywgJykpKTtcclxuICAgICAgICBzZXRBdHRyKHFlKCdbdG9DaGFyYWN0ZXJdJyksICd0b0NoYXJhY3RlcicsIHRvQ2hhcmFjdGVyKTtcclxuICAgICAgICBmaWxsUHJvZmlsZUl0ZW1Db250ZW50KHJvdywgZ2V0UHJvZmlsZUl0ZW1TZWxlY3QoKS52YWx1ZSwgcHJvZmlsZXNbdG9DaGFyYWN0ZXJdW2dldFByb2ZpbGVJdGVtU2VsZWN0KCkudmFsdWVdKTtcclxuICAgICAgICBsaXN0ZW4ocWUoJ2J1dHRvbi5yZW1vdmUnKSwgJ2NsaWNrJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGwxMG4oJ2FyZS15b3Utc3VyZS1hYm91dC1yZWxhdGlvbi1yZW1vdmluZycpLCBbYCR7YCR7ZnJvbUNoYXJhY3Rlcn0tJHt0b0NoYXJhY3Rlcn1gfWBdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVDaGFyYWN0ZXJSZWxhdGlvbihmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgZXh0ZXJuYWxSZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRpcmVjdFRleHQgPSBxZSgnLmRpcmVjdCB0ZXh0YXJlYScpO1xyXG4gICAgICAgIGRpcmVjdFRleHQudmFsdWUgPSByZWxbZnJvbUNoYXJhY3Rlcl07XHJcbiAgICAgICAgc2V0QXR0cihkaXJlY3RUZXh0LCAncGxhY2Vob2xkZXInLCBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ3JlbGF0aW9uLWZyb20tdG8nLCBbZnJvbUNoYXJhY3RlciwgdG9DaGFyYWN0ZXJdKSk7XHJcbiAgICAgICAgbGlzdGVuKGRpcmVjdFRleHQsICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXRDaGFyYWN0ZXJSZWxhdGlvblRleHQoXHJcbiAgICAgICAgICAgICAgICBmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgZnJvbUNoYXJhY3RlciwgZXZlbnQudGFyZ2V0LnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgVXRpbHMucHJvY2Vzc0Vycm9yKClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgQ29uc3RhbnRzLnJlbGF0aW9uRXNzZW5jZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBidG4gPSBxZShgLiR7bmFtZX1gKTtcclxuICAgICAgICAgICAgJChidG4pLnRvb2x0aXAoe1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6IEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCBgJHtuYW1lfWAsIFtmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3Rlcl0pLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VtZW50OiAndG9wJ1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgbGV0IGF0dHJOYW1lID0gbmFtZTtcclxuICAgICAgICAgICAgaWYgKHJlbC5zdGFydGVyICE9PSBmcm9tQ2hhcmFjdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3N0YXJ0ZXJUb0VuZGVyJykgYXR0ck5hbWUgPSAnZW5kZXJUb1N0YXJ0ZXInO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdlbmRlclRvU3RhcnRlcicpIGF0dHJOYW1lID0gJ3N0YXJ0ZXJUb0VuZGVyJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGJ0biwgJ2J0bi1wcmltYXJ5JywgcmVsLmVzc2VuY2UuaW5kZXhPZihhdHRyTmFtZSkgIT09IC0xKTtcclxuICAgICAgICAgICAgbGlzdGVuKGJ0biwgJ2NsaWNrJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnNldFJlbGF0aW9uRXNzZW5jZVN0YXR1cyhmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgYXR0ck5hbWUsICFoYXNDbGFzcyhldmVudC50YXJnZXQsICdidG4tcHJpbWFyeScpLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICB0b2dnbGVDbGFzcyhldmVudC50YXJnZXQsICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBvcmlnaW5UZXh0ID0gcWUoJy5vcmlnaW4gdGV4dGFyZWEnKTtcclxuICAgICAgICBvcmlnaW5UZXh0LnZhbHVlID0gcmVsLm9yaWdpbjtcclxuICAgICAgICBzZXRBdHRyKG9yaWdpblRleHQsICdwbGFjZWhvbGRlcicsIGwxMG4oJ3JlbGF0aW9uLW9yaWdpbicpKTtcclxuICAgICAgICBsaXN0ZW4ob3JpZ2luVGV4dCwgJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnNldE9yaWdpblJlbGF0aW9uVGV4dChmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgZXZlbnQudGFyZ2V0LnZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJldmVyc2VUZXh0ID0gcWUoJy5yZXZlcnNlIHRleHRhcmVhJyk7XHJcbiAgICAgICAgcmV2ZXJzZVRleHQudmFsdWUgPSByZWxbdG9DaGFyYWN0ZXJdO1xyXG4gICAgICAgIHNldEF0dHIocmV2ZXJzZVRleHQsICdwbGFjZWhvbGRlcicsIEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCAncmVsYXRpb24tZnJvbS10bycsIFt0b0NoYXJhY3RlciwgZnJvbUNoYXJhY3Rlcl0pKTtcclxuICAgICAgICBsaXN0ZW4ocmV2ZXJzZVRleHQsICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXRDaGFyYWN0ZXJSZWxhdGlvblRleHQoXHJcbiAgICAgICAgICAgICAgICBmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgdG9DaGFyYWN0ZXIsXHJcbiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRpcmVjdENoZWNrZWQgPSByZWwuc3RhcnRlciA9PT0gZnJvbUNoYXJhY3RlciA/IHJlbC5zdGFydGVyVGV4dFJlYWR5IDogcmVsLmVuZGVyVGV4dFJlYWR5O1xyXG4gICAgICAgIGZpbGxGaW5pc2hlZEJ1dHRvbihcclxuICAgICAgICAgICAgcWUoJy5kaXJlY3QgLmZpbmlzaGVkJyksIEpTT04uc3RyaW5naWZ5KFtmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3Rlcl0pLCBmcm9tQ2hhcmFjdGVyLFxyXG4gICAgICAgICAgICB0b0NoYXJhY3RlciwgZnJvbUNoYXJhY3RlciwgZGlyZWN0Q2hlY2tlZCwgZGlyZWN0VGV4dFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJldmVyc2VDaGVja2VkID0gcmVsLnN0YXJ0ZXIgPT09IHRvQ2hhcmFjdGVyID8gcmVsLnN0YXJ0ZXJUZXh0UmVhZHkgOiByZWwuZW5kZXJUZXh0UmVhZHk7XHJcbiAgICAgICAgZmlsbEZpbmlzaGVkQnV0dG9uKFxyXG4gICAgICAgICAgICBxZSgnLnJldmVyc2UgLmZpbmlzaGVkJyksIEpTT04uc3RyaW5naWZ5KFt0b0NoYXJhY3RlciwgZnJvbUNoYXJhY3Rlcl0pLCBmcm9tQ2hhcmFjdGVyLFxyXG4gICAgICAgICAgICB0b0NoYXJhY3RlciwgdG9DaGFyYWN0ZXIsIHJldmVyc2VDaGVja2VkLCByZXZlcnNlVGV4dFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGlmICghaXNBZGFwdGF0aW9uc01vZGUpIHtcclxuICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocWUoJy5kaXJlY3QnKSwgJ2NvbC14cy0zJyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHFlKCcuZGlyZWN0JyksICdjb2wteHMtOScpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhxZSgnLm9yaWdpbicpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHFlKCcucmV2ZXJzZScpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMocm93KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJvdztcclxuICAgIH0pO1xyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxGaW5pc2hlZEJ1dHRvbihidXR0b24sIGlkLCBmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgY2hhcmFjdGVyLCBjaGVja2VkLCB0ZXh0YXJlYSkge1xyXG4gICAgICAgIHNldENsYXNzSWYoYnV0dG9uLCAnYnRuLXByaW1hcnknLCBjaGVja2VkKTtcclxuICAgICAgICBVdGlscy5lbmFibGVFbCh0ZXh0YXJlYSwgIWNoZWNrZWQpO1xyXG4gICAgICAgIGJ1dHRvbi5pZCA9IGlkO1xyXG4gICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9ICFoYXNDbGFzcyhidXR0b24sICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGJ1dHRvbiwgJ2J0bi1wcmltYXJ5JywgbmV3VmFsdWUpO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbCh0ZXh0YXJlYSwgIW5ld1ZhbHVlKTtcclxuICAgICAgICAgICAgREJNUy5zZXRSZWxhdGlvblJlYWR5U3RhdHVzKGZyb21DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyLCBjaGFyYWN0ZXIsIG5ld1ZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZmlsbFByb2ZpbGVJdGVtQ29udGVudChlbCwgcHJvZmlsZUl0ZW1OYW1lLCBwcm9maWxlSXRlbVZhbHVlKSB7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChxZWUoZWwsICcucHJvZmlsZS1pdGVtLW5hbWUnKSksIG1ha2VUZXh0KHByb2ZpbGVJdGVtTmFtZSkpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocWVlKGVsLCAnLnByb2ZpbGUtaXRlbS12YWx1ZScpKSwgbWFrZVRleHQocHJvZmlsZUl0ZW1WYWx1ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxDaGFyU2VsZWN0b3Ioc2VsZWN0MSwgYnV0dG9uLCBkYXRhLCBmcm9tQ2hhcmFjdGVyLCBtYWtlUm93Q2FsbGJhY2spIHtcclxuICAgICAgICBzZWxlY3QxID0gJChzZWxlY3QxKTtcclxuICAgICAgICBjb25zdCB0bXBTZWxlY3QgPSBzZWxlY3QxLnNlbGVjdDIoZ2V0U2VsZWN0MkRhdGEoZGF0YSkpO1xyXG4gICAgICAgIHNlbGVjdDEuc2VsZWN0Mih7IHdpZHRoOiAnc3R5bGUnIH0pO1xyXG4gICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9DaGFyYWN0ZXIgPSBzZWxlY3QxWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICBEQk1TLmNyZWF0ZUNoYXJhY3RlclJlbGF0aW9uKGZyb21DaGFyYWN0ZXIsIHRvQ2hhcmFjdGVyLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRDaGFyYWN0ZXJSZWxhdGlvbihmcm9tQ2hhcmFjdGVyLCB0b0NoYXJhY3RlciwgKGVycjIsIHJlbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBtYWtlUm93Q2FsbGJhY2soc2VsZWN0MVswXS52YWx1ZSwgcmVsKTtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5maWx0ZXIoUi5jb21wb3NlKFIubm90LCBSLmVxdWFscyhzZWxlY3QxWzBdLnZhbHVlKSwgUi5wcm9wKCd2YWx1ZScpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJFbChzZWxlY3QxWzBdKTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3QxLnNlbGVjdDIoZ2V0U2VsZWN0MkRhdGEoZGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KSh0aGlzLlJlbGF0aW9uc1ByZXZpZXcgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuZ2VhcnMtdGFiJztcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ2dlYXJzJyk7XHJcbiAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQgPSBuZXcgdmlzLkRhdGFTZXQoKTtcclxuICAgIHN0YXRlLmVkZ2VzRGF0YXNldCA9IG5ldyB2aXMuRGF0YVNldCgpO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuYWRkTm9kZURpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHVwZGF0ZU5vZGUsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnYWRkLW9yLWVkaXQtbm9kZS1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdnZWFycy1hZGQtbm9kZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXNhdmUnLFxyXG4gICAgICAgICAgICBvbkNhbmNlbDogb25Ob2RlQ2FuY2VsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUuZWRpdE5vZGVEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCB1cGRhdGVOb2RlLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2FkZC1vci1lZGl0LW5vZGUtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ2VhcnMtZWRpdC1ub2RlJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tc2F2ZScsXHJcbiAgICAgICAgICAgIG9uQ2FuY2VsOiBvbk5vZGVDYW5jZWxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5yZW5hbWVFZGdlRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgcmVuYW1lRWRnZSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ2VhcnMtcmVuYW1lLWVkZ2UnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1zYXZlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBjb25maWd1cmVOZXR3b3JrRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgKGRpYWxvZykgPT4gKCkgPT4gZGlhbG9nLmhpZGVEbGcoKSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdjb25maWctaW5uZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ2VhcnMtY29uZmlndXJlLW5ldHdvcmsnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jbG9zZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgYWRkQ2xhc3MocWVlKGNvbmZpZ3VyZU5ldHdvcmtEaWFsb2csICcubW9kYWwtZGlhbG9nJyksICdnZWFycy1jb25maWctZGlhbG9nJyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcXVlcnlFbChgJHtyb290fSAuY3VzdG9tLXBoeXNpY3Mtc2V0dGluZ3NgKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgIFxyXG4vLyAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm5vZGVzVGV4dCcpLnZhbHVlID0gY2hhckV4YW1wbGU7XHJcbi8vICAgICAgICBzZXRBdHRyKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5ub2Rlc1RleHQnKSwncm93cycsIGNoYXJFeGFtcGxlLnNwbGl0KCdcXG4nKS5sZW5ndGgpO1xyXG4vLyAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmVkZ2VzVGV4dCcpLnZhbHVlID0gZWRnZXNFeGFtcGxlO1xyXG4vLyAgICAgICAgc2V0QXR0cihkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZWRnZXNUZXh0JyksJ3Jvd3MnLCBlZGdlc0V4YW1wbGUuc3BsaXQoJ1xcbicpLmxlbmd0aCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9IC5kcmF3LWJ1dHRvbmApLCAnY2xpY2snLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fSAuZ2V0LWltYWdlLWJ1dHRvbmApLCAnY2xpY2snLCBnZXRJbWFnZSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9IC5kb3dubG9hZC1idXR0b25gKSwgJ2NsaWNrJywgZG93bmxvYWRDc3YpO1xyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fSAuZG93bmxvYWQtanNvbi1idXR0b25gKSwgJ2NsaWNrJywgZG93bmxvYWRKU09OKTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0gLmRvd25sb2FkLWdyYXBobWwtYnV0dG9uYCksICdjbGljaycsIGRvd25sb2FkWUVEKTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0gLmNsZWFyLWJ1dHRvbmApLCAnY2xpY2snLCBjbGVhck5ldHdvcmspO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5waHlzaWNzLXNldHRpbmdzLWJ1dHRvbmApLCAnY2xpY2snLCAoKSA9PiBjb25maWd1cmVOZXR3b3JrRGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLnNlYXJjaC1ub2RlYCksICdjaGFuZ2UnLCBvbk5vZGVGb2N1cyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLmN1c3RvbS1waHlzaWNzLXNldHRpbmdzLWJ1dHRvbmApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBxdWVyeUVsKGAke3Jvb3R9IC5jdXN0b20tcGh5c2ljcy1zZXR0aW5nc2ApLnZhbHVlO1xyXG4gICAgICAgICAgICBpZihvcHRpb25zLnRyaW0oKSA9PT0gJycpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKENvbW1vblV0aWxzLnN0YXJ0c1dpdGgob3B0aW9ucywgJ3ZhciBvcHRpb25zID0gJykpe1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuc3Vic3RyaW5nKCd2YXIgb3B0aW9ucyA9ICcubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShvcHRpb25zKTtcclxuICAgICAgICAgICAgfWNhdGNoKGUpe1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGwxMG4oJ2Vycm9yLW9uLXNldHRpbmdzLWxvYWRpbmcnKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3RhdGUubmV0d29yay5zZXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gLnBoeXNpY3MtZW5hYmxlZC1jaGVja2JveGApLmNoZWNrZWQgPSBmYWxzZTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAucGh5c2ljcy1lbmFibGVkLWNoZWNrYm94YCksICdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zZXRHZWFyc1BoeXNpY3NFbmFibGVkKGV2ZW50LnRhcmdldC5jaGVja2VkLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc3RhdGUubmV0d29yay5zZXRPcHRpb25zKHtcclxuICAgICAgICAgICAgICAgICAgICBcInBoeXNpY3NcIjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBcImVuYWJsZWRcIjogZXZlbnQudGFyZ2V0LmNoZWNrZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWluVmVsb2NpdHlcIjogMC43NVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gLnNob3ctbm90ZXMtY2hlY2tib3hgKS5jaGVja2VkID0gZmFsc2U7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLnNob3ctbm90ZXMtY2hlY2tib3hgKSwgJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnNldEdlYXJzU2hvd05vdGVzRW5hYmxlZChldmVudC50YXJnZXQuY2hlY2tlZCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IC5iaWctcGljdHVyZS1jaGVja2JveGApLmNoZWNrZWQgPSBmYWxzZTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAuYmlnLXBpY3R1cmUtY2hlY2tib3hgKSwgJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHF1ZXJ5RWwoYCR7cm9vdH0gLm15bmV0d29yayA+IGRpdmApLCdiaWctcGljdHVyZScsZXZlbnQudGFyZ2V0LmNoZWNrZWQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5vbignKicsICgpID0+IHtcclxuICAgICAgICAgICAgZmlsbFNlYXJjaFNlbGVjdCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldEFsbEdlYXJzRGF0YSgoZXJyLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gLnNob3ctbm90ZXMtY2hlY2tib3hgKS5jaGVja2VkID0gZGF0YS5zZXR0aW5ncy5zaG93Tm90ZXM7XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0gLnBoeXNpY3MtZW5hYmxlZC1jaGVja2JveGApLmNoZWNrZWQgPSBkYXRhLnNldHRpbmdzLnBoeXNpY3NFbmFibGVkO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZGF0YS5ub2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgbm9kZS5sYWJlbCA9IG1ha2VMYWJlbChub2RlLm5hbWUsIG5vZGUubm90ZXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5hZGQoZGF0YS5ub2Rlcyk7XHJcbiAgICAgICAgICAgIHN0YXRlLmVkZ2VzRGF0YXNldC5jbGVhcigpO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQuYWRkKGRhdGEuZWRnZXMpO1xyXG4gICAgICAgICAgICBkcmF3TmV0d29yaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgLy8gY3JlYXRlIGEgbmV0d29ya1xyXG4gICAgZnVuY3Rpb24gZHJhd05ldHdvcmsoKSB7XHJcbiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHFlKGAke3Jvb3R9IC5teW5ldHdvcmtgKTtcclxuICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5jb25maWdJbm5lcmApKTtcclxuICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICBsb2NhbGU6IEwxMG4uZ2V0TG9jYWxlKCksXHJcbiAgICAgICAgbG9jYWxlczogQ29uc3RhbnRzLnZpc0xvY2FsZXMsXHJcbiAgICAgICAgbWFuaXB1bGF0aW9uOiB7XHJcbiAgICAgICAgICAgIGFkZE5vZGU6IGZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgZGF0YS5sYWJlbCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5uYW1lID0gJyc7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5hZGROb2RlRGlhbG9nLCAnLm5vZGUtaWQnKS52YWx1ZSA9IGRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuYWRkTm9kZURpYWxvZywgJy5ub2RlLW5hbWUnKS52YWx1ZSA9IGRhdGEubmFtZTtcclxuICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5hZGROb2RlRGlhbG9nLCAnLm5vZGUtZ3JvdXAnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgcWVlKHN0YXRlLmFkZE5vZGVEaWFsb2csICcubm9kZS1ub3RlcycpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHN0YXRlLm5vZGVEYXRhID0gZGF0YTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLm5vZGVDYWxsYmFjayA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5hZGROb2RlRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZWRpdE5vZGU6IGZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXROb2RlRGlhbG9nLCAnLm5vZGUtaWQnKS52YWx1ZSA9IGRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuZWRpdE5vZGVEaWFsb2csICcubm9kZS1uYW1lJykudmFsdWUgPSBkYXRhLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBxZWUoc3RhdGUuZWRpdE5vZGVEaWFsb2csICcubm9kZS1ncm91cCcpLnZhbHVlID0gZGF0YS5ncm91cDtcclxuICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5lZGl0Tm9kZURpYWxvZywgJy5ub2RlLW5vdGVzJykudmFsdWUgPSBkYXRhLm5vdGVzO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ub2RlRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ub2RlQ2FsbGJhY2sgPSBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9LmJpbmQodGhpcyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVkaXROb2RlRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgYWRkRWRnZTogZnVuY3Rpb24gKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhLmFycm93cyA9J3RvJztcclxuICAgICAgICAgICAgICAgIGRhdGEubGFiZWwgPScnO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZnJvbSA9PSBkYXRhLnRvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuY29uZmlybShsMTBuKCdkby15b3Utd2FudC10by1jb25uZWN0LW5vZGUtdG8taXRzZWxmJyksICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4gY2FsbGJhY2soKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGVkaXRFZGdlOmZ1bmN0aW9uIChkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBzdG9yZURhdGEoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZGVsZXRlTm9kZTpmdW5jdGlvbiAoZGF0YSwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgc3RvcmVEYXRhKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRlbGV0ZUVkZ2U6ZnVuY3Rpb24gKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgICAgIHN0b3JlRGF0YSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcGh5c2ljczoge1xyXG4gICAgICAgICAgZW5hYmxlZDogcXVlcnlFbChgJHtyb290fSAucGh5c2ljcy1lbmFibGVkLWNoZWNrYm94YCkuY2hlY2tlZCxcclxuICAgICAgICAgIHN0YWJpbGl6YXRpb246IGZhbHNlXHJcbiAgICAgICAgfSxcclxuICAgICAgICBcImVkZ2VzXCI6IHtcclxuICAgICAgICAgIFwic21vb3RoXCI6IHtcclxuICAgICAgICAgICAgXCJ0eXBlXCI6IFwiZGlzY3JldGVcIixcclxuICAgICAgICAgICAgXCJmb3JjZURpcmVjdGlvblwiOiBcIm5vbmVcIlxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29uZmlndXJlOiB7XHJcbiAgICAgICAgICBmaWx0ZXI6ZnVuY3Rpb24gKG9wdGlvbiwgcGF0aCkge1xyXG4gICAgICAgICAgICBpZiAocGF0aC5pbmRleE9mKCdwaHlzaWNzJykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHBhdGguaW5kZXhPZignc21vb3RoJykgIT09IC0xIHx8IG9wdGlvbiA9PT0gJ3Ntb290aCcpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgY29udGFpbmVyOiBxZShgJHtyb290fSAuY29uZmlnSW5uZXJgKVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICBub2Rlczogc3RhdGUubm9kZXNEYXRhc2V0LFxyXG4gICAgICAgIGVkZ2VzOiBzdGF0ZS5lZGdlc0RhdGFzZXRcclxuICAgICAgfTtcclxuICAgICAgc3RhdGUubmV0d29yayA9IG5ldyB2aXMuTmV0d29yayhjb250YWluZXIsIGRhdGEsIG9wdGlvbnMpO1xyXG4gICAgICBzdGF0ZS5uZXR3b3JrLm9uKCdzZWxlY3RFZGdlJywgc2hvd0VkZ2VMYWJlbEVkaXRvcik7XHJcbiAgICAgIHN0YXRlLm5ldHdvcmsub24oJ2RyYWdFbmQnLCAocGFyYW1zKSA9PiBzdG9yZURhdGEoKSk7XHJcbiAgICAgIHN0YXRlLm5ldHdvcmsub24oJ3N0YWJpbGl6ZWQnLCAocGFyYW1zKSA9PiBzdG9yZURhdGEoKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHN0b3JlRGF0YShjYWxsYmFjayl7XHJcbiAgICAgICAgREJNUy5zZXRHZWFyc0RhdGEoZXhwb3J0TmV0d29yaygpLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGlmKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBleHBvcnROZXR3b3JrKCkge1xyXG4gICAgICAgIHN0YXRlLm5ldHdvcmsuc3RvcmVQb3NpdGlvbnMoKTtcclxuICAgICAgICBjb25zdCBub2RlUG9zaXRpb25zID0gc3RhdGUubmV0d29yay5nZXRQb3NpdGlvbnMoKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyhub2RlUG9zaXRpb25zKTtcclxuICAgICAgICBjb25zdCBub2RlcyA9IFIuY2xvbmUoc3RhdGUubm9kZXNEYXRhc2V0LmdldCgpKTtcclxuICAgICAgICBjb25zdCBlZGdlcyA9IHN0YXRlLmVkZ2VzRGF0YXNldC5nZXQoKTtcclxuICAgICAgICBub2Rlcy5mb3JFYWNoKG5vZGUgPT4gZGVsZXRlIG5vZGUuY29sb3IpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIG5vZGVzLFxyXG4gICAgICAgICAgICBlZGdlc1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGltcG9ydE5ldHdvcmsoZGF0YSkge1xyXG4gICAgICAgIGNvbnN0IHtub2RlcywgZWRnZXN9ID0gZGF0YTtcclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQuY2xlYXIoKTtcclxuICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQuY2xlYXIoKTtcclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQudXBkYXRlKG5vZGVzKTtcclxuICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQudXBkYXRlKGVkZ2VzKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93RWRnZUxhYmVsRWRpdG9yKHBhcmFtcykge1xyXG4gICAgICAgIGlmIChwYXJhbXMuZWRnZXMubGVuZ3RoICE9PSAwICYmIHBhcmFtcy5ub2Rlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgY29uc3QgZWRnZSA9IHN0YXRlLmVkZ2VzRGF0YXNldC5nZXQocGFyYW1zLmVkZ2VzWzBdKTtcclxuICAgICAgICAgICAgcWVlKHN0YXRlLnJlbmFtZUVkZ2VEaWFsb2csICcuZW50aXR5LWlucHV0JykudmFsdWUgPSBlZGdlLmxhYmVsIHx8ICcnO1xyXG4gICAgICAgICAgICBzdGF0ZS5lZGdlRGF0YSA9IGVkZ2U7XHJcbiAgICAgICAgICAgIHN0YXRlLmVkZ2VDYWxsYmFjayA9IChlZGdlKSA9PiBzdGF0ZS5lZGdlc0RhdGFzZXQudXBkYXRlKGVkZ2UpO1xyXG4gICAgICAgICAgICBzdGF0ZS5yZW5hbWVFZGdlRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUxhYmVsKG5hbWUsIG5vdGVzKXtcclxuICAgICAgbGV0IGxhYmVsID0gcHJlcGFyZVN0cihuYW1lKTsgXHJcbiAgICAgIGlmKHF1ZXJ5RWwoYCR7cm9vdH0gLnNob3ctbm90ZXMtY2hlY2tib3hgKS5jaGVja2VkKXtcclxuICAgICAgICBsYWJlbCArPSAobm90ZXMudHJpbSgpICE9PSAnJyA/ICgnXFxuXFxuJyArIHByZXBhcmVTdHIobm90ZXMpKSA6ICcnKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gbGFiZWw7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcHJlcGFyZVN0cih0ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgbWF4U3RyTGVuZ3RoID0gMzA7XHJcbiAgICAgICAgcmV0dXJuIHRleHQuc3BsaXQoJ1xcbicpLm1hcCgoc3RyLCBpLCBzdHJpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBjb3VudGVyID0gMDtcclxuICAgICAgICAgICAgY29uc3Qgd29yZHMgPSBzdHIuc3BsaXQoJyAnKTtcclxuICAgICAgICAgICAgcmV0dXJuIHdvcmRzLnJlZHVjZSgoYWNjLCB3b3JkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZigoY291bnRlciArIHdvcmQubGVuZ3RoICsgMSkgPD0gIG1heFN0ckxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFjYyArPSB3b3JkICsgJyAnO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50ZXIgKz0gd29yZC5sZW5ndGggKyAxO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBhY2MgKz0gJ1xcbicgKyB3b3JkICsgJyAnO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50ZXIgPSAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICAgICAgfSwgJycpO1xyXG4gICAgICAgIH0pLmpvaW4oJ1xcbicpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIFxyXG4vLyAgICAgICAgcmV0dXJuIHRleHQuc3BsaXQoJ1xcbicpLm1hcChSLnNwbGl0RXZlcnkoMzApKS5tYXAoUi5qb2luKCctXFxuJykpLmpvaW4oJ1xcbicpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRJbWFnZShldmVudCl7XHJcbiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJjYW52YXNcIik7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcclxuICAgICAgY29uc3QgdyA9IGNhbnZhcy53aWR0aDtcclxuICAgICAgY29uc3QgaCA9IGNhbnZhcy5oZWlnaHQ7XHJcbiAgICAgIFxyXG4gICAgICBjb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9IFwiZGVzdGluYXRpb24tb3ZlclwiO1xyXG4gICAgICBjb250ZXh0LmZpbGxTdHlsZSA9IFwiI2ZmZmZmZlwiO1xyXG4gICAgICBjb250ZXh0LmZpbGxSZWN0KDAsMCx3LGgpO1xyXG4gICAgICBcclxuICAgICAgc2V0QXR0cihldmVudC50YXJnZXQsICdkb3dubG9hZCcsIEZpbGVVdGlscy5tYWtlRmlsZU5hbWUoJ2dlYXJzJywncG5nJykpO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgaW1nICAgID0gY2FudmFzLnRvRGF0YVVSTChcImltYWdlL3BuZ1wiKTtcclxuICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIubGlua1wiKTtcclxuICAgICAgZXZlbnQudGFyZ2V0LmhyZWYgPSBpbWc7XHJcbiAgICAgIGRyYXdOZXR3b3JrKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2xlYXJOZXR3b3JrKCl7XHJcbiAgICAgICAgVXRpbHMuY29uZmlybShsMTBuKCdjb25maXJtLWNsZWFyaW5nJyksICgpID0+IHtcclxuICAgICAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHN0YXRlLmVkZ2VzRGF0YXNldC5jbGVhcigpO1xyXG4gICAgICAgICAgICBzdG9yZURhdGEoZXhwb3J0cy5yZWZyZXNoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlVGV4dEFyZWEoKXtcclxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm5vZGVzVGV4dCcpLnZhbHVlID0gc3RhdGUubm9kZXNEYXRhc2V0Lm1hcCgobm9kZSkgPT4gW25vZGUubmFtZSwgbm9kZS5ncm91cCwgbm9kZS5ub3Rlc10uam9pbignXFx0JykpLmpvaW4oJ1xcbicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUVkZ2VUZXh0QXJlYSgpe1xyXG4gICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZWRnZXNUZXh0JykudmFsdWUgPSBzdGF0ZS5lZGdlc0RhdGFzZXQubWFwKChlZGdlKSA9PiBbc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLmZyb20pLm5hbWUsIGVkZ2UubGFiZWwsIFxyXG4gICAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLnRvKS5uYW1lXS5qb2luKCdcXHQnKSkuam9pbignXFxuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZmlsbFNlYXJjaFNlbGVjdCgpe1xyXG4gICAgICBjb25zdCBhcnIgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQubWFwKChub2RlKSA9PiAoe25hbWU6IG5vZGUubmFtZSwgdmFsdWU6IG5vZGUuaWR9KSk7XHJcbiAgICAgIGFyci5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShhID0+IGEubmFtZS50b0xvd2VyQ2FzZSgpKSk7XHJcbiAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwoJy5zZWFyY2gtbm9kZScpKSwgYXJyKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkb3dubG9hZENzdigpIHtcclxuICAgICAgICBjb25zdCBhcnIgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQubWFwKChub2RlKSA9PiBbbm9kZS5uYW1lLCBub2RlLmdyb3VwLCBub2RlLm5vdGVzXSk7XHJcbiAgICAgICAgY29uc3QgYXJyMiA9IHN0YXRlLmVkZ2VzRGF0YXNldC5tYXAoKGVkZ2UpID0+IFtzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGVkZ2UuZnJvbSkubmFtZSwgZWRnZS5sYWJlbCwgXHJcbiAgICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGVkZ2UudG8pLm5hbWVdKTtcclxuICAgICAgICAgIFxyXG4gICAgICAgIEZpbGVVdGlscy5hcnIyZDJDc3YoYXJyLmNvbmNhdChbWycnXV0pLmNvbmNhdChhcnIyKSwgJ2dlYXJzJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZG93bmxvYWRKU09OKCkge1xyXG4gICAgICBjb25zdCBhcnIgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQubWFwKChub2RlKSA9PiBbbm9kZS5uYW1lLCBub2RlLmdyb3VwLCBub2RlLm5vdGVzXSk7XHJcbiAgICAgIGNvbnN0IGFycjIgPSBzdGF0ZS5lZGdlc0RhdGFzZXQubWFwKChlZGdlKSA9PiBbc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLmZyb20pLm5hbWUsIGVkZ2UubGFiZWwsIFxyXG4gICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoZWRnZS50bykubmFtZV0pO1xyXG4gICAgICAgIFxyXG4gICAgICBjb25zdCBvdXQgPSBuZXcgQmxvYihbSlNPTi5zdHJpbmdpZnkoe25vZGVzOiBhcnIsIGVkZ2VzOiBhcnIyfSwgbnVsbCwgJyAgJyldLCB7XHJcbiAgICAgICAgICB0eXBlOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04OydcclxuICAgICAgfSk7XHJcbiAgICAgIHNhdmVBcyhvdXQsIEZpbGVVdGlscy5tYWtlRmlsZU5hbWUoJ2dlYXJzJywgJ2pzb24nKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZG93bmxvYWRZRUQoKSB7XHJcbiAgICAgIGNvbnN0IGFyciA9IHN0YXRlLm5vZGVzRGF0YXNldC5tYXAoKG5vZGUpID0+IFtub2RlLm5hbWUsIG5vZGUuZ3JvdXAsIG5vZGUubm90ZXNdKTtcclxuICAgICAgY29uc3QgYXJyMiA9IHN0YXRlLmVkZ2VzRGF0YXNldC5tYXAoKGVkZ2UpID0+IFtzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGVkZ2UuZnJvbSkubmFtZSwgZWRnZS5sYWJlbCwgXHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmdldChlZGdlLnRvKS5uYW1lXSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBncm91cHMgPSB7fTtcclxuICAgICAgbGV0IGluZGV4ID0gMTtcclxuICAgICAgc3RhdGUubm9kZXNEYXRhc2V0Lm1hcChub2RlID0+IHtcclxuICAgICAgICBpZihncm91cHNbbm9kZS5ncm91cF0gPT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICBncm91cHNbbm9kZS5ncm91cF0gPSBpbmRleDtcclxuICAgICAgICAgIGluZGV4Kys7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgY29uc3Qgbm9kZXMgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQubWFwKG5vZGUgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbG9ycyA9IENvbnN0YW50cy5jb2xvclBhbGV0dGVbZ3JvdXBzW25vZGUuZ3JvdXBdLTFdLmNvbG9yO1xyXG4gICAgICAgIHJldHVybiBDb21tb25VdGlscy5zdHJGb3JtYXQoQ29uc3RhbnRzLnllZE5vZGVUbXBsLCBbbm9kZS5pZCwgbm9kZS5sYWJlbCwgY29sb3JzLmJhY2tncm91bmQsIGNvbG9ycy5ib3JkZXJdKTtcclxuICAgICAgfSkuam9pbignXFxuJyk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBlZGdlcyA9IHN0YXRlLmVkZ2VzRGF0YXNldC5tYXAoZWRnZSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIENvbW1vblV0aWxzLnN0ckZvcm1hdChDb25zdGFudHMueWVkRWRnZVRtcGwsIFtlZGdlLmlkLCBlZGdlLmxhYmVsIHx8ICcnLCBlZGdlLmZyb20sIGVkZ2UudG9dKTtcclxuICAgICAgfSkuam9pbignXFxuJyk7XHJcbiAgICAgIGNvbnN0IG91dCA9IG5ldyBCbG9iKFtDb21tb25VdGlscy5zdHJGb3JtYXQoQ29uc3RhbnRzLnllZEdtbEJhc2UsIFtub2RlcywgZWRnZXNdKV0sIHtcclxuICAgICAgICAgIHR5cGU6ICd0ZXh0L3htbDtjaGFyc2V0PXV0Zi04OydcclxuICAgICAgfSk7XHJcbiAgICAgIHNhdmVBcyhvdXQsIEZpbGVVdGlscy5tYWtlRmlsZU5hbWUoJ2dlYXJzJywgJ2dyYXBobWwnKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25Ob2RlRm9jdXMoZXZlbnQpIHtcclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLmZvY3VzKGV2ZW50LnRhcmdldC52YWx1ZSwgQ29uc3RhbnRzLnNuRm9jdXNPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVFZGdlKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKHN0YXRlLmVkZ2VEYXRhKXtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRvSW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSBzdGF0ZS5lZGdlRGF0YTtcclxuICAgICAgICAgICAgICAgIGVkZ2UubGFiZWwgPSBsYWJlbDtcclxuICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVkZ2VDYWxsYmFjayhlZGdlKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVkZ2VEYXRhID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVkZ2VDYWxsYmFjayA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBzdG9yZURhdGEoKTtcclxuICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHVwZGF0ZU5vZGUoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgaWYoIHN0YXRlLm5vZGVEYXRhICl7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IHN0YXRlLm5vZGVEYXRhO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5pZCA9IHFlZShkaWFsb2csICcubm9kZS1pZCcpLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgZGF0YS5uYW1lID0gcWVlKGRpYWxvZywgJy5ub2RlLW5hbWUnKS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGRhdGEuZ3JvdXAgPSBxZWUoZGlhbG9nLCAnLm5vZGUtZ3JvdXAnKS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGRhdGEubm90ZXMgPSBxZWUoZGlhbG9nLCAnLm5vZGUtbm90ZXMnKS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGRhdGEubGFiZWwgPSBtYWtlTGFiZWwoZGF0YS5uYW1lLCBkYXRhLm5vdGVzKTtcclxuICAgICAgICAgICAgICAgIGRhdGEuc2hhcGUgPSAnYm94JztcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgY29uc3QgZXh0cmFGaWVsZHMgPSBSLmRpZmZlcmVuY2UoUi5rZXlzKGRhdGEpLCBDb25zdGFudHMuZ2VhcnNOb2RlUmVxdWlyZWRGaWVsZHMpO1xyXG4gICAgICAgICAgICAgICAgZGF0YSA9IFIub21pdChleHRyYUZpZWxkcywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHN0YXRlLm5vZGVDYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgc3RhdGUubm9kZURhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUubm9kZUNhbGxiYWNrID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIHN0b3JlRGF0YShleHBvcnRzLnJlZnJlc2gpO1xyXG4gICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIG9uTm9kZUNhbmNlbCgpIHtcclxuICAgICAgICBpZiggc3RhdGUubm9kZURhdGEgKXtcclxuICAgICAgICAgICAgc3RhdGUubm9kZUNhbGxiYWNrKG51bGwpO1xyXG4gICAgICAgICAgICBzdGF0ZS5ub2RlRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVDYWxsYmFjayA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KSh0aGlzLkdlYXJzID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgZnVuYy1uYW1lcyAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuZnVuY3Rpb24gQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nKHJvb3QpIHtcclxuICAgIHRoaXMuZGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgdGhpcy5vbkFjdGlvbi5iaW5kKHRoaXMpLCB7XHJcbiAgICAgICAgYm9keVNlbGVjdG9yOiAnYWRkLWZpbHRlci1jb25kaXRpb24tYm9keScsXHJcbiAgICAgICAgZGlhbG9nVGl0bGU6ICdncm91cHMtYWRkLWZpbHRlci1jb25kaXRpb24nLFxyXG4gICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLW9rJyxcclxuICAgIH0pO1xyXG4gICAgbGlzdGVuKHFlZSh0aGlzLmRpYWxvZywgYC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKSwgJ2NoYW5nZScsIHRoaXMub25Qcm9maWxlSXRlbVNlbGVjdC5iaW5kKHRoaXMpKTtcclxufVxyXG5cclxuQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLnByb3RvdHlwZS5zaG93RGxnID0gZnVuY3Rpb24oZ3JvdXBzLCBjYWxsYmFjayl7XHJcbiAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbiAgICB0aGlzLml0ZW1zID0gUi5pbmRleEJ5KFIucHJvcCgnbmFtZScpLCBSLnVubmVzdChncm91cHMubWFwKFIucHJvcCgnYXJyYXknKSkpKTtcclxuICAgIFxyXG4gICAgY29uc3Qgc2VsZWN0b3IgPSBxZWUodGhpcy5kaWFsb2csIGAucHJvZmlsZS1pdGVtLXNlbGVjdG9yYCk7XHJcbiAgICBVSS5maWxsU2hvd0l0ZW1TZWxlY3RvcjIoXHJcbiAgICAgICAgY2xlYXJFbChzZWxlY3RvciksXHJcbiAgICAgICAgZ3JvdXBzLFxyXG4gICAgICAgIGZhbHNlXHJcbiAgICApO1xyXG4gICAgc2VsZWN0b3Iub3B0aW9uc1swXS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICBcclxuICAgIHRoaXMub25Qcm9maWxlSXRlbVNlbGVjdCh7dGFyZ2V0OiBzZWxlY3Rvcn0pO1xyXG4gICAgXHJcbiAgICB0aGlzLmRpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAvLyB0byBzZXQgZGlhbG9nIHRpdGxlXHJcbi8vICAgIHNldEF0dHIocWVlKGVsLCAnLm1vZGFsLXRpdGxlJyksICdsMTBuLWlkJywgb3B0cy5kaWFsb2dUaXRsZSk7XHJcbiAgICBcclxufVxyXG5cclxuQWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nLnByb3RvdHlwZS5vbkFjdGlvbiA9IGZ1bmN0aW9uIChkaWFsb2cpe1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmdldEZpbHRlck1vZGVsSXRlbSgpKTtcclxuICAgICAgICB0aGlzLmNhbGxiYWNrKHRoaXMuZ2V0RmlsdGVyTW9kZWxJdGVtKCkpO1xyXG4gICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICB9LmJpbmQodGhpcyk7XHJcbn0gXHJcblxyXG5BZGRGaWx0ZXJDb25kaXRpb25EaWFsb2cucHJvdG90eXBlLmdldEZpbHRlck1vZGVsSXRlbSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IG9wdCA9IHFlZSh0aGlzLmRpYWxvZywgYC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKS5zZWxlY3RlZE9wdGlvbnNbMF07XHJcbiAgICBjb25zdCBpdGVtID0gdGhpcy5pdGVtc1tvcHQudmFsdWVdO1xyXG4gICAgXHJcbiAgICBjb25zdCBmaWx0ZXJJdGVtID0ge1xyXG4gICAgICAgIHR5cGU6IGl0ZW0udHlwZSxcclxuICAgICAgICBuYW1lOiBpdGVtLm5hbWVcclxuICAgIH07XHJcbiAgICBcclxuICAgIGNvbnN0IGNvbmRpdGlvbkNvbnRhaW5lciA9IChxZWUodGhpcy5kaWFsb2csICcuY29uZGl0aW9uJykpO1xyXG4gICAgY29uc3QgdmFsdWVDb250YWluZXIgPSAocWVlKHRoaXMuZGlhbG9nLCAnLnZhbHVlJykpO1xyXG4gICAgXHJcbiAgICBsZXQgYXJyO1xyXG4gICAgc3dpdGNoIChpdGVtLnR5cGUpIHtcclxuICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgIGFyciA9IG5sMmFycmF5KHFlZSh2YWx1ZUNvbnRhaW5lciwgJ3NlbGVjdCcpLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgZmlsdGVySXRlbS5zZWxlY3RlZE9wdGlvbnMgPSBSLnppcE9iaihhcnIsIFIucmVwZWF0KHRydWUsIGFyci5sZW5ndGgpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgZmlsdGVySXRlbS5jb25kaXRpb24gPSBxZWUoY29uZGl0aW9uQ29udGFpbmVyLCAnc2VsZWN0JykudmFsdWU7XHJcbiAgICAgICAgZmlsdGVySXRlbS5udW0gPSBOdW1iZXIocWVlKHZhbHVlQ29udGFpbmVyLCAnaW5wdXQnKS52YWx1ZSk7XHJcbiAgICAgICAgXHJcbi8vICAgICAgICBpZiAoaW5wdXRJdGVtLnZhbHVlID09PSAnaWdub3JlJykgeyByZXR1cm47IH1cclxuLy8gICAgICAgIG51bSA9IE51bWJlcihzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTpudW1iZXJJbnB1dGBdLnZhbHVlKTtcclxuLy8gICAgICAgIG1vZGVsLnB1c2goe1xyXG4vLyAgICAgICAgICAgIHR5cGUsIG5hbWU6IGlucHV0SXRlbU5hbWUsIG51bSwgY29uZGl0aW9uOiBpbnB1dEl0ZW0udmFsdWVcclxuLy8gICAgICAgIH0pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICBmaWx0ZXJJdGVtLmNvbmRpdGlvbiA9IHFlZShjb25kaXRpb25Db250YWluZXIsICdzZWxlY3QnKS52YWx1ZTtcclxuICAgICAgICBhcnIgPSBubDJhcnJheShxZWUodmFsdWVDb250YWluZXIsICdzZWxlY3QnKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIGZpbHRlckl0ZW0uc2VsZWN0ZWRPcHRpb25zID0gUi56aXBPYmooYXJyLCBSLnJlcGVhdCh0cnVlLCBhcnIubGVuZ3RoKSk7XHJcbi8vICAgICAgICBpZiAoaW5wdXRJdGVtLnZhbHVlID09PSAnaWdub3JlJykgeyByZXR1cm47IH1cclxuLy8gICAgICAgIHNlbGVjdGVkT3B0aW9ucyA9IHt9O1xyXG4vLyAgICAgICAgc2VsZWN0MiA9IHN0YXRlLmlucHV0SXRlbXNbYCR7aW5wdXRJdGVtLnNlbGZJbmZvLm5hbWV9Om11bHRpRW51bUlucHV0YF07XHJcbi8vICAgICAgICBhcnIgPSBubDJhcnJheShzZWxlY3QyLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbi8vICAgICAgICBtb2RlbC5wdXNoKHtcclxuLy8gICAgICAgICAgICB0eXBlLFxyXG4vLyAgICAgICAgICAgIG5hbWU6IGlucHV0SXRlbU5hbWUsXHJcbi8vICAgICAgICAgICAgY29uZGl0aW9uOiBpbnB1dEl0ZW0udmFsdWUsXHJcbi8vICAgICAgICAgICAgc2VsZWN0ZWRPcHRpb25zOiBSLnppcE9iaihhcnIsIFIucmVwZWF0KHRydWUsIGFyci5sZW5ndGgpKVxyXG4vLyAgICAgICAgfSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICd0ZXh0JzpcclxuICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgZmlsdGVySXRlbS5yZWdleFN0cmluZyA9IHFlZSh2YWx1ZUNvbnRhaW5lciwgJ2lucHV0JykudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuLy8gICAgICAgIG1vZGVsLnB1c2goeyB0eXBlLCBuYW1lOiBpbnB1dEl0ZW1OYW1lLCByZWdleFN0cmluZzogaW5wdXRJdGVtLnZhbHVlLnRvTG93ZXJDYXNlKCkgfSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7dHlwZX1gKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmaWx0ZXJJdGVtO1xyXG59XHJcblxyXG5BZGRGaWx0ZXJDb25kaXRpb25EaWFsb2cucHJvdG90eXBlLm9uUHJvZmlsZUl0ZW1TZWxlY3QgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGNvbnN0IG9wdCA9IGV2ZW50LnRhcmdldC5zZWxlY3RlZE9wdGlvbnNbMF07XHJcbiAgICBjb25zdCBpdGVtID0gdGhpcy5pdGVtc1tvcHQudmFsdWVdO1xyXG4gICAgY29uc29sZS5sb2coaXRlbSk7XHJcbiAgICBcclxuICAgIGNvbnN0IGNvbmRpdGlvbkNvbnRhaW5lciA9IGNsZWFyRWwocWVlKHRoaXMuZGlhbG9nLCAnLmNvbmRpdGlvbicpKTtcclxuICAgIHN3aXRjaCAoaXRlbS50eXBlKSB7XHJcbiAgICBjYXNlICd0ZXh0JzpcclxuICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgYWRkRWwoY29uZGl0aW9uQ29udGFpbmVyLCBxbXRlKCcudGV4dC1jb25kaXRpb24tdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgIGFkZEVsKGNvbmRpdGlvbkNvbnRhaW5lciwgcW10ZSgnLmVudW0tY29uZGl0aW9uLXRtcGwnKSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgIGFkZEVsKGNvbmRpdGlvbkNvbnRhaW5lciwgcW10ZSgnLm11bHRpZW51bS1jb25kaXRpb24tdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgYWRkRWwoY29uZGl0aW9uQ29udGFpbmVyLCBxbXRlKCcubnVtYmVyLWNvbmRpdGlvbi10bXBsJykpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke2l0ZW0udHlwZX1gKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3QgdmFsdWVDb250YWluZXIgPSBjbGVhckVsKHFlZSh0aGlzLmRpYWxvZywgJy52YWx1ZScpKTtcclxuICAgIGxldCB2YWx1ZUlucHV0LCB2YWx1ZXM7XHJcbiAgICBzd2l0Y2ggKGl0ZW0udHlwZSkge1xyXG4gICAgY2FzZSAndGV4dCc6XHJcbiAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgIGFkZEVsKHZhbHVlQ29udGFpbmVyLCBxbXRlKCcudGV4dC12YWx1ZS10bXBsJykpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgIGFkZEVsKHZhbHVlQ29udGFpbmVyLCBxbXRlKCcuY2hlY2tib3gtdmFsdWUtdG1wbCcpKTtcclxuICAgICAgICBicmVhaztcclxuICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICB2YWx1ZUlucHV0ID0gcW10ZSgnLmVudW0tdmFsdWUtdG1wbCcpO1xyXG4gICAgICAgIHZhbHVlcyA9IGl0ZW0udmFsdWUuc3BsaXQoJywnKTtcclxuICAgICAgICB2YWx1ZXMuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSk7XHJcbiAgICAgICAgdmFsdWVzID0gYXJyMlNlbGVjdCh2YWx1ZXMpO1xyXG4gICAgICAgIHZhbHVlSW5wdXQuc2l6ZSA9IHZhbHVlcy5sZW5ndGg7XHJcblxyXG4gICAgICAgIGZpbGxTZWxlY3Rvcih2YWx1ZUlucHV0LCB2YWx1ZXMubWFwKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICB2YWx1ZS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgYWRkRWwodmFsdWVDb250YWluZXIsIHZhbHVlSW5wdXQpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICBhZGRFbCh2YWx1ZUNvbnRhaW5lciwgcW10ZSgnLm51bWJlci12YWx1ZS10bXBsJykpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke2l0ZW0udHlwZX1gKTtcclxuICAgIH1cclxuICAgIEwxMG4ubG9jYWxpemVTdGF0aWModGhpcy5kaWFsb2cpO1xyXG4vLyAgICBjb25zb2xlLmxvZyhpdGVtKTtcclxufSIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4vKiBlc2xpbnQtZGlzYWJsZSBmdW5jLW5hbWVzICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5mdW5jdGlvbiBGaWx0ZXJDb25maWd1cmF0aW9uKGluZm8pIHtcclxuICAgIHRoaXMuaW5mbyA9IGluZm87XHJcbiAgICBmdW5jdGlvbiBwb3B1bGF0ZVByb2ZpbGVJdGVtcyhpdGVtKSB7XHJcbiAgICAgICAgaWYgKCFDb21tb25VdGlscy5zdGFydHNXaXRoKGl0ZW0ubmFtZSwgQ29uc3RhbnRzLkNIQVJfUFJFRklYKSAmJlxyXG4gICAgICAgICAgICAhQ29tbW9uVXRpbHMuc3RhcnRzV2l0aChpdGVtLm5hbWUsIENvbnN0YW50cy5QTEFZRVJfUFJFRklYKSkge1xyXG4gICAgICAgICAgICBpdGVtLmRpc3BsYXlOYW1lID0gZ2V0TDEwbihpdGVtLmRpc3BsYXlOYW1lKTtcclxuICAgICAgICAgICAgaXRlbS52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcyA9IENvbW1vblV0aWxzLmNsb25lKGluZm8uZ3JvdXBlZFByb2ZpbGVGaWx0ZXJJdGVtcyk7XHJcbiAgICB0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMubWFwKFIucHJvcCgncHJvZmlsZUZpbHRlckl0ZW1zJykpLm1hcChSLm1hcChwb3B1bGF0ZVByb2ZpbGVJdGVtcykpO1xyXG59XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLm1ha2VGaWx0ZXJDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICBEQk1TLmdldFByb2ZpbGVGaWx0ZXJJbmZvKChlcnIsIGluZm8pID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgIGNvbnN0IGZpbHRlckNvbmZpZ3VyYXRpb24gPSBuZXcgRmlsdGVyQ29uZmlndXJhdGlvbihpbmZvKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCBmaWx0ZXJDb25maWd1cmF0aW9uKTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuZ2V0UHJvZmlsZUZpbHRlckl0ZW1zID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIFIuZmxhdHRlbih0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMubWFwKFIucHJvcCgncHJvZmlsZUZpbHRlckl0ZW1zJykpKTtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldFByb2ZpbGVJdGVtU291cmNlID0gZnVuY3Rpb24gKG5hbWUpIHtcclxuICAgIGxldCBzb3VyY2U7XHJcbiAgICB0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMuZm9yRWFjaCggKGVsKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYXJyID0gZWwucHJvZmlsZUZpbHRlckl0ZW1zLm1hcChSLnByb3AoJ25hbWUnKSk7XHJcbiAgICAgICAgaWYoUi5jb250YWlucyhuYW1lLCBhcnIpKXtcclxuICAgICAgICAgICAgc291cmNlID0gZWwubmFtZTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBzb3VyY2U7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXROYW1lMlNvdXJjZU1hcHBpbmcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLnJlZHVjZSggKGFjYywgZ3JvdXApID0+IHtcclxuICAgICAgICBncm91cC5wcm9maWxlRmlsdGVySXRlbXMuZm9yRWFjaCggaXRlbSA9PiBhY2NbaXRlbS5uYW1lXSA9IGdyb3VwLm5hbWUpO1xyXG4gICAgICAgIHJldHVybiBhY2M7XHJcbiAgICB9LCB7fSk7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXROYW1lMkRpc3BsYXlOYW1lTWFwcGluZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMucmVkdWNlKCAoYWNjLCBncm91cCkgPT4ge1xyXG4gICAgICAgIGdyb3VwLnByb2ZpbGVGaWx0ZXJJdGVtcy5mb3JFYWNoKCBpdGVtID0+IGFjY1tpdGVtLm5hbWVdID0gaXRlbS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIGFjYztcclxuICAgIH0sIHt9KTtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldEdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuZ2V0R3JvdXBzRm9yU2VsZWN0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zLm1hcCgoZ3JvdXApID0+ICh7XHJcbiAgICAgICAgZGlzcGxheU5hbWU6IGdldEwxMG4oYHByb2ZpbGUtZmlsdGVyLSR7Z3JvdXAubmFtZX1gKSxcclxuICAgICAgICBhcnJheTogZ3JvdXAucHJvZmlsZUZpbHRlckl0ZW1zXHJcbiAgICB9KSk7XHJcbn1cclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldEJhc2VQcm9maWxlU2V0dGluZ3MgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGNoYXJhY3RlcnM6IHRoaXMuaW5mby5jaGFyYWN0ZXJzLnByb2ZpbGVTdHJ1Y3R1cmUsXHJcbiAgICAgICAgcGxheWVyczogdGhpcy5pbmZvLnBsYXllcnMucHJvZmlsZVN0cnVjdHVyZVxyXG4gICAgfTtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmdldERhdGFBcnJheXMgPSBmdW5jdGlvbiAoZmlsdGVyTW9kZWwpIHtcclxuICAgIHJldHVybiBQcm9qZWN0VXRpbHMuZ2V0RGF0YUFycmF5cyh0aGlzLmluZm8sIGZpbHRlck1vZGVsKTtcclxufTtcclxuXHJcbkZpbHRlckNvbmZpZ3VyYXRpb24ucHJvdG90eXBlLmhhdmVQcm9maWxlcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBSLmtleXModGhpcy5pbmZvLmNoYXJhY3RlcnMucHJvZmlsZXMpLmxlbmd0aCA+IDAgfHwgUi5rZXlzKHRoaXMuaW5mby5wbGF5ZXJzLnByb2ZpbGVzKS5sZW5ndGggPiAwO1xyXG59O1xyXG5cclxuRmlsdGVyQ29uZmlndXJhdGlvbi5wcm90b3R5cGUuaGF2ZVByb2ZpbGVTdHJ1Y3R1cmVzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5mby5jaGFyYWN0ZXJzLnByb2ZpbGVTdHJ1Y3R1cmUubGVuZ3RoID4gMCB8fCB0aGlzLmluZm8ucGxheWVycy5wcm9maWxlU3RydWN0dXJlLmxlbmd0aCA+IDA7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5oYXZlRGF0YSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB0aGlzLmhhdmVQcm9maWxlcygpICYmIHRoaXMuaGF2ZVByb2ZpbGVTdHJ1Y3R1cmVzKCk7XHJcbn07XHJcblxyXG5GaWx0ZXJDb25maWd1cmF0aW9uLnByb3RvdHlwZS5nZXRQcm9maWxlSWRzID0gZnVuY3Rpb24gKGZpbHRlck1vZGVsKSB7XHJcbiAgICBjb25zdCBvZmZzZXQgPSB0aGlzLmdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXNbMF0ucHJvZmlsZUZpbHRlckl0ZW1zLmxlbmd0aDtcclxuICAgIHJldHVybiB0aGlzLmdldERhdGFBcnJheXMoZmlsdGVyTW9kZWwpLm1hcChkYXRhQXJyYXkgPT4gYCR7ZGF0YUFycmF5WzBdLnZhbHVlIHx8ICcnfS8ke2RhdGFBcnJheVtvZmZzZXRdLnZhbHVlIHx8ICcnfWApLnNvcnQoKTtcclxufTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNiBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmdyb3VwLXByb2ZpbGUtdGFiICc7XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ2dyb3VwcycpO1xyXG4gICAgY29uc3Qgc2V0dGluZ3NQYXRoID0gJ0dyb3VwUHJvZmlsZSc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNyZWF0ZUdyb3VwRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgZXhwb3J0cy5jcmVhdGVHcm91cCh0cnVlLCBleHBvcnRzLnJlZnJlc2gpLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdncm91cHMtZW50ZXItZ3JvdXAtbmFtZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLWNyZWF0ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZWApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVHcm91cERpYWxvZy5zaG93RGxnKCkpO1xyXG5cclxuICAgICAgICBzdGF0ZS5yZW5hbWVHcm91cERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHJlbmFtZUdyb3VwLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdncm91cHMtZW50ZXItbmV3LWdyb3VwLW5hbWUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB0Ym9keSA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LXByb2ZpbGVgKSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXMgPSB7fTtcclxuXHJcbiAgICAgICAgQ29uc3RhbnRzLmdyb3VwUHJvZmlsZVN0cnVjdHVyZS5mb3JFYWNoKChwcm9maWxlU2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgICAgcHJvZmlsZVNldHRpbmdzLmRpc3BsYXlOYW1lID0gZ2V0TDEwbihgZ3JvdXBzLSR7cHJvZmlsZVNldHRpbmdzLm5hbWV9YCk7XHJcbiAgICAgICAgICAgIGFkZEVsKHRib2R5LCBtYWtlSW5wdXQocHJvZmlsZVNldHRpbmdzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktZmlsdGVyYCksICdpbnB1dCcsIGZpbHRlck9wdGlvbnMpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKGAke3Jvb3R9YCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnZ3JvdXAnLCBmYWxzZSwgKGVyciwgZ3JvdXBOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydGApLCBncm91cE5hbWVzLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuY29sLXhzLTlgKSwgZ3JvdXBOYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fSAuZW50aXR5LWZpbHRlcmApLCBncm91cE5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdGApKSwgZ3JvdXBOYW1lcy5tYXAoKG5hbWUsIGksIGFycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWwgPSB3cmFwRWwoJ2RpdicsIHF0ZSgnLmVudGl0eS1pdGVtLXRtcGwnKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChxZWUoZWwsICcucHJpbWFyeS1uYW1lJyksIG1ha2VUZXh0KG5hbWUuZGlzcGxheU5hbWUpKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnLCBuYW1lLmRpc3BsYXlOYW1lKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoZWwsICdwcm9maWxlLW5hbWUnLCBuYW1lLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihxZWUoZWwsICcuc2VsZWN0LWJ1dHRvbicpLCAnY2xpY2snLCBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZTIobmFtZS52YWx1ZSkpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucmVuYW1lJyksICd0aXRsZScsIGwxMG4oJ3JlbmFtZS1lbnRpdHknKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVCdG4gPSBxZWUoZWwsICcucmVtb3ZlJyk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKHJlbW92ZUJ0biwgJ3RpdGxlJywgbDEwbigncmVtb3ZlLWVudGl0eScpKTtcclxuICAgICAgICAgICAgICAgIGlmKGkrMSA8IGFyci5sZW5ndGgpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUJ0bi5uZXh0TmFtZSA9IGFycltpKzFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYoaSA+IDApe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUJ0bi5wcmV2TmFtZSA9IGFycltpLTFdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG5hbWUuZWRpdGFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLnJlbmFtZScpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5yZW5hbWVHcm91cERpYWxvZywgJy5lbnRpdHktaW5wdXQnKS52YWx1ZSA9IG5hbWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUdyb3VwRGlhbG9nLmZyb21OYW1lID0gbmFtZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucmVuYW1lR3JvdXBEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbihyZW1vdmVCdG4sICdjbGljaycsIEdyb3VwUHJvZmlsZS5yZW1vdmVHcm91cCgoKSA9PiBuYW1lLnZhbHVlLCBleHBvcnRzLnJlZnJlc2gsIHJlbW92ZUJ0bikpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5yZW5hbWUnKSwgJ2Rpc2FibGVkJywgJ2Rpc2FibGVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0QXR0cihyZW1vdmVCdG4sICdkaXNhYmxlZCcsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZTIoVUkuY2hlY2tBbmRHZXRFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgZ3JvdXBOYW1lcykpKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VJbnB1dChwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIGxldCBpbnB1dDtcclxuICAgICAgICBzd2l0Y2ggKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUpIHtcclxuICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ3RleHRhcmVhJyk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAncHJvZmlsZVRleHRJbnB1dCBmb3JtLWNvbnRyb2wnKTtcclxuICAgICAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlRmllbGRWYWx1ZShwcm9maWxlSXRlbUNvbmZpZy50eXBlKSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgIGlucHV0LnR5cGUgPSAnY2hlY2tib3gnO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2Zvcm0tY29udHJvbCcpO1xyXG4gICAgICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB1cGRhdGVGaWVsZFZhbHVlKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUpKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY29udGFpbmVyJzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2RpdicpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ2NvbnRhaW5lcic7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7cHJvZmlsZUl0ZW1Db25maWcudHlwZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaW5wdXQuc2VsZk5hbWUgPSBwcm9maWxlSXRlbUNvbmZpZy5uYW1lO1xyXG4gICAgICAgIGFkZENsYXNzKGlucHV0LCAnaXNHcm91cEVkaXRhYmxlJyk7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1twcm9maWxlSXRlbUNvbmZpZy5uYW1lXSA9IGlucHV0O1xyXG5cclxuICAgICAgICBjb25zdCByb3cgPSBxbXRlKCcucHJvZmlsZS1lZGl0b3Itcm93LXRtcGwnKTtcclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLnByb2ZpbGUtaXRlbS1uYW1lJyksIG1ha2VUZXh0KHByb2ZpbGVJdGVtQ29uZmlnLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUocm93LCAnLnByb2ZpbGUtaXRlbS1uYW1lJyksICdsMTBuLWlkJywgYGdyb3Vwcy0ke3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWV9YCk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0taW5wdXQnKSwgaW5wdXQpO1xyXG4gICAgICAgIHJldHVybiByb3c7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlRmllbGRWYWx1ZSh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBldmVudC50YXJnZXQuc2VsZk5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IHN0YXRlLm5hbWU7XHJcblxyXG4gICAgICAgICAgICBsZXQgdmFsdWU7XHJcbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnVwZGF0ZUdyb3VwRmllbGQoZ3JvdXBOYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBldmVudC50YXJnZXQuY2hlY2tlZDtcclxuICAgICAgICAgICAgICAgIERCTVMuZG9FeHBvcnRHcm91cChncm91cE5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7dHlwZX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKG5hbWUpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBxdWVyeUVscyhgJHtyb290fSBbcHJvZmlsZS1uYW1lXSAuc2VsZWN0LWJ1dHRvbmApLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnYnRuLXByaW1hcnknKSk7XHJcbiAgICAgICAgICAgIGlmKG5hbWUgIT09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKGAke3Jvb3R9IFtwcm9maWxlLW5hbWU9XCIke25hbWV9XCJdIC5zZWxlY3QtYnV0dG9uYCk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhlbCwgJ2J0bi1wcmltYXJ5Jyk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudEVsID0gZWwucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZW50aXR5TGlzdCA9IHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1saXN0YCk7XHJcbiAgICAgICAgICAgICAgICBVSS5zY3JvbGxUbyhlbnRpdHlMaXN0LCBwYXJlbnRFbCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0R3JvdXAobmFtZSwgc2hvd1Byb2ZpbGVJbmZvQ2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzaG93UHJvZmlsZUluZm9DYWxsYmFjayhlcnIsIGdyb3VwKSB7XHJcbiAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICBjb25zdCB7IG5hbWUgfSA9IGdyb3VwO1xyXG4gICAgICAgIEZpbHRlckNvbmZpZ3VyYXRpb24ubWFrZUZpbHRlckNvbmZpZ3VyYXRpb24oKGVycjEsIGZpbHRlckNvbmZpZ3VyYXRpb24pID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycjEpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMSk7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmlzRW50aXR5RWRpdGFibGUoJ2dyb3VwJywgbmFtZSwgKGVycjIsIGlzR3JvdXBFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgdXBkYXRlU2V0dGluZ3MobmFtZSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUyRGlzcGxheU5hbWUgPSBmaWx0ZXJDb25maWd1cmF0aW9uLmdldE5hbWUyRGlzcGxheU5hbWVNYXBwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUyU291cmNlID0gZmlsdGVyQ29uZmlndXJhdGlvbi5nZXROYW1lMlNvdXJjZU1hcHBpbmcoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5uYW1lID0gbmFtZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgaW5wdXRJdGVtcyB9ID0gc3RhdGU7XHJcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhpbnB1dEl0ZW1zKS5mb3JFYWNoKChpbnB1dE5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnR5cGUgPT09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLmNoZWNrZWQgPSBncm91cFtpbnB1dE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnR5cGUgPT09ICdjb250YWluZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dE5hbWUgPT09ICdmaWx0ZXJNb2RlbCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhYmxlID0gcW10ZShgJHtyb290fSAuZ3JvdXAtZmlsdGVyLXRlbXBsYXRlYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhcyA9IGdyb3VwLmZpbHRlck1vZGVsLm1hcChleHBvcnRzLm1ha2VGaWx0ZXJJdGVtU3RyaW5nKG5hbWUyRGlzcGxheU5hbWUsIG5hbWUyU291cmNlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMocWVlKHRhYmxlLCAndGJvZHknKSwgZGF0YXMubWFwKGRhdGEycm93KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKHRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVsKGNsZWFyRWwoaW5wdXRJdGVtc1tpbnB1dE5hbWVdKSwgdGFibGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0TmFtZSA9PT0gJ2NoYXJhY3Rlckxpc3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gZmlsdGVyQ29uZmlndXJhdGlvbi5nZXRQcm9maWxlSWRzKGdyb3VwLmZpbHRlck1vZGVsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0SXRlbSA9IGNsZWFyRWwoaW5wdXRJdGVtc1tpbnB1dE5hbWVdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhpbnB1dEl0ZW0sIFttYWtlVGV4dChkYXRhLmpvaW4oJywgJykpLCBtYWtlRWwoJ2JyJyksIG1ha2VUZXh0KGdldEwxMG4oJ2dyb3Vwcy10b3RhbCcpICsgZGF0YS5sZW5ndGgpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgY29udGFpbmVyOiAke2lucHV0TmFtZX1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnR5cGUgPT09ICd0ZXh0YXJlYScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnZhbHVlID0gZ3JvdXBbaW5wdXROYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaW5wdXQgdHlwZTogJHtpbnB1dEl0ZW1zW2lucHV0TmFtZV0udHlwZX1gKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLm9sZFZhbHVlID0gZ3JvdXBbaW5wdXROYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNHcm91cEVkaXRhYmxlJywgaXNHcm91cEVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICBleHBvcnRzLm1ha2VGaWx0ZXJJdGVtU3RyaW5nID0gUi5jdXJyeSgobmFtZTJEaXNwbGF5TmFtZSwgbmFtZTJTb3VyY2UsIGZpbHRlckl0ZW0pID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IG5hbWUyRGlzcGxheU5hbWVbZmlsdGVySXRlbS5uYW1lXTtcclxuICAgICAgICBjb25zdCBzb3VyY2UgPSBuYW1lMlNvdXJjZVtmaWx0ZXJJdGVtLm5hbWVdO1xyXG4gICAgICAgIGxldCBjb25kaXRpb24sIGFyciwgdmFsdWU7XHJcbiAgICAgICAgc3dpdGNoIChmaWx0ZXJJdGVtLnR5cGUpIHtcclxuICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgY29uZGl0aW9uID0gZ2V0TDEwbihgZ3JvdXBzLW9uZS1mcm9tYCk7XHJcbiAgICAgICAgICAgIHZhbHVlID0gT2JqZWN0LmtleXMoZmlsdGVySXRlbS5zZWxlY3RlZE9wdGlvbnMpLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgYXJyID0gW107XHJcbiAgICAgICAgICAgIGlmIChmaWx0ZXJJdGVtLnNlbGVjdGVkT3B0aW9ucy50cnVlKSB7IGFyci5wdXNoKGdldEwxMG4oJ2NvbnN0YW50LXllcycpKTsgfVxyXG4gICAgICAgICAgICBpZiAoZmlsdGVySXRlbS5zZWxlY3RlZE9wdGlvbnMuZmFsc2UpIHsgYXJyLnB1c2goZ2V0TDEwbignY29uc3RhbnQtbm8nKSk7IH1cclxuICAgICAgICAgICAgY29uZGl0aW9uID0gZ2V0TDEwbihgZ3JvdXBzLW9uZS1mcm9tYCk7XHJcbiAgICAgICAgICAgIHZhbHVlID0gYXJyLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGdldEwxMG4oYGNvbnN0YW50LSR7ZmlsdGVySXRlbS5jb25kaXRpb259YCk7XHJcbiAgICAgICAgICAgIHZhbHVlID0gZmlsdGVySXRlbS5udW07XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGdldEwxMG4oYGNvbnN0YW50LSR7ZmlsdGVySXRlbS5jb25kaXRpb259YCk7XHJcbiAgICAgICAgICAgIHZhbHVlID0gT2JqZWN0LmtleXMoZmlsdGVySXRlbS5zZWxlY3RlZE9wdGlvbnMpLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGdldEwxMG4oJ2dyb3Vwcy10ZXh0LWNvbnRhaW5zJyk7XHJcbiAgICAgICAgICAgIHZhbHVlID0gZmlsdGVySXRlbS5yZWdleFN0cmluZztcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtmaWx0ZXJJdGVtLnR5cGV9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRpdGxlID0gZ2V0TDEwbihgcHJvZmlsZS1maWx0ZXItJHtzb3VyY2V9YCkgKyAnLCAnICsgZ2V0TDEwbihgY29uc3RhbnQtJHtmaWx0ZXJJdGVtLnR5cGV9YCk7XHJcbiAgICAgICAgcmV0dXJuIHtkaXNwbGF5TmFtZSwgdGl0bGUsIGNvbmRpdGlvbiwgdmFsdWV9O1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGRhdGEycm93KGRhdGEpe1xyXG4gICAgICAgIGNvbnN0IHtkaXNwbGF5TmFtZSwgdGl0bGUsIGNvbmRpdGlvbiwgdmFsdWV9ID0gZGF0YTtcclxuICAgICAgICBjb25zdCByb3cgPSBxbXRlKGAke3Jvb3R9IC5ncm91cC1maWx0ZXItcm93LXRlbXBsYXRlYCk7XHJcbiAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0nKSwgbWFrZVRleHQoZGlzcGxheU5hbWUpKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShyb3csICcucHJvZmlsZS1pdGVtJyksICd0aXRsZScsIHRpdGxlKTtcclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLmNvbmRpdGlvbicpLCBtYWtlVGV4dChjb25kaXRpb24pKTtcclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLnZhbHVlJyksIG1ha2VUZXh0KHZhbHVlKSk7XHJcbiAgICAgICAgcmV0dXJuIHJvdztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyhuYW1lKSB7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBEQk1TLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgc2V0dGluZ3MuR3JvdXBQcm9maWxlLmdyb3VwTmFtZSA9IG5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZmlsdGVyT3B0aW9ucyhldmVudCkge1xyXG4gICAgICAgIGNvbnN0IHN0ciA9IGV2ZW50LnRhcmdldC52YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBjb25zdCBlbHMgPSBxdWVyeUVscyhgJHtyb290fSBbcHJpbWFyeS1uYW1lXWApO1xyXG4gICAgICAgIGVscy5mb3JFYWNoKChlbCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpc1Zpc2libGUgPSBnZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJykudG9Mb3dlckNhc2UoKS5pbmRleE9mKHN0cikgIT09IC0xO1xyXG4gICAgICAgICAgICBoaWRlRWwoZWwsICFpc1Zpc2libGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAocXVlcnlFbChgJHtyb290fSAuaGlkZGVuW3ByaW1hcnktbmFtZV0gLnNlbGVjdC1idXR0b24uYnRuLXByaW1hcnlgKSAhPT0gbnVsbCB8fFxyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IFtwcmltYXJ5LW5hbWVdIC5zZWxlY3QtYnV0dG9uLmJ0bi1wcmltYXJ5YCkgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgZWxzMiA9IHF1ZXJ5RWxzKGAke3Jvb3R9IFtwcmltYXJ5LW5hbWVdYCkuZmlsdGVyKFIucGlwZShoYXNDbGFzcyhSLl9fLCAnaGlkZGVuJyksIFIubm90KSk7XHJcbiAgICAgICAgICAgIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlMihlbHMyLmxlbmd0aCA+IDAgPyBnZXRBdHRyKGVsczJbMF0sICdwcm9maWxlLW5hbWUnKSA6IG51bGwpKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IFtwcmltYXJ5LW5hbWVdIC5zZWxlY3QtYnV0dG9uLmJ0bi1wcmltYXJ5YCkuc2Nyb2xsSW50b1ZpZXcoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5jcmVhdGVHcm91cCA9ICh1cGRhdGVTZXR0aW5nc0ZsYWcsIHJlZnJlc2gpID0+IGRpYWxvZyA9PiAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgIERCTVMuY3JlYXRlR3JvdXAobmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodXBkYXRlU2V0dGluZ3NGbGFnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goKGVycjIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlbmFtZUdyb3VwKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvSW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCB7IGZyb21OYW1lIH0gPSBkaWFsb2c7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5yZW5hbWVHcm91cChmcm9tTmFtZSwgdG9OYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBVSS51cGRhdGVFbnRpdHlTZXR0aW5nKHNldHRpbmdzUGF0aCwgdG9OYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnRzLnJlbW92ZUdyb3VwID0gKGNhbGxiYWNrLCByZWZyZXNoLCBidG4pID0+ICgpID0+IHtcclxuICAgICAgICBjb25zdCBuYW1lID0gY2FsbGJhY2soKTtcclxuXHJcbiAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignZ3JvdXBzLWFyZS15b3Utc3VyZS1hYm91dC1ncm91cC1yZW1vdmluZycpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMucmVtb3ZlR3JvdXAobmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKGJ0bi5uZXh0TmFtZSAhPT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGJ0bi5uZXh0TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGJ0bi5wcmV2TmFtZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBidG4ucHJldk5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG59KSh0aGlzLkdyb3VwUHJvZmlsZSA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNi0yMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgcm9vdFRhYiA9ICcuZ3JvdXAtc2NoZW1hLXRhYic7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdFRhYik7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldEdyb3VwU2NoZW1hcygoZXJyLCBzY2hlbWFzKSA9PiB7XHJcbi8vICAgICAgICAgICAgcmVkcmF3U2NoZW1hKHNjaGVtYXMudGhlb3J5KTtcclxuICAgICAgICAgICAgcmVkcmF3U2NoZW1hMihzY2hlbWFzLnRoZW9yeSwgJ3RoZW9yeScpO1xyXG4gICAgICAgICAgICByZWRyYXdTY2hlbWEyKHNjaGVtYXMucHJhY3RpY2UsICdwcmFjdGljZScpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWRyYXdTY2hlbWEoZ3JhcGgpIHtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBxdWVyeUVsKGAke3Jvb3RUYWJ9IC5zY2hlbWEtY29udGFpbmVyYCk7XHJcblxyXG4gICAgICAgIGlmIChzdGF0ZS5uZXR3b3JrKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLm5ldHdvcmsuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBncmFwaC5lZGdlcyA9IGdyYXBoLmVkZ2VzLm1hcChlZGdlID0+IFIubWVyZ2UoZWRnZSwge1xyXG4gICAgICAgICAgICBwaHlzaWNzOiBmYWxzZSxcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIHN0YXRlLm5ldHdvcmsgPSBuZXcgdmlzLk5ldHdvcmsoY29udGFpbmVyLCBncmFwaCwgQ29uc3RhbnRzLmdyb3VwU2NoZW1hT3B0cyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHJlZHJhd1NjaGVtYTIoZ3JhcGhEYXRhLCBjbGFzc05hbWUpIHtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdFRhYn0gc3ZnLiR7Y2xhc3NOYW1lfWApKTtcclxuICAgICAgICBjb25zdCBzdmcgPSBkMy5zZWxlY3QoYCR7cm9vdFRhYn0gc3ZnLiR7Y2xhc3NOYW1lfWApO1xyXG4gICAgICAgIGNvbnN0IHN2Z0dyb3VwID0gc3ZnLmFwcGVuZCgnZycpO1xyXG4gICAgICAgIGNvbnN0IHJvb3QgPSBzdmdHcm91cC5hcHBlbmQoJ2cnKTtcclxuXHJcbiAgICAgICAgLy8gZGVmaW5lIGFuIGFycm93IGhlYWRcclxuICAgICAgICBzdmcuYXBwZW5kKCdzdmc6ZGVmcycpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3N2ZzptYXJrZXInKVxyXG4gICAgICAgICAgICAuYXR0cignaWQnLCAnZW5kJylcclxuICAgICAgICAgICAgLmF0dHIoJ3ZpZXdCb3gnLCAnMCAtNSAxMCAxMCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCdyZWZYJywgMTApXHJcbiAgICAgICAgICAgIC5hdHRyKCdyZWZZJywgMClcclxuICAgICAgICAgICAgLmF0dHIoJ21hcmtlcldpZHRoJywgMykgLy8gbWFya2VyIHNldHRpbmdzXHJcbiAgICAgICAgICAgIC5hdHRyKCdtYXJrZXJIZWlnaHQnLCA1KVxyXG4gICAgICAgICAgICAuYXR0cignb3JpZW50JywgJ2F1dG8nKVxyXG4gICAgICAgICAgICAuc3R5bGUoJ2ZpbGwnLCAnIzk5OScpXHJcbiAgICAgICAgICAgIC5zdHlsZSgnc3Ryb2tlLW9wYWNpdHknLCAwLjYpIC8vIGFycm93aGVhZCBjb2xvclxyXG4gICAgICAgICAgICAuYXBwZW5kKCdzdmc6cGF0aCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCdkJywgJ00wLC01TDEwLDBMMCw1Jyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3Qgbm9kZURpY3QgPSBncmFwaERhdGEubm9kZXMucmVkdWNlKChkaWN0LCBub2RlLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGRpY3Rbbm9kZS5pZF0gPSBpO1xyXG4gICAgICAgICAgICByZXR1cm4gZGljdDtcclxuICAgICAgICB9LCB7fSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5vZGVXaWR0aCA9IDE3MDtcclxuICAgICAgICBjb25zdCBub2RlSGVpZ2h0ID0gMjA7XHJcblxyXG4gICAgICAgIGNvbnN0IG5hbWUyTm9kZSA9IG9iaiA9PiAoe1xyXG4gICAgICAgICAgICBpZDogbm9kZURpY3Rbb2JqLmlkXSxcclxuICAgICAgICAgICAgbmFtZTogb2JqLmlkLFxyXG4gICAgICAgICAgICB0aXRsZTogb2JqLnRpdGxlLFxyXG4gICAgICAgICAgICBsYWJlbDogb2JqLmxhYmVsLFxyXG4gICAgICAgICAgICB3aWR0aDogbm9kZVdpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IG5vZGVIZWlnaHRcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcGFpcjJFZGdlID0gKG9iaiwgaSkgPT4gKHtcclxuICAgICAgICAgICAgaWQ6IGkgKyBncmFwaERhdGEubm9kZXMubGVuZ3RoLFxyXG4gICAgICAgICAgICBzb3VyY2U6IG5vZGVEaWN0W29iai50b10sXHJcbiAgICAgICAgICAgIHRhcmdldDogbm9kZURpY3Rbb2JqLmZyb21dXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGdyYXBoID0ge1xyXG4gICAgICAgICAgICBub2RlczogZ3JhcGhEYXRhLm5vZGVzLm1hcChuYW1lMk5vZGUpLFxyXG4gICAgICAgICAgICBsaW5rczogZ3JhcGhEYXRhLmVkZ2VzLm1hcChwYWlyMkVkZ2UpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgbGF5b3V0ZXIgPSBrbGF5LmQzYWRhcHRlcigpO1xyXG4gICAgICAgIGNvbnN0IHdpZHRoID0gOTYwO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IDQwMDtcclxuXHJcbiAgICAgICAgbGF5b3V0ZXJcclxuICAgICAgICAgICAgLm5vZGVzKGdyYXBoLm5vZGVzKVxyXG4gICAgICAgICAgICAubGlua3MoZ3JhcGgubGlua3MpXHJcbiAgICAgICAgICAgIC5zaXplKFt3aWR0aCwgaGVpZ2h0XSlcclxuICAgICAgICAgICAgLnRyYW5zZm9ybUdyb3VwKHJvb3QpXHJcbiAgICAgICAgICAgIC5vcHRpb25zKHtcclxuICAgICAgICAgICAgICAgIGVkZ2VSb3V0aW5nOiAnT1JUSE9HT05BTCcsXHJcbiAgICAgICAgICAgICAgICBcImRpcmVjdGlvblwiOiBcIlJJR0hUXCIsXHJcbiAgICAgICAgICAgICAgICBpbnRDb29yZGluYXRlczogZmFsc2VcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmRlZmF1bHRQb3J0U2l6ZShbMiwgMl0pXHJcbiAgICAgICAgICAgIC5zdGFydCgpO1xyXG5cclxuICAgICAgICBjb25zdCBsaW5rID0gcm9vdC5zZWxlY3RBbGwoJy5saW5rJylcclxuICAgICAgICAgICAgLmRhdGEoZ3JhcGgubGlua3MpXHJcbiAgICAgICAgICAgIC5lbnRlcigpXHJcbiAgICAgICAgICAgIC5hcHBlbmQoJ3BhdGgnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAnbGluaycpXHJcbiAgICAgICAgICAgIC5hdHRyKCdkJywgJ00wIDAnKVxyXG4gICAgICAgICAgICAuYXR0cignbWFya2VyLWVuZCcsICd1cmwoI2VuZCknKTtcclxuXHJcbiAgICAgICAgLy8gd2UgZ3JvdXAgbm9kZXMgYWxvbmcgd2l0aCB0aGVpciBwb3J0c1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSByb290LnNlbGVjdEFsbCgnLm5vZGUnKVxyXG4gICAgICAgICAgICAuZGF0YShncmFwaC5ub2RlcylcclxuICAgICAgICAgICAgLmVudGVyKClcclxuICAgICAgICAgICAgLmFwcGVuZCgnZycpO1xyXG5cclxuICAgICAgICBub2RlLmFwcGVuZCgncmVjdCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsIChkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ25vZGUgdmFsaWQnO1xyXG4vLyAgICAgICAgICAgICAgICBjb25zdCBkZXRhaWxzID0gY2hlY2tSZXMuZGV0YWlsc1tkLm5hbWVdO1xyXG4vLyAgICAgICAgICAgICAgICBpZiAoZGV0YWlscyA9PT0gdW5kZWZpbmVkIHx8IGRldGFpbHMubGVuZ3RoID09PSAwKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ25vZGUgdmFsaWQnO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIHJldHVybiAnbm9kZSBpbnZhbGlkJztcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmF0dHIoJ3dpZHRoJywgbm9kZVdpZHRoKVxyXG4gICAgICAgICAgICAuYXR0cignaGVpZ2h0Jywgbm9kZUhlaWdodClcclxuICAgICAgICAgICAgLmF0dHIoJ3RpdGxlJywgJ2xpbmsnKVxyXG4gICAgICAgICAgICAuYXR0cigncngnLCA1KVxyXG4gICAgICAgICAgICAuYXR0cigncnknLCA1KVxyXG4gICAgICAgICAgICAuYXR0cigneCcsIDApXHJcbiAgICAgICAgICAgIC5hdHRyKCd5JywgMCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbm9kZS5hcHBlbmQoJ3RpdGxlJykudGV4dChkID0+IGQudGl0bGUpXHJcblxyXG4gICAgICAgIG5vZGUuYXBwZW5kKCd0ZXh0JylcclxuICAgICAgICAgICAgLmF0dHIoJ3gnLCBub2RlV2lkdGggLyAyKVxyXG4gICAgICAgICAgICAuYXR0cigneScsIG5vZGVIZWlnaHQgLyAyKVxyXG4gICAgICAgICAgICAuYXR0cignYWxpZ25tZW50LWJhc2VsaW5lJywgJ21pZGRsZScpXHJcbiAgICAgICAgICAgIC5hdHRyKCd0ZXh0LWFuY2hvcicsICdtaWRkbGUnKVxyXG4vLyAgICAgICAgICAgIC50ZXh0KGQgPT4gZC5uYW1lKVxyXG4gICAgICAgICAgICAudGV4dChkID0+IGQubGFiZWwpXHJcbiAgICAgICAgICAgIC5hdHRyKCdmb250LXNpemUnLCAnNHB4Jyk7XHJcblxyXG4gICAgICAgIC8vIHBvcnRzXHJcbiAgICAgICAgY29uc3QgcG9ydCA9IG5vZGUuc2VsZWN0QWxsKCcucG9ydCcpXHJcbiAgICAgICAgICAgIC5kYXRhKGQgPT4gZC5wb3J0cylcclxuICAgICAgICAgICAgLmVudGVyKClcclxuICAgICAgICAgICAgLmFwcGVuZCgncmVjdCcpXHJcbiAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdwb3J0JylcclxuICAgICAgICAgICAgLmF0dHIoJ3dpZHRoJywgMilcclxuICAgICAgICAgICAgLmF0dHIoJ2hlaWdodCcsIDIpXHJcbiAgICAgICAgICAgIC5hdHRyKCd4JywgMClcclxuICAgICAgICAgICAgLmF0dHIoJ3knLCAwKTtcclxuXHJcbiAgICAgICAgLy8gYXBwbHkgbGF5b3V0XHJcbiAgICAgICAgbGF5b3V0ZXIub24oJ2ZpbmlzaCcsIChkMikgPT4ge1xyXG4gICAgICAgIC8vIGFwcGx5IGVkZ2Ugcm91dGVzXHJcbiAgICAgICAgICAgIGxpbmsudHJhbnNpdGlvbigpLmF0dHIoJ2QnLCAoZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHBhdGggPSAnJztcclxuICAgICAgICAgICAgICAgIHBhdGggKz0gYE0ke2Quc291cmNlUG9pbnQueH0gJHtkLnNvdXJjZVBvaW50Lnl9IGA7XHJcbiAgICAgICAgICAgICAgICBkLmJlbmRQb2ludHMuZm9yRWFjaCgoYnAsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBwYXRoICs9IGBMJHticC54fSAke2JwLnl9IGA7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHBhdGggKz0gYEwke2QudGFyZ2V0UG9pbnQueH0gJHtkLnRhcmdldFBvaW50Lnl9IGA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBhcHBseSBub2RlIHBvc2l0aW9uc1xyXG4gICAgICAgICAgICBub2RlLnRyYW5zaXRpb24oKVxyXG4gICAgICAgICAgICAgICAgLmF0dHIoJ3RyYW5zZm9ybScsIGQgPT4gYHRyYW5zbGF0ZSgke2QueH0gJHtkLnl9KWApO1xyXG5cclxuICAgICAgICAgICAgLy8gYXBwbHkgcG9ydCBwb3NpdGlvbnNcclxuICAgICAgICAgICAgcG9ydC50cmFuc2l0aW9uKClcclxuICAgICAgICAgICAgICAgIC5hdHRyKCd4JywgZCA9PiBkLngpXHJcbiAgICAgICAgICAgICAgICAuYXR0cigneScsIGQgPT4gZC55KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGF5b3V0ZXIuc3RhcnQoKTtcclxuICAgIH07XHJcbn0pKHRoaXMuR3JvdXBTY2hlbWEgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTYgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgY29uc3Qgcm9vdCA9ICcuaW52ZXN0aWdhdGlvbi1ib2FyZC10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uZ3JvdXAtYWRkLWJ1dHRvbmApLCAnY2xpY2snLCBhZGRHcm91cCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uZ3JvdXAtc3dpdGNoLWJ1dHRvbmApLCAnY2xpY2snLCBzd2l0Y2hHcm91cCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uZ3JvdXAtc2F2ZS1ub3Rlcy1idXR0b25gKSwgJ2NsaWNrJywgc2V0R3JvdXBOb3Rlcyk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIGNyZWF0ZVJlc291cmNlKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW5hbWUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCByZW5hbWVSZXNvdXJjZSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZWRnZS1idXR0b25gKSwgJ2NsaWNrJywgdXBkYXRlRWRnZSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNhbmNlbC1ub2RlLWFkZGluZy1idXR0b25gKSwgJ2NsaWNrJywgY2FuY2VsKCcuYm9hcmQtYWRkLW5vZGUtcG9wdXAnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uY2FuY2VsLXJlc291cmNlLWVkaXRpbmctYnV0dG9uYCksICdjbGljaycsIGNhbmNlbCgnLmJvYXJkLWVkaXQtcmVzb3VyY2UtcG9wdXAnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uY2FuY2VsLWdyb3VwLWVkaXRpbmctYnV0dG9uYCksICdjbGljaycsIGNhbmNlbCgnLmJvYXJkLWVkaXQtZ3JvdXAtcG9wdXAnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uY2FuY2VsLWFkZC1lZGdlLWJ1dHRvbmApLCAnY2xpY2snLCBjYW5jZWwoJy5ib2FyZC1hZGQtZWRnZS1wb3B1cCcpKTtcclxuXHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KCk7XHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgIG5vZGVzOiBzdGF0ZS5ub2Rlc0RhdGFzZXQsXHJcbiAgICAgICAgICAgIGVkZ2VzOiBzdGF0ZS5lZGdlc0RhdGFzZXRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBxdWVyeUVsKGAke3Jvb3R9LnNjaGVtYS1jb250YWluZXJgKTtcclxuICAgICAgICBzdGF0ZS5uZXR3b3JrID0gbmV3IHZpcy5OZXR3b3JrKGNvbnRhaW5lciwgZGF0YSwgQ29uc3RhbnRzLmludmVzdGlnYXRpb25Cb2FyZE9wdHMpO1xyXG4gICAgICAgIHN0YXRlLm5ldHdvcmsub24oJ3NlbGVjdEVkZ2UnLCBzaG93RWRnZUxhYmVsRWRpdG9yKTtcclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLm9uKCdkZXNlbGVjdEVkZ2UnLCBoaWRlRWRnZUxhYmVsRWRpdG9yKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKHNvZnRSZWZyZXNoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2dyb3VwJywgZmFsc2UsIFV0aWxzLnByb2Nlc3NFcnJvcigoZ3JvdXBOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmdldEludmVzdGlnYXRpb25Cb2FyZERhdGEoKGVyciwgaWJEYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbGxHcm91cE5hbWVzID0gZ3JvdXBOYW1lcy5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGliR3JvdXBOYW1lcyA9IFIua2V5cyhpYkRhdGEuZ3JvdXBzKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZyZWVHcm91cE5hbWVzID0gUi5kaWZmZXJlbmNlKGFsbEdyb3VwTmFtZXMsIGliR3JvdXBOYW1lcyk7XHJcblxyXG4gICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9Lmdyb3VwLWFkZC1zZWxlY3RgKSk7XHJcbiAgICAgICAgICAgICAgICAkKGAke3Jvb3R9Lmdyb3VwLWFkZC1zZWxlY3RgKS5zZWxlY3QyKGFycjJTZWxlY3QyKGZyZWVHcm91cE5hbWVzKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9Lmdyb3VwLXN3aXRjaC1zZWxlY3RgKSk7XHJcbiAgICAgICAgICAgICAgICAkKGAke3Jvb3R9Lmdyb3VwLXN3aXRjaC1zZWxlY3RgKS5zZWxlY3QyKGFycjJTZWxlY3QyKGZyZWVHcm91cE5hbWVzKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFzb2Z0UmVmcmVzaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZHJhd0JvYXJkKGliRGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gYWRkTm9kZShub2RlLCBjYWxsYmFjaykge1xyXG4gICAgICAgIHNob3dQb3B1cCgnLmJvYXJkLWFkZC1ub2RlLXBvcHVwJywgdHJ1ZSk7XHJcbiAgICAgICAgc3RhdGUubW9kaWZ5QXJncyA9IHtcclxuICAgICAgICAgICAgbmV3Tm9kZTogbm9kZSxcclxuICAgICAgICAgICAgY2FsbGJhY2tcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGFkZEdyb3VwKCkge1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9Lmdyb3VwLWFkZC1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgREJNUy5hZGRCb2FyZEdyb3VwKG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgc2V0Tm9kZShuYW1lLCAnZ3JvdXBzJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlUmVzb3VyY2UoKSB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1lbnRpdHktaW5wdXRgKTtcclxuICAgICAgICBjb25zdCBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIERCTVMuY3JlYXRlUmVzb3VyY2UobmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBzZXROb2RlKG5hbWUsICdyZXNvdXJjZXMnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZXROb2RlKG5vZGVOYW1lLCBncm91cCkge1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSBzdGF0ZS5tb2RpZnlBcmdzLm5ld05vZGU7XHJcbiAgICAgICAgaWYgKGdyb3VwID09PSAnZ3JvdXBzJykge1xyXG4gICAgICAgICAgICBub2RlLm9yaWdpbmFsTGFiZWwgPSBub2RlTmFtZTtcclxuICAgICAgICAgICAgbm9kZS5vcmlnaW5hbE5vdGVzID0gJyc7XHJcbiAgICAgICAgICAgIG5vZGUubGFiZWwgPSBtYWtlRGlzcGxheUxhYmVsKG5vZGUub3JpZ2luYWxMYWJlbCwgbm9kZS5vcmlnaW5hbE5vdGVzKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub2RlLmxhYmVsID0gbm9kZU5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5vZGUuaWQgPSBfbWFrZVJlbE5vZGVJZChub2RlTmFtZSwgZ3JvdXApO1xyXG4gICAgICAgIG5vZGUuZ3JvdXAgPSBncm91cDtcclxuICAgICAgICBzaG93UG9wdXAoJy5ib2FyZC1hZGQtbm9kZS1wb3B1cCcsIGZhbHNlKTtcclxuICAgICAgICBleHBvcnRzLnJlZnJlc2godHJ1ZSk7XHJcbiAgICAgICAgc3RhdGUubW9kaWZ5QXJncy5jYWxsYmFjayhub2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBlZGl0Tm9kZUZ1bihub2RlLCBjYWxsYmFjaykge1xyXG4gICAgICAgIHN0YXRlLm1vZGlmeUFyZ3MgPSB7XHJcbiAgICAgICAgICAgIGVkaXROb2RlOiBub2RlLFxyXG4gICAgICAgICAgICBjYWxsYmFja1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChub2RlLmdyb3VwID09PSAnZ3JvdXBzJykge1xyXG4gICAgICAgICAgICBlZGl0R3JvdXAoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzaG93UG9wdXAoJy5ib2FyZC1lZGl0LXJlc291cmNlLXBvcHVwJywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGVkaXRHcm91cCgpIHtcclxuICAgICAgICBzaG93UG9wdXAoJy5ib2FyZC1lZGl0LWdyb3VwLXBvcHVwJywgdHJ1ZSk7XHJcbiAgICAgICAgcXVlcnlFbChgJHtyb290fS5ncm91cC1ub3Rlcy1lZGl0b3JgKS52YWx1ZSA9IHN0YXRlLm1vZGlmeUFyZ3MuZWRpdE5vZGUub3JpZ2luYWxOb3RlcztcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzd2l0Y2hHcm91cCgpIHtcclxuICAgICAgICBjb25zdCBub2RlID0gc3RhdGUubW9kaWZ5QXJncy5lZGl0Tm9kZTtcclxuICAgICAgICBjb25zdCBmcm9tTmFtZSA9IG5vZGUub3JpZ2luYWxMYWJlbDtcclxuICAgICAgICBjb25zdCB0b05hbWUgPSBxdWVyeUVsKGAke3Jvb3R9Lmdyb3VwLXN3aXRjaC1zZWxlY3RgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgeyBjYWxsYmFjayB9ID0gc3RhdGUubW9kaWZ5QXJncztcclxuXHJcbiAgICAgICAgREJNUy5zd2l0Y2hHcm91cHMoZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBub2RlLm9yaWdpbmFsTGFiZWwgPSB0b05hbWU7XHJcbiAgICAgICAgICAgIG5vZGUubGFiZWwgPSBtYWtlRGlzcGxheUxhYmVsKG5vZGUub3JpZ2luYWxMYWJlbCwgbm9kZS5vcmlnaW5hbE5vdGVzKTtcclxuICAgICAgICAgICAgc2hvd1BvcHVwKCcuYm9hcmQtZWRpdC1ncm91cC1wb3B1cCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobm9kZSk7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCh0cnVlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZXRHcm91cE5vdGVzKCkge1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSBzdGF0ZS5tb2RpZnlBcmdzLmVkaXROb2RlO1xyXG4gICAgICAgIGNvbnN0IG5vdGVzID0gcXVlcnlFbChgJHtyb290fS5ncm91cC1ub3Rlcy1lZGl0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgeyBjYWxsYmFjayB9ID0gc3RhdGUubW9kaWZ5QXJncztcclxuXHJcbiAgICAgICAgREJNUy5zZXRHcm91cE5vdGVzKG5vZGUub3JpZ2luYWxMYWJlbCwgbm90ZXMsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgbm9kZS5vcmlnaW5hbE5vdGVzID0gbm90ZXM7XHJcbiAgICAgICAgICAgIG5vZGUubGFiZWwgPSBtYWtlRGlzcGxheUxhYmVsKG5vZGUub3JpZ2luYWxMYWJlbCwgbm9kZS5vcmlnaW5hbE5vdGVzKTtcclxuICAgICAgICAgICAgc2hvd1BvcHVwKCcuYm9hcmQtZWRpdC1ncm91cC1wb3B1cCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobm9kZSk7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCh0cnVlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVSZXNvdXJjZSgpIHtcclxuICAgICAgICBjb25zdCBub2RlID0gc3RhdGUubW9kaWZ5QXJncy5lZGl0Tm9kZTtcclxuICAgICAgICBjb25zdCBmcm9tTmFtZSA9IG5vZGUubGFiZWw7XHJcbiAgICAgICAgY29uc3QgdG9OYW1lID0gcXVlcnlFbChgJHtyb290fS5yZW5hbWUtZW50aXR5LWlucHV0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIGNvbnN0IHsgY2FsbGJhY2sgfSA9IHN0YXRlLm1vZGlmeUFyZ3M7XHJcblxyXG4gICAgICAgIERCTVMucmVuYW1lUmVzb3VyY2UoZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgbm9kZS5sYWJlbCA9IHRvTmFtZTtcclxuICAgICAgICAgICAgc2hvd1BvcHVwKCcuYm9hcmQtZWRpdC1yZXNvdXJjZS1wb3B1cCcsIGZhbHNlKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobm9kZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZGVsZXRlTm9kZShkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGRhdGEubm9kZXNbMF0pO1xyXG4gICAgICAgIGNvbnN0IGZ1bmNOYW1lID0gbm9kZS5ncm91cCA9PT0gJ2dyb3VwcycgPyAncmVtb3ZlQm9hcmRHcm91cCcgOiAncmVtb3ZlUmVzb3VyY2UnO1xyXG4gICAgICAgIGNvbnN0IG1zZyA9IG5vZGUuZ3JvdXAgPT09ICdncm91cHMnID8gZ2V0TDEwbignaW52ZXN0aWdhdGlvbi1ib2FyZC1jb25maXJtLWdyb3VwLW5vZGUtcmVtb3ZpbmcnKSA6XHJcbiAgICAgICAgICAgIGdldEwxMG4oJ2ludmVzdGlnYXRpb24tYm9hcmQtY29uZmlybS1yZXNvdXJjZS1ub2RlLXJlbW92aW5nJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxhYmVsID0gbm9kZS5ncm91cCA9PT0gJ2dyb3VwcycgPyBub2RlLm9yaWdpbmFsTGFiZWwgOiBub2RlLmxhYmVsO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KG1zZywgW2xhYmVsXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNU1tmdW5jTmFtZV0obGFiZWwsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgY2FsbGJhY2soKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2godHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSwgY2FsbGJhY2spO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHByZXBhcmVTdHIoc3RyKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0ci5zcGxpdCgnXFxuJykubWFwKFIuc3BsaXRFdmVyeSgyMCkpLm1hcChSLmpvaW4oJ1xcbicpKS5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlRGlzcGxheUxhYmVsKGxhYmVsLCBub3Rlcykge1xyXG4gICAgICAgIHJldHVybiBwcmVwYXJlU3RyKGxhYmVsKSArIChub3Rlcy50cmltKCkgPT09ICcnID8gJycgOiAoYFxcblxcbiR7cHJlcGFyZVN0cihub3Rlcyl9YCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIF9tYWtlUmVsTm9kZUlkKG5hbWUsIHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKHR5cGUgPT09ICdncm91cHMnID8gJ2dyb3VwLScgOiAncmVzb3VyY2UtJykgKyBuYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlZHJhd0JvYXJkKGliRGF0YSkge1xyXG4gICAgICAgIGxldCBub2RlcyA9IFtdO1xyXG4gICAgICAgIGZ1bmN0aW9uIG1ha2VSZXNvdXJjZU5vZGUobmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgbGFiZWw6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICBpZDogX21ha2VSZWxOb2RlSWQobmFtZSwgJ3Jlc291cmNlcycpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZ1bmN0aW9uIG1ha2VHcm91cE5vZGUobm9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxMYWJlbDogbm9kZS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxOb3Rlczogbm9kZS5ub3RlcyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiBtYWtlRGlzcGxheUxhYmVsKG5vZGUubmFtZSwgbm9kZS5ub3RlcyksXHJcbiAgICAgICAgICAgICAgICBpZDogX21ha2VSZWxOb2RlSWQobm9kZS5uYW1lLCAnZ3JvdXBzJylcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5vZGVzID0gbm9kZXMuY29uY2F0KFIudmFsdWVzKGliRGF0YS5ncm91cHMpLm1hcChtYWtlR3JvdXBOb2RlKS5tYXAoUi5tZXJnZSh7IGdyb3VwOiAnZ3JvdXBzJyB9KSkpO1xyXG4gICAgICAgIG5vZGVzID0gbm9kZXMuY29uY2F0KFIua2V5cyhpYkRhdGEucmVzb3VyY2VzKS5tYXAobWFrZVJlc291cmNlTm9kZSkubWFwKFIubWVyZ2UoeyBncm91cDogJ3Jlc291cmNlcycgfSkpKTtcclxuXHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0LmFkZChub2Rlcyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGVkZ2VzID0gUi5mbGF0dGVuKFIua2V5cyhpYkRhdGEucmVsYXRpb25zKS5tYXAocmVsMSA9PiBSLmtleXMoaWJEYXRhLnJlbGF0aW9uc1tyZWwxXSkubWFwKHJlbDIgPT4gKHtcclxuICAgICAgICAgICAgZnJvbTogcmVsMSxcclxuICAgICAgICAgICAgdG86IHJlbDIsXHJcbiAgICAgICAgICAgIGxhYmVsOiBpYkRhdGEucmVsYXRpb25zW3JlbDFdW3JlbDJdLFxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBpZDogcmVsMSArICctJyArIHJlbDJcclxuICAgICAgICB9KSkpKTtcclxuXHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LmNsZWFyKCk7XHJcbiAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LmFkZChlZGdlcyk7XHJcblxyXG4gICAgICAgIGxldCBvcHRzID0gQ29tbW9uVXRpbHMuY2xvbmUoQ29uc3RhbnRzLmludmVzdGlnYXRpb25Cb2FyZE9wdHMpO1xyXG4gICAgICAgIG9wdHMgPSBSLm1lcmdlKG9wdHMsIHtcclxuICAgICAgICAgICAgbG9jYWxlOiBMMTBuLmdldExhbmcoKSxcclxuICAgICAgICAgICAgbG9jYWxlczogQ29uc3RhbnRzLnZpc0xvY2FsZXMsXHJcbiAgICAgICAgICAgIG1hbmlwdWxhdGlvbjoge1xyXG4gICAgICAgICAgICAgICAgYWRkTm9kZSxcclxuICAgICAgICAgICAgICAgIGRlbGV0ZU5vZGUsXHJcbiAgICAgICAgICAgICAgICBlZGl0Tm9kZTogZWRpdE5vZGVGdW4sXHJcbiAgICAgICAgICAgICAgICBhZGRFZGdlOiBjcmVhdGVFZGdlLFxyXG4gICAgICAgICAgICAgICAgZWRpdEVkZ2U6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgZGVsZXRlRWRnZSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgLy8gICAgICAgIGNvbmZpZ3VyZTogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdGF0ZS5uZXR3b3JrLnNldE9wdGlvbnMob3B0cyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0VkZ2VMYWJlbEVkaXRvcihwYXJhbXMpIHtcclxuICAgICAgICBpZiAocGFyYW1zLmVkZ2VzLmxlbmd0aCAhPT0gMCAmJiBwYXJhbXMubm9kZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSBzdGF0ZS5lZGdlc0RhdGFzZXQuZ2V0KHBhcmFtcy5lZGdlc1swXSk7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vZGlmeUFyZ3MgPSB7XHJcbiAgICAgICAgICAgICAgICBlZGdlLFxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZWRnZTIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZWRnZTIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuZWRnZXNEYXRhc2V0LnVwZGF0ZShlZGdlMik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGVkaXRFZGdlOiB0cnVlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0uYWRkLWVkZ2UtbGFiZWwtaW5wdXRgKS52YWx1ZSA9IGVkZ2UubGFiZWw7XHJcbiAgICAgICAgICAgIHNob3dQb3B1cCgnLmJvYXJkLWFkZC1lZGdlLXBvcHVwJywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gaGlkZUVkZ2VMYWJlbEVkaXRvcihwYXJhbXMpIHtcclxuICAgICAgICBzaG93UG9wdXAoJy5ib2FyZC1hZGQtZWRnZS1wb3B1cCcsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVFZGdlKGRhdGEsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgY29uc3QgZnJvbU5vZGUgPSBzdGF0ZS5ub2Rlc0RhdGFzZXQuZ2V0KGRhdGEuZnJvbSk7XHJcbiAgICAgICAgY29uc3QgdG9Ob2RlID0gc3RhdGUubm9kZXNEYXRhc2V0LmdldChkYXRhLnRvKTtcclxuXHJcbiAgICAgICAgREJNUy5hZGRFZGdlKGZyb21Ob2RlLmlkLCB0b05vZGUuaWQsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBjYWxsYmFjaygpOyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGVkZ2UgPSB7XHJcbiAgICAgICAgICAgICAgICBmcm9tOiBmcm9tTm9kZS5pZCxcclxuICAgICAgICAgICAgICAgIHRvOiB0b05vZGUuaWQsXHJcbiAgICAgICAgICAgICAgICBsYWJlbDogJycsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGVkZ2UpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBzdGF0ZS5lZGdlc0RhdGFzZXQuZ2V0KHtcclxuICAgICAgICAgICAgICAgIGZpbHRlcihpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0uZnJvbSA9PT0gZnJvbU5vZGUuaWQgJiYgaXRlbS50byA9PT0gdG9Ob2RlLmlkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHNob3dFZGdlTGFiZWxFZGl0b3IoeyBlZGdlczogW2l0ZW1zWzBdLmlkXSwgbm9kZXM6IFtdIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUVkZ2UoKSB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBxdWVyeUVsKGAke3Jvb3R9LmFkZC1lZGdlLWxhYmVsLWlucHV0YCk7XHJcbiAgICAgICAgY29uc3QgbGFiZWwgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgeyBlZGdlIH0gPSBzdGF0ZS5tb2RpZnlBcmdzO1xyXG4gICAgICAgIERCTVMuc2V0RWRnZUxhYmVsKGVkZ2UuZnJvbSwgZWRnZS50bywgbGFiZWwsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuXHJcbiAgICAgICAgICAgIGVkZ2UubGFiZWwgPSBsYWJlbDtcclxuICAgICAgICAgICAgc2hvd1BvcHVwKCcuYm9hcmQtYWRkLWVkZ2UtcG9wdXAnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vZGlmeUFyZ3MuY2FsbGJhY2soZWRnZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZGVsZXRlRWRnZShkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgICAgIGNvbnN0IGVkZ2UgPSBzdGF0ZS5lZGdlc0RhdGFzZXQuZ2V0KGRhdGEuZWRnZXNbMF0pO1xyXG4gICAgICAgIERCTVMucmVtb3ZlRWRnZShlZGdlLmZyb20sIGVkZ2UudG8sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyBjYWxsYmFjaygpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2FuY2VsKHNlbGVjdG9yKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgc2hvd1BvcHVwKHNlbGVjdG9yLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vZGlmeUFyZ3MuY2FsbGJhY2soKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNob3dQb3B1cChzZWxlY3Rvciwgc2hvdykge1xyXG4gICAgICAgIGhpZGVFbChxdWVyeUVsKHJvb3QgKyBzZWxlY3RvciksICFzaG93KTtcclxuICAgIH1cclxufSkodGhpcy5JbnZlc3RpZ2F0aW9uQm9hcmQgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnByb2ZpbGUtZmlsdGVyLXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBjcmVhdGVHcm91cERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIEdyb3VwUHJvZmlsZS5jcmVhdGVHcm91cChmYWxzZSwgZXhwb3J0cy5yZWZyZXNoKSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnZ3JvdXBzLWVudGVyLWdyb3VwLW5hbWUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCByZW5hbWVHcm91cERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHJlbmFtZUdyb3VwKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdncm91cHMtZW50ZXItbmV3LWdyb3VwLW5hbWUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1yZW5hbWUnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4vLyAgICAgICAgc3RhdGUuYWRkRmlsdGVyQ29uZGl0aW9uRGlhbG9nID0gbmV3IEFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZyhyb290KTtcclxuLy8gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGUuZmlsdGVyLWNvbmRpdGlvbmApLCAnY2xpY2snLCBvbkFkZEZpbHRlckNvbmRpdGlvbik7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9I3Byb2ZpbGUtZmlsdGVyLWNvbHVtbnMgLnByb2ZpbGUtaXRlbS1zZWxlY3RvcmApLCAnY2hhbmdlJywgVUkuc2hvd1NlbGVjdGVkRWxzMyhyb290LCAnZGVwZW5kZW50JywgJ2RlcGVuZGVudC1pbmRleCcpKTtcclxuICAgICAgICBcclxuLy8gICAgICAgIFV0aWxzLmVuYWJsZShleHBvcnRzLmNvbnRlbnQsICdpc0dyb3VwRWRpdGFibGUnLCBpc0dyb3VwRWRpdGFibGUpO1xyXG4vLyAgICAgICAgbGlzdGVuIHF1ZXJ5RWwoYCR7cm9vdH0uc2F2ZS1lbnRpdHktc2VsZWN0YClcclxuICAgICAgICBcclxuICAgICAgICAkKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnNlbGVjdDIoKS5vbignY2hhbmdlJywgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyR3JvdXBzID0gc3RhdGUudXNlckdyb3VwTmFtZXMubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzR3JvdXBFZGl0YWJsZSA9IFIuY29udGFpbnMoZ3JvdXAsIHVzZXJHcm91cHMpO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNHcm91cEVkaXRhYmxlJywgaXNHcm91cEVkaXRhYmxlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uc2hvdy1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIGxvYWRGaWx0ZXJGcm9tR3JvdXApO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBzYXZlRmlsdGVyVG9Hcm91cCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0uZG93bmxvYWQtZmlsdGVyLXRhYmxlYCksICdjbGljaycsIGRvd25sb2FkRmlsdGVyVGFibGUpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uY3JlYXRlLmdyb3VwYCksICdjbGljaycsICgpID0+IGNyZWF0ZUdyb3VwRGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LnJlbmFtZS5ncm91cGApLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHFlZShyZW5hbWVHcm91cERpYWxvZywgJy5lbnRpdHktaW5wdXQnKS52YWx1ZSA9IHF1ZXJ5RWwoYCR7cm9vdH0uc2F2ZS1lbnRpdHktc2VsZWN0YCkudmFsdWU7XHJcbiAgICAgICAgICAgIHJlbmFtZUdyb3VwRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUuZ3JvdXBgKSwgJ2NsaWNrJywgR3JvdXBQcm9maWxlLnJlbW92ZUdyb3VwKCgpID0+IFxyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnZhbHVlLCBleHBvcnRzLnJlZnJlc2gpKTtcclxuXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBzdGF0ZS5zb3J0S2V5ID0gQ29uc3RhbnRzLkNIQVJfTkFNRTtcclxuICAgICAgICBzdGF0ZS5zb3J0RGlyID0gJ2FzYyc7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtcyA9IHt9O1xyXG4gICAgICAgIHN0YXRlLmNoZWNrYm94ZXMgPSB7fTtcclxuICAgICAgICBzdGF0ZS5jdXJGaWx0ZXJNb2RlbCA9IFtdO1xyXG5cclxuICAgICAgICBjb25zdCBmaWx0ZXJTZXR0aW5nc0RpdiA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5maWx0ZXItc2V0dGluZ3MtcGFuZWxgKSk7XHJcbiAgICAgICAgYWRkRWwoZmlsdGVyU2V0dGluZ3NEaXYsIGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdzZXBhcmF0b3InKSk7XHJcblxyXG4gICAgICAgIGdyb3VwQXJlYVJlZnJlc2goKTtcclxuXHJcbiAgICAgICAgRmlsdGVyQ29uZmlndXJhdGlvbi5tYWtlRmlsdGVyQ29uZmlndXJhdGlvbigoZXJyLCBmaWx0ZXJDb25maWd1cmF0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICBzdGF0ZS5maWx0ZXJDb25maWd1cmF0aW9uID0gZmlsdGVyQ29uZmlndXJhdGlvbjtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQubm8tY2hhcmFjdGVyc2ApLCAhZmlsdGVyQ29uZmlndXJhdGlvbi5oYXZlUHJvZmlsZXMoKSk7XHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQubm8tcGxheWVyc2ApLCAhZmlsdGVyQ29uZmlndXJhdGlvbi5oYXZlUHJvZmlsZXMoKSk7XHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQubm8tY2hhcmFjdGVyLXByb2ZpbGVgKSwgIWZpbHRlckNvbmZpZ3VyYXRpb24uaGF2ZVByb2ZpbGVTdHJ1Y3R1cmVzKCkpO1xyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLXBsYXllci1wcm9maWxlYCksICFmaWx0ZXJDb25maWd1cmF0aW9uLmhhdmVQcm9maWxlU3RydWN0dXJlcygpKTtcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5wcm9maWxlLWZpbHRlci1jb250YWluZXIgLnBhbmVsYCksIGZpbHRlckNvbmZpZ3VyYXRpb24uaGF2ZURhdGEoKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBncm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zID0gZmlsdGVyQ29uZmlndXJhdGlvbi5nZXRHcm91cGVkUHJvZmlsZUZpbHRlckl0ZW1zKCk7XHJcbiAgICAgICAgICAgIGFkZEVscyhmaWx0ZXJTZXR0aW5nc0RpdiwgUi5mbGF0dGVuKGdyb3VwZWRQcm9maWxlRmlsdGVySXRlbXMubWFwKGl0ZW0gPT4gUi5jb25jYXQoaXRlbS5wcm9maWxlRmlsdGVySXRlbXMubWFwKG1ha2VJbnB1dCksIFthZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnZmlsdGVyU2VwYXJhdG9yJyldKSkpKTtcclxuXHJcbiAgICAgICAgICAgIFVJLmZpbGxTaG93SXRlbVNlbGVjdG9yMihcclxuICAgICAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSNwcm9maWxlLWZpbHRlci1jb2x1bW5zIC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKSksXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJDb25maWd1cmF0aW9uLmdldEdyb3Vwc0ZvclNlbGVjdCgpLFxyXG4gICAgICAgICAgICAgICAgdHJ1ZVxyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgYWRkRWwoXHJcbiAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uZmlsdGVyLWhlYWRgKSksXHJcbiAgICAgICAgICAgICAgICBtYWtlQ29udGVudEhlYWRlcihnZXRIZWFkZXJQcm9maWxlSXRlbU5hbWVzKGZpbHRlckNvbmZpZ3VyYXRpb24uZ2V0UHJvZmlsZUZpbHRlckl0ZW1zKCkpKVxyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgcmVidWlsZENvbnRlbnQoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIG9uQWRkRmlsdGVyQ29uZGl0aW9uKCkge1xyXG4gICAgICAgIHN0YXRlLmFkZEZpbHRlckNvbmRpdGlvbkRpYWxvZy5zaG93RGxnKHN0YXRlLmZpbHRlckNvbmZpZ3VyYXRpb24uZ2V0R3JvdXBzRm9yU2VsZWN0KCksIHNldEZpbHRlck1vZGVsSXRlbSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHNldEZpbHRlck1vZGVsSXRlbSAoZmlsdGVyTW9kZWxJdGVtKSB7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSBSLmZpbmRJbmRleChSLnByb3BFcSgnbmFtZScsIGZpbHRlck1vZGVsSXRlbS5uYW1lKSwgc3RhdGUuY3VyRmlsdGVyTW9kZWwpO1xyXG4gICAgICAgIGlmKGluZGV4ID09PSAtMSl7XHJcbiAgICAgICAgICAgIHN0YXRlLmN1ckZpbHRlck1vZGVsLnB1c2goZmlsdGVyTW9kZWxJdGVtKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzdGF0ZS5jdXJGaWx0ZXJNb2RlbFtpbmRleF0gPSBmaWx0ZXJNb2RlbEl0ZW07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBncm91cEFyZWFSZWZyZXNoKCkge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdncm91cCcsIHRydWUsIFV0aWxzLnByb2Nlc3NFcnJvcigodXNlckdyb3VwTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2dyb3VwJywgZmFsc2UsIFV0aWxzLnByb2Nlc3NFcnJvcigoYWxsR3JvdXBOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW5hbWUuZ3JvdXBgKSwgYWxsR3JvdXBOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnJlbW92ZS5ncm91cGApLCBhbGxHcm91cE5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0uc2hvdy1lbnRpdHktYnV0dG9uYCksIGFsbEdyb3VwTmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5zYXZlLWVudGl0eS1idXR0b25gKSwgYWxsR3JvdXBOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLCBhbGxHcm91cE5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS51c2VyR3JvdXBOYW1lcyA9IHVzZXJHcm91cE5hbWVzO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuYWxsR3JvdXBOYW1lcyA9IGFsbEdyb3VwTmFtZXM7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGEoYWxsR3JvdXBOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uc2F2ZS1lbnRpdHktc2VsZWN0YCkpO1xyXG4gICAgICAgICAgICAgICAgJChgJHtyb290fS5zYXZlLWVudGl0eS1zZWxlY3RgKS5zZWxlY3QyKGRhdGEpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEhlYWRlclByb2ZpbGVJdGVtTmFtZXMocHJvZmlsZVNldHRpbmdzKSB7XHJcbiAgICAgICAgcmV0dXJuIFIubWFwKFIucGljayhbJ25hbWUnLCAnZGlzcGxheU5hbWUnLCAndHlwZSddKSwgcHJvZmlsZVNldHRpbmdzKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlUHJpbnREYXRhKCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGFBcnJheXMgPSBzdGF0ZS5maWx0ZXJDb25maWd1cmF0aW9uLmdldERhdGFBcnJheXMobWFrZUZpbHRlck1vZGVsKCkpO1xyXG5cclxuICAgICAgICBjb25zdCBzb3J0RnVuYyA9IENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeUJhc2Uoc3RhdGUuc29ydERpciwgKGEsIGIpID0+IGEgPiBiLCAoYSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtYXAgPSBDb21tb25VdGlscy5hcnIybWFwKGEsICdpdGVtTmFtZScpO1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gbWFwW3N0YXRlLnNvcnRLZXldO1xyXG4gICAgICAgICAgICBsZXQgeyB2YWx1ZSB9ID0gaXRlbTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgc3dpdGNoIChpdGVtLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtpdGVtLnR5cGV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBkYXRhQXJyYXlzLnNvcnQoc29ydEZ1bmMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlYnVpbGRDb250ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGRhdGFBcnJheXMgPSBtYWtlUHJpbnREYXRhKCk7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmZpbHRlci1yZXN1bHQtc2l6ZWApKSwgbWFrZVRleHQoZGF0YUFycmF5cy5sZW5ndGgpKTtcclxuICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LmZpbHRlci1jb250ZW50YCkpLCBkYXRhQXJyYXlzLm1hcChtYWtlRGF0YVN0cmluZykpO1xyXG4gICAgICAgIFVJLnNob3dTZWxlY3RlZEVsczMocm9vdCwgJ2RlcGVuZGVudCcsICdkZXBlbmRlbnQtaW5kZXgnKSh7IHRhcmdldDogcXVlcnlFbChgJHtyb290fSNwcm9maWxlLWZpbHRlci1jb2x1bW5zIC5wcm9maWxlLWl0ZW0tc2VsZWN0b3JgKSB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzYXZlRmlsdGVyVG9Hcm91cCgpIHtcclxuICAgICAgICBjb25zdCBncm91cE5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnZhbHVlO1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdncm91cCcsIGdyb3VwTmFtZSwgKGVyciwgaXNHcm91cEVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGlmICghaXNHcm91cEVkaXRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChzdHJGb3JtYXQoZ2V0TDEwbignZ3JvdXBzLWdyb3VwLWVkaXRpbmctZm9yYmlkZGVuJyksIFtncm91cE5hbWVdKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgREJNUy5zYXZlRmlsdGVyVG9Hcm91cChncm91cE5hbWUsIG1ha2VGaWx0ZXJNb2RlbCgpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbG9hZEZpbHRlckZyb21Hcm91cCgpIHtcclxuICAgICAgICBjb25zdCBncm91cE5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnNhdmUtZW50aXR5LXNlbGVjdGApLnZhbHVlO1xyXG4gICAgICAgIERCTVMuZ2V0R3JvdXAoZ3JvdXBOYW1lLCAoZXJyLCBncm91cCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCBjb25mbGljdFR5cGVzID1cclxuICAgICAgICAgICAgICAgIFByb2plY3RVdGlscy5pc0ZpbHRlck1vZGVsQ29tcGF0aWJsZVdpdGhQcm9maWxlcyhcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5maWx0ZXJDb25maWd1cmF0aW9uLmdldEJhc2VQcm9maWxlU2V0dGluZ3MoKSxcclxuICAgICAgICAgICAgICAgICAgICBncm91cC5maWx0ZXJNb2RlbFxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgaWYgKGNvbmZsaWN0VHlwZXMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChzdHJGb3JtYXQoZ2V0TDEwbignZ3JvdXBzLWJhc2UtZmlsdGVyLWlzLWluY29tcGF0aWJsZS13aXRoLXBhZ2UtcHJvZmlsZXMnKSwgW2NvbmZsaWN0VHlwZXMuam9pbignLCcpXSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGFwcGx5RmlsdGVyTW9kZWwoZ3JvdXAuZmlsdGVyTW9kZWwpO1xyXG4gICAgICAgICAgICByZWJ1aWxkQ29udGVudCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGRvd25sb2FkRmlsdGVyVGFibGUoKSB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKGAke3Jvb3R9I3Byb2ZpbGUtZmlsdGVyLWNvbHVtbnMgLnByb2ZpbGUtaXRlbS1zZWxlY3RvcmApO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGVkW2ldID0gZWwub3B0aW9uc1tpXS5zZWxlY3RlZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGFBcnJheXMgPSBtYWtlUHJpbnREYXRhKCk7XHJcbiAgICAgICAgY29uc3QgY2xlYW5BcnJheXMgPSBkYXRhQXJyYXlzLm1hcChkYXRhQXJyYXkgPT4gZGF0YUFycmF5LmZpbHRlcigoaXRlbSwgaW5kZXgpID0+IHNlbGVjdGVkW2luZGV4XSkubWFwKFIucHJvcCgndmFsdWUnKSkpO1xyXG5cclxuICAgICAgICBGaWxlVXRpbHMuYXJyMmQyQ3N2KGNsZWFuQXJyYXlzLCAncHJvZmlsZUZpbHRlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGFwcGx5RmlsdGVyTW9kZWwoZmlsdGVyTW9kZWwpIHtcclxuICAgICAgICBmaWx0ZXJNb2RlbCA9IENvbW1vblV0aWxzLmFycjJtYXAoZmlsdGVyTW9kZWwsICduYW1lJyk7XHJcblxyXG4gICAgICAgIE9iamVjdC5rZXlzKHN0YXRlLmlucHV0SXRlbXMpLmZvckVhY2goKGlucHV0SXRlbU5hbWUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGlucHV0SXRlbU5hbWUuZW5kc1dpdGgoJzpudW1iZXJJbnB1dCcpIHx8IGlucHV0SXRlbU5hbWUuZW5kc1dpdGgoJzptdWx0aUVudW1JbnB1dCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0SXRlbSA9IHN0YXRlLmlucHV0SXRlbXNbaW5wdXRJdGVtTmFtZV07XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZE9wdGlvbnMsIHJlZ2V4LCBudW0sIGksIGNvdW50ZXI7XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RhdGUuY2hlY2tib3hlc1tpbnB1dEl0ZW1OYW1lXS5jaGVja2VkICE9PSAoZmlsdGVyTW9kZWxbaW5wdXRJdGVtTmFtZV0gIT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrYm94ZXNbaW5wdXRJdGVtTmFtZV0uY2xpY2soKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWZpbHRlck1vZGVsW2lucHV0SXRlbU5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2VsZWN0O1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChpbnB1dEl0ZW0uc2VsZkluZm8udHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0SXRlbS5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS5vcHRpb25zW2ldLnNlbGVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmlucHV0SXRlbXNbYCR7aW5wdXRJdGVtLnNlbGZJbmZvLm5hbWV9Om51bWJlcklucHV0YF0udmFsdWUgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS52YWx1ZSA9ICdpZ25vcmUnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3QgPSBzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTptdWx0aUVudW1JbnB1dGBdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWxlY3Qub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Qub3B0aW9uc1tpXS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS52YWx1ZSA9ICdpZ25vcmUnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke2lucHV0SXRlbS5zZWxmSW5mby50eXBlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbW9kZWxJdGVtID0gZmlsdGVyTW9kZWxbaW5wdXRJdGVtTmFtZV07XHJcbiAgICAgICAgICAgICAgICBsZXQgc2VsZWN0O1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChpbnB1dEl0ZW0uc2VsZkluZm8udHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGlucHV0SXRlbS5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0SXRlbS5vcHRpb25zW2ldLnNlbGVjdGVkID0gISFtb2RlbEl0ZW0uc2VsZWN0ZWRPcHRpb25zW2lucHV0SXRlbS5vcHRpb25zW2ldLnZhbHVlXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtLm9wdGlvbnNbMF0uc2VsZWN0ZWQgPSBtb2RlbEl0ZW0uc2VsZWN0ZWRPcHRpb25zLnRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtLm9wdGlvbnNbMV0uc2VsZWN0ZWQgPSBtb2RlbEl0ZW0uc2VsZWN0ZWRPcHRpb25zLmZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0udmFsdWUgPSBtb2RlbEl0ZW0uY29uZGl0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmlucHV0SXRlbXNbYCR7aW5wdXRJdGVtLnNlbGZJbmZvLm5hbWV9Om51bWJlcklucHV0YF0udmFsdWUgPSBtb2RlbEl0ZW0ubnVtO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgICAgICAgICBpbnB1dEl0ZW0udmFsdWUgPSBtb2RlbEl0ZW0uY29uZGl0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdCA9IHN0YXRlLmlucHV0SXRlbXNbYCR7aW5wdXRJdGVtLnNlbGZJbmZvLm5hbWV9Om11bHRpRW51bUlucHV0YF07XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbGVjdC5vcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC5vcHRpb25zW2ldLnNlbGVjdGVkID0gISFtb2RlbEl0ZW0uc2VsZWN0ZWRPcHRpb25zW3NlbGVjdC5vcHRpb25zW2ldLnZhbHVlXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRJdGVtLnZhbHVlID0gbW9kZWxJdGVtLnJlZ2V4U3RyaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke2lucHV0SXRlbS5zZWxmSW5mby50eXBlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUZpbHRlck1vZGVsKCkge1xyXG4gICAgICAgIGNvbnN0IG1vZGVsID0gW107XHJcbiAgICAgICAgT2JqZWN0LmtleXMoc3RhdGUuaW5wdXRJdGVtcykuZm9yRWFjaCgoaW5wdXRJdGVtTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaW5wdXRJdGVtTmFtZS5lbmRzV2l0aCgnOm51bWJlcklucHV0JykgfHwgaW5wdXRJdGVtTmFtZS5lbmRzV2l0aCgnOm11bHRpRW51bUlucHV0JykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc3RhdGUuY2hlY2tib3hlc1tpbnB1dEl0ZW1OYW1lXS5jaGVja2VkID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0SXRlbSA9IHN0YXRlLmlucHV0SXRlbXNbaW5wdXRJdGVtTmFtZV07XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZE9wdGlvbnMsIHJlZ2V4LCBudW0sIGksIGFycjtcclxuICAgICAgICAgICAgY29uc3QgeyB0eXBlIH0gPSBpbnB1dEl0ZW0uc2VsZkluZm87XHJcblxyXG4gICAgICAgICAgICBsZXQgc2VsZWN0MjtcclxuICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgYXJyID0gbmwyYXJyYXkoaW5wdXRJdGVtLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wdXNoKHsgdHlwZSwgbmFtZTogaW5wdXRJdGVtTmFtZSwgc2VsZWN0ZWRPcHRpb25zOiBSLnppcE9iaihhcnIsIFIucmVwZWF0KHRydWUsIGFyci5sZW5ndGgpKSB9KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZE9wdGlvbnMgPSB7fTtcclxuICAgICAgICAgICAgICAgIGlmIChpbnB1dEl0ZW0ub3B0aW9uc1swXS5zZWxlY3RlZCkgeyBzZWxlY3RlZE9wdGlvbnMudHJ1ZSA9IHRydWU7IH1cclxuICAgICAgICAgICAgICAgIGlmIChpbnB1dEl0ZW0ub3B0aW9uc1sxXS5zZWxlY3RlZCkgeyBzZWxlY3RlZE9wdGlvbnMuZmFsc2UgPSB0cnVlOyB9XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wdXNoKHsgdHlwZSwgbmFtZTogaW5wdXRJdGVtTmFtZSwgc2VsZWN0ZWRPcHRpb25zIH0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXRJdGVtLnZhbHVlID09PSAnaWdub3JlJykgeyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIG51bSA9IE51bWJlcihzdGF0ZS5pbnB1dEl0ZW1zW2Ake2lucHV0SXRlbS5zZWxmSW5mby5uYW1lfTpudW1iZXJJbnB1dGBdLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIG1vZGVsLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGUsIG5hbWU6IGlucHV0SXRlbU5hbWUsIG51bSwgY29uZGl0aW9uOiBpbnB1dEl0ZW0udmFsdWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXRJdGVtLnZhbHVlID09PSAnaWdub3JlJykgeyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkT3B0aW9ucyA9IHt9O1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0MiA9IHN0YXRlLmlucHV0SXRlbXNbYCR7aW5wdXRJdGVtLnNlbGZJbmZvLm5hbWV9Om11bHRpRW51bUlucHV0YF07XHJcbiAgICAgICAgICAgICAgICBhcnIgPSBubDJhcnJheShzZWxlY3QyLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGlucHV0SXRlbU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBpbnB1dEl0ZW0udmFsdWUsXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRPcHRpb25zOiBSLnppcE9iaihhcnIsIFIucmVwZWF0KHRydWUsIGFyci5sZW5ndGgpKVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICBtb2RlbC5wdXNoKHsgdHlwZSwgbmFtZTogaW5wdXRJdGVtTmFtZSwgcmVnZXhTdHJpbmc6IGlucHV0SXRlbS52YWx1ZS50b0xvd2VyQ2FzZSgpIH0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke3R5cGV9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbW9kZWw7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZURhdGFTdHJpbmcoZGF0YUFycmF5KSB7XHJcbiAgICAgICAgY29uc3QgeyBpbnB1dEl0ZW1zIH0gPSBzdGF0ZTtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgndHInKSwgZGF0YUFycmF5Lm1hcCgodmFsdWVJbmZvLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCByZWdleCwgcG9zLCBkaXNwbGF5VmFsdWU7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IHZhbHVlSW5mbztcclxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSA9IGNvbnN0TDEwbignbm90QXZhaWxhYmxlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWVJbmZvLnR5cGUgPT09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSA9IGNvbnN0TDEwbihDb25zdGFudHNbdmFsdWVdKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZUluZm8udHlwZSA9PT0gJ3RleHQnKSB7XHJcbiAgICAgICAgICAgICAgICBwb3MgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoaW5wdXRJdGVtc1t2YWx1ZUluZm8uaXRlbU5hbWVdLnZhbHVlLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgICAgICAgICAgZGlzcGxheVZhbHVlID0gdmFsdWUuc3Vic3RyaW5nKHBvcyAtIDUsIHBvcyArIDE1KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChSLmNvbnRhaW5zKHZhbHVlSW5mby50eXBlLCBbJ251bWJlcicsICdlbnVtJywgJ211bHRpRW51bScsICdzdHJpbmcnXSkpIHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHZhbHVlSW5mby50eXBlOiAke3ZhbHVlSW5mby50eXBlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRkID0gYWRkRWwoc2V0Q2xhc3NCeUNvbmRpdGlvbihtYWtlRWwoJ3RkJyksICdsaWdodEdyZXknLCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSwgbWFrZVRleHQoZGlzcGxheVZhbHVlKSk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzZXModGQsIFtgZGVwZW5kZW50LSR7aX1gLCAnZGVwZW5kZW50JywgdmFsdWVJbmZvLnR5cGUgPT09ICdudW1iZXInID8gJ3RleHQtYWxpZ24tcmlnaHQnIDogJ3RleHQtYWxpZ24tbGVmdCddKTtcclxuICAgICAgICAgICAgc2V0QXR0cih0ZCwgJ2RlcGVuZGVudC1pbmRleCcsIGkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGQ7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VDb250ZW50SGVhZGVyKHByb2ZpbGVJdGVtTmFtZXMpIHtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgndHInKSwgcHJvZmlsZUl0ZW1OYW1lcy5tYXAoKGVsZW0sIGkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGQgPSBhZGRFbHMobWFrZUVsKCd0aCcpLCBbbWFrZVRleHQoYCR7ZWxlbS5kaXNwbGF5TmFtZX0gYCldKTtcclxuICAgICAgICAgICAgdGQuaW5mbyA9IGVsZW0ubmFtZTtcclxuICAgICAgICAgICAgYWRkQ2xhc3Nlcyh0ZCwgW2BkZXBlbmRlbnQtJHtpfWAsICdkZXBlbmRlbnQnLCAnc29ydGluZycsIGVsZW0udHlwZSA9PT0gJ251bWJlcicgPyAndGV4dC1hbGlnbi1yaWdodCcgOiAndGV4dC1hbGlnbi1sZWZ0J10pO1xyXG4gICAgICAgICAgICBzZXRBdHRyKHRkLCAnZGVwZW5kZW50LWluZGV4JywgaSk7XHJcbiAgICAgICAgICAgIGxpc3Rlbih0ZCwgJ2NsaWNrJywgb25Tb3J0Q2hhbmdlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRkO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvblNvcnRDaGFuZ2UoZXZlbnQpIHtcclxuICAgICAgICBsZXQgeyB0YXJnZXQgfSA9IGV2ZW50O1xyXG4gICAgICAgIGlmICh0YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnc3BhbicpIHtcclxuICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3RhdGUuc29ydEtleSA9PT0gdGFyZ2V0LmluZm8pIHtcclxuICAgICAgICAgICAgc3RhdGUuc29ydERpciA9IHN0YXRlLnNvcnREaXIgPT09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYyc7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGFyZ2V0LCAnc29ydERlc2MnLCBzdGF0ZS5zb3J0RGlyID09PSAnZGVzYycpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHRhcmdldCwgJ3NvcnRBc2MnLCBzdGF0ZS5zb3J0RGlyID09PSAnYXNjJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsdGVySGVhZCA9IHF1ZXJ5RWwoYCR7cm9vdH0uZmlsdGVyLWhlYWRgKTtcclxuICAgICAgICAgICAgbmwyYXJyYXkoZmlsdGVySGVhZC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdzb3J0QXNjJykpLmZvckVhY2gocmVtb3ZlQ2xhc3MoUi5fXywgJ3NvcnRBc2MnKSk7XHJcbiAgICAgICAgICAgIG5sMmFycmF5KGZpbHRlckhlYWQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnc29ydERlc2MnKSkuZm9yRWFjaChyZW1vdmVDbGFzcyhSLl9fLCAnc29ydERlc2MnKSk7XHJcblxyXG4gICAgICAgICAgICBzdGF0ZS5zb3J0S2V5ID0gdGFyZ2V0LmluZm87XHJcbiAgICAgICAgICAgIHN0YXRlLnNvcnREaXIgPSAnYXNjJztcclxuICAgICAgICAgICAgYWRkQ2xhc3ModGFyZ2V0LCAnc29ydEFzYycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZWJ1aWxkQ29udGVudCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VJbnB1dChwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIGNvbnN0IGVsID0gcW10ZShgJHtyb290fSAuZmlsdGVyLWl0ZW0tdG1wbGApO1xyXG4gICAgICAgIGNvbnN0IGNoZWNrYm94ID0gcWVlKGVsLCAnaW5wdXRbdHlwZT1cImNoZWNrYm94XCJdJyk7XHJcbiAgICAgICAgY29uc3QgaWQgPSBcImZpbHRlci1pdGVtLVwiICsgcHJvZmlsZUl0ZW1Db25maWcuZGlzcGxheU5hbWU7XHJcbiAgICAgICAgY2hlY2tib3guY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIGNoZWNrYm94LmlkID0gaWQ7XHJcbiAgICAgICAgYWRkRWwocWVlKGVsLCAnLmZpbHRlci1pdGVtLW5hbWUnKSwgbWFrZVRleHQocHJvZmlsZUl0ZW1Db25maWcuZGlzcGxheU5hbWUpKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJ2xhYmVsJyksICdmb3InLCBpZCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgaW5wdXRDb250YWluZXIgPSBxZWUoZWwsICcuZmlsdGVyLWl0ZW0tY29udGFpbmVyJyk7XHJcbiAgICAgICAgbGlzdGVuKGNoZWNrYm94LCAnY2xpY2snLCB0b2dnbGVDb250ZW50KGVsLCBpbnB1dENvbnRhaW5lcikpO1xyXG4gICAgICAgIHN0YXRlLmNoZWNrYm94ZXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBjaGVja2JveDtcclxuICAgICAgICBcclxuICAgICAgICBhZGRFbChpbnB1dENvbnRhaW5lciwgbWFrZUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZykpO1xyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gdG9nZ2xlQ29udGVudChpdGVtQ29udGFpbmVyLCBpbnB1dENvbnRhaW5lcikge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgaGlkZUVsKGlucHV0Q29udGFpbmVyLCAhZXZlbnQudGFyZ2V0LmNoZWNrZWQpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGl0ZW1Db250YWluZXIsICdmbGV4LWZyb250LWVsZW1lbnQnLCBldmVudC50YXJnZXQuY2hlY2tlZCk7XHJcbiAgICAgICAgICAgIHJlYnVpbGRDb250ZW50KCk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgc3dpdGNoIChwcm9maWxlSXRlbUNvbmZpZy50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgcmV0dXJuIG1ha2VUZXh0RmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKTtcclxuICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgcmV0dXJuIG1ha2VFbnVtRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKTtcclxuICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICByZXR1cm4gbWFrZU11bHRpRW51bUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgcmV0dXJuIG1ha2VOdW1iZXJGaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpO1xyXG4gICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgcmV0dXJuIG1ha2VDaGVja2JveEZpbHRlcihwcm9maWxlSXRlbUNvbmZpZyk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgJHtwcm9maWxlSXRlbUNvbmZpZy50eXBlfWApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlVGV4dEZpbHRlcihwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gcW10ZShgJHtyb290fSAudGV4dC1maWx0ZXItdG1wbGApO1xyXG4gICAgICAgIGlucHV0LnNlbGZJbmZvID0gcHJvZmlsZUl0ZW1Db25maWc7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHJlYnVpbGRDb250ZW50KTtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gaW5wdXQ7XHJcbiAgICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VDb21tb25FbnVtRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnLCB2YWx1ZXMpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IHFtdGUoYCR7cm9vdH0gLmNvbW1vbi1lbnVtLWZpbHRlci10bXBsYCk7XHJcbiAgICAgICAgc2VsZWN0b3Iuc2VsZkluZm8gPSBwcm9maWxlSXRlbUNvbmZpZztcclxuICAgICAgICBzZWxlY3Rvci5zaXplID0gdmFsdWVzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgZmlsbFNlbGVjdG9yKHNlbGVjdG9yLCB2YWx1ZXMubWFwKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICB2YWx1ZS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgc2VsZWN0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVidWlsZENvbnRlbnQpO1xyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBzZWxlY3RvcjtcclxuICAgICAgICByZXR1cm4gc2VsZWN0b3I7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUVudW1GaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBhcnIyU2VsZWN0KHByb2ZpbGVJdGVtQ29uZmlnLnZhbHVlLnNwbGl0KCcsJykpO1xyXG4gICAgICAgIHJldHVybiBtYWtlQ29tbW9uRW51bUZpbHRlcihwcm9maWxlSXRlbUNvbmZpZywgdmFsdWVzKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ2hlY2tib3hGaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBbe1xyXG4gICAgICAgICAgICB2YWx1ZTogQ29uc3RhbnRzLnRydWUsXHJcbiAgICAgICAgICAgIG5hbWU6IGNvbnN0TDEwbihDb25zdGFudHMudHJ1ZSlcclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgIHZhbHVlOiBDb25zdGFudHMuZmFsc2UsXHJcbiAgICAgICAgICAgIG5hbWU6IGNvbnN0TDEwbihDb25zdGFudHMuZmFsc2UpXHJcbiAgICAgICAgfV07XHJcbiAgICAgICAgcmV0dXJuIG1ha2VDb21tb25FbnVtRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnLCB2YWx1ZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VNdWx0aUVudW1GaWx0ZXIocHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICBjb25zdCBmaWx0ZXIgPSBxbXRlKGAke3Jvb3R9IC5tdWx0aS1lbnVtLWZpbHRlci10bXBsYCk7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBxZWUoZmlsdGVyLCAnLm11bHRpLWVudW0tZmlsdGVyLXR5cGUnKTtcclxuICAgICAgICBzZWxlY3Rvci5zZWxmSW5mbyA9IHByb2ZpbGVJdGVtQ29uZmlnO1xyXG5cclxuICAgICAgICBDb25zdGFudHMubXVsdGlFbnVtRmlsdGVyLmZvckVhY2goKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICAgICAgICAgIG9wdGlvbi5hcHBlbmRDaGlsZChtYWtlVGV4dChjb25zdEwxMG4odmFsdWUpKSk7XHJcbiAgICAgICAgICAgIG9wdGlvbi52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICBzZWxlY3Rvci5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNlbGVjdG9yLnNlbGVjdGVkSW5kZXggPSAwO1xyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXNbcHJvZmlsZUl0ZW1Db25maWcubmFtZV0gPSBzZWxlY3RvcjtcclxuICAgICAgICBzZWxlY3Rvci5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZWJ1aWxkQ29udGVudCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yMiA9IHFlZShmaWx0ZXIsICcubXVsdGktZW51bS1maWx0ZXItY29udGVudCcpO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IGFycjJTZWxlY3QocHJvZmlsZUl0ZW1Db25maWcudmFsdWUuc3BsaXQoJywnKSk7XHJcbiAgICAgICAgZmlsbFNlbGVjdG9yKHNlbGVjdG9yMiwgdmFsdWVzLm1hcCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgdmFsdWUuc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHNlbGVjdG9yMi5zaXplID0gdmFsdWVzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1tgJHtwcm9maWxlSXRlbUNvbmZpZy5uYW1lfTptdWx0aUVudW1JbnB1dGBdID0gc2VsZWN0b3IyO1xyXG4gICAgICAgIHNlbGVjdG9yMi5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZWJ1aWxkQ29udGVudCk7XHJcbiAgICAgICAgcmV0dXJuIGZpbHRlcjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlTnVtYmVyRmlsdGVyKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgY29uc3QgZmlsdGVyID0gcW10ZShgJHtyb290fSAubnVtYmVyLWZpbHRlci10bXBsYCk7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBxZWUoZmlsdGVyLCAnc2VsZWN0Jyk7XHJcbiAgICAgICAgc2VsZWN0b3Iuc2VsZkluZm8gPSBwcm9maWxlSXRlbUNvbmZpZztcclxuXHJcbiAgICAgICAgQ29uc3RhbnRzLm51bWJlckZpbHRlci5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgICAgICBvcHRpb24uYXBwZW5kQ2hpbGQobWFrZVRleHQoY29uc3RMMTBuKHZhbHVlKSkpO1xyXG4gICAgICAgICAgICBvcHRpb24udmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgc2VsZWN0b3IuYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzZWxlY3Rvci5zZWxlY3RlZEluZGV4ID0gMDtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gc2VsZWN0b3I7XHJcbiAgICAgICAgc2VsZWN0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVidWlsZENvbnRlbnQpO1xyXG5cclxuICAgICAgICBjb25zdCBpbnB1dCA9IHFlZShmaWx0ZXIsICdpbnB1dCcpO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gMDtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW2Ake3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWV9Om51bWJlcklucHV0YF0gPSBpbnB1dDtcclxuICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHJlYnVpbGRDb250ZW50KTtcclxuICAgICAgICByZXR1cm4gZmlsdGVyO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbmFtZUdyb3VwKHNlbGVjdG9yKSB7XHJcbiAgICAgICAgcmV0dXJuIGRpYWxvZyA9PiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvSW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCBmcm9tTmFtZSA9IHF1ZXJ5RWwoc2VsZWN0b3IpLnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lR3JvdXAoZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goKGVycjIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59KSh0aGlzLlByb2ZpbGVGaWx0ZXIgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTYgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnYWJvdXREaXYnKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgfTtcclxufSkodGhpcy5BYm91dCA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNiBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcubG9nLXZpZXdlci10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5wYWdpbmF0aW9uYCkpO1xyXG4gICAgICAgIGFkZEVscyhwYWdpbmF0aW9uLCBSLnJhbmdlKDAsIDIwKS5tYXAoKG51bSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBhID0gc2V0QXR0cihtYWtlRWwoJ2EnKSwgJ2hyZWYnLCAnIycpO1xyXG4gICAgICAgICAgICBjb25zdCBsaSA9IGFkZEVsKG1ha2VFbCgnbGknKSwgYSk7XHJcbiAgICAgICAgICAgIGxpLm51bSA9IG51bTtcclxuICAgICAgICAgICAgYWRkRWwoYSwgbWFrZVRleHQobnVtICsgMSkpO1xyXG4gICAgICAgICAgICBsaXN0ZW4oYSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZ2V0RGF0YSh7IHRhcmdldDogeyB2YWx1ZTogbnVtIH0gfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcmV2QWN0aXZlID0gcXVlcnlFbChgJHtyb290fS5wYWdpbmF0aW9uIGxpLmFjdGl2ZWApO1xyXG4gICAgICAgICAgICAgICAgaWYgKHByZXZBY3RpdmUgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhwcmV2QWN0aXZlLCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhsaSwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGxpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH1idXR0b24uY2xlYXItZmlsdGVyYCksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH1pbnB1dFtmaWx0ZXJdYCkuZm9yRWFjaChlbCA9PiAoZWwudmFsdWUgPSAnJykpO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH1pbnB1dFtmaWx0ZXJdYCkuZm9yRWFjaChsaXN0ZW4oUi5fXywgJ2lucHV0JywgZXhwb3J0cy5yZWZyZXNoKSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBxdWVyeUVscyhgJHtyb290fS5wYWdpbmF0aW9uIGxpIGFgKVswXS5jbGljaygpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBkYXRhUmVjaWV2ZWQoZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucmVzdWx0LW51bWJlcmApKSwgbWFrZVRleHQoTDEwbi5mb3JtYXQoJ2xvZy12aWV3ZXInLCAndG90YWwnLCBbZGF0YS5tYXhdKSkpO1xyXG5cclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ubG9nLWRhdGFgKSk7XHJcbiAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0ucGFnaW5hdGlvbiBsaWApLmZvckVhY2gobGkgPT4gaGlkZUVsKGxpLCBsaS5udW0gPiBkYXRhLmxvZ1NpemUgLSAxKSk7XHJcbiAgICAgICAgUi5hcChbYWRkRWwoY29udGFpbmVyKV0sIGRhdGEucmVxdWVzdGVkTG9nLm1hcChtYWtlUm93KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0RGF0YShldmVudCkge1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IFIuZnJvbVBhaXJzKHF1ZXJ5RWxzKGAke3Jvb3R9aW5wdXRbZmlsdGVyXWApLm1hcChlbCA9PiBbZ2V0QXR0cihlbCwgJ2ZpbHRlcicpLCBlbC52YWx1ZV0pKTtcclxuICAgICAgICBEQk1TLmdldExvZyhOdW1iZXIoZXZlbnQudGFyZ2V0LnZhbHVlKSwgZmlsdGVyLCBkYXRhUmVjaWV2ZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VSb3cocm93RGF0YSkge1xyXG4gICAgICAgIGNvbnN0IGFkZFRleHQgPSAodGV4dCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQodGV4dCkpKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKCd0cicpLCBbXHJcbiAgICAgICAgICAgIGFkZFRleHQoYCR7cm93RGF0YVswXX1gKSxcclxuICAgICAgICAgICAgYWRkVGV4dChuZXcgRGF0ZShyb3dEYXRhWzJdKS5mb3JtYXQoJ3l5eXkvbW0vZGQgSEg6TU06c3MnKSksXHJcbiAgICAgICAgICAgIGFkZFRleHQocm93RGF0YVsxXSksXHJcbiAgICAgICAgICAgIGFkZFRleHQocm93RGF0YVszXSksXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhZGRFbHMobWFrZUVsKCd0ZCcpLCBKU09OLnBhcnNlKHJvd0RhdGFbNF0pLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhZGRFbChhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAnbG9nLXBhcmFtJyksIG1ha2VUZXh0KFIuaXMoT2JqZWN0LCBpdGVtKSA/IEpTT04uc3RyaW5naWZ5KGl0ZW0pIDogaXRlbSkpO1xyXG4gICAgICAgICAgICB9KSksXHJcbiAgICAgICAgICAgIGFkZEVscyhtYWtlRWwoJ3RkJyksIEpTT04ucGFyc2Uocm93RGF0YVs1XSkubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdsb2ctcGFyYW0nKSwgbWFrZVRleHQoUi5pcyhPYmplY3QsIGl0ZW0pID8gSlNPTi5zdHJpbmdpZnkoaXRlbSkgOiBpdGVtKSk7XHJcbiAgICAgICAgICAgIH0pKSxcclxuICAgICAgICBdKTtcclxuICAgIH1cclxufSkodGhpcy5Mb2dWaWV3ZXIgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIFN0b3J5Q2hhcmFjdGVyc1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCduZXR3b3JrU3Vic2V0c1NlbGVjdG9yJyksICdjaGFuZ2UnLCBvbk5ldHdvcmtTdWJzZXRzQ2hhbmdlKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKHBhcmVudCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLnBhcmVudCA9IHBhcmVudDtcclxuXHJcbiAgICAgICAgbGV0IHNlbGVjdG9yID0gZmlsbFNlbGVjdG9yKGNsZWFyRWwoZ2V0RWwoJ25ldHdvcmtTdWJzZXRzU2VsZWN0b3InKSksIGNvbnN0QXJyMlNlbGVjdChDb25zdGFudHMub2JqZWN0U3Vic2V0cykpO1xyXG4gICAgICAgIFtzZWxlY3Rvci52YWx1ZV0gPSBDb25zdGFudHMub2JqZWN0U3Vic2V0cztcclxuICAgICAgICBvbk5ldHdvcmtTdWJzZXRzQ2hhbmdlKHsgdGFyZ2V0OiBzZWxlY3RvciB9KTtcclxuXHJcbiAgICAgICAgc2VsZWN0b3IgPSBmaWxsU2VsZWN0b3IoXHJcbiAgICAgICAgICAgIGNsZWFyRWwoZ2V0RWwoJ25ldHdvcmtDaGFyYWN0ZXJTZWxlY3RvcicpKSxcclxuICAgICAgICAgICAgc3RhdGUucGFyZW50LmNoYXJhY3Rlck5hbWVzLnNvcnQoVXRpbHMuY2hhck9yZEFPYmplY3QpLm1hcChyZW1hcFByb3BzNFNlbGVjdClcclxuICAgICAgICApO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgc2VsZWN0b3Iub3B0aW9ucy5sZW5ndGggPiAxNSA/IDE1IDogc2VsZWN0b3Iub3B0aW9ucy5sZW5ndGgpO1xyXG4gICAgICAgIHNlbGVjdG9yID0gZmlsbFNlbGVjdG9yKFxyXG4gICAgICAgICAgICBjbGVhckVsKGdldEVsKCduZXR3b3JrU3RvcnlTZWxlY3RvcicpKSxcclxuICAgICAgICAgICAgc3RhdGUucGFyZW50LnN0b3J5TmFtZXMuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCkubWFwKHJlbWFwUHJvcHM0U2VsZWN0KVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgc2V0QXR0cihzZWxlY3RvciwgJ3NpemUnLCBzZWxlY3Rvci5vcHRpb25zLmxlbmd0aCA+IDE1ID8gMTUgOiBzZWxlY3Rvci5vcHRpb25zLmxlbmd0aCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuZ2V0U3RvcnlOYW1lcyA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBnZXRFbCgnbmV0d29ya1N1YnNldHNTZWxlY3RvcicpO1xyXG5cclxuICAgICAgICBpZiAoQ29uc3RhbnRzLm9iamVjdFN1YnNldHNbMF0gPT09IHZhbHVlKSB7IC8vIGFsbCBvYmplY3RzXHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5wYXJlbnQuc3RvcnlOYW1lcy5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzFdID09PSB2YWx1ZSkgeyAvLyBcInNlbGVjdGVkIGNoYXJhY3RlcnNcIlxyXG4gICAgICAgICAgICBjb25zdCBwcmltYXJ5Q2hhcmFjdGVycyA9IG5sMmFycmF5KGdldEVsKCduZXR3b3JrQ2hhcmFjdGVyU2VsZWN0b3InKS5zZWxlY3RlZE9wdGlvbnMpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgICAgICBjb25zdCBpc1ByaW1hcnlDaGFyYWN0ZXIgPSBSLmNvbnRhaW5zKFIuX18sIHByaW1hcnlDaGFyYWN0ZXJzKTtcclxuICAgICAgICAgICAgcmV0dXJuIFIudmFsdWVzKHN0YXRlLnBhcmVudC5TdG9yaWVzKVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihzdG9yeSA9PiBSLmtleXMoc3RvcnkuY2hhcmFjdGVycykuc29tZShpc1ByaW1hcnlDaGFyYWN0ZXIpKS5tYXAoUi5wcm9wKCduYW1lJykpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoQ29uc3RhbnRzLm9iamVjdFN1YnNldHNbMl0gPT09IHZhbHVlKSB7IC8vXCJzZWxlY3RlZCBzdG9yaWVzXCJcclxuICAgICAgICAgICAgcmV0dXJuIG5sMmFycmF5KGdldEVsKCduZXR3b3JrU3RvcnlTZWxlY3RvcicpLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBzdWJzZXRzIHNlbGVjdG9yOiAke3ZhbHVlfWApO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmdldENoYXJhY3Rlck5hbWVzID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGdldEVsKCduZXR3b3JrU3Vic2V0c1NlbGVjdG9yJyk7XHJcblxyXG4gICAgICAgIGlmIChDb25zdGFudHMub2JqZWN0U3Vic2V0c1swXSA9PT0gdmFsdWUpIHsgLy8gYWxsIG9iamVjdHNcclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmVudC5jaGFyYWN0ZXJOYW1lcy5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzFdID09PSB2YWx1ZSkgeyAvLyBcInNlbGVjdGVkIGNoYXJhY3RlcnNcIlxyXG4gICAgICAgICAgICAvLyByZXR1cm5zIGNoYXJhY3RlciBhbmQgaGlzIG5laWdoYm91cnNcclxuICAgICAgICAgICAgY29uc3QgcHJpbWFyeUNoYXJhY3RlcnMgPSBubDJhcnJheShnZXRFbCgnbmV0d29ya0NoYXJhY3RlclNlbGVjdG9yJykuc2VsZWN0ZWRPcHRpb25zKS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICAgICAgY29uc3QgaXNQcmltYXJ5Q2hhcmFjdGVyID0gUi5jb250YWlucyhSLl9fLCBwcmltYXJ5Q2hhcmFjdGVycyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZGFyeUNoYXJhY3RlcnMgPSBSLnZhbHVlcyhzdGF0ZS5wYXJlbnQuU3RvcmllcylcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoc3RvcnkgPT4gUi5rZXlzKHN0b3J5LmNoYXJhY3RlcnMpLnNvbWUoaXNQcmltYXJ5Q2hhcmFjdGVyKSlcclxuICAgICAgICAgICAgICAgIC5tYXAoc3RvcnkgPT4gc3RvcnkuZXZlbnRzLmZpbHRlcihldmVudCA9PiBSLmtleXMoZXZlbnQuY2hhcmFjdGVycykuc29tZShpc1ByaW1hcnlDaGFyYWN0ZXIpKVxyXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoZXZlbnQgPT4gUi5rZXlzKGV2ZW50LmNoYXJhY3RlcnMpLmZpbHRlcihuYW1lID0+ICFpc1ByaW1hcnlDaGFyYWN0ZXIobmFtZSkpKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hhcmFjdGVycy5jb25jYXQoUi51bmlxKFIuZmxhdHRlbihzZWNvbmRhcnlDaGFyYWN0ZXJzKSkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoQ29uc3RhbnRzLm9iamVjdFN1YnNldHNbMl0gPT09IHZhbHVlKSB7IC8vXCJzZWxlY3RlZCBzdG9yaWVzXCJcclxuICAgICAgICAgICAgY29uc3Qgc3RvcmllcyA9IG5sMmFycmF5KGdldEVsKCduZXR3b3JrU3RvcnlTZWxlY3RvcicpLnNlbGVjdGVkT3B0aW9ucykubWFwKFIucHJvcCgndmFsdWUnKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBSLnVuaXEoUi5mbGF0dGVuKHN0b3JpZXMubWFwKHN0b3J5TmFtZSA9PiBSLmtleXMoc3RhdGUucGFyZW50LlN0b3JpZXNbc3RvcnlOYW1lXS5jaGFyYWN0ZXJzKSkpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHN1YnNldHMgc2VsZWN0b3I6ICR7dmFsdWV9YCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIG9uTmV0d29ya1N1YnNldHNDaGFuZ2UoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZFN1YnNldCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBoaWRlRWwoZ2V0RWwoJ25ldHdvcmtDaGFyYWN0ZXJEaXYnKSwgIHNlbGVjdGVkU3Vic2V0ICE9PSBDb25zdGFudHMub2JqZWN0U3Vic2V0c1sxXSk7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCduZXR3b3JrU3RvcnlEaXYnKSwgc2VsZWN0ZWRTdWJzZXQgIT09IENvbnN0YW50cy5vYmplY3RTdWJzZXRzWzJdKTtcclxuICAgIH1cclxufSkodGhpcy5OZXR3b3JrU3Vic2V0c1NlbGVjdG9yID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TLCBTdG9yeUNoYXJhY3RlcnNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgY29uc3QgU1RPUllfUFJFRklYID0gJ1N0Oic7XHJcbiAgICBjb25zdCBDSEFSX1BSRUZJWCA9ICdDaDonO1xyXG4gICAgY29uc3QgUFJPRklMRV9HUk9VUCA9ICdwcm9mLSc7XHJcbiAgICBjb25zdCBGSUxURVJfR1JPVVAgPSAnZmlsdGVyLSc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIE5ldHdvcmtTdWJzZXRzU2VsZWN0b3IuaW5pdCgpO1xyXG5cclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ25ldHdvcmtOb2RlR3JvdXBTZWxlY3RvcicpLCAnY2hhbmdlJywgY29sb3JOb2Rlcyk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdzaG93UGxheWVyTmFtZXNDaGVja2JveCcpLCAnY2hhbmdlJywgdXBkYXRlTm9kZUxhYmVscyk7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCdkcmF3TmV0d29ya0J1dHRvbicpLCAnY2xpY2snLCBvbkRyYXdOZXR3b3JrKTtcclxuICAgICAgICAkKCcjbm9kZUZvY3VzU2VsZWN0b3InKS5zZWxlY3QyKCkub24oJ2NoYW5nZScsIG9uTm9kZUZvY3VzKTtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ25ldHdvcmtTZWxlY3RvcicpLCAnY2hhbmdlJywgb25OZXR3b3JrU2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZSk7XHJcblxyXG4gICAgICAgIHF1ZXJ5RWxzKCcjYWN0aXZpdHlCbG9jayBidXR0b24nKS5mb3JFYWNoKGxpc3RlbihSLl9fLCAnY2xpY2snLCBldmVudCA9PiB0b2dnbGVDbGFzcyhldmVudC50YXJnZXQsICdidG4tcHJpbWFyeScpKSk7XHJcbiAgICAgICAgcXVlcnlFbHMoJyNyZWxhdGlvbnNCbG9jayBidXR0b24nKS5mb3JFYWNoKGxpc3RlbihSLl9fLCAnY2xpY2snLCBldmVudCA9PiB0b2dnbGVDbGFzcyhldmVudC50YXJnZXQsICdidG4tcHJpbWFyeScpKSk7XHJcblxyXG4gICAgICAgIC8vICAgICAgICBzdGF0ZS5uZXR3b3JrO1xyXG4gICAgICAgIHN0YXRlLmhpZ2hsaWdodEFjdGl2ZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICBpbml0V2FybmluZygpO1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKGluaXRXYXJuaW5nKTtcclxuXHJcbiAgICAgICAgLy8gICAgVGltZWxpbmVkTmV0d29yay5pbml0KCk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IGdldEVsKCdzb2NpYWxOZXR3b3JrRGl2Jyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGluaXRXYXJuaW5nKCkge1xyXG4gICAgICAgIGNvbnN0IHdhcm5pbmcgPSBjbGVhckVsKGdldEVsKCdzb2NpYWxOZXR3b3JrV2FybmluZycpKTtcclxuICAgICAgICBjb25zdCBidXR0b24gPSBhZGRFbChtYWtlRWwoJ2J1dHRvbicpLCBtYWtlVGV4dChnZXRMMTBuKCdzb2NpYWwtbmV0d29yay1yZW1vdmUtcmVzb3VyY2VzLXdhcm5pbmcnKSkpO1xyXG4gICAgICAgIGFkZEVscyh3YXJuaW5nLCBbbWFrZVRleHQoZ2V0TDEwbignc29jaWFsLW5ldHdvcmstcmVxdWlyZS1yZXNvdXJjZXMtd2FybmluZycpKSwgYnV0dG9uXSk7XHJcbiAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NsaWNrJywgKCkgPT4gYWRkQ2xhc3Mod2FybmluZywgJ2hpZGRlbicpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBub2RlU29ydCA9IENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShhID0+IGEubGFiZWwudG9Mb3dlckNhc2UoKSk7XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGxldCBzZWxlY3RvciA9IGZpbGxTZWxlY3RvcihjbGVhckVsKGdldEVsKCduZXR3b3JrU2VsZWN0b3InKSksIGNvbnN0QXJyMlNlbGVjdChDb25zdGFudHMubmV0d29ya3MpKTtcclxuICAgICAgICBbc2VsZWN0b3IudmFsdWVdID0gQ29uc3RhbnRzLm5ldHdvcmtzO1xyXG4gICAgICAgIG9uTmV0d29ya1NlbGVjdG9yQ2hhbmdlRGVsZWdhdGUoeyB0YXJnZXQ6IHNlbGVjdG9yIH0pO1xyXG5cclxuICAgICAgICBzZWxlY3RvciA9IGNsZWFyRWwoZ2V0RWwoJ25ldHdvcmtOb2RlR3JvdXBTZWxlY3RvcicpKTtcclxuXHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyMSwgY2hhcmFjdGVyTmFtZXMpID0+IHsgLy8gc3Vic2V0IHNlbGVjdG9yXHJcbiAgICAgICAgICAgIGlmIChlcnIxKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjEpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3N0b3J5JywgZmFsc2UsIChlcnIyLCBzdG9yeU5hbWVzKSA9PiB7IC8vIHN1YnNldCBzZWxlY3RvclxyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRBbGxQcm9maWxlcygnY2hhcmFjdGVyJywgKGVycjMsIHByb2ZpbGVzKSA9PiB7IC8vIG5vZGUgY29sb3JpbmdcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRBbGxTdG9yaWVzKChlcnI0LCBzdG9yaWVzKSA9PiB7IC8vIGNvbnRhaW5zIG1vc3QgcGFydCBvZiBTTiBkYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI0KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjQpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKCdjaGFyYWN0ZXInLCAoZXJyNSwgcHJvZmlsZVN0cnVjdHVyZSkgPT4geyAvLyBub2RlIGNvbG9yaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNSkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI1KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVCaW5kaW5ncygoZXJyNiwgcHJvZmlsZUJpbmRpbmdzKSA9PiB7IC8vIG5vZGUgY29sb3JpbmdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI2KTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRHcm91cENoYXJhY3RlclNldHMoKGVycjcsIGdyb3VwQ2hhcmFjdGVyU2V0cykgPT4geyAvLyBub2RlIGNvbG9yaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI3KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjcpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyOCwgbWV0YUluZm8pID0+IHsgLy8gdGltZWxpbmVkIG5ldHdvcmtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnI4KSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjgpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0UmVsYXRpb25zKChlcnI5LCByZWxhdGlvbnMpID0+IHsgLy8gcmVsYXRpb25zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjkpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyOSk7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5TdG9yaWVzID0gc3RvcmllcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5DaGFyYWN0ZXJzID0gcHJvZmlsZXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUucHJvZmlsZUJpbmRpbmdzID0gcHJvZmlsZUJpbmRpbmdzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmdyb3VwQ2hhcmFjdGVyU2V0cyA9IGdyb3VwQ2hhcmFjdGVyU2V0cztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tZXRhSW5mbyA9IG1ldGFJbmZvO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlbGF0aW9ucyA9IHJlbGF0aW9ucztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tib3hlcyA9IHByb2ZpbGVTdHJ1Y3R1cmUuZmlsdGVyKGVsZW1lbnQgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUi5lcXVhbHMoZWxlbWVudC50eXBlLCAnY2hlY2tib3gnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUi52YWx1ZXMocHJvZmlsZXMpLmZvckVhY2goKHByb2ZpbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tib3hlcy5tYXAoaXRlbSA9PiAocHJvZmlsZVtpdGVtLm5hbWVdID1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0TDEwbihDb25zdGFudHNbcHJvZmlsZVtpdGVtLm5hbWVdXSkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb3JHcm91cHMgPSBwcm9maWxlU3RydWN0dXJlLmZpbHRlcihlbGVtZW50ID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIuY29udGFpbnMoZWxlbWVudC50eXBlLCBbJ2VudW0nLCAnY2hlY2tib3gnXSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRDb2xvckdyb3VwID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogQ29uc3RhbnRzLm5vR3JvdXAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGNvbnN0TDEwbihDb25zdGFudHMubm9Hcm91cClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9maWxlTGFiZWwgPSBzdHJGb3JtYXQoZ2V0TDEwbignc29jaWFsLW5ldHdvcmstcHJvZmlsZS1ncm91cCcpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJMYWJlbCA9IHN0ckZvcm1hdChnZXRMMTBuKCdzb2NpYWwtbmV0d29yay1maWx0ZXItZ3JvdXAnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2ZpbGVHcm91cHMgPSBjb2xvckdyb3Vwcy5tYXAoZ3JvdXAgPT4gZ3JvdXAubmFtZSkubWFwKG5hbWUgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHsgdmFsdWU6IFBST0ZJTEVfR1JPVVAgKyBuYW1lLCBuYW1lOiBwcm9maWxlTGFiZWwoW25hbWVdKSB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyR3JvdXBzID0gUi5rZXlzKGdyb3VwQ2hhcmFjdGVyU2V0cykubWFwKG5hbWUgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHsgdmFsdWU6IEZJTFRFUl9HUk9VUCArIG5hbWUsIG5hbWU6IGZpbHRlckxhYmVsKFtuYW1lXSkgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtkZWZhdWx0Q29sb3JHcm91cF0uY29uY2F0KHByb2ZpbGVHcm91cHMpLmNvbmNhdChmaWx0ZXJHcm91cHMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdEdyb3VwQ29sb3JzKGNvbG9yR3JvdXBzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTmV0d29ya1N1YnNldHNTZWxlY3Rvci5yZWZyZXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVyTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3J5TmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFN0b3JpZXM6IHN0b3JpZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkRyYXdOZXR3b3JrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGluaXRHcm91cENvbG9ycyhjb2xvckdyb3Vwcykge1xyXG4gICAgICAgIHN0YXRlLmdyb3VwQ29sb3JzID0gUi5jbG9uZShDb25zdGFudHMuc25GaXhlZENvbG9ycyk7XHJcbiAgICAgICAgc3RhdGUuZ3JvdXBMaXN0cyA9IHt9O1xyXG5cclxuICAgICAgICBjb2xvckdyb3Vwcy5mb3JFYWNoKChncm91cCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZ3JvdXAudHlwZSA9PT0gJ2VudW0nKSB7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cExpc3RzW1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lXSA9IGdyb3VwLnZhbHVlLnNwbGl0KCcsJykubWFwKChzdWJHcm91cE5hbWUsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cENvbG9yc1tgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHtzdWJHcm91cE5hbWUudHJpbSgpfWBdID1cclxuICAgICAgICAgICAgICAgICAgICAgICAgQ29uc3RhbnRzLmNvbG9yUGFsZXR0ZVtpKzJdO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtQUk9GSUxFX0dST1VQICsgZ3JvdXAubmFtZX0uJHtzdWJHcm91cE5hbWUudHJpbSgpfWA7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChncm91cC50eXBlID09PSAnY2hlY2tib3gnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0cnVlTmFtZSA9IGNvbnN0TDEwbihDb25zdGFudHMudHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmYWxzZU5hbWUgPSBjb25zdEwxMG4oQ29uc3RhbnRzLmZhbHNlKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmdyb3VwQ29sb3JzW2Ake1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lfS4ke3RydWVOYW1lfWBdID1cclxuICAgICAgICAgICAgICAgICAgICBDb25zdGFudHMuY29sb3JQYWxldHRlW2dyb3VwLnZhbHVlID8gMCsyIDogMSsyXTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmdyb3VwQ29sb3JzW2Ake1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lfS4ke2ZhbHNlTmFtZX1gXSA9XHJcbiAgICAgICAgICAgICAgICAgICAgQ29uc3RhbnRzLmNvbG9yUGFsZXR0ZVtncm91cC52YWx1ZSA/IDErMiA6IDArMl07XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ncm91cExpc3RzW1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lXSA9XHJcbiAgICAgICAgICAgICAgICAgICAgW2Ake1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lfS4ke3RydWVOYW1lfWAsIGAke1BST0ZJTEVfR1JPVVAgKyBncm91cC5uYW1lfS4ke2ZhbHNlTmFtZX1gXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBwcm9maWxlIGl0ZW0gdHlwZTogJHtncm91cC50eXBlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUxlZ2VuZEl0ZW0obGFiZWwsIGNvbG9yKSB7XHJcbiAgICAgICAgY29uc3QgY29sb3JEaXYgPSBhZGRFbChtYWtlRWwoJ2RpdicpLCBtYWtlVGV4dChsYWJlbCkpO1xyXG4gICAgICAgIGNvbG9yRGl2LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yLmJhY2tncm91bmQ7XHJcbiAgICAgICAgY29sb3JEaXYuc3R5bGUuYm9yZGVyID0gYHNvbGlkIDJweCAke2NvbG9yLmJvcmRlcn1gO1xyXG4gICAgICAgIHJldHVybiBjb2xvckRpdjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZWZyZXNoTGVnZW5kKGdyb3VwTmFtZSkge1xyXG4gICAgICAgIGNvbnN0IGNvbG9yTGVnZW5kID0gY2xlYXJFbChnZXRFbCgnY29sb3JMZWdlbmQnKSk7XHJcbiAgICAgICAgbGV0IGVscyA9IFtdO1xyXG5cclxuICAgICAgICBpZiAoZ3JvdXBOYW1lID09PSAnbm9Hcm91cCcpIHtcclxuICAgICAgICAgICAgZWxzLnB1c2gobWFrZUxlZ2VuZEl0ZW0oY29uc3RMMTBuKCdub0dyb3VwJyksIENvbnN0YW50cy5zbkZpeGVkQ29sb3JzLm5vR3JvdXAuY29sb3IpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbW1vblV0aWxzLnN0YXJ0c1dpdGgoZ3JvdXBOYW1lLCBQUk9GSUxFX0dST1VQKSkge1xyXG4gICAgICAgICAgICBlbHMgPSBlbHMuY29uY2F0KHN0YXRlLmdyb3VwTGlzdHNbZ3JvdXBOYW1lXS5tYXAodmFsdWUgPT5cclxuICAgICAgICAgICAgICAgIG1ha2VMZWdlbmRJdGVtKHZhbHVlLnN1YnN0cmluZyhQUk9GSUxFX0dST1VQLmxlbmd0aCksIHN0YXRlLmdyb3VwQ29sb3JzW3ZhbHVlXS5jb2xvcikpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKENvbW1vblV0aWxzLnN0YXJ0c1dpdGgoZ3JvdXBOYW1lLCBGSUxURVJfR1JPVVApKSB7XHJcbiAgICAgICAgICAgIGVscy5wdXNoKG1ha2VMZWdlbmRJdGVtKGNvbnN0TDEwbignbm9Hcm91cCcpLCBDb25zdGFudHMuc25GaXhlZENvbG9ycy5ub0dyb3VwLmNvbG9yKSk7XHJcbiAgICAgICAgICAgIGVscy5wdXNoKG1ha2VMZWdlbmRJdGVtKGNvbnN0TDEwbignZnJvbUdyb3VwJyksIENvbnN0YW50cy5zbkZpeGVkQ29sb3JzLmZyb21Hcm91cC5jb2xvcikpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBncm91cCBuYW1lL3R5cGU6ICR7Z3JvdXBOYW1lfWApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKFsnY2hhcmFjdGVyUHJlc2VuY2VJblN0b3J5JywgJ2NoYXJhY3RlckFjdGl2aXR5SW5TdG9yeSddLmluZGV4T2Yoc3RhdGUuc2VsZWN0ZWROZXR3b3JrKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgZWxzLnB1c2gobWFrZUxlZ2VuZEl0ZW0oZ2V0TDEwbignc29jaWFsLW5ldHdvcmstc3RvcnknKSwgQ29uc3RhbnRzLnNuRml4ZWRDb2xvcnMuc3RvcnlDb2xvci5jb2xvcikpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhZGRFbHMoY29sb3JMZWdlbmQsIGVscyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY29sb3JOb2RlcyhldmVudCkge1xyXG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICByZWZyZXNoTGVnZW5kKGdyb3VwTmFtZSk7XHJcbiAgICAgICAgaWYgKHN0YXRlLm5vZGVzRGF0YXNldCA9PT0gdW5kZWZpbmVkKSByZXR1cm47XHJcblxyXG4gICAgICAgIE5ldHdvcmtTdWJzZXRzU2VsZWN0b3IuZ2V0Q2hhcmFjdGVyTmFtZXMoKS5mb3JFYWNoKChjaGFyYWN0ZXJOYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC51cGRhdGUoe1xyXG4gICAgICAgICAgICAgICAgaWQ6IENIQVJfUFJFRklYICsgY2hhcmFjdGVyTmFtZSxcclxuICAgICAgICAgICAgICAgIGdyb3VwOiBnZXROb2RlR3JvdXAoY2hhcmFjdGVyTmFtZSwgZ3JvdXBOYW1lKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXROb2RlR3JvdXAoY2hhcmFjdGVyTmFtZSwgZ3JvdXBOYW1lKSB7XHJcbiAgICAgICAgaWYgKGdyb3VwTmFtZSA9PT0gJ25vR3JvdXAnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBncm91cE5hbWU7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKGdyb3VwTmFtZSwgUFJPRklMRV9HUk9VUCkpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhcmFjdGVyID0gc3RhdGUuQ2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXTtcclxuICAgICAgICAgICAgcmV0dXJuIGAke2dyb3VwTmFtZX0uJHtjaGFyYWN0ZXJbZ3JvdXBOYW1lLnN1YnN0cmluZyhQUk9GSUxFX0dST1VQLmxlbmd0aCldfWA7XHJcbiAgICAgICAgfSBlbHNlIGlmIChDb21tb25VdGlscy5zdGFydHNXaXRoKGdyb3VwTmFtZSwgRklMVEVSX0dST1VQKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGUuZ3JvdXBDaGFyYWN0ZXJTZXRzW2dyb3VwTmFtZS5zdWJzdHJpbmcoRklMVEVSX0dST1VQLmxlbmd0aCldW2NoYXJhY3Rlck5hbWVdID8gJ2Zyb21Hcm91cCcgOiAnbm9Hcm91cCc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBncm91cCBuYW1lOiAke2dyb3VwTmFtZX1gKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlTGFiZWxzKCkge1xyXG4gICAgICAgIGlmIChzdGF0ZS5ub2Rlc0RhdGFzZXQgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xyXG4gICAgICAgIGNvbnN0IHNob3dQbGF5ZXIgPSBnZXRFbCgnc2hvd1BsYXllck5hbWVzQ2hlY2tib3gnKS5jaGVja2VkO1xyXG4gICAgICAgIGNvbnN0IGFsbE5vZGVzID0gc3RhdGUubm9kZXNEYXRhc2V0LmdldCh7XHJcbiAgICAgICAgICAgIHJldHVyblR5cGU6ICdPYmplY3QnXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIFIudmFsdWVzKGFsbE5vZGVzKS5maWx0ZXIobm9kZSA9PiBub2RlLnR5cGUgPT09ICdjaGFyYWN0ZXInKS5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gbWFrZUNoYXJhY3Rlck5vZGVMYWJlbChzaG93UGxheWVyLCBub2RlLm9yaWdpbk5hbWUpO1xyXG4gICAgICAgICAgICBpZiAobm9kZS5sYWJlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlLmxhYmVsID0gbGFiZWw7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oaWRkZW5MYWJlbCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlLmhpZGRlbkxhYmVsID0gbGFiZWw7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VzcGljaW91cyBub2RlOiAke0pTT04uc3RyaW5naWZ5KG5vZGUpfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLm5vZGVzRGF0YXNldC51cGRhdGUoUi52YWx1ZXMoYWxsTm9kZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbk5ldHdvcmtTZWxlY3RvckNoYW5nZURlbGVnYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCdhY3Rpdml0eUJsb2NrJyksIGV2ZW50LnRhcmdldC52YWx1ZSAhPT0gJ2NoYXJhY3RlckFjdGl2aXR5SW5TdG9yeScpO1xyXG4gICAgICAgIHF1ZXJ5RWxzKCcjYWN0aXZpdHlCbG9jayBidXR0b24nKS5mb3JFYWNoKGVsID0+IGFkZENsYXNzKGVsLCAnYnRuLXByaW1hcnknKSk7XHJcbiAgICAgICAgaGlkZUVsKGdldEVsKCdyZWxhdGlvbnNCbG9jaycpLCBldmVudC50YXJnZXQudmFsdWUgIT09ICdjaGFyYWN0ZXJSZWxhdGlvbnMnKTtcclxuICAgICAgICBxdWVyeUVscygnI3JlbGF0aW9uc0Jsb2NrIGJ1dHRvbicpLmZvckVhY2goZWwgPT4gYWRkQ2xhc3MoZWwsICdidG4tcHJpbWFyeScpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbk5vZGVGb2N1cyhldmVudCkge1xyXG4gICAgICAgIHN0YXRlLm5ldHdvcmsuZm9jdXMoZXZlbnQudGFyZ2V0LnZhbHVlLCBDb25zdGFudHMuc25Gb2N1c09wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uRHJhd05ldHdvcmsoKSB7XHJcbiAgICAgICAgb25OZXR3b3JrU2VsZWN0b3JDaGFuZ2UoZ2V0RWwoJ25ldHdvcmtTZWxlY3RvcicpLnZhbHVlKTtcclxuICAgIC8vICAgIFRpbWVsaW5lZE5ldHdvcmsucmVmcmVzaChzdGF0ZS5uZXR3b3JrLCBzdGF0ZS5ub2Rlc0RhdGFzZXQsXHJcbiAgICAvLyAgICAgICAgICAgIHN0YXRlLmVkZ2VzRGF0YXNldCwgZ2V0RXZlbnREZXRhaWxzKCksIHN0YXRlLm1ldGFJbmZvKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBvbk5ldHdvcmtTZWxlY3RvckNoYW5nZShzZWxlY3RlZE5ldHdvcmspIHtcclxuICAgICAgICBzdGF0ZS5zZWxlY3RlZE5ldHdvcmsgPSBzZWxlY3RlZE5ldHdvcms7XHJcbiAgICAgICAgbGV0IG5vZGVzID0gW107XHJcbiAgICAgICAgbGV0IGVkZ2VzID0gW107XHJcblxyXG4gICAgICAgIHN3aXRjaCAoc2VsZWN0ZWROZXR3b3JrKSB7XHJcbiAgICAgICAgY2FzZSAnc29jaWFsUmVsYXRpb25zJzpcclxuICAgICAgICAgICAgbm9kZXMgPSBnZXRDaGFyYWN0ZXJOb2RlcygpO1xyXG4gICAgICAgICAgICBlZGdlcyA9IGdldERldGFpbGVkRWRnZXMoKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY2hhcmFjdGVyUHJlc2VuY2VJblN0b3J5JzpcclxuICAgICAgICAgICAgbm9kZXMgPSBnZXRDaGFyYWN0ZXJOb2RlcygpLmNvbmNhdChnZXRTdG9yeU5vZGVzKCkpO1xyXG4gICAgICAgICAgICBlZGdlcyA9IGdldFN0b3J5RWRnZXMoKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY2hhcmFjdGVyQWN0aXZpdHlJblN0b3J5JzpcclxuICAgICAgICAgICAgbm9kZXMgPSBnZXRDaGFyYWN0ZXJOb2RlcygpLmNvbmNhdChnZXRTdG9yeU5vZGVzKCkpO1xyXG4gICAgICAgICAgICBlZGdlcyA9IGdldEFjdGl2aXR5RWRnZXMoKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnY2hhcmFjdGVyUmVsYXRpb25zJzpcclxuICAgICAgICAgICAgbm9kZXMgPSBnZXRDaGFyYWN0ZXJOb2RlcygpO1xyXG4gICAgICAgICAgICBlZGdlcyA9IGdldFJlbGF0aW9uRWRnZXMoKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIG5ldHdvcmsgdHlwZTogJHtzZWxlY3RlZE5ldHdvcmt9YCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZWZyZXNoTGVnZW5kKGdldEVsKCduZXR3b3JrTm9kZUdyb3VwU2VsZWN0b3InKS52YWx1ZSk7XHJcblxyXG4gICAgICAgIGNsZWFyRWwoZ2V0RWwoJ25vZGVGb2N1c1NlbGVjdG9yJykpO1xyXG4gICAgICAgIG5vZGVzLnNvcnQobm9kZVNvcnQpO1xyXG5cclxuICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGFDb21tb24ocmVtYXBQcm9wcyhbJ2lkJywgJ3RleHQnXSwgWydpZCcsICdvcmlnaW5OYW1lJ10pLCBub2Rlcyk7XHJcbiAgICAgICAgJCgnI25vZGVGb2N1c1NlbGVjdG9yJykuc2VsZWN0MihkYXRhKTtcclxuXHJcbiAgICAgICAgc3RhdGUubm9kZXNEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KG5vZGVzKTtcclxuICAgICAgICBzdGF0ZS5lZGdlc0RhdGFzZXQgPSBuZXcgdmlzLkRhdGFTZXQoZWRnZXMpO1xyXG5cclxuICAgICAgICByZWRyYXdBbGwoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ2hhcmFjdGVyTm9kZUxhYmVsKHNob3dQbGF5ZXIsIGNoYXJhY3Rlck5hbWUpIHtcclxuICAgICAgICBjb25zdCBsYWJlbCA9IGNoYXJhY3Rlck5hbWUuc3BsaXQoJyAnKS5qb2luKCdcXG4nKTtcclxuICAgICAgICBpZiAoc2hvd1BsYXllcikge1xyXG4gICAgICAgICAgICBjb25zdCBwbGF5ZXIgPSBzdGF0ZS5wcm9maWxlQmluZGluZ3NbY2hhcmFjdGVyTmFtZV0gfHwgJyc7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtsYWJlbH0vXFxuJHtwbGF5ZXJ9YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGxhYmVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldENoYXJhY3Rlck5vZGVzKCkge1xyXG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IGdldEVsKCduZXR3b3JrTm9kZUdyb3VwU2VsZWN0b3InKS52YWx1ZTtcclxuICAgICAgICBjb25zdCBzaG93UGxheWVyID0gZ2V0RWwoJ3Nob3dQbGF5ZXJOYW1lc0NoZWNrYm94JykuY2hlY2tlZDtcclxuICAgICAgICByZXR1cm4gTmV0d29ya1N1YnNldHNTZWxlY3Rvci5nZXRDaGFyYWN0ZXJOYW1lcygpLm1hcCgoY2hhcmFjdGVyTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwcm9maWxlID0gc3RhdGUuQ2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGlkOiBDSEFSX1BSRUZJWCArIGNoYXJhY3Rlck5hbWUsXHJcbiAgICAgICAgICAgICAgICBsYWJlbDogbWFrZUNoYXJhY3Rlck5vZGVMYWJlbChzaG93UGxheWVyLCBjaGFyYWN0ZXJOYW1lKSxcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdjaGFyYWN0ZXInLFxyXG4gICAgICAgICAgICAgICAgb3JpZ2luTmFtZTogY2hhcmFjdGVyTmFtZSxcclxuICAgICAgICAgICAgICAgIGdyb3VwOiBncm91cE5hbWUgPT09ICdub0dyb3VwJyA/IGNvbnN0TDEwbignbm9Hcm91cCcpIDogYCR7Z3JvdXBOYW1lfS4ke3Byb2ZpbGVbZ3JvdXBOYW1lXX1gXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U3RvcnlOb2RlcygpIHtcclxuICAgICAgICBjb25zdCBub2RlcyA9IE5ldHdvcmtTdWJzZXRzU2VsZWN0b3IuZ2V0U3RvcnlOYW1lcygpLm1hcChuYW1lID0+ICh7XHJcbiAgICAgICAgICAgIGlkOiBTVE9SWV9QUkVGSVggKyBuYW1lLFxyXG4gICAgICAgICAgICBsYWJlbDogbmFtZS5zcGxpdCgnICcpLmpvaW4oJ1xcbicpLFxyXG4gICAgICAgICAgICB2YWx1ZTogT2JqZWN0LmtleXMoc3RhdGUuU3Rvcmllc1tuYW1lXS5jaGFyYWN0ZXJzKS5sZW5ndGgsXHJcbiAgICAgICAgICAgIHRpdGxlOiBPYmplY3Qua2V5cyhzdGF0ZS5TdG9yaWVzW25hbWVdLmNoYXJhY3RlcnMpLmxlbmd0aCxcclxuICAgICAgICAgICAgZ3JvdXA6ICdzdG9yeUNvbG9yJyxcclxuICAgICAgICAgICAgdHlwZTogJ3N0b3J5JyxcclxuICAgICAgICAgICAgb3JpZ2luTmFtZTogbmFtZSxcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgcmV0dXJuIG5vZGVzO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEFjdGl2aXR5RWRnZXMoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRBY3Rpdml0aWVzID0gcXVlcnlFbHMoJyNhY3Rpdml0eUJsb2NrIGJ1dHRvbi5idG4tcHJpbWFyeScpLm1hcChnZXRBdHRyKFIuX18sICdkYXRhLXZhbHVlJykpO1xyXG4gICAgICAgIGNvbnN0IHN0b3JpZXMgPSBzdGF0ZS5TdG9yaWVzO1xyXG4gICAgICAgIHJldHVybiBSLmZsYXR0ZW4oUi5rZXlzKHN0b3JpZXMpLm1hcChuYW1lID0+IFIua2V5cyhzdG9yaWVzW25hbWVdLmNoYXJhY3RlcnMpXHJcbiAgICAgICAgICAgIC5tYXAoY2hhcjEgPT4gUi5rZXlzKHN0b3JpZXNbbmFtZV0uY2hhcmFjdGVyc1tjaGFyMV0uYWN0aXZpdHkpLmZpbHRlcihSLmNvbnRhaW5zKFIuX18sIHNlbGVjdGVkQWN0aXZpdGllcykpXHJcbiAgICAgICAgICAgICAgICAubWFwKGFjdGl2aXR5ID0+ICh7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJvbTogU1RPUllfUFJFRklYICsgbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB0bzogQ0hBUl9QUkVGSVggKyBjaGFyMSxcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcjogQ29uc3RhbnRzLnNuQWN0aXZpdHlDb2xvcnNbYWN0aXZpdHldLFxyXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiAyLFxyXG4gICAgICAgICAgICAgICAgICAgIGhvdmVyV2lkdGg6IDRcclxuICAgICAgICAgICAgICAgIH0pKSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRSZWxhdGlvbkVkZ2VzKCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkUmVsYXRpb25zID0gcXVlcnlFbHMoJyNyZWxhdGlvbnNCbG9jayBidXR0b24uYnRuLXByaW1hcnknKS5tYXAoZ2V0QXR0cihSLl9fLCAnZGF0YS12YWx1ZScpKTtcclxuICAgICAgICBjb25zdCB7IHJlbGF0aW9ucyB9ID0gc3RhdGU7XHJcbiAgICAgICAgY29uc3QgY2hlY2tlZCA9IFIuY29udGFpbnMoUi5fXywgc2VsZWN0ZWRSZWxhdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiBSLmZsYXR0ZW4ocmVsYXRpb25zLm1hcCgocmVsKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCB7IHN0YXJ0ZXIgfSA9IHJlbDtcclxuICAgICAgICAgICAgY29uc3QgeyBlbmRlciB9ID0gcmVsO1xyXG4gICAgICAgICAgICBjb25zdCBlZGdlVG1wbCA9IHtcclxuICAgICAgICAgICAgICAgIGZyb206IENIQVJfUFJFRklYICsgc3RhcnRlcixcclxuICAgICAgICAgICAgICAgIHRvOiBDSEFSX1BSRUZJWCArIGVuZGVyLFxyXG4gICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zblJlbGF0aW9uQ29sb3JzLm5ldXRyYWwsXHJcbiAgICAgICAgICAgICAgICB3aWR0aDogMixcclxuICAgICAgICAgICAgICAgIGhvdmVyV2lkdGg6IDRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKHJlbC5lc3NlbmNlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrZWQoJ25ldXRyYWwnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKFIubWVyZ2UoZWRnZVRtcGwsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zblJlbGF0aW9uQ29sb3JzLm5ldXRyYWwsXHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoZWNrZWQoJ2FsbGllcycpICYmIFIuY29udGFpbnMoJ2FsbGllcycsIHJlbC5lc3NlbmNlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKFIubWVyZ2UoZWRnZVRtcGwsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zblJlbGF0aW9uQ29sb3JzLmFsbGllcyxcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tlZCgnZGlyZWN0aW9uYWwnKSAmJiBSLmNvbnRhaW5zKCdzdGFydGVyVG9FbmRlcicsIHJlbC5lc3NlbmNlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKFIubWVyZ2UoZWRnZVRtcGwsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zblJlbGF0aW9uQ29sb3JzLnN0YXJ0ZXJUb0VuZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJvd3M6ICd0bydcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tlZCgnZGlyZWN0aW9uYWwnKSAmJiBSLmNvbnRhaW5zKCdlbmRlclRvU3RhcnRlcicsIHJlbC5lc3NlbmNlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKFIubWVyZ2UoZWRnZVRtcGwsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENvbnN0YW50cy5zblJlbGF0aW9uQ29sb3JzLmVuZGVyVG9TdGFydGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJvd3M6ICdmcm9tJ1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTdG9yeUVkZ2VzKCkge1xyXG4gICAgICAgIHJldHVybiBSLmZsYXR0ZW4oUi5rZXlzKHN0YXRlLlN0b3JpZXMpLm1hcChuYW1lID0+IFIua2V5cyhzdGF0ZS5TdG9yaWVzW25hbWVdLmNoYXJhY3RlcnMpLm1hcChjaGFyMSA9PiAoe1xyXG4gICAgICAgICAgICBmcm9tOiBTVE9SWV9QUkVGSVggKyBuYW1lLFxyXG4gICAgICAgICAgICB0bzogQ0hBUl9QUkVGSVggKyBjaGFyMSxcclxuICAgICAgICAgICAgY29sb3I6ICdncmV5J1xyXG4gICAgICAgIH0pKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEV2ZW50RGV0YWlscygpIHtcclxuICAgICAgICByZXR1cm4gUi5mbGF0dGVuKFIudmFsdWVzKHN0YXRlLlN0b3JpZXMpLm1hcChzdG9yeSA9PiBzdG9yeS5ldmVudHMubWFwKGV2ZW50ID0+ICh7XHJcbiAgICAgICAgICAgIGV2ZW50TmFtZTogZXZlbnQubmFtZSxcclxuICAgICAgICAgICAgc3RvcnlOYW1lOiBzdG9yeS5uYW1lLFxyXG4gICAgICAgICAgICB0aW1lOiBldmVudC50aW1lLFxyXG4gICAgICAgICAgICBjaGFyYWN0ZXJzOiBSLmtleXMoZXZlbnQuY2hhcmFjdGVycylcclxuICAgICAgICB9KSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXREZXRhaWxlZEVkZ2VzKCkge1xyXG4gICAgICAgIGNvbnN0IGVkZ2VzQ2hlY2sgPSB7fTtcclxuICAgICAgICBSLnZhbHVlcyhzdGF0ZS5TdG9yaWVzKS5mb3JFYWNoKChzdG9yeSkgPT4ge1xyXG4gICAgICAgICAgICBzdG9yeS5ldmVudHMuZm9yRWFjaCgoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNoYXJOYW1lcyA9IFIua2V5cyhldmVudC5jaGFyYWN0ZXJzKS5zb3J0KCk7XHJcbiAgICAgICAgICAgICAgICBjaGFyTmFtZXMuZm9yRWFjaCgoY2hhcjEsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjaGFyTmFtZXMuZm9yRWFjaCgoY2hhcjIsIGopID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPD0gaikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGNoYXIxICsgY2hhcjI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZWRnZXNDaGVja1trZXldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGdlc0NoZWNrW2tleV0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogQ0hBUl9QUkVGSVggKyBjaGFyMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogQ0hBUl9QUkVGSVggKyBjaGFyMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZToge30sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkZ2VzQ2hlY2tba2V5XS50aXRsZVtzdG9yeS5uYW1lXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBSLnZhbHVlcyhlZGdlc0NoZWNrKS5tYXAoKGVkZ2VJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gUi5rZXlzKGVkZ2VJbmZvLnRpdGxlKS5zb3J0KCkuam9pbignLCAnKTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBSLmtleXMoZWRnZUluZm8udGl0bGUpLmxlbmd0aDtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGZyb206IGVkZ2VJbmZvLmZyb20sXHJcbiAgICAgICAgICAgICAgICB0bzogZWRnZUluZm8udG8sXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogYCR7dmFsdWV9OiAke3RpdGxlfWAsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZSxcclxuICAgICAgICAgICAgICAgIGNvbG9yOiAnZ3JleSdcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZWRyYXdBbGwoKSB7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZ2V0RWwoJ3NvY2lhbE5ldHdvcmtDb250YWluZXInKTtcclxuXHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgbm9kZXM6IHN0YXRlLm5vZGVzRGF0YXNldCxcclxuICAgICAgICAgICAgZWRnZXM6IHN0YXRlLmVkZ2VzRGF0YXNldFxyXG4gICAgICAgIH07IC8vIE5vdGU6IGRhdGEgaXMgY29taW5nIGZyb20gLi9kYXRhc291cmNlcy9Xb3JsZEN1cDIwMTQuanNcclxuXHJcbiAgICAgICAgaWYgKHN0YXRlLm5ldHdvcmspIHtcclxuICAgICAgICAgICAgc3RhdGUubmV0d29yay5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBvcHRzID0gQ29tbW9uVXRpbHMuY2xvbmUoQ29uc3RhbnRzLnNvY2lhbE5ldHdvcmtPcHRzKTtcclxuICAgICAgICBvcHRzLmdyb3VwcyA9IHN0YXRlLmdyb3VwQ29sb3JzO1xyXG5cclxuICAgICAgICBzdGF0ZS5uZXR3b3JrID0gbmV3IHZpcy5OZXR3b3JrKGNvbnRhaW5lciwgZGF0YSwgb3B0cyk7XHJcblxyXG4gICAgICAgIHN0YXRlLm5ldHdvcmsub24oJ2NsaWNrJywgbmVpZ2hib3VyaG9vZEhpZ2hsaWdodCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGlkZUxhYmVsKG5vZGUpIHtcclxuICAgICAgICBpZiAobm9kZS5oaWRkZW5MYWJlbCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIG5vZGUuaGlkZGVuTGFiZWwgPSBub2RlLmxhYmVsO1xyXG4gICAgICAgICAgICBub2RlLmxhYmVsID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHNob3dMYWJlbChub2RlKSB7XHJcbiAgICAgICAgaWYgKG5vZGUuaGlkZGVuTGFiZWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBub2RlLmxhYmVsID0gbm9kZS5oaWRkZW5MYWJlbDtcclxuICAgICAgICAgICAgbm9kZS5oaWRkZW5MYWJlbCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGlnaGxpZ2h0Tm9kZXMobmV0d29yaywgYWxsTm9kZXMsIHplcm9EZWdyZWVOb2RlcywgZmlyc3REZWdyZWVOb2Rlcykge1xyXG4gICAgICAgIC8vIGdldCB0aGUgc2Vjb25kIGRlZ3JlZSBub2Rlc1xyXG4gICAgICAgIGNvbnN0IHNlY29uZERlZ3JlZU5vZGVzID0gUi51bmlxKFIuZmxhdHRlbihmaXJzdERlZ3JlZU5vZGVzLm1hcChpZCA9PiBuZXR3b3JrLmdldENvbm5lY3RlZE5vZGVzKGlkKSkpKTtcclxuICAgICAgICAvLyBtYXJrIGFsbCBub2RlcyBhcyBoYXJkIHRvIHJlYWQuXHJcbiAgICAgICAgUi52YWx1ZXMoYWxsTm9kZXMpLmZvckVhY2goKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgbm9kZS5jb2xvciA9ICdyZ2JhKDIwMCwyMDAsMjAwLDAuNSknO1xyXG4gICAgICAgICAgICBoaWRlTGFiZWwobm9kZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gYWxsIHNlY29uZCBkZWdyZWUgbm9kZXMgZ2V0IGEgZGlmZmVyZW50IGNvbG9yIGFuZCB0aGVpciBsYWJlbCBiYWNrXHJcbiAgICAgICAgc2Vjb25kRGVncmVlTm9kZXMubWFwKGlkID0+IGFsbE5vZGVzW2lkXSkuZm9yRWFjaCgobm9kZSkgPT4ge1xyXG4gICAgICAgICAgICBub2RlLmNvbG9yID0gJ3JnYmEoMTUwLDE1MCwxNTAsMC43NSknO1xyXG4gICAgICAgICAgICBzaG93TGFiZWwobm9kZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gYWxsIGZpcnN0IGRlZ3JlZSBub2RlcyBnZXQgdGhlaXIgb3duIGNvbG9yIGFuZCB0aGVpciBsYWJlbCBiYWNrXHJcbiAgICAgICAgZmlyc3REZWdyZWVOb2Rlcy5tYXAoaWQgPT4gYWxsTm9kZXNbaWRdKS5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgIG5vZGUuY29sb3IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHNob3dMYWJlbChub2RlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyB0aGUgbWFpbiBub2RlIGdldHMgaXRzIG93biBjb2xvciBhbmQgaXRzIGxhYmVsIGJhY2suXHJcbiAgICAgICAgemVyb0RlZ3JlZU5vZGVzLm1hcChpZCA9PiBhbGxOb2Rlc1tpZF0pLmZvckVhY2goKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgbm9kZS5jb2xvciA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgc2hvd0xhYmVsKG5vZGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG5laWdoYm91cmhvb2RIaWdobGlnaHQocGFyYW1zKSB7XHJcbiAgICAgICAgLy8gZ2V0IGEgSlNPTiBvYmplY3RcclxuICAgICAgICBjb25zdCBhbGxOb2RlcyA9IHN0YXRlLm5vZGVzRGF0YXNldC5nZXQoe1xyXG4gICAgICAgICAgICByZXR1cm5UeXBlOiAnT2JqZWN0J1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB7IG5ldHdvcmsgfSA9IHN0YXRlO1xyXG4gICAgICAgIGlmIChwYXJhbXMubm9kZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBzdGF0ZS5oaWdobGlnaHRBY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZE5vZGUgPSBwYXJhbXMubm9kZXNbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IHplcm9EZWdyZWVOb2RlcyA9IFtzZWxlY3RlZE5vZGVdO1xyXG4gICAgICAgICAgICBjb25zdCBmaXJzdERlZ3JlZU5vZGVzID0gbmV0d29yay5nZXRDb25uZWN0ZWROb2RlcyhzZWxlY3RlZE5vZGUpO1xyXG4gICAgICAgICAgICBoaWdobGlnaHROb2RlcyhuZXR3b3JrLCBhbGxOb2RlcywgemVyb0RlZ3JlZU5vZGVzLCBmaXJzdERlZ3JlZU5vZGVzKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHBhcmFtcy5lZGdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmhpZ2hsaWdodEFjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRWRnZSA9IHBhcmFtcy5lZGdlc1swXTtcclxuICAgICAgICAgICAgY29uc3QgZmlyc3REZWdyZWVOb2RlcyA9IG5ldHdvcmsuZ2V0Q29ubmVjdGVkTm9kZXMoc2VsZWN0ZWRFZGdlKTtcclxuICAgICAgICAgICAgaGlnaGxpZ2h0Tm9kZXMobmV0d29yaywgYWxsTm9kZXMsIFtdLCBmaXJzdERlZ3JlZU5vZGVzKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhpZ2hsaWdodEFjdGl2ZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAvLyByZXNldCBhbGwgbm9kZXNcclxuICAgICAgICAgICAgUi52YWx1ZXMoYWxsTm9kZXMpLmZvckVhY2goKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgICAgIG5vZGUuY29sb3IgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBzaG93TGFiZWwobm9kZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzdGF0ZS5oaWdobGlnaHRBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHRyYW5zZm9ybSB0aGUgb2JqZWN0IGludG8gYW4gYXJyYXlcclxuICAgICAgICBzdGF0ZS5ub2Rlc0RhdGFzZXQudXBkYXRlKFIudmFsdWVzKGFsbE5vZGVzKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuU29jaWFsTmV0d29yayA9IHt9KTtcclxuIiwiLy9cInVzZSBzdHJpY3RcIjtcclxuLy9cclxuLy8oZnVuY3Rpb24oZXhwb3J0cyl7XHJcbi8vXHJcbi8vLy8gICAgdmFyIGNhbWVyYUluaXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygtMzAsIDQwLCAzMCkubXVsdGlwbHlTY2FsYXIoMi41KTtcclxuLy8vLyAgICB2YXIgY2FtZXJhSW5pdFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDQwLCA0MCkubXVsdGlwbHlTY2FsYXIoMi41KTtcclxuLy8vLyAgICB2YXIgY2FtZXJhSW5pdFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDQwKS5tdWx0aXBseVNjYWxhcigyLjUpO1xyXG4vLyAgICB2YXIgY2FtZXJhSW5pdFBvcyA9IG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDYwKS5tdWx0aXBseVNjYWxhcigyLjUpO1xyXG4vLyAgICB2YXIgYmFzaWNaU2NhbGUgPSAyNTtcclxuLy8gICAgdmFyIHNwb3RMaWdodEluaXRQb3MgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCA1MCk7XHJcbi8vXHJcbi8vICAgIC8vIHRocmVlLmpzXHJcbi8vICAgIHZhciBjYW1lcmE7XHJcbi8vICAgIHZhciBzY2VuZTtcclxuLy8gICAgdmFyIHJlbmRlcmVyO1xyXG4vLyAgICB2YXIgY29udHJvbHM7XHJcbi8vICAgIHZhciBzdGF0cztcclxuLy9cclxuLy8gICAgZnVuY3Rpb24gaW5pdFN0YXRzKCkge1xyXG4vLyAgICAgICAgdmFyIHN0YXRzID0gbmV3IFN0YXRzKCk7XHJcbi8vICAgICAgICBzdGF0cy5zZXRNb2RlKDApOyAvLyAwOiBmcHMsIDE6IG1zXHJcbi8vICAgICAgICBhZGRFbChjbGVhckVsKGdldEVsKFwiU3RhdHMtb3V0cHV0XCIpKSwgc3RhdHMuZG9tRWxlbWVudCk7XHJcbi8vICAgICAgICByZXR1cm4gc3RhdHM7XHJcbi8vICAgIH07XHJcbi8vXHJcbi8vICAgIGZ1bmN0aW9uIGluaXQoKXtcclxuLy8gICAgICAgIC8vIGNyZWF0ZSBhIHJlbmRlciBhbmQgc2V0IHRoZSBzaXplXHJcbi8vICAgICAgICByZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKCk7XHJcbi8vICAgICAgICByZW5kZXJlci5zZXRDbGVhckNvbG9yKG5ldyBUSFJFRS5Db2xvcigweEVFRUVFRSwgMS4wKSk7XHJcbi8vICAgICAgICBhZGRFbChjbGVhckVsKGdldEVsKFwiV2ViR0wtb3V0cHV0XCIpKSwgcmVuZGVyZXIuZG9tRWxlbWVudCk7XHJcbi8vXHJcbi8vICAgICAgICBzdGF0cyA9IGluaXRTdGF0cygpO1xyXG4vL1xyXG4vLyAgICAgICAgY29udHJvbHMgPSBuZXcgZnVuY3Rpb24gKCkge1xyXG4vLyAgICAgICAgICAgIHRoaXMucm90YXRpb25TcGVlZCA9IDAuMDg7XHJcbi8vLy8gICAgICAgICAgICB0aGlzLmJvdW5jaW5nU3BlZWQgPSAwLjAzO1xyXG4vLyAgICAgICAgICAgIHRoaXMuelNjYWxlID0gYmFzaWNaU2NhbGU7XHJcbi8vICAgICAgICAgICAgdGhpcy5wbGFuZVNjYWxlID0gMTA7XHJcbi8vICAgICAgICAgICAgdGhpcy5jYW1lcmFaID0gMTIwO1xyXG4vLy8vICAgICAgICAgICAgdGhpcy5jYW1lcmFSb3RYID0gMDtcclxuLy8vLyAgICAgICAgICAgIHRoaXMuY2FtZXJhUm90WSA9IDA7XHJcbi8vLy8gICAgICAgICAgICB0aGlzLmNhbWVyYVJvdFogPSAwO1xyXG4vL1xyXG4vLyAgICAgICAgICAgIHRoaXMub3V0cHV0T2JqZWN0cyA9IGZ1bmN0aW9uICgpIHtcclxuLy8gICAgICAgICAgICAgICAgY29uc29sZS5sb2coc2NlbmUuY2hpbGRyZW4pO1xyXG4vLyAgICAgICAgICAgIH1cclxuLy8gICAgICAgIH07XHJcbi8vXHJcbi8vXHJcbi8vICAgICAgICB2YXIgZ3VpID0gbmV3IGRhdC5HVUkoeyBhdXRvUGxhY2U6IGZhbHNlIH0pO1xyXG4vLyAgICAgICAgZ3VpLmFkZChjb250cm9scywgJ3JvdGF0aW9uU3BlZWQnLCAwLCAwLjUpO1xyXG4vLy8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnYm91bmNpbmdTcGVlZCcsIDAsIDAuNSk7XHJcbi8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnelNjYWxlJywgMSwgMTAwKTtcclxuLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdwbGFuZVNjYWxlJywgMSwgMTAwKTtcclxuLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdjYW1lcmFaJywgLTUwMCwgNTAwKTtcclxuLy8vLyAgICAgICAgZ3VpLmFkZChjb250cm9scywgJ2NhbWVyYVJvdFgnLCAtMSwgMSk7XHJcbi8vLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdjYW1lcmFSb3RZJywgLTEsIDEpO1xyXG4vLy8vICAgICAgICBndWkuYWRkKGNvbnRyb2xzLCAnY2FtZXJhUm90WicsIC0xLCAxKTtcclxuLy9cclxuLy8gICAgICAgIGd1aS5hZGQoY29udHJvbHMsICdvdXRwdXRPYmplY3RzJyk7XHJcbi8vXHJcbi8vICAgICAgICBhZGRFbChnZXRFbCgnZ3VpLXNldHRpbmdzLW91dHB1dCcpLCBndWkuZG9tRWxlbWVudCk7XHJcbi8vICAgIC8vICAgIHJlbmRlcmVyLnNoYWRvd01hcEVuYWJsZWQgPSB0cnVlO1xyXG4vLyAgICB9O1xyXG4vL1xyXG4vLyAgICB2YXIgaXNGaXJzdFJlZnJlc2ggPSB0cnVlO1xyXG4vL1xyXG4vLyAgICAvLyBvbmNlIGV2ZXJ5dGhpbmcgaXMgbG9hZGVkLCB3ZSBydW4gb3VyIFRocmVlLmpzIHN0dWZmLlxyXG4vLyAgICBmdW5jdGlvbiByZWZyZXNoKG5ldHdvcmssIG5vZGVzLCBlZGdlcywgZXZlbnREZXRhaWxzLCBtZXRhSW5mbykge1xyXG4vL1xyXG4vLyAgICAgICAgdmFyIGxvd2VyVGltZUJvdW5kYXJ5ID0gbmV3IERhdGUobWV0YUluZm8ucHJlR2FtZURhdGUpLmdldFRpbWUoKTtcclxuLy8gICAgICAgIHZhciB1cHBlclRpbWVCb3VuZGFyeSA9IG5ldyBEYXRlKG1ldGFJbmZvLmRhdGUpLmdldFRpbWUoKTtcclxuLy8gICAgICAgIHZhciB0aW1lRGlmZiA9IHVwcGVyVGltZUJvdW5kYXJ5IC0gbG93ZXJUaW1lQm91bmRhcnk7XHJcbi8vICAgICAgICBjb25zb2xlLmxvZyhsb3dlclRpbWVCb3VuZGFyeSk7XHJcbi8vICAgICAgICBjb25zb2xlLmxvZyh1cHBlclRpbWVCb3VuZGFyeSk7XHJcbi8vICAgICAgICBjb25zb2xlLmxvZyh0aW1lRGlmZik7XHJcbi8vXHJcbi8vICAgICAgICB2YXIgY2hhcmFjdGVyRXZlbnRzID0ge307XHJcbi8vICAgICAgICB2YXIgc3RvcnlFdmVudHMgPSB7fTtcclxuLy8gICAgICAgIGV2ZW50RGV0YWlscy5mb3JFYWNoKGZ1bmN0aW9uKGV2ZW50SW5mbyl7XHJcbi8vICAgICAgICAgICAgaWYoZXZlbnRJbmZvLnRpbWUgPT09ICcnKXtcclxuLy8gICAgICAgICAgICAgICAgZXZlbnRJbmZvLnRpbWUgPSBtZXRhSW5mby5kYXRlO1xyXG4vLyAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICBldmVudEluZm8uc2NhbGVkVGltZSA9IChuZXcgRGF0ZShldmVudEluZm8udGltZSkuZ2V0VGltZSgpIC0gbG93ZXJUaW1lQm91bmRhcnkpIC8gdGltZURpZmY7XHJcbi8vICAgICAgICAgICAgY29uc29sZS5sb2coZXZlbnRJbmZvLnNjYWxlZFRpbWUpO1xyXG4vLyAgICAgICAgICAgIHN0b3J5RXZlbnRzW2V2ZW50SW5mby5zdG9yeU5hbWVdID0gc3RvcnlFdmVudHNbZXZlbnRJbmZvLnN0b3J5TmFtZV0gfHwge2V2ZW50czogW119O1xyXG4vLyAgICAgICAgICAgIHN0b3J5RXZlbnRzW2V2ZW50SW5mby5zdG9yeU5hbWVdLmV2ZW50cy5wdXNoKGV2ZW50SW5mbyk7XHJcbi8vICAgICAgICAgICAgZXZlbnRJbmZvLmNoYXJhY3RlcnMuZm9yRWFjaChmdW5jdGlvbihjaGFyYWN0ZXIpe1xyXG4vLyAgICAgICAgICAgICAgICBjaGFyYWN0ZXJFdmVudHNbY2hhcmFjdGVyXSA9IGNoYXJhY3RlckV2ZW50c1tjaGFyYWN0ZXJdIHx8IHtldmVudHM6IFtdfTtcclxuLy8gICAgICAgICAgICAgICAgY2hhcmFjdGVyRXZlbnRzW2NoYXJhY3Rlcl0uZXZlbnRzLnB1c2goZXZlbnRJbmZvKTtcclxuLy8gICAgICAgICAgICB9KTtcclxuLy8gICAgICAgIH0pO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2coc3RvcnlFdmVudHMpO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2coY2hhcmFjdGVyRXZlbnRzKTtcclxuLy8gICAgICAgIGZ1bmN0aW9uIGZpbGxNaW5NYXgob2JqSW5mbyl7XHJcbi8vICAgICAgICAgICAgb2JqSW5mby5taW5UaW1lID0gUi5yZWR1Y2UoUi5taW4sIEluZmluaXR5LCBvYmpJbmZvLmV2ZW50cy5tYXAoUi5wcm9wKCdzY2FsZWRUaW1lJykpKTtcclxuLy8gICAgICAgICAgICBvYmpJbmZvLm1heFRpbWUgPSBSLnJlZHVjZShSLm1heCwgLUluZmluaXR5LCBvYmpJbmZvLmV2ZW50cy5tYXAoUi5wcm9wKCdzY2FsZWRUaW1lJykpKTtcclxuLy8gICAgICAgIH1cclxuLy8gICAgICAgIFIudmFsdWVzKHN0b3J5RXZlbnRzKS5mb3JFYWNoKGZpbGxNaW5NYXgpO1xyXG4vLyAgICAgICAgUi52YWx1ZXMoY2hhcmFjdGVyRXZlbnRzKS5mb3JFYWNoKGZpbGxNaW5NYXgpO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2coc3RvcnlFdmVudHMpO1xyXG4vLyAgICAgICAgY29uc29sZS5sb2coY2hhcmFjdGVyRXZlbnRzKTtcclxuLy9cclxuLy8gICAgICAgIHZhciBzaXplcyA9IHVwZGF0ZVJlbmRlcmVyU2l6ZSgpO1xyXG4vLy8vICAgICAgICBpZihpc0ZpcnN0UmVmcmVzaCl7XHJcbi8vICAgICAgICAvLyBjcmVhdGUgYSBzY2VuZSwgdGhhdCB3aWxsIGhvbGQgYWxsIG91ciBlbGVtZW50cyBzdWNoIGFzIG9iamVjdHMsIGNhbWVyYXMgYW5kIGxpZ2h0cy5cclxuLy8gICAgICAgIHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcbi8vXHJcbi8vICAgICAgICAvLyBjcmVhdGUgYSBjYW1lcmEsIHdoaWNoIGRlZmluZXMgd2hlcmUgd2UncmUgbG9va2luZyBhdC5cclxuLy8gICAgICAgIGNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSg0NSwgc2l6ZXMud2lkdGggLyBzaXplcy5oZWlnaHQsIDAuMSwgMTAwMCk7XHJcbi8vXHJcbi8vLy8gICAgICAgIHZhciBvcmJpdENvbnRyb2xzID0gbmV3IFRIUkVFLk9yYml0Q29udHJvbHMoY2FtZXJhKTtcclxuLy8vLy8vICAgICAgICBvcmJpdENvbnRyb2xzLmF1dG9Sb3RhdGUgPSB0cnVlO1xyXG4vLy8vICAgICAgICB2YXIgY2xvY2sgPSBuZXcgVEhSRUUuQ2xvY2soKTtcclxuLy9cclxuLy8gICAgICAgIC8vIHNob3cgYXhlcyBpbiB0aGUgc2NyZWVuXHJcbi8vICAgICAgICB2YXIgYXhlcyA9IG5ldyBUSFJFRS5BeGlzSGVscGVyKDIwKTtcclxuLy8gICAgICAgIHNjZW5lLmFkZChheGVzKTtcclxuLy9cclxuLy8gICAgICAgIC8vIGNyZWF0ZSB0aGUgZ3JvdW5kIHBsYW5lXHJcbi8vICAgICAgICB2YXIgcGxhbmVHZW9tZXRyeSA9IG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDYwLCAyMCwgMSwgMSk7XHJcbi8vICAgICAgICB2YXIgcGxhbmVNYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7Y29sb3I6IDB4ZmZmZmZmLCBvcGFjaXR5OiAwfSk7XHJcbi8vICAgICAgICB2YXIgcGxhbmUgPSBuZXcgVEhSRUUuTWVzaChwbGFuZUdlb21ldHJ5LCBwbGFuZU1hdGVyaWFsKTtcclxuLy8gICAgICAgIC8vICAgIHBsYW5lLnJlY2VpdmVTaGFkb3cgPSB0cnVlO1xyXG4vL1xyXG4vLyAgICAgICAgLy8gcm90YXRlIGFuZCBwb3NpdGlvbiB0aGUgcGxhbmVcclxuLy8gICAgICAgIHBsYW5lLnJvdGF0aW9uLnggPSAtMC41ICogTWF0aC5QSTtcclxuLy8gICAgICAgIHBsYW5lLnBvc2l0aW9uLnggPSAxNTtcclxuLy8gICAgICAgIHBsYW5lLnBvc2l0aW9uLnkgPSAwO1xyXG4vLyAgICAgICAgcGxhbmUucG9zaXRpb24ueiA9IDA7XHJcbi8vXHJcbi8vICAgICAgICAvLyBhZGQgdGhlIHBsYW5lIHRvIHRoZSBzY2VuZVxyXG4vLyAgICAgICAgc2NlbmUuYWRkKHBsYW5lKTtcclxuLy9cclxuLy8gICAgICAgIC8vIHBvc2l0aW9uIGFuZCBwb2ludCB0aGUgY2FtZXJhIHRvIHRoZSBjZW50ZXIgb2YgdGhlIHNjZW5lXHJcbi8vICAgICAgICBjYW1lcmEucG9zaXRpb24uY29weShjYW1lcmFJbml0UG9zKTtcclxuLy8gICAgICAgIGNhbWVyYS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG4vLyAgICAgICAgY2FtZXJhLnBvc2l0aW9uLmFkZChuZXcgVEhSRUUuVmVjdG9yMygwLCAtMTAwLCAwKSk7XHJcbi8vICAgICAgICBjYW1lcmEubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApKTtcclxuLy8vLyAgICAgICAgY2FtZXJhLnJvdGF0aW9uLnogPSAgTWF0aC5QSTtcclxuLy8vLyAgICAgICAgY2FtZXJhLmxvb2tBdChzY2VuZS5wb3NpdGlvbik7XHJcbi8vXHJcbi8vLy8gICAgICAgIGNhbWVyYS5yb3RhdGVPbkF4aXMoY2FtZXJhSW5pdFBvcy5ub3JtYWxpemUoKSAsIDAuNik7XHJcbi8vLy8gICAgICAgIGNhbWVyYS5yb3RhdGlvbi56ID0gMC43NSAqIE1hdGguUEk7XHJcbi8vXHJcbi8vLy8gICAgICAgIGNhbWVyYS5wb3NpdGlvbi54ID0gLTMwO1xyXG4vLy8vICAgICAgICBjYW1lcmEucG9zaXRpb24ueSA9IDQwO1xyXG4vLy8vICAgICAgICBjYW1lcmEucG9zaXRpb24ueiA9IDMwO1xyXG4vL1xyXG4vLyAgICAgICAgLy8gYWRkIHN1YnRsZSBhbWJpZW50IGxpZ2h0aW5nXHJcbi8vICAgICAgICB2YXIgYW1iaWVudExpZ2h0ID0gbmV3IFRIUkVFLkFtYmllbnRMaWdodCgweDBjMGMwYyk7XHJcbi8vICAgICAgICBzY2VuZS5hZGQoYW1iaWVudExpZ2h0KTtcclxuLy9cclxuLy8gICAgICAgIC8vIGFkZCBzcG90bGlnaHQgZm9yIHRoZSBzaGFkb3dzXHJcbi8vICAgICAgICB2YXIgc3BvdExpZ2h0ID0gbmV3IFRIUkVFLlNwb3RMaWdodCgweGZmZmZmZik7XHJcbi8vICAgICAgICBzcG90TGlnaHQucG9zaXRpb24uY29weShzcG90TGlnaHRJbml0UG9zKTtcclxuLy8gICAgICAgIC8vICAgIHNwb3RMaWdodC5jYXN0U2hhZG93ID0gdHJ1ZTtcclxuLy8gICAgICAgIHNjZW5lLmFkZChzcG90TGlnaHQpO1xyXG4vLy8vICAgICAgICAgICAgaXNGaXJzdFJlZnJlc2ggPSBmYWxzZTtcclxuLy8vLyAgICAgICAgfVxyXG4vL1xyXG4vLyAgICAgICAgLy8gY2FsbCB0aGUgcmVuZGVyIGZ1bmN0aW9uXHJcbi8vICAgICAgICB2YXIgc3RlcCA9IDA7XHJcbi8vXHJcbi8vICAgICAgICB2YXIgaXNJbml0aWFsaXplZCA9IGZhbHNlO1xyXG4vLy8vICAgICAgICBpZihpc0ZpcnN0UmVmcmVzaCl7XHJcbi8vICAgICAgICAgICAgcmVuZGVyKCk7XHJcbi8vLy8gICAgICAgICAgICBpc0ZpcnN0UmVmcmVzaCA9IGZhbHNlO1xyXG4vLy8vICAgICAgICB9XHJcbi8vLy8gICAgICAgIG5ldHdvcmsuc3RvcmVQb3NpdGlvbnMoKTtcclxuLy9cclxuLy8gICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50SW5mbyhpZCl7XHJcbi8vICAgICAgICAgICAgaWYoaWQuc3RhcnRzV2l0aCgnU3Q6Jykpe1xyXG4vLyAgICAgICAgICAgICAgICByZXR1cm4gc3RvcnlFdmVudHNbaWQuc3Vic3RyaW5nKDMpXTtcclxuLy8gICAgICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgICAgICByZXR1cm4gY2hhcmFjdGVyRXZlbnRzW2lkXTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9O1xyXG4vL1xyXG4vLyAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkge1xyXG4vLyAgICAgICAgICAgIHN0YXRzLnVwZGF0ZSgpO1xyXG4vLyAgICAgICAgICAgIG5ldHdvcmsuc3RvcmVQb3NpdGlvbnMoKTtcclxuLy8gICAgICAgICAgICBpZighaXNJbml0aWFsaXplZCl7XHJcbi8vICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5vZGVzLmdldCgpKTtcclxuLy8gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZWRnZXMuZ2V0KCkpO1xyXG4vLyAgICAgICAgICAgICAgICBub2Rlcy5nZXQoKS5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50SW5mbyA9IGdldEV2ZW50SW5mbyhub2RlLmlkKTtcclxuLy9cclxuLy8gICAgICAgICAgICAgICAgICAgIGlmKGV2ZW50SW5mbyl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGV2ZW50SW5mby5tYXhUaW1lIC0gZXZlbnRJbmZvLm1pblRpbWU7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHogPSAoZXZlbnRJbmZvLm1heFRpbWUgKyBldmVudEluZm8ubWluVGltZSkvMjtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBhZGRDeWxpbmRlcihub2RlLngvMTAsLW5vZGUueS8xMCwgeipiYXNpY1pTY2FsZSwgaGVpZ2h0LCAwLjUsIFN0cmluZygnY3lsLScgKyBub2RlLmlkKSk7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgICAgICBhZGRDeWxpbmRlcigwLDAsMCwgMiwgMC41LCBTdHJpbmcoJ2N5bC0nICsgbm9kZS5pZCkpO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ3lsaW5kZXIobm9kZS54LzEwLC1ub2RlLnkvMTAsIC01LCBoZWlnaHQsIDMsIFN0cmluZyhub2RlLmlkICsgJzAnKSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGFkZEN5bGluZGVyKG5vZGUueC8xMCwtbm9kZS55LzEwLCA0LCBTdHJpbmcobm9kZS5pZCArICcxLXRvcCcpKTtcclxuLy8gICAgICAgICAgICAgICAgfSk7XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgIGlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4vLyAgICAgICAgICAgIH0gZWxzZSB7XHJcbi8vICAgICAgICAgICAgICAgIG5vZGVzLmdldCgpLmZvckVhY2goZnVuY3Rpb24obm9kZSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICB2YXIgY3lsID0gc2NlbmUuZ2V0T2JqZWN0QnlOYW1lKFN0cmluZygnY3lsLScgKyBub2RlLmlkKSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihjeWwpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIGN5bC5wb3NpdGlvbi54ID0gbm9kZS54LzEwO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIGN5bC5wb3NpdGlvbi55ID0gLW5vZGUueS8xMDtcclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuLy8vLyAgICAgICAgICAgICAgICAgICAgY3lsID0gc2NlbmUuZ2V0T2JqZWN0QnlOYW1lKFN0cmluZyhub2RlLmlkICsgJzEtdG9wJykpO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICBjeWwucG9zaXRpb24ueCA9IG5vZGUueC8xMDtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgY3lsLnBvc2l0aW9uLnkgPSAtbm9kZS55LzEwO1xyXG4vLyAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vXHJcbi8vICAgICAgICAgICAgc2NlbmUudHJhdmVyc2UoZnVuY3Rpb24gKGUpIHtcclxuLy8gICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBUSFJFRS5NZXNoICYmIGUubmFtZS5zdGFydHNXaXRoKCdjeWwtJykpIHtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgZS5wb3NpdGlvbi55ID0gY29udHJvbHMuelNjYWxlO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50SW5mbyA9IGdldEV2ZW50SW5mbyhlLm5hbWUuc3Vic3RyaW5nKDQpKTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgaWYoZXZlbnRJbmZvKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBlLnBvc2l0aW9uLnogPSAoZXZlbnRJbmZvLm1heFRpbWUgKyBldmVudEluZm8ubWluVGltZSkvMiAqIGNvbnRyb2xzLnpTY2FsZTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgICAgIGUuc2V0SGVpZ2h0KChldmVudEluZm8ubWF4VGltZSAtIGV2ZW50SW5mby5taW5UaW1lKSAqIGNvbnRyb2xzLnpTY2FsZSk7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlLm5hbWUpO1xyXG4vLy8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgICAgICBlLnNjYWxlLnkgPSBjb250cm9scy56U2NhbGU7XHJcbi8vICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICB9KTtcclxuLy9cclxuLy8gICAgICAgICAgICB2YXIgbm93VGltZSA9IERhdGUubm93KCk7XHJcbi8vICAgICAgICAgICAgdmFyIG11bHRpcCA9IDAuMDA1O1xyXG4vLyAgICAgICAgICAgIGNhbWVyYS5wb3NpdGlvbi54ID0gNTAqTWF0aC5zaW4obm93VGltZSpjb250cm9scy5yb3RhdGlvblNwZWVkKm11bHRpcCk7XHJcbi8vICAgICAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnkgPSA1MCpNYXRoLmNvcyhub3dUaW1lKmNvbnRyb2xzLnJvdGF0aW9uU3BlZWQqbXVsdGlwKTtcclxuLy8gICAgICAgICAgICBjYW1lcmEucG9zaXRpb24ueiA9IGNvbnRyb2xzLmNhbWVyYVo7XHJcbi8vICAgICAgICAgICAgY2FtZXJhLmxvb2tBdChuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSk7XHJcbi8vLy8gICAgICAgICAgICBzY2VuZS50cmF2ZXJzZShmdW5jdGlvbiAoZSkge1xyXG4vLy8vICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgVEhSRUUuTWVzaCAmJiBlLm5hbWUuZW5kc1dpdGgoJzEtdG9wJykpIHtcclxuLy8vLy8vICAgICAgICAgICAgICAgICAgICBlLnBvc2l0aW9uLnkgPSBjb250cm9scy56U2NhbGU7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGUucG9zaXRpb24ueiA9IGNvbnRyb2xzLnpTY2FsZTtcclxuLy8vLyAgICAgICAgICAgICAgICB9XHJcbi8vLy8gICAgICAgICAgICB9KTtcclxuLy9cclxuLy8vLyAgICAgICAgICAgIHZhciBkZWx0YSA9IGNsb2NrLmdldERlbHRhKCk7XHJcbi8vLy8gICAgICAgICAgICBvcmJpdENvbnRyb2xzLnVwZGF0ZShkZWx0YSk7XHJcbi8vXHJcbi8vLy8gICAgICAgICAgICBjYW1lcmEucm90YXRlT25BeGlzKGNhbWVyYUluaXRQb3Mubm9ybWFsaXplKCkgLCBjb250cm9scy5jYW1lcmFSb3RYKTtcclxuLy8vLyAgICAgICAgICAgIGNhbWVyYS5yb3RhdGVPbkF4aXMoY2FtZXJhLmdldFdvcmxkRGlyZWN0aW9uKCkubm9ybWFsaXplKCkgLCBjb250cm9scy5jYW1lcmFSb3RYKTtcclxuLy8vLyAgICAgICAgICAgIGNhbWVyYS5yb3RhdGlvbi5jb3B5KG5ldyBUSFJFRS5WZWN0b3IzKGNvbnRyb2xzLmNhbWVyYVJvdFgsXHJcbi8vLy8gICAgICAgICAgICAgICAgY29udHJvbHMuY2FtZXJhUm90WSwgY29udHJvbHMuY2FtZXJhUm90WikubXVsdGlwbHlTY2FsYXIoTWF0aC5QSSkpO1xyXG4vLy8vICAgICAgICAgICAgY2FtZXJhLnJvdGF0aW9uLnggPSBjb250cm9scy5jYW1lcmFSb3RYICogTWF0aC5QSTtcclxuLy9cclxuLy8gICAgICAgICAgICAvLyByZW5kZXIgdXNpbmcgcmVxdWVzdEFuaW1hdGlvbkZyYW1lXHJcbi8vICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XHJcbi8vICAgICAgICAgICAgcmVuZGVyZXIucmVuZGVyKHNjZW5lLCBjYW1lcmEpO1xyXG4vLyAgICAgICAgfVxyXG4vL1xyXG4vLyAgICB9XHJcbi8vXHJcbi8vICAgIGZ1bmN0aW9uIHVwZGF0ZVJlbmRlcmVyU2l6ZSgpe1xyXG4vLyAgICAgICAgdmFyIHN0eWxlcyA9IGdldENvbXB1dGVkU3R5bGUoZ2V0RWwoJ3NvY2lhbE5ldHdvcmtDb250YWluZXInKSk7XHJcbi8vICAgICAgICB2YXIgd2lkdGggPSBzdHlsZXMud2lkdGguc3BsaXQoJ3B4Jykuam9pbignJykgKiAwLjc1O1xyXG4vLyAgICAgICAgdmFyIGhlaWdodCA9IHN0eWxlcy5oZWlnaHQuc3BsaXQoJ3B4Jykuam9pbignJykgKiAwLjc1O1xyXG4vLyAgICAgICAgcmVuZGVyZXIuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTtcclxuLy8gICAgICAgIHJldHVybiB7XHJcbi8vICAgICAgICAgICAgd2lkdGg6IHdpZHRoLFxyXG4vLyAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0LFxyXG4vLyAgICAgICAgfVxyXG4vLyAgICB9XHJcbi8vICAgIGZ1bmN0aW9uIG9uUmVzaXplKCkge1xyXG4vLyAgICAgICAgaWYoY2FtZXJhICYmIHJlbmRlcmVyKXtcclxuLy8gICAgICAgICAgICB2YXIgc2l6ZXMgPSB1cGRhdGVSZW5kZXJlclNpemUoKTtcclxuLy8gICAgICAgICAgICBjYW1lcmEuYXNwZWN0ID0gc2l6ZXMud2lkdGggLyBzaXplcy5oZWlnaHQ7XHJcbi8vICAgICAgICAgICAgY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcclxuLy8gICAgICAgIH1cclxuLy8gICAgfVxyXG4vL1xyXG4vLyAgICBmdW5jdGlvbiBhZGRDeWxpbmRlcih4LCB5LCB6LCBoZWlnaHQsIHJhZGl1cywgaWQpIHtcclxuLy9cclxuLy8gICAgICAgIHZhciBnZW9tZXRyeSA9IG5ldyBUSFJFRS5DeWxpbmRlckdlb21ldHJ5KCByYWRpdXMsIHJhZGl1cywgaGVpZ2h0LCAzMiApO1xyXG4vLyAgICAgICAgdmFyIG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hMYW1iZXJ0TWF0ZXJpYWwoIHtjb2xvcjogMHg3Nzc3ZmZ9ICk7XHJcbi8vICAgICAgICB2YXIgY3lsaW5kZXIgPSBuZXcgVEhSRUUuTWVzaCggZ2VvbWV0cnksIG1hdGVyaWFsICk7XHJcbi8vICAgICAgICBjeWxpbmRlci5uYW1lID0gaWQ7XHJcbi8vXHJcbi8vICAgICAgICBjeWxpbmRlci5wb3NpdGlvbi54ID0geDtcclxuLy8gICAgICAgIGN5bGluZGVyLnBvc2l0aW9uLnkgPSB5O1xyXG4vLyAgICAgICAgY3lsaW5kZXIucG9zaXRpb24ueiA9IHo7XHJcbi8vICAgICAgICBjeWxpbmRlci5yb3RhdGlvbi54ID0gLTAuNSAqIE1hdGguUEk7XHJcbi8vLy8gICAgICAgIGN5bGluZGVyLnBvc2l0aW9uLnkgPSB6O1xyXG4vLy8vICAgICAgICBjeWxpbmRlci5wb3NpdGlvbi56ID0geTtcclxuLy9cclxuLy8gICAgLy8gICAgY3lsaW5kZXIucG9zaXRpb24ueCA9IDQwO1xyXG4vL1xyXG4vLyAgICAgICAgc2NlbmUuYWRkKCBjeWxpbmRlciApO1xyXG4vL1xyXG4vLyAgICB9O1xyXG4vL1xyXG4vLyAgICBleHBvcnRzLmluaXQgPSBpbml0O1xyXG4vLyAgICBleHBvcnRzLnJlZnJlc2ggPSByZWZyZXNoO1xyXG4vLy8vICAgIHdpbmRvdy5vbmxvYWQgPSBpbml0O1xyXG4vL1xyXG4vLyAgICAvLyBsaXN0ZW4gdG8gdGhlIHJlc2l6ZSBldmVudHNcclxuLy8gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uUmVzaXplLCBmYWxzZSk7XHJcbi8vXHJcbi8vXHJcbi8vfSkodGhpc1snVGltZWxpbmVkTmV0d29yayddPXt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIGpRdWVyeSwgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IGRlZmF1bHRIaXN0cyA9IFsnc3RvcnlFdmVudHNIaXN0JywgJ3N0b3J5Q2hhcmFjdGVyc0hpc3QnLCAnZXZlbnRDb21wbGV0ZW5lc3NIaXN0JyxcclxuICAgICAgICAnY2hhcmFjdGVyU3ltYm9sc0hpc3QnLCAnY2hhcmFjdGVyU3Rvcmllc0hpc3QnXTtcclxuICAgIGNvbnN0IGVudGl0eUNoYXJ0cyA9IFsnY2hhcmFjdGVyQ2hhcnQnLCAncGxheWVyQ2hhcnQnLCAnc3RvcnlDaGFydCcsICdncm91cENoYXJ0J107XHJcblxyXG4gICAgY29uc3Qgc3RhdGlzdGljS2V5cyA9IFtcclxuICAgICAgICAnY2hhcmFjdGVyTnVtYmVyJyxcclxuICAgICAgICAncGxheWVyTnVtYmVyJyxcclxuICAgICAgICAnc3RvcnlOdW1iZXInLFxyXG4gICAgICAgICdncm91cE51bWJlcicsXHJcbiAgICAgICAgJ2V2ZW50c051bWJlcicsXHJcbiAgICAgICAgJ3VzZXJOdW1iZXInLFxyXG4gICAgICAgICd0ZXh0Q2hhcmFjdGVyTnVtYmVyJyxcclxuICAgICAgICAnbGFzdEV2ZW50JyxcclxuICAgICAgICAnZmlyc3RFdmVudCcsXHJcbiAgICBdO1xyXG5cclxuICAgIGNvbnN0IHJvb3QgPSAnLm92ZXJ2aWV3LXRhYiAnO1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBzdGF0ZS5DaGFydHMgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUubmFtZSA9IGdldEVsKCdnYW1lTmFtZUlucHV0Jyk7XHJcbiAgICAgICAgc3RhdGUubmFtZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB1cGRhdGVOYW1lKTtcclxuXHJcbiAgICAgICAgc3RhdGUubGFzdFNhdmVUaW1lID0gZ2V0RWwoJ2xhc3RTYXZlVGltZScpO1xyXG5cclxuICAgICAgICBzdGF0ZS5kYXRlID0gZ2V0RWwoJ2dhbWVEYXRlUGlja2VyJyk7XHJcblxyXG4gICAgICAgIGxldCBvcHRzID0ge1xyXG4gICAgICAgICAgICBsYW5nOiBMMTBuLmdldExhbmcoKSxcclxuICAgICAgICAgICAgbWFzazogdHJ1ZSxcclxuICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZTogdXBkYXRlVGltZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGpRdWVyeShzdGF0ZS5kYXRlKS5kYXRldGltZXBpY2tlcihvcHRzKTtcclxuXHJcbiAgICAgICAgc3RhdGUucHJlRGF0ZSA9IGdldEVsKCdwcmVHYW1lRGF0ZVBpY2tlcicpO1xyXG5cclxuICAgICAgICBvcHRzID0ge1xyXG4gICAgICAgICAgICBsYW5nOiBMMTBuLmdldExhbmcoKSxcclxuICAgICAgICAgICAgbWFzazogdHJ1ZSxcclxuICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZTogdXBkYXRlUHJlR2FtZURhdGVcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBqUXVlcnkoc3RhdGUucHJlRGF0ZSkuZGF0ZXRpbWVwaWNrZXIob3B0cyk7XHJcblxyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKCgpID0+IHtcclxuICAgICAgICAgICAgalF1ZXJ5KHN0YXRlLmRhdGUpLmRhdGV0aW1lcGlja2VyKHtcclxuICAgICAgICAgICAgICAgIGxhbmc6IEwxMG4uZ2V0TGFuZygpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBqUXVlcnkoc3RhdGUucHJlRGF0ZSkuZGF0ZXRpbWVwaWNrZXIoe1xyXG4gICAgICAgICAgICAgICAgbGFuZzogTDEwbi5nZXRMYW5nKClcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmRlc2NyID0gcXVlcnlFbChgJHtyb290fS5nYW1lLWRlc2NyaXB0aW9uLWFyZWFgKTtcclxuICAgICAgICBzdGF0ZS5kZXNjci5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB1cGRhdGVEZXNjcik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgZ2VhcnNDb250YWluZXIgPSBxZWUocXVlcnlFbChyb290KSwgJyNnZWFycycpO1xyXG4gICAgICAgIGFkZEVsKGdlYXJzQ29udGFpbmVyLCBxZSgnLmdlYXJzLXRhYicpKTtcclxuICAgICAgICBHZWFycy5pbml0KCk7XHJcbiAgICAgICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zKSB7XHJcbiAgICAgICAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG11dGF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gXCJjbGFzc1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaGFzQ2xhc3MoZ2VhcnNDb250YWluZXIsICdhY3RpdmUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBHZWFycy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBvYnNlcnZlci5vYnNlcnZlKGdlYXJzQ29udGFpbmVyLCB7XHJcbiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBzbGlkZXJzQ29udGFpbmVyID0gcWVlKHF1ZXJ5RWwocm9vdCksICcjc2xpZGVycycpO1xyXG4gICAgICAgIGFkZEVsKHNsaWRlcnNDb250YWluZXIsIHFlKCcuc2xpZGVycy10YWInKSk7XHJcbiAgICAgICAgU2xpZGVycy5pbml0KCk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgR2VhcnMucmVmcmVzaCgpO1xyXG4gICAgICAgIFNsaWRlcnMucmVmcmVzaCgpO1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKChlcnIsIGlzQWRtaW4pID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2FkbWluT25seScsIGlzQWRtaW4pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIFByb21pc2UuYWxsKCBbREJNUy5nZXRNZXRhSW5mb1BtKCksIERCTVMuZ2V0U3RhdGlzdGljc1BtKCldICkudGhlbih1cGRhdGVPdmVydmlld1RhYikuY2F0Y2goVXRpbHMuaGFuZGxlRXJyb3IpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ2hhcnQoaWQsIGNhbnZhcywgZGF0YSkge1xyXG4gICAgICAgIGlmIChzdGF0ZS5DaGFydHNbaWRdKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLkNoYXJ0c1tpZF0uZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbGFiZWxzID0gW107XHJcbiAgICAgICAgY29uc3QgZGF0YXNldCA9IHtcclxuICAgICAgICAgICAgZGF0YTogW10sXHJcbiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogW10sXHJcbiAgICAgICAgICAgIGhvdmVyQmFja2dyb3VuZENvbG9yOiBbXVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGF0YS5mb3JFYWNoKChpdGVtLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChDb25zdGFudHMuY29sb3JQYWxldHRlW2ldKSB7XHJcbiAgICAgICAgICAgICAgICBsYWJlbHMucHVzaChpdGVtLmxhYmVsKTtcclxuICAgICAgICAgICAgICAgIGRhdGFzZXQuZGF0YS5wdXNoKGl0ZW0udmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgZGF0YXNldC5iYWNrZ3JvdW5kQ29sb3IucHVzaChDb25zdGFudHMuY29sb3JQYWxldHRlW2ldLmNvbG9yLmJhY2tncm91bmQpO1xyXG4gICAgICAgICAgICAgICAgZGF0YXNldC5ob3ZlckJhY2tncm91bmRDb2xvci5wdXNoKENvbnN0YW50cy5jb2xvclBhbGV0dGVbaV0uY29sb3IuaG92ZXIuYmFja2dyb3VuZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgICAgICAgc3RhdGUuQ2hhcnRzW2lkXSA9IG5ldyBDaGFydChjdHgsIHtcclxuICAgICAgICAgICAgdHlwZTogJ2RvdWdobnV0JyxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgbGFiZWxzLFxyXG4gICAgICAgICAgICAgICAgZGF0YXNldHM6IFtkYXRhc2V0XVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvcHRpb25zOiB7XHJcbiAgICAgICAgICAgICAgICBhbmltYXRpb246IHtcclxuICAgICAgICAgICAgICAgICAgICBhbmltYXRlUm90YXRlOiBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNpdmU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgbGVnZW5kOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgdG9vbHRpcHM6IHtcclxuICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b206IGN1c3RvbVRvb2x0aXBzXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUhpc3RvZ3JhbShwbGFjZSwgZGF0YSkge1xyXG4gICAgICAgIGxldCBtYXggPSBudWxsO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCgoYmFyRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoYmFyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG1heCA9PT0gbnVsbCB8fCBiYXJEYXRhLnZhbHVlID4gbWF4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWF4ID0gYmFyRGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCgoYmFyRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoYmFyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgLy8gYmFyRGF0YS5ub3JtVmFsdWUgPSAoYmFyRGF0YS52YWx1ZSAtIG1pbikvKG1heC1taW4pO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICBiYXJEYXRhLm5vcm1WYWx1ZSA9IChiYXJEYXRhLnZhbHVlIC0gMCkvKG1heC0wKTtcclxuICAgICAgICAgICAgICAgIGJhckRhdGEubm9ybVZhbHVlID0gKCgoYmFyRGF0YS52YWx1ZSAtIDApIC8gKG1heCAtIDApKSAqIDAuOSkgKyAwLjE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IGRpdjtcclxuICAgICAgICBkYXRhLmZvckVhY2goKGJhckRhdGEpID0+IHtcclxuICAgICAgICAgICAgZGl2ID0gYmFyRGF0YSA9PT0gbnVsbCA/IG1ha2VFbCgnZGl2JykgOiBhZGRFbChtYWtlRWwoJ2RpdicpLCBtYWtlVGV4dChiYXJEYXRhLnZhbHVlKSk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGRpdiwgJ2JhcicpO1xyXG4gICAgICAgICAgICBpZiAoYmFyRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgZGl2LnN0eWxlLmhlaWdodCA9IGAke2JhckRhdGEubm9ybVZhbHVlICogMTAwfSVgO1xyXG4gICAgICAgICAgICAgICAgJChkaXYpLnRvb2x0aXAoe1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBiYXJEYXRhLnRpcCxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBhZGRFbChwbGFjZSwgZGl2KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVPdmVydmlld1RhYihyZXN1bHRzKSB7XHJcbiAgICAgICAgY29uc3QgW21ldGFJbmZvLCBzdGF0aXN0aWNzXSA9IHJlc3VsdHM7XHJcbiAgICAgICAgc3RhdGUubmFtZS52YWx1ZSA9IG1ldGFJbmZvLm5hbWU7XHJcbiAgICAgICAgc3RhdGUuZGF0ZS52YWx1ZSA9IG1ldGFJbmZvLmRhdGU7XHJcbiAgICAgICAgc3RhdGUucHJlRGF0ZS52YWx1ZSA9IG1ldGFJbmZvLnByZUdhbWVEYXRlO1xyXG4gICAgICAgIHN0YXRlLmRlc2NyLnZhbHVlID0gbWV0YUluZm8uZGVzY3JpcHRpb247XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChzdGF0ZS5sYXN0U2F2ZVRpbWUpLCBtYWtlVGV4dChuZXcgRGF0ZShtZXRhSW5mby5zYXZlVGltZSkuZm9ybWF0KCd5eXl5L21tL2RkIEhIOk1NOnNzJykpKTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0aXN0aWNzLmxhc3RFdmVudCA9IHN0YXRpc3RpY3MubGFzdEV2ZW50ICE9PSAnJyA/IG5ldyBEYXRlKHN0YXRpc3RpY3MubGFzdEV2ZW50KS5mb3JtYXQoJ3l5eXkvbW0vZGQgaDpNTScpIDogJyc7XHJcbiAgICAgICAgc3RhdGlzdGljcy5maXJzdEV2ZW50ID0gc3RhdGlzdGljcy5maXJzdEV2ZW50ICE9PSAnJyA/IG5ldyBEYXRlKHN0YXRpc3RpY3MuZmlyc3RFdmVudCkuZm9ybWF0KCd5eXl5L21tL2RkIGg6TU0nKSA6ICcnO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRpc3RpY0tleXMuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgIHVwZGF0ZVN0YXRpc3RpY1ZhbHVlKHN0YXRpc3RpY3MsIGtleSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChnZXRFbCgnZ2VuZXJhbENvbXBsZXRlbmVzcycpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ292ZXJ2aWV3LWdlbmVyYWwtY29tcGxldGVuZXNzLXZhbHVlJyksIHN0YXRpc3RpY3MuZ2VuZXJhbENvbXBsZXRlbmVzcykpKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKGdldEVsKCdzdG9yeUNvbXBsZXRlbmVzcycpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ292ZXJ2aWV3LXN0b3J5LWNvbXBsZXRlbmVzcy12YWx1ZScpLCBzdGF0aXN0aWNzLnN0b3J5Q29tcGxldGVuZXNzKSkpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwoZ2V0RWwoJ3JlbGF0aW9uQ29tcGxldGVuZXNzJykpLCBtYWtlVGV4dChzdHJGb3JtYXQoZ2V0TDEwbignb3ZlcnZpZXctcmVsYXRpb24tY29tcGxldGVuZXNzLXZhbHVlJyksIHN0YXRpc3RpY3MucmVsYXRpb25Db21wbGV0ZW5lc3MpKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZGVmYXVsdEhpc3RzLmZvckVhY2goKGhpc3ROYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIG1ha2VIaXN0b2dyYW0oY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LiR7aGlzdE5hbWV9YCkpLCBzdGF0aXN0aWNzW2hpc3ROYW1lXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZW50aXR5Q2hhcnRzLmZvckVhY2goKGVudGl0eUNoYXJ0KSA9PiB7XHJcbiAgICAgICAgICAgIG1ha2VDaGFydChlbnRpdHlDaGFydCwgcXVlcnlFbChgJHtyb290fS4ke2VudGl0eUNoYXJ0fWApLCBzdGF0aXN0aWNzW2VudGl0eUNoYXJ0XSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3Qgc3ltYm9sQ2hhcnREYXRhID0gUi50b1BhaXJzKGxvY2FsaXplQ29uc3RzKHN0YXRpc3RpY3MudGV4dENoYXJhY3RlcnNDb3VudCkpLm1hcChwYWlyID0+ICh7XHJcbiAgICAgICAgICAgIHZhbHVlOiBwYWlyWzFdLFxyXG4gICAgICAgICAgICBsYWJlbDogbWFrZUNoYXJ0TGFiZWwoc3RhdGlzdGljcy50ZXh0Q2hhcmFjdGVyTnVtYmVyLCBwYWlyWzBdLCBwYWlyWzFdKVxyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBtYWtlQ2hhcnQoJ3N5bWJvbENoYXJ0JywgcXVlcnlFbChgJHtyb290fS5zeW1ib2xDaGFydGApLCBzeW1ib2xDaGFydERhdGEpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdDaGFydERhdGEgPSBSLnRvUGFpcnMobG9jYWxpemVDb25zdHMoc3RhdGlzdGljcy5iaW5kaW5nU3RhdHMpKS5tYXAocGFpciA9PiAoe1xyXG4gICAgICAgICAgICB2YWx1ZTogcGFpclsxXSxcclxuICAgICAgICAgICAgbGFiZWw6IFtwYWlyWzBdLCAnOiAnLCBwYWlyWzFdXS5qb2luKCcnKVxyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBtYWtlQ2hhcnQoJ2JpbmRpbmdDaGFydCcsIHF1ZXJ5RWwoYCR7cm9vdH0uYmluZGluZ0NoYXJ0YCksIGJpbmRpbmdDaGFydERhdGEpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBiYXJEYXRhLCBiYXJEaXYsIGJhcjtcclxuICAgICAgICBcclxuICAgICAgICBmdW5jdGlvbiBtYWtlQ29udGFpbmVyKG9iaikge1xyXG4gICAgICAgICAgICBiYXJEaXYgPSBtYWtlRWwoJ2RpdicpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhiYXJEaXYsICdjb2wteHMtMycpO1xyXG4gICAgICAgICAgICBhZGRFbChiYXJEaXYsIGFkZEVsKG1ha2VFbCgnaDQnKSwgbWFrZVRleHQob2JqLm5hbWUpKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKGJhckRpdiwgb2JqLmJhcik7XHJcbiAgICAgICAgICAgIHJldHVybiBiYXJEaXY7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkQ2hhcnQoaW5mbykge1xyXG4gICAgICAgICAgICBiYXIgPSBzZXRBdHRyKHNldEF0dHIobWFrZUVsKCdjYW52YXMnKSwgJ3dpZHRoJywgJzMwMCcpLCAnaGVpZ2h0JywgJzEwMCcpO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gUi56aXBPYmooWyduYW1lJywgJ2JhciddLCBbaW5mby5uYW1lLCBiYXJdKTtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gbWFrZUNvbnRhaW5lcihkYXRhKTtcclxuICAgICAgICAgICAgbWFrZUNoYXJ0KGluZm8uaWQsIGJhciwgaW5mby5wcmVwYXJlZCk7XHJcbiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkSGlzdChpbmZvKSB7XHJcbiAgICAgICAgICAgIGJhciA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdvdmVydmlld0hpc3QnKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YSA9IFIuemlwT2JqKFsnbmFtZScsICdiYXInXSwgW2luZm8ubmFtZSwgYmFyXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG1ha2VDb250YWluZXIoZGF0YSk7XHJcbiAgICAgICAgICAgIG1ha2VIaXN0b2dyYW0oYmFyLCBpbmZvLnByZXBhcmVkKTtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgaW5uZXJNYWtlQ2hhcnQgPSBSLmNvbXBvc2UoYnVpbGRDaGFydCwgcHJlcGFyZUNoYXJ0KTtcclxuICAgICAgICBjb25zdCBpbm5lck1ha2VIaXN0ID0gUi5jb21wb3NlKGJ1aWxkSGlzdCwgcHJlcGFyZUhpc3QpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGZ1bmN0aW9uIGxvY2FsaXplQ2hlY2tib3hlcyhpbmZvKSB7XHJcbiAgICAgICAgICAgIGluZm8uZGF0YSA9IFIuZnJvbVBhaXJzKFIudG9QYWlycyhpbmZvLmRhdGEpLm1hcCgodmFsKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YWxbMF0gPSBjb25zdEwxMG4oQ29uc3RhbnRzW3ZhbFswXV0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gaW5mbztcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgbWFrZUNoZWNrYm94Q2hhcnQgPSBSLmNvbXBvc2UoaW5uZXJNYWtlQ2hhcnQsIGxvY2FsaXplQ2hlY2tib3hlcyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgZm4gPSBSLmNvbmQoW1xyXG4gICAgICAgICAgICBbUi5jb21wb3NlKFIuZXF1YWxzKCdlbnVtJyksIFIucHJvcCgndHlwZScpKSwgaW5uZXJNYWtlQ2hhcnRdLFxyXG4gICAgICAgICAgICBbUi5jb21wb3NlKFIuZXF1YWxzKCdjaGVja2JveCcpLCBSLnByb3AoJ3R5cGUnKSksIG1ha2VDaGVja2JveENoYXJ0XSxcclxuICAgICAgICAgICAgW1IuVCwgaW5uZXJNYWtlSGlzdF0sXHJcbiAgICAgICAgICAgIF0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQuY2hhcmFjdGVyYCksIHN0YXRpc3RpY3MucHJvZmlsZUNoYXJ0cy5jaGFyYWN0ZXJDaGFydHMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICBzdGF0aXN0aWNzLnByb2ZpbGVDaGFydHMuY2hhcmFjdGVyQ2hhcnRzLm1hcChmbilcclxuICAgICAgICAgICAgLm1hcChhZGRFbChjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhcmFjdGVyUHJvZmlsZURpYWdyYW1zYCkpKSk7XHJcbiAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IC5hbGVydC5wbGF5ZXJgKSwgc3RhdGlzdGljcy5wcm9maWxlQ2hhcnRzLnBsYXllckNoYXJ0cy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgIHN0YXRpc3RpY3MucHJvZmlsZUNoYXJ0cy5wbGF5ZXJDaGFydHMubWFwKGZuKVxyXG4gICAgICAgICAgICAubWFwKGFkZEVsKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5wbGF5ZXJQcm9maWxlRGlhZ3JhbXNgKSkpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gbG9jYWxpemVDb25zdHMoaW5mbykge1xyXG4gICAgICAgIGluZm8gPSBSLmZyb21QYWlycyhSLnRvUGFpcnMoaW5mbykubWFwKCh2YWwpID0+IHtcclxuICAgICAgICAgICAgdmFsWzBdID0gY29uc3RMMTBuKHZhbFswXSk7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHJldHVybiBpbmZvO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHByZXBhcmVDaGFydChpbmZvKSB7XHJcbiAgICAgICAgY29uc3QgdG90YWwgPSBSLnN1bShSLnZhbHVlcyhpbmZvLmRhdGEpKTtcclxuICAgICAgICBpbmZvLnByZXBhcmVkID0gUi5rZXlzKGluZm8uZGF0YSkubWFwKGtleSA9PiBSLnppcE9iaihbJ3ZhbHVlJywgJ2xhYmVsJ10sIFtpbmZvLmRhdGFba2V5XSwgbWFrZUNoYXJ0TGFiZWwodG90YWwsIGtleSwgaW5mby5kYXRhW2tleV0pXSkpO1xyXG4gICAgICAgIHJldHVybiBpbmZvO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHByZXBhcmVIaXN0KGluZm8pIHtcclxuICAgICAgICBpbmZvLnByZXBhcmVkID0gW107XHJcbiAgICAgICAgY29uc3QgeyBzdGVwIH0gPSBpbmZvLmRhdGE7XHJcbiAgICAgICAgaW5mby5kYXRhID0gaW5mby5kYXRhLmdyb3VwcztcclxuICAgICAgICBjb25zdCBtaW4gPSBSLmFwcGx5KE1hdGgubWluLCBSLmtleXMoaW5mby5kYXRhKSk7XHJcbiAgICAgICAgY29uc3QgbWF4ID0gUi5hcHBseShNYXRoLm1heCwgUi5rZXlzKGluZm8uZGF0YSkpO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gbWluOyBpIDwgbWF4ICsgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmZvLmRhdGFbaV0pIHtcclxuICAgICAgICAgICAgICAgIGluZm8ucHJlcGFyZWQucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGluZm8uZGF0YVtpXSxcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogYCR7aSAqIHN0ZXB9LSR7KGkgKiBzdGVwKSArIChzdGVwIC0gMSl9YCxcclxuICAgICAgICAgICAgICAgICAgICB0aXA6IGAke2kgKiBzdGVwfS0keyhpICogc3RlcCkgKyAoc3RlcCAtIDEpfWBcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaW5mby5wcmVwYXJlZC5wdXNoKG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBpbmZvO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBtYWtlQ2hhcnRMYWJlbCA9IFIuY3VycnkoKHRvdGFsLCBrZXksIHZhbHVlKSA9PlxyXG4gICAgICAgIFtrZXksICc6ICcsICgodmFsdWUgLyB0b3RhbCkgKiAxMDApLnRvRml4ZWQoMCksICclICgnLCB2YWx1ZSwgJy8nLCB0b3RhbCwgJyknXS5qb2luKCcnKSk7XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlU3RhdGlzdGljVmFsdWUoc3RhdGlzdGljcywga2V5KSB7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChnZXRFbChrZXkpKSwgbWFrZVRleHQoc3RhdGlzdGljc1trZXldKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlTmFtZShldmVudCkge1xyXG4gICAgICAgIERCTVMuc2V0TWV0YUluZm9TdHJpbmdQbSgnbmFtZScsIGV2ZW50LnRhcmdldC52YWx1ZSkuY2F0Y2goVXRpbHMuaGFuZGxlRXJyb3IpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gdXBkYXRlVGltZShkcCwgaW5wdXQpIHtcclxuICAgICAgICBEQk1TLnNldE1ldGFJbmZvRGF0ZSgnZGF0ZScsIGlucHV0LnZhbCgpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiB1cGRhdGVQcmVHYW1lRGF0ZShkcCwgaW5wdXQpIHtcclxuICAgICAgICBEQk1TLnNldE1ldGFJbmZvRGF0ZSgncHJlR2FtZURhdGUnLCBpbnB1dC52YWwoKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gdXBkYXRlRGVzY3IoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLnNldE1ldGFJbmZvU3RyaW5nKCdkZXNjcmlwdGlvbicsIGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGN1c3RvbVRvb2x0aXBzKHRvb2x0aXApIHtcclxuICAgICAgICAvLyBUb29sdGlwIEVsZW1lbnRcclxuICAgICAgICBsZXQgdG9vbHRpcEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NoYXJ0anMtdG9vbHRpcCcpO1xyXG5cclxuICAgICAgICBpZiAoIXRvb2x0aXBFbCkge1xyXG4gICAgICAgICAgICB0b29sdGlwRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgdG9vbHRpcEVsLmlkID0gJ2NoYXJ0anMtdG9vbHRpcCc7XHJcbiAgICAgICAgICAgIHRvb2x0aXBFbC5pbm5lckhUTUwgPSAnPHRhYmxlPjwvdGFibGU+JztcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0b29sdGlwRWwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSGlkZSBpZiBubyB0b29sdGlwXHJcbiAgICAgICAgaWYgKHRvb2x0aXAub3BhY2l0eSA9PT0gMCkge1xyXG4gICAgICAgICAgICB0b29sdGlwRWwuc3R5bGUub3BhY2l0eSA9IDA7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFNldCBjYXJldCBQb3NpdGlvblxyXG4gICAgICAgIHRvb2x0aXBFbC5jbGFzc0xpc3QucmVtb3ZlKCdhYm92ZScsICdiZWxvdycsICduby10cmFuc2Zvcm0nKTtcclxuICAgICAgICBpZiAodG9vbHRpcC55QWxpZ24pIHtcclxuICAgICAgICAgICAgdG9vbHRpcEVsLmNsYXNzTGlzdC5hZGQodG9vbHRpcC55QWxpZ24pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRvb2x0aXBFbC5jbGFzc0xpc3QuYWRkKCduby10cmFuc2Zvcm0nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGdldEJvZHkoYm9keUl0ZW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuIGJvZHlJdGVtLmxpbmVzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gU2V0IFRleHRcclxuICAgICAgICBpZiAodG9vbHRpcC5ib2R5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlTGluZXMgPSB0b29sdGlwLnRpdGxlIHx8IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBib2R5TGluZXMgPSB0b29sdGlwLmJvZHkubWFwKGdldEJvZHkpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGlubmVySHRtbCA9ICc8dGhlYWQ+JztcclxuXHJcbiAgICAgICAgICAgIHRpdGxlTGluZXMuZm9yRWFjaCgodGl0bGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlubmVySHRtbCArPSBgPHRyPjx0aD4ke3RpdGxlfTwvdGg+PC90cj5gO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaW5uZXJIdG1sICs9ICc8L3RoZWFkPjx0Ym9keT4nO1xyXG5cclxuICAgICAgICAgICAgYm9keUxpbmVzLmZvckVhY2goKGJvZHksIGkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9ycyA9IHRvb2x0aXAubGFiZWxDb2xvcnNbaV07XHJcbiAgICAgICAgICAgICAgICBsZXQgc3R5bGUgPSBgYmFja2dyb3VuZDoke2NvbG9ycy5iYWNrZ3JvdW5kQ29sb3J9YDtcclxuICAgICAgICAgICAgICAgIHN0eWxlICs9IGA7IGJvcmRlci1jb2xvcjoke2NvbG9ycy5ib3JkZXJDb2xvcn1gO1xyXG4gICAgICAgICAgICAgICAgc3R5bGUgKz0gJzsgYm9yZGVyLXdpZHRoOiAycHgnO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGA8c3BhbiBjbGFzcz1cImNoYXJ0anMtdG9vbHRpcC1rZXlcIiBzdHlsZT1cIiR7c3R5bGV9XCI+PC9zcGFuPmA7XHJcbiAgICAgICAgICAgICAgICBpbm5lckh0bWwgKz0gYDx0cj48dGQ+JHtzcGFufSR7Ym9keX08L3RkPjwvdHI+YDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlubmVySHRtbCArPSAnPC90Ym9keT4nO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdGFibGVSb290ID0gdG9vbHRpcEVsLnF1ZXJ5U2VsZWN0b3IoJ3RhYmxlJyk7XHJcbiAgICAgICAgICAgIHRhYmxlUm9vdC5pbm5lckhUTUwgPSBpbm5lckh0bWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMuX2NoYXJ0LmNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuXHJcbiAgICAgICAgLy8gICAgICAgIC8vIERpc3BsYXksIHBvc2l0aW9uLCBhbmQgc2V0IHN0eWxlcyBmb3IgZm9udFxyXG4gICAgICAgIHRvb2x0aXBFbC5zdHlsZS5vcGFjaXR5ID0gMTtcclxuICAgICAgICB0b29sdGlwRWwuc3R5bGUubGVmdCA9IGAke3Bvc2l0aW9uLmxlZnQgKyB0b29sdGlwLmNhcmV0WH1weGA7XHJcbiAgICAgICAgdG9vbHRpcEVsLnN0eWxlLnRvcCA9IGAke3Bvc2l0aW9uLnRvcCArIHRvb2x0aXAuY2FyZXRZfXB4YDtcclxuICAgICAgICAvLyAgICAgICAgdG9vbHRpcEVsLnN0eWxlLmZvbnRGYW1pbHkgPSB0b29sdGlwLl9mb250RmFtaWx5O1xyXG4gICAgICAgIC8vICAgICAgICB0b29sdGlwRWwuc3R5bGUuZm9udFNpemUgPSB0b29sdGlwLmZvbnRTaXplO1xyXG4gICAgICAgIC8vICAgICAgICB0b29sdGlwRWwuc3R5bGUuZm9udFN0eWxlID0gdG9vbHRpcC5fZm9udFN0eWxlO1xyXG4gICAgICAgIHRvb2x0aXBFbC5zdHlsZS5wYWRkaW5nID0gYCR7dG9vbHRpcC55UGFkZGluZ31weCAke3Rvb2x0aXAueFBhZGRpbmd9cHhgO1xyXG4gICAgfVxyXG59KSh0aGlzLk92ZXJ2aWV3ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5wcm9maWxlLWJpbmRpbmctdGFiICc7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LmNyZWF0ZS1iaW5kaW5nLWJ1dHRvbmApLCAnY2xpY2snLCBjcmVhdGVCaW5kaW5nKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS5yZW1vdmUtYmluZGluZy1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlQmluZGluZyk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVyciwgY2hhcmFjdGVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3BsYXllcicsIGZhbHNlLCAoZXJyMiwgcGxheWVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZUJpbmRpbmdzKChlcnIzLCBwcm9maWxlQmluZGluZ3MpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvbmRlZENoYXJhY3Rlckxpc3QgPSBSLmtleXMocHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBib25kZWRQbGF5ZXJMaXN0ID0gUi52YWx1ZXMocHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXIgPSBsaXN0ID0+IFIuY29tcG9zZShSLm5vdCwgUi5jb250YWlucyhSLl9fLCBsaXN0KSwgUi5wcm9wKCd2YWx1ZScpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uY2hhcmFjdGVyLXNlbGVjdG9yYCkpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJOYW1lcy5maWx0ZXIoZmlsdGVyKGJvbmRlZENoYXJhY3Rlckxpc3QpKS5tYXAocmVtYXBQcm9wczRTZWxlY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBmaWxsU2VsZWN0b3IoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5wbGF5ZXItc2VsZWN0b3JgKSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllck5hbWVzLmZpbHRlcihmaWx0ZXIoYm9uZGVkUGxheWVyTGlzdCkpLm1hcChyZW1hcFByb3BzNFNlbGVjdClcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdzID0gUi50b1BhaXJzKHByb2ZpbGVCaW5kaW5ncykubWFwKGJpbmRpbmcgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogUi5qb2luKCcvJywgYmluZGluZyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeShiaW5kaW5nKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ25hbWUnKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uYmluZGluZy1zZWxlY3RvcmApKSwgYmluZGluZ3MpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nKCkge1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LmNoYXJhY3Rlci1zZWxlY3RvcmApLnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IHBsYXllck5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnBsYXllci1zZWxlY3RvcmApLnZhbHVlO1xyXG5cclxuICAgICAgICBpZiAoY2hhcmFjdGVyTmFtZSA9PT0gJycgfHwgcGxheWVyTmFtZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignYmluZGluZy1jaGFyYWN0ZXItb3ItcGxheWVyLW5vdC1zZWxlY3RlZCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgREJNUy5jcmVhdGVCaW5kaW5nKGNoYXJhY3Rlck5hbWUsIHBsYXllck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVCaW5kaW5nKCkge1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdWYWwgPSBxdWVyeUVsKGAke3Jvb3R9LmJpbmRpbmctc2VsZWN0b3JgKS52YWx1ZTtcclxuXHJcbiAgICAgICAgaWYgKGJpbmRpbmdWYWwgPT09ICcnKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2JpbmRpbmctYmluZGluZy1pcy1ub3Qtc2VsZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYmluZGluZyA9IEpTT04ucGFyc2UoYmluZGluZ1ZhbCk7XHJcblxyXG4gICAgICAgIERCTVMucmVtb3ZlQmluZGluZyhiaW5kaW5nWzBdLCBiaW5kaW5nWzFdLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuUHJvZmlsZUJpbmRpbmcgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5cclxuLy8gQ2hhcmFjdGVyIHByb2ZpbGUgYWxyZWFkeSBoYSBmaWVsZCAnbmFtZSdcclxuLy8gSSBoYWQgc29tZSBjaG9pY2VzOlxyXG4vLyAxLiByZW1vdmUgdGhpcyBmaWVsZCBhdCBhbGxcclxuLy8gMi4gQWRkIG9uZSBtb3JlIG9iamVjdCB0byBkaXZpZGUgc3BlY2lhbCB2YWx1ZXMgKG5hbWUpIGFuZCB1c2VyIGRlZmluZWQgdmFsdWVzXHJcbi8vIDMuIFByb2hpYml0IHRvIG1ha2UgZmllbGQgLSBuYW1lXHJcbi8vIDEuIFRoaXMgZmllbGQgaXMgdXNlZCBpbiBtYW55IHBsYWNlc1xyXG4vLyAyLiAtIHRvbyBjb21wbGV4IHdheVxyXG4vLyAzLiBzaW1wbGUgYW5kIGxlc3NlciBjb21wbGV4aXR5LCBJIGNob29zZSB0aGlzIHdheVxyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCB0YWJSb290ID0gJy5wcm9maWxlLWNvbmZpZ3VyZXItdGFiICc7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJQYW5lbCA9IGAke3RhYlJvb3R9LmNoYXJhY3Rlci1wcm9maWxlLXBhbmVsIGA7XHJcbiAgICBjb25zdCBwbGF5ZXJQYW5lbCA9IGAke3RhYlJvb3R9LnBsYXllci1wcm9maWxlLXBhbmVsIGA7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNlbCA9IGNsZWFyRWwocXVlcnlFbChgJHtjaGFyYWN0ZXJQYW5lbH0uY3JlYXRlLWVudGl0eS10eXBlLXNlbGVjdGApKTtcclxuICAgICAgICBjb25zdCBmaWxsTWFpblNlbCA9ICgpID0+IHsgZmlsbEl0ZW1UeXBlc1NlbChjbGVhckVsKHNlbCkpOyB9O1xyXG4gICAgICAgIGZpbGxNYWluU2VsKCk7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZmlsbE1haW5TZWwpO1xyXG4gICAgICAgIGNvbnN0IHNlbDIgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cGxheWVyUGFuZWx9LmNyZWF0ZS1lbnRpdHktdHlwZS1zZWxlY3RgKSk7XHJcbiAgICAgICAgY29uc3QgZmlsbE1haW5TZWwyID0gKCkgPT4geyBmaWxsSXRlbVR5cGVzU2VsKGNsZWFyRWwoc2VsMikpOyB9O1xyXG4gICAgICAgIGZpbGxNYWluU2VsMigpO1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKGZpbGxNYWluU2VsMik7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke2NoYXJhY3RlclBhbmVsfS5jcmVhdGUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBjcmVhdGVQcm9maWxlSXRlbSgnY2hhcmFjdGVyJywgY2hhcmFjdGVyUGFuZWwpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtjaGFyYWN0ZXJQYW5lbH0ubW92ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIG1vdmVQcm9maWxlSXRlbSgnY2hhcmFjdGVyJywgY2hhcmFjdGVyUGFuZWwpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtjaGFyYWN0ZXJQYW5lbH0ucmVtb3ZlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlUHJvZmlsZUl0ZW0oJ2NoYXJhY3RlcicsIGNoYXJhY3RlclBhbmVsKSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3BsYXllclBhbmVsfS5jcmVhdGUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBjcmVhdGVQcm9maWxlSXRlbSgncGxheWVyJywgcGxheWVyUGFuZWwpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtwbGF5ZXJQYW5lbH0ubW92ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIG1vdmVQcm9maWxlSXRlbSgncGxheWVyJywgcGxheWVyUGFuZWwpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtwbGF5ZXJQYW5lbH0ucmVtb3ZlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgcmVtb3ZlUHJvZmlsZUl0ZW0oJ3BsYXllcicsIHBsYXllclBhbmVsKSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwodGFiUm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICByZWZyZXNoUGFuZWwoJ2NoYXJhY3RlcicsIGNoYXJhY3RlclBhbmVsKTtcclxuICAgICAgICByZWZyZXNoUGFuZWwoJ3BsYXllcicsIHBsYXllclBhbmVsKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVmcmVzaFBhbmVsKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICBEQk1TLmdldFByb2ZpbGVTdHJ1Y3R1cmUodHlwZSwgKGVyciwgYWxsUHJvZmlsZVNldHRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBhcnIgPSBhbGxQcm9maWxlU2V0dGluZ3MubWFwKFIuY29tcG9zZShzdHJGb3JtYXQoZ2V0TDEwbignY29tbW9uLXNldC1pdGVtLWJlZm9yZScpKSwgUi5hcHBlbmQoUi5fXywgW10pLCBSLnByb3AoJ25hbWUnKSkpO1xyXG4gICAgICAgICAgICBhcnIucHVzaChnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYXMtbGFzdCcpKTtcclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb25TZWxlY3RvcnMgPSBbcXVlcnlFbChgJHtyb290fS5jcmVhdGUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdGApLFxyXG4gICAgICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fS5tb3ZlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3RgKV07XHJcbiAgICAgICAgICAgIHBvc2l0aW9uU2VsZWN0b3JzLm1hcChjbGVhckVsKS5tYXAoZmlsbFNlbGVjdG9yKFIuX18sIGFycjJTZWxlY3QoYXJyKSkpLm1hcChzZXRQcm9wKFIuX18sICdzZWxlY3RlZEluZGV4JywgYWxsUHJvZmlsZVNldHRpbmdzLmxlbmd0aCkpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucHJvZmlsZS1jb25maWctY29udGFpbmVyYCkpO1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGFkZEVscyh0YWJsZSwgYWxsUHJvZmlsZVNldHRpbmdzLm1hcChnZXRJbnB1dCh0eXBlKSkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIxKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihlcnIxKTsgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNBZG1pbigoZXJyMiwgaXNBZG1pbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2FkbWluT25seScsIGlzQWRtaW4pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdG9yQXJyID0gW3F1ZXJ5RWwoYCR7cm9vdH0ubW92ZS1lbnRpdHktc2VsZWN0YCksIHF1ZXJ5RWwoYCR7cm9vdH0ucmVtb3ZlLWVudGl0eS1zZWxlY3RgKV07XHJcbiAgICAgICAgICAgIHNlbGVjdG9yQXJyLm1hcChjbGVhckVsKS5tYXAoZmlsbFNlbGVjdG9yKFIuX18sIGFycjJTZWxlY3QoYWxsUHJvZmlsZVNldHRpbmdzLm1hcChSLnByb3AoJ25hbWUnKSkpKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlUHJvZmlsZUl0ZW0odHlwZSwgcm9vdCkge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gcXVlcnlFbChgJHtyb290fS5jcmVhdGUtZW50aXR5LWlucHV0YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1UeXBlID0gcXVlcnlFbChgJHtyb290fS5jcmVhdGUtZW50aXR5LXR5cGUtc2VsZWN0YCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCBwb3NpdGlvblNlbGVjdG9yID0gcXVlcnlFbChgJHtyb290fS5jcmVhdGUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdGApO1xyXG5cclxuICAgICAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlSXRlbSh0eXBlLCBuYW1lLCBpdGVtVHlwZSwgcG9zaXRpb25TZWxlY3Rvci5zZWxlY3RlZEluZGV4LCBVdGlscy5wcm9jZXNzRXJyb3IoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtb3ZlUHJvZmlsZUl0ZW0odHlwZSwgcm9vdCkge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgaW5kZXggfSA9IHF1ZXJ5RWwoYCR7cm9vdH0ubW92ZS1lbnRpdHktc2VsZWN0YCkuc2VsZWN0ZWRPcHRpb25zWzBdO1xyXG4gICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IHF1ZXJ5RWwoYCR7cm9vdH0ubW92ZS1lbnRpdHktcG9zaXRpb24tc2VsZWN0YCkuc2VsZWN0ZWRJbmRleDtcclxuICAgICAgICAgICAgREJNUy5tb3ZlUHJvZmlsZUl0ZW0odHlwZSwgaW5kZXgsIG5ld0luZGV4LCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVQcm9maWxlSXRlbSh0eXBlLCByb290KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS1lbnRpdHktc2VsZWN0YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gc2VsZWN0b3Iuc2VsZWN0ZWRJbmRleDtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHNlbGVjdG9yLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbigncHJvZmlsZXMtYXJlLXlvdS1zdXJlLWFib3V0LXJlbW92aW5nLXByb2ZpbGUtaXRlbScpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZVByb2ZpbGVJdGVtKHR5cGUsIGluZGV4LCBuYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGZpbGxJdGVtVHlwZXNTZWwgPSBzZWwgPT4gZmlsbFNlbGVjdG9yKHNlbCwgY29uc3RBcnIyU2VsZWN0KFIua2V5cyhDb25zdGFudHMucHJvZmlsZUZpZWxkVHlwZXMpKSk7XHJcbiAgICBjb25zdCBmaWxsUGxheWVyQWNjZXNzU2VsID0gc2VsID0+IGZpbGxTZWxlY3RvcihzZWwsIGNvbnN0QXJyMlNlbGVjdChDb25zdGFudHMucGxheWVyQWNjZXNzVHlwZXMpKTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZ2V0SW5wdXQgPSBSLmN1cnJ5KCh0eXBlLCBwcm9maWxlU2V0dGluZ3MsIGluZGV4KSA9PiB7IC8vIHRocm93cyBJbnRlcm5hbEVycm9yXHJcbiAgICAgICAgaW5kZXgrKztcclxuICAgICAgICBjb25zdCBlbHMgPSBbXTtcclxuXHJcbiAgICAgICAgZWxzLnB1c2goYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KGluZGV4KSkpO1xyXG5cclxuICAgICAgICBsZXQgaW5wdXQgPSBzZXRQcm9wcyhtYWtlRWwoJ2lucHV0JyksIHtcclxuICAgICAgICAgICAgdmFsdWU6IHByb2ZpbGVTZXR0aW5ncy5uYW1lLFxyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHJlbmFtZVByb2ZpbGVJdGVtKHR5cGUpKTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2l0ZW1OYW1lSW5wdXQnKTtcclxuICAgICAgICBlbHMucHVzaChpbnB1dCk7XHJcblxyXG4gICAgICAgIGxldCBzZWwgPSBtYWtlRWwoJ3NlbGVjdCcpO1xyXG4gICAgICAgIGZpbGxJdGVtVHlwZXNTZWwoc2VsKTtcclxuICAgICAgICBzZXRQcm9wcyhzZWwsIHtcclxuICAgICAgICAgICAgdmFsdWU6IHByb2ZpbGVTZXR0aW5ncy50eXBlLFxyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgb2xkVHlwZTogcHJvZmlsZVNldHRpbmdzLnR5cGVcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaXN0ZW4oc2VsLCAnY2hhbmdlJywgY2hhbmdlUHJvZmlsZUl0ZW1UeXBlKHR5cGUpKTtcclxuICAgICAgICBlbHMucHVzaChzZWwpO1xyXG5cclxuICAgICAgICBzd2l0Y2ggKHByb2ZpbGVTZXR0aW5ncy50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ3RleHRhcmVhJyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwcm9maWxlU2V0dGluZ3MudmFsdWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ251bWJlcic7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JztcclxuICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5JbnRlcm5hbEVycm9yKCdlcnJvcnMtdW5leHBlY3RlZC1zd2l0Y2gtYXJndW1lbnQnLCBbcHJvZmlsZVNldHRpbmdzLnR5cGVdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNldFByb3BzKGlucHV0LCB7XHJcbiAgICAgICAgICAgIGluZm86IHByb2ZpbGVTZXR0aW5ncy5uYW1lLFxyXG4gICAgICAgICAgICBpbmZvVHlwZTogcHJvZmlsZVNldHRpbmdzLnR5cGUsXHJcbiAgICAgICAgICAgIG9sZFZhbHVlOiBwcm9maWxlU2V0dGluZ3MudmFsdWVcclxuICAgICAgICB9KTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgYHByb2ZpbGUtY29uZmlndXJlci0ke3Byb2ZpbGVTZXR0aW5ncy50eXBlfWApO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHVwZGF0ZURlZmF1bHRWYWx1ZSh0eXBlKSk7XHJcbiAgICAgICAgZWxzLnB1c2goaW5wdXQpO1xyXG5cclxuICAgICAgICBpbnB1dCA9IHNldFByb3BzKG1ha2VFbCgnaW5wdXQnKSwge1xyXG4gICAgICAgICAgICBjaGVja2VkOiBwcm9maWxlU2V0dGluZ3MuZG9FeHBvcnQsXHJcbiAgICAgICAgICAgIGluZm86IHByb2ZpbGVTZXR0aW5ncy5uYW1lLFxyXG4gICAgICAgICAgICB0eXBlOiAnY2hlY2tib3gnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgZG9FeHBvcnRDaGFuZ2UodHlwZSkpO1xyXG4gICAgICAgIGVscy5wdXNoKGlucHV0KTtcclxuXHJcbiAgICAgICAgc2VsID0gbWFrZUVsKCdzZWxlY3QnKTtcclxuICAgICAgICBmaWxsUGxheWVyQWNjZXNzU2VsKHNlbCk7XHJcbiAgICAgICAgc2V0UHJvcHMoc2VsLCB7XHJcbiAgICAgICAgICAgIHZhbHVlOiBwcm9maWxlU2V0dGluZ3MucGxheWVyQWNjZXNzLFxyXG4gICAgICAgICAgICBpbmZvOiBwcm9maWxlU2V0dGluZ3MubmFtZSxcclxuICAgICAgICAgICAgb2xkVmFsdWU6IHByb2ZpbGVTZXR0aW5ncy5wbGF5ZXJBY2Nlc3MsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHNlbCwgJ2NoYW5nZScsIGNoYW5nZVByb2ZpbGVJdGVtUGxheWVyQWNjZXNzKHR5cGUpKTtcclxuICAgICAgICBlbHMucHVzaChzZWwpO1xyXG5cclxuICAgICAgICBpbnB1dCA9IHNldFByb3BzKG1ha2VFbCgnaW5wdXQnKSwge1xyXG4gICAgICAgICAgICBjaGVja2VkOiBwcm9maWxlU2V0dGluZ3Muc2hvd0luUm9sZUdyaWQsXHJcbiAgICAgICAgICAgIGluZm86IHByb2ZpbGVTZXR0aW5ncy5uYW1lLFxyXG4gICAgICAgICAgICB0eXBlOiAnY2hlY2tib3gnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCAnY2hhbmdlJywgc2hvd0luUm9sZUdyaWRDaGFuZ2UodHlwZSkpO1xyXG4gICAgICAgIGVscy5wdXNoKGlucHV0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ3RyJyksIGVscy5tYXAoZWwgPT4gYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRDbGFzcyhlbCwgJ2FkbWluT25seScpKSkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgY29uc3QgaXRlbVR5cGUgPSBldmVudC50YXJnZXQuaW5mb1R5cGU7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgb2xkVmFsdWUgfSA9IGV2ZW50LnRhcmdldDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXRlbVR5cGUgPT09ICdjaGVja2JveCcgPyBldmVudC50YXJnZXQuY2hlY2tlZCA6IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIGxldCBuZXdPcHRpb25zLCBtaXNzZWRWYWx1ZXMsIG5ld1ZhbHVlLCB1cGRhdGVFbnVtO1xyXG5cclxuICAgICAgICAgICAgc3dpdGNoIChpdGVtVHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVEZWZhdWx0VmFsdWUodHlwZSwgbmFtZSwgdmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgaWYgKE51bWJlci5pc05hTih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdwcm9maWxlcy1ub3QtYS1udW1iZXInKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVEZWZhdWx0VmFsdWUodHlwZSwgbmFtZSwgTnVtYmVyKHZhbHVlKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAnJyAmJiBpdGVtVHlwZSA9PT0gJ2VudW0nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigncHJvZmlsZXMtZW51bS1pdGVtLWNhbnQtYmUtZW1wdHknKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbmV3T3B0aW9ucyA9IHZhbHVlLnNwbGl0KCcsJykubWFwKFIudHJpbSk7XHJcbiAgICAgICAgICAgICAgICBtaXNzZWRWYWx1ZXMgPSBvbGRWYWx1ZS50cmltKCkgPT09ICcnID8gW10gOiBSLmRpZmZlcmVuY2Uob2xkVmFsdWUuc3BsaXQoJywnKSwgbmV3T3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdXBkYXRlRW51bSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG5ld09wdGlvbnMuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5vbGRWYWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIG5ld1ZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtaXNzZWRWYWx1ZXMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbigncHJvZmlsZXMtbmV3LWVudW0tdmFsdWVzLXJlbW92ZS1zb21lLW9sZC12YWx1ZXMnKSwgW21pc3NlZFZhbHVlcy5qb2luKCcsJyldKSwgdXBkYXRlRW51bSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBvbGRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlRW51bSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihuZXcgRXJyb3JzLkludGVybmFsRXJyb3IoJ2Vycm9ycy11bmV4cGVjdGVkLXN3aXRjaC1hcmd1bWVudCcsIFtpdGVtVHlwZV0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZG9FeHBvcnRDaGFuZ2UodHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5kb0V4cG9ydFByb2ZpbGVJdGVtQ2hhbmdlKHR5cGUsIGV2ZW50LnRhcmdldC5pbmZvLCBldmVudC50YXJnZXQuY2hlY2tlZCwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0luUm9sZUdyaWRDaGFuZ2UodHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zaG93SW5Sb2xlR3JpZFByb2ZpbGVJdGVtQ2hhbmdlKHR5cGUsIGV2ZW50LnRhcmdldC5pbmZvLCBldmVudC50YXJnZXQuY2hlY2tlZCwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lUHJvZmlsZUl0ZW0odHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3TmFtZSA9IGV2ZW50LnRhcmdldC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG9sZE5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lUHJvZmlsZUl0ZW0odHlwZSwgbmV3TmFtZSwgb2xkTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LnRhcmdldC5pbmZvO1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUHJvZmlsZUl0ZW1UeXBlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLWFyZS15b3Utc3VyZS1hYm91dC1jaGFuZ2luZy1wcm9maWxlLWl0ZW0tdHlwZScpLCBbZXZlbnQudGFyZ2V0LmluZm9dKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3VHlwZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgICAgIERCTVMuY2hhbmdlUHJvZmlsZUl0ZW1UeXBlKHR5cGUsIG5hbWUsIG5ld1R5cGUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gZXZlbnQudGFyZ2V0Lm9sZFR5cGU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUHJvZmlsZUl0ZW1QbGF5ZXJBY2Nlc3ModHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGxheWVyQWNjZXNzVHlwZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGV2ZW50LnRhcmdldC5pbmZvO1xyXG4gICAgICAgICAgICBEQk1TLmNoYW5nZVByb2ZpbGVJdGVtUGxheWVyQWNjZXNzKHR5cGUsIG5hbWUsIHBsYXllckFjY2Vzc1R5cGUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBldmVudC50YXJnZXQub2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMucHJvY2Vzc0Vycm9yKCkoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufSkodGhpcy5Qcm9maWxlQ29uZmlndXJlciA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7XHJcbiAgICAgICAgY2hhcmFjdGVyOiB7fSxcclxuICAgICAgICBwbGF5ZXI6IHt9XHJcbiAgICB9O1xyXG4gICAgY29uc3Qgcm9vdCA9ICcucHJvZmlsZS1lZGl0b3ItdGFiICc7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJTZWxlY3RvciA9IGAke3Jvb3R9LmNoYXJhY3Rlci1wcm9maWxlLXNlbGVjdG9yYDtcclxuICAgIGNvbnN0IHBsYXllclNlbGVjdG9yID0gYCR7cm9vdH0ucGxheWVyLXByb2ZpbGUtc2VsZWN0b3JgO1xyXG4gICAgY29uc3QgY2hhcmFjdGVyUHJvZmlsZURpdiA9IGAke3Jvb3R9LmNoYXJhY3Rlci1wcm9maWxlLWRpdmA7XHJcbiAgICBjb25zdCBwbGF5ZXJQcm9maWxlRGl2ID0gYCR7cm9vdH0ucGxheWVyLXByb2ZpbGUtZGl2YDtcclxuICAgIGNvbnN0IGNoYXJhY3RlclJlcG9ydERpdiA9IGAke3Jvb3R9LmNoYXJhY3Rlci1yZXBvcnQtZGl2IHRib2R5YDtcclxuICAgIGxldCBwcm9maWxlRWRpdG9yQ29yZTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgJChjaGFyYWN0ZXJTZWxlY3Rvcikuc2VsZWN0MigpLm9uKCdzZWxlY3QyOnNlbGVjdCcsIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlMignY2hhcmFjdGVyJykpO1xyXG4gICAgICAgICQocGxheWVyU2VsZWN0b3IpLnNlbGVjdDIoKS5vbignc2VsZWN0MjpzZWxlY3QnLCBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZTIoJ3BsYXllcicpKTtcclxuICAgICAgICBwcm9maWxlRWRpdG9yQ29yZSA9IFByb2ZpbGVFZGl0b3JDb3JlLm1ha2VQcm9maWxlRWRpdG9yQ29yZSgpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2hhcmFjdGVyUmVwb3J0RGl2KSk7XHJcbiAgICAgICAgcmVmcmVzaFBhbmVsKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJTZWxlY3RvciwgY2hhcmFjdGVyUHJvZmlsZURpdiwgKCkgPT4ge1xyXG4gICAgICAgICAgICByZWZyZXNoUGFuZWwoJ3BsYXllcicsIHBsYXllclNlbGVjdG9yLCBwbGF5ZXJQcm9maWxlRGl2LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhcHBseVNldHRpbmdzKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJTZWxlY3RvciwgY2hhcmFjdGVyUHJvZmlsZURpdik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWZyZXNoUGFuZWwodHlwZSwgc2VsZWN0b3IsIHByb2ZpbGVEaXYsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkodHlwZSwgZmFsc2UsIChlcnIsIG5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICBuYW1lcy5wdXNoKHsgZGlzcGxheU5hbWU6ICcnLCB2YWx1ZTogJycsIGVkaXRhYmxlOiBmYWxzZSB9KTtcclxuXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChzZWxlY3RvcikpO1xyXG4gICAgICAgICAgICAkKHNlbGVjdG9yKS5zZWxlY3QyKGdldFNlbGVjdDJEYXRhKG5hbWVzKSk7XHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLm5hbWVzID0gbmFtZXM7XHJcblxyXG4gICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVTdHJ1Y3R1cmUodHlwZSwgKGVycjIsIGFsbFByb2ZpbGVTZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuaW5pdFByb2ZpbGVTdHJ1Y3R1cmUocHJvZmlsZURpdiwgdHlwZSwgYWxsUHJvZmlsZVNldHRpbmdzLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGFwcGx5U2V0dGluZ3ModHlwZSwgc2VsZWN0b3IsIHByb2ZpbGVEaXYpIHtcclxuICAgICAgICBjb25zdCB7IG5hbWVzIH0gPSBzdGF0ZVt0eXBlXTtcclxuICAgICAgICBpZiAobmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gbmFtZXNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICBpZiAoIXNldHRpbmdzLlByb2ZpbGVFZGl0b3IpIHtcclxuICAgICAgICAgICAgICAgIHNldHRpbmdzLlByb2ZpbGVFZGl0b3IgPSB7fTtcclxuICAgICAgICAgICAgICAgIHNldHRpbmdzLlByb2ZpbGVFZGl0b3JbdHlwZV0gPSBuYW1lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBwcm9maWxlTmFtZSA9IHNldHRpbmdzLlByb2ZpbGVFZGl0b3JbdHlwZV07XHJcbiAgICAgICAgICAgIGlmIChuYW1lcy5tYXAobmFtZUluZm8gPT4gbmFtZUluZm8udmFsdWUpLmluZGV4T2YocHJvZmlsZU5hbWUpID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgc2V0dGluZ3MuUHJvZmlsZUVkaXRvclt0eXBlXSA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICBwcm9maWxlTmFtZSA9IG5hbWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKHR5cGUpKHsgdGFyZ2V0OiB7IHZhbHVlOiBwcm9maWxlTmFtZSB9IH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZWxlY3RQcm9maWxlcyhjaGFyTmFtZSwgcGxheWVyTmFtZSkge1xyXG4gICAgICAgIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJQcm9maWxlRGl2LCBjaGFyTmFtZSk7XHJcbiAgICAgICAgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUoJ3BsYXllcicsIHBsYXllclByb2ZpbGVEaXYsIHBsYXllck5hbWUpO1xyXG4gICAgICAgICQoY2hhcmFjdGVyU2VsZWN0b3IpLnNlbGVjdDIoKS52YWwoY2hhck5hbWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICQocGxheWVyU2VsZWN0b3IpLnNlbGVjdDIoKS52YWwocGxheWVyTmFtZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUyKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdFByb2ZpbGVzKCcnLCAnJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgREJNUy5nZXRQcm9maWxlQmluZGluZyh0eXBlLCBuYW1lLCAoZXJyLCBiaW5kaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc2VsZWN0UHJvZmlsZXMoYmluZGluZ1swXSwgYmluZGluZ1sxXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUodHlwZSwgcHJvZmlsZURpdiwgbmFtZSkge1xyXG4gICAgICAgIHVwZGF0ZVNldHRpbmdzKHR5cGUsIG5hbWUpO1xyXG4gICAgICAgIGlmIChuYW1lID09PSAnJykge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhxdWVyeUVsKHByb2ZpbGVEaXYpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIGlmICh0eXBlID09PSAnY2hhcmFjdGVyJykge1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MocXVlcnlFbChjaGFyYWN0ZXJSZXBvcnREaXYpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBEQk1TLmdldFByb2ZpbGUodHlwZSwgbmFtZSwgKGVyciwgcHJvZmlsZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSh0eXBlLCBuYW1lLCAoZXJyMiwgaXNDaGFyYWN0ZXJFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuZmlsbFByb2ZpbGVJbmZvcm1hdGlvbihwcm9maWxlRGl2LCB0eXBlLCBwcm9maWxlLCAoKSA9PiBpc0NoYXJhY3RlckVkaXRhYmxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NoYXJhY3RlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICBEQk1TLmdldENoYXJhY3RlclJlcG9ydChuYW1lLCAoZXJyMywgY2hhcmFjdGVyUmVwb3J0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocXVlcnlFbChjaGFyYWN0ZXJSZXBvcnREaXYpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjaGFyYWN0ZXJSZXBvcnREaXYpKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlclJlcG9ydC5tYXAoQ2hhcmFjdGVyUmVwb3J0cy5tYWtlU3RvcnlSZXBvcnRSb3cpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVNldHRpbmdzKHR5cGUsIG5hbWUpIHtcclxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IERCTVMuZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICBzZXR0aW5ncy5Qcm9maWxlRWRpdG9yW3R5cGVdID0gbmFtZTtcclxuICAgIH1cclxufSkodGhpcy5Qcm9maWxlRWRpdG9yID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgZnVuYy1uYW1lcyAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLm1ha2VQcm9maWxlRWRpdG9yQ29yZSA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBpbm5lckV4cG9ydHMgPSB7fTtcclxuXHJcbiAgICAgICAgY29uc3Qgcm9vdCA9ICcucHJvZmlsZS1lZGl0b3ItY29yZS10bXBsJztcclxuXHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB7XHJcbiAgICAgICAgICAgIGNoYXJhY3Rlcjoge30sXHJcbiAgICAgICAgICAgIHBsYXllcjoge31cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpbm5lckV4cG9ydHMuaW5pdFByb2ZpbGVTdHJ1Y3R1cmUgPSAocHJvZmlsZURpdiwgdHlwZSwgcHJvZmlsZVN0cnVjdHVyZSwgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gcXRlKGAke3Jvb3R9IC5wcm9maWxlLWVkaXRvci1jb250YWluZXItdG1wbGApO1xyXG4gICAgICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwocHJvZmlsZURpdikpLCBjb250YWluZXIpO1xyXG4gICAgICAgICAgICBzdGF0ZVt0eXBlXS5pbnB1dEl0ZW1zID0ge307XHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLnByb2ZpbGVTdHJ1Y3R1cmUgPSBwcm9maWxlU3RydWN0dXJlO1xyXG5cclxuICAgICAgICAgICAgaWYocHJvZmlsZVN0cnVjdHVyZS5sZW5ndGggPT09IDApe1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYWxlcnQgPSBxbXRlKCcuYWxlcnQtYmxvY2stdG1wbCcpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwoYWxlcnQsIG1ha2VUZXh0KEwxMG4uZ2V0KCdhZHZpY2VzJywgYGVtcHR5LSR7dHlwZX0tcHJvZmlsZS1zdHJ1Y3R1cmVgKSkpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwocXVlcnlFbChwcm9maWxlRGl2KSwgYWxlcnQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHMocWVlKHF1ZXJ5RWwocHJvZmlsZURpdiksICcuaW5zZXJ0aW9uLXBvaW50JyksIHByb2ZpbGVTdHJ1Y3R1cmUubWFwKGFwcGVuZElucHV0KHR5cGUpKSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgICAgIHZhciBhcHBlbmRJbnB1dCA9IFIuY3VycnkoKHR5cGUsIHByb2ZpbGVJdGVtQ29uZmlnKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1JbnB1dCA9IG5ldyBQcm9maWxlSXRlbUlucHV0KHR5cGUsIHByb2ZpbGVJdGVtQ29uZmlnKTtcclxuICAgICAgICAgICAgc3RhdGVbdHlwZV0uaW5wdXRJdGVtc1twcm9maWxlSXRlbUNvbmZpZy5uYW1lXSA9IGl0ZW1JbnB1dDtcclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gcXRlKGAke3Jvb3R9IC5wcm9maWxlLWVkaXRvci1yb3ctdG1wbGApO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLnByb2ZpbGUtaXRlbS1uYW1lJyksIG1ha2VUZXh0KHByb2ZpbGVJdGVtQ29uZmlnLm5hbWUpKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5wcm9maWxlLWl0ZW0taW5wdXQnKSwgaXRlbUlucHV0LmRvbSk7XHJcbiAgICAgICAgICAgIHJldHVybiByb3c7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlubmVyRXhwb3J0cy5maWxsUHJvZmlsZUluZm9ybWF0aW9uID0gKHByb2ZpbGVEaXYsIHR5cGUsIHByb2ZpbGUsIGlzRWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocXVlcnlFbChwcm9maWxlRGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBSLnZhbHVlcyhzdGF0ZVt0eXBlXS5pbnB1dEl0ZW1zKS5mb3JFYWNoKChpdGVtSW5wdXQpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtSW5wdXQudHlwZSA9PT0gJ211bHRpRW51bScpIHtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtSW5wdXQubXVsdGlFbnVtU2VsZWN0LnByb3AoJ2Rpc2FibGVkJywgIWlzRWRpdGFibGUoaXRlbUlucHV0Lm5hbWUsIHN0YXRlW3R5cGVdLnByb2ZpbGVTdHJ1Y3R1cmUpKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwoaXRlbUlucHV0LmRvbSwgaXNFZGl0YWJsZShpdGVtSW5wdXQubmFtZSwgc3RhdGVbdHlwZV0ucHJvZmlsZVN0cnVjdHVyZSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHN0YXRlW3R5cGVdLm5hbWUgPSBwcm9maWxlLm5hbWU7XHJcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoc3RhdGVbdHlwZV0uaW5wdXRJdGVtcykuZm9yRWFjaCgoaXRlbSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaXRlbS5zaG93RmllbGRWYWx1ZShwcm9maWxlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gUHJvZmlsZUl0ZW1JbnB1dChwcm9maWxlVHlwZSwgcHJvZmlsZUl0ZW1Db25maWcpIHtcclxuICAgICAgICAgICAgbGV0IGlucHV0LCBzZWw7XHJcbiAgICAgICAgICAgIHN3aXRjaCAocHJvZmlsZUl0ZW1Db25maWcudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCd0ZXh0YXJlYScpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdwcm9maWxlVGV4dElucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdwcm9maWxlU3RyaW5nSW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdzZWxlY3QnKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAncHJvZmlsZVNlbGVjdElucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0b05hbWVPYmogPSBSLmNvbXBvc2UoUi56aXBPYmooWyduYW1lJ10pLCBSLmFwcGVuZChSLl9fLCBbXSkpO1xyXG4gICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKGlucHV0LCBSLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEsIHByb2ZpbGVJdGVtQ29uZmlnLnZhbHVlLnNwbGl0KCcsJykpLm1hcCh0b05hbWVPYmopKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gJ251bWJlcic7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JztcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5tdWx0aUVudW1TZWxlY3QgPSAkKCc8c2VsZWN0Pjwvc2VsZWN0PicpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cih0aGlzLm11bHRpRW51bVNlbGVjdFswXSwgJ3N0eWxlJywgJ3dpZHRoOiAxMDAlOycpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3ModGhpcy5tdWx0aUVudW1TZWxlY3RbMF0sICdjb21tb24tc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyh0aGlzLm11bHRpRW51bVNlbGVjdFswXSwgJ3Byb2ZpbGVTdHJpbmdJbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgW2lucHV0XSA9ICQoJzxzcGFuPjwvc3Bhbj4nKS5hcHBlbmQodGhpcy5tdWx0aUVudW1TZWxlY3QpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cih0aGlzLm11bHRpRW51bVNlbGVjdFswXSwgJ211bHRpcGxlJywgJ211bHRpcGxlJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgc2VsID0gdGhpcy5tdWx0aUVudW1TZWxlY3Quc2VsZWN0MihhcnIyU2VsZWN0MihSLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEsIHByb2ZpbGVJdGVtQ29uZmlnLnZhbHVlLnNwbGl0KCcsJykpKSk7XHJcbiAgICAgICAgICAgICAgICBzZWwub24oJ2NoYW5nZScsIHRoaXMudXBkYXRlRmllbGRWYWx1ZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5JbnRlcm5hbEVycm9yKCdlcnJvcnMtdW5leHBlY3RlZC1zd2l0Y2gtYXJndW1lbnQnLCBbcHJvZmlsZUl0ZW1Db25maWcudHlwZV0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAocHJvZmlsZUl0ZW1Db25maWcudHlwZSAhPT0gJ211bHRpRW51bScpIHtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHRoaXMudXBkYXRlRmllbGRWYWx1ZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZG9tID0gaW5wdXQ7XHJcbiAgICAgICAgICAgIHRoaXMudHlwZSA9IHByb2ZpbGVJdGVtQ29uZmlnLnR5cGU7XHJcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZVR5cGUgPSBwcm9maWxlVHlwZTtcclxuICAgICAgICAgICAgdGhpcy5uYW1lID0gcHJvZmlsZUl0ZW1Db25maWcubmFtZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFByb2ZpbGVJdGVtSW5wdXQucHJvdG90eXBlLnNob3dGaWVsZFZhbHVlID0gZnVuY3Rpb24gKHByb2ZpbGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94Jykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kb20uY2hlY2tlZCA9IHByb2ZpbGVbdGhpcy5uYW1lXTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdtdWx0aUVudW0nKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm11bHRpRW51bVNlbGVjdC52YWwocHJvZmlsZVt0aGlzLm5hbWVdID09PSAnJyA/IG51bGwgOiBwcm9maWxlW3RoaXMubmFtZV0uc3BsaXQoJywnKSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvbS52YWx1ZSA9IHByb2ZpbGVbdGhpcy5uYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm9sZFZhbHVlID0gcHJvZmlsZVt0aGlzLm5hbWVdO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIFByb2ZpbGVJdGVtSW5wdXQucHJvdG90eXBlLnVwZGF0ZUZpZWxkVmFsdWUgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGROYW1lID0gdGhpcy5uYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBwcm9maWxlTmFtZSA9IHN0YXRlW3RoaXMucHJvZmlsZVR5cGVdLm5hbWU7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm11bHRpRW51bVNlbGVjdCAmJiB0aGlzLm11bHRpRW51bVNlbGVjdC5wcm9wKCdkaXNhYmxlZCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47IC8vIHdlIG5lZWQgdG8gdHJpZ2dlciBjaGFuZ2UgZXZlbnQgb24gbXVsdGlFbnVtU2VsZWN0IHRvIHVwZGF0ZSBzZWxlY3Rpb24uXHJcbiAgICAgICAgICAgICAgICAvLyBJdCBtYXkgYmUgZGlzYWJsZWQgc28gaXQgaGFzIGZhbHNlIHBvc2l0aXZlIGNhbGwuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSwgdmFsO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKHRoaXMudHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmRvbS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKHRoaXMuZG9tLnZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ3Byb2ZpbGVzLW5vdC1hLW51bWJlcicpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbS52YWx1ZSA9IHRoaXMub2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBOdW1iZXIodGhpcy5kb20udmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5kb20uY2hlY2tlZDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLm11bHRpRW51bVNlbGVjdC52YWwoKS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKG5ldyBFcnJvcnMuSW50ZXJuYWxFcnJvcignZXJyb3JzLXVuZXhwZWN0ZWQtc3dpdGNoLWFyZ3VtZW50JywgW3RoaXMudHlwZV0pKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBEQk1TLnVwZGF0ZVByb2ZpbGVGaWVsZCh0aGlzLnByb2ZpbGVUeXBlLCBwcm9maWxlTmFtZSwgZmllbGROYW1lLCB0aGlzLnR5cGUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGlubmVyRXhwb3J0cztcclxuICAgIH07XHJcbn0pKHRoaXMuUHJvZmlsZUVkaXRvckNvcmUgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIFByb2ZpbGVFZGl0b3IsIFByb2ZpbGVDb25maWd1cmVyLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3QgdGFiUm9vdCA9ICcucHJvZmlsZXMtdGFiICc7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJSb290ID0gYCR7dGFiUm9vdH0uY2hhcmFjdGVyLXByb2ZpbGUtcGFuZWwgYDtcclxuICAgIGNvbnN0IHBsYXllclJvb3QgPSBgJHt0YWJSb290fS5wbGF5ZXItcHJvZmlsZS1wYW5lbCBgO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBzdGF0ZS52aWV3cyA9IHt9O1xyXG4gICAgICAgIGNvbnN0IG5hdiA9IGAke3RhYlJvb3R9LnN1Yi10YWItbmF2aWdhdGlvbmA7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IGAke3RhYlJvb3R9LnN1Yi10YWItY29udGVudGA7XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHF1ZXJ5RWwobmF2KSxcclxuICAgICAgICAgICAgY29udGVudDogcXVlcnlFbChjb250ZW50KVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCAncHJvZmlsZS1lZGl0b3InLCBQcm9maWxlRWRpdG9yLCB7IG1haW5QYWdlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3Byb2ZpbGUtY29uc3RydWN0b3InLCBQcm9maWxlQ29uZmlndXJlcik7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCAncHJvZmlsZS1iaW5kaW5nJywgUHJvZmlsZUJpbmRpbmcpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtjaGFyYWN0ZXJSb290fS5jcmVhdGUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCBjcmVhdGVQcm9maWxlKCdjaGFyYWN0ZXInLCBjaGFyYWN0ZXJSb290KSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7Y2hhcmFjdGVyUm9vdH0ucmVuYW1lLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgcmVuYW1lUHJvZmlsZSgnY2hhcmFjdGVyJywgY2hhcmFjdGVyUm9vdCkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke2NoYXJhY3RlclJvb3R9LnJlbW92ZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIHJlbW92ZVByb2ZpbGUoJ2NoYXJhY3RlcicsIGNoYXJhY3RlclJvb3QpKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cGxheWVyUm9vdH0uY3JlYXRlLWVudGl0eS1idXR0b25gKSwgJ2NsaWNrJywgY3JlYXRlUHJvZmlsZSgncGxheWVyJywgcGxheWVyUm9vdCkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3BsYXllclJvb3R9LnJlbmFtZS1lbnRpdHktYnV0dG9uYCksICdjbGljaycsIHJlbmFtZVByb2ZpbGUoJ3BsYXllcicsIHBsYXllclJvb3QpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtwbGF5ZXJSb290fS5yZW1vdmUtZW50aXR5LWJ1dHRvbmApLCAnY2xpY2snLCByZW1vdmVQcm9maWxlKCdwbGF5ZXInLCBwbGF5ZXJSb290KSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwodGFiUm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgdHJ1ZSwgKGVyciwgY2hhcmFjdGVyTmFtZXMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3BsYXllcicsIHRydWUsIChlcnIyLCBwbGF5ZXJOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgcmVidWlsZEludGVyZmFjZShjaGFyYWN0ZXJSb290LCBjaGFyYWN0ZXJOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICByZWJ1aWxkSW50ZXJmYWNlKHBsYXllclJvb3QsIHBsYXllck5hbWVzKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlYnVpbGRJbnRlcmZhY2Uocm9vdCwgbmFtZXMpIHtcclxuICAgICAgICBjb25zdCBkYXRhID0gZ2V0U2VsZWN0MkRhdGEobmFtZXMpO1xyXG5cclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucmVuYW1lLWVudGl0eS1zZWxlY3RgKSk7XHJcbiAgICAgICAgJChgJHtyb290fS5yZW5hbWUtZW50aXR5LXNlbGVjdGApLnNlbGVjdDIoZGF0YSk7XHJcblxyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5yZW1vdmUtZW50aXR5LXNlbGVjdGApKTtcclxuICAgICAgICAkKGAke3Jvb3R9LnJlbW92ZS1lbnRpdHktc2VsZWN0YCkuc2VsZWN0MihkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVQcm9maWxlKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHF1ZXJ5RWwoYCR7cm9vdH0uY3JlYXRlLWVudGl0eS1pbnB1dGApO1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlKHR5cGUsIG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaCgoZXJyMikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuY3VycmVudFZpZXcudXBkYXRlU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY3VycmVudFZpZXcudXBkYXRlU2V0dGluZ3MobmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVQcm9maWxlKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcXVlcnlFbChgJHtyb290fS5yZW5hbWUtZW50aXR5LWlucHV0YCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZyb21OYW1lID0gcXVlcnlFbChgJHtyb290fS5yZW5hbWUtZW50aXR5LXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgdG9OYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcblxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZVByb2ZpbGUodHlwZSwgZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuY3VycmVudFZpZXcudXBkYXRlU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY3VycmVudFZpZXcudXBkYXRlU2V0dGluZ3ModHlwZSwgdG9OYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVQcm9maWxlKHR5cGUsIHJvb3QpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gcXVlcnlFbChgJHtyb290fS5yZW1vdmUtZW50aXR5LXNlbGVjdGApLnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Byb2ZpbGVzLWFyZS15b3Utc3VyZS1hYm91dC1jaGFyYWN0ZXItcmVtb3ZpbmcnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVQcm9maWxlKHR5cGUsIG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufSkodGhpcy5Qcm9maWxlcyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuY2hhcmFjdGVyLXJlcG9ydHMtdG1wbCc7XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlU3RvcnlSZXBvcnRSb3cgPSAoc3RvcnlJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYWN0ID0gc3RvcnlJbmZvLmFjdGl2aXR5O1xyXG4gICAgICAgIGNvbnN0IGNvbXBsZXRlbmVzcyA9IG1ha2VDb21wbGV0ZW5lc3NMYWJlbChzdG9yeUluZm8uZmluaXNoZWRBZGFwdGF0aW9ucywgc3RvcnlJbmZvLnRvdGFsQWRhcHRhdGlvbnMpO1xyXG4gICAgICAgIGNvbnN0IGNvbG9yID0gZ2V0Q29tcGxldGVuZXNzQ29sb3Ioc3RvcnlJbmZvLmZpbmlzaGVkQWRhcHRhdGlvbnMsIHN0b3J5SW5mby50b3RhbEFkYXB0YXRpb25zKTtcclxuICAgICAgICBjb25zdCByb3cgPSBxdGUoYCR7cm9vdH0gLnN0b3J5LXJlcG9ydC1yb3ctdG1wbGApO1xyXG4gICAgICAgIGNvbnN0IHFlID0gcWVlKHJvdyk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhyb3cpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcuc3RvcnktbmFtZScpLCBtYWtlVGV4dChzdG9yeUluZm8uc3RvcnlOYW1lKSk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxZSgnLmFjdGl2aXR5LWFjdGl2ZScpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JywgYWN0LmFjdGl2ZSk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxZSgnLmFjdGl2aXR5LWZvbGxvd2VyJyksICdhY3RpdmUtaXRlbS1pbi1yZXBvcnQnLCBhY3QuZm9sbG93ZXIpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocWUoJy5hY3Rpdml0eS1kZWZlbnNpdmUnKSwgJ2FjdGl2ZS1pdGVtLWluLXJlcG9ydCcsIGFjdC5kZWZlbnNpdmUpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocWUoJy5hY3Rpdml0eS1wYXNzaXZlJyksICdhY3RpdmUtaXRlbS1pbi1yZXBvcnQnLCBhY3QucGFzc2l2ZSk7XHJcbiAgICAgICAgYWRkRWwocWUoJy5jb21wbGV0ZW5lc3MnKSwgbWFrZVRleHQoY29tcGxldGVuZXNzKSk7XHJcbiAgICAgICAgc2V0U3R5bGUocWUoJy5jb21wbGV0ZW5lc3MnKSwgJ2JhY2tncm91bmQtY29sb3InLCBjb2xvcik7XHJcbiAgICAgICAgYWRkRWwocWUoJy5tZWV0cycpLCBtYWtlVGV4dChzdG9yeUluZm8ubWVldHMuam9pbignLCAnKSkpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcuaW52ZW50b3J5JyksIG1ha2VUZXh0KHN0b3J5SW5mby5pbnZlbnRvcnkpKTtcclxuICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VSZWxhdGlvblJlcG9ydFJvdyA9IFIuY3VycnkoKGNoYXJhY3Rlck5hbWUsIHJlbCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJvdyA9IHF0ZShgJHtyb290fSAucmVsYXRpb24tcmVwb3J0LXJvdy10bXBsYCk7XHJcbiAgICAgICAgY29uc3QgcWUgPSBxZWUocm93KTtcclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKHJvdyk7XHJcbiAgICAgICAgY29uc3Qgc2Vjb25kQ2hhcmFjdGVyID0gUHJvamVjdFV0aWxzLmdldDJuZFJlbENoYXIoY2hhcmFjdGVyTmFtZSwgcmVsKTtcclxuICAgICAgICBhZGRFbChxZSgnLmNoYXJhY3Rlci1uYW1lJyksIG1ha2VUZXh0KHNlY29uZENoYXJhY3RlcikpO1xyXG4gICAgICAgIGNvbnN0IGlzU3RhcnRlciA9IHJlbC5zdGFydGVyID09PSBjaGFyYWN0ZXJOYW1lO1xyXG5cclxuICAgICAgICBpZiAoaXNTdGFydGVyKSB7XHJcbiAgICAgICAgICAgIHNldEF0dHIoXHJcbiAgICAgICAgICAgICAgICBxZSgnLmRpcmVjdGlvbi1zdGFydGVyVG9FbmRlcicpLCAndGl0bGUnLFxyXG4gICAgICAgICAgICAgICAgTDEwbi5mb3JtYXQoJ2JyaWVmaW5ncycsICdzdGFydGVyVG9FbmRlcicsIFtjaGFyYWN0ZXJOYW1lLCBzZWNvbmRDaGFyYWN0ZXJdKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBzZXRBdHRyKFxyXG4gICAgICAgICAgICAgICAgcWUoJy5kaXJlY3Rpb24tZW5kZXJUb1N0YXJ0ZXInKSwgJ3RpdGxlJyxcclxuICAgICAgICAgICAgICAgIEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCAnZW5kZXJUb1N0YXJ0ZXInLCBbc2Vjb25kQ2hhcmFjdGVyLCBjaGFyYWN0ZXJOYW1lXSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzZXRBdHRyKFxyXG4gICAgICAgICAgICAgICAgcWUoJy5kaXJlY3Rpb24tc3RhcnRlclRvRW5kZXInKSwgJ3RpdGxlJyxcclxuICAgICAgICAgICAgICAgIEwxMG4uZm9ybWF0KCdicmllZmluZ3MnLCAnc3RhcnRlclRvRW5kZXInLCBbc2Vjb25kQ2hhcmFjdGVyLCBjaGFyYWN0ZXJOYW1lXSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgc2V0QXR0cihcclxuICAgICAgICAgICAgICAgIHFlKCcuZGlyZWN0aW9uLWVuZGVyVG9TdGFydGVyJyksICd0aXRsZScsXHJcbiAgICAgICAgICAgICAgICBMMTBuLmZvcm1hdCgnYnJpZWZpbmdzJywgJ2VuZGVyVG9TdGFydGVyJywgW2NoYXJhY3Rlck5hbWUsIHNlY29uZENoYXJhY3Rlcl0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKFxyXG4gICAgICAgICAgICBxZSgnLmRpcmVjdGlvbi1zdGFydGVyVG9FbmRlcicpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JyxcclxuICAgICAgICAgICAgUi5jb250YWlucyhpc1N0YXJ0ZXIgPyAnc3RhcnRlclRvRW5kZXInIDogJ2VuZGVyVG9TdGFydGVyJywgcmVsLmVzc2VuY2UpXHJcbiAgICAgICAgKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHFlKCcuZGlyZWN0aW9uLWFsbGllcycpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JywgUi5jb250YWlucygnYWxsaWVzJywgcmVsLmVzc2VuY2UpKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKFxyXG4gICAgICAgICAgICBxZSgnLmRpcmVjdGlvbi1lbmRlclRvU3RhcnRlcicpLCAnYWN0aXZlLWl0ZW0taW4tcmVwb3J0JyxcclxuICAgICAgICAgICAgUi5jb250YWlucyghaXNTdGFydGVyID8gJ3N0YXJ0ZXJUb0VuZGVyJyA6ICdlbmRlclRvU3RhcnRlcicsIHJlbC5lc3NlbmNlKVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbmlzaGVkID0gaXNTdGFydGVyID8gcmVsLnN0YXJ0ZXJUZXh0UmVhZHkgOiByZWwuZW5kZXJUZXh0UmVhZHk7XHJcblxyXG4gICAgICAgIGFkZEVsKHFlKCcuY29tcGxldGVuZXNzJyksIG1ha2VUZXh0KEwxMG4uZ2V0KCdjb25zdGFudCcsIGZpbmlzaGVkID8gJ2ZpbmlzaGVkJyA6ICd1bmZpbmlzaGVkJykpKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHFlKCcuY29tcGxldGVuZXNzJyksICdyZWxhdGlvbi1maW5pc2hlZCcsIGZpbmlzaGVkKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHFlKCcuY29tcGxldGVuZXNzJyksICdyZWxhdGlvbi11bmZpbmlzaGVkJywgIWZpbmlzaGVkKTtcclxuXHJcbiAgICAgICAgYWRkRWwocWUoJy5vcmlnaW4nKSwgbWFrZVRleHQocmVsLm9yaWdpbikpO1xyXG4gICAgICAgIHJldHVybiByb3c7XHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQ29tcGxldGVuZXNzTGFiZWwodmFsdWUsIHRvdGFsKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0ckZvcm1hdCgnezB9ICh7MX0vezJ9KScsIFt0b3RhbCA9PT0gMCA/ICctJyA6IGAkeygodmFsdWUgLyB0b3RhbCkgKiAxMDApLnRvRml4ZWQoMCl9JWAsIHZhbHVlLCB0b3RhbF0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldENvbXBsZXRlbmVzc0NvbG9yKHZhbHVlLCB0b3RhbCkge1xyXG4gICAgICAgIGlmICh0b3RhbCA9PT0gMCkgeyByZXR1cm4gJ3RyYW5zcGFyZW50JzsgfVxyXG4gICAgICAgIGZ1bmN0aW9uIGNhbGMoYiwgYSwgcGFydCkge1xyXG4gICAgICAgICAgICByZXR1cm4gKChhICogcGFydCkgKyAoKDEgLSBwYXJ0KSAqIGIpKS50b0ZpeGVkKDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHAgPSB2YWx1ZSAvIHRvdGFsO1xyXG4gICAgICAgIGlmIChwIDwgMC41KSB7XHJcbiAgICAgICAgICAgIHAgKj0gMjtcclxuICAgICAgICAgICAgcmV0dXJuIHN0ckZvcm1hdCgncmdiYSh7MH0sezF9LHsyfSwgMSknLCBbY2FsYygyNTEsIDI1NSwgcCksIGNhbGMoMTI2LCAyNTUsIHApLCBjYWxjKDEyOSwgMCwgcCldKTsgLy8gcmVkIHRvIHllbGxvdyBtYXBwaW5nXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHAgPSAocCAtIDAuNSkgKiAyO1xyXG4gICAgICAgIHJldHVybiBzdHJGb3JtYXQoJ3JnYmEoezB9LHsxfSx7Mn0sIDEpJywgW2NhbGMoMjU1LCAxMjMsIHApLCBjYWxjKDI1NSwgMjI1LCBwKSwgY2FsYygwLCA2NSwgcCldKTsgLy8geWVsbG93IHRvIGdyZWVuIG1hcHBpbmdcclxuICAgIH1cclxufSkodGhpcy5DaGFyYWN0ZXJSZXBvcnRzID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5wcm9maWxlLWJpbmRpbmcyLXRhYiAnO1xyXG4gICAgY29uc3QgbDEwbiA9IEwxMG4uZ2V0KCdiaW5kaW5nJyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5jaGFyYWN0ZXItZmlsdGVyYCksICdpbnB1dCcsIGZpbHRlckxpc3QoJy5jaGFyYWN0ZXItbGlzdCcpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fSAucGxheWVyLWZpbHRlcmApLCAnaW5wdXQnLCBmaWx0ZXJMaXN0KCcucGxheWVyLWxpc3QnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLmJpbmRpbmctZmlsdGVyYCksICdpbnB1dCcsIGZpbHRlckxpc3QoJy5iaW5kaW5nLWxpc3QnKSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuZ2V0RW50aXR5TmFtZXNBcnJheSgnY2hhcmFjdGVyJywgZmFsc2UsIChlcnIsIGNoYXJhY3Rlck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdwbGF5ZXInLCBmYWxzZSwgKGVycjIsIHBsYXllck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBEQk1TLmdldFByb2ZpbGVCaW5kaW5ncygoZXJyMywgcHJvZmlsZUJpbmRpbmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UoY2hhcmFjdGVyTmFtZXMsIHBsYXllck5hbWVzLCBwcm9maWxlQmluZGluZ3MpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWJ1aWxkSW50ZXJmYWNlKGNoYXJhY3Rlck5hbWVzLCBwbGF5ZXJOYW1lcywgcHJvZmlsZUJpbmRpbmdzKSB7XHJcbiAgICAgICAgY29uc3QgYm9uZGVkQ2hhcmFjdGVyTGlzdCA9IFIua2V5cyhwcm9maWxlQmluZGluZ3MpO1xyXG4gICAgICAgIGNvbnN0IGJvbmRlZFBsYXllckxpc3QgPSBSLnZhbHVlcyhwcm9maWxlQmluZGluZ3MpO1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IGxpc3QgPT4gUi5jb21wb3NlKFIubm90LCBSLmNvbnRhaW5zKFIuX18sIGxpc3QpLCBSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHNob3dFbChxdWVyeUVsKGAke3Jvb3R9IC5hbGVydC5uby1jaGFyYWN0ZXJgKSwgY2hhcmFjdGVyTmFtZXMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICBVdGlscy5lbmFibGVFbChxdWVyeUVsKGAke3Jvb3R9IC5jaGFyYWN0ZXItZmlsdGVyYCksIGNoYXJhY3Rlck5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLmNoYXJhY3Rlci1saXN0YCksIGNoYXJhY3Rlck5hbWVzLmxlbmd0aCAhPT0gMCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLmFsZXJ0Lm5vLXBsYXllcmApLCBwbGF5ZXJOYW1lcy5sZW5ndGggPT09IDApO1xyXG4gICAgICAgIFV0aWxzLmVuYWJsZUVsKHF1ZXJ5RWwoYCR7cm9vdH0gLnBsYXllci1maWx0ZXJgKSwgcGxheWVyTmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICBzaG93RWwocXVlcnlFbChgJHtyb290fSAucGxheWVyLWxpc3RgKSwgcGxheWVyTmFtZXMubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICBcclxuICAgICAgICBVdGlscy5lbmFibGVFbChxdWVyeUVsKGAke3Jvb3R9IC5iaW5kaW5nLWZpbHRlcmApLCBSLmtleXMocHJvZmlsZUJpbmRpbmdzKS5sZW5ndGggIT09IDApO1xyXG5cclxuICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3QuY2hhcmFjdGVyLWxpc3RgKSksXHJcbiAgICAgICAgICAgIGNoYXJhY3Rlck5hbWVzLmZpbHRlcihmaWx0ZXIoYm9uZGVkQ2hhcmFjdGVyTGlzdCkpLm1hcChwcm9maWxlMmVsKCdjaGFyYWN0ZXInKSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBhZGRFbHMoXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChgJHtyb290fSAuZW50aXR5LWxpc3QucGxheWVyLWxpc3RgKSksXHJcbiAgICAgICAgICAgIHBsYXllck5hbWVzLmZpbHRlcihmaWx0ZXIoYm9uZGVkUGxheWVyTGlzdCkpLm1hcChwcm9maWxlMmVsKCdwbGF5ZXInKSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCBiaW5kaW5ncyA9IFIudG9QYWlycyhwcm9maWxlQmluZGluZ3MpLm1hcChiaW5kaW5nID0+ICh7XHJcbiAgICAgICAgICAgIG5hbWU6IFIuam9pbignLycsIGJpbmRpbmcpLFxyXG4gICAgICAgICAgICB2YWx1ZTogYmluZGluZ1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBiaW5kaW5ncy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ25hbWUnKSkpO1xyXG5cclxuICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdC5iaW5kaW5nLWxpc3RgKSksIGJpbmRpbmdzLm1hcChiaW5kaW5nMmVsKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcHJvZmlsZTJlbCA9IFIuY3VycnkoKHR5cGUsIG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBlbCA9IHFtdGUoYCR7cm9vdH0gLnByb2ZpbGUtaXRlbS10bXBsYCk7XHJcbiAgICAgICAgZWwucHJvZmlsZU5hbWUgPSBuYW1lLnZhbHVlO1xyXG4gICAgICAgIGNvbnN0IGJ0biA9IHFlZShlbCwgJ1tyb2xlPWJ1dHRvbl0nKTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcucHJpbWFyeS1uYW1lJyksIG1ha2VUZXh0KG5hbWUuZGlzcGxheU5hbWUpKTtcclxuICAgICAgICBzZXRBdHRyKGJ0biwgJ3Byb2ZpbGUtbmFtZScsIG5hbWUudmFsdWUpO1xyXG4gICAgICAgIHNldEF0dHIoYnRuLCAncHJpbWFyeS1uYW1lJywgbmFtZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgc2V0QXR0cihidG4sICdwcm9maWxlLXR5cGUnLCB0eXBlKTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ3N0YXJ0Jywgb25EcmFnU3RhcnQpO1xyXG4gICAgICAgIGxpc3RlbihidG4sICdkcm9wJywgb25Ecm9wKTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCAnZHJhZ292ZXInLCBhbGxvd0Ryb3ApO1xyXG4gICAgICAgIGxpc3RlbihidG4sICdkcmFnZW50ZXInLCBoYW5kbGVEcmFnRW50ZXIpO1xyXG4gICAgICAgIGxpc3RlbihidG4sICdkcmFnbGVhdmUnLCBoYW5kbGVEcmFnTGVhdmUpO1xyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkRyYWdTdGFydCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYG9uRHJhZ1N0YXJ0ICR7dGhpcy5wcm9maWxlTmFtZX1gKTtcclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YSgnZGF0YScsIEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgbmFtZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS1uYW1lJyksXHJcbiAgICAgICAgICAgIHR5cGU6IGdldEF0dHIodGhpcywgJ3Byb2ZpbGUtdHlwZScpLFxyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICdtb3ZlJztcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIG9uRHJvcCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3ModGhpcywgJ292ZXInKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhgb25Ecm9wICR7dGhpcy5wcm9maWxlTmFtZX0ke2V2ZW50LmRhdGFUcmFuc2Zlci5nZXREYXRhKCdkYXRhJyl9YCk7XHJcbiAgICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikge1xyXG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsgLy8gc3RvcHMgdGhlIGJyb3dzZXIgZnJvbSByZWRpcmVjdGluZy5cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdGhhdERhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGFUcmFuc2Zlci5nZXREYXRhKCdkYXRhJykpO1xyXG4gICAgICAgIGlmICh0aGF0RGF0YS50eXBlID09PSBnZXRBdHRyKHRoaXMsICdwcm9maWxlLXR5cGUnKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjcmVhdGVCaW5kaW5nKFt0aGF0RGF0YSwge1xyXG4gICAgICAgICAgICBuYW1lOiBnZXRBdHRyKHRoaXMsICdwcm9maWxlLW5hbWUnKSxcclxuICAgICAgICAgICAgdHlwZTogZ2V0QXR0cih0aGlzLCAncHJvZmlsZS10eXBlJyksXHJcbiAgICAgICAgfV0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgYWxsb3dEcm9wID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgYWxsb3dEcm9wICR7dGhpcy5wcm9maWxlTmFtZX1gKTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVEcmFnRW50ZXIoZXZlbnQpIHtcclxuICAgICAgICBhZGRDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGhhbmRsZURyYWdMZWF2ZShldmVudCkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKHRoaXMsICdvdmVyJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYmluZGluZzJlbChiaW5kaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZWwgPSB3cmFwRWwoJ2RpdicsIHF0ZShgJHtyb290fSAuYmluZGluZy1pdGVtLXRtcGxgKSk7XHJcbiAgICAgICAgYWRkRWwocWVlKGVsLCAnLnByaW1hcnktbmFtZScpLCBtYWtlVGV4dChiaW5kaW5nLm5hbWUpKTtcclxuICAgICAgICBzZXRBdHRyKGVsLCAncHJpbWFyeS1uYW1lJywgYmluZGluZy5uYW1lKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy51bmxpbmsnKSwgJ3RpdGxlJywgbDEwbigndW5saW5rLWJpbmRpbmcnKSk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJy51bmxpbmsnKSwgJ2NsaWNrJywgKCkgPT4gcmVtb3ZlQmluZGluZyhiaW5kaW5nLnZhbHVlKSk7XHJcbiAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBmaWx0ZXJMaXN0ID0gc2VsID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0ciA9IGV2ZW50LnRhcmdldC52YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBjb25zdCBlbHMgPSBxdWVyeUVscyhgJHtyb290fSAke3NlbH0gW3ByaW1hcnktbmFtZV1gKTtcclxuICAgICAgICBlbHMuZm9yRWFjaCgoZWwpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXNWaXNpYmxlID0gZ2V0QXR0cihlbCwgJ3ByaW1hcnktbmFtZScpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihzdHIpICE9PSAtMTtcclxuICAgICAgICAgICAgc2hvd0VsKGVsLCBpc1Zpc2libGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nKHBhaXIpIHtcclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lID0gcGFpclswXS50eXBlID09PSAnY2hhcmFjdGVyJyA/IHBhaXJbMF0ubmFtZSA6IHBhaXJbMV0ubmFtZTtcclxuICAgICAgICBjb25zdCBwbGF5ZXJOYW1lID0gcGFpclswXS50eXBlID09PSAncGxheWVyJyA/IHBhaXJbMF0ubmFtZSA6IHBhaXJbMV0ubmFtZTtcclxuICAgICAgICBEQk1TLmNyZWF0ZUJpbmRpbmcoY2hhcmFjdGVyTmFtZSwgcGxheWVyTmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUJpbmRpbmcoYmluZGluZykge1xyXG4gICAgICAgIERCTVMucmVtb3ZlQmluZGluZyhiaW5kaW5nWzBdLCBiaW5kaW5nWzFdLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuUHJvZmlsZUJpbmRpbmcyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuXHJcbi8vIENoYXJhY3Rlci9QbGF5ZXIgcHJvZmlsZXMgYWxyZWFkeSBoYXZlIGZpZWxkICduYW1lJ1xyXG4vLyBJIGhhZCBzb21lIGNob2ljZXM6XHJcbi8vIDEuIHJlbW92ZSB0aGlzIGZpZWxkIGF0IGFsbFxyXG4vLyAyLiBBZGQgb25lIG1vcmUgb2JqZWN0IHRvIGRpdmlkZSBzcGVjaWFsIHZhbHVlcyAobmFtZSkgYW5kIHVzZXIgZGVmaW5lZCB2YWx1ZXNcclxuLy8gMy4gUHJvaGliaXQgdG8gbWFrZSBmaWVsZCAtIG5hbWVcclxuLy8gMS4gVGhpcyBmaWVsZCBpcyB1c2VkIGluIG1hbnkgcGxhY2VzXHJcbi8vIDIuIC0gdG9vIGNvbXBsZXggd2F5XHJcbi8vIDMuIHNpbXBsZSBhbmQgbGVzc2VyIGNvbXBsZXhpdHksIEkgY2hvb3NlIHRoaXMgd2F5XHJcblxyXG5mdW5jdGlvbiBQcm9maWxlQ29uZmlndXJlclRtcGwoZXhwb3J0cywgb3B0cykge1xyXG4gICAgY29uc3QgeyB0YWJUeXBlIH0gPSBvcHRzO1xyXG5cclxuICAgIGNvbnN0IHRtcGxSb290ID0gJy5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi10bXBsJztcclxuICAgIGNvbnN0IHRhYlJvb3QgPSBgLnByb2ZpbGUtY29uZmlndXJlcjItdGFiLiR7YCR7dGFiVHlwZX0tdHlwZWB9IGA7XHJcbiAgICBjb25zdCBwcm9maWxlUGFuZWwgPSBgJHt0YWJSb290fS5wcm9maWxlLXBhbmVsIGA7XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ3Byb2ZpbGVzJyk7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBlbCA9IHF1ZXJ5RWwodG1wbFJvb3QpLmNsb25lTm9kZSh0cnVlKTtcclxuXHJcbiAgICAgICAgYWRkQ2xhc3NlcyhlbCwgWydwcm9maWxlLWNvbmZpZ3VyZXIyLXRhYicsIGAke2Ake3RhYlR5cGV9LXR5cGVgfWBdKTtcclxuICAgICAgICByZW1vdmVDbGFzcyhlbCwgJ3Byb2ZpbGUtY29uZmlndXJlcjItdGFiLXRtcGwnKTtcclxuICAgICAgICBhZGRFbChxdWVyeUVsKCcudGFiLWNvbnRhaW5lcicpLCBlbCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZVByb2ZpbGVJdGVtRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coXHJcbiAgICAgICAgICAgIGAucHJvZmlsZS1jb25maWd1cmVyMi10YWIuJHtgJHt0YWJUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICBjcmVhdGVQcm9maWxlSXRlbSwge1xyXG4gICAgICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLXByb2ZpbGUtaXRlbS1ib2R5JyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAncHJvZmlsZXMtY3JlYXRlLXByb2ZpbGUtaXRlbScsXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgICAgICAgICAgaW5pdEJvZHk6IChib2R5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsID0gY2xlYXJFbChxZWUoYm9keSwgJy5jcmVhdGUtZW50aXR5LXR5cGUtc2VsZWN0JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGxNYWluU2VsID0gKCkgPT4geyBmaWxsSXRlbVR5cGVzU2VsKGNsZWFyRWwoc2VsKSk7IH07XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsbE1haW5TZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShmaWxsTWFpblNlbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBzdGF0ZS5yZW5hbWVQcm9maWxlSXRlbURpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKFxyXG4gICAgICAgICAgICBgLnByb2ZpbGUtY29uZmlndXJlcjItdGFiLiR7YCR7dGFiVHlwZX0tdHlwZWB9YCxcclxuICAgICAgICAgICAgcmVuYW1lUHJvZmlsZUl0ZW0sIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAncHJvZmlsZXMtZW50ZXItbmV3LXByb2ZpbGUtaXRlbS1uYW1lJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlbmFtZScsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBzdGF0ZS5tb3ZlUHJvZmlsZUl0ZW1EaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhcclxuICAgICAgICAgICAgYC5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi4ke2Ake3RhYlR5cGV9LXR5cGVgfWAsXHJcbiAgICAgICAgICAgIG1vdmVQcm9maWxlSXRlbSwge1xyXG4gICAgICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW92ZS1wcm9maWxlLWl0ZW0tYm9keScsXHJcbiAgICAgICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3Byb2ZpbGVzLW5ldy1wcm9maWxlLWl0ZW0tcG9zaXRpb24nLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tbW92ZScsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLnJlbmFtZUVudW1JdGVtRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coXHJcbiAgICAgICAgICAgIGAucHJvZmlsZS1jb25maWd1cmVyMi10YWIuJHtgJHt0YWJUeXBlfS10eXBlYH1gLFxyXG4gICAgICAgICAgICByZW5hbWVFbnVtVmFsdWUsIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ3JlbmFtZS1lbnVtLXZhbHVlLXRtcGwnLFxyXG4gICAgICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdwcm9maWxlcy1yZW5hbWUtZW51bS1pdGVtJyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlbmFtZScsXHJcbiAgICAgICAgICAgICAgICBpbml0Qm9keTogKGJvZHkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW5hbWVTZWxlY3QgPSBjbGVhckVsKHFlZShib2R5LCAnLnJlbmFtZWQtdmFsdWUtc2VsZWN0JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbmFtZUlucHV0ID0gY2xlYXJFbChxZWUoYm9keSwgJy5lbnVtLXZhbHVlLW5hbWUtaW5wdXQnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuKHJlbmFtZVNlbGVjdCwgJ2NoYW5nZScsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVuYW1lSW5wdXQudmFsdWUgPSByZW5hbWVTZWxlY3QudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLmVudW1FZGl0b3JEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhcclxuICAgICAgICAgICAgYC5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi4ke2Ake3RhYlR5cGV9LXR5cGVgfWAsXHJcbiAgICAgICAgICAgIHVwZGF0ZUVudW1WYWx1ZXMsIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2VudW0tZGlhbG9nLWVkaXRvci10bXBsJyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAncHJvZmlsZXMtZW51bS1lZGl0b3InLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tc2F2ZScsXHJcbiAgICAgICAgICAgICAgICBpbml0Qm9keTogKGJvZHkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRlZFZhbHVlc0FyZWEgPSBxZWUoYm9keSwgJy5uZXctZW51bS12YWx1ZXMnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVkVmFsdWVzQXJlYSA9IHFlZShib2R5LCAnLnJlbW92ZWQtZW51bS12YWx1ZXMnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dEFyZWEgPSBxZWUoYm9keSwgJy5lbnVtLXZhbHVlLWlucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlU2VsZWN0ID0gcWVlKGJvZHksICcuZGVmYXVsdC12YWx1ZS1zZWxlY3QnKTtcclxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW4oaW5wdXRBcmVhLCAnaW5wdXQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHMgPSBpbnB1dEFyZWEudmFsdWUuc3BsaXQoJywnKS5tYXAoUi50cmltKS5maWx0ZXIoUi5waXBlKFIuZXF1YWxzKCcnKSwgUi5ub3QpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkZWRWYWx1ZXMgPSBSLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEsIFIuZGlmZmVyZW5jZShuZXdWYWxzLCBpbnB1dEFyZWEuc3JjTGlzdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChhZGRlZFZhbHVlc0FyZWEpLCBlbnVtTGlzdDJFbHMoYWRkZWRWYWx1ZXMpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlZFZhbHVlcyA9IFIuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSwgUi5kaWZmZXJlbmNlKGlucHV0QXJlYS5zcmNMaXN0LCBuZXdWYWxzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHJlbW92ZWRWYWx1ZXNBcmVhKSwgZW51bUxpc3QyRWxzKHJlbW92ZWRWYWx1ZXMpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWVTZWxlY3QudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRWwoZGVmYXVsdFZhbHVlU2VsZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5ld1ZhbHMubGVuZ3RoID09PSAwKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIVIuY29udGFpbnMoZGVmYXVsdFZhbHVlLCBuZXdWYWxzKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSBuZXdWYWxzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihkZWZhdWx0VmFsdWVTZWxlY3QsIGFycjJTZWxlY3QobmV3VmFscykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBxZWUoZGVmYXVsdFZhbHVlU2VsZWN0LCBgW3ZhbHVlPVwiJHtkZWZhdWx0VmFsdWV9XCJdYCkuc2VsZWN0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5tdWx0aUVudW1FZGl0b3JEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhcclxuICAgICAgICAgICAgYC5wcm9maWxlLWNvbmZpZ3VyZXIyLXRhYi4ke2Ake3RhYlR5cGV9LXR5cGVgfWAsXHJcbiAgICAgICAgICAgIHVwZGF0ZUVudW1WYWx1ZXMsIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ211bHRpLWVudW0tZGlhbG9nLWVkaXRvci10bXBsJyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAncHJvZmlsZXMtbXVsdGktZW51bS1lZGl0b3InLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tc2F2ZScsXHJcbiAgICAgICAgICAgICAgICBpbml0Qm9keTogKGJvZHkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRlZFZhbHVlc0FyZWEgPSBxZWUoYm9keSwgJy5uZXctZW51bS12YWx1ZXMnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVkVmFsdWVzQXJlYSA9IHFlZShib2R5LCAnLnJlbW92ZWQtZW51bS12YWx1ZXMnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dEFyZWEgPSBxZWUoYm9keSwgJy5lbnVtLXZhbHVlLWlucHV0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuKGlucHV0QXJlYSwgJ2lucHV0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWxzID0gaW5wdXRBcmVhLnZhbHVlLnNwbGl0KCcsJykubWFwKFIudHJpbSkuZmlsdGVyKFIucGlwZShSLmVxdWFscygnJyksIFIubm90KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZGVkVmFsdWVzID0gUi5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBLCBSLmRpZmZlcmVuY2UobmV3VmFscywgaW5wdXRBcmVhLnNyY0xpc3QpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwoYWRkZWRWYWx1ZXNBcmVhKSwgZW51bUxpc3QyRWxzKGFkZGVkVmFsdWVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZWRWYWx1ZXMgPSBSLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEsIFIuZGlmZmVyZW5jZShpbnB1dEFyZWEuc3JjTGlzdCwgbmV3VmFscykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChyZW1vdmVkVmFsdWVzQXJlYSksIGVudW1MaXN0MkVscyhyZW1vdmVkVmFsdWVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5wYW5lbCBoMycpLCAnbDEwbi1pZCcsIGBwcm9maWxlcy0ke29wdHMucGFuZWxOYW1lfWApO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLmFsZXJ0JyksICdsMTBuLWlkJywgYGFkdmljZXMtZW1wdHktJHt0YWJUeXBlfS1wcm9maWxlLXN0cnVjdHVyZWApO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoZWwpO1xyXG5cclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5wYW5lbCBhJyksICdwYW5lbC10b2dnbGVyJywgYCR7dGFiUm9vdH0ucHJvZmlsZS1wYW5lbGApO1xyXG4gICAgICAgIFVJLmluaXRQYW5lbFRvZ2dsZXJzKGVsKTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3RhYlJvb3R9LmNyZWF0ZWApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVQcm9maWxlSXRlbURpYWxvZy5zaG93RGxnKCkpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IGVsO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgcmVmcmVzaFBhbmVsKHRhYlR5cGUsIHByb2ZpbGVQYW5lbCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hQYW5lbCh0eXBlLCByb290KSB7XHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKHR5cGUsIChlcnIsIGFsbFByb2ZpbGVTZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYCR7dGFiUm9vdH0gLmFsZXJ0YCksIGFsbFByb2ZpbGVTZXR0aW5ncy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICBoaWRlRWwocXVlcnlFbChgJHt0YWJSb290fSB0YWJsZWApLCBhbGxQcm9maWxlU2V0dGluZ3MubGVuZ3RoID09PSAwKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IGFsbFByb2ZpbGVTZXR0aW5ncy5tYXAoUi5jb21wb3NlKHN0ckZvcm1hdChnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYmVmb3JlJykpLCBSLmFwcGVuZChSLl9fLCBbXSksIFIucHJvcCgnbmFtZScpKSk7XHJcbiAgICAgICAgICAgIGFyci5wdXNoKGdldEwxMG4oJ2NvbW1vbi1zZXQtaXRlbS1hcy1sYXN0JykpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb25TZWxlY3RvcnMgPSBbcXVlcnlFbChgJHt0YWJSb290fSAuY3JlYXRlLWVudGl0eS1wb3NpdGlvbi1zZWxlY3RgKSxcclxuICAgICAgICAgICAgICAgIHF1ZXJ5RWwoYCR7dGFiUm9vdH0gLm1vdmUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdGApXTtcclxuICAgICAgICAgICAgcG9zaXRpb25TZWxlY3RvcnMubWFwKGNsZWFyRWwpLm1hcChmaWxsU2VsZWN0b3IoUi5fXywgYXJyMlNlbGVjdChhcnIpKSkubWFwKHNldFByb3AoUi5fXywgJ3NlbGVjdGVkSW5kZXgnLCBhbGxQcm9maWxlU2V0dGluZ3MubGVuZ3RoKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0YWJsZSA9IGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5wcm9maWxlLWNvbmZpZy1jb250YWluZXJgKSk7XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgYWRkRWxzKHRhYmxlLCBhbGxQcm9maWxlU2V0dGluZ3MubWFwKGdldElucHV0KHR5cGUpKSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycjEpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmhhbmRsZUVycm9yKGVycjEpOyByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0FkbWluKChlcnIyLCBpc0FkbWluKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnYWRtaW5Pbmx5JywgaXNBZG1pbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVByb2ZpbGVJdGVtKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gcWVlKGRpYWxvZywgJy5jcmVhdGUtZW50aXR5LW5hbWUtaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGlucHV0LnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgaXRlbVR5cGUgPSBxZWUoZGlhbG9nLCAnLmNyZWF0ZS1lbnRpdHktdHlwZS1zZWxlY3QnKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgc2VsZWN0ZWRJbmRleCB9ID0gcWVlKGRpYWxvZywgJy5jcmVhdGUtZW50aXR5LXBvc2l0aW9uLXNlbGVjdCcpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlSXRlbSh0YWJUeXBlLCBuYW1lLCBpdGVtVHlwZSwgc2VsZWN0ZWRJbmRleCwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBmaWxsSXRlbVR5cGVzU2VsID0gc2VsID0+IGZpbGxTZWxlY3RvcihzZWwsIGNvbnN0QXJyMlNlbGVjdChSLmtleXMoQ29uc3RhbnRzLnByb2ZpbGVGaWVsZFR5cGVzKSkpO1xyXG4gICAgY29uc3QgZmlsbFBsYXllckFjY2Vzc1NlbCA9IHNlbCA9PiBmaWxsU2VsZWN0b3Ioc2VsLCBjb25zdEFycjJTZWxlY3QoQ29uc3RhbnRzLnBsYXllckFjY2Vzc1R5cGVzKSk7XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIGdldElucHV0ID0gUi5jdXJyeSgodHlwZSwgcHJvZmlsZVNldHRpbmdzLCBpbmRleCkgPT4geyAvLyB0aHJvd3MgSW50ZXJuYWxFcnJvclxyXG4gICAgICAgIGNvbnN0IHJvdyA9IHF0ZShgJHt0YWJSb290fSAucHJvZmlsZS1jb25maWd1cmVyLXJvdy10bXBsYCk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhyb3cpO1xyXG4gICAgICAgIGFkZEVsKHFlZShyb3csICcuaXRlbS1wb3NpdGlvbicpLCBtYWtlVGV4dChpbmRleCArIDEpKTtcclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLml0ZW0tbmFtZScpLCBtYWtlVGV4dChwcm9maWxlU2V0dGluZ3MubmFtZSkpO1xyXG5cclxuICAgICAgICBjb25zdCBpdGVtVHlwZSA9IHFlZShyb3csICcuaXRlbS10eXBlJyk7XHJcbiAgICAgICAgZmlsbEl0ZW1UeXBlc1NlbChpdGVtVHlwZSk7XHJcbiAgICAgICAgaXRlbVR5cGUudmFsdWUgPSBwcm9maWxlU2V0dGluZ3MudHlwZTtcclxuICAgICAgICBpdGVtVHlwZS5pbmZvID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgaXRlbVR5cGUub2xkVHlwZSA9IHByb2ZpbGVTZXR0aW5ncy50eXBlO1xyXG4gICAgICAgIGxpc3RlbihpdGVtVHlwZSwgJ2NoYW5nZScsIGNoYW5nZVByb2ZpbGVJdGVtVHlwZSh0eXBlKSk7XHJcblxyXG4gICAgICAgIGxldCBpbnB1dCwgYWRkRGVmYXVsdExpc3RlbmVyID0gdHJ1ZTtcclxuICAgICAgICBzd2l0Y2ggKHByb2ZpbGVTZXR0aW5ncy50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCd0ZXh0YXJlYScpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnZW51bSc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gcW10ZShgJHt0YWJSb290fSAuZW51bS12YWx1ZS1lZGl0b3ItdG1wbGApO1xyXG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IGxpc3RbMF07XHJcbiAgICAgICAgICAgIGxpc3Quc29ydChDb21tb25VdGlscy5jaGFyT3JkQSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhZGRFbHMocWVlKGlucHV0LCAnLnRleHQnKSwgZW51bUxpc3QyRWxzKGxpc3QsIGRlZmF1bHRWYWx1ZSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGlzdGVuKHFlZShpbnB1dCwgJy5idG4uYWRkJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHFlZShzdGF0ZS5lbnVtRWRpdG9yRGlhbG9nLCAnLmluaXRpYWwtdmFsdWUnKSksIGVudW1MaXN0MkVscyhsaXN0LCBkZWZhdWx0VmFsdWUpKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0QXJlYSA9IHFlZShzdGF0ZS5lbnVtRWRpdG9yRGlhbG9nLCAnLmVudW0tdmFsdWUtaW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIGlucHV0QXJlYS52YWx1ZSA9IGxpc3Quam9pbignLCcpO1xyXG4gICAgICAgICAgICAgICAgaW5wdXRBcmVhLnNyY0xpc3QgPSBsaXN0O1xyXG4gICAgICAgICAgICAgICAgaW5wdXRBcmVhLmRlZmF1bHRWYWx1ZSA9IGRlZmF1bHRWYWx1ZTtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlU2VsZWN0ID0gY2xlYXJFbChxZWUoc3RhdGUuZW51bUVkaXRvckRpYWxvZywgJy5kZWZhdWx0LXZhbHVlLXNlbGVjdCcpKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihkZWZhdWx0VmFsdWVTZWxlY3QsIGFycjJTZWxlY3QobGlzdCkpO1xyXG4gICAgICAgICAgICAgICAgcWVlKGRlZmF1bHRWYWx1ZVNlbGVjdCwgYFt2YWx1ZT1cIiR7ZGVmYXVsdFZhbHVlfVwiXWApLnNlbGVjdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVudW1FZGl0b3JEaWFsb2cuaXRlbU5hbWUgPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmVudW1FZGl0b3JEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxpc3RlbihxZWUoaW5wdXQsICcuYnRuLnJlbmFtZScpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZW5hbWVTZWxlY3QgPSBjbGVhckVsKHFlZShzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZywgJy5yZW5hbWVkLXZhbHVlLXNlbGVjdCcpKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihyZW5hbWVTZWxlY3QsIGFycjJTZWxlY3QobGlzdCkpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZihsaXN0Lmxlbmd0aCA+IDApe1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZywgJy5lbnVtLXZhbHVlLW5hbWUtaW5wdXQnKS52YWx1ZSA9IGxpc3RbMF07IFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZy5pdGVtTmFtZSA9IHByb2ZpbGVTZXR0aW5ncy5uYW1lO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoaW5wdXQpO1xyXG4gICAgICAgICAgICBhZGREZWZhdWx0TGlzdGVuZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgaW5wdXQgPSBxbXRlKGAke3RhYlJvb3R9IC5lbnVtLXZhbHVlLWVkaXRvci10bXBsYCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpc3QyID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgIGxpc3QyLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYWRkRWxzKHFlZShpbnB1dCwgJy50ZXh0JyksIGVudW1MaXN0MkVscyhsaXN0MikpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGlzdGVuKHFlZShpbnB1dCwgJy5idG4uYWRkJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHFlZShzdGF0ZS5tdWx0aUVudW1FZGl0b3JEaWFsb2csICcuaW5pdGlhbC12YWx1ZScpKSwgZW51bUxpc3QyRWxzKGxpc3QyKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dEFyZWEgPSBxZWUoc3RhdGUubXVsdGlFbnVtRWRpdG9yRGlhbG9nLCAnLmVudW0tdmFsdWUtaW5wdXQnKTtcclxuICAgICAgICAgICAgICAgIGlucHV0QXJlYS52YWx1ZSA9IGxpc3QyLmpvaW4oJywnKTtcclxuICAgICAgICAgICAgICAgIGlucHV0QXJlYS5zcmNMaXN0ID0gbGlzdDI7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5tdWx0aUVudW1FZGl0b3JEaWFsb2cuaXRlbU5hbWUgPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLm11bHRpRW51bUVkaXRvckRpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgbGlzdGVuKHFlZShpbnB1dCwgJy5idG4ucmVuYW1lJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbmFtZVNlbGVjdCA9IGNsZWFyRWwocWVlKHN0YXRlLnJlbmFtZUVudW1JdGVtRGlhbG9nLCAnLnJlbmFtZWQtdmFsdWUtc2VsZWN0JykpO1xyXG4gICAgICAgICAgICAgICAgZmlsbFNlbGVjdG9yKHJlbmFtZVNlbGVjdCwgYXJyMlNlbGVjdChsaXN0MikpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZihsaXN0Mi5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgICAgICAgICBxZWUoc3RhdGUucmVuYW1lRW51bUl0ZW1EaWFsb2csICcuZW51bS12YWx1ZS1uYW1lLWlucHV0JykudmFsdWUgPSBsaXN0MlswXTsgXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUVudW1JdGVtRGlhbG9nLml0ZW1OYW1lID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5yZW5hbWVFbnVtSXRlbURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhpbnB1dCk7XHJcbiAgICAgICAgICAgIGFkZERlZmF1bHRMaXN0ZW5lciA9IGZhbHNlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBwcm9maWxlU2V0dGluZ3MudmFsdWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ251bWJlcic7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnZhbHVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAndGl0bGUnLCBsMTBuKCdkZWZhdWx0LXZhbHVlJykpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gJ2NoZWNrYm94JztcclxuICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHByb2ZpbGVTZXR0aW5ncy52YWx1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9ycy5JbnRlcm5hbEVycm9yKCdlcnJvcnMtdW5leHBlY3RlZC1zd2l0Y2gtYXJndW1lbnQnLCBbcHJvZmlsZVNldHRpbmdzLnR5cGVdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNldFByb3BzKGlucHV0LCB7XHJcbiAgICAgICAgICAgIGluZm86IHByb2ZpbGVTZXR0aW5ncy5uYW1lLFxyXG4gICAgICAgICAgICBpbmZvVHlwZTogcHJvZmlsZVNldHRpbmdzLnR5cGUsXHJcbiAgICAgICAgICAgIG9sZFZhbHVlOiBwcm9maWxlU2V0dGluZ3MudmFsdWVcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZihhZGREZWZhdWx0TGlzdGVuZXIpe1xyXG4gICAgICAgICAgICBhZGRDbGFzc2VzKGlucHV0LCBbYHByb2ZpbGUtY29uZmlndXJlci0ke3Byb2ZpbGVTZXR0aW5ncy50eXBlfWAsICdhZG1pbk9ubHknLCAnZm9ybS1jb250cm9sJ10pO1xyXG4gICAgICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCB1cGRhdGVEZWZhdWx0VmFsdWUodHlwZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhZGRFbChxZWUocm93LCAnLml0ZW0tZGVmYXVsdC12YWx1ZS1jb250YWluZXInKSwgaW5wdXQpO1xyXG5cclxuICAgICAgICBzZXRDbGFzc0lmKHFlZShyb3csICcucHJpbnQnKSwgJ2J0bi1wcmltYXJ5JywgcHJvZmlsZVNldHRpbmdzLmRvRXhwb3J0KTtcclxuICAgICAgICBsaXN0ZW4ocWVlKHJvdywgJy5wcmludCcpLCAnY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmRvRXhwb3J0UHJvZmlsZUl0ZW1DaGFuZ2UodHlwZSwgcHJvZmlsZVNldHRpbmdzLm5hbWUsICFoYXNDbGFzcyhlLnRhcmdldCwgJ2J0bi1wcmltYXJ5JyksIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICB0b2dnbGVDbGFzcyhlLnRhcmdldCwgJ2J0bi1wcmltYXJ5Jyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBwbGF5ZXJBY2Nlc3MgPSBxZWUocm93LCAnLnBsYXllci1hY2Nlc3MnKTtcclxuICAgICAgICBmaWxsUGxheWVyQWNjZXNzU2VsKHBsYXllckFjY2Vzcyk7XHJcbiAgICAgICAgcGxheWVyQWNjZXNzLnZhbHVlID0gcHJvZmlsZVNldHRpbmdzLnBsYXllckFjY2VzcztcclxuICAgICAgICBwbGF5ZXJBY2Nlc3MuaW5mbyA9IHByb2ZpbGVTZXR0aW5ncy5uYW1lO1xyXG4gICAgICAgIHBsYXllckFjY2Vzcy5vbGRWYWx1ZSA9IHByb2ZpbGVTZXR0aW5ncy5wbGF5ZXJBY2Nlc3M7XHJcbiAgICAgICAgbGlzdGVuKHBsYXllckFjY2VzcywgJ2NoYW5nZScsIGNoYW5nZVByb2ZpbGVJdGVtUGxheWVyQWNjZXNzKHR5cGUpKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2hvd0luUm9sZUdyaWQgPSBxZWUocm93LCAnLnNob3ctaW4tcm9sZS1ncmlkJyk7XHJcbiAgICAgICAgc2hvd0luUm9sZUdyaWQuY2hlY2tlZCA9IHByb2ZpbGVTZXR0aW5ncy5zaG93SW5Sb2xlR3JpZDtcclxuICAgICAgICBzaG93SW5Sb2xlR3JpZC5pbmZvID0gcHJvZmlsZVNldHRpbmdzLm5hbWU7XHJcbiAgICAgICAgbGlzdGVuKHNob3dJblJvbGVHcmlkLCAnY2hhbmdlJywgc2hvd0luUm9sZUdyaWRDaGFuZ2UodHlwZSkpO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWVlKHJvdywgJy5tb3ZlJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgc3RhdGUuY3VycmVudEluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vdmVQcm9maWxlSXRlbURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZWUocm93LCAnLnJlbmFtZS1wcm9maWxlLWl0ZW0nKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBxZWUoc3RhdGUucmVuYW1lUHJvZmlsZUl0ZW1EaWFsb2csICcuZW50aXR5LWlucHV0JykudmFsdWUgPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICAgICAgc3RhdGUucmVuYW1lUHJvZmlsZUl0ZW1EaWFsb2cuZnJvbU5hbWUgPSBwcm9maWxlU2V0dGluZ3MubmFtZTtcclxuICAgICAgICAgICAgc3RhdGUucmVuYW1lUHJvZmlsZUl0ZW1EaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsaXN0ZW4ocWVlKHJvdywgJy5yZW1vdmUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKEwxMG4uZm9ybWF0KCdwcm9maWxlcycsICdhcmUteW91LXN1cmUtYWJvdXQtcmVtb3ZpbmctcHJvZmlsZS1pdGVtJywgW3Byb2ZpbGVTZXR0aW5ncy5uYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgICAgIERCTVMucmVtb3ZlUHJvZmlsZUl0ZW0odHlwZSwgaW5kZXgsIHByb2ZpbGVTZXR0aW5ncy5uYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGVudW1MaXN0MkVscyhsaXN0LCBkZWZhdWx0VmFsdWUpe1xyXG4gICAgICAgIHJldHVybiBSLnNwbGl0RXZlcnkoNCwgbGlzdC5tYXAodmFsID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dCh2YWwpKTtcclxuICAgICAgICAgICAgaWYoZGVmYXVsdFZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsID09PSBkZWZhdWx0VmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3Moc3BhbiwgJ2JvbGQnKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoc3BhbiwgJ3RpdGxlJywgbDEwbignZGVmYXVsdC12YWx1ZScpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhZGRDbGFzcyhzcGFuLCAnbWFyZ2luLXJpZ2h0LTE2IGVudW0taXRlbScpO1xyXG4gICAgICAgICAgICByZXR1cm4gc3BhbjtcclxuICAgICAgICB9KSkubWFwKGFyciA9PiBhZGRFbHMobWFrZUVsKCdkaXYnKSwgYXJyKSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUpIHtcclxuICAgICAgICByZXR1cm4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBldmVudC50YXJnZXQuaW5mbztcclxuICAgICAgICAgICAgY29uc3QgaXRlbVR5cGUgPSBldmVudC50YXJnZXQuaW5mb1R5cGU7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgb2xkVmFsdWUgfSA9IGV2ZW50LnRhcmdldDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXRlbVR5cGUgPT09ICdjaGVja2JveCcgPyBldmVudC50YXJnZXQuY2hlY2tlZCA6IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIGxldCBuZXdPcHRpb25zLCBtaXNzZWRWYWx1ZXMsIG5ld1ZhbHVlLCB1cGRhdGVFbnVtO1xyXG5cclxuICAgICAgICAgICAgc3dpdGNoIChpdGVtVHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVEZWZhdWx0VmFsdWUodHlwZSwgbmFtZSwgdmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgaWYgKE51bWJlci5pc05hTih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdwcm9maWxlcy1ub3QtYS1udW1iZXInKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVEZWZhdWx0VmFsdWUodHlwZSwgbmFtZSwgTnVtYmVyKHZhbHVlKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ211bHRpRW51bSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAnJyAmJiBpdGVtVHlwZSA9PT0gJ2VudW0nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigncHJvZmlsZXMtZW51bS1pdGVtLWNhbnQtYmUtZW1wdHknKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gb2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbmV3T3B0aW9ucyA9IHZhbHVlLnNwbGl0KCcsJykubWFwKFIudHJpbSk7XHJcbiAgICAgICAgICAgICAgICBtaXNzZWRWYWx1ZXMgPSBvbGRWYWx1ZS50cmltKCkgPT09ICcnID8gW10gOiBSLmRpZmZlcmVuY2Uob2xkVmFsdWUuc3BsaXQoJywnKSwgbmV3T3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdXBkYXRlRW51bSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG5ld09wdGlvbnMuam9pbignLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5vbGRWYWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIERCTVMudXBkYXRlRGVmYXVsdFZhbHVlKHR5cGUsIG5hbWUsIG5ld1ZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtaXNzZWRWYWx1ZXMubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbigncHJvZmlsZXMtbmV3LWVudW0tdmFsdWVzLXJlbW92ZS1zb21lLW9sZC12YWx1ZXMnKSwgW21pc3NlZFZhbHVlcy5qb2luKCcsJyldKSwgdXBkYXRlRW51bSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBvbGRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlRW51bSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihuZXcgRXJyb3JzLkludGVybmFsRXJyb3IoJ2Vycm9ycy11bmV4cGVjdGVkLXN3aXRjaC1hcmd1bWVudCcsIFtpdGVtVHlwZV0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0luUm9sZUdyaWRDaGFuZ2UodHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgREJNUy5zaG93SW5Sb2xlR3JpZFByb2ZpbGVJdGVtQ2hhbmdlKHR5cGUsIGV2ZW50LnRhcmdldC5pbmZvLCBldmVudC50YXJnZXQuY2hlY2tlZCwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVuYW1lUHJvZmlsZUl0ZW0oZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9JbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IG9sZE5hbWUgPSBkaWFsb2cuZnJvbU5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld05hbWUgPSB0b0lucHV0LnZhbHVlLnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lUHJvZmlsZUl0ZW0odGFiVHlwZSwgbmV3TmFtZSwgb2xkTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW92ZVByb2ZpbGVJdGVtKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gc3RhdGUuY3VycmVudEluZGV4O1xyXG4gICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IHF1ZXJ5RWwoYCR7dGFiUm9vdH0ubW92ZS1lbnRpdHktcG9zaXRpb24tc2VsZWN0YCkuc2VsZWN0ZWRJbmRleDtcclxuICAgICAgICAgICAgREJNUy5tb3ZlUHJvZmlsZUl0ZW0odGFiVHlwZSwgaW5kZXgsIG5ld0luZGV4LCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFbnVtVmFsdWVzKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBkaWFsb2cuaXRlbU5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0QXJlYSA9IHFlZShkaWFsb2csICcuZW51bS12YWx1ZS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWVTZWxlY3QgPSBxZWUoZGlhbG9nLCAnLmRlZmF1bHQtdmFsdWUtc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoaW5wdXRBcmVhLnZhbHVlLnRyaW0oKSA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ3Byb2ZpbGVzLWVudW0taXRlbS1jYW50LWJlLWVtcHR5JykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBuZXdWYWxzID0gaW5wdXRBcmVhLnZhbHVlLnNwbGl0KCcsJykubWFwKFIudHJpbSkuZmlsdGVyKFIucGlwZShSLmVxdWFscygnJyksIFIubm90KSk7XHJcbiAgICAgICAgICAgIGlmKGRlZmF1bHRWYWx1ZVNlbGVjdCl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBkZWZhdWx0VmFsdWVTZWxlY3QudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBuZXdWYWxzID0gUi53aXRob3V0KFtkZWZhdWx0VmFsdWVdLCBuZXdWYWxzKTtcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHMgPSBSLnByZXBlbmQoZGVmYXVsdFZhbHVlLCBuZXdWYWxzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgREJNUy51cGRhdGVEZWZhdWx0VmFsdWUodGFiVHlwZSwgbmFtZSwgbmV3VmFscy5qb2luKCcsJyksIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIHJlbmFtZUVudW1WYWx1ZShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZGlhbG9nLml0ZW1OYW1lO1xyXG4gICAgICAgICAgICBjb25zdCByZW5hbWVTZWxlY3QgPSBxZWUoZGlhbG9nLCAnLnJlbmFtZWQtdmFsdWUtc2VsZWN0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlbmFtZUlucHV0ID0gcWVlKGRpYWxvZywgJy5lbnVtLXZhbHVlLW5hbWUtaW5wdXQnKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIERCTVMucmVuYW1lRW51bVZhbHVlKHRhYlR5cGUsIG5hbWUsIHJlbmFtZVNlbGVjdC52YWx1ZS50cmltKCksIHJlbmFtZUlucHV0LnZhbHVlLnRyaW0oKSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjaGFuZ2VQcm9maWxlSXRlbVR5cGUodHlwZSkge1xyXG4gICAgICAgIHJldHVybiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbigncHJvZmlsZXMtYXJlLXlvdS1zdXJlLWFib3V0LWNoYW5naW5nLXByb2ZpbGUtaXRlbS10eXBlJyksIFtldmVudC50YXJnZXQuaW5mb10pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdUeXBlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IGV2ZW50LnRhcmdldC5pbmZvO1xyXG4gICAgICAgICAgICAgICAgREJNUy5jaGFuZ2VQcm9maWxlSXRlbVR5cGUodHlwZSwgbmFtZSwgbmV3VHlwZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBldmVudC50YXJnZXQub2xkVHlwZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjaGFuZ2VQcm9maWxlSXRlbVBsYXllckFjY2Vzcyh0eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwbGF5ZXJBY2Nlc3NUeXBlID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZXZlbnQudGFyZ2V0LmluZm87XHJcbiAgICAgICAgICAgIERCTVMuY2hhbmdlUHJvZmlsZUl0ZW1QbGF5ZXJBY2Nlc3ModHlwZSwgbmFtZSwgcGxheWVyQWNjZXNzVHlwZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LnRhcmdldC5vbGRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5wcm9jZXNzRXJyb3IoKShlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5Qcm9maWxlQ29uZmlndXJlclRtcGwodGhpcy5DaGFyYWN0ZXJDb25maWd1cmVyID0ge30sIHtcclxuICAgIHRhYlR5cGU6ICdjaGFyYWN0ZXInLFxyXG4gICAgcGFuZWxOYW1lOiAnY2hhcmFjdGVycy1wcm9maWxlLXN0cnVjdHVyZScsXHJcbn0pO1xyXG5cclxuUHJvZmlsZUNvbmZpZ3VyZXJUbXBsKHRoaXMuUGxheWVyQ29uZmlndXJlciA9IHt9LCB7XHJcbiAgICB0YWJUeXBlOiAncGxheWVyJyxcclxuICAgIHBhbmVsTmFtZTogJ3BsYXllcnMtcHJvZmlsZS1zdHJ1Y3R1cmUnLFxyXG59KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxOCBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmZ1bmN0aW9uIFByb2ZpbGVFZGl0b3JUbXBsKGV4cG9ydHMsIG9wdHMpIHtcclxuICAgIGNvbnN0IHsgZmlyc3RUeXBlLCBzZWNvbmRUeXBlLCBzZXR0aW5nc1BhdGggfSA9IG9wdHM7XHJcblxyXG4gICAgY29uc3QgdG1wbFJvb3QgPSAnLnByb2ZpbGUtZWRpdG9yMi10YWItdG1wbCc7XHJcbiAgICBjb25zdCByb290ID0gYC5wcm9maWxlLWVkaXRvcjItdGFiLiR7YCR7Zmlyc3RUeXBlfS10eXBlYH0gYDtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCBsMTBuID0gTDEwbi5nZXQoJ3Byb2ZpbGVzJyk7XHJcbiAgICBsZXQgcHJvZmlsZUVkaXRvckNvcmU7XHJcbiAgICBjb25zdCBwcm9maWxlUGFuZWwgPSBgJHtyb290fS5wcm9maWxlLXBhbmVsYDtcclxuICAgIGNvbnN0IHJlcG9ydEJ5U3RvcmllcyA9IGAke3Jvb3R9LnJlcG9ydC1ieS1zdG9yaWVzYDtcclxuICAgIGNvbnN0IHJlcG9ydEJ5UmVsYXRpb25zID0gYCR7cm9vdH0ucmVwb3J0LWJ5LXJlbGF0aW9uc2A7XHJcbiAgICBjb25zdCBwcm9maWxlRGl2ID0gYCR7cm9vdH0ucHJvZmlsZS1kaXZgO1xyXG4gICAgY29uc3QgcmVwb3J0QnlTdG9yaWVzRGl2ID0gYCR7cm9vdH0ucmVwb3J0LWJ5LXN0b3JpZXMtZGl2IHRib2R5YDtcclxuICAgIGNvbnN0IHJlcG9ydEJ5UmVsYXRpb25zRGl2ID0gYCR7cm9vdH0ucmVwb3J0LWJ5LXJlbGF0aW9ucy1kaXYgdGJvZHlgO1xyXG4gICAgY29uc3QgYWxlcnRCbG9jayA9IGAke3Jvb3R9LmFsZXJ0LWJsb2NrYDtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUgPSBQcm9maWxlRWRpdG9yQ29yZS5tYWtlUHJvZmlsZUVkaXRvckNvcmUoKTtcclxuICAgICAgICBjb25zdCBlbCA9IHF1ZXJ5RWwodG1wbFJvb3QpLmNsb25lTm9kZSh0cnVlKTtcclxuXHJcbiAgICAgICAgYWRkQ2xhc3NlcyhlbCwgWydwcm9maWxlLWVkaXRvcjItdGFiJywgYCR7YCR7Zmlyc3RUeXBlfS10eXBlYH1gXSk7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MoZWwsICdwcm9maWxlLWVkaXRvcjItdGFiLXRtcGwnKTtcclxuICAgICAgICBhZGRFbChxdWVyeUVsKCcudGFiLWNvbnRhaW5lcicpLCBlbCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZUNoYXJhY3RlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKFxyXG4gICAgICAgICAgICBgLnByb2ZpbGUtZWRpdG9yMi10YWIuJHtgJHtmaXJzdFR5cGV9LXR5cGVgfWAsXHJcbiAgICAgICAgICAgIGNyZWF0ZVByb2ZpbGUsIHtcclxuICAgICAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiBgcHJvZmlsZXMtJHtvcHRzLmNyZWF0ZU1zZ31gLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYCR7cm9vdH0gLmNyZWF0ZWApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVDaGFyYWN0ZXJEaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBzdGF0ZS5yZW5hbWVDaGFyYWN0ZXJEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhgLiR7YCR7Zmlyc3RUeXBlfS10eXBlYH1gLCByZW5hbWVQcm9maWxlLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ21vZGFsLXByb21wdC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6IGBwcm9maWxlcy0ke29wdHMucmVuYW1lTXNnfWAsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlbmFtZScsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGhpZGVFbChxZWUoZWwsICcucmVwb3J0LWJ5LXN0b3JpZXMnKSwgZmlyc3RUeXBlID09PSAncGxheWVyJyk7XHJcbiAgICAgICAgaGlkZUVsKHFlZShlbCwgJy5yZXBvcnQtYnktcmVsYXRpb25zJyksIGZpcnN0VHlwZSA9PT0gJ3BsYXllcicpO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLmVudGl0eS1maWx0ZXInKSwgJ2wxMG4tcGxhY2Vob2xkZXItaWQnLCBgcHJvZmlsZXMtJHtvcHRzLmZpbHRlclBsYWNlaG9sZGVyfWApO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnByb2ZpbGUtcGFuZWwgaDMnKSwgJ2wxMG4taWQnLCBgcHJvZmlsZXMtJHtvcHRzLnBhbmVsTmFtZX1gKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5jcmVhdGUnKSwgJ2wxMG4tdGl0bGUnLCBgcHJvZmlsZXMtJHtvcHRzLmNyZWF0ZVByb2ZpbGV9YCk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcuYWxlcnQtYmxvY2snKSwgJ2wxMG4taWQnLCBgYWR2aWNlcy1uby0ke2ZpcnN0VHlwZX1gKTtcclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKGVsKTtcclxuXHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucmVwb3J0LWJ5LXN0b3JpZXMgYScpLCAncGFuZWwtdG9nZ2xlcicsIGAke3Jvb3R9LnJlcG9ydC1ieS1zdG9yaWVzLWRpdmApO1xyXG4gICAgICAgIHNldEF0dHIocWVlKGVsLCAnLnJlcG9ydC1ieS1yZWxhdGlvbnMgYScpLCAncGFuZWwtdG9nZ2xlcicsIGAke3Jvb3R9LnJlcG9ydC1ieS1yZWxhdGlvbnMtZGl2YCk7XHJcbiAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucHJvZmlsZS1wYW5lbCBhJyksICdwYW5lbC10b2dnbGVyJywgYCR7cm9vdH0ucHJvZmlsZS1kaXZgKTtcclxuICAgICAgICBVSS5pbml0UGFuZWxUb2dnbGVycyhlbCk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IGVsO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktZmlsdGVyYCksICdpbnB1dCcsIGZpbHRlck9wdGlvbnMpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoZmlyc3RUeXBlLCBmYWxzZSwgKGVyciwgcHJpbWFyeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KHNlY29uZFR5cGUsIGZhbHNlLCAoZXJyMiwgc2Vjb25kYXJ5TmFtZXMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UHJvZmlsZUJpbmRpbmdzKChlcnIzLCBwcm9maWxlQmluZGluZ3MpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvZmlsZUJpbmRpbmdzID0gb3B0cy5wcm9jZXNzQmluZGluZ3MocHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGVFbChxdWVyeUVsKGAke3Jvb3R9LmVudGl0eS1maWx0ZXJgKSwgcHJpbWFyeU5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UocHJpbWFyeU5hbWVzLCBzZWNvbmRhcnlOYW1lcywgcHJvZmlsZUJpbmRpbmdzKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcmVidWlsZEludGVyZmFjZShwcmltYXJ5TmFtZXMsIHNlY29uZGFyeU5hbWVzLCBwcm9maWxlQmluZGluZ3MpIHtcclxuICAgICAgICBjb25zdCBzZWNEaWN0ID0gUi5pbmRleEJ5KFIucHJvcCgndmFsdWUnKSwgc2Vjb25kYXJ5TmFtZXMpO1xyXG4gICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0gLmVudGl0eS1saXN0YCkpLCBwcmltYXJ5TmFtZXMubWFwKChuYW1lLCBpLCBhcnIpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZWwgPSB3cmFwRWwoJ2RpdicsIHF0ZShgJHtyb290fSAuZW50aXR5LWl0ZW0tdG1wbGApKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKGVsLCAnLnByaW1hcnktbmFtZScpLCBtYWtlVGV4dChuYW1lLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnLCBuYW1lLmRpc3BsYXlOYW1lKTtcclxuICAgICAgICAgICAgc2V0QXR0cihlbCwgJ3Byb2ZpbGUtbmFtZScsIG5hbWUudmFsdWUpO1xyXG4gICAgICAgICAgICBpZiAocHJvZmlsZUJpbmRpbmdzW25hbWUudmFsdWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZGFyeU5hbWUgPSBzZWNEaWN0W3Byb2ZpbGVCaW5kaW5nc1tuYW1lLnZhbHVlXV0uZGlzcGxheU5hbWU7XHJcbiAgICAgICAgICAgICAgICBhZGRFbChxZWUoZWwsICcuc2Vjb25kYXJ5LW5hbWUnKSwgbWFrZVRleHQoc2Vjb25kYXJ5TmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihlbCwgJ3NlY29uZGFyeS1uYW1lJywgc2Vjb25kYXJ5TmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5zZWxlY3QtYnV0dG9uJyksICdjbGljaycsICgpID0+IHNlbGVjdFByb2ZpbGUobmFtZS52YWx1ZSkpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5yZW5hbWUnKSwgJ3RpdGxlJywgbDEwbihvcHRzLnJlbmFtZVByb2ZpbGUpKTtcclxuICAgICAgICAgICAgY29uc3QgcmVtb3ZlQnRuID0gcWVlKGVsLCAnLnJlbW92ZScpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKHJlbW92ZUJ0biwgJ3RpdGxlJywgbDEwbihvcHRzLnJlbW92ZVByb2ZpbGUpKTtcclxuICAgICAgICAgICAgaWYoaSsxIDwgYXJyLmxlbmd0aCl7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVCdG4ubmV4dE5hbWUgPSBhcnJbaSsxXS52YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihpID4gMCl7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVCdG4ucHJldk5hbWUgPSBhcnJbaS0xXS52YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobmFtZS5lZGl0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5yZW5hbWUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShzdGF0ZS5yZW5hbWVDaGFyYWN0ZXJEaWFsb2csICcuZW50aXR5LWlucHV0JykudmFsdWUgPSBuYW1lLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLnJlbmFtZUNoYXJhY3RlckRpYWxvZy5mcm9tTmFtZSA9IG5hbWUudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucmVuYW1lQ2hhcmFjdGVyRGlhbG9nLnNob3dEbGcoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKHJlbW92ZUJ0biwgJ2NsaWNrJywgcmVtb3ZlUHJvZmlsZShmaXJzdFR5cGUsIG5hbWUudmFsdWUsIHJlbW92ZUJ0bikpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihxZWUoZWwsICcucmVuYW1lJyksICdkaXNhYmxlZCcsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihyZW1vdmVCdG4sICdkaXNhYmxlZCcsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBlbDtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4ge1xyXG4gICAgICAgICAgICBzZWxlY3RQcm9maWxlKFVJLmNoZWNrQW5kR2V0RW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIHByaW1hcnlOYW1lcykpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgREJNUy5nZXRQcm9maWxlU3RydWN0dXJlKGZpcnN0VHlwZSwgKGVycjIsIGFsbFByb2ZpbGVTZXR0aW5ncykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmluaXRQcm9maWxlU3RydWN0dXJlKHByb2ZpbGVEaXYsIGZpcnN0VHlwZSwgYWxsUHJvZmlsZVNldHRpbmdzLCBjYWxsYmFjayk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc2VsZWN0UHJvZmlsZShuYW1lKSB7XHJcbiAgICAgICAgaGlkZUVsKHF1ZXJ5RWwocHJvZmlsZVBhbmVsKSwgbmFtZSA9PT0gbnVsbCk7XHJcbiAgICAgICAgaGlkZUVsKHF1ZXJ5RWwocmVwb3J0QnlTdG9yaWVzKSwgbmFtZSA9PT0gbnVsbCB8fCBmaXJzdFR5cGUgPT09ICdwbGF5ZXInKTtcclxuICAgICAgICBoaWRlRWwocXVlcnlFbChyZXBvcnRCeVJlbGF0aW9ucyksIG5hbWUgPT09IG51bGwgfHwgZmlyc3RUeXBlID09PSAncGxheWVyJyk7XHJcbiAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYWxlcnRCbG9jayksIG5hbWUgIT09IG51bGwpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKG5hbWUgPT09IG51bGwpe1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCBuYW1lKTtcclxuICAgICAgICBxdWVyeUVscyhgJHtyb290fSBbcHJvZmlsZS1uYW1lXSAuc2VsZWN0LWJ1dHRvbmApLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnYnRuLXByaW1hcnknKSk7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKGAke3Jvb3R9IFtwcm9maWxlLW5hbWU9XCIke25hbWV9XCJdIC5zZWxlY3QtYnV0dG9uYCk7XHJcbiAgICAgICAgYWRkQ2xhc3MoZWwsICdidG4tcHJpbWFyeScpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHBhcmVudEVsID0gZWwucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUxpc3QgPSBxdWVyeUVsKGAke3Jvb3R9IC5lbnRpdHktbGlzdGApO1xyXG4gICAgICAgIFVJLnNjcm9sbFRvKGVudGl0eUxpc3QsIHBhcmVudEVsKTtcclxuICAgICAgICBcclxuICAgICAgICBEQk1TLmdldFByb2ZpbGUoZmlyc3RUeXBlLCBuYW1lLCAoZXJyLCBwcm9maWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKGZpcnN0VHlwZSwgbmFtZSwgKGVycjIsIGlzUHJvZmlsZUVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyMikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhxdWVyeUVsKHByb2ZpbGVEaXYpLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICBwcm9maWxlRWRpdG9yQ29yZS5maWxsUHJvZmlsZUluZm9ybWF0aW9uKHByb2ZpbGVEaXYsIGZpcnN0VHlwZSwgcHJvZmlsZSwgKCkgPT4gaXNQcm9maWxlRWRpdGFibGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChmaXJzdFR5cGUgPT09ICdjaGFyYWN0ZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRDaGFyYWN0ZXJSZXBvcnQobmFtZSwgKGVycjMsIGNoYXJhY3RlclJlcG9ydCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIERCTVMuZ2V0UmVsYXRpb25zU3VtbWFyeShuYW1lLCAoZXJyNCwgcmVsYXRpb25zU3VtbWFyeSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjQpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyNCk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlRWwocXVlcnlFbChgJHtyZXBvcnRCeVN0b3JpZXN9IC5hbGVydGApLCBjaGFyYWN0ZXJSZXBvcnQubGVuZ3RoICE9PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGVFbChxdWVyeUVsKGAke3JlcG9ydEJ5U3Rvcmllc30gdGFibGVgKSwgY2hhcmFjdGVyUmVwb3J0Lmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNoYXJhY3RlclJlcG9ydC5sZW5ndGggIT09IDApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwocmVwb3J0QnlTdG9yaWVzRGl2KSwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChyZXBvcnRCeVN0b3JpZXNEaXYpKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlclJlcG9ydC5tYXAoQ2hhcmFjdGVyUmVwb3J0cy5tYWtlU3RvcnlSZXBvcnRSb3cpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYCR7cmVwb3J0QnlSZWxhdGlvbnN9IC5hbGVydGApLCByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlkZUVsKHF1ZXJ5RWwoYCR7cmVwb3J0QnlSZWxhdGlvbnN9IHRhYmxlYCksIHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zLmxlbmd0aCA9PT0gMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlbGF0aW9uc1N1bW1hcnkucmVsYXRpb25zLmxlbmd0aCAhPT0gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MocXVlcnlFbChyZXBvcnRCeVJlbGF0aW9uc0RpdiksICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxhdGlvbnNTdW1tYXJ5LnJlbGF0aW9ucy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShyZWwgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFByb2plY3RVdGlscy5nZXQybmRSZWxDaGFyKG5hbWUsIHJlbCkudG9Mb3dlckNhc2UoKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwocmVwb3J0QnlSZWxhdGlvbnNEaXYpKSwgcmVsYXRpb25zU3VtbWFyeS5yZWxhdGlvbnNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoQ2hhcmFjdGVyUmVwb3J0cy5tYWtlUmVsYXRpb25SZXBvcnRSb3cobmFtZSkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbHRlck9wdGlvbnMoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBzdHIgPSBldmVudC50YXJnZXQudmFsdWUudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZWxzID0gcXVlcnlFbHMoYCR7cm9vdH0gW3ByaW1hcnktbmFtZV1gKTtcclxuICAgICAgICBlbHMuZm9yRWFjaCgoZWwpID0+IHtcclxuICAgICAgICAgICAgbGV0IGlzVmlzaWJsZSA9IGdldEF0dHIoZWwsICdwcmltYXJ5LW5hbWUnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc3RyKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIGlmICghaXNWaXNpYmxlICYmIGdldEF0dHIoZWwsICdzZWNvbmRhcnktbmFtZScpICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBpc1Zpc2libGUgPSBnZXRBdHRyKGVsLCAnc2Vjb25kYXJ5LW5hbWUnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc3RyKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaGlkZUVsKGVsLCAhaXNWaXNpYmxlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKHF1ZXJ5RWwoYCR7cm9vdH0gLmhpZGRlbltwcmltYXJ5LW5hbWVdIC5zZWxlY3QtYnV0dG9uLmJ0bi1wcmltYXJ5YCkgIT09IG51bGwgfHxcclxuICAgICAgICAgICAgcXVlcnlFbChgJHtyb290fSBbcHJpbWFyeS1uYW1lXSAuc2VsZWN0LWJ1dHRvbi5idG4tcHJpbWFyeWApID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVsczIgPSBxdWVyeUVscyhgJHtyb290fSBbcHJpbWFyeS1uYW1lXWApLmZpbHRlcihSLnBpcGUoaGFzQ2xhc3MoUi5fXywgJ2hpZGRlbicpLCBSLm5vdCkpO1xyXG4gICAgICAgICAgICBzZWxlY3RQcm9maWxlKGVsczIubGVuZ3RoID4gMCA/IGdldEF0dHIoZWxzMlswXSwgJ3Byb2ZpbGUtbmFtZScpIDogbnVsbCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9IFtwcmltYXJ5LW5hbWVdIC5zZWxlY3QtYnV0dG9uLmJ0bi1wcmltYXJ5YCkuc2Nyb2xsSW50b1ZpZXcoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlUHJvZmlsZShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbnB1dCA9IHFlZShkaWFsb2csICcuZW50aXR5LWlucHV0Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5jcmVhdGVQcm9maWxlKGZpcnN0VHlwZSwgdmFsdWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIFVJLnVwZGF0ZUVudGl0eVNldHRpbmcoc2V0dGluZ3NQYXRoLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goKGVycjIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVQcm9maWxlKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvSW5wdXQgPSBxZWUoZGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCB7IGZyb21OYW1lIH0gPSBkaWFsb2c7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5yZW5hbWVQcm9maWxlKGZpcnN0VHlwZSwgZnJvbU5hbWUsIHRvTmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIHRvTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVtb3ZlUHJvZmlsZSh0eXBlLCBuYW1lLCBidG4pIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChsMTBuKG9wdHMucmVtb3ZlTXNnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVQcm9maWxlKHR5cGUsIG5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYnRuLm5leHROYW1lICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGJ0bi5uZXh0TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihidG4ucHJldk5hbWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVUkudXBkYXRlRW50aXR5U2V0dGluZyhzZXR0aW5nc1BhdGgsIGJ0bi5wcmV2TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuXHJcblByb2ZpbGVFZGl0b3JUbXBsKHRoaXMuQ2hhcmFjdGVyRWRpdG9yID0ge30sIHtcclxuICAgIGZpcnN0VHlwZTogJ2NoYXJhY3RlcicsXHJcbiAgICBzZWNvbmRUeXBlOiAncGxheWVyJyxcclxuICAgIHNldHRpbmdzUGF0aDogJ0NoYXJhY3RlcnMnLFxyXG4gICAgcHJvY2Vzc0JpbmRpbmdzOiBSLmlkZW50aXR5LFxyXG4gICAgY3JlYXRlTXNnOiAnZW50ZXItY2hhcmFjdGVyLW5hbWUnLFxyXG4gICAgcmVuYW1lTXNnOiAnZW50ZXItbmV3LWNoYXJhY3Rlci1uYW1lJyxcclxuICAgIHJlbW92ZU1zZzogJ2FyZS15b3Utc3VyZS1hYm91dC1jaGFyYWN0ZXItcmVtb3ZpbmcnLFxyXG4gICAgZmlsdGVyUGxhY2Vob2xkZXI6ICdmaW5kLWNoYXJhY3RlcicsXHJcbiAgICBwYW5lbE5hbWU6ICdjaGFyYWN0ZXItcHJvZmlsZScsXHJcbiAgICBjcmVhdGVQcm9maWxlOiAnY3JlYXRlLWNoYXJhY3RlcicsXHJcbiAgICByZW5hbWVQcm9maWxlOiAncmVuYW1lLWNoYXJhY3RlcicsXHJcbiAgICByZW1vdmVQcm9maWxlOiAncmVtb3ZlLWNoYXJhY3RlcicsXHJcbn0pO1xyXG5cclxuUHJvZmlsZUVkaXRvclRtcGwodGhpcy5QbGF5ZXJFZGl0b3IgPSB7fSwge1xyXG4gICAgZmlyc3RUeXBlOiAncGxheWVyJyxcclxuICAgIHNlY29uZFR5cGU6ICdjaGFyYWN0ZXInLFxyXG4gICAgc2V0dGluZ3NQYXRoOiAnUGxheWVycycsXHJcbiAgICBwcm9jZXNzQmluZGluZ3M6IFIuaW52ZXJ0T2JqLFxyXG4gICAgY3JlYXRlTXNnOiAnZW50ZXItcGxheWVyLW5hbWUnLFxyXG4gICAgcmVuYW1lTXNnOiAnZW50ZXItbmV3LXBsYXllci1uYW1lJyxcclxuICAgIHJlbW92ZU1zZzogJ2FyZS15b3Utc3VyZS1hYm91dC1wbGF5ZXItcmVtb3ZpbmcnLFxyXG4gICAgZmlsdGVyUGxhY2Vob2xkZXI6ICdmaW5kLXBsYXllcicsXHJcbiAgICBwYW5lbE5hbWU6ICdwbGF5ZXItcHJvZmlsZScsXHJcbiAgICBjcmVhdGVQcm9maWxlOiAnY3JlYXRlLXBsYXllcicsXHJcbiAgICByZW5hbWVQcm9maWxlOiAncmVuYW1lLXBsYXllcicsXHJcbiAgICByZW1vdmVQcm9maWxlOiAncmVtb3ZlLXBsYXllcicsXHJcbn0pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5yb2xlLWdyaWQtdGFiICc7XHJcbiAgICBsZXQgZ3JvdXBpbmdPcmRlcjtcclxuICAgIGxldCBwcm9maWxlc0RhdGE7XHJcbiAgICBsZXQgYnV0dG9ucztcclxuICAgIGNvbnN0IGwxMG4gPSBMMTBuLmdldCgncm9sZS1ncmlkJyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldFJvbGVHcmlkSW5mbygoZXJyLCBkYXRhMikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBncm91cGluZ09yZGVyID0gW107XHJcbiAgICAgICAgICAgIGJ1dHRvbnMgPSBbXTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnQubm8tY2hhcmFjdGVyLXByb2ZpbGVgKSwgZGF0YTIuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZS5sZW5ndGggPT09IDApO1xyXG4gICAgICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0Lm5vLWNoYXJhY3RlcnNgKSwgZGF0YTIucHJvZmlsZURhdGEubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHNob3dFbChxZShgJHtyb290fSA+IC5jb250YWluZXItZmx1aWRgKSwgZGF0YTIucHJvZmlsZURhdGEubGVuZ3RoICE9PSAwICYmIGRhdGEyLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUubGVuZ3RoICE9PSAwKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGhhY2sgLSBkeW5hbWljYWxseSByZXBsYWNlIGNoZWNrYm94IHdpdGggZW51bVxyXG4gICAgICAgICAgICBjb25zdCBjaGVja2JveGVzID0gZGF0YTIuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZS5maWx0ZXIoZWwgPT4gZWwudHlwZSA9PT0gJ2NoZWNrYm94JykubWFwKFIucHJvcCgnbmFtZScpKTtcclxuICAgICAgICAgICAgZGF0YTIuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSA9IGRhdGEyLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUubWFwKChlbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVsLnR5cGUgPT09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb0V4cG9ydDogZWwuZG9FeHBvcnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGVsLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllckFjY2VzczogZWwucGxheWVyQWNjZXNzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93SW5Sb2xlR3JpZDogZWwuc2hvd0luUm9sZUdyaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlbnVtJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtMMTBuLmdldCgnY29uc3RhbnQnLCAneWVzJyksIEwxMG4uZ2V0KCdjb25zdGFudCcsICdubycpXS5qb2luKCcsJyksXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBlbDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHByb2ZpbGVzRGF0YSA9IGRhdGEyO1xyXG4gICAgICAgICAgICBkYXRhMi5wcm9maWxlRGF0YS5mb3JFYWNoKChlbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY2hlY2tib3hlcy5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWwuY2hhcmFjdGVyW25hbWVdID0gTDEwbi5nZXQoJ2NvbnN0YW50JywgZWwuY2hhcmFjdGVyW25hbWVdID09PSB0cnVlID8gJ3llcycgOiAnbm8nKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNvcnRlciA9IENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShhID0+IGEudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlciA9IGVsID0+IGVsLnR5cGUgPT09ICdlbnVtJztcclxuICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdJdGVtcyA9IHByb2ZpbGVzRGF0YS5jaGFyYWN0ZXJQcm9maWxlU3RydWN0dXJlLmZpbHRlcihmaWx0ZXIpLm1hcChSLnByb3AoJ25hbWUnKSkuc29ydChzb3J0ZXIpO1xyXG5cclxuICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5idXR0b24tY29udGFpbmVyYCkpLCBncm91cGluZ0l0ZW1zLm1hcCgoaXRlbSwgaSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnV0dG9uID0gYWRkRWwobWFrZUVsKCdhJyksIG1ha2VUZXh0KGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgIGJ1dHRvbi5pdGVtID0gaXRlbTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoYnV0dG9uLCAnZHJhZ2dhYmxlJywgJ3RydWUnKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoYnV0dG9uLCAncm9sZScsICdidXR0b24nKTtcclxuICAgICAgICAgICAgICAgIHNldEF0dHIoYnV0dG9uLCAnaHJlZicsICcjJyk7XHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgJ29yZGVyJywgaSArIDEpO1xyXG4gICAgICAgICAgICAgICAgc2V0U3R5bGUoYnV0dG9uLCAnb3JkZXInLCBpICsgMSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzc2VzKGJ1dHRvbiwgWydidG4nLCAnYnRuLWRlZmF1bHQnXSk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnZHJhZ3N0YXJ0Jywgb25EcmFnU3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2Ryb3AnLCBvbkRyb3ApO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2RyYWdvdmVyJywgYWxsb3dEcm9wKTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdkcmFnZW50ZXInLCBoYW5kbGVEcmFnRW50ZXIpO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2RyYWdsZWF2ZScsIGhhbmRsZURyYWdMZWF2ZSk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlQ2xhc3MoYnV0dG9uLCAnYnRuLXByaW1hcnknKTtcclxuICAgICAgICAgICAgICAgICAgICBkcmF3TGlzdCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBidXR0b25zLnB1c2goYnV0dG9uKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBidXR0b247XHJcbiAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgICAgIGRyYXdMaXN0KCk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgZHJhd1BsYWluUGFuZWxMaXN0KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBvbkRyYWdTdGFydCA9IGZ1bmN0aW9uIChldmVudCl7XHJcbiAgICAgICAgY29uc29sZS5sb2coYG9uRHJhZ1N0YXJ0ICR7dGhpcy5pdGVtfWApO1xyXG4gICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREYXRhKCdkYXRhJywgSlNPTi5zdHJpbmdpZnkoeyBpdGVtOiB0aGlzLml0ZW0sIG9yZGVyOiBnZXRBdHRyKHRoaXMsICdvcmRlcicpIH0pKTtcclxuICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZWZmZWN0QWxsb3dlZCA9ICdtb3ZlJztcclxuICAgIH07XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIG9uRHJvcCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBvbkRyb3AgJHt0aGlzLml0ZW19JHtldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpfWApO1xyXG4gICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHtcclxuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IC8vIHN0b3BzIHRoZSBicm93c2VyIGZyb20gcmVkaXJlY3RpbmcuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHVwZGF0ZUJ1dHRvbnMoSlNPTi5wYXJzZShldmVudC5kYXRhVHJhbnNmZXIuZ2V0RGF0YSgnZGF0YScpKSwgeyBpdGVtOiB0aGlzLml0ZW0sIG9yZGVyOiBnZXRBdHRyKHRoaXMsICdvcmRlcicpIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgYWxsb3dEcm9wID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGFsbG93RHJvcCAke3RoaXMuaXRlbX1gKTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBoYW5kbGVEcmFnRW50ZXIoZXZlbnQpIHtcclxuICAgICAgICBhZGRDbGFzcyh0aGlzLCAnb3ZlcicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGhhbmRsZURyYWdMZWF2ZShldmVudCkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKHRoaXMsICdvdmVyJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXZhcix2YXJzLW9uLXRvcFxyXG4gICAgdmFyIHVwZGF0ZUJ1dHRvbnMgPSAoZHJhZ1N0YXJ0ZXIsIGRyYWdSZWNlaXZlcikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0T3JkZXIgPSBOdW1iZXIoZHJhZ1N0YXJ0ZXIub3JkZXIpIC0gMTtcclxuICAgICAgICBjb25zdCByZWNlaXZlT3JkZXIgPSBOdW1iZXIoZHJhZ1JlY2VpdmVyLm9yZGVyKSAtIDE7XHJcbiAgICAgICAgY29uc3QgYnV0dG9uID0gYnV0dG9ucy5zcGxpY2Uoc3RhcnRPcmRlciwgMSlbMF07XHJcbiAgICAgICAgYnV0dG9ucyA9IFIuaW5zZXJ0KHJlY2VpdmVPcmRlciwgYnV0dG9uLCBidXR0b25zKTtcclxuICAgICAgICBidXR0b25zLmZvckVhY2goKGJ1dHRvbjIsIGkpID0+IHtcclxuICAgICAgICAgICAgc2V0QXR0cihidXR0b24yLCAnb3JkZXInLCBpICsgMSk7XHJcbiAgICAgICAgICAgIHNldFN0eWxlKGJ1dHRvbjIsICdvcmRlcicsIGkgKyAxKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBkcmF3TGlzdCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgZHJhd0xpc3QgPSAoKSA9PiB7XHJcbiAgICAgICAgZ3JvdXBpbmdPcmRlciA9IGJ1dHRvbnMuZmlsdGVyKGhhc0NsYXNzKFIuX18sICdidG4tcHJpbWFyeScpKS5tYXAoUi5wcm9wKCdpdGVtJykpO1xyXG4gICAgICAgIGRyYXdHcm91cGVkTGlzdCgoZ3JvdXBpbmdPcmRlci5sZW5ndGggPiAwKSA/IGdldFRyZWVCeVVzZXJTZWxlY3QoKSA6IGdldFRyZWVCeUFscGhhYmV0KCkpO1xyXG4gICAgICAgIC8vICAgICAgICAoZ3JvdXBpbmdPcmRlci5sZW5ndGggPiAwKSA/IGRyYXdHcm91cGVkTGlzdCgpIDogZHJhd1BsYWluUGFuZWxMaXN0KCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBnZXRUcmVlQnlBbHBoYWJldCA9ICgpID0+XHJcbiAgICAgICAgLy8gICAgICAgIHZhciBncm91cHMgPSBSLmdyb3VwQnkoKHByb2ZpbGUpID0+IHtcclxuICAgICAgICAvLyAgICAgICAgICAgIHJldHVybiBwcm9maWxlLmNoYXJhY3Rlck5hbWVbMF07XHJcbiAgICAgICAgLy8gICAgICAgIH0sIHByb2ZpbGVzRGF0YS5wcm9maWxlRGF0YSk7XHJcbiAgICAgICAgLy9cclxuICAgICAgICAvLyAgICAgICAgdmFyIHN0cnVjdHVyZXMgPSBSLnRvUGFpcnMoZ3JvdXBzKS5tYXAocGFpciA9PiAoe1xyXG4gICAgICAgIC8vICAgICAgICAgICAga2V5OiBwYWlyWzBdLFxyXG4gICAgICAgIC8vICAgICAgICAgICAgbGFzdEtleVBhcnQ6IHBhaXJbMF0sXHJcbiAgICAgICAgLy8gICAgICAgICAgICBncm91cHM6IHBhaXJbMV1cclxuICAgICAgICAvLyAgICAgICAgfSkpO1xyXG4gICAgICAgIC8vXHJcbiAgICAgICAgLy8gICAgICAgIHN0cnVjdHVyZXMuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoUi5wcm9wKCdrZXknKSkpO1xyXG4gICAgICAgIC8vICAgICAgICByZXR1cm4gc3RydWN0dXJlcztcclxuICAgICAgICBbe1xyXG4gICAgICAgICAgICBrZXk6IGwxMG4oJ2FsbC1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgICAgIGxhc3RLZXlQYXJ0OiBsMTBuKCdhbGwtY2hhcmFjdGVycycpLFxyXG4gICAgICAgICAgICBncm91cHM6IHByb2ZpbGVzRGF0YS5wcm9maWxlRGF0YVxyXG4gICAgICAgIH1dO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBnZXRUcmVlQnlVc2VyU2VsZWN0ID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IFIuZ3JvdXBCeShwcm9maWxlID0+IGdyb3VwaW5nT3JkZXIubWFwKG5hbWUgPT4gcHJvZmlsZS5jaGFyYWN0ZXJbbmFtZV0pLmpvaW4oJy8nKSwgcHJvZmlsZXNEYXRhLnByb2ZpbGVEYXRhKTtcclxuXHJcbiAgICAgICAgY29uc3QgZ3JvdXBpbmdJdGVtSW5mbyA9IFIuaW5kZXhCeShSLnByb3AoJ25hbWUnKSwgcHJvZmlsZXNEYXRhLmNoYXJhY3RlclByb2ZpbGVTdHJ1Y3R1cmUuZmlsdGVyKGVsID0+IFIuY29udGFpbnMoZWwubmFtZSwgZ3JvdXBpbmdPcmRlcikpKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFt7XHJcbiAgICAgICAgICAgIGtleTogbDEwbignYWxsLWNoYXJhY3RlcnMnKSxcclxuICAgICAgICAgICAgbGFzdEtleVBhcnQ6IGwxMG4oJ2FsbC1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgICAgIGNoaWxkcmVuOiBtYWtlR3JvdXBUcmVlKGdyb3VwcywgZ3JvdXBpbmdJdGVtSW5mbywgMCwgW10pXHJcbiAgICAgICAgfV07XHJcbiAgICB9O1xyXG5cclxuICAgIC8vICAgICAgICAgICAgdmFyIGZpbHRlciA9IGVsID0+IGVsLnR5cGUgPT09ICdlbnVtJyB8fCBlbC50eXBlID09PSAnY2hlY2tib3gnO1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBkcmF3R3JvdXBlZExpc3QgPSAoc3RydWN0dXJlcykgPT4ge1xyXG4gICAgICAgIC8vICAgICAgICBzdHJ1Y3R1cmVzID0gW3tcclxuICAgICAgICAvLyAgICAgICAgICAgIFwia2V5XCI6IGwxMG4oJ2FsbC1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgLy8gICAgICAgICAgICBcImxhc3RLZXlQYXJ0XCI6IGwxMG4oJ2FsbC1jaGFyYWN0ZXJzJyksXHJcbiAgICAgICAgLy8gICAgICAgICAgICBcImNoaWxkcmVuXCI6IHN0cnVjdHVyZXNcclxuICAgICAgICAvLyAgICAgICAgfV07XHJcbiAgICAgICAgLy8gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHN0cnVjdHVyZXMpKTtcclxuXHJcbiAgICAgICAgc3RydWN0dXJlcy5mb3JFYWNoKGNhbGNTaXplKTtcclxuXHJcbiAgICAgICAgLy8gYWRkRWwocXVlcnlFbChyb290ICsgJy5ncm91cC1jb250ZW50JyksIGFkZEVscyhhZGRDbGFzc2VzKG1ha2VFbCgndWwnKSwgWydyZW1vdmUtdWwtZG90cycsICd6ZXJvLXBhZGRpbmcnXSksXHJcbiAgICAgICAgLy8gbWFrZUdyb3VwVHJlZShncm91cHMsIGdyb3VwaW5nSXRlbUluZm8sIDAsIFtdKSkpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5ncm91cC1jb250ZW50YCkpLCBhZGRFbHMoYWRkQ2xhc3NlcyhcclxuICAgICAgICAgICAgbWFrZUVsKCd1bCcpLFxyXG4gICAgICAgICAgICBbJ3JlbW92ZS11bC1kb3RzJywgJ3plcm8tcGFkZGluZyddXHJcbiAgICAgICAgKSwgUi5mbGF0dGVuKHN0cnVjdHVyZXMubWFwKHJlbmRlckdyb3VwU3RydWN0dXJlKSkpKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgbWFrZUhlYWRlciA9ICh0ZXh0LCBjaGFyYWN0ZXJOdW0sIHBsYXllck51bSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3RlckJhZGdlID0gYWRkRWwoYWRkQ2xhc3MobWFrZUVsKCdzcGFuJyksICdiYWRnZScpLCBtYWtlVGV4dChgJHtjaGFyYWN0ZXJOdW19IC8gJHtwbGF5ZXJOdW19YCkpO1xyXG4gICAgICAgIHNldEF0dHIoY2hhcmFjdGVyQmFkZ2UsICd0aXRsZScsIEwxMG4uZm9ybWF0KCdyb2xlLWdyaWQnLCAnYmFkZ2UtdGl0bGUnLCBbY2hhcmFjdGVyTnVtLCBwbGF5ZXJOdW1dKSk7XHJcbiAgICAgICAgLy8gICAgICAgIGNvbnN0IHBsYXllckJhZGdlID0gYWRkRWwoYWRkQ2xhc3MobWFrZUVsKCdzcGFuJyksICdiYWRnZScpLCBtYWtlVGV4dChwbGF5ZXJOdW0pKTtcclxuXHJcbiAgICAgICAgY29uc3QgaDMgPSBhZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCdoMycpLCAncGFuZWwtdGl0bGUnKSwgW21ha2VUZXh0KGAgJHt0ZXh0fSBgKSwgY2hhcmFjdGVyQmFkZ2VdKTtcclxuICAgICAgICBjb25zdCBhID0gc2V0QXR0cihtYWtlRWwoJ2EnKSwgJ2hyZWYnLCAnIy8nKTtcclxuICAgICAgICBzZXRBdHRyKGEsICd0cmVlLXBhbmVsLXRvZ2dsZXInLCAnJyk7XHJcbiAgICAgICAgY29uc3QgaGVhZGluZyA9IGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdwYW5lbC1oZWFkaW5nJyksIGFkZEVscyhhLCBbaDNdKSk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVsKGFkZENsYXNzZXMobWFrZUVsKCdkaXYnKSwgWydwYW5lbCcsICdwYW5lbC1kZWZhdWx0JywgJ2lubGluZS1wYW5lbCddKSwgaGVhZGluZyk7XHJcbiAgICAgICAgLy8gdmFyIGhlYWRpbmcgPSBhZGRFbChhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAncGFuZWwtaGVhZGluZycpLFxyXG4gICAgICAgIC8vICAgICAgYWRkRWwoYWRkQ2xhc3MobWFrZUVsKCdoMycpLCAncGFuZWwtdGl0bGUnKSwgbWFrZVRleHQodGV4dCkpKTtcclxuICAgICAgICAvLyByZXR1cm4gYWRkRWwoYWRkQ2xhc3NlcyhtYWtlRWwoJ2RpdicpLCBbJ3BhbmVsJywgJ3BhbmVsLWRlZmF1bHQnXSksIGhlYWRpbmcpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgY2FsY1NpemUgPSAoZWwpID0+IHtcclxuICAgICAgICBpZiAoZWwuY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgZWwuY2hpbGRyZW4uZm9yRWFjaChjYWxjU2l6ZSk7XHJcbiAgICAgICAgICAgIGVsLmNoYXJhY3Rlck51bSA9IFIuc3VtKGVsLmNoaWxkcmVuLm1hcChSLnByb3AoJ2NoYXJhY3Rlck51bScpKSk7XHJcbiAgICAgICAgICAgIGVsLnBsYXllck51bSA9IFIuc3VtKGVsLmNoaWxkcmVuLm1hcChSLnByb3AoJ3BsYXllck51bScpKSk7XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gZ3JvdXBzXHJcbiAgICAgICAgICAgIGVsLmNoYXJhY3Rlck51bSA9IGVsLmdyb3Vwcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGVsLnBsYXllck51bSA9IGVsLmdyb3Vwcy5maWx0ZXIoUi5waXBlKFIucHJvcCgncGxheWVyTmFtZScpLCBSLmlzTmlsLCBSLm5vdCkpLmxlbmd0aDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciByZW5kZXJHcm91cFN0cnVjdHVyZSA9IChlbCkgPT4ge1xyXG4gICAgICAgIC8vICAgICAgICByZXR1cm4gUi5mbGF0dGVuKHN0cnVjdHVyZS5tYXAoZWwgPT4ge1xyXG4gICAgICAgIGxldCBkb21DaGlsZHJlbiwgaGVhZGVyO1xyXG4gICAgICAgIGlmIChlbC5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICBkb21DaGlsZHJlbiA9IGFkZEVscyhhZGRDbGFzcyhtYWtlRWwoJ3VsJyksICdyZW1vdmUtdWwtZG90cycpLCBSLmZsYXR0ZW4oZWwuY2hpbGRyZW4ubWFwKHJlbmRlckdyb3VwU3RydWN0dXJlKSkpO1xyXG4gICAgICAgICAgICBoZWFkZXIgPSBtYWtlSGVhZGVyKGVsLmxhc3RLZXlQYXJ0LCBlbC5jaGFyYWN0ZXJOdW0sIGVsLnBsYXllck51bSk7XHJcbiAgICAgICAgICAgIFVJLmF0dGFjaFBhbmVsVG9nZ2xlcihxdWVyeUVsRWwoaGVhZGVyLCAnYScpLCBkb21DaGlsZHJlbik7XHJcbiAgICAgICAgICAgIHJldHVybiBSLmNvbmNhdChbYWRkRWwobWFrZUVsKCdsaScpLCBoZWFkZXIpXSwgW2RvbUNoaWxkcmVuXSk7XHJcbiAgICAgICAgfSAvLyBncm91cHNcclxuICAgICAgICAvLyAgICAgICAgICAgIHZhciBwYW5lbExpc3QgPSBtYWtlUGFuZWxMaXN0KGVsLmdyb3VwcykubWFwKGFkZENsYXNzZXMoUi5fXyxbJ2lubGluZS1wYW5lbCddKSk7XHJcbiAgICAgICAgY29uc3QgcGFuZWxMaXN0ID0gbWFrZVBhbmVsTGlzdChlbC5ncm91cHMpLm1hcChhZGRDbGFzc2VzKFIuX18sIFsnaW5saW5lLXBhbmVsJywgJ2NvbC14cy02J10pKTtcclxuICAgICAgICAvLyAgICAgICAgICAgIHZhciBwYW5lbExpc3QgPSBtYWtlUGFuZWxMaXN0KGVsLmdyb3VwcykubWFwKGFkZENsYXNzZXMoUi5fXyxbJ2lubGluZS1wYW5lbCcsICdjb2wteHMtNCddKSk7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3JvdycpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGFkZEVsKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdsaXN0LWNvbnRlbnQtcGFkZGluZyBjb250YWluZXItZmx1aWQnKSwgcm93KTtcclxuICAgICAgICBkb21DaGlsZHJlbiA9IGFkZEVscyhyb3csIHBhbmVsTGlzdCk7XHJcbiAgICAgICAgaGVhZGVyID0gbWFrZUhlYWRlcihlbC5rZXksIGVsLmNoYXJhY3Rlck51bSwgZWwucGxheWVyTnVtKTtcclxuICAgICAgICBVSS5hdHRhY2hQYW5lbFRvZ2dsZXIocXVlcnlFbEVsKGhlYWRlciwgJ2EnKSwgY29udGFpbmVyKTtcclxuICAgICAgICByZXR1cm4gUi5jb25jYXQoW2FkZEVsKG1ha2VFbCgnbGknKSwgaGVhZGVyKV0sIFtjb250YWluZXJdKTtcclxuICAgICAgICAvLyB2YXIgY29udGFpbmVyID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ2xpc3QtY29udGVudC1wYWRkaW5nIGNvbnRhaW5lci1mbHVpZCcpO1xyXG4gICAgICAgIC8vIGRvbUNoaWxkcmVuID0gYWRkRWxzKGNvbnRhaW5lciwgcGFuZWxMaXN0KTtcclxuICAgICAgICAvLyByZXR1cm4gUi5jb25jYXQoW2FkZEVsKG1ha2VFbCgnbGknKSwgbWFrZUhlYWRlcihlbC5rZXksIGVsLmNoYXJhY3Rlck51bSwgZWwucGxheWVyTnVtKSldLCBbZG9tQ2hpbGRyZW5dKTtcclxuXHJcblxyXG4gICAgICAgIC8vICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXIsdmFycy1vbi10b3BcclxuICAgIHZhciBtYWtlR3JvdXBUcmVlID0gKGdyb3VwcywgZ3JvdXBpbmdJdGVtSW5mbywgaW5kZXgsIGtleSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGFyciA9IGdyb3VwaW5nSXRlbUluZm9bZ3JvdXBpbmdPcmRlcltpbmRleF1dLnZhbHVlLnNwbGl0KCcsJykubWFwKChuYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5leHRLZXkgPSBSLmNvbmNhdChrZXksIFtuYW1lXSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgdmFyIG5leHRLZXkgPSBSLmNvbmNhdChrZXksIFtncm91cGluZ09yZGVyW2luZGV4XSArICc6ICcgKyBuYW1lXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhc3RLZXlQYXJ0ID0gYCR7Z3JvdXBpbmdPcmRlcltpbmRleF19OiAke25hbWV9YDtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICB2YXIgZG9tQ2hpbGRyZW47XHJcbiAgICAgICAgICAgIGlmIChncm91cGluZ09yZGVyLmxlbmd0aCAhPT0gaW5kZXggKyAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZHJlbiA9IG1ha2VHcm91cFRyZWUoZ3JvdXBzLCBncm91cGluZ0l0ZW1JbmZvLCBpbmRleCArIDEsIG5leHRLZXkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBkb21DaGlsZHJlbiA9IFthZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCd1bCcpLCAncmVtb3ZlLXVsLWRvdHMnKSwgY2hpbGRyZW4pXTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5OiBuZXh0S2V5LmpvaW4oJyAvICcpLFxyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RLZXlQYXJ0LFxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGZ1bGxLZXkgPSBuZXh0S2V5LmpvaW4oJy8nKTtcclxuICAgICAgICAgICAgaWYgKGdyb3Vwc1tmdWxsS2V5XSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBkb21DaGlsZHJlbiA9IFthZGRFbHMoYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ2xpc3QtY29udGVudC1wYWRkaW5nJyksIG1ha2VQYW5lbExpc3QoZ3JvdXBzW2Z1bGxLZXldKSldO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAga2V5OiBuZXh0S2V5LmpvaW4oJyAvICcpLFxyXG4gICAgICAgICAgICAgICAgbGFzdEtleVBhcnQsXHJcbiAgICAgICAgICAgICAgICBncm91cHM6IGdyb3Vwc1tmdWxsS2V5XVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICByZXR1cm4gUi5jb25jYXQoW2FkZEVsKG1ha2VFbCgnbGknKSwgbWFrZUhlYWRlcihuYW1lKSldLCBkb21DaGlsZHJlbik7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgcmV0dXJuIFIuY29uY2F0KFthZGRFbChtYWtlRWwoJ2xpJyksIG1ha2VIZWFkZXIobmV4dEtleS5qb2luKCcgLyAnKSkpXSwgZG9tQ2hpbGRyZW4pO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIG5hbWU6IG5leHRLZXkuam9pbignIC8gJyksXHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIGNoaWxkcmVuOlxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIH1cclxuICAgICAgICB9KS5maWx0ZXIoZWwgPT4gZWwgIT09IG51bGwpO1xyXG4gICAgICAgIHJldHVybiBhcnIubGVuZ3RoID09PSAwID8gbnVsbCA6IGFycjtcclxuICAgICAgICAvLyAgICAgICAgaWYoYXJyLmxlbmd0aCA9PT0gMCl7XHJcbiAgICAgICAgLy8gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAvLyAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyAgICAgICAgICAgIHJldHVybiBSLmZsYXR0ZW4oYXJyKTtcclxuICAgICAgICAvLyAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBkcmF3UGxhaW5QYW5lbExpc3QgPSAoKSA9PiB7XHJcbiAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChgJHtyb290fS5ncm91cC1jb250ZW50YCkpLCBtYWtlUGFuZWxMaXN0KHByb2ZpbGVzRGF0YS5wcm9maWxlRGF0YSkpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyLHZhcnMtb24tdG9wXHJcbiAgICB2YXIgbWFrZVBhbmVsTGlzdCA9IHByb2ZpbGVBcnJheSA9PlxyXG4gICAgICAgIHByb2ZpbGVBcnJheS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShhID0+IGEuY2hhcmFjdGVyTmFtZS50b0xvd2VyQ2FzZSgpKSkubWFwKChwcm9maWxlRGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YWJsZXMgPSBbVUkubWFrZVByb2ZpbGVUYWJsZShwcm9maWxlc0RhdGEuY2hhcmFjdGVyUHJvZmlsZVN0cnVjdHVyZSwgcHJvZmlsZURhdGEuY2hhcmFjdGVyKV07XHJcbiAgICAgICAgICAgIGxldCB0aXRsZSA9IHByb2ZpbGVEYXRhLmNoYXJhY3Rlck5hbWU7XHJcbiAgICAgICAgICAgIGlmIChwcm9maWxlRGF0YS5wbGF5ZXJOYW1lICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRhYmxlcy5wdXNoKFVJLm1ha2VQcm9maWxlVGFibGUocHJvZmlsZXNEYXRhLnBsYXllclByb2ZpbGVTdHJ1Y3R1cmUsIHByb2ZpbGVEYXRhLnBsYXllcikpO1xyXG4gICAgICAgICAgICAgICAgdGl0bGUgKz0gYC8ke3Byb2ZpbGVEYXRhLnBsYXllck5hbWV9YDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgcGFuZWxJbmZvID0gVUkubWFrZVBhbmVsQ29yZShtYWtlVGV4dCh0aXRsZSksIGFkZEVscyhtYWtlRWwoJ2RpdicpLCB0YWJsZXMpKTtcclxuICAgICAgICAgICAgVUkuYXR0YWNoUGFuZWxUb2dnbGVyKHBhbmVsSW5mby5hLCBwYW5lbEluZm8uY29udGVudERpdiwgKGV2ZW50LCB0b2dnbGVQYW5lbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcXVlcnlFbHMoYCR7cm9vdH0uZ3JvdXAtY29udGVudCAuZXhwYW5kZWRbcGFuZWwtdG9nZ2xlcl1gKS5maWx0ZXIoZWwgPT5cclxuICAgICAgICAgICAgICAgICAgICAhZWwuY29udGFpbnMoZXZlbnQudGFyZ2V0KSkuZm9yRWFjaChlbCA9PiBlbC5jbGljaygpKTtcclxuICAgICAgICAgICAgICAgIHRvZ2dsZVBhbmVsKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwYW5lbEluZm8uYS5jbGljaygpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHBhbmVsSW5mby5wYW5lbDtcclxuICAgICAgICB9KTtcclxufSkodGhpcy5Sb2xlR3JpZCA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLmVudGVyLXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICAkKGRvY3VtZW50LmZvcm1zWydsb2dpbi1mb3JtJ10pLm9uKCdzdWJtaXQnLCBzdWJtaXQpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHN1Ym1pdCgpIHtcclxuICAgICAgICBjb25zdCBmb3JtID0gJCh0aGlzKTtcclxuXHJcbiAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbCgnJyk7XHJcbiAgICAgICAgLy8gICAgICAgICQoXCI6c3VibWl0XCIsIGZvcm0pLmJ1dHRvbihcImxvYWRpbmdcIik7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICcvbG9naW4nLFxyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgZGF0YTogZm9ybS5zZXJpYWxpemUoKSxcclxuICAgICAgICAgICAgY29tcGxldGUoKSB7XHJcbiAgICAgICAgICAgICAgICAkKCc6c3VibWl0JywgZm9ybSkuYnV0dG9uKCdyZXNldCcpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICBzdGF0dXNDb2RlIDoge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgMjAwIDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgNDAzIDogZnVuY3Rpb24oanFYSFIpIHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGpxWEhSLnJlc3BvbnNlVGV4dCk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChlcnJvci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcXVlc3QuZG9uZSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAvL3dpbmRvdy5sb2NhdGlvbi5ocmVmID0gXCIvY2hhdFwiO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IFwiL25pbXMuaHRtbFwiO1xyXG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9ICcvcGFnZS5odG1sJztcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKChlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBtc2c7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtc2cgPSBVdGlscy5oYW5kbGVFcnJvck1zZyhKU09OLnBhcnNlKGVycm9ySW5mby5yZXNwb25zZVRleHQpKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBtc2cgPSBVdGlscy5oYW5kbGVFcnJvck1zZyhlcnJvckluZm8ucmVzcG9uc2VUZXh0IHx8IHRleHRTdGF0dXMgfHwgJ2Vycm9yJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShqcVhIUi5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwodGV4dFN0YXR1cyk7XHJcbiAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwobXNnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG59KSh0aGlzLkVudGVyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCByb290ID0gJy5wbGF5ZXItdGFiICc7XHJcbiAgICBjb25zdCBjaGFyYWN0ZXJQcm9maWxlRGl2ID0gYCR7cm9vdH0uY2hhcmFjdGVyLXByb2ZpbGUtZGl2YDtcclxuICAgIGNvbnN0IHBsYXllclByb2ZpbGVEaXYgPSBgJHtyb290fS5wbGF5ZXItcHJvZmlsZS1kaXZgO1xyXG4gICAgY29uc3QgcGxheWVySGVhZGVyID0gYCR7cm9vdH0ucGxheWVyLXByb2ZpbGUtaGVhZGVyYDtcclxuICAgIGNvbnN0IGNoYXJhY3RlckhlYWRlciA9IGAke3Jvb3R9LmNoYXJhY3Rlci1wcm9maWxlLWhlYWRlcmA7XHJcblxyXG4gICAgbGV0IHByb2ZpbGVFZGl0b3JDb3JlO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBwcm9maWxlRWRpdG9yQ29yZSA9IFByb2ZpbGVFZGl0b3JDb3JlLm1ha2VQcm9maWxlRWRpdG9yQ29yZSgpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmdldFdlbGNvbWVUZXh0KChlcnIsIHRleHQpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRQbGF5ZXJQcm9maWxlSW5mbygoZXJyMiwgcHJvZmlsZUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0UGxheWVyc09wdGlvbnMoKGVycjMsIHBsYXllcnNPcHRpb25zKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkSW50ZXJmYWNlKHRleHQsIHByb2ZpbGVJbmZvLCBwbGF5ZXJzT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGlzRWRpdGFibGUocHJvZmlsZU5hbWUsIHByb2ZpbGVTdHJ1Y3R1cmUpIHtcclxuICAgICAgICByZXR1cm4gUi5maW5kKFIucHJvcEVxKCduYW1lJywgcHJvZmlsZU5hbWUpLCBwcm9maWxlU3RydWN0dXJlKS5wbGF5ZXJBY2Nlc3MgPT09ICd3cml0ZSc7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYnVpbGRJbnRlcmZhY2UodGV4dCwgcHJvZmlsZUluZm8sIHBsYXllcnNPcHRpb25zKSB7XHJcbiAgICAgICAgcHJvZmlsZUVkaXRvckNvcmUuaW5pdFByb2ZpbGVTdHJ1Y3R1cmUocGxheWVyUHJvZmlsZURpdiwgJ3BsYXllcicsIHByb2ZpbGVJbmZvLnBsYXllci5wcm9maWxlU3RydWN0dXJlKTtcclxuICAgICAgICBwcm9maWxlRWRpdG9yQ29yZS5maWxsUHJvZmlsZUluZm9ybWF0aW9uKHBsYXllclByb2ZpbGVEaXYsICdwbGF5ZXInLCBwcm9maWxlSW5mby5wbGF5ZXIucHJvZmlsZSwgaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKHBsYXllckhlYWRlcikpLCBtYWtlVGV4dChzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLXBsYXllci1wcm9maWxlJyksIFtwcm9maWxlSW5mby5wbGF5ZXIucHJvZmlsZS5uYW1lXSkpKTtcclxuXHJcbiAgICAgICAgaWYgKHByb2ZpbGVJbmZvLmNoYXJhY3RlciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChjaGFyYWN0ZXJIZWFkZXIpKSwgbWFrZVRleHQoc3RyRm9ybWF0KGdldEwxMG4oJ2JyaWVmaW5ncy1jaGFyYWN0ZXItcHJvZmlsZScpLCBbJyddKSkpO1xyXG4gICAgICAgICAgICBjb25zdCBlbCA9IGNsZWFyRWwocXVlcnlFbChjaGFyYWN0ZXJQcm9maWxlRGl2KSk7XHJcbiAgICAgICAgICAgIGlmIChwbGF5ZXJzT3B0aW9ucy5hbGxvd0NoYXJhY3RlckNyZWF0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGFkZEVsKG1ha2VFbCgnZGl2JyksIG1ha2VUZXh0KGdldEwxMG4oJ3Byb2ZpbGVzLXBsYXllci1oYXMtbm8tY2hhcmFjdGVyLWFuZC1jYW4tY3JlYXRlLWl0JykpKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGxhYmVsLCAnbWFyZ2luLWJvdHRvbS04Jyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dCA9IHNldEF0dHIobWFrZUVsKCdpbnB1dCcpLCAncGxhY2Vob2xkZXInLCBnZXRMMTBuKCdwcm9maWxlcy1jaGFyYWN0ZXItbmFtZScpKTtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCAnZm9ybS1jb250cm9sIG1hcmdpbi1ib3R0b20tOCcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYnV0dG9uID0gYWRkRWwobWFrZUVsKCdidXR0b24nKSwgbWFrZVRleHQoZ2V0TDEwbignY29tbW9uLWNyZWF0ZScpKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhidXR0b24sICdidG4gYnRuLWRlZmF1bHQnKTtcclxuICAgICAgICAgICAgICAgIGxpc3RlbihidXR0b24sICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBEQk1TLmNyZWF0ZUNoYXJhY3RlckJ5UGxheWVyKGlucHV0LnZhbHVlLnRyaW0oKSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBhZGRFbHMoZWwsIFtsYWJlbCwgaW5wdXQsIGJ1dHRvbl0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWRkRWwoZWwsIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChnZXRMMTBuKCdwcm9maWxlcy1wbGF5ZXItaGFzLW5vLWNoYXJhY3Rlci1hbmQtY2FudC1jcmVhdGUtaXQnKSkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmluaXRQcm9maWxlU3RydWN0dXJlKGNoYXJhY3RlclByb2ZpbGVEaXYsICdjaGFyYWN0ZXInLCBwcm9maWxlSW5mby5jaGFyYWN0ZXIucHJvZmlsZVN0cnVjdHVyZSk7XHJcbiAgICAgICAgICAgIHByb2ZpbGVFZGl0b3JDb3JlLmZpbGxQcm9maWxlSW5mb3JtYXRpb24oY2hhcmFjdGVyUHJvZmlsZURpdiwgJ2NoYXJhY3RlcicsIHByb2ZpbGVJbmZvLmNoYXJhY3Rlci5wcm9maWxlLCBpc0VkaXRhYmxlKTtcclxuICAgICAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKGNoYXJhY3RlckhlYWRlcikpLCBtYWtlVGV4dChzdHJGb3JtYXQoZ2V0TDEwbignYnJpZWZpbmdzLWNoYXJhY3Rlci1wcm9maWxlJyksIFtwcm9maWxlSW5mby5jaGFyYWN0ZXIucHJvZmlsZS5uYW1lXSkpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHF1ZXJ5RWwoYCR7cm9vdH0ud2VsY29tZS10ZXh0LWFyZWFgKS52YWx1ZSA9IHRleHQ7XHJcbiAgICB9XHJcbn0pKHRoaXMuUGxheWVyID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuc2lnbi11cC10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgJChkb2N1bWVudC5mb3Jtc1snc2lnbi11cC1mb3JtJ10pLm9uKCdzdWJtaXQnLCBzdWJtaXQpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gc3VibWl0KCkge1xyXG4gICAgICAgIGNvbnN0IGZvcm0gPSAkKHRoaXMpO1xyXG5cclxuICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKCcnKTtcclxuICAgICAgICAkKCc6c3VibWl0JywgZm9ybSkuYnV0dG9uKCdsb2FkaW5nJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmw6ICcvc2lnblVwJyxcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IGZvcm0uc2VyaWFsaXplKCksXHJcbiAgICAgICAgICAgIGNvbXBsZXRlKCkge1xyXG4gICAgICAgICAgICAgICAgJCgnOnN1Ym1pdCcsIGZvcm0pLmJ1dHRvbigncmVzZXQnKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXF1ZXN0LmRvbmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgZm9ybS5odG1sKGdldEwxMG4oJ2VudHJhbmNlLXNpZ24tdXAtc3VjY2VzcycpKS5hZGRDbGFzcygnYWxlcnQtc3VjY2VzcycpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXF1ZXN0LmZhaWwoKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pID0+IHtcclxuICAgICAgICAgICAgbGV0IG1zZztcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIG1zZyA9IFV0aWxzLmhhbmRsZUVycm9yTXNnKEpTT04ucGFyc2UoZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIG1zZyA9IFV0aWxzLmhhbmRsZUVycm9yTXNnKGVycm9ySW5mby5yZXNwb25zZVRleHQgfHwgdGV4dFN0YXR1cyB8fCAnZXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKG1zZyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxufSkodGhpcy5TaWduVXAgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnNsaWRlcnMtdGFiICc7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgc3RhdGUuc2xpZGVycyA9IFtdO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3JlYXRlU2xpZGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgY3JlYXRlU2xpZGVyLCB7XHJcbiAgICAgICAgICAgIGJvZHlTZWxlY3RvcjogJ2NyZWF0ZS1zbGlkZXItYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc2xpZGVycy1jcmVhdGUtc2xpZGVyJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5lZGl0U2xpZGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgZWRpdFNsaWRlciwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdjcmVhdGUtc2xpZGVyLWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3NsaWRlcnMtZWRpdC1zbGlkZXInLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1zYXZlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBzdGF0ZS5tb3ZlU2xpZGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2cocm9vdCwgbW92ZVNsaWRlciwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb3ZlLXNsaWRlci1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdzbGlkZXJzLW1vdmUtc2xpZGVyJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tbW92ZScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9IC5jcmVhdGVgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlU2xpZGVyRGlhbG9nLnNob3dEbGcoKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0U2xpZGVyRGF0YVBtKCkudGhlbihjcmVhdGVTbGlkZXJzKS5jYXRjaChVdGlscy5oYW5kbGVFcnJvcik7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBjcmVhdGVTbGlkZXJzKG1vZGVsKSB7XHJcbiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbW9kZWwubWFwKCBpbmZvID0+IHtyZXR1cm4ge25hbWU6IHN0ckZvcm1hdChMMTBuLmdldCgnY29tbW9uJywgJ3NldC1pdGVtLWJlZm9yZScpLCBbaW5mby5uYW1lXSl9fSk7XHJcbiAgICAgICAgcG9zaXRpb25zLnB1c2goe25hbWU6IEwxMG4uZ2V0KCdjb21tb24nLCAnc2V0LWl0ZW0tYXMtbGFzdCcpfSk7XHJcbiAgICAgICAgZmlsbFNlbGVjdG9yKGNsZWFyRWwocWUoYCR7cm9vdH0gLm1vdmUtc2xpZGVyLXBvcy1zZWxlY3RgKSksIHBvc2l0aW9ucyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbCgnLm1peGVyLXBhbmVsIC5wYW5lbC1ib2R5JykpLCBtb2RlbC5tYXAoIG1ha2VTbGlkZXJCYWNrYm9uZSApKSA7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY2xlYXJFbHMoc3RhdGUuc2xpZGVycyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUuc2xpZGVycyA9IG1vZGVsLm1hcCggKHNsLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNsaWRlciA9IG5ldyBTbGlkZXIoJy5taXhlci1wYW5lbCAucGFuZWwtYm9keSBpbnB1dFtwb3M9XCInICsgaSArICdcIl0nLCB7XHJcbiAgICAgICAgICAgICAgICBtYXg6IDEwLFxyXG4gICAgICAgICAgICAgICAgbWluOiAtMTAsXHJcbiAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogJ3ZlcnRpY2FsJyxcclxuICAgICAgICAgICAgICAgIHJldmVyc2VkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgdG9vbHRpcDogJ2Fsd2F5cycsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogc2wudmFsdWUsXHJcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguYWJzKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzbGlkZXIub24oJ2NoYW5nZScsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy51cGRhdGVTbGlkZXJWYWx1ZVBtKGksIGV2ZW50Lm5ld1ZhbHVlKS5jYXRjaChVdGlscy5oYW5kbGVFcnJvcik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gc2xpZGVyO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICB2YXIgbWFrZVNsaWRlckJhY2tib25lID0gKHNsLCBpKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxbXRlKGAke3Jvb3R9IC5zbGlkZXItY29udGFpbmVyLXRtcGxgKTtcclxuICAgICAgICBzZXRBdHRyKHFlZShlbCwgJ2lucHV0JyksICdwb3MnLCBpKTtcclxuICAgICAgICBhZGRFbChxZWUoZWwsICcuc2xpZGVyLW5hbWUnKSwgbWFrZVRleHQoc2wubmFtZSkpO1xyXG4gICAgICAgIGFkZEVsKHFlZShlbCwgJy5zbGlkZXItdG9wJyksIG1ha2VUZXh0KHNsLnRvcCkpO1xyXG4gICAgICAgIGFkZEVsKHFlZShlbCwgJy5zbGlkZXItYm90dG9tJyksIG1ha2VUZXh0KHNsLmJvdHRvbSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICdidXR0b24ubW92ZScpLCAnY2xpY2snLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vdmVTbGlkZXJEaWFsb2cuY3VycmVudEluZGV4ID0gaTtcclxuICAgICAgICAgICAgc3RhdGUubW92ZVNsaWRlckRpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJ2J1dHRvbi5yZW5hbWUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBxZWUoc3RhdGUuZWRpdFNsaWRlckRpYWxvZywgJy5zbGlkZXItbmFtZScpLnZhbHVlID0gc2wubmFtZTtcclxuICAgICAgICAgICAgcWVlKHN0YXRlLmVkaXRTbGlkZXJEaWFsb2csICcuc2xpZGVyLXRvcCcpLnZhbHVlID0gc2wudG9wO1xyXG4gICAgICAgICAgICBxZWUoc3RhdGUuZWRpdFNsaWRlckRpYWxvZywgJy5zbGlkZXItYm90dG9tJykudmFsdWUgPSBzbC5ib3R0b207XHJcbiAgICAgICAgICAgIHN0YXRlLmVkaXRTbGlkZXJEaWFsb2cucG9zID0gaTtcclxuICAgICAgICAgICAgc3RhdGUuZWRpdFNsaWRlckRpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJ2J1dHRvbi5yZW1vdmUnKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBVdGlscy5jb25maXJtKEwxMG4uZm9ybWF0KCdzbGlkZXJzJywgJ2FyZS15b3Utc3VyZS1hYm91dC1yZW1vdmluZy1zbGlkZXInLCBbc2wubmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZVNsaWRlcihpLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhlbCk7XHJcbiAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZnVuY3Rpb24gY3JlYXRlU2xpZGVyKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBxZWUoZGlhbG9nLCAnLnNsaWRlci1uYW1lJykudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCB0b3AgPSBxZWUoZGlhbG9nLCAnLnNsaWRlci10b3AnKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJvdHRvbSA9IHFlZShkaWFsb2csICcuc2xpZGVyLWJvdHRvbScpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgREJNUy5jcmVhdGVTbGlkZXIobmFtZSwgdG9wLCBib3R0b20sIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShkaWFsb2csICcuc2xpZGVyLW5hbWUnKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHFlZShkaWFsb2csICcuc2xpZGVyLXRvcCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgcWVlKGRpYWxvZywgJy5zbGlkZXItYm90dG9tJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBlZGl0U2xpZGVyKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBxZWUoZGlhbG9nLCAnLnNsaWRlci1uYW1lJykudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBjb25zdCB0b3AgPSBxZWUoZGlhbG9nLCAnLnNsaWRlci10b3AnKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJvdHRvbSA9IHFlZShkaWFsb2csICcuc2xpZGVyLWJvdHRvbScpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgcG9zID0gZGlhbG9nLnBvcztcclxuICAgICAgICAgICAgREJNUy51cGRhdGVTbGlkZXJOYW1pbmcocG9zLCBuYW1lLCB0b3AsIGJvdHRvbSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEVycm9yKGRpYWxvZywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcWVlKGRpYWxvZywgJy5zbGlkZXItbmFtZScpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgcWVlKGRpYWxvZywgJy5zbGlkZXItdG9wJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBxZWUoZGlhbG9nLCAnLnNsaWRlci1ib3R0b20nKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gbW92ZVNsaWRlcihkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICB2YXIgaW5kZXggPSBkaWFsb2cuY3VycmVudEluZGV4O1xyXG4gICAgICAgICAgICB2YXIgcG9zID0gcWVlKGRpYWxvZywgJy5tb3ZlLXNsaWRlci1wb3Mtc2VsZWN0Jykuc2VsZWN0ZWRJbmRleDtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIERCTVMubW92ZVNsaWRlcihpbmRleCwgcG9zLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSkodGhpcy5TbGlkZXJzID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TLCBTdG9yaWVzXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgZXhwb3J0cy5uYW1lID0gJ0V2ZW50UHJlc2VuY2UnO1xyXG4gICAgY29uc3Qgcm9vdCA9ICcjZXZlbnRQcmVzZW5jZURpdiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ2V2ZW50UHJlc2VuY2VTZWxlY3RvcicpLCAnY2hhbmdlJywgVUkuc2hvd1NlbGVjdGVkRWxzMyhyb290LCAnZGVwZW5kZW50JywgJ2RlcGVuZGVudC1pbmRleCcpKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGFibGVIZWFkID0gZ2V0RWwoJ2V2ZW50UHJlc2VuY2VUYWJsZUhlYWQnKTtcclxuICAgICAgICBjb25zdCB0YWJsZSA9IGdldEVsKCdldmVudFByZXNlbmNlVGFibGUnKTtcclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJTZWxlY3RvciA9IGdldEVsKCdldmVudFByZXNlbmNlU2VsZWN0b3InKTtcclxuXHJcbiAgICAgICAgaWYgKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgY2xlYXJFbCh0YWJsZUhlYWQpO1xyXG4gICAgICAgICAgICBjbGVhckVsKHRhYmxlKTtcclxuICAgICAgICAgICAgY2xlYXJFbChjaGFyYWN0ZXJTZWxlY3Rvcik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdzdG9yeScsIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCAoZXJyLCBpc1N0b3J5RWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2NoYXJhY3RlcicsIGZhbHNlLCAoZXJyMiwgYWxsQ2hhcmFjdGVycykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgREJNUy5nZXRTdG9yeUNoYXJhY3Rlck5hbWVzQXJyYXkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIChlcnIzLCBjaGFyYWN0ZXJBcnJheSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXAgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICBhbGxDaGFyYWN0ZXJzLmZvckVhY2goKGVsZW0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwW2VsZW0udmFsdWVdID0gZWxlbTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhQXJyYXkgPSBjaGFyYWN0ZXJBcnJheS5tYXAoZWxlbSA9PiBtYXBbZWxlbV0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBkYXRhQXJyYXkuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlBcnJheSA9IGRhdGFBcnJheS5tYXAoZWxlbSA9PiBlbGVtLmRpc3BsYXlOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBjaGFyYWN0ZXJBcnJheSA9IGRhdGFBcnJheS5tYXAoZWxlbSA9PiBlbGVtLnZhbHVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgREJNUy5nZXRTdG9yeUV2ZW50cyhTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgKGVycjQsIGV2ZW50cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyNCkgeyBVdGlscy5oYW5kbGVFcnJvcihlcnI0KTsgcmV0dXJuOyB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKHRhYmxlSGVhZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRWwodGFibGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLmFsZXJ0Lm5vLWNoYXJhY3RlcnNgKSwgY2hhcmFjdGVyQXJyYXkubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLmFsZXJ0Lm5vLWV2ZW50c2ApLCBldmVudHMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VsKHF1ZXJ5RWwoYCR7cm9vdH0gLnBhbmVsLWJvZHlgKSwgZXZlbnRzLmxlbmd0aCAhPT0gMCAmJiBjaGFyYWN0ZXJBcnJheS5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgVUkuZmlsbFNob3dJdGVtU2VsZWN0b3IoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhckVsKGNoYXJhY3RlclNlbGVjdG9yKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlBcnJheS5tYXAobmFtZSA9PiAoeyBuYW1lLCBoaWRkZW46IGZhbHNlIH0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kVGFibGVIZWFkZXIodGFibGVIZWFkLCBkaXNwbGF5QXJyYXkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudHMuZm9yRWFjaCgoZXZlbnQsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZFRhYmxlSW5wdXQodGFibGUsIGV2ZW50LCBpLCBjaGFyYWN0ZXJBcnJheSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNTdG9yeUVkaXRhYmxlJywgaXNTdG9yeUVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGFwcGVuZFRhYmxlSGVhZGVyKHRhYmxlLCBjaGFyYWN0ZXJBcnJheSkge1xyXG4gICAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IGFkZEVsKG1ha2VFbCgndGgnKSwgbWFrZVRleHQoZ2V0TDEwbignc3Rvcmllcy1ldmVudCcpKSk7XHJcbiAgICAgICAgY29uc3QgZWxzID0gY2hhcmFjdGVyQXJyYXkubWFwKChjaGFyYWN0ZXJOYW1lLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRoID0gYWRkRWwobWFrZUVsKCd0aCcpLCBtYWtlVGV4dChjaGFyYWN0ZXJOYW1lKSk7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHRoLCBgZGVwZW5kZW50YCk7XHJcbiAgICAgICAgICAgIHNldEF0dHIodGgsICdkZXBlbmRlbnQtaW5kZXgnLCBpKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGFkZEVsKHRhYmxlLCBhZGRFbHMobWFrZUVsKCd0cicpLCBSLmNvbmNhdChbZXZlbnROYW1lXSwgZWxzKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGFwcGVuZFRhYmxlSW5wdXQodGFibGUsIGV2ZW50LCBpLCBjaGFyYWN0ZXJBcnJheSkge1xyXG4gICAgICAgIGNvbnN0IHRyID0gbWFrZUVsKCd0cicpO1xyXG4gICAgICAgIGxldCB0ZCA9IG1ha2VFbCgndGQnKTtcclxuICAgICAgICB0ZC5hcHBlbmRDaGlsZChtYWtlVGV4dChldmVudC5uYW1lKSk7XHJcbiAgICAgICAgdHIuYXBwZW5kQ2hpbGQodGQpO1xyXG5cclxuICAgICAgICBhZGRFbHModHIsIGNoYXJhY3RlckFycmF5Lm1hcCgoY2hhcmFjdGVyLCBqKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRkID0gcW10ZShgJHtyb290fSAuZXZlbnQtcHJlc2VuY2UtY2VsbGApO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0ZCwgYGRlcGVuZGVudGApO1xyXG4gICAgICAgICAgICBzZXRBdHRyKHRkLCAnZGVwZW5kZW50LWluZGV4Jywgaik7XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gcWVlKHRkLCAnaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgbGFiZWwgPSBxZWUodGQsICdsYWJlbCcpO1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJdKSB7XHJcbiAgICAgICAgICAgICAgICBpbnB1dC5jaGVja2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpbnB1dC5ldmVudEluZGV4ID0gaTtcclxuICAgICAgICAgICAgaW5wdXQuZXZlbnROYW1lID0gZXZlbnQubmFtZTtcclxuICAgICAgICAgICAgaW5wdXQuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3RlcjtcclxuICAgICAgICAgICAgaW5wdXQuaGFzVGV4dCA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyXSAhPT0gdW5kZWZpbmVkICYmIGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyXS50ZXh0ICE9PSAnJztcclxuICAgICAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgb25DaGFuZ2VDaGFyYWN0ZXJDaGVja2JveCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCBzcGFuID0gcWVlKHRkLCAnc3BhbicpO1xyXG4gICAgICAgICAgICBpZihldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlcl0gIT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgICAgICBpZihldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlcl0ucmVhZHkpe1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKHNwYW4sICdmaW5pc2hlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEF0dHIoc3BhbiwgJ3RpdGxlJywgTDEwbi5nZXQoJ2FkYXB0YXRpb25zJywgJ2FkYXB0YXRpb24tZmluaXNoZWQnKSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaW5wdXQuaGFzVGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKHNwYW4sICdpbi1wcm9ncmVzcycpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldEF0dHIoc3BhbiwgJ3RpdGxlJywgTDEwbi5nZXQoJ2FkYXB0YXRpb25zJywgJ2FkYXB0YXRpb24taW4tcHJvZ3Jlc3MnKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gaSArIGNoYXJhY3RlcjtcclxuICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ2lkJywgaWQpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGxhYmVsLCAnZm9yJywgaWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGQ7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICB0YWJsZS5hcHBlbmRDaGlsZCh0cik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFuZ2VDaGFyYWN0ZXJDaGVja2JveChldmVudCkge1xyXG4gICAgICAgIGlmIChldmVudC50YXJnZXQuY2hlY2tlZCkge1xyXG4gICAgICAgICAgICBEQk1TLmFkZENoYXJhY3RlclRvRXZlbnQoXHJcbiAgICAgICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSxcclxuICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5ldmVudEluZGV4LCBldmVudC50YXJnZXQuY2hhcmFjdGVyTmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2UgaWYgKCFldmVudC50YXJnZXQuaGFzVGV4dCkge1xyXG4gICAgICAgICAgICBEQk1TLnJlbW92ZUNoYXJhY3RlckZyb21FdmVudChcclxuICAgICAgICAgICAgICAgIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLFxyXG4gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmV2ZW50SW5kZXgsIGV2ZW50LnRhcmdldC5jaGFyYWN0ZXJOYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KFxyXG4gICAgICAgICAgICAgICAgZ2V0TDEwbignc3Rvcmllcy1yZW1vdmUtY2hhcmFjdGVyLWZyb20tZXZlbnQtd2FybmluZycpLFxyXG4gICAgICAgICAgICAgICAgW2V2ZW50LnRhcmdldC5jaGFyYWN0ZXJOYW1lLCBldmVudC50YXJnZXQuZXZlbnROYW1lXVxyXG4gICAgICAgICAgICApLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZUNoYXJhY3RlckZyb21FdmVudChcclxuICAgICAgICAgICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSxcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuZXZlbnRJbmRleCwgZXZlbnQudGFyZ2V0LmNoYXJhY3Rlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSkodGhpcy5FdmVudFByZXNlbmNlID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TLCBTdG9yeUV2ZW50cywgU3RvcnlDaGFyYWN0ZXJzLCBFdmVudFByZXNlbmNlXHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgY29uc3Qgcm9vdCA9ICcuc3Rvcmllcy10YWIgJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3JlYXRlU3RvcnlEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBjcmVhdGVTdG9yeSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc3Rvcmllcy1lbnRlci1zdG9yeS1uYW1lJyxcclxuICAgICAgICAgICAgYWN0aW9uQnV0dG9uVGl0bGU6ICdjb21tb24tY3JlYXRlJyxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVuYW1lU3RvcnlEaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCByZW5hbWVTdG9yeSwge1xyXG4gICAgICAgICAgICBib2R5U2VsZWN0b3I6ICdtb2RhbC1wcm9tcHQtYm9keScsXHJcbiAgICAgICAgICAgIGRpYWxvZ1RpdGxlOiAnc3Rvcmllcy1lbnRlci1uZXctc3RvcnktbmFtZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlbmFtZScsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmxlZnQgPSB7IHZpZXdzOiB7fSB9O1xyXG4gICAgICAgIHN0YXRlLnJpZ2h0ID0geyB2aWV3czoge30gfTtcclxuICAgICAgICBsZXQgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUubGVmdCxcclxuICAgICAgICAgICAgbmF2aWdhdGlvbjogcXVlcnlFbCgnLnN0b3JpZXMtbmF2aWdhdGlvbi1jb250YWluZXIgLmxlZnQtc2lkZScpLFxyXG4gICAgICAgICAgICBjb250ZW50OiBxdWVyeUVsKCcuc3Rvcmllcy1jb250ZW50LWNvbnRhaW5lciAubGVmdC1zaWRlJylcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3dyaXRlci1zdG9yeScsIFdyaXRlclN0b3J5LCB7IG1haW5QYWdlOiB0cnVlLCB0b2dnbGU6IHRydWUgfSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCAnc3RvcnktZXZlbnRzJywgU3RvcnlFdmVudHMsIHsgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3N0b3J5LWNoYXJhY3RlcnMnLCBTdG9yeUNoYXJhY3RlcnMsIHsgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ2V2ZW50LXByZXNlbmNlJywgRXZlbnRQcmVzZW5jZSwgeyB0b2dnbGU6IHRydWUgfSk7XHJcbiAgICAgICAgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUucmlnaHQsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHF1ZXJ5RWwoJy5zdG9yaWVzLW5hdmlnYXRpb24tY29udGFpbmVyIC5yaWdodC1zaWRlJyksXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IHF1ZXJ5RWwoJy5zdG9yaWVzLWNvbnRlbnQtY29udGFpbmVyIC5yaWdodC1zaWRlJylcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3dyaXRlci1zdG9yeScsIFdyaXRlclN0b3J5LCB7IHRvZ2dsZTogdHJ1ZSB9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsICdzdG9yeS1ldmVudHMnLCBTdG9yeUV2ZW50cywgeyBtYWluUGFnZTogdHJ1ZSwgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ3N0b3J5LWNoYXJhY3RlcnMnLCBTdG9yeUNoYXJhY3RlcnMsIHsgdG9nZ2xlOiB0cnVlIH0pO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgJ2V2ZW50LXByZXNlbmNlJywgRXZlbnRQcmVzZW5jZSwgeyB0b2dnbGU6IHRydWUgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGAke3Jvb3R9LnJlbW92ZS5zdG9yeWApLCAnY2xpY2snLCByZW1vdmVTdG9yeSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGUuc3RvcnlgKSwgJ2NsaWNrJywgKCkgPT4gY3JlYXRlU3RvcnlEaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0ucmVuYW1lLnN0b3J5YCksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgcWVlKHJlbmFtZVN0b3J5RGlhbG9nLCAnLmVudGl0eS1pbnB1dCcpLnZhbHVlID0gcXVlcnlFbChgJHtyb290fSNzdG9yeVNlbGVjdG9yYCkudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICByZW5hbWVTdG9yeURpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZShgJHtyb290fS5jcmVhdGUuZXZlbnRgKSwgJ2NsaWNrJywgKCkgPT4gU3RvcnlFdmVudHMuY3JlYXRlRXZlbnREaWFsb2cuc2hvd0RsZygpKTtcclxuICAgICAgICBsaXN0ZW4ocWUoYCR7cm9vdH0uYWRkLmNoYXJhY3RlcmApLCAnY2xpY2snLCAoKSA9PiBTdG9yeUNoYXJhY3RlcnMuYWRkQ2hhcmFjdGVyRGlhbG9nLnNob3dEbGcoKSk7XHJcblxyXG4gICAgICAgICQoJyNzdG9yeVNlbGVjdG9yJykuc2VsZWN0MigpLm9uKCdjaGFuZ2UnLCBvblN0b3J5U2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuY2hhaW5SZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIGlmICgoc3RhdGUubGVmdC5jdXJyZW50VmlldyAmJiBzdGF0ZS5sZWZ0LmN1cnJlbnRWaWV3Lm5hbWUgPT09ICdFdmVudFByZXNlbmNlJykgfHxcclxuICAgICAgICAgICAgKHN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3ICYmIHN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3Lm5hbWUgPT09ICdFdmVudFByZXNlbmNlJykpIHtcclxuICAgICAgICAgICAgRXZlbnRQcmVzZW5jZS5yZWZyZXNoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlTZWxlY3RvciA9IGNsZWFyRWwoZ2V0RWwoJ3N0b3J5U2VsZWN0b3InKSk7XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzdG9yeScsIGZhbHNlLCAoZXJyLCBhbGxTdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBnZXRTZWxlY3QyRGF0YShhbGxTdG9yeU5hbWVzKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LnJlbmFtZS5zdG9yeWApLCBhbGxTdG9yeU5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICBVdGlscy5lbmFibGVFbChxZShgJHtyb290fS5yZW1vdmUuc3RvcnlgKSwgYWxsU3RvcnlOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0uY3JlYXRlLmV2ZW50YCksIGFsbFN0b3J5TmFtZXMubGVuZ3RoID4gMCk7XHJcbiAgICAgICAgICAgIFV0aWxzLmVuYWJsZUVsKHFlKGAke3Jvb3R9LmFkZC5jaGFyYWN0ZXJgKSwgYWxsU3RvcnlOYW1lcy5sZW5ndGggPiAwKTtcclxuICAgICAgICAgICAgVXRpbHMuZW5hYmxlRWwocWUoYCR7cm9vdH0jc3RvcnlTZWxlY3RvcmApLCBhbGxTdG9yeU5hbWVzLmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9LmFsZXJ0YCksIGFsbFN0b3J5TmFtZXMubGVuZ3RoID09PSAwKTtcclxuICAgICAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9LnN0b3JpZXMtbWFpbi1jb250YWluZXJgKSwgYWxsU3RvcnlOYW1lcy5sZW5ndGggIT09IDApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGFsbFN0b3J5TmFtZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gZ2V0U2VsZWN0ZWRTdG9yeU5hbWUoYWxsU3RvcnlOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAkKCcjc3RvcnlTZWxlY3RvcicpLnNlbGVjdDIoZGF0YSkudmFsKHN0b3J5TmFtZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICBvblN0b3J5U2VsZWN0b3JDaGFuZ2Uoc3RvcnlOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICQoJyNzdG9yeVNlbGVjdG9yJykuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgICAgIG9uU3RvcnlTZWxlY3RvckNoYW5nZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBSLnZhbHVlcyhzdGF0ZS5sZWZ0LnZpZXdzKS5mb3JFYWNoKHZpZXcgPT4gdmlldy5yZWZyZXNoKCkpO1xyXG4gICAgICAgICAgICBpZiAoc3RhdGUubGVmdC5jdXJyZW50VmlldylzdGF0ZS5sZWZ0LmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3KXN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0U2VsZWN0ZWRTdG9yeU5hbWUoc3RvcnlOYW1lcykge1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gREJNUy5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgIGlmICghc2V0dGluZ3MuU3Rvcmllcykge1xyXG4gICAgICAgICAgICBzZXR0aW5ncy5TdG9yaWVzID0ge1xyXG4gICAgICAgICAgICAgICAgc3RvcnlOYW1lOiBzdG9yeU5hbWVzWzBdLnZhbHVlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB7IHN0b3J5TmFtZSB9ID0gc2V0dGluZ3MuU3RvcmllcztcclxuICAgICAgICBpZiAoc3RvcnlOYW1lcy5tYXAobmFtZUluZm8gPT4gbmFtZUluZm8udmFsdWUpLmluZGV4T2Yoc3RvcnlOYW1lKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgc2V0dGluZ3MuU3Rvcmllcy5zdG9yeU5hbWUgPSBzdG9yeU5hbWVzWzBdLnZhbHVlO1xyXG4gICAgICAgICAgICBzdG9yeU5hbWUgPSBzdG9yeU5hbWVzWzBdLnZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RvcnlOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVN0b3J5KGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5jcmVhdGVTdG9yeShzdG9yeU5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdzKHN0b3J5TmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goKGVycjIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW5hbWVTdG9yeShkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b0lucHV0ID0gcWVlKGRpYWxvZywgJy5lbnRpdHktaW5wdXQnKTtcclxuICAgICAgICAgICAgY29uc3QgZnJvbU5hbWUgPSBxdWVyeUVsKGAke3Jvb3R9I3N0b3J5U2VsZWN0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgREJNUy5yZW5hbWVTdG9yeShmcm9tTmFtZSwgdG9OYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVTZXR0aW5ncyh0b05hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVTdG9yeSgpIHtcclxuICAgICAgICBjb25zdCBuYW1lID0gcXVlcnlFbChgJHtyb290fSNzdG9yeVNlbGVjdG9yYCkudmFsdWUudHJpbSgpO1xyXG5cclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdzdG9yaWVzLWFyZS15b3Utc3VyZS1hYm91dC1zdG9yeS1yZW1vdmluZycpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMucmVtb3ZlU3RvcnkobmFtZSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKChlcnIyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uU3RvcnlTZWxlY3RvckNoYW5nZURlbGVnYXRlKGV2ZW50KSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgIG9uU3RvcnlTZWxlY3RvckNoYW5nZShzdG9yeU5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uU3RvcnlTZWxlY3RvckNoYW5nZShzdG9yeU5hbWUpIHtcclxuICAgICAgICBzdGF0ZS5DdXJyZW50U3RvcnlOYW1lID0gc3RvcnlOYW1lO1xyXG5cclxuICAgICAgICBpZiAoc3RvcnlOYW1lKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdzKHN0b3J5TmFtZSk7XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdzdG9yeScsIHN0b3J5TmFtZSwgKGVyciwgaXNTdG9yeUVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxlZnQuY3VycmVudFZpZXcpc3RhdGUubGVmdC5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUucmlnaHQuY3VycmVudFZpZXcpc3RhdGUucmlnaHQuY3VycmVudFZpZXcucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuZW5hYmxlKGV4cG9ydHMuY29udGVudCwgJ2lzU3RvcnlFZGl0YWJsZScsIGlzU3RvcnlFZGl0YWJsZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIHdoZW4gdGhlcmUgYXJlIG5vIHN0b3JpZXMgYXQgYWxsXHJcbiAgICAgICAgICAgIHVwZGF0ZVNldHRpbmdzKG51bGwpO1xyXG4gICAgICAgICAgICBpZiAoc3RhdGUubGVmdC5jdXJyZW50VmlldylzdGF0ZS5sZWZ0LmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3KXN0YXRlLnJpZ2h0LmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0cy5nZXRDdXJyZW50U3RvcnlOYW1lID0gKCkgPT4gc3RhdGUuQ3VycmVudFN0b3J5TmFtZTtcclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyhzdG9yeU5hbWUpIHtcclxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IERCTVMuZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICBzZXR0aW5ncy5TdG9yaWVzLnN0b3J5TmFtZSA9IHN0b3J5TmFtZTtcclxuICAgIH1cclxufSkodGhpcy5TdG9yaWVzID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTggVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5zdG9yeS1jaGFyYWN0ZXJzLXRhYiAnO1xyXG4gICAgY29uc3Qgc3VwZXJSb290ID0gJy5zdG9yaWVzLXRhYiAnO1xyXG4gICAgbGV0IGluaXRpYWxpemVkID0gZmFsc2U7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChpbml0aWFsaXplZCkgcmV0dXJuO1xyXG4gICAgICAgIGV4cG9ydHMuYWRkQ2hhcmFjdGVyRGlhbG9nID0gVUkuY3JlYXRlTW9kYWxEaWFsb2coc3VwZXJSb290LCBhZGRDaGFyYWN0ZXIsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtYWRkLWNoYXJhY3Rlci1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdzdG9yaWVzLWFkZC1jaGFyYWN0ZXItdGl0bGUnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1hZGQnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmFkZC5jaGFyYWN0ZXJgKSwgJ2NsaWNrJywgKCkgPT4gYWRkQ2hhcmFjdGVyRGlhbG9nLnNob3dEbGcoKSk7XHJcblxyXG4gICAgICAgIHN0YXRlLnN3aXRjaENoYXJhY3RlckRpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKHJvb3QsIHN3aXRjaENoYXJhY3RlcnMsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW9kYWwtc3dpdGNoLWV2ZW50LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3N0b3JpZXMtc3dpdGNoLWNoYXJhY3Rlci10aXRsZScsXHJcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvblRpdGxlOiAnY29tbW9uLXJlcGxhY2UnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHN0YXRlLkV4dGVybmFsQ2hhcmFjdGVyU2VsZWN0b3JzID0gW3F1ZXJ5RWwoYCR7c3VwZXJSb290fS5zdG9yeUNoYXJhY3RlcnNBZGRTZWxlY3RvcmApLFxyXG4gICAgICAgICAgICBxdWVyeUVsKGAke3Jvb3R9LnN0b3J5Q2hhcmFjdGVyc1RvU2VsZWN0b3JgKV07XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuRXh0ZXJuYWxDaGFyYWN0ZXJTZWxlY3RvcnMuZm9yRWFjaChjbGVhckVsKTtcclxuXHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9LnN0b3J5Q2hhcmFjdGVyc1RhYmxlYCkpO1xyXG5cclxuICAgICAgICBpZiAoIVN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpKSB7IHJldHVybjsgfVxyXG5cclxuICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIuaXNFbnRpdHlFZGl0YWJsZSgnc3RvcnknLCBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgKGVyciwgaXNTdG9yeUVkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjIsIGFsbENoYXJhY3RlcnMpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0U3RvcnlDaGFyYWN0ZXJzKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCAoZXJyMywgbG9jYWxDaGFyYWN0ZXJzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjMpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMyk7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UoYWxsQ2hhcmFjdGVycywgbG9jYWxDaGFyYWN0ZXJzKTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNTdG9yeUVkaXRhYmxlJywgaXNTdG9yeUVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICBTdG9yaWVzLmNoYWluUmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiByZWJ1aWxkSW50ZXJmYWNlKGFsbENoYXJhY3RlcnMsIGxvY2FsQ2hhcmFjdGVycykge1xyXG4gICAgICAgIGNvbnN0IGFkZEFycmF5ID0gW107XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlQXJyYXkgPSBbXTtcclxuXHJcbiAgICAgICAgYWxsQ2hhcmFjdGVycy5maWx0ZXIobmFtZUluZm8gPT4gIWxvY2FsQ2hhcmFjdGVyc1tuYW1lSW5mby52YWx1ZV0pLmZvckVhY2goKG5hbWVJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIGFkZEFycmF5LnB1c2gobmFtZUluZm8pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBhbGxDaGFyYWN0ZXJzLmZpbHRlcihuYW1lSW5mbyA9PiBsb2NhbENoYXJhY3RlcnNbbmFtZUluZm8udmFsdWVdKS5mb3JFYWNoKChuYW1lSW5mbykgPT4ge1xyXG4gICAgICAgICAgICByZW1vdmVBcnJheS5wdXNoKG5hbWVJbmZvKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYWRkQXJyYXkuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCk7XHJcbiAgICAgICAgcmVtb3ZlQXJyYXkuc29ydChVdGlscy5jaGFyT3JkQU9iamVjdCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGFkZERhdGEgPSBnZXRTZWxlY3QyRGF0YShhZGRBcnJheSk7XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlRGF0YSA9IGdldFNlbGVjdDJEYXRhKHJlbW92ZUFycmF5KTtcclxuXHJcbiAgICAgICAgc3RhdGUuRXh0ZXJuYWxDaGFyYWN0ZXJTZWxlY3RvcnMuZm9yRWFjaCgoc2VsZWN0b3IpID0+IHtcclxuICAgICAgICAgICAgJChzZWxlY3Rvcikuc2VsZWN0MihhZGREYXRhKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0uc3RvcnlDaGFyYWN0ZXJzVGFibGVgKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc2hvd0VsKHFlKGAke3Jvb3R9IHRhYmxlYCksIFIua2V5cyhsb2NhbENoYXJhY3RlcnMpLmxlbmd0aCAhPT0gMCApO1xyXG4gICAgICAgIHNob3dFbChxZShgJHtyb290fSAuYWxlcnRgKSwgUi5rZXlzKGxvY2FsQ2hhcmFjdGVycykubGVuZ3RoID09PSAwICk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVtb3ZlQXJyYXkuZm9yRWFjaCgocmVtb3ZlVmFsdWUpID0+IHtcclxuICAgICAgICAgICAgYWRkRWwodGFibGUsIGdldENoYXJhY3RlcklucHV0KHJlbW92ZVZhbHVlLCBsb2NhbENoYXJhY3RlcnNbcmVtb3ZlVmFsdWUudmFsdWVdKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYWRkQ2hhcmFjdGVyKGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoYXJhY3Rlck5hbWUgPSBxdWVyeUVsKGAke3N1cGVyUm9vdH0uc3RvcnlDaGFyYWN0ZXJzQWRkU2VsZWN0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIERCTVMuYWRkU3RvcnlDaGFyYWN0ZXIoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGNoYXJhY3Rlck5hbWUsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZy5oaWRlRGxnKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3dpdGNoQ2hhcmFjdGVycyhkaWFsb2cpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0b05hbWUgPSBxdWVyeUVsKGAke3Jvb3R9LnN0b3J5Q2hhcmFjdGVyc1RvU2VsZWN0b3JgKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIERCTVMuc3dpdGNoU3RvcnlDaGFyYWN0ZXJzKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBkaWFsb2cuY2hhcmFjdGVyTmFtZSwgdG9OYW1lLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUNoYXJhY3RlcihjaGFyYWN0ZXJOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignc3Rvcmllcy1yZW1vdmUtY2hhcmFjdGVyLWZyb20tc3Rvcnktd2FybmluZycpLCBbY2hhcmFjdGVyTmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZVN0b3J5Q2hhcmFjdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoYXJhY3Rlck5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldENoYXJhY3RlcklucHV0KGNoYXJhY3Rlck1ldGEsIGNoYXJhY3Rlcikge1xyXG4gICAgICAgIGNvbnN0IGVsID0gd3JhcEVsKCd0cicsIHF0ZShgJHtyb290fSAuc3RvcnktY2hhcmFjdGVyLXJvdy10bXBsYCkpO1xyXG4gICAgICAgIEwxMG4ubG9jYWxpemVTdGF0aWMoZWwpO1xyXG4gICAgICAgIGNvbnN0IHFlID0gcWVlKGVsKTtcclxuXHJcbiAgICAgICAgYWRkRWwocWUoJy5jaGFyYWN0ZXItbmFtZScpLCBtYWtlVGV4dChjaGFyYWN0ZXJNZXRhLmRpc3BsYXlOYW1lKSk7XHJcblxyXG4gICAgICAgIGxldCBpbnB1dCA9IHFlKCcuaW52ZW50b3J5SW5wdXQnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IGNoYXJhY3Rlci5pbnZlbnRvcnk7XHJcbiAgICAgICAgaW5wdXQuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIHVwZGF0ZUNoYXJhY3RlckludmVudG9yeSk7XHJcblxyXG4gICAgICAgIENvbnN0YW50cy5jaGFyYWN0ZXJBY3Rpdml0eVR5cGVzLmZvckVhY2goKGFjdGl2aXR5VHlwZSkgPT4ge1xyXG4gICAgICAgICAgICBpbnB1dCA9IHFlKGAuJHthY3Rpdml0eVR5cGV9IGlucHV0YCk7XHJcbiAgICAgICAgICAgIGlmIChjaGFyYWN0ZXIuYWN0aXZpdHlbYWN0aXZpdHlUeXBlXSkge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaW5wdXQuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgICAgICBpbnB1dC5hY3Rpdml0eVR5cGUgPSBhY3Rpdml0eVR5cGU7XHJcbiAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIG9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAnaWQnLCBjaGFyYWN0ZXIubmFtZSArIGFjdGl2aXR5VHlwZSk7XHJcbiAgICAgICAgICAgIHNldEF0dHIocWUoYC4ke2FjdGl2aXR5VHlwZX0gbGFiZWxgKSwgJ2ZvcicsIGNoYXJhY3Rlci5uYW1lICsgYWN0aXZpdHlUeXBlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlKCcucmVwbGFjZS5jaGFyYWN0ZXInKSwgJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBzdGF0ZS5zd2l0Y2hDaGFyYWN0ZXJEaWFsb2cuY2hhcmFjdGVyTmFtZSA9IGNoYXJhY3Rlci5uYW1lO1xyXG4gICAgICAgICAgICBzdGF0ZS5zd2l0Y2hDaGFyYWN0ZXJEaWFsb2cuc2hvd0RsZygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxpc3RlbihxZSgnLnJlbW92ZS5jaGFyYWN0ZXInKSwgJ2NsaWNrJywgcmVtb3ZlQ2hhcmFjdGVyKGNoYXJhY3Rlci5uYW1lKSk7XHJcbiAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUNoYXJhY3RlckludmVudG9yeShldmVudCkge1xyXG4gICAgICAgIERCTVMudXBkYXRlQ2hhcmFjdGVySW52ZW50b3J5KFxyXG4gICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSxcclxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNoYXJhY3Rlck5hbWUsIGV2ZW50LnRhcmdldC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkoZXZlbnQpIHtcclxuICAgICAgICBEQk1TLm9uQ2hhbmdlQ2hhcmFjdGVyQWN0aXZpdHkoXHJcbiAgICAgICAgICAgIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBldmVudC50YXJnZXQuY2hhcmFjdGVyTmFtZSxcclxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmFjdGl2aXR5VHlwZSwgZXZlbnQudGFyZ2V0LmNoZWNrZWQsIFV0aWxzLnByb2Nlc3NFcnJvcigpXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufSkodGhpcy5TdG9yeUNoYXJhY3RlcnMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy5zdG9yeS1ldmVudHMtdGFiICc7XHJcbiAgICBsZXQgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGluaXRpYWxpemVkKSByZXR1cm47XHJcbiAgICAgICAgZXhwb3J0cy5jcmVhdGVFdmVudERpYWxvZyA9IFVJLmNyZWF0ZU1vZGFsRGlhbG9nKCcuc3Rvcmllcy10YWIgJywgY3JlYXRlRXZlbnQsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnY3JlYXRlLWV2ZW50LWJvZHknLFxyXG4gICAgICAgICAgICBkaWFsb2dUaXRsZTogJ3N0b3JpZXMtZXZlbnQtY3JlYXRpb24nLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1jcmVhdGUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgbGlzdGVuKHFlKGAke3Jvb3R9LmNyZWF0ZS5ldmVudGApLCAnY2xpY2snLCAoKSA9PiBjcmVhdGVFdmVudERpYWxvZy5zaG93RGxnKCkpO1xyXG5cclxuICAgICAgICBzdGF0ZS5tb3ZlRXZlbnREaWFsb2cgPSBVSS5jcmVhdGVNb2RhbERpYWxvZyhyb290LCBtb3ZlRXZlbnQsIHtcclxuICAgICAgICAgICAgYm9keVNlbGVjdG9yOiAnbW92ZS1ldmVudC1ib2R5JyxcclxuICAgICAgICAgICAgZGlhbG9nVGl0bGU6ICdzdG9yaWVzLW1vdmUtZXZlbnQnLFxyXG4gICAgICAgICAgICBhY3Rpb25CdXR0b25UaXRsZTogJ2NvbW1vbi1tb3ZlJyxcclxuICAgICAgICB9KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxZShyb290KTtcclxuICAgICAgICBpbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjbGVhckludGVyZmFjZSgpO1xyXG4gICAgICAgIGlmIChTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5pc0VudGl0eUVkaXRhYmxlKCdzdG9yeScsIFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCAoZXJyLCBpc1N0b3J5RWRpdGFibGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyMiwgbWV0YUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIERCTVMuZ2V0U3RvcnlFdmVudHMoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIChlcnIzLCBldmVudHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMykgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIzKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmVidWlsZEludGVyZmFjZShldmVudHMsIG1ldGFJbmZvKTtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5lbmFibGUoZXhwb3J0cy5jb250ZW50LCAnaXNTdG9yeUVkaXRhYmxlJywgaXNTdG9yeUVkaXRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICBTdG9yaWVzLmNoYWluUmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjbGVhckludGVyZmFjZSgpIHtcclxuICAgICAgICBjbGVhckVsKGdldEVsKCdldmVudEJsb2NrJykpO1xyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3JzID0gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmV2ZW50UG9zaXRpb25TZWxlY3RvcicpKTtcclxuICAgICAgICBSLmFwKFtjbGVhckVsXSwgcG9zaXRpb25TZWxlY3RvcnMpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdG9yQXJyID0gbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmV2ZW50RWRpdFNlbGVjdG9yJykpO1xyXG4gICAgICAgIFIuYXAoW2NsZWFyRWxdLCBzZWxlY3RvckFycik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gcmVidWlsZEludGVyZmFjZShldmVudHMsIG1ldGFJbmZvKSB7XHJcbiAgICAgICAgLy8gZXZlbnQgcGFydFxyXG4gICAgICAgIGNvbnN0IHRhYmxlID0gY2xlYXJFbChnZXRFbCgnZXZlbnRCbG9jaycpKTtcclxuICAgICAgICBcclxuICAgICAgICBzaG93RWwodGFibGUsIGV2ZW50cy5sZW5ndGggIT09IDAgKTtcclxuICAgICAgICBzaG93RWwocWUoYCR7cm9vdH0gLmFsZXJ0YCksIGV2ZW50cy5sZW5ndGggPT09IDAgKTtcclxuXHJcbiAgICAgICAgLy8gcmVmcmVzaCBwb3NpdGlvbiBzZWxlY3RvclxyXG4gICAgICAgIGNvbnN0IGFkZE9wdCA9IFIuY3VycnkoKHNlbCwgdGV4dCkgPT4ge1xyXG4gICAgICAgICAgICBhZGRFbChzZWwsIGFkZEVsKG1ha2VFbCgnb3B0aW9uJyksIG1ha2VUZXh0KHRleHQpKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCBvcHRpb24sIGFkZE9wdExvYztcclxuICAgICAgICBjb25zdCBwb3NpdGlvblNlbGVjdG9ycyA9IG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5ldmVudFBvc2l0aW9uU2VsZWN0b3InKSk7XHJcbiAgICAgICAgUi5hcChbY2xlYXJFbF0sIHBvc2l0aW9uU2VsZWN0b3JzKTtcclxuICAgICAgICBwb3NpdGlvblNlbGVjdG9ycy5mb3JFYWNoKChwb3NpdGlvblNlbGVjdG9yKSA9PiB7XHJcbiAgICAgICAgICAgIGFkZE9wdExvYyA9IGFkZE9wdChwb3NpdGlvblNlbGVjdG9yKTtcclxuXHJcbiAgICAgICAgICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYWRkT3B0TG9jKHN0ckZvcm1hdChnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYmVmb3JlJyksIFtldmVudC5uYW1lXSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGFkZE9wdExvYyhnZXRMMTBuKCdjb21tb24tc2V0LWl0ZW0tYXMtbGFzdCcpKTtcclxuXHJcbiAgICAgICAgICAgIHBvc2l0aW9uU2VsZWN0b3Iuc2VsZWN0ZWRJbmRleCA9IGV2ZW50cy5sZW5ndGg7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmV2ZW50c0xlbmd0aCA9IGV2ZW50cy5sZW5ndGg7XHJcblxyXG4gICAgICAgIFIuYXAoW2FkZEVsKHRhYmxlKV0sIGV2ZW50cy5tYXAoKGV2ZW50LCBpLCBldmVudHMyKSA9PlxyXG4gICAgICAgICAgICBhcHBlbmRFdmVudElucHV0KGV2ZW50LCBpLCBldmVudHMyLCBtZXRhSW5mby5kYXRlLCBtZXRhSW5mby5wcmVHYW1lRGF0ZSkpKTtcclxuXHJcbiAgICAgICAgLy8gcmVmcmVzaCBzd2FwIHNlbGVjdG9yXHJcbiAgICAgICAgY29uc3Qgc2VsZWN0b3JBcnIgPSBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZXZlbnRFZGl0U2VsZWN0b3InKSk7XHJcbiAgICAgICAgUi5hcChbY2xlYXJFbF0sIHNlbGVjdG9yQXJyKTtcclxuXHJcbiAgICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50LCBpKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGVjdG9yQXJyLmZvckVhY2goKHNlbGVjdG9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgICAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KGV2ZW50Lm5hbWUpKTtcclxuICAgICAgICAgICAgICAgIG9wdGlvbi5ldmVudEluZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50KGRpYWxvZykge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZUlucHV0ID0gcWVlKGRpYWxvZywgJy5ldmVudE5hbWVJbnB1dCcpO1xyXG4gICAgICAgICAgICBjb25zdCBldmVudE5hbWUgPSBldmVudE5hbWVJbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uU2VsZWN0b3IgPSBxZWUoZGlhbG9nLCAnLnBvc2l0aW9uU2VsZWN0b3InKTtcclxuXHJcbiAgICAgICAgICAgIERCTVMuY3JlYXRlRXZlbnQoXHJcbiAgICAgICAgICAgICAgICBTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgZXZlbnROYW1lLCBwb3NpdGlvblNlbGVjdG9yLnNlbGVjdGVkSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRFcnJvcihkaWFsb2csIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnROYW1lSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmhpZGVEbGcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYXBwZW5kRXZlbnRJbnB1dChldmVudCwgaW5kZXgsIGV2ZW50cywgZGF0ZSwgcHJlR2FtZURhdGUpIHtcclxuICAgICAgICBjb25zdCBlbCA9IHdyYXBFbCgndHInLCBxdGUoYCR7cm9vdH0gLmV2ZW50LXRtcGxgKSk7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYyhlbCk7XHJcbiAgICAgICAgY29uc3QgcWUgPSBxZWUoZWwpO1xyXG4gICAgICAgIGFkZEVsKHFlKCcuZXZlbnQtbnVtYmVyJyksIG1ha2VUZXh0KGluZGV4ICsgMSkpO1xyXG4gICAgICAgIGNvbnN0IG5hbWVJbnB1dCA9IHFlKCcuZXZlbnQtbmFtZS1pbnB1dCcpO1xyXG4gICAgICAgIG5hbWVJbnB1dC52YWx1ZSA9IGV2ZW50Lm5hbWU7XHJcbiAgICAgICAgbmFtZUlucHV0LmV2ZW50SW5kZXggPSBpbmRleDtcclxuICAgICAgICBsaXN0ZW4obmFtZUlucHV0LCAnY2hhbmdlJywgdXBkYXRlRXZlbnROYW1lKTtcclxuXHJcbiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gcWUoJy5ldmVudC10ZXh0Jyk7XHJcbiAgICAgICAgdGV4dElucHV0LnZhbHVlID0gZXZlbnQudGV4dDtcclxuICAgICAgICB0ZXh0SW5wdXQuZXZlbnRJbmRleCA9IGluZGV4O1xyXG4gICAgICAgIGxpc3Rlbih0ZXh0SW5wdXQsICdjaGFuZ2UnLCB1cGRhdGVFdmVudFRleHQpO1xyXG5cclxuICAgICAgICBVSS5tYWtlRXZlbnRUaW1lUGlja2VyMihxZSgnLmV2ZW50LXRpbWUnKSwge1xyXG4gICAgICAgICAgICBldmVudFRpbWU6IGV2ZW50LnRpbWUsXHJcbiAgICAgICAgICAgIGluZGV4LFxyXG4gICAgICAgICAgICBwcmVHYW1lRGF0ZSxcclxuICAgICAgICAgICAgZGF0ZSxcclxuICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZUNyZWF0b3JcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGlzdGVuKHFlZShlbCwgJy5tb3ZlJyksICdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgc3RhdGUubW92ZUV2ZW50RGlhbG9nLmluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHN0YXRlLm1vdmVFdmVudERpYWxvZy5zaG93RGxnKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICcuY2xvbmUnKSwgJ2NsaWNrJywgY2xvbmVFdmVudChpbmRleCkpO1xyXG4gICAgICAgIGlmIChzdGF0ZS5ldmVudHNMZW5ndGggPT09IGluZGV4ICsgMSkge1xyXG4gICAgICAgICAgICBzZXRBdHRyKHFlZShlbCwgJy5tZXJnZScpLCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsaXN0ZW4ocWVlKGVsLCAnLm1lcmdlJyksICdjbGljaycsIG1lcmdlRXZlbnRzKGluZGV4LCBldmVudC5uYW1lLCBldmVudHNbaW5kZXggKyAxXS5uYW1lKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxpc3RlbihxZWUoZWwsICcucmVtb3ZlJyksICdjbGljaycsIHJlbW92ZUV2ZW50KGV2ZW50Lm5hbWUsIGluZGV4KSk7XHJcblxyXG4gICAgICAgIHJldHVybiBlbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtb3ZlRXZlbnQoZGlhbG9nKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3SW5kZXggPSBxdWVyeUVsKCcubW92ZVBvc2l0aW9uU2VsZWN0b3InKS5zZWxlY3RlZEluZGV4O1xyXG5cclxuICAgICAgICAgICAgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCk7XHJcbiAgICAgICAgICAgIERCTVMubW92ZUV2ZW50KFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBkaWFsb2cuaW5kZXgsIG5ld0luZGV4LCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZGlhbG9nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkaWFsb2cuaGlkZURsZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNsb25lRXZlbnQoaW5kZXgpIHtcclxuICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLmNsb25lRXZlbnQoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGluZGV4LCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtZXJnZUV2ZW50cyhpbmRleCwgZmlyc3ROYW1lLCBzZWNvbmROYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLmV2ZW50c0xlbmd0aCA9PT0gaW5kZXggKyAxKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdzdG9yaWVzLWNhbnQtbWVyZ2UtbGFzdC1ldmVudCcpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShMMTBuLmZvcm1hdCgnc3RvcmllcycsICdjb25maXJtLWV2ZW50LW1lcmdlJywgW2ZpcnN0TmFtZSwgc2Vjb25kTmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLm1lcmdlRXZlbnRzKFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBpbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZUV2ZW50KG5hbWUsIGluZGV4KSB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignc3Rvcmllcy1yZW1vdmUtZXZlbnQtd2FybmluZycpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZUV2ZW50KFN0b3JpZXMuZ2V0Q3VycmVudFN0b3J5TmFtZSgpLCBpbmRleCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldEV2ZW50SGVhZGVyKCkge1xyXG4gICAgICAgIGNvbnN0IHRyID0gbWFrZUVsKCd0cicpO1xyXG4gICAgICAgIGFkZEVsKHRyLCBhZGRFbChtYWtlRWwoJ3RoJyksIG1ha2VUZXh0KCfihJYnKSkpO1xyXG4gICAgICAgIGFkZEVsKHRyLCBhZGRFbChtYWtlRWwoJ3RoJyksIG1ha2VUZXh0KGdldEwxMG4oJ3N0b3JpZXMtZXZlbnQnKSkpKTtcclxuICAgICAgICByZXR1cm4gdHI7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25DaGFuZ2VEYXRlVGltZUNyZWF0b3IobXlJbnB1dCkge1xyXG4gICAgICAgIHJldHVybiAoZHAsIGlucHV0KSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RXZlbnRPcmlnaW5Qcm9wZXJ0eShTdG9yaWVzLmdldEN1cnJlbnRTdG9yeU5hbWUoKSwgbXlJbnB1dC5ldmVudEluZGV4LCAndGltZScsIGlucHV0LnZhbCgpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgU3RvcnlFdmVudHMubGFzdERhdGUgPSBpbnB1dC52YWwoKTtcclxuICAgICAgICAgICAgcmVtb3ZlQ2xhc3MobXlJbnB1dCwgJ2RlZmF1bHREYXRlJyk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFdmVudE5hbWUoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50T3JpZ2luUHJvcGVydHkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGlucHV0LmV2ZW50SW5kZXgsICduYW1lJywgaW5wdXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVFdmVudFRleHQoZXZlbnQpIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50T3JpZ2luUHJvcGVydHkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIGlucHV0LmV2ZW50SW5kZXgsICd0ZXh0JywgaW5wdXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH1cclxufSkodGhpcy5TdG9yeUV2ZW50cyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNSBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgbGlzdGVuKGdldEVsKCd3cml0ZXJTdG9yeUFyZWEnKSwgJ2NoYW5nZScsIHVwZGF0ZVdyaXRlclN0b3J5KTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBnZXRFbCgnd3JpdGVyU3RvcnlEaXYyJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVmcmVzaCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBzdG9yeUFyZWEgPSBnZXRFbCgnd3JpdGVyU3RvcnlBcmVhJyk7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlOYW1lID0gU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCk7XHJcblxyXG4gICAgICAgIGlmIChzdG9yeU5hbWUpIHtcclxuICAgICAgICAgICAgREJNUy5nZXRXcml0ZXJTdG9yeShzdG9yeU5hbWUsIChlcnIsIHN0b3J5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgc3RvcnlBcmVhLnZhbHVlID0gc3Rvcnk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0b3J5QXJlYS52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gdXBkYXRlV3JpdGVyU3RvcnkoKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcnlBcmVhID0gZ2V0RWwoJ3dyaXRlclN0b3J5QXJlYScpO1xyXG4gICAgICAgIERCTVMuc2V0V3JpdGVyU3RvcnkoU3Rvcmllcy5nZXRDdXJyZW50U3RvcnlOYW1lKCksIHN0b3J5QXJlYS52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfVxyXG59KSh0aGlzLldyaXRlclN0b3J5ID0ge30pO1xyXG4iLCIvKkNvcHlyaWdodCAyMDE4IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBCcmllZmluZ1ByZXZpZXcsIEJyaWVmaW5nRXhwb3J0XHJcbiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuZnVuY3Rpb24gUm91dGluZ1RhYlRtcGwoZXhwb3J0cywgb3B0cykge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIGNvbnN0IHRtcGxSb290ID0gJy50YWItcm91dGluZy10bXBsJztcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBxdWVyeUVsKHRtcGxSb290KS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MoZWwsICd0YWItcm91dGluZy10bXBsJyk7XHJcbiAgICAgICAgYWRkRWwocXVlcnlFbCgnLnRhYi1jb250YWluZXInKSwgZWwpO1xyXG4gICAgICAgIHN0YXRlLnZpZXdzID0ge307XHJcbiAgICAgICAgY29uc3QgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHFlZShlbCwgJy5zdWItdGFiLW5hdmlnYXRpb24nKSxcclxuICAgICAgICAgICAgY29udGVudDogcWVlKGVsLCAnLnN1Yi10YWItY29udGVudCcpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCB0YWJzID0gUi5pbmRleEJ5KFIucHJvcCgndmlld05hbWUnKSwgb3B0cy50YWJzLm1hcCh0YWIgPT4gKHtcclxuICAgICAgICAgICAgdmlld05hbWU6IHRhYi52aWV3TmFtZSxcclxuICAgICAgICAgICAgdmlld1JlczogVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCB0YWIuYnRuTmFtZSwgd2luZG93W3RhYi52aWV3TmFtZV0pXHJcbiAgICAgICAgfSkpKTtcclxuXHJcbiAgICAgICAgVXRpbHMuc2V0Rmlyc3RUYWIoY29udGFpbmVycywgdGFic1tvcHRzLmZpcnN0VGFiXS52aWV3UmVzKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBlbDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gKCkgPT4ge1xyXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuICAgIH07XHJcbn1cclxuXHJcblJvdXRpbmdUYWJUbXBsKHRoaXMuQnJpZWZpbmdzID0ge30sIHtcclxuICAgIGZpcnN0VGFiOiAnQnJpZWZpbmdQcmV2aWV3JyxcclxuICAgIHRhYnM6IFt7XHJcbiAgICAgICAgYnRuTmFtZTogJ2JyaWVmaW5nLXByZXZpZXcnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQnJpZWZpbmdQcmV2aWV3J1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdicmllZmluZy1leHBvcnQnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQnJpZWZpbmdFeHBvcnQnXHJcbiAgICB9XVxyXG59KTtcclxuXHJcblJvdXRpbmdUYWJUbXBsKHRoaXMuQ2hhcmFjdGVycyA9IHt9LCB7XHJcbiAgICBmaXJzdFRhYjogJ0NoYXJhY3RlckVkaXRvcicsXHJcbiAgICB0YWJzOiBbe1xyXG4gICAgICAgIGJ0bk5hbWU6ICdmaWxsaW5nLXByb2ZpbGUnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnQ2hhcmFjdGVyRWRpdG9yJ1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdjaGFuZ2luZy1wcm9maWxlLXN0cnVjdHVyZScsXHJcbiAgICAgICAgdmlld05hbWU6ICdDaGFyYWN0ZXJDb25maWd1cmVyJ1xyXG4gICAgfSwge1xyXG4gICAgICAgIGJ0bk5hbWU6ICdiaW5kaW5nLWNoYXJhY3RlcnMtYW5kLXBsYXllcnMnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnUHJvZmlsZUJpbmRpbmcyJ1xyXG4gICAgfV1cclxufSk7XHJcblxyXG5Sb3V0aW5nVGFiVG1wbCh0aGlzLlBsYXllcnMgPSB7fSwge1xyXG4gICAgZmlyc3RUYWI6ICdQbGF5ZXJFZGl0b3InLFxyXG4gICAgdGFiczogW3tcclxuICAgICAgICBidG5OYW1lOiAnZmlsbGluZy1wcm9maWxlJyxcclxuICAgICAgICB2aWV3TmFtZTogJ1BsYXllckVkaXRvcidcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnY2hhbmdpbmctcHJvZmlsZS1zdHJ1Y3R1cmUnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnUGxheWVyQ29uZmlndXJlcidcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnYmluZGluZy1jaGFyYWN0ZXJzLWFuZC1wbGF5ZXJzJyxcclxuICAgICAgICB2aWV3TmFtZTogJ1Byb2ZpbGVCaW5kaW5nMidcclxuICAgIH1dXHJcbn0pO1xyXG5cclxuUm91dGluZ1RhYlRtcGwodGhpcy5Mb2dWaWV3ZXIyID0ge30sIHtcclxuICAgIGZpcnN0VGFiOiAnTG9nVmlld2VyJyxcclxuICAgIHRhYnM6IFt7XHJcbiAgICAgICAgYnRuTmFtZTogJ2xvZ1ZpZXdlcicsXHJcbiAgICAgICAgdmlld05hbWU6ICdMb2dWaWV3ZXInXHJcbiAgICB9LCB7XHJcbiAgICAgICAgYnRuTmFtZTogJ2dyb3VwLXNjaGVtYScsXHJcbiAgICAgICAgdmlld05hbWU6ICdHcm91cFNjaGVtYSdcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAnaW52ZXN0aWdhdGlvbi1ib2FyZCcsXHJcbiAgICAgICAgdmlld05hbWU6ICdJbnZlc3RpZ2F0aW9uQm9hcmQnXHJcbiAgICB9LCB7XHJcbiAgICAgICAgYnRuTmFtZTogJ2Fib3V0JyxcclxuICAgICAgICB2aWV3TmFtZTogJ0Fib3V0J1xyXG4gICAgfV1cclxufSk7XHJcblxyXG5Sb3V0aW5nVGFiVG1wbCh0aGlzLkFjY2Vzc01hbmFnZXIgPSB7fSwge1xyXG4gICAgZmlyc3RUYWI6ICdPcmdhbml6ZXJNYW5hZ2VtZW50JyxcclxuICAgIHRhYnM6IFt7XHJcbiAgICAgICAgYnRuTmFtZTogJ29yZ2FuaXplck1hbmFnZW1lbnQnLFxyXG4gICAgICAgIHZpZXdOYW1lOiAnT3JnYW5pemVyTWFuYWdlbWVudCdcclxuICAgIH0sIHtcclxuICAgICAgICBidG5OYW1lOiAncGxheWVyTWFuYWdlbWVudCcsXHJcbiAgICAgICAgdmlld05hbWU6ICdQbGF5ZXJNYW5hZ2VtZW50J1xyXG4gICAgfV1cclxufSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHJvb3QgPSAnLnRleHQtc2VhcmNoLXRhYiAnO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChgJHtyb290fS50ZXh0LXNlYXJjaC1idXR0b25gKSwgJ2NsaWNrJywgZmluZFRleHRzKTtcclxuICAgICAgICBsaXN0ZW5PbkVudGVyKHF1ZXJ5RWwoYCR7cm9vdH0udGV4dC1zZWFyY2gtaW5wdXRgKSwgZmluZFRleHRzKTtcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGZpbmRUZXh0cygpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZFRleHRUeXBlcyA9IHF1ZXJ5RWxFbHMocXVlcnlFbChyb290KSwgYCR7cm9vdH0udGV4dFNlYXJjaFR5cGVSYWRpb2ApXHJcbiAgICAgICAgICAgIC5maWx0ZXIoZWwgPT4gZWwuY2hlY2tlZCkubWFwKGVsID0+IGVsLnZhbHVlKTtcclxuICAgICAgICBjb25zdCBzZWFyY2hTdHIgPSBxdWVyeUVsKGAke3Jvb3R9LnRleHQtc2VhcmNoLWlucHV0YCkudmFsdWU7XHJcbiAgICAgICAgY29uc3QgY2FzZVNlbnNpdGl2ZSA9IGdldEVsKCdjYXNlU2Vuc2l0aXZlVGV4dFNlYXJjaCcpLmNoZWNrZWQ7XHJcbiAgICAgICAgREJNUy5nZXRUZXh0cyhzZWFyY2hTdHIsIHNlbGVjdGVkVGV4dFR5cGVzLCBjYXNlU2Vuc2l0aXZlLCAoZXJyLCB0ZXh0cykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZXh0MnBhbmVsID0gdGV4dCA9PlxyXG4gICAgICAgICAgICAgICAgbWFrZVBhbmVsKFxyXG4gICAgICAgICAgICAgICAgICAgIG1ha2VUZXh0KGAke2dldEwxMG4oYHRleHQtc2VhcmNoLSR7dGV4dC50ZXh0VHlwZX1gKX0gKCR7dGV4dC5yZXN1bHQubGVuZ3RofSlgKSxcclxuICAgICAgICAgICAgICAgICAgICBtYWtlUGFuZWxDb250ZW50KHRleHQsIHNlYXJjaFN0ciwgY2FzZVNlbnNpdGl2ZSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGFkZEVscyhjbGVhckVsKHF1ZXJ5RWwoYCR7cm9vdH0ucmVzdWx0LXBhbmVsYCkpLCB0ZXh0cy5tYXAodGV4dDJwYW5lbCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VQYW5lbENvbnRlbnQodGV4dHNJbmZvLCBzZWFyY2hTdHIsIGNhc2VTZW5zaXRpdmUpIHtcclxuICAgICAgICB0ZXh0c0luZm8ucmVzdWx0LnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgnbmFtZScpKSk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ2RpdicpLCB0ZXh0c0luZm8ucmVzdWx0Lm1hcCgodGV4dEluZm8pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaGVhZCA9IGFkZEVsKG1ha2VFbCgnZGl2JyksIG1ha2VUZXh0KHRleHRJbmZvLm5hbWUpKTtcclxuICAgICAgICAgICAgY29uc3QgYm9keSA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksIHRleHRJbmZvLnR5cGUgPT09ICd0ZXh0JyA/ICd0ZXh0LWJvZHknIDogJ3N0cmluZy1ib2R5Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChDb21tb25VdGlscy5lc2NhcGVSZWdFeHAoc2VhcmNoU3RyKSwgY2FzZVNlbnNpdGl2ZSA/ICdnJyA6ICdnaScpO1xyXG4gICAgICAgICAgICBib2R5LmlubmVySFRNTCA9IHRleHRJbmZvLnRleHQucmVwbGFjZShyZWdleCwgJzxzcGFuPiQmPC9zcGFuPicpO1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkRWxzKGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICd0ZXh0LWNhcmQnKSwgW2hlYWQsIGJvZHldKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZVBhbmVsKHRpdGxlLCBjb250ZW50KSB7XHJcbiAgICAgICAgY29uc3QgcGFuZWxJbmZvID0gVUkubWFrZVBhbmVsQ29yZSh0aXRsZSwgY29udGVudCk7XHJcbiAgICAgICAgVUkuYXR0YWNoUGFuZWxUb2dnbGVyKHBhbmVsSW5mby5hLCBwYW5lbEluZm8uY29udGVudERpdik7XHJcbiAgICAgICAgcGFuZWxJbmZvLmEuY2xpY2soKTtcclxuICAgICAgICByZXR1cm4gcGFuZWxJbmZvLnBhbmVsO1xyXG4gICAgfVxyXG59KSh0aGlzLlRleHRTZWFyY2ggPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBjb25zdCByb290ID0gJy50aW1lbGluZS10YWInO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBsaXN0ZW4oZ2V0RWwoJ3RpbWVsaW5lU3RvcnlTZWxlY3RvcicpLCAnY2hhbmdlJywgb25TdG9yeVNlbGVjdG9yQ2hhbmdlRGVsZWdhdGUpO1xyXG5cclxuICAgICAgICBzdGF0ZS5UaW1lbGluZURhdGFzZXQgPSBuZXcgdmlzLkRhdGFTZXQoKTtcclxuICAgICAgICBzdGF0ZS5UYWdEYXRhc2V0ID0gbmV3IHZpcy5EYXRhU2V0KCk7XHJcblxyXG4gICAgICAgIHF1ZXJ5RWxzKGAke3Jvb3R9IGlucHV0W25hbWU9dGltZWxpbmVGaWx0ZXJdYCkubWFwKGxpc3RlbihSLl9fLCAnY2hhbmdlJywgcmVmcmVzaFRpbWVsaW5lKSk7XHJcbiAgICAgICAgZ2V0RWwoJ3RpbWVsaW5lRmlsdGVyQnlTdG9yeScpLmNoZWNrZWQgPSB0cnVlO1xyXG5cclxuICAgICAgICAvLyBzcGVjaWZ5IG9wdGlvbnNcclxuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICBvcmllbnRhdGlvbjogJ3RvcCcsXHJcbiAgICAgICAgICAgIHNob3dDdXJyZW50VGltZTogZmFsc2UsXHJcbiAgICAgICAgICAgIC8vICAgICAgICBlZGl0YWJsZSA6IHtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICB1cGRhdGVUaW1lIDogdHJ1ZVxyXG4gICAgICAgICAgICAvLyAgICAgICAgfSxcclxuICAgICAgICAgICAgLy8gICAgICAgIG9uTW92ZSA6IGZ1bmN0aW9uIChpdGVtLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIGlmIChpdGVtLnN0b3J5TmFtZSkge1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBEQk1TLnNldEV2ZW50VGltZShpdGVtLnN0b3J5TmFtZSwgaXRlbS5ldmVudEluZGV4LCBpdGVtLnN0YXJ0LCBmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGl0ZW0pO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyAgICAgICAgbXVsdGlzZWxlY3QgOiB0cnVlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgdGltZWxpbmUgPSBuZXcgdmlzLlRpbWVsaW5lKGdldEVsKCd0aW1lbGluZUNvbnRhaW5lcicpLCBudWxsLCBvcHRpb25zKTtcclxuICAgICAgICB0aW1lbGluZS5zZXRHcm91cHMoc3RhdGUuVGFnRGF0YXNldCk7XHJcbiAgICAgICAgdGltZWxpbmUuc2V0SXRlbXMoc3RhdGUuVGltZWxpbmVEYXRhc2V0KTtcclxuICAgICAgICBzdGF0ZS50aW1lbGluZUNvbXBvbmVudCA9IHRpbWVsaW5lO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXRNZXRhSW5mbygoZXJyLCBtZXRhSW5mbykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG5cclxuICAgICAgICAgICAgc3RhdGUucG9zdERhdGUgPSBtZXRhSW5mby5kYXRlO1xyXG4gICAgICAgICAgICBzdGF0ZS5wcmVEYXRlID0gbWV0YUluZm8ucHJlR2FtZURhdGU7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUoc3RhdGUucG9zdERhdGUpO1xyXG4gICAgICAgICAgICBjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShzdGF0ZS5wcmVEYXRlKTtcclxuICAgICAgICAgICAgZW5kRGF0ZS5zZXRGdWxsWWVhcihlbmREYXRlLmdldEZ1bGxZZWFyKCkgKyAxKTtcclxuICAgICAgICAgICAgc3RhcnREYXRlLnNldEZ1bGxZZWFyKHN0YXJ0RGF0ZS5nZXRGdWxsWWVhcigpIC0gMSk7XHJcblxyXG4gICAgICAgICAgICBzdGF0ZS50aW1lbGluZUNvbXBvbmVudC5zZXRPcHRpb25zKHtcclxuICAgICAgICAgICAgICAgIGVuZDogZW5kRGF0ZSxcclxuICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydERhdGUsXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgREJNUy5nZXRFdmVudHNUaW1lSW5mbygoZXJyMSwgZXZlbnRzVGltZUluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIxKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjEpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50c1RpbWVJbmZvID0gZXZlbnRzVGltZUluZm87XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5ldmVudHNCeVN0b3JpZXMgPSBSLmdyb3VwQnkoUi5wcm9wKCdzdG9yeU5hbWUnKSwgZXZlbnRzVGltZUluZm8pO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzID0gUi51bmlxKFIuZmxhdHRlbihldmVudHNUaW1lSW5mby5tYXAoZXZlbnQgPT4gZXZlbnQuY2hhcmFjdGVycykpKTtcclxuICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50c0J5Q2hhcmFjdGVycyA9IFIuemlwT2JqKFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50c0J5Q2hhcmFjdGVycyxcclxuICAgICAgICAgICAgICAgICAgICBSLmFwKFtSLmNsb25lXSwgUi5yZXBlYXQoW10sIHN0YXRlLmV2ZW50c0J5Q2hhcmFjdGVycy5sZW5ndGgpKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIGV2ZW50c1RpbWVJbmZvLmZvckVhY2goZXZlbnQgPT4gZXZlbnQuY2hhcmFjdGVycy5mb3JFYWNoKGNoYXJhY3RlciA9PlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXRlLmV2ZW50c0J5Q2hhcmFjdGVyc1tjaGFyYWN0ZXJdLnB1c2goZXZlbnQpKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3N0b3J5JywgZmFsc2UsIChlcnIyLCBhbGxTdG9yeU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycjIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyMik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdjaGFyYWN0ZXInLCBmYWxzZSwgKGVycjMsIGFsbENoYXJhY3Rlck5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycjMpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4eShhbGxTdG9yeU5hbWVzLCBzdGF0ZS5ldmVudHNCeVN0b3JpZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5hbGxTdG9yeU5hbWVzID0gYWxsU3RvcnlOYW1lcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VmZml4eShhbGxDaGFyYWN0ZXJOYW1lcywgc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUuYWxsQ2hhcmFjdGVyTmFtZXMgPSBhbGxDaGFyYWN0ZXJOYW1lcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaFRpbWVsaW5lKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHN1ZmZpeHkoZW50aXR5TmFtZXMsIGRhdGEpIHtcclxuICAgICAgICBlbnRpdHlOYW1lcy5mb3JFYWNoKChuYW1lSW5mbykgPT4ge1xyXG4gICAgICAgICAgICBuYW1lSW5mby5oYXNFdmVudHMgPSBkYXRhW25hbWVJbmZvLnZhbHVlXSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlZnJlc2hUaW1lbGluZSgpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RvclZhbHVlcyA9IGdldEVsKCd0aW1lbGluZUZpbHRlckJ5U3RvcnknKS5jaGVja2VkID8gc3RhdGUuYWxsU3RvcnlOYW1lcyA6IHN0YXRlLmFsbENoYXJhY3Rlck5hbWVzO1xyXG5cclxuICAgICAgICBjb25zdCBzZWxlY3RvciA9IGNsZWFyRWwoZ2V0RWwoJ3RpbWVsaW5lU3RvcnlTZWxlY3RvcicpKTtcclxuICAgICAgICBmaWxsU2VsZWN0b3Ioc2VsZWN0b3IsIHNlbGVjdG9yVmFsdWVzLm1hcChvYmogPT4gKHtcclxuICAgICAgICAgICAgbmFtZTogb2JqLmRpc3BsYXlOYW1lLFxyXG4gICAgICAgICAgICB2YWx1ZTogb2JqLnZhbHVlLFxyXG4gICAgICAgICAgICBjbGFzc05hbWU6IG9iai5oYXNFdmVudHMgP1xyXG4gICAgICAgICAgICAgICAgJ2ZhLWljb24gZmluaXNoZWQgdHJhbnNwYXJlbnQtaWNvbiBzZWxlY3QtaWNvbi1wYWRkaW5nJyA6XHJcbiAgICAgICAgICAgICAgICAnZmEtaWNvbiBlbXB0eSBpY29uLXBhZGRpbmcgc2VsZWN0LWljb24tcGFkZGluZydcclxuICAgICAgICB9KSkpO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgc2VsZWN0b3JWYWx1ZXMubGVuZ3RoID4gMTUgPyAxNSA6IHNlbGVjdG9yVmFsdWVzLmxlbmd0aCk7XHJcblxyXG4gICAgICAgIGlmIChzZWxlY3RvclZhbHVlcy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgc2VsZWN0b3Iub3B0aW9uc1swXS5zZWxlY3RlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIG9uU3RvcnlTZWxlY3RvckNoYW5nZShbc2VsZWN0b3JWYWx1ZXNbMF0udmFsdWVdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb25TdG9yeVNlbGVjdG9yQ2hhbmdlRGVsZWdhdGUoZXZlbnQpIHtcclxuICAgICAgICBvblN0b3J5U2VsZWN0b3JDaGFuZ2UobmwyYXJyYXkoZXZlbnQudGFyZ2V0LnNlbGVjdGVkT3B0aW9ucykubWFwKG9wdCA9PiBvcHQudmFsdWUpKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwcmVwYXJlTGFiZWwgPSBsYWJlbCA9PiBgPHNwYW4gY2xhc3M9XCJ0aW1lbGluZS1sYWJlbFwiPiR7bGFiZWx9PC9zcGFuPmA7XHJcblxyXG4gICAgZnVuY3Rpb24gb25TdG9yeVNlbGVjdG9yQ2hhbmdlKGVudGl0eU5hbWVzKSB7XHJcbiAgICAgICAgc3RhdGUuVGFnRGF0YXNldC5jbGVhcigpO1xyXG4gICAgICAgIHN0YXRlLlRpbWVsaW5lRGF0YXNldC5jbGVhcigpO1xyXG5cclxuICAgICAgICBzdGF0ZS5UYWdEYXRhc2V0LmFkZChlbnRpdHlOYW1lcy5tYXAoZW50aXR5TmFtZSA9PiBSLmFsd2F5cyh7IGlkOiBlbnRpdHlOYW1lLCBjb250ZW50OiBlbnRpdHlOYW1lIH0pKCkpKTtcclxuXHJcbiAgICAgICAgY29uc3QgYnlTdG9yeSA9IGdldEVsKCd0aW1lbGluZUZpbHRlckJ5U3RvcnknKS5jaGVja2VkO1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBieVN0b3J5ID8gc3RhdGUuZXZlbnRzQnlTdG9yaWVzIDogc3RhdGUuZXZlbnRzQnlDaGFyYWN0ZXJzO1xyXG4gICAgICAgIGVudGl0eU5hbWVzID0gUi5pbnRlcnNlY3Rpb24oZW50aXR5TmFtZXMsIFIua2V5cyhkYXRhKSk7XHJcbiAgICAgICAgY29uc3QgdXNlZERhdGEgPSBSLnBpY2soZW50aXR5TmFtZXMsIGRhdGEpO1xyXG4gICAgICAgIGZpbGxUaW1lbGluZXModXNlZERhdGEpO1xyXG4gICAgICAgIGNvbnN0IGV2ZW50cyA9IFIudW5pcShSLmZsYXR0ZW4oUi52YWx1ZXModXNlZERhdGEpKVxyXG4gICAgICAgICAgICAgICAgLm1hcChldmVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQudGltZSA9IG5ldyBEYXRlKGV2ZW50LnRpbWUgIT09ICcnID8gZXZlbnQudGltZSA6IHN0YXRlLnBvc3REYXRlKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5jaGFyYWN0ZXJzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDtcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICBcclxuICAgICAgICBldmVudHMuc29ydChDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoUi5wcm9wKCd0aW1lJykpKTtcclxuICAgICAgICBcclxuICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKGAke3Jvb3R9IC50aW1lbGluZS1saXN0YCkpLCBldmVudHMubWFwKGV2ZW50ID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgcm93ID0gcW10ZShgJHtyb290fSAudGltZWxpbmUtZXZlbnQtdG1wbGApO1xyXG4gICAgICAgICAgICBhZGRFbChxZWUocm93LCAnLnRpbWUnKSwgbWFrZVRleHQoZXZlbnQudGltZS5mb3JtYXQoJ3l5eXkvbW0vZGQgaDpNTScpKSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHFlZShyb3csICcuc3RvcnktbmFtZScpLCBtYWtlVGV4dChldmVudC5zdG9yeU5hbWUpKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5ldmVudC1uYW1lJyksIG1ha2VUZXh0KGV2ZW50Lm5hbWUpKTtcclxuICAgICAgICAgICAgYWRkRWwocWVlKHJvdywgJy5jaGFyYWN0ZXJzJyksIG1ha2VUZXh0KGV2ZW50LmNoYXJhY3RlcnMuam9pbignLCAnKSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gcm93O1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgaWYgKGVudGl0eU5hbWVzWzBdKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLlRpbWVsaW5lRGF0YXNldC5hZGQoe1xyXG4gICAgICAgICAgICAgICAgY29udGVudDogcHJlcGFyZUxhYmVsKEwxMG4uZ2V0VmFsdWUoJ292ZXJ2aWV3LXByZS1nYW1lLWVuZC1kYXRlJykpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKHN0YXRlLnBvc3REYXRlKSxcclxuICAgICAgICAgICAgICAgIGdyb3VwOiBlbnRpdHlOYW1lc1swXSxcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogJ2ltcG9ydGFudEl0ZW0nLFxyXG4gICAgICAgICAgICAgICAgZWRpdGFibGU6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzdGF0ZS5UaW1lbGluZURhdGFzZXQuYWRkKHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHByZXBhcmVMYWJlbChMMTBuLmdldFZhbHVlKCdvdmVydmlldy1wcmUtZ2FtZS1zdGFydC1kYXRlJykpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKHN0YXRlLnByZURhdGUpLFxyXG4gICAgICAgICAgICAgICAgZ3JvdXA6IGVudGl0eU5hbWVzWzBdLFxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnaW1wb3J0YW50SXRlbScsXHJcbiAgICAgICAgICAgICAgICBlZGl0YWJsZTogZmFsc2VcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBmaWxsVGltZWxpbmVzKHVzZWREYXRhKSB7XHJcbiAgICAgICAgc3RhdGUuVGltZWxpbmVEYXRhc2V0LmFkZChSLmZsYXR0ZW4oUi50b1BhaXJzKHVzZWREYXRhKS5tYXAoKHBhaXIpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZW50aXR5TmFtZSA9IHBhaXJbMF07XHJcbiAgICAgICAgICAgIHJldHVybiBwYWlyWzFdLm1hcChldmVudCA9PiAoe1xyXG4gICAgICAgICAgICAgICAgY29udGVudDogcHJlcGFyZUxhYmVsKGV2ZW50Lm5hbWUpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQ6IGV2ZW50LnRpbWUgIT09ICcnID8gZXZlbnQudGltZSA6IHN0YXRlLnBvc3REYXRlLFxyXG4gICAgICAgICAgICAgICAgZ3JvdXA6IGVudGl0eU5hbWVcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIH0pKSk7XHJcbiAgICB9XHJcbn0pKHRoaXMuVGltZWxpbmUgPSB7fSk7XHJcbiJdfQ==
