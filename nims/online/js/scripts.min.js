"use strict";function LocalDBMS(){}function RemoteDBMS(){this.clearSettings()}function getL10n(A){return L10n.getValue(A)}function constL10n(A){return L10n.getValue("constant-"+A)}function isEmpty(A){return 0===Object.getOwnPropertyNames(A).length}function toggleClass(A,e){hasClass(A,e)?removeClass(A,e):addClass(A,e)}function hasClass(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");return t.test(A.className)}function removeClass(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");A.className=A.className.replace(t,"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}function setClassByCondition(A,e,t){t?addClass(A,e):removeClass(A,e)}function getEl(A){return document.getElementById(A)}function getEls(A){return document.getElementsByClassName(A)}function makeEl(A){return document.createElement(A)}function makeText(A){return document.createTextNode(A)}function setAttr(A,e,t){return A.setAttribute(e,t),A}function getAttr(A,e){return A.getAttribute(e)}function setProp(A,e,t){return A[e]=t,A}function setProps(A,e){for(var t in e)setProp(A,t,e[t]);return A}function clearEl(A){return Utils.removeChildren(A),A}function passEls(A,e){for(var t=0;t<A.children.length;t++)addEl(e,A.children[t])}function listen(A,e,t){A.addEventListener(e,t)}function arr2map(A,e){return R.reduce(function(A,t){return A[t[e]]=t,A},{},A)}function arr2Chunks(A,e){var t,r,a=[];for(t=0,r=A.length;r>t;t+=e)a.push(A.slice(t,t+e));return a}function fillSelector(A,e){e.forEach(function(e){var t=makeEl("option");addEl(t,makeText(e.name)),e.value&&(t.value=e.value),e.selected&&(t.selected=!0),addEl(A,t)})}function nl2array(A){return Array.prototype.slice.call(A)}LocalDBMS.prototype.getSettings=function(){return this.database.Settings},commonAPI(LocalDBMS,Migrator,CommonUtils),statisticsAPI(LocalDBMS,R,CommonUtils),consistencyCheckAPI(LocalDBMS,R,CommonUtils,Ajv,Schema),charactersAPI(LocalDBMS,Errors),extrasAPI(LocalDBMS,R,CommonUtils,dateFormat),briefingExportAPI(LocalDBMS,CommonUtils,R,Constants),profileConfigurerAPI(LocalDBMS,Constants,CommonUtils,Errors),storiesAPI(LocalDBMS,CommonUtils,Errors),eventsAPI(LocalDBMS,CommonUtils),accessManagerAPI(LocalDBMS,CommonUtils),logAPI(LocalDBMS,R,CommonUtils,!1,MODE);var url="/";RemoteDBMS._simpleGet=function(A,e,t){var r="";e&&(r="?params="+encodeURIComponent(JSON.stringify(e)));var a=$.ajax({url:url+A+r,dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",cache:!1});a.done(function(A){t(null,JSON.parse(A))}),a.fail(function(A,e,r){try{t(JSON.parse(A.responseText))}catch(a){t(A.responseText)}})},RemoteDBMS._simplePut=function(A,e,t){var r=$.ajax({url:url+A,dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify(e)});r.done(function(A){t&&t()}),r.fail(function(A,e,r){try{t(JSON.parse(A.responseText))}catch(a){t(A.responseText)}})},Object.keys(LocalDBMS.prototype).forEach(function(A){RemoteDBMS.prototype[A]=function(){for(var e=[],t=0;t<arguments.length-1;t++)e.push(arguments[t]);CommonUtils.startsWith(A,"get")||CommonUtils.startsWith(A,"is")?RemoteDBMS._simpleGet(A,e,arguments[arguments.length-1]):RemoteDBMS._simplePut(A,e,arguments[arguments.length-1])}}),RemoteDBMS.prototype.clearSettings=function(){this.Settings={BriefingPreview:{},Stories:{},CharacterProfile:{}}},RemoteDBMS.prototype.getSettings=function(){return this.Settings};var FileUtils={};FileUtils.init=function(A){FileUtils.callback=A},FileUtils.makeNewBase=function(){Utils.confirm(getL10n("utils-new-base-warning"))&&DBMS.setDatabase(CommonUtils.clone(EmptyBase.data),FileUtils.callback)},FileUtils.openHelp=function(){window.open("doc/nims.html")},FileUtils.readSingleFile=function(A){var e=A.target.files[0];if(e){var t=new FileReader;t.onload=function(A){var e=A.target.result,t=JSON.parse(e);DBMS.setDatabase(t,FileUtils.callback)},t.readAsText(e)}else Utils.alert(getL10n("utils-base-file-loading-error"))},FileUtils.saveFile=function(){DBMS.getDatabase(function(A,e){return A?void Utils.handleError(A):void FileUtils.json2File(e,"nims-base.json")})},FileUtils.json2File=function(A,e){FileUtils.str2File(JSON.stringify(A,null,"  "),e)},FileUtils.str2File=function(A,e){var t=new Blob([A],{type:"text/plain;charset=utf-8"});saveAs(t,e)};var L10n={};L10n.initialized=!1,L10n.l10nDelegates=[],L10n.init=function(){if(!L10n.initialized){L10n.dictionaries={},console.log(navigator.language);var A=function(A){var e={};for(var t in A)for(var r in A[t])e[t+"-"+r]=A[t][r];return e};for(var e in Dictionaries)L10n.dictionaries[e]=A(Dictionaries[e]);var t="ru";console.log(t),L10n.dictionaries[t]?L10n.dict=L10n.dictionaries[t]:L10n.dict=L10n.dictionaries.en,L10n.initialized=!0}};var lang="RU";L10n.toggleL10n=function(){"RU"===lang?(L10n.dict=L10n.dictionaries.en,lang="EN"):(L10n.dict=L10n.dictionaries.ru,lang="RU"),L10n.localizeStatic(),L10n.l10nDelegates.forEach(function(A){A()}),PageManager.currentView.refresh()},L10n.getValue=function(A){var e=L10n.dict[A];return e?e:A+":RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA"},L10n.getFixedValue=function(A){return function(){return L10n.getValue(A)}},L10n.onL10nChange=function(A){L10n.l10nDelegates.push(A)},L10n.localizeStatic=function(){L10n.init();for(var A,e=document.querySelectorAll("[l10n-id]"),t=0;t<e.length;t++)A=e[t],addEl(clearEl(A),makeText(L10n.getValue(getAttr(A,"l10n-id"))));e=document.querySelectorAll("[l10n-placeholder-id]");for(var t=0;t<e.length;t++)A=e[t],setAttr(A,"placeholder",L10n.getValue(getAttr(A,"l10n-placeholder-id")))};var PageManager={},DBMS;PageManager.onLoad=function(){L10n.localizeStatic(),UI.initSelectorFilters(),UI.initPanelTogglers(),"Standalone"===MODE?(DBMS=new LocalDBMS,DBMS.setDatabase(BaseExample.data,function(A){return A?void Utils.handleError(A):void PageManager.consistencyCheck(PageManager.onDatabaseLoad)})):"NIMS_Server"===MODE&&(DBMS=new RemoteDBMS,PageManager.consistencyCheck(PageManager.onDatabaseLoad))},PageManager.consistencyCheck=function(A){DBMS.getConsistencyCheckResult(function(e,t){return e?void Utils.handleError(e):(t.forEach(CommonUtils.consoleLog),t.length>0?Utils.alert(getL10n("overview-consistency-problem-detected")):console.log("Consistency check didn't find errors"),void A())})},PageManager.onDatabaseLoad=function(){PermissionInformer.refresh(function(A){return A?void Utils.handleError(A):void PermissionInformer.isAdmin(function(A,e){if(A)return void Utils.handleError(A);var t=PageManager;t.views={};var r,a="navigation",n="contentArea",i=getEl(a),s={root:t,navigation:i,content:getEl(n)};Utils.addView(s,"overview",Overview,{mainPage:!0}),Utils.addView(s,"characters",Characters),Utils.addView(s,"stories",Stories),Utils.addView(s,"adaptations",Events),Utils.addView(s,"briefings",Briefings),addEl(i,addClass(makeEl("div"),"nav-separator")),Utils.addView(s,"timeline",Timeline,{id:"timelineButton",tooltip:!0}),Utils.addView(s,"social-network",SocialNetwork,{id:"socialNetworkButton",tooltip:!0}),Utils.addView(s,"character-filter",CharacterFilter,{id:"filterButton",tooltip:!0}),addEl(i,addClass(makeEl("div"),"nav-separator"));var o={tooltip:!0,className:"mainNavButton"};if(e){var r=PageManager.makeButton("dataLoadButton","open-database",null,o);r.addEventListener("change",FileUtils.readSingleFile,!1);var c=makeEl("input");c.type="file",r.appendChild(c),addEl(i,r)}addEl(i,PageManager.makeButton("dataSaveButton","save-database",FileUtils.saveFile,o)),"Standalone"===MODE&&addEl(i,PageManager.makeButton("newBaseButton","create-database",FileUtils.makeNewBase,o)),addEl(i,PageManager.makeButton("mainHelpButton","docs",FileUtils.openHelp,o));var l=PageManager.makeButton("toggleL10nButton","l10n",L10n.toggleL10n,o),d=function(){l.style.backgroundImage=strFormat('url("./images/{0}.svg")',[getL10n("header-dictionary-icon")])};L10n.onL10nChange(d),d(),Utils.addView(s,"logViewer",LogViewer,{id:"logViewerButton",tooltip:!0}),"NIMS_Server"===MODE&&(Utils.addView(s,"admins",AccessManager,{id:"accessManagerButton",tooltip:!0}),addEl(i,PageManager.makeButton("logoutButton","logout",PageManager.postLogout,o))),FileUtils.init(function(A){return A?void Utils.handleError(A):void PageManager.consistencyCheck(PageManager.currentView.refresh)}),PageManager.currentView.refresh()})})},PageManager.runTests=function(){PageManager.consistencyCheck(function(){})},PageManager.postLogout=function(){document.querySelector("#logoutForm button").click()},PageManager.makeButton=function(A,e,t,r){var a=makeEl("div");if(a.id=A,r.tooltip){var n=function(){$(a).attr("data-original-title",L10n.getValue("header-"+e))};L10n.onL10nChange(n),$(a).tooltip({title:L10n.getValue("header-"+e),placement:"bottom"})}return addClass(a,"action-button"),r.className&&addClass(a,r.className),t&&listen(a,"click",t),a},window.onbeforeunload=function(A){var e=getL10n("utils-close-page-warning");return"undefined"==typeof A&&(A=window.event),A&&(A.returnValue=e),e};var PermissionInformer={};PermissionInformer.summary={},"NIMS_Server"===MODE?(PermissionInformer.refresh=function(A){var e=$.ajax({url:"/getPermissionsSummary",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});e.done(function(e){PermissionInformer.summary=JSON.parse(e),A?A():PermissionInformer.subscribe()}),e.fail(function(e,t,r){A?A(e.responseText):setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.subscribe=function(){var A=$.ajax({url:"/subscribeOnPermissionsUpdate",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});A.done(function(A){PermissionInformer.summary=JSON.parse(A),PermissionInformer.subscribe()}),A.fail(function(A,e,t){setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.refresh(),PermissionInformer.isAdmin=function(A){A(null,PermissionInformer.summary.isAdmin)},PermissionInformer.isEditor=function(A){A(null,PermissionInformer.summary.isEditor)},PermissionInformer.isCharacterEditable=function(A,e){e(null,PermissionInformer.isObjectEditableSync("character",A))},PermissionInformer.isObjectEditableSync=function(A,e){if(PermissionInformer.summary.isEditor)return!0;if(PermissionInformer.summary.existEditor)return!1;var t;switch(A){case"story":t=PermissionInformer.summary.userStories;break;case"character":t=PermissionInformer.summary.userCharacters}return-1!==t.indexOf(e)},PermissionInformer.isStoryEditable=function(A,e){e(null,PermissionInformer.isObjectEditableSync("story",A))},PermissionInformer.getCharacterNamesArray=function(A,e){var t=[],r=PermissionInformer.summary.userCharacters,a=PermissionInformer.summary.allCharacters,n=PermissionInformer.summary.characterOwnerMap;a.filter(function(e){return A?PermissionInformer.isObjectEditableSync("character",e):!0}).forEach(function(A){t.push({displayName:n[A]+". "+A,value:A,editable:PermissionInformer.isObjectEditableSync("character",A),isOwner:-1!==r.indexOf(A)})}),t.sort(Utils.charOrdAObject),e(null,t)},PermissionInformer.getStoryNamesArray=function(A,e){var t=[],r=PermissionInformer.summary.userStories,a=PermissionInformer.summary.allStories,n=PermissionInformer.summary.storiesOwnerMap;a.filter(function(e){return A?PermissionInformer.isObjectEditableSync("story",e):!0}).forEach(function(A){t.push({displayName:n[A]+". "+A,value:A,editable:PermissionInformer.isObjectEditableSync("story",A),isOwner:-1!==r.indexOf(A)})}),t.sort(Utils.charOrdAObject),e(null,t)},PermissionInformer.areAdaptationsEditable=function(A,e){var t={},r=PermissionInformer.summary.isAdaptationRightsByStory;A.forEach(function(A){var e=A.storyName+"-"+A.characterName;r?t[e]=PermissionInformer.isObjectEditableSync("story",A.storyName):t[e]=PermissionInformer.isObjectEditableSync("character",A.characterName)}),e(null,t)}):(PermissionInformer.refresh=function(A){A()},PermissionInformer.isAdmin=function(A){A(null,!0)},PermissionInformer.isEditor=function(A){A(null,!0)},PermissionInformer.getCharacterNamesArray=function(A,e){DBMS.getCharacterNamesArray(function(A,t){if(A)return void Utils.handleError(A);var r=[];t.forEach(function(A){r.push({displayName:A,value:A,editable:!0})}),e(null,r)})},PermissionInformer.getStoryNamesArray=function(A,e){DBMS.getStoryNamesArray(function(A,t){if(A)return void Utils.handleError(A);var r=[];t.forEach(function(A){r.push({displayName:A,value:A,editable:!0})}),e(null,r)})},PermissionInformer.isCharacterEditable=function(A,e){e(null,!0)},PermissionInformer.isStoryEditable=function(A,e){e(null,!0)},PermissionInformer.areAdaptationsEditable=function(A,e){var t={};A.forEach(function(A){t[A.storyName+"-"+A.characterName]=!0}),e(null,t)});var UI={};UI.initTabPanel=function(A,e){var t,r=getEls(e);for(t=1;t<r.length;t++)addClass(r[t],"hidden");var a=getEls(A);for(addClass(a[0],"active"),t=0;t<a.length;t++)listen(a[t],"click",UI.tabButtonClick(a,r))},UI.tabButtonClick=function(A,e){return function(t){for(var r=0;r<A.length;r++)setClassByCondition(A[r],"active",t.target.id===A[r].id);for(var r=0;r<e.length;r++)setClassByCondition(e[r],"hidden",t.target.id+"Container"!==e[r].id)}},UI.fillShowItemSelector=function(A,e){var t;setAttr(A,"size",e.length),e.forEach(function(e,r){t=setProps(makeEl("option"),{selected:!0}),addEl(A,addEl(t,makeText(e)))})},UI.showSelectedEls=function(A){return function(e){var t,r,a,n=e.target;for(r=0;r<n.options.length;r+=1)for(t=getEls(r+A),a=0;a<t.length;a++)setClassByCondition(t[a],"hidden",!n.options[r].selected)}},UI.initSelectorFilters=function(){for(var A,e,t=document.querySelectorAll("[selector-filter]"),r=0;r<t.length;r++)A=t[r],e=getEl(getAttr(A,"selector-filter")),listen(A,"input",UI.filterOptions(e))},UI.filterOptions=function(A){return function(e){var t,r,a=e.target.value;for(a=Utils.globStringToRegex(a.trim().toLowerCase()),t=0;t<A.options.length;t+=1)r=A.options[t],setClassByCondition(r,"hidden",-1===r.innerHTML.toLowerCase().search(a))}},UI.initPanelTogglers=function(){for(var A,e,t=document.querySelectorAll("[panel-toggler]"),r=0;r<t.length;r++)A=t[r],e=document.querySelector(getAttr(A,"panel-toggler")),listen(A,"click",UI.togglePanel(e))},UI.togglePanel=function(A){return function(e){toggleClass(A,"hidden")}},UI.makeEventTimePicker=function(A){var e=makeEl("input");R.ap([addClass(e)],A.extraClasses),addClass(e,"eventTime"),e.value=A.eventTime,e.eventIndex=A.index;var t={lang:"ru",mask:!0,startDate:new Date(A.preGameDate),endDate:new Date(A.date),onChangeDateTime:A.onChangeDateTimeCreator(e)};return""!==A.eventTime?t.value=A.eventTime:(t.value=A.date,addClass(e,"defaultDate")),jQuery(e).datetimepicker(t),e},UI.resizeTextarea=function(A){var e=A.target;e.style.height="24px",e.style.height=e.scrollHeight+12+"px"},UI.makeAdaptationTimeInput=function(A,e,t,r){var a=makeEl("input");return setClassByCondition(a,"notEditable",!r),addClass(a,"adaptationTimeInput"),a.value=e.characters[t].time,a.dataKey=JSON.stringify([A,e.index,t]),listen(a,"change",UI.onChangePersonalTimeDelegate),a},UI.onChangePersonalTimeDelegate=function(A){var e=JSON.parse(A.target.dataKey),t=A.target.value;DBMS.setEventAdaptationTime(e[0],e[1],e[2],t,Utils.processError())};var Utils={};Utils.addView=function(A,e,t,r){var r=r||{};t.init();var a="navigation-button";A.root.views[e]=t;var n=makeEl("div");if(r.tooltip){var i=function(){$(n).attr("data-original-title",L10n.getValue("header-"+e))};L10n.onL10nChange(i),$(n).tooltip({title:L10n.getValue("header-"+e),placement:"bottom"})}else addEl(n,makeText(L10n.getValue("header-"+e))),setAttr(n,"l10n-id","header-"+e);addClass(n,a),addClass(n,"-test-"+e),addClass(n,"-toggle-class-"+e),r.id&&(n.id=r.id),A.navigation.appendChild(n);var s,o=function(t){return function(n){if(s=A.navigation.getElementsByClassName(a),r.toggle)for(var i=getEls("-toggle-class-"+e),o=0;o<i.length;o++)n.target.isEqualNode(i[o])||hasClass(i[o],"active")&&i[o].click();var c=hasClass(n.target,"active");for(o=0;o<s.length;o++)removeClass(s[o],"active");!r.toggle||r.toggle&&!c?(addClass(n.target,"active"),passEls(A.content,getEl("warehouse")),A.content.appendChild(t.content),removeClass(A.content,"hidden"),A.root.currentView=t,t.refresh()):(removeClass(n.target,"active"),passEls(A.content,getEl("warehouse")),A.root.currentView=null,addClass(A.content,"hidden"))}};n.addEventListener("click",o(t)),r.mainPage&&(addClass(n,"active"),A.content.appendChild(t.content),A.root.currentView=t)},Utils.globStringToRegex=function(A){return new RegExp(Utils.preg_quote(A).replace(/\\\*/g,".*").replace(/\\\?/g,"."),"g")},Utils.preg_quote=function(A,e){return(A+"").replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\"+(e||"")+"-]","g"),"\\$&")},Utils.alert=function(A){window.alert(A)},Utils.confirm=function(A){return window.confirm(A)},Utils.removeChildren=function(A){if(A)for(;A.firstChild;)A.removeChild(A.firstChild)},Utils.processError=function(A){return function(e){if(e)return void Utils.handleError(e);if(A){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);A.apply(null,t)}}},Utils.handleError=function(A){A instanceof Errors.ValidationError||"object"==typeof A?Utils.alert(strFormat(getL10n(A.messageId),A.parameters)):Utils.alert(A)},Utils.enable=function(A,e,t){var r,a,n=A.getElementsByClassName(e);for(r=0;r<n.length;r++)a=n[r],t?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")},Utils.charOrdAObject=CommonUtils.charOrdAFactory(function(A){return A.displayName.toLowerCase()}),String.prototype.endsWith=function(A){return-1!==this.indexOf(A,this.length-A.length)};var strFormat=R.curry(CommonUtils.strFormat),addClass=R.curry(function(A,e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)","g");if(!t.test(A.className))return A.className=(A.className+" "+e).replace(/\s+/g," ").replace(/(^ | $)/g,""),A}),addClasses=R.curry(function(A,e){return R.ap([addClass(A)],e),A}),rAddClass=R.curry(function(A,e){var t=new RegExp("(^|\\s)"+A+"(\\s|$)","g");if(!t.test(e.className))return e.className=(e.className+" "+A).replace(/\s+/g," ").replace(/(^ | $)/g,""),e}),addEl=R.curry(function(A,e){return A.appendChild(e),A}),addEls=R.curry(function(A,e){return R.ap([addEl(A)],e),A}),makeOpt=function(A){var e=makeEl("option");return addEl(e,makeText(A)),e},rAddEl=R.curry(function(A,e){return e.appendChild(A),e}),remapProps=R.curry(function(A,e,t){return R.compose(R.zipObj(A),R.values,R.pick(e))(t)}),remapProps4Select2=remapProps(["id","text"],["value","displayName"]),remapProps4Select=remapProps(["value","name"],["value","displayName"]),getSelect2DataCommon=R.curry(function(A,e){return R.compose(R.zipObj(["data"]),R.append(R.__,[]),R.map(A))(e)}),getSelect2Data=getSelect2DataCommon(remapProps4Select2),getSelectedRadio=function(A){for(var e=document.querySelectorAll(A),t=0;t<e.length;t++)if(e[t].checked===!0)return e[t];return null};Date.prototype.format=function(A,e){return dateFormat(this,A,e)};