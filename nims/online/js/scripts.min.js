"use strict";function makeLocalDBMS(){function e(){this._init(t)}var t={};return e.prototype.getSettings=function(){return this.database.Settings},baseAPI(e,Migrator,CommonUtils,EventEmitter),statisticsAPI(e,R,CommonUtils),consistencyCheckAPI(e,R,CommonUtils,Ajv,Schema),charactersAPI(e,Constants,CommonUtils,Errors,t),groupsAPI(e,R,Constants,CommonUtils,Errors,t),investigationBoardAPI(e,R,Constants,CommonUtils,Errors,t),relationsAPI(e,R,Constants,CommonUtils,Errors,t),briefingExportAPI(e,CommonUtils,R,Constants),profileConfigurerAPI(e,Constants,CommonUtils,Errors),storyBaseAPI(e,R,CommonUtils,Errors),storyEventsAPI(e,R,CommonUtils,Errors),storyCharactersAPI(e,R,CommonUtils,Errors,t),storyViewAPI(e,R,CommonUtils,dateFormat),storyAdaptationsAPI(e,CommonUtils),accessManagerAPI(e,CommonUtils,R),logAPI(e,R,CommonUtils),Logger.attachLogCalls(e,R,!1),e}function makeRemoteDBMS(e){function t(){this.clearSettings()}var n="/",r=!1;return t._simpleGet=function(e,t,r){var a="";t&&(a="?params="+encodeURIComponent(JSON.stringify(t)));var i=$.ajax({url:n+e+a,dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",cache:!1,timeout:Constants.httpTimeout});i.done(function(e){r(null,JSON.parse(e))}),i.fail(function(e,t,n){try{r(JSON.parse(e.responseText))}catch(a){r(e.responseText||t||"error")}})},t._simplePut=function(e,t,a){var i=$.ajax({url:n+e,dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify(t),timeout:Constants.httpTimeout});if(r){var o=clearEl(getEl("debugNotification"));removeClass(o,"hidden"),removeClass(o,"operationOK"),removeClass(o,"operationFail"),addEl(o,makeText(e+" "+JSON.stringify(t)))}i.done(function(e){r&&(addClass(o,"operationOK"),setTimeout(function(){addClass(o,"hidden")},1e3)),a&&a()}),i.fail(function(e,t,n){r&&(addClass(o,"operationFail"),setTimeout(function(){addClass(o,"hidden")},1e3));try{a(JSON.parse(e.responseText))}catch(i){a(e.responseText||t||"error")}})},Object.keys(e.prototype).forEach(function(e){t.prototype[e]=function(){for(var n=[],r=0;r<arguments.length-1;r++)n.push(arguments[r]);CommonUtils.startsWith(e,"get")||CommonUtils.startsWith(e,"is")?t._simpleGet(e,n,arguments[arguments.length-1]):t._simplePut(e,n,arguments[arguments.length-1])}}),t.prototype.clearSettings=function(){this.Settings={BriefingPreview:{},Stories:{},CharacterProfile:{}}},t.prototype.getSettings=function(){return this.Settings},t}function getL10n(e){return L10n.getValue(e)}function constL10n(e){return L10n.getValue("constant-"+e)}function isEmpty(e){return 0===Object.getOwnPropertyNames(e).length}function toggleClass(e,t){hasClass(e,t)?removeClass(e,t):addClass(e,t)}function hasClass(e,t){var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");return n.test(e.className)}function setClassByCondition(e,t,n){n?addClass(e,t):removeClass(e,t)}function getEl(e){return document.getElementById(e)}function queryEl(e){return document.querySelector(e)}function queryElEls(e,t){return e.querySelectorAll(t)}function getEls(e){return document.getElementsByClassName(e)}function makeEl(e){return document.createElement(e)}function makeText(e){return document.createTextNode(e)}function delAttr(e,t){return e.removeAttribute(t),e}function getAttr(e,t){return e.getAttribute(t)}function setProp(e,t,n){return e[t]=n,e}function setProps(e,t){for(var n in t)setProp(e,n,t[n]);return e}function clearEl(e){return Utils.removeChildren(e),e}function passEls(e,t){for(var n=0;n<e.children.length;n++)addEl(t,e.children[n])}function listen(e,t,n){e.addEventListener(t,n)}function arr2Chunks(e,t){var n,r,a=[];for(n=0,r=e.length;r>n;n+=t)a.push(e.slice(n,n+t));return a}function fillSelector(e,t){t.forEach(function(t){var n=makeEl("option");addEl(n,makeText(t.name)),t.value&&(n.value=t.value),t.selected&&(n.selected=!0),addEl(e,n)})}function nl2array(e){return Array.prototype.slice.call(e)}var LocalDBMS=makeLocalDBMS(),RemoteDBMS=makeRemoteDBMS(LocalDBMS),FileUtils={};FileUtils.init=function(e){FileUtils.callback=e},FileUtils.makeNewBase=function(){Utils.confirm(getL10n("utils-new-base-warning"))&&DBMS.setDatabase(CommonUtils.clone(EmptyBase.data),FileUtils.callback)},FileUtils.openHelp=function(){window.open("extras/doc/nims.html")},FileUtils.readSingleFile=function(e){var t=e.target.files[0];if(t){var n=new FileReader;n.onload=function(e){var t=e.target.result,n=JSON.parse(t);DBMS.setDatabase(n,FileUtils.callback)},n.readAsText(t)}else Utils.alert(getL10n("utils-base-file-loading-error"))},FileUtils.saveFile=function(){DBMS.getDatabase(function(e,t){return e?void Utils.handleError(e):void FileUtils.json2File(t,"nims-base.json")})},FileUtils.json2File=function(e,t){FileUtils.str2File(JSON.stringify(e,null,"  "),t)},FileUtils.str2File=function(e,t){var n=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(n,t)};var L10n={};L10n.initialized=!1,L10n.l10nDelegates=[],L10n.init=function(){if(!L10n.initialized){L10n.dictionaries={},console.log(navigator.language);var e=function(e){var t={};for(var n in e)for(var r in e[n])t[n+"-"+r]=e[n][r];return t};for(var t in Dictionaries)L10n.dictionaries[t]=e(Dictionaries[t]);var n=defaultLang;console.log(n),L10n.dictionaries[n]?L10n.dict=L10n.dictionaries[n]:L10n.dict=L10n.dictionaries.en,L10n.initialized=!0}};var lang="RU";L10n.toggleL10n=function(){"RU"===lang?(L10n.dict=L10n.dictionaries.en,lang="EN"):(L10n.dict=L10n.dictionaries.ru,lang="RU"),L10n.localizeStatic(),L10n.l10nDelegates.forEach(function(e){e()}),PageManager.currentView.refresh()},L10n.getLang=function(){return lang.toLowerCase()},L10n.getValue=function(e){var t=L10n.dict[e];return t?t:e+":RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA"},L10n.getFixedValue=function(e){return function(){return L10n.getValue(e)}},L10n.onL10nChange=function(e){L10n.l10nDelegates.push(e)},L10n.localizeStatic=function(){L10n.init();for(var e,t=document.querySelectorAll("[l10n-id]"),n=0;n<t.length;n++)e=t[n],addEl(clearEl(e),makeText(L10n.getValue(getAttr(e,"l10n-id"))));t=document.querySelectorAll("[l10n-placeholder-id]");for(var n=0;n<t.length;n++)e=t[n],setAttr(e,"placeholder",L10n.getValue(getAttr(e,"l10n-placeholder-id")))};var PageManager={},DBMS;PageManager.onLoad=function(){L10n.localizeStatic(),UI.initSelectorFilters(),UI.initPanelTogglers(),"Standalone"===MODE?(DBMS=new LocalDBMS,DBMS.setDatabase(BaseExample.data,function(e){return e?void Utils.handleError(e):void PageManager.consistencyCheck(PageManager.onDatabaseLoad)})):"NIMS_Server"===MODE&&(DBMS=new RemoteDBMS,PageManager.consistencyCheck(PageManager.onDatabaseLoad))},PageManager.consistencyCheck=function(e){DBMS.getConsistencyCheckResult(function(t,n){return t?void Utils.handleError(t):(n.forEach(CommonUtils.consoleLog),n.length>0?Utils.alert(getL10n("overview-consistency-problem-detected")):console.log("Consistency check didn't find errors"),void e())})},PageManager.onDatabaseLoad=function(){PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void PermissionInformer.isAdmin(function(e,t){if(e)return void Utils.handleError(e);var n=PageManager;n.views={};var r,a="navigation",i="contentArea",o=getEl(a),s={root:n,navigation:o,content:getEl(i)};Utils.addView(s,"overview",Overview,{mainPage:!0}),Utils.addView(s,"characters",Characters),Utils.addView(s,"stories",Stories),Utils.addView(s,"adaptations",Events),Utils.addView(s,"briefings",Briefings),addEl(o,addClass(makeEl("div"),"nav-separator")),Utils.addView(s,"timeline",Timeline,{id:"timelineButton",tooltip:!0}),Utils.addView(s,"social-network",SocialNetwork,{id:"socialNetworkButton",tooltip:!0}),Utils.addView(s,"character-filter",CharacterFilter,{id:"filterButton",tooltip:!0}),Utils.addView(s,"groups",Groups,{id:"groupsButton",tooltip:!0}),addEl(o,addClass(makeEl("div"),"nav-separator"));var l={tooltip:!0,className:"mainNavButton"};if(t){var r=PageManager.makeButton("dataLoadButton","open-database",null,l);r.addEventListener("change",FileUtils.readSingleFile,!1);var c=makeEl("input");c.type="file",addClass(c,"hidden"),setAttr(c,"tabindex",-1),r.appendChild(c),r.addEventListener("click",function(e){c.click()}),addEl(o,r)}addEl(o,PageManager.makeButton("dataSaveButton","save-database",FileUtils.saveFile,l)),"Standalone"===MODE&&addEl(o,PageManager.makeButton("newBaseButton","create-database",FileUtils.makeNewBase,l)),addEl(o,PageManager.makeButton("mainHelpButton","docs",FileUtils.openHelp,l)),Utils.addView(s,"logViewer",LogViewer2,{id:"logViewerButton",tooltip:!0}),"NIMS_Server"===MODE&&(Utils.addView(s,"admins",AccessManager,{id:"accessManagerButton",tooltip:!0}),addEl(o,PageManager.makeButton("logoutButton","logout",PageManager.postLogout,l))),FileUtils.init(function(e){return e?void Utils.handleError(e):void PageManager.consistencyCheck(PageManager.currentView.refresh)}),PageManager.currentView.refresh()})})},PageManager.runTests=function(){PageManager.consistencyCheck(function(){})},PageManager.postLogout=function(){document.querySelector("#logoutForm button").click()},PageManager.makeButton=function(e,t,n,r){var a=makeEl("button");if(a.id=e,r.tooltip){var i=function(){$(a).attr("data-original-title",L10n.getValue("header-"+t))};L10n.onL10nChange(i),$(a).tooltip({title:L10n.getValue("header-"+t),placement:"bottom"})}return addClass(a,"action-button"),r.className&&addClass(a,r.className),n&&listen(a,"click",n),a},window.onbeforeunload=function(e){var t=getL10n("utils-close-page-warning");return"undefined"==typeof e&&(e=window.event),e&&(e.returnValue=t),t};var PermissionInformer={};PermissionInformer.summary={},"NIMS_Server"===MODE?(PermissionInformer.refresh=function(e){var t=$.ajax({url:"/getPermissionsSummary",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",timeout:Constants.httpTimeout});t.done(function(t){PermissionInformer.summary=JSON.parse(t),e?e():PermissionInformer.subscribe()}),t.fail(function(t,n,r){e?e(t.responseText||"error"):setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.subscribe=function(){var e=$.ajax({url:"/subscribeOnPermissionsUpdate",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8",timeout:Constants.httpTimeout});e.done(function(e){PermissionInformer.summary=JSON.parse(e),PermissionInformer.subscribe()}),e.fail(function(e,t,n){setTimeout(PermissionInformer.subscribe,500)})},PermissionInformer.refresh(),PermissionInformer.isAdmin=function(e){e(null,PermissionInformer.summary.isAdmin)},PermissionInformer.isEditor=function(e){e(null,PermissionInformer.summary.isEditor)},PermissionInformer.isCharacterEditable=function(e,t){t(null,PermissionInformer.isObjectEditableSync("characters",e))},PermissionInformer.isStoryEditable=function(e,t){t(null,PermissionInformer.isObjectEditableSync("stories",e))},PermissionInformer.isGroupEditable=function(e,t){t(null,PermissionInformer.isObjectEditableSync("groups",e))},PermissionInformer.isObjectEditableSync=function(e,t){return PermissionInformer.summary.isEditor?!0:PermissionInformer.summary.existEditor?!1:-1!==PermissionInformer.summary.user[e].indexOf(t)},PermissionInformer.getEntityNamesArray=R.curry(function(e,t,n){var r=PermissionInformer.summary.user[e],a=PermissionInformer.summary.all[e],i=PermissionInformer.summary.ownerMaps[e],o=a.filter(function(n){return t?PermissionInformer.isObjectEditableSync(e,n):!0}).map(function(t){return{displayName:i[t]+". "+t,value:t,editable:PermissionInformer.isObjectEditableSync(e,t),isOwner:-1!==r.indexOf(t)}});o.sort(Utils.charOrdAObject),n(null,o)}),PermissionInformer.getCharacterNamesArray=PermissionInformer.getEntityNamesArray("characters"),PermissionInformer.getStoryNamesArray=PermissionInformer.getEntityNamesArray("stories"),PermissionInformer.getGroupNamesArray=PermissionInformer.getEntityNamesArray("groups"),PermissionInformer.areAdaptationsEditable=function(e,t){var n={},r=PermissionInformer.summary.isAdaptationRightsByStory;e.forEach(function(e){var t=e.storyName+"-"+e.characterName;r?n[t]=PermissionInformer.isObjectEditableSync("stories",e.storyName):n[t]=PermissionInformer.isObjectEditableSync("characters",e.characterName)}),t(null,n)}):(PermissionInformer.refresh=function(e){e()},PermissionInformer.isAdmin=function(e){e(null,!0)},PermissionInformer.isEditor=function(e){e(null,!0)},PermissionInformer.getEntityNamesArray=R.curry(function(e,t,n){DBMS[e](function(e,t){if(e)return void Utils.handleError(e);var r=[];t.forEach(function(e){r.push({displayName:e,value:e,editable:!0})}),n(null,r)})}),PermissionInformer.getCharacterNamesArray=PermissionInformer.getEntityNamesArray("getCharacterNamesArray"),PermissionInformer.getStoryNamesArray=PermissionInformer.getEntityNamesArray("getStoryNamesArray"),PermissionInformer.getGroupNamesArray=PermissionInformer.getEntityNamesArray("getGroupNamesArray"),PermissionInformer.isStoryEditable=PermissionInformer.isGroupEditable=PermissionInformer.isCharacterEditable=function(e,t){t(null,!0)},PermissionInformer.areAdaptationsEditable=function(e,t){var n={};e.forEach(function(e){n[e.storyName+"-"+e.characterName]=!0}),t(null,n)});var UI={};UI.initTabPanel=function(e,t){var n,r=getEls(t);for(n=1;n<r.length;n++)addClass(r[n],"hidden");var a=getEls(e);for(addClass(a[0],"active"),n=0;n<a.length;n++)listen(a[n],"click",UI.tabButtonClick(a,r))},UI.tabButtonClick=function(e,t){return function(n){for(var r=0;r<e.length;r++)setClassByCondition(e[r],"active",n.target.id===e[r].id);for(var r=0;r<t.length;r++)setClassByCondition(t[r],"hidden",n.target.id+"Container"!==t[r].id)}},UI.fillShowItemSelector=function(e,t){var n;setAttr(e,"size",t.length),t.forEach(function(t,r){n=setProps(makeEl("option"),{selected:!0}),addEl(e,addEl(n,makeText(t)))})},UI.showSelectedEls=function(e){return function(t){var n,r,a,i=t.target;for(r=0;r<i.options.length;r+=1)for(n=getEls(r+e),a=0;a<n.length;a++)setClassByCondition(n[a],"hidden",!i.options[r].selected)}},UI.initSelectorFilters=function(){for(var e,t,n=document.querySelectorAll("[selector-filter]"),r=0;r<n.length;r++)e=n[r],t=queryEl(getAttr(e,"selector-filter")),listen(e,"input",UI.filterOptions(t))},UI.filterOptions=function(e){return function(t){var n,r,a=t.target.value;for(a=CommonUtils.globStringToRegex(a.trim().toLowerCase()),n=0;n<e.options.length;n+=1)r=e.options[n],setClassByCondition(r,"hidden",-1===r.innerHTML.toLowerCase().search(a))}},UI.initPanelTogglers=function(){for(var e,t,n,r=document.querySelectorAll("[panel-toggler]"),a=0;a<r.length;a++)e=r[a],n=getAttr(e,"panel-toggler"),t=document.querySelector(n),null==t&&Utils.alert("Panel toggler is broken: "+n),listen(e,"click",UI.togglePanel(t))},UI.togglePanel=function(e){return function(t){toggleClass(e,"hidden")}},UI.makeEventTimePicker=function(e){var t=makeEl("input");R.ap([addClass(t)],e.extraClasses),addClass(t,"eventTime"),t.value=e.eventTime,t.eventIndex=e.index;var n={lang:L10n.getLang(),mask:!0,startDate:new Date(e.preGameDate),endDate:new Date(e.date),onChangeDateTime:e.onChangeDateTimeCreator(t)};return""!==e.eventTime?n.value=e.eventTime:(n.value=e.date,addClass(t,"defaultDate")),jQuery(t).datetimepicker(n),t},UI.resizeTextarea=function(e){var t=e.target;t.style.height="24px",t.style.height=t.scrollHeight+12+"px"},UI.makeAdaptationTimeInput=function(e,t,n,r){var a=makeEl("input");return setClassByCondition(a,"notEditable",!r),addClass(a,"adaptationTimeInput"),a.value=t.characters[n].time,a.dataKey=JSON.stringify([e,t.index,n]),listen(a,"change",UI.onChangePersonalTimeDelegate),a},UI.onChangePersonalTimeDelegate=function(e){var t=JSON.parse(e.target.dataKey),n=e.target.value;DBMS.setEventAdaptationTime(t[0],t[1],t[2],n,Utils.processError())};var Utils={};Utils.addView=function(e,t,n,r){var r=r||{};n.init();var a="navigation-button";e.root.views[t]=n;var i=makeEl("button");if(r.tooltip){var o=function(){$(i).attr("data-original-title",L10n.getValue("header-"+t))};L10n.onL10nChange(o),$(i).tooltip({title:L10n.getValue("header-"+t),placement:"bottom"})}else addEl(i,makeText(L10n.getValue("header-"+t))),setAttr(i,"l10n-id","header-"+t);addClass(i,a),addClass(i,"-test-"+t),addClass(i,"-toggle-class-"+t),r.id&&(i.id=r.id),e.navigation.appendChild(i);var s,l=function(n){return function(i){if(s=e.navigation.getElementsByClassName(a),r.toggle)for(var o=getEls("-toggle-class-"+t),l=0;l<o.length;l++)i.target.isEqualNode(o[l])||hasClass(o[l],"active")&&o[l].click();var c=hasClass(i.target,"active");for(l=0;l<s.length;l++)removeClass(s[l],"active");!r.toggle||r.toggle&&!c?(addClass(i.target,"active"),passEls(e.content,getEl("warehouse")),e.content.appendChild(n.content),removeClass(e.content,"hidden"),e.root.currentView=n,n.refresh()):(removeClass(i.target,"active"),passEls(e.content,getEl("warehouse")),e.root.currentView=null,addClass(e.content,"hidden"))}};i.addEventListener("click",l(n)),r.mainPage&&(addClass(i,"active"),e.content.appendChild(n.content),e.root.currentView=n)},Utils.alert=function(e){window.alert(e)},Utils.confirm=function(e){return window.confirm(e)},Utils.removeChildren=function(e){if(e)for(;e.firstChild;)e.removeChild(e.firstChild)},Utils.processError=function(e){return function(t){if(t)return void Utils.handleError(t);if(e){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);e.apply(null,n)}}},Utils.handleError=function(e){e instanceof Errors.ValidationError||e.name&&"ValidationError"===e.name?Utils.alert(strFormat(getL10n(e.messageId),e.parameters)):"object"==typeof e?Utils.alert(e.message):Utils.alert(e)},Utils.enable=function(e,t,n){var r,a,i,o=e.getElementsByClassName(t);for(r=0;r<o.length;r++)a=o[r],i="textarea"===a.tagName.toLowerCase()?"readonly":"disabled",n?a.removeAttribute(i):a.setAttribute(i,i)},Utils.charOrdAObject=CommonUtils.charOrdAFactory(function(e){return e.displayName.toLowerCase()}),Utils.rebuildSelector=function(e,t){clearEl(e),t.forEach(function(t){var n=makeEl("option");n.appendChild(makeText(t.displayName)),n.value=t.value,e.appendChild(n)})},Utils.rebuildSelectorArr=function(e,t){clearEl(e),t.forEach(function(t){var n=makeEl("option");n.appendChild(makeText(t)),e.appendChild(n)})},String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)};var strFormat=R.curry(CommonUtils.strFormat),addClass=R.curry(function(e,t){var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");if(!n.test(e.className))return e.className=(e.className+" "+t).replace(/\s+/g," ").replace(/(^ | $)/g,""),e}),addClasses=R.curry(function(e,t){return R.ap([addClass(e)],t),e}),rAddClass=R.curry(function(e,t){var n=new RegExp("(^|\\s)"+e+"(\\s|$)","g");if(!n.test(t.className))return t.className=(t.className+" "+e).replace(/\s+/g," ").replace(/(^ | $)/g,""),t}),removeClass=R.curry(function(e,t){var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");e.className=e.className.replace(n,"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}),addEl=R.curry(function(e,t){return e.appendChild(t),e}),addEls=R.curry(function(e,t){return R.ap([addEl(e)],t),e}),makeOpt=function(e){var t=makeEl("option");return addEl(t,makeText(e)),t},rAddEl=R.curry(function(e,t){return t.appendChild(e),t}),setAttr=R.curry(function(e,t,n){return e.setAttribute(t,n),e}),remapProps=R.curry(function(e,t,n){return R.compose(R.zipObj(e),R.values,R.pick(t))(n)}),remapProps4Select2=remapProps(["id","text"],["value","displayName"]),remapProps4Select=remapProps(["value","name"],["value","displayName"]),getSelect2DataCommon=R.curry(function(e,t){return R.compose(R.zipObj(["data"]),R.append(R.__,[]),R.map(e))(t)}),getSelect2Data=getSelect2DataCommon(remapProps4Select2),makeSelect2Opt=R.compose(R.zipObj(["id","text"]),R.repeat(R.__,2)),arr2Select2=R.compose(R.assoc("data",R.__,{}),R.map(makeSelect2Opt)),getSelectedRadio=function(e){for(var t=document.querySelectorAll(e),n=0;n<t.length;n++)if(t[n].checked===!0)return t[n];return null},debugInterceptor=function(e){return function(){console.log(JSON.stringify(arguments[0])),e.apply(null,arguments)}};Date.prototype.format=function(e,t){return dateFormat(this,e,t)};