"use strict";function FilterConfiguration(e){this.info=e,this.innerProfileSettings=CommonUtils.clone(e.innerProfileSettings),this.innerProfileSettings.forEach(function(e){CommonUtils.startsWith(e.name,"profile-")||(e.displayName=getL10n(e.displayName),e.value=""),e.canHide=e.name!=Constants.CHAR_NAME})}var About={};About.init=function(){About.content=getEl("aboutDiv")},About.refresh=function(){};var AccessManager={};AccessManager.init=function(){listen(getEl("createUserButton"),"click",AccessManager.createUser),listen(getEl("changePasswordButton"),"click",AccessManager.changePassword),listen(getEl("removeUserButton"),"click",AccessManager.removeUser),listen(getEl("assignPermissionButton"),"click",AccessManager.assignPermission),listen(getEl("removePermissionButton"),"click",AccessManager.removePermission),listen(getEl("newAdminButton"),"click",AccessManager.assignNewAdmin),listen(getEl("removeEditorButton"),"click",AccessManager.removeEditor),listen(getEl("newEditorButton"),"click",AccessManager.assignEditor),AccessManager.entities=["characters","stories","groups"];var e,t,r=document.getElementsByClassName("adaptationRights");for(e=0;e<r.length;e++)t=r[e],t.addEventListener("click",AccessManager.changeAdaptationRightsMode);AccessManager.content=getEl("accessManagerDiv")},AccessManager.refresh=function(){DBMS.getManagementInfo(function(e,t){return e?void Utils.handleError(e):void PermissionInformer.isAdmin(function(e,r){return e?void Utils.handleError(e):void PermissionInformer.isEditor(function(e,a){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!r,function(e,n){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!r,function(e,i){return e?void Utils.handleError(e):void PermissionInformer.getGroupNamesArray(!r,function(e,o){if(e)return void Utils.handleError(e);var s={characters:n,groups:o,stories:i};if(!r&&a)for(var l in s)s[l]=s[l].filter(R.prop("isOwner"));AccessManager.rebuildInterface(s,t),Utils.enable(AccessManager.content,"adminOnly",r),Utils.enable(AccessManager.content,"editorOrAdmin",r||a)})})})})})})},AccessManager.rebuildInterface=function(e,t){var r=t.usersInfo,a=Object.keys(r).sort(CommonUtils.charOrdA),n=[];n.push(getEl("passwordUserName")),n.push(getEl("userPermissionSelector")),n.push(getEl("newEditorSelector")),n.forEach(function(e){Utils.rebuildSelectorArr(e,a)});var i=a.slice(0);i.splice(a.indexOf(t.admin),1);var o=getEl("newAdminSelector");Utils.rebuildSelectorArr(o,i),o=getEl("userRemoveSelector"),Utils.rebuildSelectorArr(o,i),AccessManager.entities.forEach(function(t){Utils.rebuildSelector(getEl("permission-selector__"+t),e[t])}),addEl(clearEl(getEl("currentAdministrator")),makeText(t.admin));var s=clearEl(getEl("currentEditor"));t.editor&&addEl(s,makeText(t.editor)),getEl("adaptationRights"+t.adaptationRights).checked=!0,AccessManager.buildPermissionList(e,r)},AccessManager.buildPermissionList=function(e,t){function r(e){return addEl(makeEl("li"),makeText(e))}function a(e){return AccessManager.entities.reduce(function(t,a){return t.push(r(o[a])),t.push(addEls(makeEl("ol"),e[a].sort().map(r))),t},[])}var n=clearEl(getEl("permissionTable")),i=makeEl("ul");addEl(n,i),R.keys(e).forEach(function(t){e[t]=e[t].map(R.prop("value"))}),R.values(t).forEach(function(t){R.keys(t).forEach(function(r){e[r]=R.difference(e[r],t[r])})}),t[getL10n("admins-have-not-owner")]=e;var o={characters:getL10n("admins-characters"),stories:getL10n("admins-stories"),groups:getL10n("admins-groups")},s=Object.keys(t).sort(CommonUtils.charOrdA);addEls(i,s.reduce(function(e,n){return e.push(r(n)),e.push(addEls(makeEl("ol"),a(t[n]))),e},[]))},AccessManager.createUser=function(){var e=getEl("userNameInput"),t=e.value.trim();if(""===t)return void Utils.alert(getL10n("admins-user-name-is-not-specified"));var r=getEl("userPasswordInput"),a=r.value.trim();return""===a?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.isUserNameUsed(t,function(e,r){return e?void Utils.handleError(e):void(r?Utils.alert(getL10n("admins-user-already-exists")):DBMS.createUser(t,a,Utils.processError(AccessManager.refresh)))})},AccessManager.changePassword=function(){var e=getEl("passwordUserName").value.trim(),t=getEl("newPassword").value.trim();return""===t?void Utils.alert(getL10n("admins-password-is-not-specified")):void DBMS.changePassword(e,t,Utils.processError(AccessManager.refresh))},AccessManager.removeUser=function(){var e=getEl("userRemoveSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-user-remove"),[e]))&&DBMS.removeUser(e,Utils.processError(AccessManager.refresh))},AccessManager.getSelectedOptions=function(e){for(var t=getEl(e).selectedOptions,r=[],a=0;a<t.length;a++)r.push(t[a].value);return r},AccessManager.permissionAction=function(e){return function(){var t=getEl("userPermissionSelector").value.trim();if(""===t)return void Utils.alert(getL10n("admins-user-is-not-selected"));var r={};AccessManager.entities.forEach(function(e){r[e]=AccessManager.getSelectedOptions("permission-selector__"+e)}),DBMS[e](t,r,Utils.processError(AccessManager.refresh))}},AccessManager.removePermission=AccessManager.permissionAction("removePermission"),AccessManager.assignPermission=AccessManager.permissionAction("assignPermission"),AccessManager.assignNewAdmin=function(){var e=getEl("newAdminSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-admin-assigment"),[e]))&&DBMS.assignAdmin(e,Utils.processError(AccessManager.refresh))},AccessManager.removeEditor=function(){DBMS.removeEditor(Utils.processError(AccessManager.refresh))},AccessManager.assignEditor=function(){var e=getEl("newEditorSelector").value.trim();Utils.confirm(strFormat(getL10n("admins-confirm-editor-assigment"),[e]))&&DBMS.assignEditor(e,Utils.processError(AccessManager.refresh))},AccessManager.changeAdaptationRightsMode=function(e){DBMS.changeAdaptationRightsMode(e.target.value,Utils.processError())};var BriefingExport={};BriefingExport.templates={},BriefingExport.init=function(){listen(getEl("makeDefaultTextBriefings"),"click",function(){BriefingExport.resolveTextTemplate(function(e){BriefingExport.makeTextBriefings("txt",e)})}),listen(getEl("makeCustomTextBriefings"),"click",function(){BriefingExport.makeTextBriefings(getEl("textTypeSelector").value,getEl("templateArea").value)});var e=getEl("docxBriefings");e.addEventListener("change",BriefingExport.readTemplateFile);for(var t=document.querySelectorAll("#briefingExportDiv input[name=exportSelection]"),r=0;r<t.length;r++)listen(t[r],"change",BriefingExport.onExportSelectionChange);getEl("exportSelectionAll").checked=!0,e=getEl("briefingNumberSelector"),Constants.briefingNumber.forEach(R.compose(addEl(e),makeOpt)),listen(e,"change",BriefingExport.onNumberSelectorChange),BriefingExport.briefingNumberSelector=e,BriefingExport.briefingIntervalSelector=getEl("briefingIntervalSelector"),BriefingExport.briefingMultiSelector=getEl("briefingMultiSelector"),getEl("makeBriefingsByTime ".trim()).addEventListener("click",BriefingExport.makeExport("templateByTime")),getEl("makeBriefingsByStory".trim()).addEventListener("click",BriefingExport.makeExport("templateByStory")),getEl("makeInventoryList   ".trim()).addEventListener("click",BriefingExport.makeExport("inventoryTemplate")),UI.initTabPanel("exportModeButton","exportContainer"),listen(getEl("previewTextOutput"),"click",BriefingExport.previewTextOutput),getEl("textBriefingPreviewArea").value="",listen(getEl("showRawData"),"click",BriefingExport.previewTextDataAsIs),listen(getEl("convertToDocxTemplate"),"click",BriefingExport.convertToDocxTemplate),listen(getEl("generateByDocxTemplate"),"click",BriefingExport.generateByDocxTemplate),BriefingExport.briefingSelector=getEl("briefingSelector"),BriefingExport.briefingMultiSelect=getEl("briefingMultiSelect"),BriefingExport.content=getEl("briefingExportDiv")},BriefingExport.refresh=function(){BriefingExport.resolveTextTemplate(function(e){getEl("templateArea").value=e,BriefingExport.onNumberSelectorChange()})},BriefingExport.resolveTextTemplate=function(e){DBMS.getAllProfileSettings(function(t,r){if(t)return void Utils.handleError(t);var a=R.compose(R.join(""),R.insert(1,R.__,["{{profileInfo-","}}\n"]),R.prop("name")),n=R.compose(R.equals(!0),R.prop("doExport")),i=r.filter(n).map(a).join("");e(R.replace(/\{0\}/g,i,TEXT_TEMPLATE))})},BriefingExport.onExportSelectionChange=function(e){var t="exportSelectionSpecific"===e.target.id,r="exportSelectionMultiple"===e.target.id;setClassByCondition(BriefingExport.briefingSelector,"hidden",!t),setClassByCondition(BriefingExport.briefingMultiSelect,"hidden",!r)},BriefingExport.getSelectedUsers=function(){var e=getSelectedRadio("#briefingExportDiv input[name=exportSelection]").id;switch(e){case"exportSelectionAll":return null;case"exportSelectionSpecific":return JSON.parse(BriefingExport.briefingIntervalSelector.selectedOptions[0].value);case"exportSelectionMultiple":for(var t=BriefingExport.briefingMultiSelector.selectedOptions,r={},a=0;a<t.length;a++)r[t[a].value]=!0;return r;default:Utils.alert("unexpected id: "+e)}return null},BriefingExport.onNumberSelectorChange=function(){var e,t,r,a=(clearEl(BriefingExport.briefingIntervalSelector),clearEl(BriefingExport.briefingMultiSelector)),n=Number(BriefingExport.briefingNumberSelector.value);PermissionInformer.getCharacterNamesArray(!1,function(i,o){if(i)return void Utils.handleError(i);if(o.length>0){e=arr2Chunks(o,n);var s=e.map(function(e){return t=1===e.length?e[0].displayName:e[0].displayName+" - "+e[e.length-1].displayName,r=JSON.stringify(e.reduce(function(e,t){return e[t.value]=!0,e},{})),{id:r,text:t}});$("#"+BriefingExport.briefingIntervalSelector.id).select2({data:s}),fillSelector(a,o.map(remapProps4Select))}})},BriefingExport.makeExport=function(e){return function(){BriefingExport.templates[e]||(BriefingExport.templates[e]=atob(templatesArr[e])),BriefingExport.exportDocxByTemplate(BriefingExport.templates[e])}},BriefingExport.getBriefingData=function(e){DBMS.getBriefingData(BriefingExport.getSelectedUsers(),function(t,r){return t?void Utils.handleError(t):void DBMS.getAllProfileSettings(function(t,a){if(t)return void Utils.handleError(t);var n=a.filter(function(e,t){return"checkbox"===e.type}).map(R.prop("name"));r.briefings.forEach(function(e){e.profileInfoArray.forEach(function(e){-1!=n.indexOf(e.itemName)&&(e.value=constL10n(Constants[e.value]),e.splittedText=[{string:constL10n(Constants[e.value])}])}),n.forEach(function(t){e["profileInfo-"+t]=constL10n(Constants[e["profileInfo-"+t]])})}),e(null,r)})})},BriefingExport.exportDocxByTemplate=function(e){BriefingExport.getBriefingData(function(t,r){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(r,"docx",BriefingExport.generateSingleDocx("blob",e),BriefingExport.generateSingleDocx("Uint8Array",e))})},BriefingExport.convertToDocxTemplate=function(){var e=BriefingExport.makeDocxTemplate("blob");Utils.confirm(getL10n("briefings-save-file"))&&saveAs(e,"template.docx")},BriefingExport.generateByDocxTemplate=function(){BriefingExport.exportDocxByTemplate(BriefingExport.makeDocxTemplate("Uint8Array"))},BriefingExport.makeDocxTemplate=function(e){var t=getEl("templateArea").value,r=R.pipe(R.replace(/{{{/g,"{"),R.replace(/}}}/g,"}"),R.replace(/{{/g,"{"),R.replace(/}}/g,"}"));t=r(t).split("\n").map(function(e){return{string:e}}),BriefingExport.templates.genericTemplate||(BriefingExport.templates.genericTemplate=atob(templatesArr.genericTemplate));var a=new window.Docxgen(BriefingExport.templates.genericTemplate);return a.setData({splittedText:t}),a.render(),a.getZip().generate({type:e})},BriefingExport.previewTextDataAsIs=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=JSON.stringify(t,null,"  "))})},BriefingExport.previewTextOutput=function(){BriefingExport.getBriefingData(function(e,t){return e?void Utils.handleError(e):void(getEl("textBriefingPreviewArea").value=BriefingExport.generateSingleTxt(getEl("templateArea").value,t))})},BriefingExport.makeTextBriefings=function(e,t){var r=BriefingExport.generateSingleTxt(t);BriefingExport.getBriefingData(function(t,a){return t?void Utils.handleError(t):void BriefingExport.generateBriefings(a,e,function(e){var t=r(e);return new Blob([t],{type:"text/plain;charset=utf-8"})},r)})},BriefingExport.readTemplateFile=function(e){var t=e.target.files[0];if(t){var r=new FileReader;r.onload=function(e){var t=e.target.result;BriefingExport.getBriefingData(function(e,r){return e?void Utils.handleError(e):void BriefingExport.generateBriefings(r,"docx",BriefingExport.generateSingleDocx("blob",t),BriefingExport.generateSingleDocx("Uint8Array",t))})},r.readAsBinaryString(t)}else Utils.alert(getL10n("briefings-error-on-template-uploading"))};var updateStatus=function(e){var t=getEl("exportStatus");clearEl(t),t.appendChild(makeText(e))};BriefingExport.generateBriefings=function(e,t,r,a){var n,i,o=getEl("toSeparateFileCheckbox").checked,s="briefings";updateStatus(getL10n("briefings-save-preparing"));try{if(o){var l=new JSZip;l.generate();updateStatus(getL10n("briefings-start-saving"));var c=BriefingExport.makeArchiveData(e,a);for(var d in c)l.file(d+"."+t,c[d]);updateStatus(getL10n("briefings-archiving")),i=l.generate({type:"blob"}),updateStatus(getL10n("briefings-archive-is-ready")),BriefingExport.saveFile("briefings-save-archive",i,s+".zip")}else updateStatus(getL10n("briefings-start-saving")),n=r(e),updateStatus(getL10n("briefings-file-is-ready")),BriefingExport.saveFile("briefings-save-file",n,s+"."+t)}catch(u){Utils.alert(getL10n("briefings-error-on-generating-briefings")),console.log(u)}},BriefingExport.saveFile=function(e,t,r){Utils.confirm(getL10n(e))&&saveAs(t,r)},BriefingExport.makeArchiveData=function(e,t){var r={};return e.briefings.forEach(function(a,n){r[a.charName]=t({gameName:e.gameName,briefings:[a]}),updateStatus(strFormat(getL10n("briefings-save-status"),[n+1,e.briefings.length]))}),r},BriefingExport.generateSingleDocx=R.curry(function(e,t,r){var a=new window.Docxgen(t);a.setData(r),a.render();var n=a.getZip().generate({type:e});return n}),BriefingExport.generateSingleTxt=R.curry(function(e,t){try{return Mustache.render(e,t)}catch(r){throw Utils.alert(strFormat(getL10n("briefings-template-error"),[r.message])),r}}),function(e){var t;e.init=function(){$("#briefingCharacter").select2().on("change",r);var t=getEl("eventGroupingByStoryRadio");listen(t,"change",e.refresh),t.checked=!0,t=getEl("adaptationsModeRadio"),listen(t,"change",e.refresh),t.checked=!0,listen(getEl("eventGroupingByTimeRadio"),"change",e.refresh),listen(getEl("proofreadingModeRadio"),"change",e.refresh),listen(getEl("hideAllPanelsCheckbox"),"change",e.refresh),listen(getEl("disableHeadersCheckbox"),"change",e.refresh),e.content=getEl("briefingPreviewDiv")},e.refresh=function(){clearEl(getEl("briefingCharacter")),clearEl(getEl("briefingContent")),DBMS.getAllProfileSettings(function(e,r){return e?void Utils.handleError(e):(t=r,void PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);if(t.length>0){var r=DBMS.getSettings();r.BriefingPreview||(r.BriefingPreview={characterName:t[0].value});var a=r.BriefingPreview.characterName,n=t.map(R.prop("value"));-1===n.indexOf(a)&&(r.BriefingPreview.characterName=t[0].value,a=t[0].value);var i=getSelect2Data(t);$("#briefingCharacter").select2(i).val(a).trigger("change")}}))})};var r=function(e){n(e.target.value)},a=function(e){var t=DBMS.getSettings();t.BriefingPreview.characterName=e},n=function(e){a(e);var t=clearEl(getEl("briefingContent")),r=0,n={characterName:e},o=function(){r<i.length?(r++,i[r-1].load(n,o)):i.map(R.prop("make")).forEach(function(e){e(t,n)})};o()},i=[{name:"storyRights",load:function(e,t){PermissionInformer.getStoryNamesArray(!0,function(r,a){return r?void Utils.handleError(r):(e.userStoryNamesMap=R.indexBy(R.prop("value"),a),void t())})},make:function(e,t){}},{name:"profile",load:function(e,t){DBMS.getProfile(e.characterName,function(r,a){return r?void Utils.handleError(r):(e.profile=a,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("briefings-profile")),y(t.profile)))}},{name:"inventory",load:function(e,t){DBMS.getAllInventoryLists(e.characterName,function(r,a){return r?void Utils.handleError(r):(e.allInventoryLists=a,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("briefings-inventory")+" ("+t.allInventoryLists.length+")"),h(t.allInventoryLists,t.characterName,t.userStoryNamesMap)))}},{name:"groups",load:function(e,t){DBMS.getCharacterGroupTexts(e.characterName,function(r,a){return r?void Utils.handleError(r):(e.groupTexts=a,void t())})},make:function(e,t){addEl(e,l(makeText(getL10n("header-groups")+" ("+t.groupTexts.length+")"),v(t.groupTexts)))}},{name:"relations",load:function(e,t){DBMS.getAllProfiles(function(r,a){return r?void Utils.handleError(r):void DBMS.getRelationsSummary(e.characterName,function(r,n){return r?void Utils.handleError(r):void PermissionInformer.getCharacterNamesArray(!1,function(r,i){return r?void Utils.handleError(r):(e.relationsSummary=n,e.characterNamesArray=i,e.profiles=a,void t())})})})},make:function(e,t){var r=getL10n("header-relations")+" ("+R.keys(t.relationsSummary.directRelations).length+")";addEl(e,l(makeText(r),g(t.characterName,t.relationsSummary,t.characterNamesArray,t.profiles)))}},{name:"stories",load:function(e,t){t()},make:function(e,t){var r=getEl("eventGroupingByStoryRadio").checked;r?C(e,t.characterName,t.userStoryNamesMap):b(e,t.characterName,t.userStoryNamesMap)}}],o=function(){s(),Utils.enable(e.content,"notEditable",!1)},s=function(){R.ap([UI.resizeTextarea],nl2array(getEl("briefingContent").getElementsByTagName("textarea")).map(function(e){return{target:e}}))},l=function(e,t){var r=addClasses(makeEl("div"),["panel","panel-default"]),a=addClass(addEl(makeEl("h3"),e),"panel-title"),n=setAttr(makeEl("a"),"href","#/"),i=addClass(makeEl("div"),"panel-heading");addEl(r,addEl(i,addEl(n,a)));var o=addClass(makeEl("div"),"panel-body");setClassByCondition(o,"hidden",getEl("hideAllPanelsCheckbox").checked),addEl(r,addEl(o,t));var l=UI.togglePanel(o);return listen(n,"click",function(){l(),s()}),r},c=["character-name","direct-relation","reverse-relation","extra-info"],d=["character-name","direct-relation","extra-info"],u=function(e,t){return[addEl(addClass(makeEl("div"),"bold-cursive"),makeText(e)),makeText(t)]},m=R.curry(function(e,t,r,a,n,i){var o=addClass(makeEl("textarea"),"briefing-relation-area");o.value=a.directRelations[i]||"",listen(o,"change",function(e){DBMS.setCharacterRelation(n,i,e.target.value,Utils.processError())});var s;r?(s=addClass(makeEl("textarea"),"briefing-relation-area"),s.value=a.reverseRelations[i]||"",listen(s,"change",function(e){DBMS.setCharacterRelation(i,n,e.target.value,Utils.processError())})):s=makeEl("span");var l=a.knownCharacters[i],c=[addEl(makeEl("td"),makeText(i)),addEl(makeEl("td"),o)];r&&c.push(addEl(makeEl("td"),s));var d=[addClass(addEl(makeEl("div"),makeText(getL10n("briefings-where-meets"))),"bold-cursive"),addEl(makeEl("div"),makeText(void 0===l?"":R.keys(l).join(", "))),makeEl("br"),addEls(setAttr(makeEl("div"),"toCharacter",i),u(t.value,e[i][t.value]))];return c.push(addEls(makeEl("td"),d)),addEls(makeEl("tr"),c)}),p=function(e,t,r){var a=$("<select></select>"),n=$("<span></span>").append(a);addClass(a[0],"common-select");var i=(a.select2(getSelect2Data(t)),addEl(makeEl("button"),makeText(getL10n("common-add"))));return listen(i,"click",function(){r(a[0].value),t=t.filter(R.compose(R.not,R.equals(a[0].value),R.prop("value"))),clearEl(a[0]),a.select2(getSelect2Data(t))}),addEls(makeEl("div"),[addEl(makeEl("span"),makeText(e)),n[0],i])},f=function(e){var r=$("<select></select>"),a=$("<span></span>").append(r);addClasses(r[0],["common-select","profile-item-select"]);var n=r.select2(arr2Select2(t.map(R.prop("name")).sort()));return n.on("change",e),n.val(t[0].name).trigger("change"),{el:addEls(makeEl("div"),[addEl(makeEl("span"),makeText(getL10n("briefings-profile-item"))),a[0]]),select:r[0]}},g=function(e,t,r,a){r=r.filter(R.compose(R.not,R.equals(e),R.prop("value")));var n=R.union(R.keys(t.directRelations),R.keys(t.reverseRelations)).sort(),i=r.filter(R.compose(R.not,R.contains(R.__,n),R.prop("value"))),o=i.filter(R.compose(R.contains(R.__,R.keys(t.knownCharacters)),R.prop("value"))),s=i.filter(R.compose(R.not,R.contains(R.__,R.keys(t.knownCharacters)),R.prop("value"))),l=getEl("adaptationsModeRadio").checked,g=makeEl("tbody"),v=f(function(e){var t=nl2array(queryElEls(g,"[toCharacter]"));t.map(clearEl).forEach(function(t){var r=getAttr(t,"toCharacter"),n=e.target.value;addEls(t,u(n,a[r][n]))})}),h=m(a,v.select,l,t,e),E=R.compose(addEl(g),h),y=addEls(addClass(makeEl("div"),"entity-management relations-management"),[p(getL10n("briefings-known-characters"),o,E),p(getL10n("briefings-unknown-characters"),s,E),v.el]),b=l?c:d,S=addEl(makeEl("thead"),addEls(makeEl("tr"),b.map(function(e){return addEl(makeEl("th"),makeText(getL10n("briefings-"+e)))}))),C=addEls(addClasses(makeEl("table"),["table"]),[S,g]);return addEls(g,n.filter(function(e){return l?!0:void 0!==t.directRelations[e]}).map(h)),addEls(makeEl("div"),[y,C])},v=function(e){return addEls(makeEl("div"),e.map(function(e){var t=makeEl("div");addEl(t,addEl(makeEl("h4"),makeText(e.groupName)));var r=addEl(makeEl("textarea"),makeText(e.text));return setAttr(r,"disabled","disabled"),addClass(r,"briefingTextSpan"),addEl(t,r)}))},h=function(e,t,r){var a;return a=makeEl("tbody"),e.forEach(function(e){var n=makeEl("input");n.value=e.inventory,n.storyName=e.storyName,n.characterName=t,addClass(n,"inventoryInput"),r[e.storyName]||addClass(n,"notEditable"),n.addEventListener("change",N),addEl(a,E(makeText(e.storyName),n))}),addEl(addClasses(makeEl("table"),["table","table-striped"]),a)},E=function(e,t){return addEls(makeEl("tr"),[addEl(makeEl("td"),e),addEl(makeEl("td"),t)])},y=function(e){var r,a,n;return r=makeEl("tbody"),t.forEach(function(t){if(t.doExport){switch(a=makeText(t.name),t.type){case"text":n=addClass(makeEl("span"),"briefingTextSpan"),addEl(n,makeText(e[t.name]));break;case"enum":case"number":case"string":n=makeText(e[t.name]);break;case"checkbox":n=makeText(constL10n(Constants[e[t.name]]))}addEl(r,E(a,n))}}),addEl(addClasses(makeEl("table"),["table","table-striped"]),r)},b=function(e,t,r){DBMS.getCharacterEventsByTime(t,function(a,n){if(a)return void Utils.handleError(a);var i=n.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(i,function(a,i){if(a)return void Utils.handleError(a);var s={userStoryNamesMap:r,areAdaptationsEditable:i,showStoryName:!0},c=5;addEls(e,R.splitEvery(c,n).map(function(e,r){var a,n=addEls(makeEl("div"),e.map(function(e,a){return s.index=r*c+1+a,w(e,t,s)}));return a=getEl("disableHeadersCheckbox").checked?makeText(strFormat(getL10n("briefings-events-header"),[r*c+1,r*c+e.length])):addEls(makeEl("div"),e.map(function(e){return k(e,!0)})),l(a,n)})),o()})})},S=function(e,t){var r;return r=getEl("disableHeadersCheckbox").checked?strFormat(getL10n("briefings-story-header"),[t+1]):e.storyName,makeText(r+" ("+e.events.length+")")},C=function(e,t,r){DBMS.getCharacterEventGroupsByStory(t,function(a,n){if(a)return void Utils.handleError(a);var i=n.map(function(e){return{characterName:t,storyName:e.storyName}});PermissionInformer.areAdaptationsEditable(i,function(a,i){if(a)return void Utils.handleError(a);var s={userStoryNamesMap:r,areAdaptationsEditable:i,showStoryName:!1};addEls(e,n.map(function(e,r){var a=addEls(makeEl("div"),e.events.map(function(e,r){return s.index=r+1,w(e,t,s)}));return l(S(e,r),a)})),o()})})},k=function(e,t){var r=addEl(makeEl("span"),makeText(strFormat("{0} {1}",[t?e.storyName+":":"",e.name]))),a=addClass(addEl(makeEl("span"),makeText(e.time)),"previewEventTime");return addEls(makeEl("div"),[a,r])},x=function(e,t,r){return getEl("disableHeadersCheckbox").checked?addEl(makeEl("h4"),makeText(strFormat(getL10n("briefings-event-header"),[r]))):addEl(makeEl("h4"),k(e,t))},w=function(e,t,r){var a=makeEl("div"),n=getEl("adaptationsModeRadio").checked,i=(e.text,e.characters[t].text),o=!!r.userStoryNamesMap[e.storyName],s=r.areAdaptationsEditable[e.storyName+"-"+t],l=""===i,c=[];c.push(x(e,r.showStoryName,r.index)),c.push(makeText(getL10n("briefings-subjective-time"))),c.push(UI.makeAdaptationTimeInput(e.storyName,e,t,s));var d;if(n||l){d=makeEl("textarea"),addClass(d,"briefingPersonalStory"),setClassByCondition(d,"notEditable",!o),d.value=e.text,d.eventIndex=e.index,d.storyName=e.storyName,listen(d,"change",T),P(d);var u=I(d,o),m=makeEl("div");addEls(m,[addEl(makeEl("h5"),makeText(getL10n("briefings-origin"))),u,d]),c.push(m)}if(n||!l){d=makeEl("textarea"),addClass(d,"briefingPersonalStory"),setClassByCondition(d,"notEditable",!s),d.value=e.characters[t].text,d.characterName=t,d.eventIndex=e.index,d.storyName=e.storyName,listen(d,"change",B),P(d);var p=makeEl("div");addEls(p,[addEl(makeEl("h5"),makeText(getL10n("briefings-adaptation"))),d,makeEl("br")]),c.push(p)}return addEls(a,c),a},P=function(e){listen(e,"keydown",UI.resizeTextarea),listen(e,"paste",UI.resizeTextarea),listen(e,"cut",UI.resizeTextarea),listen(e,"change",UI.resizeTextarea),listen(e,"drop",UI.resizeTextarea)},I=function(e,t){e.setAttribute("disabled","disabled");var r=addEl(makeEl("button"),makeText(getL10n("briefings-unlock-event-source")));return setClassByCondition(r,"notEditable",!t),listen(r,"click",function(){e.removeAttribute("disabled")}),r},N=function(e){var t=e.target;DBMS.updateCharacterInventory(t.storyName,t.characterName,t.value,Utils.processError())},T=function(e){var t=e.target.storyName,r=e.target.eventIndex,a=e.target.value;DBMS.setOriginEventText(t,r,a,Utils.processError())},B=function(e){var t=e.target.storyName,r=e.target.eventIndex,a=e.target.characterName,n=e.target.value;DBMS.setAdaptationEventText(t,r,a,n,Utils.processError())}}(this.BriefingPreview={});var Briefings={};Briefings.init=function(){var e=Briefings;e.views={};var t="briefingsNavigation",r="briefingsContent",a={root:e,navigation:getEl(t),content:getEl(r)};Utils.addView(a,"briefing-preview",BriefingPreview,{mainPage:!0}),Utils.addView(a,"briefing-export",BriefingExport),Briefings.content=getEl("briefingsDiv")},Briefings.refresh=function(){Briefings.currentView.refresh()};var CharacterFilter={};CharacterFilter.init=function(){listen(getEl("profileItemSelector"),"change",UI.showSelectedEls("-dependent")),listen(queryEl("#characterFilterDiv .create-entity-button"),"click",Groups.createGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .rename-entity-button"),"click",Groups.renameGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .remove-entity-button"),"click",Groups.removeGroup("#characterFilterDiv",CharacterFilter.groupAreaRefresh)),listen(queryEl("#characterFilterDiv .show-entity-button"),"click",CharacterFilter.loadFilterFromGroup),listen(queryEl("#characterFilterDiv .save-entity-button"),"click",CharacterFilter.saveFilterToGroup),listen(queryEl("#download-filter-table"),"click",CharacterFilter.downloadFilterTable),CharacterFilter.content=getEl("characterFilterDiv")},CharacterFilter.groupAreaRefresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(e){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(t){Groups.rebuildInterface("#characterFilterDiv",e);var r=getSelect2Data(t);clearEl(queryEl("#characterFilterDiv .save-entity-select")),$("#characterFilterDiv .save-entity-select").select2(r)}))}))},CharacterFilter.refresh=function(){CharacterFilter.sortKey=Constants.CHAR_NAME,CharacterFilter.sortDir="asc",CharacterFilter.inputItems={},CharacterFilter.checkboxes={};var e=clearEl(queryEl("#characterFilterDiv .filter-settings-panel"));addEl(e,addClass(makeEl("div"),"separator")),CharacterFilter.groupAreaRefresh(),FilterConfiguration.makeFilterConfiguration(function(t,r){if(t)return void Utils.handleError(t);CharacterFilter.filterConfiguration=r;var a=r.getAllProfileSettings();addEls(e,a.map(CharacterFilter.makeInput)),UI.fillShowItemSelector(clearEl(getEl("profileItemSelector")),CharacterFilter.getShowProfileItemNames(a)),addEl(clearEl(getEl("filterHead")),CharacterFilter.makeContentHeader(CharacterFilter.getHeaderProfileItemNames(a))),CharacterFilter.rebuildContent()})},CharacterFilter.getShowProfileItemNames=function(e){return R.map(R.prop("displayName"),e.filter(R.prop("canHide")))},CharacterFilter.getHeaderProfileItemNames=function(e){return R.map(R.pick(["name","displayName"]),e)},CharacterFilter.makePrintData=function(){var e=CharacterFilter.filterConfiguration.getDataArrays(CharacterFilter.makeFilterModel()),t=CommonUtils.charOrdAFactoryBase(CharacterFilter.sortDir,function(e){var t=CommonUtils.arr2map(e,"itemName"),r=t[CharacterFilter.sortKey],a=r.value;switch(r.type){case"text":case"string":case"enum":a=a.toLowerCase()}return a});return e.sort(t)},CharacterFilter.rebuildContent=function(){var e=CharacterFilter.makePrintData();addEl(clearEl(getEl("filterResultSize")),makeText(e.length)),addEls(clearEl(getEl("filterContent")),e.map(CharacterFilter.makeDataString)),UI.showSelectedEls("-dependent")({target:getEl("profileItemSelector")})},CharacterFilter.saveFilterToGroup=function(){var e=queryEl("#characterFilterDiv .save-entity-select").value.trim();PermissionInformer.isGroupEditable(e,function(t,r){return t?void Utils.handleError(t):r?void DBMS.saveFilterToGroup(e,CharacterFilter.makeFilterModel(),Utils.processError()):void Utils.alert(strFormat(getL10n("groups-group-editing-forbidden"),[e]))})},CharacterFilter.loadFilterFromGroup=function(){var e=queryEl("#characterFilterDiv .save-entity-select").value.trim();DBMS.getGroup(e,function(e,t){if(e)return void Utils.handleError(e);var r=CommonUtils.isFilterModelCompatibleWithProfiles(CharacterFilter.filterConfiguration.getBaseProfileSettings(),t.filterModel);return 0!=r.length?void Utils.alert(strFormat(getL10n("groups-base-filter-is-incompatible-with-page-profiles"),[r.join(",")])):(CharacterFilter.applyFilterModel(t.filterModel),void CharacterFilter.rebuildContent())})},CharacterFilter.downloadFilterTable=function(){function e(e){if(!("string"==typeof e||e instanceof String))return e;var t=e.replace(/"/g,'""');return t.search(/("|,|\n)/g)>=0&&(t='"'+t+'"'),t}for(var t=getEl("profileItemSelector"),r=[!0],a=0;a<t.options.length;a+=1)r[a+1]=t.options[a].selected;var n=CharacterFilter.makePrintData(),i="\ufeff"+n.map(function(t){return t.filter(function(e,t){return r[t]}).map(R.pipe(R.prop("value"),e)).join(";")}).join("\n"),o=new Blob([i],{type:"text/csv;charset=utf-8;"});saveAs(o,"table.csv")},CharacterFilter.applyFilterModel=function(e){var e=CommonUtils.arr2map(e,"name");Object.keys(CharacterFilter.inputItems).forEach(function(t){if(!t.endsWith(":numberInput")){var r,a=CharacterFilter.inputItems[t];if(CharacterFilter.checkboxes[t].checked!=(null!=e[t])&&CharacterFilter.checkboxes[t].click(),e[t]){var n=e[t];switch(a.selfInfo.type){case"enum":for(r=0;r<a.options.length;r+=1)a.options[r].selected=!!n.selectedOptions[a.options[r].value];break;case"checkbox":a.options[0].selected=n.selectedOptions["true"],a.options[1].selected=n.selectedOptions["false"];break;case"number":a.value=n.condition,CharacterFilter.inputItems[a.selfInfo.name+":numberInput"].value=n.num;break;case"text":case"string":a.value=n.regexString}}else switch(a.selfInfo.type){case"enum":case"checkbox":for(r=0;r<a.options.length;r+=1)a.options[r].selected=!0;break;case"number":CharacterFilter.inputItems[a.selfInfo.name+":numberInput"].value=0,a.value="ignore";break;case"text":case"string":a.value=""}}})},CharacterFilter.makeFilterModel=function(){var e=[];return Object.keys(CharacterFilter.inputItems).forEach(function(t){if(!t.endsWith(":numberInput")&&CharacterFilter.checkboxes[t].checked!==!1){var r,a,n,i,o=CharacterFilter.inputItems[t];
switch(o.selfInfo.type){case"enum":for(r={},i=0,n=0;n<o.options.length;n+=1)o.options[n].selected&&(r[o.options[n].value]=!0,i++);if(o.options.length==i)return;e.push({type:"enum",name:t,selectedOptions:r});break;case"checkbox":if(r={},o.options[0].selected&&o.options[1].selected)return;o.options[0].selected&&(r["true"]=!0),o.options[1].selected&&(r["false"]=!0),e.push({type:"checkbox",name:t,selectedOptions:r});break;case"number":if("ignore"===o.value)return;a=Number(CharacterFilter.inputItems[o.selfInfo.name+":numberInput"].value),e.push({type:"number",name:t,num:a,condition:o.value});break;case"text":case"string":if(""==o.value)return;e.push({type:o.selfInfo.type,name:t,regexString:o.value.toLowerCase()})}}}),e},CharacterFilter.makeDataString=function(e){var t,r,a,n=CharacterFilter.inputItems;return addEls(makeEl("tr"),e.map(function(e,i){return a=e.value,"checkbox"===e.type?a=constL10n(Constants[a]):"text"===e.type&&(r=a.toLowerCase().indexOf(n[e.itemName].value.toLowerCase()),a=a.substring(r-5,r+15)),t=addEl(makeEl("td"),makeText(a)),addClass(t,i-1+"-dependent"),t}))},CharacterFilter.makeContentHeader=function(e){return addEls(makeEl("tr"),e.map(function(e,t){var r=addEls(makeEl("th"),[makeText(e.displayName),makeEl("span")]);return r.info=e.name,addClass(r,t-1+"-dependent"),listen(r,"click",CharacterFilter.onSortChange),r}))},CharacterFilter.onSortChange=function(e){var t=e.target;if("span"===t.tagName.toLowerCase()&&(t=t.parentElement),CharacterFilter.sortKey===t.info)CharacterFilter.sortDir="asc"===CharacterFilter.sortDir?"desc":"asc",setClassByCondition(t,"sortDesc","desc"===CharacterFilter.sortDir),setClassByCondition(t,"sortAsc","asc"===CharacterFilter.sortDir);else{var r=getEl("filterHead");nl2array(r.getElementsByClassName("sortAsc")).forEach(removeClass(R.__,"sortAsc")),nl2array(r.getElementsByClassName("sortDesc")).forEach(removeClass(R.__,"sortDesc")),CharacterFilter.sortKey=t.info,CharacterFilter.sortDir="asc",addClass(t,"sortAsc")}CharacterFilter.rebuildContent()},CharacterFilter.makeInput=function(e){var t=makeEl("div"),r=makeEl("label"),a=makeEl("input");a.type="checkbox",a.checked=!1,addEl(r,a),addEl(r,makeText(e.displayName));var n=function(e,t){return function(r){setClassByCondition(t,"hidden",!r.target.checked),setClassByCondition(e,"flex-front-element",r.target.checked),CharacterFilter.rebuildContent()}};addEl(t,r);var i=makeEl("div");return addClass(i,"hidden"),addEl(t,i),listen(a,"click",n(t,i)),CharacterFilter.checkboxes[e.name]=a,addEl(i,CharacterFilter.makeFilter(e)),t},CharacterFilter.makeFilter=function(e){switch(e.type){case"text":case"string":return CharacterFilter.makeTextFilter(e);case"enum":return CharacterFilter.makeEnumFilter(e);case"number":return CharacterFilter.makeNumberFilter(e);case"checkbox":return CharacterFilter.makeCheckboxFilter(e)}},CharacterFilter.makeTextFilter=function(e){var t=makeEl("input");return t.selfInfo=e,t.value="",t.addEventListener("input",CharacterFilter.rebuildContent),CharacterFilter.inputItems[e.name]=t,t},CharacterFilter.makeCommonEnumFilter=function(e,t){var r=makeEl("select");return r.selfInfo=e,r.multiple="multiple",r.size=t.length,t.forEach(function(e){var t=makeEl("option");t.selected=!0,t.value=e.name,t.appendChild(makeText(e.displayName)),r.appendChild(t)}),r.addEventListener("change",CharacterFilter.rebuildContent),CharacterFilter.inputItems[e.name]=r,r},CharacterFilter.makeEnumFilter=function(e){var t=e.value.split(",").map(function(e){return{name:e,displayName:e}});return CharacterFilter.makeCommonEnumFilter(e,t)},CharacterFilter.makeCheckboxFilter=function(e){var t=[{name:Constants[!0],displayName:constL10n(Constants[!0])},{name:Constants[!1],displayName:constL10n(Constants[!1])}];return CharacterFilter.makeCommonEnumFilter(e,t)},CharacterFilter.makeNumberFilter=function(e){var t=makeEl("select");t.selfInfo=e,Constants.numberFilter.forEach(function(e){var r=makeEl("option");r.appendChild(makeText(constL10n(e))),r.value=e,t.appendChild(r)}),t.selectedIndex=0,CharacterFilter.inputItems[e.name]=t,t.addEventListener("change",CharacterFilter.rebuildContent);var r=makeEl("input");r.value=0,r.type="number",CharacterFilter.inputItems[e.name+":numberInput"]=r,r.addEventListener("input",CharacterFilter.rebuildContent);var a=makeEl("div");return addEl(a,t),addEl(a,r),a};var CharacterProfile={};CharacterProfile.init=function(){listen(getEl("bioEditorSelector"),"change",CharacterProfile.showProfileInfoDelegate),CharacterProfile.content=getEl("characterProfile")},CharacterProfile.refresh=function(){PermissionInformer.getCharacterNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);var r=clearEl(getEl("bioEditorSelector"));t.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e.displayName)),t.value=e.value,r.appendChild(t)});var a=clearEl(getEl("profileContentDiv")),n=makeEl("table"),i=makeEl("tbody");n.appendChild(i),addClass(n,"table"),a.appendChild(n),CharacterProfile.inputItems={},DBMS.getAllProfileSettings(function(e,a){return e?void Utils.handleError(e):(a.forEach(function(e){CharacterProfile.appendInput(i,e)}),void CharacterProfile.applySettings(t,r))})})},CharacterProfile.applySettings=function(e,t){if(e.length>0){var r=e[0].value,a=DBMS.getSettings();a.CharacterProfile||(a.CharacterProfile={characterName:r});var n=a.CharacterProfile.characterName;-1===e.map(function(e){return e.value}).indexOf(n)&&(a.CharacterProfile.characterName=r,n=r),DBMS.getProfile(n,CharacterProfile.showProfileInfoCallback),t.value=n}},CharacterProfile.appendInput=function(e,t){var r=makeEl("tr"),a=makeEl("td");a.appendChild(makeText(t.name)),r.appendChild(a),a=makeEl("td");var n,i;switch(t.type){case"text":n=makeEl("textarea"),addClass(n,"profileTextInput");break;case"string":n=makeEl("input"),addClass(n,"profileStringInput");break;case"enum":n=makeEl("select"),i=t.value.split(","),i.forEach(function(e){var t=makeEl("option");t.appendChild(makeText(e)),n.appendChild(t)});break;case"number":n=makeEl("input"),n.type="number";break;case"checkbox":n=makeEl("input"),n.type="checkbox"}n.addEventListener("change",CharacterProfile.updateFieldValue(t.type)),n.selfName=t.name,addClass(n,"isCharacterEditable"),a.appendChild(n),CharacterProfile.inputItems[t.name]=n,r.appendChild(a),e.appendChild(r)},CharacterProfile.updateFieldValue=function(e){return function(t){var r,a=t.target.selfName,n=CharacterProfile.name;switch(e){case"text":case"string":case"enum":r=t.target.value;break;case"number":if(isNaN(t.target.value))return Utils.alert(getL10n("characters-not-a-number")),void(t.target.value=t.target.oldValue);r=Number(t.target.value);break;case"checkbox":r=t.target.checked}DBMS.updateProfileField(n,a,e,r,Utils.processError())}},CharacterProfile.showProfileInfoDelegate=function(e){var t=e.target.value.trim();DBMS.getProfile(t,CharacterProfile.showProfileInfoCallback)},CharacterProfile.showProfileInfoCallback=function(e,t){if(e)return void Utils.handleError(e);var r=t.name;PermissionInformer.isCharacterEditable(r,function(e,a){if(e)return void Utils.handleError(e);CharacterProfile.updateSettings(r),CharacterProfile.name=r;var n=CharacterProfile.inputItems;Object.keys(n).forEach(function(e){"checkbox"===n[e].type?n[e].checked=t[e]:n[e].value=t[e],n[e].oldValue=t[e],Utils.enable(CharacterProfile.content,"isCharacterEditable",a)})})},CharacterProfile.updateSettings=function(e){var t=DBMS.getSettings();t.CharacterProfile.characterName=e};var CharacterProfileConfigurer={};CharacterProfileConfigurer.init=function(){var e=clearEl(getEl("profileItemTypeSelector")),t=function(){CharacterProfileConfigurer.fillSelector(clearEl(e))};t(),L10n.onL10nChange(t),listen(getEl("createProfileItemButton"),"click",CharacterProfileConfigurer.createProfileItem),listen(getEl("moveProfileItemButton"),"click",CharacterProfileConfigurer.moveProfileItem),listen(getEl("removeProfileItemButton"),"click",CharacterProfileConfigurer.removeProfileItem),CharacterProfileConfigurer.content=getEl("characterProfileConfigurer")},CharacterProfileConfigurer.refresh=function(){var e=[];e.push(getEl("profileItemPositionSelector")),e.push(getEl("moveProfileItemPositionSelector")),DBMS.getAllProfileSettings(function(t,r){if(t)return void Utils.handleError(t);var a;e.forEach(function(e){clearEl(e);var t=function(t){addEl(e,addEl(makeEl("option"),makeText(t)))};r.forEach(function(e){t(strFormat(getL10n("common-set-item-before"),[e.name]))}),t(getL10n("common-set-item-as-last")),e.selectedIndex=r.length});var n=clearEl(getEl("profileConfigBlock"));r.forEach(function(e,t){addEl(n,CharacterProfileConfigurer.getInput(e,t+1))}),PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(CharacterProfileConfigurer.content,"adminOnly",t)});var i=[];i.push(getEl("moveProfileItemSelector")),i.push(getEl("removeProfileItemSelector")),i.forEach(function(e){clearEl(e),r.forEach(function(t,r){a=makeEl("option"),a.appendChild(makeText(t.name)),a.profileItemIndex=r,e.appendChild(a)})})})},CharacterProfileConfigurer.createProfileItem=function(){var e=getEl("profileItemNameInput").value.trim();CharacterProfileConfigurer.validateProfileItemName(e,function(){var t=getEl("profileItemTypeSelector").value.trim();if(!Constants.profileFieldTypes[t])return void Utils.alert(strFormat(getL10n("characters-unknown-profile-item-type"),[t]));var r=Constants.profileFieldTypes[t].value,a=getEl("profileItemPositionSelector"),n=a.value;DBMS.createProfileItem(e,t,r,n===getL10n("common-set-item-as-last"),a.selectedIndex,Utils.processError(CharacterProfileConfigurer.refresh))})},CharacterProfileConfigurer.moveProfileItem=function(){var e=getEl("moveProfileItemSelector").selectedOptions[0].profileItemIndex,t=getEl("moveProfileItemPositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("characters-profile-item-positions-are-equal")):void DBMS.moveProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.removeProfileItem=function(){var e=getEl("removeProfileItemSelector").selectedIndex,t=getEl("removeProfileItemSelector").value;Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-removing-profile-item"),[t]))&&DBMS.removeProfileItem(e,t,Utils.processError(CharacterProfileConfigurer.refresh))},CharacterProfileConfigurer.fillSelector=function(e){var t=function(e,t){return setProp(addEl(makeEl("option"),makeText(t)),"value",e)};R.values(Constants.profileFieldTypes).forEach(function(r){addEl(e,t(r.name,constL10n(r.name)))})},CharacterProfileConfigurer.getInput=function(e,t){var r=makeEl("tr"),a=R.compose(addEl(r),function(e){return addEl(makeEl("td"),e)});a(addEl(makeEl("span"),makeText(t)));var n=setProps(makeEl("input"),{value:e.name,info:e.name});listen(n,"change",CharacterProfileConfigurer.renameProfileItem),addClass(n,"itemNameInput"),addClass(n,"adminOnly"),a(n);var i=makeEl("select");CharacterProfileConfigurer.fillSelector(i),setProps(i,{value:e.type,info:e.name,oldType:e.type}),listen(i,"change",CharacterProfileConfigurer.changeProfileItemType),addClass(i,"adminOnly"),a(i);var o="text"==e.type||"enum"==e.type;switch(n=o?makeEl("textarea"):makeEl("input"),setProps(n,{info:e.name,infoType:e.type,oldValue:e.value}),addClass(n,"adminOnly"),addClass(n,"profile-configurer-"+e.type),e.type){case"text":case"string":case"enum":n.value=e.value;break;case"number":n.type="number",n.value=e.value;break;case"checkbox":n.type="checkbox",n.checked=e.value}listen(n,"change",CharacterProfileConfigurer.updateDefaultValue),a(n);var n=setProps(makeEl("input"),{checked:e.doExport,info:e.name,type:"checkbox"});return listen(n,"change",CharacterProfileConfigurer.doExportChange),addClass(n,"adminOnly"),a(n),r},CharacterProfileConfigurer.updateDefaultValue=function(e){var t,r=e.target.info,a=e.target.infoType,n=e.target.oldValue;switch(a){case"text":case"string":case"number":case"enum":t=e.target.value;break;case"checkbox":t=e.target.checked}var i,o,s,l,c;switch(a){case"text":case"string":case"checkbox":DBMS.updateDefaultValue(r,t,Utils.processError());break;case"number":if(isNaN(t))return Utils.alert(getL10n("characters-not-a-number")),void(e.target.value=n);DBMS.updateDefaultValue(r,Number(t),Utils.processError());break;case"enum":if(""===t)return Utils.alert(getL10n("characters-enum-item-cant-be-empty")),void(e.target.value=n);if(i=n.split(","),o=t.split(","),o=o.map(function(e){return e.trim()}),s=[{}].concat(o).reduce(function(e,t){return e[t]=!0,e}),l=i.filter(function(e){return!s[e]}),0!==l.length)return Utils.confirm(strFormat(getL10n("characters-new-enum-values-remove-some-old-values"),[l.join(",")]))?(c=o.join(","),e.target.value=c,void DBMS.updateDefaultValue(r,c,Utils.processError())):void(e.target.value=n);c=o.join(","),e.target.value=c,DBMS.updateDefaultValue(r,c,Utils.processError())}},CharacterProfileConfigurer.doExportChange=function(e){DBMS.doExportProfileItemChange(e.target.info,e.target.checked,Utils.processError())},CharacterProfileConfigurer.renameProfileItem=function(e){var t=e.target.value.trim(),r=e.target.info;CharacterProfileConfigurer.validateProfileItemName(t,function(){DBMS.renameProfileItem(t,r,Utils.processError(CharacterProfileConfigurer.refresh))},function(){e.target.value=e.target.info})},CharacterProfileConfigurer.validateProfileItemName=function(e,t,r){if(""===e)return Utils.alert(getL10n("characters-profile-item-name-is-not-specified")),void(r&&r());if("name"===e)return Utils.alert(getL10n("characters-profile-item-name-cant-be-name")),void(r&&r());var a=function(){Utils.alert(getL10n("characters-such-name-already-used")),r&&r()};DBMS.isProfileItemNameUsed(e,function(e,r){return e?void Utils.handleError(e):void(r?a():t())})},CharacterProfileConfigurer.changeProfileItemType=function(e){if(Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-changing-profile-item-type"),[e.target.info]))){var t=e.target.value,r=e.target.info;DBMS.changeProfileItemType(r,t,Utils.processError(CharacterProfileConfigurer.refresh))}else e.target.value=e.target.oldType};var Characters={};Characters.init=function(){var e=Characters;e.views={};var t="charactersNavigation",r="charactersContent",a={root:e,navigation:getEl(t),content:getEl(r)};Utils.addView(a,"character-profile",CharacterProfile,{mainPage:!0}),Utils.addView(a,"character-profile-constructor",CharacterProfileConfigurer),listen(queryEl("#charactersDiv .create-entity-button"),"click",Characters.createCharacter),listen(queryEl("#charactersDiv .rename-entity-button"),"click",Characters.renameCharacter),listen(queryEl("#charactersDiv .remove-entity-button"),"click",Characters.removeCharacter),Characters.content=getEl("charactersDiv")},Characters.refresh=function(){PermissionInformer.getCharacterNamesArray(!0,Utils.processError(Characters.rebuildInterface))},Characters.rebuildInterface=function(e){var t=getSelect2Data(e);clearEl(queryEl("#charactersDiv .rename-entity-select")),$("#charactersDiv .rename-entity-select").select2(t),clearEl(queryEl("#charactersDiv .remove-entity-select")),$("#charactersDiv .remove-entity-select").select2(t),Characters.currentView.refresh()},Characters.createCharacter=function(){var e=queryEl("#charactersDiv .create-entity-input").value.trim();return""===e?void Utils.alert(getL10n("characters-character-name-is-not-specified")):void DBMS.isCharacterNameUsed(e,function(t,r){return t?void Utils.handleError(t):void(r?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[e])):DBMS.createCharacter(e,function(t){return t?void Utils.handleError(t):void PermissionInformer.refresh(function(t){return t?void Utils.handleError(t):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(e),void Characters.refresh())})}))})},Characters.renameCharacter=function(){var e=queryEl("#charactersDiv .rename-entity-select").value.trim(),t=queryEl("#charactersDiv .rename-entity-input").value.trim();return""===t?void Utils.alert(getL10n("characters-new-character-name-is-not-specified")):e===t?void Utils.alert(getL10n("characters-names-are-the-same")):void DBMS.isCharacterNameUsed(t,function(r,a){return r?void Utils.handleError(r):void(a?Utils.alert(strFormat(getL10n("characters-character-name-already-used"),[t])):DBMS.renameCharacter(e,t,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):(Characters.currentView.updateSettings&&Characters.currentView.updateSettings(t),void Characters.refresh())})}))})},Characters.removeCharacter=function(){var e=queryEl("#charactersDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("characters-are-you-sure-about-character-removing"),[e]))&&DBMS.removeCharacter(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Characters.refresh()})})};var Chat={};Chat.init=function(){var e=getEl("sendMessageButton");e.addEventListener("click",Chat.onSubmit),Chat.subscribe(),Chat.content=getEl("chatDiv")},Chat.refresh=function(){},Chat.onSubmit=function(){var e=getEl("chatMessage"),t=$.ajax({url:"/publish",dataType:"text",method:"PUT",contentType:"application/json;charset=utf-8",data:JSON.stringify({message:e.value})});return t.done(function(e){}),t.fail(function(e,t,r){alert(e.responseText)}),e.value="",!1},Chat.subscribe=function(){var e=$.ajax({url:"/subscribe",dataType:"text",method:"GET",contentType:"application/json;charset=utf-8"});e.done(function(e){var t=makeEl("li");t.appendChild(makeText(e)),messages.appendChild(t),Chat.subscribe()}),e.fail(function(e,t,r){setTimeout(Chat.subscribe,500)})};var EventPresence={name:"EventPresence"};EventPresence.init=function(){listen(getEl("eventPresenceSelector"),"change",UI.showSelectedEls("-dependent")),EventPresence.content=getEl("eventPresenceDiv")},EventPresence.refresh=function(){var e=getEl("eventPresenceTableHead"),t=getEl("eventPresenceTable"),r=getEl("eventPresenceSelector");return void 0==Stories.CurrentStoryName?(clearEl(e),clearEl(t),void clearEl(r)):void PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(a,n){return a?void Utils.handleError(a):void PermissionInformer.getCharacterNamesArray(!1,function(a,i){return a?void Utils.handleError(a):void DBMS.getStoryCharacterNamesArray(Stories.CurrentStoryName,function(a,o){if(a)return void Utils.handleError(a);var s={};i.forEach(function(e){s[e.value]=e});var l=o.map(function(e){return s[e]});l.sort(Utils.charOrdAObject);var c=l.map(function(e){return e.displayName}),o=l.map(function(e){return e.value});DBMS.getStoryEvents(Stories.CurrentStoryName,function(a,i){return a?void Utils.handleError(a):(clearEl(e),clearEl(t),UI.fillShowItemSelector(clearEl(r),c,o),EventPresence.appendTableHeader(e,c),void i.forEach(function(e,r){EventPresence.appendTableInput(t,e,r,o),Utils.enable(EventPresence.content,"isStoryEditable",n)}))})})})})},EventPresence.appendTableHeader=function(e,t){var r=makeEl("tr");rAddEl(rAddEl(makeText(getL10n("stories-event")),makeEl("th")),r),t.forEach(function(e,t){rAddEl(rAddEl(makeText(e),rAddClass(t+"-dependent",makeEl("th"))),r)}),e.appendChild(r)},EventPresence.appendTableInput=function(e,t,r,a){var n=makeEl("tr"),i=makeEl("td");i.appendChild(makeText(t.name)),n.appendChild(i),a.forEach(function(e,a){i=addClass(makeEl("td"),"vertical-aligned-td"),addClass(i,a+"-dependent");var o=makeEl("input");addClass(o,"isStoryEditable"),o.type="checkbox",t.characters[e]&&(o.checked=!0),o.eventIndex=r,o.eventName=t.name,o.characterName=e,o.hasText=null!=t.characters[e]&&""!=t.characters[e].text,o.addEventListener("change",EventPresence.onChangeCharacterCheckbox);var s=r+e;setAttr(o,"id",s),addClass(o,"hidden"),addEl(i,o);var l=addClass(makeEl("label"),"checkbox-label");setAttr(l,"for",s),addEl(i,l),n.appendChild(i)}),e.appendChild(n)},EventPresence.onChangeCharacterCheckbox=function(e){e.target.checked?DBMS.addCharacterToEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.hasText?Utils.confirm(strFormat(getL10n("stories-remove-character-from-event-warning"),[e.target.characterName,e.target.eventName]))?DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError()):e.target.checked=!0:DBMS.removeCharacterFromEvent(Stories.CurrentStoryName,e.target.eventIndex,e.target.characterName,Utils.processError())};var Events={};Events.init=function(){listen(getEl("events-storySelector"),"change",Events.updateAdaptationSelectorDelegate),listen(getEl("events-characterSelector"),"change",Events.showPersonalStoriesDelegate),listen(getEl("events-eventSelector"),"change",Events.showPersonalStoriesDelegate2),listen(getEl("finishedStoryCheckbox"),"change",Events.refresh),listen(getEl("adaptationFilterByCharacter"),"change",Events.updateFilter),listen(getEl("adaptationFilterByEvent"),"change",Events.updateFilter),Events.content=getEl("eventsDiv")},Events.getSelectedStoryName=function(e){var t=e.map(R.prop("storyName")),r=DBMS.getSettings();r.Events||(r.Events={storyName:t[0],characterNames:[],eventIndexes:[],selectedFilter:"adaptationFilterByCharacter"});var a=r.Events.storyName;return-1===t.indexOf(a)&&(r.Events.storyName=t[0],a=t[0]),a},Events.getNames=function(e,t,r){var a=e.map(R.prop(t)),n=DBMS.getSettings().Events[r],i=n.filter(function(e){return-1!==a.indexOf(e)});return Events.updateSettings(r,i),i},Events.getCharacterNames=function(e){return Events.getNames(e,"characterName","characterNames")},Events.getEventIndexes=function(e){return Events.getNames(e,"index","eventIndexes")},Events.refresh=function(){var e=clearEl(getEl("events-storySelector"));clearEl(getEl("events-characterSelector")),clearEl(getEl("events-eventSelector")),clearEl(getEl("personalStories")),PermissionInformer.getStoryNamesArray(!1,function(t,r){return t?void Utils.handleError(t):void DBMS.getFilteredStoryNames(getEl("finishedStoryCheckbox").checked,function(t,a){if(t)return void Utils.handleError(t);if(!(a.length<=0)){var n=Events.getSelectedStoryName(a),i=CommonUtils.arr2map(r,"value");a.forEach(function(e){e.displayName=i[e.storyName].displayName,e.value=i[e.storyName].value}),a.sort(Utils.charOrdAObject);var o;a.forEach(function(t){o=addEl(makeEl("option"),makeText(t.displayName+Events.getSuffix(t))),setProp(o,"selected",t.value===n),setProp(o,"storyInfo",t.value),addEl(e,o)}),Events.updateAdaptationSelector(n)}})})},Events.updateAdaptationSelectorDelegate=function(e){var t=e.target.selectedOptions[0].storyInfo;Events.updateSettings("storyName",t),Events.updateSettings("characterNames",[]),Events.updateAdaptationSelector(t)},Events.updateAdaptationSelector=function(e){var t=clearEl(getEl("events-characterSelector")),r=clearEl(getEl("events-eventSelector"));PermissionInformer.getCharacterNamesArray(!1,function(a,n){return a?void Utils.handleError(a):void DBMS.getFilteredCharacterNames(e,getEl("finishedStoryCheckbox").checked,function(a,i){return a?void Utils.handleError(a):void DBMS.getFilteredEventNames(e,getEl("finishedStoryCheckbox").checked,function(a,o){if(a)return void Utils.handleError(a);var s=Events.getCharacterNames(i),l=Events.getEventIndexes(o),c=CommonUtils.arr2map(n,"value");i.forEach(function(e){e.displayName=c[e.characterName].displayName,e.value=c[e.characterName].value}),i.sort(Utils.charOrdAObject);var d;i.forEach(function(r){d=addEl(makeEl("option"),makeText(r.displayName+Events.getSuffix(r))),setProp(d,"selected",-1!==s.indexOf(r.value)),setProp(d,"storyInfo",e),setProp(d,"characterName",r.value),addEl(t,d)}),setAttr(t,"size",i.length),o.forEach(function(t){d=addEl(makeEl("option"),makeText(t.name+Events.getSuffix(t))),setProp(d,"selected",-1!==l.indexOf(t.index)),setProp(d,"storyInfo",e),setProp(d,"eventIndex222",t.index),addEl(r,d)}),setAttr(r,"size",o.length);var u=DBMS.getSettings().Events.selectedFilter;getEl(u).checked=!0,Events.updateFilter({target:{id:u}})})})})},Events.updateFilter=function(e){Events.updateSettings("selectedFilter",e.target.id);var t="adaptationFilterByCharacter"===e.target.id;if(setClassByCondition(getEl("events-characterSelectorDiv"),"hidden",!t),setClassByCondition(getEl("events-eventSelectorDiv"),"hidden",t),t)Events.showPersonalStoriesDelegate({target:getEl("events-characterSelector")});else{var r,a=getEl("events-characterSelector");if(0===a.options.length)return;var n=[];for(r=0;r<a.options.length;r+=1)n.push(a.options[r].characterName);Events.showPersonalStories(a.options[0].storyInfo,n,function(){Events.showPersonalStoriesDelegate2({target:getEl("events-eventSelector")})})}},Events.showPersonalStoriesDelegate=function(e){if(0!=e.target.selectedOptions.length){var t,r=e.target.selectedOptions[0],a=r.storyInfo,n=[],i=e.target;for(t=0;t<i.selectedOptions.length;t+=1)n.push(i.selectedOptions[t].characterName);Events.updateSettings("characterNames",n),Events.showPersonalStories(a,n)}},Events.showPersonalStoriesDelegate2=function(e){var t,r,a=[],n=getEl("events-eventSelector"),i=getEls("eventRow-dependent");for(t=0;t<i.length;t+=1)addClass(i[t],"hidden");for(t=0;t<n.selectedOptions.length;t+=1)r=n.selectedOptions[t].eventIndex222,removeClass(getEls(r+"-dependent")[0],"hidden"),a.push(r);Events.updateSettings("eventIndexes",a)},Events.showPersonalStories=function(e,t,r){DBMS.getMetaInfo(function(a,n){return a?void Utils.handleError(a):void DBMS.getEvents(e,t,function(a,i){return a?void Utils.handleError(a):void PermissionInformer.isStoryEditable(e,function(a,o){if(a)return void Utils.handleError(a);var s=t.map(function(t){return{characterName:t,storyName:e}});PermissionInformer.areAdaptationsEditable(s,function(a,s){return a?void Utils.handleError(a):(Events.buildAdaptationInterface(e,t,i,s,n),Utils.enable(Events.content,"isStoryEditable",o),Utils.enable(Events.content,"notEditable",!1),void(r&&r()))})})})})},Events.buildAdaptationInterface=function(e,t,r,a,n){var i,o,s,l,c,d,u,m,p=clearEl(getEl("personalStories"));R.ap([addEl(p)],r.map(function(r){return i=makeEl("div"),R.ap([addClass(i)],["eventMainPanelRow",r.index+"-dependent","eventRow-dependent"]),o=addClass(makeEl("div"),"eventMainPanelRow-left"),d=addClass(makeEl("div"),"story-events-div-main"),u=addClass(makeEl("div"),"story-events-div-left"),m=addClass(makeEl("div"),"story-events-div-right"),addEl(d,u),addEl(d,m),addEl(o,d),addEl(u,addEl(makeEl("div"),makeText(r.name))),addEl(m,UI.makeEventTimePicker({eventTime:r.time,index:r.index,preGameDate:n.preGameDate,date:n.date,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:Events.onChangeDateTimeCreator(e)})),addEl(o,Events.makeOriginTextInput(e,r)),addEl(i,o),o=addClass(makeEl("div"),"eventMainPanelRow-right"),l=addClass(makeEl("div"),"events-eventsContainer"),R.ap([addEl(l)],t.filter(function(e){return r.characters[e]}).map(function(t){return s=addClass(makeEl("div"),"events-singleEventAdaptation"),d=addClass(makeEl("div"),"story-events-div-main"),u=addClass(makeEl("div"),"story-events-div-left"),m=addClass(makeEl("div"),"story-events-div-right"),addEl(d,u),addEl(d,m),addEl(s,d),c=a[e+"-"+t],addEl(u,makeText(t)),addEl(m,UI.makeAdaptationTimeInput(e,r,t,c)),addEl(s,Events.makeAdaptationTextInput(e,r,t,c)),addEl(s,Events.makeAdaptationReadyInput(e,r,t,c)),s})),addEl(i,addEl(o,l)),i}))},Events.onChangeDateTimeCreator=R.curry(function(e,t){return function(r,a){DBMS.updateEventProperty(e,t.eventIndex,"time",a.val(),Utils.processError()),StoryEvents.lastDate=a.val(),removeClass(t,"defaultDate")}}),Events.makeOriginTextInput=function(e,t){var r=makeEl("textarea");return addClass(r,"isStoryEditable"),addClass(r,"eventPersonalStory"),r.value=t.text,r.dataKey=JSON.stringify([e,t.index]),listen(r,"change",Events.onChangeOriginText),r},Events.makeAdaptationTextInput=function(e,t,r,a){var n=makeEl("textarea");return setClassByCondition(n,"notEditable",!a),addClass(n,"eventPersonalStory"),n.value=t.characters[r].text,n.dataKey=JSON.stringify([e,t.index,r]),listen(n,"change",Events.onChangeAdaptationText),n},Events.makeAdaptationReadyInput=function(e,t,r,a){var n=makeEl("div"),i=makeEl("input");return setClassByCondition(i,"notEditable",!a),i.type="checkbox",i.checked=t.characters[r].ready,i.dataKey=JSON.stringify([e,t.index,r]),i.id=t.index+"-"+e+"-"+r,listen(i,"change",Events.onChangeReadyStatus),addEl(n,i),addEl(n,setAttr(addEl(makeEl("label"),makeText(constL10n(Constants.finishedText))),"for",i.id)),n},Events.onChangeReadyStatus=function(e){var t=JSON.parse(e.target.dataKey),r=e.target.checked;DBMS.changeAdaptationReadyStatus(t[0],t[1],t[2],r,Utils.processError())},Events.onChangeOriginText=function(e){var t=JSON.parse(e.target.dataKey),r=e.target.value;DBMS.setOriginEventText(t[0],t[1],r,Utils.processError())},Events.onChangeAdaptationText=function(e){var t=JSON.parse(e.target.dataKey),r=e.target.value;DBMS.setAdaptationEventText(t[0],t[1],t[2],r,Utils.processError())},Events.getSuffix=function(e){return e.isEmpty?constL10n(Constants.emptySuffix):e.isFinished?constL10n(Constants.finishedSuffix):""},Events.updateSettings=function(e,t){var r=DBMS.getSettings();r.Events[e]=t},FilterConfiguration.makeFilterConfiguration=function(e){DBMS.getCharacterFilterInfo(function(t,r){if(t)return void Utils.handleError(t);var a=new FilterConfiguration(r);e(null,a)})},FilterConfiguration.prototype.getAllProfileSettings=function(){return this.innerProfileSettings},FilterConfiguration.prototype.getBaseProfileSettings=function(){return this.info.profileSettings},FilterConfiguration.prototype.getDataArrays=function(e){return CommonUtils.getDataArrays(this.info,e)};var GroupProfile={};GroupProfile.profileSettings=[{name:"filterModel",type:"container"},{name:"characterList",type:"container"},{name:"masterDescription",type:"text"},{name:"doExport",type:"checkbox"},{name:"characterDescription",type:"text"}],GroupProfile.init=function(){listen(queryEl(".group-profile-tab .entity-selector"),"change",GroupProfile.showProfileInfoDelegate);var e=clearEl(queryEl(".group-profile-tab .entity-profile"));GroupProfile.inputItems={},GroupProfile.profileSettings.forEach(function(t){t.displayName=getL10n("groups-"+t.name),addEl(e,GroupProfile.makeInput(t))}),GroupProfile.content=queryEl(".group-profile-tab")},GroupProfile.refresh=function(){PermissionInformer.getGroupNamesArray(!1,function(e,t){if(e)return void Utils.handleError(e);var r=clearEl(queryEl(".group-profile-tab .entity-selector"));fillSelector(r,t.map(remapProps4Select)),GroupProfile.applySettings(t,r)})},GroupProfile.applySettings=function(e,t){if(e.length>0){var r=e[0].value,a=DBMS.getSettings();a.GroupProfile||(a.GroupProfile={groupName:r});var n=a.GroupProfile.groupName;-1===e.map(function(e){return e.value}).indexOf(n)&&(a.GroupProfile.groupName=r,n=r),DBMS.getGroup(n,GroupProfile.showProfileInfoCallback),t.value=n}},GroupProfile.makeInput=function(e){var t,r=setAttr(makeEl("span"),"l10n-id","groups-"+e.name),a=addEl(makeEl("tr"),addEl(makeEl("td"),addEl(r,makeText(e.displayName))));switch(e.type){case"text":t=makeEl("textarea"),addClass(t,"profileTextInput"),t.addEventListener("change",GroupProfile.updateFieldValue(e.type));break;case"checkbox":t=makeEl("input"),t.type="checkbox",t.addEventListener("change",GroupProfile.updateFieldValue(e.type));break;case"container":t=makeEl("div"),t.type="container"}return t.selfName=e.name,addClass(t,"isGroupEditable"),GroupProfile.inputItems[e.name]=t,addEl(a,addEl(makeEl("td"),t))},GroupProfile.updateFieldValue=function(e){return function(t){var r,a=t.target.selfName,n=GroupProfile.name;switch(e){case"text":r=t.target.value;break;case"checkbox":r=t.target.checked}DBMS.updateGroupField(n,a,r,Utils.processError())}},GroupProfile.showProfileInfoDelegate=function(e){var t=e.target.value.trim();DBMS.getGroup(t,GroupProfile.showProfileInfoCallback)},GroupProfile.showProfileInfoCallback=function(e,t){if(e)return void Utils.handleError(e);var r=t.name;FilterConfiguration.makeFilterConfiguration(function(e,a){return e?void Utils.handleError(e):void PermissionInformer.isGroupEditable(r,function(e,n){if(e)return void Utils.handleError(e);
CharacterProfile.updateSettings(r),GroupProfile.name=r;var i=GroupProfile.inputItems;Object.keys(i).forEach(function(e){if("checkbox"===i[e].type)i[e].checked=t[e];else if("container"===i[e].type)if("filterModel"===e){var r=clearEl(i[e]),o=makeEl("table");addClass(o,"table");var s=makeEl("tbody");addEls(s,t.filterModel.map(GroupProfile.makeFilterItemString(a))),addEl(o,s),addEl(r,o)}else{var l=a.getDataArrays(t.filterModel).map(function(e){return e[0].value}).sort(),r=clearEl(i[e]);addEl(r,makeText(l.join(", "))),addEl(r,makeEl("br")),addEl(r,makeText(getL10n("groups-total")+l.length))}else i[e].value=t[e];i[e].oldValue=t[e],Utils.enable(GroupProfile.content,"isGroupEditable",n)})})})},GroupProfile.getHeaderDisplayName=function(e,t){return CommonUtils.arr2map(e.getAllProfileSettings(),"name")[t].displayName},GroupProfile.makeFilterItemString=R.curry(function(e,t){var r=makeEl("tr"),a=makeEl("td");addEl(r,a);var n=GroupProfile.getHeaderDisplayName(e,t.name);addEl(a,makeText(n));var i;switch(t.type){case"enum":i=strFormat("{0}",[Object.keys(t.selectedOptions).join(", ")]);break;case"checkbox":var o=[];t.selectedOptions["true"]&&o.push(getL10n("constant-yes")),t.selectedOptions["false"]&&o.push(getL10n("constant-no")),i=strFormat("{0}",[o.join(", ")]);break;case"number":i=strFormat("{0} {1}",[getL10n("constant-"+t.condition),t.num]);break;case"text":case"string":i=strFormat(getL10n("groups-text-contains"),[t.regexString])}return a=makeEl("td"),addEl(r,a),addEl(a,makeText(i)),r}),GroupProfile.updateSettings=function(e){var t=DBMS.getSettings();t.GroupProfile.groupName=e};var Groups={};Groups.init=function(){var e=Groups;e.views={};var t=".groups-tab .sub-tab-navigation",r=".groups-tab .sub-tab-content",a={root:e,navigation:queryEl(t),content:queryEl(r)};Utils.addView(a,"group-profile",GroupProfile,{mainPage:!0}),Utils.addView(a,"group-schema",GroupSchema),Utils.addView(a,"investigation-board",InvestigationBoard),listen(queryEl(".groups-tab .create-entity-button"),"click",Groups.createGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .rename-entity-button"),"click",Groups.renameGroup(".groups-tab",Groups.refresh)),listen(queryEl(".groups-tab .remove-entity-button"),"click",Groups.removeGroup(".groups-tab",Groups.refresh)),Groups.content=queryEl(".groups-tab")},Groups.refresh=function(){PermissionInformer.getGroupNamesArray(!0,Utils.processError(function(e){Groups.rebuildInterface(".groups-tab",e),Groups.currentView.refresh()}))},Groups.rebuildInterface=function(e,t){var r=getSelect2Data(t);clearEl(queryEl(e+" .rename-entity-select")),$(e+" .rename-entity-select").select2(r),clearEl(queryEl(e+" .remove-entity-select")),$(e+" .remove-entity-select").select2(r)},Groups.createGroup=function(e,t){return function(){var r=queryEl(e+" .create-entity-input").value.trim();return""===r?void Utils.alert(getL10n("groups-group-name-is-not-specified")):void DBMS.isGroupNameUsed(r,function(e,a){return e?void Utils.handleError(e):a?void Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[r])):void DBMS.createGroup(r,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})})})}},Groups.renameGroup=function(e,t){return function(){var r=queryEl(e+" .rename-entity-select").value.trim(),a=queryEl(e+" .rename-entity-input").value.trim();return""===a?void Utils.alert(getL10n("groups-new-group-name-is-not-specified")):r===a?void Utils.alert(getL10n("groups-names-are-the-same")):void DBMS.isGroupNameUsed(a,function(e,n){return e?void Utils.handleError(e):void(n?Utils.alert(strFormat(getL10n("groups-group-name-already-used"),[a])):DBMS.renameGroup(r,a,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})}))})}},Groups.removeGroup=function(e,t){return function(){var r=queryEl(e+" .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("groups-are-you-sure-about-group-removing"),[r]))&&DBMS.removeGroup(r,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void t()})})}};var GroupSchema={};GroupSchema.init=function(){GroupSchema.content=queryEl(".group-schema-tab")},GroupSchema.refresh=function(){DBMS.getGroupSchemas(function(e,t){GroupSchema.redrawSchema(t.theory)})},GroupSchema.redrawSchema=function(e){var t=queryEl(".group-schema-tab .schema-container");GroupSchema.network&&GroupSchema.network.destroy(),e.edges=e.edges.map(function(e){return R.merge(e,{physics:!1})}),GroupSchema.network=new vis.Network(t,e,Constants.groupSchemaOpts)};var InvestigationBoard={};InvestigationBoard.init=function(){listen(queryEl(".investigation-board-tab .group-add-button"),"click",InvestigationBoard.addGroup),listen(queryEl(".investigation-board-tab .group-switch-button"),"click",InvestigationBoard.switchGroup),listen(queryEl(".investigation-board-tab .group-save-notes-button"),"click",InvestigationBoard.setGroupNotes),listen(queryEl(".investigation-board-tab .create-entity-button"),"click",InvestigationBoard.createResource),listen(queryEl(".investigation-board-tab .rename-entity-button"),"click",InvestigationBoard.renameResource),listen(queryEl(".investigation-board-tab .save-edge-button"),"click",InvestigationBoard.saveEdge),listen(queryEl(".investigation-board-tab .cancel-node-adding-button"),"click",InvestigationBoard.cancel(".board-add-node-popup")),listen(queryEl(".investigation-board-tab .cancel-resource-editing-button"),"click",InvestigationBoard.cancel(".board-edit-resource-popup")),listen(queryEl(".investigation-board-tab .cancel-group-editing-button"),"click",InvestigationBoard.cancel(".board-edit-group-popup")),listen(queryEl(".investigation-board-tab .cancel-add-edge-button"),"click",InvestigationBoard.cancel(".board-add-edge-popup")),InvestigationBoard.nodesDataset=new vis.DataSet,InvestigationBoard.edgesDataset=new vis.DataSet;var e={nodes:InvestigationBoard.nodesDataset,edges:InvestigationBoard.edgesDataset},t=queryEl(".investigation-board-tab .schema-container");InvestigationBoard.network=new vis.Network(t,e,Constants.investigationBoardOpts),InvestigationBoard.network.on("selectEdge",InvestigationBoard.showEdgeLabelEditor),InvestigationBoard.network.on("deselectEdge",InvestigationBoard.hideEdgeLabelEditor),InvestigationBoard.content=queryEl(".investigation-board-tab")},InvestigationBoard.refresh=function(e){PermissionInformer.getGroupNamesArray(!1,Utils.processError(function(t){DBMS.getInvestigationBoardData(function(r,a){var n=t.map(R.prop("value")),i=R.keys(a.groups),o=R.difference(n,i);clearEl(queryEl(".investigation-board-tab .group-add-select")),$(".investigation-board-tab .group-add-select").select2(arr2Select2(o)),clearEl(queryEl(".investigation-board-tab .group-switch-select")),$(".investigation-board-tab .group-switch-select").select2(arr2Select2(o)),e||InvestigationBoard.redrawBoard(a)})}))},InvestigationBoard.addNode=function(e,t){InvestigationBoard.showPopup(".board-add-node-popup",!0),InvestigationBoard.modifyArgs={newNode:e,callback:t}},InvestigationBoard.addGroup=function(){var e=queryEl(".investigation-board-tab .group-add-select").value.trim();DBMS.addBoardGroup(e,function(t){return t?void Utils.handleError(t):void InvestigationBoard.setNode(e,"groups")})},InvestigationBoard.createResource=function(){var e=queryEl(".investigation-board-tab .create-entity-input").value.trim();DBMS.createResource(e,function(t){return t?void Utils.handleError(t):void InvestigationBoard.setNode(e,"resources")})},InvestigationBoard.setNode=function(e,t){var r=InvestigationBoard.modifyArgs.newNode;"groups"===t?(r.originalLabel=e,r.originalNotes="",r.label=InvestigationBoard.makeDisplayLabel(r.originalLabel,r.originalNotes)):r.label=e,r.id=InvestigationBoard._makeRelNodeId(e,t),r.group=t,InvestigationBoard.showPopup(".board-add-node-popup",!1),InvestigationBoard.refresh(!0),InvestigationBoard.modifyArgs.callback(r)},InvestigationBoard.editNodeFun=function(e,t){InvestigationBoard.modifyArgs={editNode:e,callback:t},"groups"===e.group?InvestigationBoard.editGroup():InvestigationBoard.editResource()},InvestigationBoard.editGroup=function(){InvestigationBoard.showPopup(".board-edit-group-popup",!0),queryEl(".investigation-board-tab .group-notes-editor").value=InvestigationBoard.modifyArgs.editNode.originalNotes},InvestigationBoard.switchGroup=function(){var e=InvestigationBoard.modifyArgs.editNode,t=e.originalLabel,r=queryEl(".investigation-board-tab .group-switch-select").value.trim(),a=InvestigationBoard.modifyArgs.callback;DBMS.switchGroups(t,r,function(t){return t?void Utils.handleError(t):(e.originalLabel=r,e.label=InvestigationBoard.makeDisplayLabel(e.originalLabel,e.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),a(e),void InvestigationBoard.refresh(!0))})},InvestigationBoard.setGroupNotes=function(){var e=InvestigationBoard.modifyArgs.editNode,t=queryEl(".investigation-board-tab .group-notes-editor").value.trim(),r=InvestigationBoard.modifyArgs.callback;DBMS.setGroupNotes(e.originalLabel,t,function(a){return a?void Utils.handleError(a):(e.originalNotes=t,e.label=InvestigationBoard.makeDisplayLabel(e.originalLabel,e.originalNotes),InvestigationBoard.showPopup(".board-edit-group-popup",!1),r(e),void InvestigationBoard.refresh(!0))})},InvestigationBoard.editResource=function(){InvestigationBoard.showPopup(".board-edit-resource-popup",!0)},InvestigationBoard.renameResource=function(){var e=InvestigationBoard.modifyArgs.editNode,t=e.label,r=queryEl(".investigation-board-tab .rename-entity-input").value.trim(),a=InvestigationBoard.modifyArgs.callback;DBMS.renameResource(t,r,function(t){return t?void Utils.handleError(t):(e.label=r,InvestigationBoard.showPopup(".board-edit-resource-popup",!1),void a(e))})},InvestigationBoard.deleteNode=function(e,t){var r=InvestigationBoard.nodesDataset.get(e.nodes[0]),a="groups"===r.group?"removeBoardGroup":"removeResource",n="groups"===r.group?getL10n("investigation-board-confirm-group-node-removing"):getL10n("investigation-board-confirm-resource-node-removing"),i="groups"===r.group?r.originalLabel:r.label;Utils.confirm(strFormat(n,[i]))?DBMS[a](i,function(r){return r?(Utils.handleError(r),void t()):(InvestigationBoard.refresh(!0),void t(e))}):t()},InvestigationBoard.makeDisplayLabel=function(e,t){function r(e){return e.split("\n").map(R.splitEvery(20)).map(R.join("\n")).join("\n")}return r(e)+(""===t.trim()?"":"\n\n"+r(t))},InvestigationBoard._makeRelNodeId=function(e,t){return("groups"===t?"group-":"resource-")+e},InvestigationBoard.redrawBoard=function(e){function t(e){return{label:e,id:InvestigationBoard._makeRelNodeId(e,"resources")}}function r(e){return{originalLabel:e.name,originalNotes:e.notes,label:InvestigationBoard.makeDisplayLabel(e.name,e.notes),id:InvestigationBoard._makeRelNodeId(e.name,"groups")}}var a=[];a=a.concat(R.values(e.groups).map(r).map(R.merge({group:"groups"}))),a=a.concat(R.keys(e.resources).map(t).map(R.merge({group:"resources"}))),InvestigationBoard.nodesDataset.clear(),InvestigationBoard.nodesDataset.add(a);var n=[],n=R.flatten(R.keys(e.relations).map(function(t){return R.keys(e.relations[t]).map(function(r){return{from:t,to:r,label:e.relations[t][r]}})}));InvestigationBoard.edgesDataset.clear(),InvestigationBoard.edgesDataset.add(n);var i=CommonUtils.clone(Constants.investigationBoardOpts);i=R.merge(i,{locale:L10n.getLang(),locales:Constants.visLocales,manipulation:{addNode:InvestigationBoard.addNode,deleteNode:InvestigationBoard.deleteNode,editNode:InvestigationBoard.editNodeFun,addEdge:InvestigationBoard.addEdge,editEdge:!1,deleteEdge:InvestigationBoard.deleteEdge}}),InvestigationBoard.network.setOptions(i)},InvestigationBoard.showEdgeLabelEditor=function(e){if(0!==e.edges.length&&0===e.nodes.length){var t=InvestigationBoard.edgesDataset.get(e.edges[0]);InvestigationBoard.modifyArgs={edge:t,callback:function(e){e&&InvestigationBoard.edgesDataset.update(e)},editEdge:!0},queryEl(".investigation-board-tab .add-edge-label-input").value=t.label,InvestigationBoard.showPopup(".board-add-edge-popup",!0)}},InvestigationBoard.hideEdgeLabelEditor=function(e){InvestigationBoard.showPopup(".board-add-edge-popup",!1)},InvestigationBoard.addEdge=function(e,t){var r=InvestigationBoard.nodesDataset.get(e.from);return"resources"===r.group?(Utils.alert(getL10n("investigation-board-resource-node-cant-be-first")),void t()):(InvestigationBoard.modifyArgs={fromNode:InvestigationBoard.nodesDataset.get(e.from),toNode:InvestigationBoard.nodesDataset.get(e.to),callback:t},void InvestigationBoard.showPopup(".board-add-edge-popup",!0))},InvestigationBoard.saveEdge=function(){InvestigationBoard.modifyArgs.editEdge?InvestigationBoard.updateEdge():InvestigationBoard.createEdge()},InvestigationBoard.updateEdge=function(){var e=queryEl(".investigation-board-tab .add-edge-label-input").value.trim(),t=InvestigationBoard.modifyArgs.edge;DBMS.setEdgeLabel(t.from,t.to,e,function(r){return r?void Utils.handleError(r):(t.label=e,InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback(t))})},InvestigationBoard.createEdge=function(){var e=InvestigationBoard.modifyArgs.fromNode,t=InvestigationBoard.modifyArgs.toNode,r=queryEl(".investigation-board-tab .add-edge-label-input").value.trim();DBMS.addEdge(e.id,t.id,r,function(a){return a?void Utils.handleError(a):(InvestigationBoard.showPopup(".board-add-edge-popup",!1),void InvestigationBoard.modifyArgs.callback({from:e.id,to:t.id,label:r}))})},InvestigationBoard.deleteEdge=function(e,t){var r=InvestigationBoard.edgesDataset.get(e.edges[0]);DBMS.removeEdge(r.from,r.to,function(r){return r?(Utils.handleError(r),void t()):void t(e)})},InvestigationBoard.cancel=function(e){return function(){InvestigationBoard.showPopup(e,!1),InvestigationBoard.modifyArgs.callback()}},InvestigationBoard.showPopup=R.curry(function(e,t){setClassByCondition(queryEl(".investigation-board-tab "+e),"hidden",!t)});var LogViewer={};LogViewer.init=function(){listen(getEl("logPageSelector"),"change",function(e){DBMS.getLog(Number(e.target.value),LogViewer.dataRecieved)}),LogViewer.content=getEl("logViewerDiv")},LogViewer.refresh=function(){getEl("logPageSelector").selectedIndex=0,DBMS.getLog(0,LogViewer.dataRecieved)},LogViewer.dataRecieved=function(e,t){if(e)return void Utils.handleError(e);var r=getEl("logPageSelector"),a=r.selectedIndex;clearEl(r);for(var n=[],i=0;i<t.logSize;i++)n.push({name:i+1,value:String(i),selected:a==i});fillSelector(r,n);var o=clearEl(getEl("logData"));R.ap([addEl(o)],t.requestedLog.map(LogViewer.makeRow))},LogViewer.makeRow=function(e){var t=makeEl("tr"),r=function(e){addEl(t,addEl(makeEl("td"),makeText(e)))};return r(e[0]),r(new Date(e[2]).format("yyyy/mm/dd HH:MM:ss")),r(e[1]),r(e[3]),r(e[4]),t};var LogViewer2={};LogViewer2.init=function(){var e=LogViewer2;e.views={};var t=".log-viewer2-tab .sub-tab-navigation",r=".log-viewer2-tab .sub-tab-content",a={root:e,navigation:queryEl(t),content:queryEl(r)};Utils.addView(a,"logViewer",LogViewer,{mainPage:!0}),Utils.addView(a,"about",About),LogViewer2.content=queryEl(".log-viewer2-tab")},LogViewer2.refresh=function(){LogViewer2.currentView.refresh()};var MasterStory={};MasterStory.init=function(){listen(getEl("masterStoryArea"),"change",MasterStory.updateMasterStory),MasterStory.content=getEl("masterStoryDiv2")},MasterStory.refresh=function(){var e=getEl("masterStoryArea"),t=Stories.CurrentStoryName;t?DBMS.getMasterStory(t,function(t,r){return t?void Utils.handleError(t):void(e.value=r)}):e.value=""},MasterStory.updateMasterStory=function(){var e=getEl("masterStoryArea");DBMS.updateMasterStory(Stories.CurrentStoryName,e.value,Utils.processError())};var statisticKeys=["storyNumber","characterNumber","eventsNumber","userNumber","textCharacterNumber","lastEvent","firstEvent"],Overview={};Overview.Charts={},Overview.init=function(){Overview.name=getEl("gameNameInput"),Overview.name.addEventListener("change",Overview.updateName),Overview.lastSaveTime=getEl("lastSaveTime"),Overview.date=getEl("gameDatePicker");var e={lang:L10n.getLang(),mask:!0,onChangeDateTime:Overview.updateTime};jQuery(Overview.date).datetimepicker(e),Overview.preDate=getEl("preGameDatePicker"),e={lang:"ru",mask:!0,onChangeDateTime:Overview.updatePreGameDate},jQuery(Overview.preDate).datetimepicker(e),L10n.onL10nChange(function(){jQuery(Overview.date).datetimepicker({lang:L10n.getLang()}),jQuery(Overview.preDate).datetimepicker({lang:L10n.getLang()})}),Overview.descr=getEl("gameDescription"),Overview.descr.addEventListener("change",Overview.updateDescr),UI.initTabPanel("overviewInfoButton","overviewContainer"),Overview.content=getEl("overviewDiv")},Overview.makeChart=function(e,t,r){Overview.Charts[e]&&Overview.Charts[e].destroy(),r.forEach(function(e,t){Constants.colorPalette[t]&&(e.color=Constants.colorPalette[t].color.background,e.highlight=Constants.colorPalette[t].color.hover.background)});var a=t.getContext("2d");Overview.Charts[e]=new Chart(a).Doughnut(r,{animateRotate:!1,tooltipTemplate:"<%if (label){%><%=label%><%}%>"})},Overview.makeHistogram=function(e,t){var r=null;t.forEach(function(e){e&&(null===r||e.value>r)&&(r=e.value)}),t.forEach(function(e){e&&(e.normValue=(e.value-0)/(r-0)*.9+.1)});var a;t.forEach(function(t){a=null===t?makeEl("div"):addEl(makeEl("div"),makeText(t.value)),addClass(a,"bar"),t&&(a.style.height=100*t.normValue+"%",$(a).tooltip({title:t.tip})),addEl(e,a)})},Overview.refresh=function(){PermissionInformer.isAdmin(function(e,t){return e?void Utils.handleError(e):void Utils.enable(Overview.content,"adminOnly",t)}),DBMS.getMetaInfo(function(e,t){return e?void Utils.handleError(e):void DBMS.getStatistics(function(e,r){if(e)return void Utils.handleError(e);Overview.name.value=t.name,Overview.date.value=t.date,Overview.preDate.value=t.preGameDate,Overview.descr.value=t.description,addEl(clearEl(Overview.lastSaveTime),makeText(new Date(t.saveTime).format("yyyy/mm/dd HH:MM:ss"))),r.lastEvent=""!==r.lastEvent?new Date(r.lastEvent).format("yyyy/mm/dd h:MM"):"",r.firstEvent=""!==r.firstEvent?new Date(r.firstEvent).format("yyyy/mm/dd h:MM"):"",statisticKeys.forEach(function(e){Overview.updateStatisticValue(r,e)}),addEl(clearEl(getEl("generalCompleteness")),makeText(strFormat(getL10n("overview-general-completeness-value"),r.generalCompleteness))),addEl(clearEl(getEl("storyCompleteness")),makeText(strFormat(getL10n("overview-story-completeness-value"),r.storyCompleteness))),Overview.makeHistogram(clearEl(getEl("storyEventsHist")),r.storyEventsHist),Overview.makeHistogram(clearEl(getEl("storyCharactersHist")),r.storyCharactersHist),Overview.makeHistogram(clearEl(getEl("eventCompletenessHist")),r.eventCompletenessHist),Overview.makeHistogram(clearEl(getEl("characterSymbolsHist")),r.characterSymbolsHist),Overview.makeHistogram(clearEl(getEl("characterStoriesHist")),r.characterStoriesHist),Overview.makeChart("characterChart",getEl("characterChart"),r.characterChartData),Overview.makeChart("storyChart",getEl("storyChart"),r.storyChartData),Overview.makeChart("groupChart",getEl("groupChart"),r.groupChartData);var a,n,i=clearEl(getEl("profileDiagrams")),o=addEl(i),s=function(e){return a=makeEl("div"),addEl(a,addEl(makeEl("h4"),makeText(e.name))),addEl(a,e.bar),a},l=function(e){return n=setAttr(setAttr(makeEl("canvas"),"width","300"),"height","100"),Overview.makeChart(e.name,n,e.prepared),R.zipObj(["name","bar"],[e.name,n])},c=function(e){return n=makeEl("div"),addClass(n,"overviewHist"),Overview.makeHistogram(n,e.prepared),R.zipObj(["name","bar"],[e.name,n])},d=R.compose(o,s,l,Overview.prepareChart),u=R.compose(o,s,c,Overview.prepareHist),m=function(e){return e.data=R.fromPairs(R.toPairs(e.data).map(function(e){return e[0]=constL10n(Constants[e[0]]),e})),e},p=R.compose(d,m),f=R.cond([[R.compose(R.equals("enum"),R.prop("type")),d],[R.compose(R.equals("checkbox"),R.prop("type")),p],[R.T,u]]);r.profileCharts.forEach(f)})})},Overview.prepareChart=function(e){var t=R.sum(R.values(e.data));e.prepared=[];for(var r in e.data)e.prepared.push(R.zipObj(["value","label"],[e.data[r],Overview.makeChartLabel(t,r,e.data[r])]));return e},Overview.prepareHist=function(e){e.prepared=[];var t=e.data.step;e.data=e.data.groups;for(var r=R.apply(Math.min,R.keys(e.data)),a=R.apply(Math.max,R.keys(e.data)),n=r;a+1>n;n++)e.data[n]?e.prepared.push({value:e.data[n],label:n*t+"-"+(n*t+(t-1)),tip:n*t+"-"+(n*t+(t-1))}):e.prepared.push(null);return e},Overview.makeChartLabel=R.curry(function(e,t,r){return[t,": ",(r/e*100).toFixed(0),"% (",r,"/",e,")"].join("")}),Overview.updateStatisticValue=function(e,t){addEl(clearEl(getEl(t)),makeText(e[t]))},Overview.updateName=function(e){DBMS.setMetaInfo("name",e.target.value,Utils.processError())},Overview.updateTime=function(e,t){DBMS.setMetaInfo("date",t.val(),Utils.processError())},Overview.updatePreGameDate=function(e,t){DBMS.setMetaInfo("preGameDate",t.val(),Utils.processError())},Overview.updateDescr=function(e){DBMS.setMetaInfo("description",e.target.value,Utils.processError())};var Stories={};Stories.init=function(){Stories.left={views:{}},Stories.right={views:{}};var e={root:Stories.left,navigation:queryEl(".stories-navigation-container .left-side"),content:queryEl(".stories-content-container .left-side")};Utils.addView(e,"master-story",MasterStory,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),e={root:Stories.right,navigation:queryEl(".stories-navigation-container .right-side"),content:queryEl(".stories-content-container .right-side")},Utils.addView(e,"master-story",MasterStory,{toggle:!0}),Utils.addView(e,"story-events",StoryEvents,{mainPage:!0,toggle:!0}),Utils.addView(e,"story-characters",StoryCharacters,{toggle:!0}),Utils.addView(e,"event-presence",EventPresence,{toggle:!0}),listen(queryEl("#storiesDiv .create-entity-button"),"click",Stories.createStory),listen(queryEl("#storiesDiv .rename-entity-button"),"click",Stories.renameStory),listen(queryEl("#storiesDiv .remove-entity-button"),"click",Stories.removeStory),$("#storySelector").select2().on("change",Stories.onStorySelectorChangeDelegate),Stories.content=getEl("storiesDiv")},Stories.chainRefresh=function(){(Stories.left.currentView&&"EventPresence"===Stories.left.currentView.name||Stories.right.currentView&&"EventPresence"===Stories.right.currentView.name)&&EventPresence.refresh()},Stories.refresh=function(){var e=["#storiesDiv .rename-entity-select","#storiesDiv .remove-entity-select"];clearEl(getEl("storySelector"));e.forEach(R.compose(clearEl,queryEl)),PermissionInformer.getStoryNamesArray(!1,function(t,r){return t?void Utils.handleError(t):void PermissionInformer.getStoryNamesArray(!0,function(t,a){if(t)return void Utils.handleError(t);if(a.length>0){var n=getSelect2Data(a);e.forEach(function(e){$(e).select2(n)})}if(r.length>0){var i=Stories.getSelectedStoryName(r),n=getSelect2Data(r);$("#storySelector").select2(n).val(i).trigger("change"),Stories.onStorySelectorChange(i)}else Stories.onStorySelectorChange();Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh()})})},Stories.getSelectedStoryName=function(e){var t=DBMS.getSettings();t.Stories||(t.Stories={storyName:e[0].value});var r=t.Stories.storyName;return-1===e.map(function(e){return e.value}).indexOf(r)&&(t.Stories.storyName=e[0].value,r=e[0].value),r},Stories.createStory=function(){var e=queryEl("#storiesDiv .create-entity-input").value.trim();return""===e?void Utils.alert(getL10n("stories-story-name-is-not-specified")):void DBMS.isStoryExist(e,function(t,r){return t?void Utils.handleError(t):void(r?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[e])):DBMS.createStory(e,function(t){return t?void Utils.handleError(t):(Stories.updateSettings(e),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.renameStory=function(){var e=queryEl("#storiesDiv .rename-entity-select").value.trim(),t=queryEl("#storiesDiv .rename-entity-input").value.trim();return""===t?void Utils.alert(getL10n("stories-new-story-name-is-not-specified")):e===t?void Utils.alert(getL10n("stories-names-are-the-same")):void DBMS.isStoryExist(t,function(r,a){return r?void Utils.handleError(r):void(a?Utils.alert(strFormat(getL10n("stories-story-name-already-used"),[t])):DBMS.renameStory(e,t,function(e){return e?void Utils.handleError(e):(Stories.updateSettings(t),void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()}))}))})},Stories.removeStory=function(){var e=queryEl("#storiesDiv .remove-entity-select").value.trim();Utils.confirm(strFormat(getL10n("stories-are-you-sure-about-story-removing"),[e]))&&DBMS.removeStory(e,function(e){return e?void Utils.handleError(e):void PermissionInformer.refresh(function(e){return e?void Utils.handleError(e):void Stories.refresh()})})},Stories.onStorySelectorChangeDelegate=function(e){var t=e.target.value;Stories.onStorySelectorChange(t)},Stories.onStorySelectorChange=function(e){Stories.CurrentStoryName=e,e?(Stories.updateSettings(e),PermissionInformer.isStoryEditable(e,function(e,t){return e?void Utils.handleError(e):(Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh(),void Utils.enable(Stories.content,"isStoryEditable",t))})):(Stories.updateSettings(null),Stories.left.currentView&&Stories.left.currentView.refresh(),Stories.right.currentView&&Stories.right.currentView.refresh())},Stories.updateSettings=function(e){var t=DBMS.getSettings();t.Stories.storyName=e};var StoryCharacters={};StoryCharacters.init=function(){var e=getEl("storyCharactersAddButton");e.addEventListener("click",StoryCharacters.addCharacter),e=getEl("storyCharactersSwitchButton"),e.addEventListener("click",StoryCharacters.switchCharacters),e=getEl("storyCharactersRemoveButton"),e.addEventListener("click",StoryCharacters.removeCharacter),StoryCharacters.ExternalCharacterSelectors=[getEl("storyCharactersAddSelector"),getEl("storyCharactersToSelector")],StoryCharacters.InternalCharacterSelectors=[getEl("storyCharactersRemoveSelector"),getEl("storyCharactersFromSelector")],StoryCharacters.content=getEl("storyCharactersDiv")},StoryCharacters.refresh=function(){StoryCharacters.ExternalCharacterSelectors.forEach(clearEl),StoryCharacters.InternalCharacterSelectors.forEach(clearEl),clearEl(getEl("story-characterActivityTableHead")),clearEl(getEl("story-characterActivityTable")),clearEl(getEl("storyCharactersTableHead")),clearEl(getEl("storyCharactersTable")),Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void PermissionInformer.getCharacterNamesArray(!1,function(e,r){return e?void Utils.handleError(e):void DBMS.getStoryCharacters(Stories.CurrentStoryName,function(e,a){return e?void Utils.handleError(e):(StoryCharacters.rebuildInterface(r,a),Utils.enable(StoryCharacters.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryCharacters.rebuildInterface=function(e,t){var r=[],a=[];e.filter(function(e){return!t[e.value]}).forEach(function(e){r.push(e)}),e.filter(function(e){return t[e.value]}).forEach(function(e){a.push(e)}),r.sort(Utils.charOrdAObject),a.sort(Utils.charOrdAObject);var n=getSelect2Data(r),i=getSelect2Data(a);StoryCharacters.ExternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(n)}),StoryCharacters.InternalCharacterSelectors.forEach(function(e){$("#"+e.id).select2(i)});var o=clearEl(getEl("story-characterActivityTableHead")),s=clearEl(getEl("story-characterActivityTable"));addEl(o,StoryCharacters.getCharacterHeader([getL10n("stories-name")].concat(Constants.characterActivityTypes.map(constL10n)))),a.forEach(function(e){addEl(s,StoryCharacters.getCharacterActivity(e,t[e.value]))}),o=clearEl(getEl("storyCharactersTableHead")),s=clearEl(getEl("storyCharactersTable")),addEl(o,StoryCharacters.getCharacterHeader([getL10n("stories-name"),getL10n("stories-inventory")])),a.forEach(function(e){addEl(s,StoryCharacters.getCharacterInput(e,t[e.value]))})},StoryCharacters.addCharacter=function(){var e=getEl("storyCharactersAddSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void DBMS.addStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh))},StoryCharacters.switchCharacters=function(){var e=getEl("storyCharactersFromSelector").value.trim(),t=getEl("storyCharactersToSelector").value.trim();return""===e||""===t?void Utils.alert(getL10n("stories-one-of-switch-characters-is-not-specified")):void DBMS.switchStoryCharacters(Stories.CurrentStoryName,e,t,Utils.processError(StoryCharacters.refresh))},StoryCharacters.removeCharacter=function(){var e=getEl("storyCharactersRemoveSelector").value.trim();return""===e?void Utils.alert(getL10n("stories-character-name-is-not-specified")):void(Utils.confirm(strFormat(getL10n("stories-remove-character-from-story-warning"),[e]))&&DBMS.removeStoryCharacter(Stories.CurrentStoryName,e,Utils.processError(StoryCharacters.refresh)))},StoryCharacters.getCharacterHeader=function(e){var t=makeEl("tr");return e.forEach(function(e){addEl(t,addEl(makeEl("th"),makeText(e)))}),t},StoryCharacters.getCharacterInput=function(e,t){var r=makeEl("tr"),a=makeEl("td");a.appendChild(makeText(e.displayName)),r.appendChild(a),a=makeEl("td");var n=makeEl("input");return n.value=t.inventory,n.characterName=t.name,addClass(n,"inventoryInput"),addClass(n,"isStoryEditable"),n.addEventListener("change",StoryCharacters.updateCharacterInventory),a.appendChild(n),r.appendChild(a),r},StoryCharacters.updateCharacterInventory=function(e){DBMS.updateCharacterInventory(Stories.CurrentStoryName,e.target.characterName,e.target.value,Utils.processError())},StoryCharacters.getCharacterActivity=function(e,t){var r=makeEl("tr"),a=makeEl("td");a.appendChild(makeText(e.displayName)),r.appendChild(a);var n;return addEls(r,Constants.characterActivityTypes.map(function(e){a=addClass(makeEl("td"),"vertical-aligned-td"),n=makeEl("input"),addClass(n,"isStoryEditable"),n.type="checkbox",t.activity[e]&&(n.checked=!0),n.characterName=t.name,n.activityType=e,n.addEventListener("change",StoryCharacters.onChangeCharacterActivity),setAttr(n,"id",t.name+e),addClass(n,"hidden"),addEl(a,n);var r=addClass(makeEl("label"),"checkbox-label");return setAttr(r,"for",t.name+e),addEl(a,r)})),r},StoryCharacters.onChangeCharacterActivity=function(e){DBMS.onChangeCharacterActivity(Stories.CurrentStoryName,e.target.characterName,e.target.activityType,e.target.checked,Utils.processError())};var StoryEvents={};StoryEvents.init=function(){var e=getEl("createEventButton");e.addEventListener("click",StoryEvents.createEvent),e=getEl("moveEventButton"),e.addEventListener("click",StoryEvents.moveEvent),e=getEl("cloneEventButton"),e.addEventListener("click",StoryEvents.cloneEvent),e=getEl("mergeEventButton"),e.addEventListener("click",StoryEvents.mergeEvents),e=getEl("removeEventButton"),e.addEventListener("click",StoryEvents.removeEvent),StoryEvents.content=getEl("storyEventsDiv")},StoryEvents.refresh=function(){StoryEvents.clearInterface(),void 0!==Stories.CurrentStoryName&&PermissionInformer.isStoryEditable(Stories.CurrentStoryName,function(e,t){return e?void Utils.handleError(e):void DBMS.getMetaInfo(function(e,r){return e?void Utils.handleError(e):void DBMS.getStoryEvents(Stories.CurrentStoryName,function(e,a){return e?void Utils.handleError(e):(StoryEvents.rebuildInterface(a,r),Utils.enable(StoryEvents.content,"isStoryEditable",t),void Stories.chainRefresh())})})})},StoryEvents.clearInterface=function(){clearEl(getEl("eventBlockHead")),clearEl(getEl("eventBlock"));var e=nl2array(document.querySelectorAll(".eventPositionSelector"));
R.ap([clearEl],e);var t=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],t)},StoryEvents.rebuildInterface=function(e,t){var r=clearEl(getEl("eventBlockHead")),a=clearEl(getEl("eventBlock"));addEl(r,StoryEvents.getEventHeader());var n,i,o=R.curry(function(e,t){addEl(e,addEl(makeEl("option"),makeText(t)))}),s=nl2array(document.querySelectorAll(".eventPositionSelector"));R.ap([clearEl],s),s.forEach(function(t){i=o(t),e.forEach(function(e){i(strFormat(getL10n("common-set-item-before"),[e.name]))}),i(getL10n("common-set-item-as-last")),t.selectedIndex=e.length}),R.ap([addEl(a)],e.map(function(e,r){return StoryEvents.appendEventInput(e,r,t.date,t.preGameDate)})),StoryEvents.eventsLength=e.length;var l=nl2array(document.querySelectorAll(".eventEditSelector"));R.ap([clearEl],l),e.forEach(function(e,t){l.forEach(function(r){n=makeEl("option"),n.appendChild(makeText(e.name)),n.eventIndex=t,r.appendChild(n)})})},StoryEvents.createEvent=function(){var e=getEl("eventNameInput"),t=e.value.trim(),r=getEl("eventTextInput"),a=getEl("positionSelector"),n=r.value.trim();return""===t?void Utils.alert(getL10n("stories-event-name-is-not-specified")):""===n?void Utils.alert(getL10n("stories-event-text-is-empty")):void DBMS.createEvent(Stories.CurrentStoryName,t,n,a.value===getL10n("common-set-item-as-last"),a.selectedIndex,function(t){return t?void Utils.handleError(t):(e.value="",r.value="",void StoryEvents.refresh())})},StoryEvents.moveEvent=function(){var e=getEl("moveEventSelector").selectedOptions[0].eventIndex,t=getEl("movePositionSelector").selectedIndex;return e===t?void Utils.alert(getL10n("stories-event-positions-are-the-same")):void DBMS.moveEvent(Stories.CurrentStoryName,e,t,Utils.processError(StoryEvents.refresh))},StoryEvents.cloneEvent=function(){var e=getEl("cloneEventSelector").selectedIndex;DBMS.cloneEvent(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.mergeEvents=function(){var e=getEl("mergeEventSelector").selectedIndex;return StoryEvents.eventsLength==e+1?void Utils.alert(getL10n("stories-cant-merge-last-event")):void DBMS.mergeEvents(Stories.CurrentStoryName,e,Utils.processError(StoryEvents.refresh))},StoryEvents.removeEvent=function(){var e=getEl("removeEventSelector");Utils.confirm(strFormat(getL10n("stories-remove-event-warning"),[e.value]))&&DBMS.removeEvent(Stories.CurrentStoryName,e.selectedIndex,Utils.processError(StoryEvents.refresh))},StoryEvents.getEventHeader=function(){var e=makeEl("tr");return addEl(e,addEl(makeEl("th"),makeText("№"))),addEl(e,addEl(makeEl("th"),makeText(getL10n("stories-event")))),e},StoryEvents.appendEventInput=function(e,t,r,a){var n=makeEl("tr");addEl(n,addEl(makeEl("td"),addEl(makeEl("span"),makeText(t+1))));var i=makeEl("td"),o=addClass(makeEl("div"),"story-events-div-main"),s=addClass(makeEl("div"),"story-events-div-left"),l=addClass(makeEl("div"),"story-events-div-right");return addEl(o,s),addEl(o,l),addEl(i,o),addEl(s,StoryEvents.makeEventNameInput(e,t)),addEl(l,UI.makeEventTimePicker({eventTime:e.time,index:t,preGameDate:a,date:r,extraClasses:["isStoryEditable"],onChangeDateTimeCreator:StoryEvents.onChangeDateTimeCreator})),addEl(i,StoryEvents.makeEventTextInput(e,t)),addEl(n,i),n},StoryEvents.makeEventNameInput=function(e,t){var r=makeEl("input");return addClass(r,"isStoryEditable"),r.value=e.name,r.eventIndex=t,r.addEventListener("change",StoryEvents.updateEventName),r},StoryEvents.makeEventTextInput=function(e,t){var r=makeEl("textarea");return addClass(r,"isStoryEditable"),addClass(r,"eventText"),r.value=e.text,r.eventIndex=t,r.addEventListener("change",StoryEvents.updateEventText),r},StoryEvents.onChangeDateTimeCreator=function(e){return function(t,r){DBMS.updateEventProperty(Stories.CurrentStoryName,e.eventIndex,"time",r.val(),Utils.processError()),StoryEvents.lastDate=r.val(),removeClass(e,"defaultDate")}},StoryEvents.updateEventName=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-name-is-not-specified")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"name",t.value,Utils.processError(StoryEvents.refresh))},StoryEvents.updateEventText=function(e){var t=e.target;return""===t.value.trim()?(Utils.alert(getL10n("stories-event-text-is-empty")),void StoryEvents.refresh()):void DBMS.updateEventProperty(Stories.CurrentStoryName,t.eventIndex,"text",t.value,Utils.processError())};var Template={};Template.init=function(){},Template.refresh=function(){};var Timeline={};Timeline.init=function(){var e=getEl("timelineStorySelector");e.addEventListener("change",Timeline.onStorySelectorChangeDelegate);var t=getEl("timelineContainer");Timeline.TimelineDataset=new vis.DataSet,Timeline.TagDataset=new vis.DataSet;var r={orientation:"top",showCurrentTime:!1},a=new vis.Timeline(t,null,r);a.setGroups(Timeline.TagDataset),a.setItems(Timeline.TimelineDataset),Timeline.timelineComponent=a,Timeline.content=getEl("timelineDiv")},Timeline.refresh=function(){var e=getEl("timelineStorySelector");clearEl(e);var t;DBMS.getMetaInfo(function(r,a){if(r)return void Utils.handleError(r);Timeline.postDate=a.date,Timeline.preDate=a.preGameDate;var n=new Date(Timeline.postDate),i=new Date(Timeline.preDate);n.setFullYear(n.getFullYear()+1),i.setFullYear(i.getFullYear()-1),Timeline.timelineComponent.setOptions({end:n,start:i}),PermissionInformer.getStoryNamesArray(!1,function(r,a){return r?void Utils.handleError(r):(a.forEach(function(r){t=makeEl("option"),t.appendChild(makeText(r.displayName)),t.value=r.value,e.appendChild(t)}),void(0!=a.length&&Timeline.onStorySelectorChange([a[0].value])))})})},Timeline.onStorySelectorChangeDelegate=function(e){for(var t=e.target.selectedOptions,r=[],a=0;a<t.length;a++)r.push(t[a].value);Timeline.onStorySelectorChange(r)},Timeline.onStorySelectorChange=function(e){Timeline.TagDataset.clear(),Timeline.TimelineDataset.clear();var t;DBMS.getEventGroupsForStories(e,function(r,a){return r?void Utils.handleError(r):(a.forEach(function(e){t=e.storyName,Timeline.TagDataset.add({id:t,content:t});var r=e.events;r.forEach(function(e){var r=Timeline.postDate;e.time&&(r=e.time),Timeline.TimelineDataset.add({content:e.name,start:r,group:t,storyName:t,eventIndex:e.index})})}),void(e[0]&&(Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-end-date"),start:new Date(Timeline.postDate),group:e[0],className:"importantItem",editable:!1}),Timeline.TimelineDataset.add({content:L10n.getValue("overview-pre-game-start-date"),start:new Date(Timeline.preDate),group:e[0],className:"importantItem",editable:!1}))))})};var NetworkSubsetsSelector={};NetworkSubsetsSelector.init=function(){listen(getEl("networkSubsetsSelector"),"change",NetworkSubsetsSelector.onNetworkSubsetsChange)},NetworkSubsetsSelector.refresh=function(e){NetworkSubsetsSelector.parent=e;var t,r=clearEl(getEl("networkSubsetsSelector")),a=!0;Constants.objectSubsets.forEach(function(e){t=makeEl("option"),t.appendChild(makeText(constL10n(e))),t.value=e,a&&(t.selected=!0,a=!1),r.appendChild(t)}),r=clearEl(getEl("networkCharacterSelector")),Object.keys(NetworkSubsetsSelector.parent.Characters).map(function(e){return NetworkSubsetsSelector.parent.Characters[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,r.appendChild(t)}),r=clearEl(getEl("networkStorySelector")),Object.keys(NetworkSubsetsSelector.parent.Stories).map(function(e){return NetworkSubsetsSelector.parent.Stories[e]}).sort(Utils.charOrdAObject).forEach(function(e){t=makeEl("option"),t.appendChild(makeText(e.displayName)),t.value=e.name,r.appendChild(t)})},NetworkSubsetsSelector.getStoryNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Stories);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var r,a={};for(r=0;r<e.selectedOptions.length;r+=1)a[e.selectedOptions[r].value]=!0;var n,i,o=[],s=function(e){return a[e]};return Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){n=NetworkSubsetsSelector.parent.Stories[e],i=Object.keys(n.characters),i.some(s)&&o.push(e)}),o}e=getEl("networkStorySelector");var r,o=[];for(r=0;r<e.selectedOptions.length;r+=1)o.push(e.selectedOptions[r].value);return o},NetworkSubsetsSelector.getCharacterNames=function(){var e,t=getEl("networkSubsetsSelector").value;if(Constants.objectSubsets[0]===t)return Object.keys(NetworkSubsetsSelector.parent.Characters);if(Constants.objectSubsets[1]===t){e=getEl("networkCharacterSelector");var r,a={},n={};for(r=0;r<e.selectedOptions.length;r+=1)a[e.selectedOptions[r].value]=!0;var i,o,s,l,c=function(e){return a[e]};Object.keys(NetworkSubsetsSelector.parent.Stories).forEach(function(e){i=NetworkSubsetsSelector.parent.Stories[e],o=Object.keys(i.characters),o.some(c)&&i.events.forEach(function(e){s=Object.keys(e.characters),s.some(c)&&s.forEach(function(e){c(e)||(n[e]=!0)})})});var d=Object.keys(a).concat(Object.keys(n));return d}e=getEl("networkStorySelector");var r,u=[],m={};for(r=0;r<e.selectedOptions.length;r+=1)u.push(e.selectedOptions[r].value);var i;return u.forEach(function(e){i=NetworkSubsetsSelector.parent.Stories[e];for(l in i.characters)m[l]=!0}),Object.keys(m)},NetworkSubsetsSelector.onNetworkSubsetsChange=function(e){var t=e.target.value,r=getEl("networkCharacterDiv"),a=getEl("networkStoryDiv");setClassByCondition(r,"hidden",t!==Constants.objectSubsets[1]),setClassByCondition(a,"hidden",t!==Constants.objectSubsets[2])};var SocialNetwork={};SocialNetwork.colorMap={},SocialNetwork.activityColors={active:"red",follower:"blue",defensive:"green",passive:"grey"},SocialNetwork.generatedColors=[],SocialNetwork.focusOptions={scale:1.2,offset:{x:0,y:0},animation:{duration:1e3,easingFunction:"easeInOutQuad"}},SocialNetwork.fixedColors={storyColor:{color:{background:"rgb(255,255,0)",border:"rgb(255,168,3)"}},noGroup:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}},thirdDegreeNode:{color:{background:"rgba(200,200,200,0.5)",border:"rgba(200,200,200,0.5)"}},secondDegreeNode:{color:{background:"rgba(150,150,150,0.75)",border:"rgba(150,150,150,0.75)"}},firstDegreeNode:{color:{background:"rgb(151,194,252)",border:"rgb(43,124,233)"}}},SocialNetwork.init=function(){SocialNetwork.highlightActive=!0,NetworkSubsetsSelector.init(),listen(getEl("networkNodeGroupSelector"),"change",function(e){SocialNetwork.updateNodes(e.target.value)}),listen(getEl("drawNetworkButton"),"click",SocialNetwork.onDrawNetwork),$("#nodeFocusSelector").select2().on("change",SocialNetwork.onNodeFocus);var e=getEl("networkSelector");e.addEventListener("change",SocialNetwork.onNetworkSelectorChangeDelegate),e=getEl("activitySelector"),e.addEventListener("change",SocialNetwork.onActivitySelectorChangeDelegate);var t,r;Constants.characterActivityTypes.forEach(function(a){r=makeEl("option"),r.appendChild(makeText(constL10n(a))),t=r.style,t.color=SocialNetwork.activityColors[a],r.activity=a,e.appendChild(r)}),SocialNetwork.selectedActivities={},SocialNetwork.network,SocialNetwork.highlightActive=!1;var a=function(){var e=clearEl(getEl("socialNetworkWarning"));addEl(e,makeText(getL10n("social-network-require-resources-warning")));var t=makeEl("button");addEl(t,makeText(getL10n("social-network-remove-resources-warning"))),addEl(e,t),t.addEventListener("click",function(){addClass(e,"hidden")})};a(),L10n.onL10nChange(a),SocialNetwork.nodeSort=CommonUtils.charOrdAFactory(function(e){return e.label.toLowerCase()}),SocialNetwork.content=getEl("socialNetworkDiv")},SocialNetwork.refresh=function(){var e,t=clearEl(getEl("networkSelector"));Constants.networks.forEach(function(r){e=makeEl("option"),e.appendChild(makeText(constL10n(r))),e.value=r,t.appendChild(e)}),t.value=Constants.networks[0],t=clearEl(getEl("networkNodeGroupSelector")),PermissionInformer.getCharacterNamesArray(!1,function(e,r){return e?void Utils.handleError(e):void PermissionInformer.getStoryNamesArray(!1,function(e,a){return e?void Utils.handleError(e):void DBMS.getAllProfiles(function(e,n){return e?void Utils.handleError(e):(SocialNetwork.Characters=n,r.forEach(function(e){n[e.value].displayName=e.displayName}),void DBMS.getAllStories(function(e,r){return e?void Utils.handleError(e):(SocialNetwork.Stories=r,a.forEach(function(e){r[e.value].displayName=e.displayName}),void DBMS.getAllProfileSettings(function(e,r){return e?void Utils.handleError(e):void DBMS.getMetaInfo(function(e,a){if(e)return void Utils.handleError(e);SocialNetwork.metaInfo=a;var n=r.filter(function(e){return"enum"===e.type||"checkbox"===e.type}),i=[{name:Constants.noGroup,displayName:constL10n(Constants.noGroup)}].concat(n.map(function(e){return{name:e.name,displayName:e.name}}));i.forEach(function(e){var r=makeEl("option");r.appendChild(makeText(e.displayName)),r.value=e.name,t.appendChild(r)}),SocialNetwork.groupColors={};for(var o in SocialNetwork.fixedColors)SocialNetwork.groupColors[o]=SocialNetwork.fixedColors[o];n.forEach(function(e){"enum"===e.type?e.value.split(",").forEach(function(t,r){SocialNetwork.groupColors[e.name+"."+t.trim()]=Constants.colorPalette[r]}):"checkbox"===e.type&&(e.value?(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[0],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[1]):(SocialNetwork.groupColors[e.name+".true"]=Constants.colorPalette[1],SocialNetwork.groupColors[e.name+".false"]=Constants.colorPalette[0]))}),NetworkSubsetsSelector.refresh(SocialNetwork)})}))}))})})})},SocialNetwork.refreshLegend=function(e){var t=getEl("colorLegend");clearEl(t);var r;Object.keys(SocialNetwork.groupColors).filter(function(t){return t.substring(0,e.length)===e}).forEach(function(e){r=makeEl("div"),r.appendChild(makeText("noGroup"===e?constL10n("noGroup"):e)),r.style.backgroundColor=SocialNetwork.groupColors[e].color.background,r.style.border="solid 2px "+SocialNetwork.groupColors[e].color.border,t.appendChild(r)}),-1!==["characterPresenceInStory","characterActivityInStory"].indexOf(SocialNetwork.selectedNetwork)&&(r=makeEl("div"),r.appendChild(makeText(getL10n("social-network-story"))),r.style.backgroundColor=SocialNetwork.fixedColors.storyColor.color.background,r.style.border="solid 2px "+SocialNetwork.fixedColors.storyColor.color.border,t.appendChild(r))},SocialNetwork.updateNodes=function(e){SocialNetwork.refreshLegend(e);var t;NetworkSubsetsSelector.getCharacterNames().forEach(function(r){var a=SocialNetwork.Characters[r];t="noGroup"===e?e:e+"."+a[e],SocialNetwork.nodesDataset.update({id:a.name,group:t})})},SocialNetwork.onActivitySelectorChangeDelegate=function(e){SocialNetwork.selectedActivities={};var t;for(t=0;t<e.target.selectedOptions.length;t+=1)SocialNetwork.selectedActivities[e.target.selectedOptions[t].activity]=!0},SocialNetwork.onNetworkSelectorChangeDelegate=function(e){var t=e.target.value,r=getEl("activityBlock");setClassByCondition(r,"hidden","characterActivityInStory"!==t)},SocialNetwork.onNodeFocus=function(e){SocialNetwork.network.focus(e.target.value,SocialNetwork.focusOptions)},SocialNetwork.onDrawNetwork=function(){SocialNetwork.onNetworkSelectorChange(getEl("networkSelector").value)},SocialNetwork.onNetworkSelectorChange=function(e){switch(SocialNetwork.selectedNetwork=e,SocialNetwork.nodes=[],SocialNetwork.edges=[],e){case"simpleNetwork":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getSimpleEdges();break;case"socialRelations":SocialNetwork.nodes=SocialNetwork.getCharacterNodes(),SocialNetwork.edges=SocialNetwork.getDetailedEdges();break;case"characterPresenceInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getStoryEdges();break;case"characterActivityInStory":SocialNetwork.nodes=SocialNetwork.getCharacterNodes().concat(SocialNetwork.getStoryNodes()),SocialNetwork.edges=SocialNetwork.getActivityEdges()}SocialNetwork.refreshLegend(getEl("networkNodeGroupSelector").value),clearEl(getEl("nodeFocusSelector")),SocialNetwork.nodes.sort(SocialNetwork.nodeSort);var t=getSelect2DataCommon(remapProps(["id","text"],["id","label"]),SocialNetwork.nodes);$("#nodeFocusSelector").select2(t),SocialNetwork.nodesDataset=new vis.DataSet(SocialNetwork.nodes),SocialNetwork.edgesDataset=new vis.DataSet(SocialNetwork.edges),SocialNetwork.redrawAll()},SocialNetwork.getCharacterNodes=function(){var e=getEl("networkNodeGroupSelector").value,t=[];return NetworkSubsetsSelector.getCharacterNames().forEach(function(r){var a=SocialNetwork.Characters[r];t.push({id:a.name,label:a.name.split(" ").join("\n"),group:"noGroup"===e?constL10n("noGroup"):e+"."+a[e]})}),t},SocialNetwork.getStoryNodes=function(){var e=NetworkSubsetsSelector.getStoryNames().map(function(e){return{id:"St:"+e,label:e.split(" ").join("\n"),value:Object.keys(SocialNetwork.Stories[e].characters).length,title:Object.keys(SocialNetwork.Stories[e].characters).length,group:"storyColor"}});return e},SocialNetwork.getActivityEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var r=SocialNetwork.Stories[t];for(var a in r.characters)for(var n in r.characters[a].activity)SocialNetwork.selectedActivities[n]&&e.push({from:"St:"+t,to:a,color:SocialNetwork.activityColors[n],width:2,hoverWidth:4})}return e},SocialNetwork.getStoryEdges=function(){var e=[];for(var t in SocialNetwork.Stories){var r=SocialNetwork.Stories[t];for(var a in r.characters)e.push({from:"St:"+t,to:a,color:"grey"})}return e},SocialNetwork.getSimpleEdges=function(){var e=[],t={};for(var r in SocialNetwork.Stories){var a=SocialNetwork.Stories[r];a.events.forEach(function(a){for(var n in a.characters)for(var i in a.characters)n===i||t[r+n+i]||t[r+i+n]||(t[r+n+i]=!0,e.push({from:n,to:i,color:"grey"}))})}return e},SocialNetwork.getEventDetails=function(){return R.flatten(R.values(SocialNetwork.Stories).map(function(e){return e.events.map(function(t){return{eventName:t.name,storyName:e.name,time:t.time,characters:R.keys(t.characters)}})}))},SocialNetwork.getDetailedEdges=function(){var e={};return R.values(SocialNetwork.Stories).forEach(function(t){t.events.forEach(function(r){var a=R.keys(r.characters).sort();a.forEach(function(r,n){a.forEach(function(a,i){if(!(i>=n)){var o=r+a;e[o]||(e[o]={from:r,to:a,title:{}}),e[o].title[t.name]=!0}})})})}),R.values(e).map(function(e){var t=R.keys(e.title).sort().join(", "),r=R.keys(e.title).length;return{from:e.from,to:e.to,title:r+": "+t,value:r,color:"grey"}})},SocialNetwork.redrawAll=function(){var e=getEl("socialNetworkContainer"),t={nodes:SocialNetwork.nodesDataset,edges:SocialNetwork.edgesDataset};SocialNetwork.network&&SocialNetwork.network.destroy();var r=CommonUtils.clone(Constants.socialNetworkOpts);r.groups=SocialNetwork.groupColors,SocialNetwork.network=new vis.Network(e,t,r),SocialNetwork.network.on("click",SocialNetwork.neighbourhoodHighlight)},SocialNetwork.neighbourhoodHighlight=function(e){var t=SocialNetwork.nodesDataset.get({returnType:"Object"}),r=SocialNetwork.network,a=SocialNetwork.nodesDataset;if(e.nodes.length>0){SocialNetwork.highlightActive=!0;var n,i,o=e.nodes[0],s=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var c=r.getConnectedNodes(o),d=[];for(n=1;s>n;n++)for(i=0;i<c.length;i++)d=d.concat(r.getConnectedNodes(c[i]));for(n=0;n<d.length;n++)t[d[n]].color="rgba(150,150,150,0.75)",void 0!==t[d[n]].hiddenLabel&&(t[d[n]].label=t[d[n]].hiddenLabel,t[d[n]].hiddenLabel=void 0);for(n=0;n<c.length;n++)t[c[n]].color=void 0,void 0!==t[c[n]].hiddenLabel&&(t[c[n]].label=t[c[n]].hiddenLabel,t[c[n]].hiddenLabel=void 0);t[o].color=void 0,void 0!==t[o].hiddenLabel&&(t[o].label=t[o].hiddenLabel,t[o].hiddenLabel=void 0)}else if(e.edges.length>0){SocialNetwork.highlightActive=!0;var n,i,u=e.edges[0],s=2;for(var l in t)t[l].color="rgba(200,200,200,0.5)",void 0===t[l].hiddenLabel&&(t[l].hiddenLabel=t[l].label,t[l].label=void 0);var m=r.getConnectedNodes(u),p=[];for(n=1;s>n;n++)for(i=0;i<m.length;i++)p=p.concat(r.getConnectedNodes(m[i]));for(n=0;n<p.length;n++)t[p[n]].color="rgba(150,150,150,0.75)",void 0!==t[p[n]].hiddenLabel&&(t[p[n]].label=t[p[n]].hiddenLabel,t[p[n]].hiddenLabel=void 0);for(n=0;n<m.length;n++)t[m[n]].color=void 0,void 0!==t[m[n]].hiddenLabel&&(t[m[n]].label=t[m[n]].hiddenLabel,t[m[n]].hiddenLabel=void 0)}else if(SocialNetwork.highlightActive===!0){for(var l in t)t[l].color=void 0,void 0!==t[l].hiddenLabel&&(t[l].label=t[l].hiddenLabel,t[l].hiddenLabel=void 0);SocialNetwork.highlightActive=!1}var f=[];for(l in t)t.hasOwnProperty(l)&&f.push(t[l]);a.update(f)},function(e){function t(){var e=new Stats;return e.setMode(0),addEl(clearEl(getEl("Stats-output")),e.domElement),e}function r(){c=new THREE.WebGLRenderer,c.setClearColor(new THREE.Color(15658734,1)),addEl(clearEl(getEl("WebGL-output")),c.domElement),u=t(),d=new function(){this.rotationSpeed=.08,this.zScale=p,this.planeScale=10,this.cameraZ=120,this.outputObjects=function(){console.log(l.children)}};var e=new dat.GUI({autoPlace:!1});e.add(d,"rotationSpeed",0,.5),e.add(d,"zScale",1,100),e.add(d,"planeScale",1,100),e.add(d,"cameraZ",-500,500),e.add(d,"outputObjects"),addEl(getEl("gui-settings-output"),e.domElement)}function a(e,t,r,a,i){function g(e){e.minTime=R.reduce(R.min,1/0,e.events.map(R.prop("scaledTime"))),e.maxTime=R.reduce(R.max,-(1/0),e.events.map(R.prop("scaledTime")))}function v(e){return e.startsWith("St:")?C[e.substring(3)]:S[e]}function h(){u.update(),e.storePositions(),B?t.get().forEach(function(e){var t=l.getObjectByName(String("cyl-"+e.id));t&&(t.position.x=e.x/10,t.position.y=-e.y/10)}):(console.log(t.get()),console.log(r.get()),t.get().forEach(function(e){var t=v(e.id);if(t){var r=t.maxTime-t.minTime,a=(t.maxTime+t.minTime)/2;o(e.x/10,-e.y/10,a*p,r,.5,String("cyl-"+e.id))}}),B=!0),l.traverse(function(e){if(e instanceof THREE.Mesh&&e.name.startsWith("cyl-")){var t=v(e.name.substring(4));e.position.z=(t.maxTime+t.minTime)/2*d.zScale,e.scale.y=d.zScale}});var a=Date.now(),n=.005;s.position.x=50*Math.sin(a*d.rotationSpeed*n),s.position.y=50*Math.cos(a*d.rotationSpeed*n),s.position.z=d.cameraZ,s.lookAt(new THREE.Vector3(0,0,0)),requestAnimationFrame(h),c.render(l,s)}var E=new Date(i.preGameDate).getTime(),y=new Date(i.date).getTime(),b=y-E;console.log(E),console.log(y),console.log(b);var S={},C={};a.forEach(function(e){""===e.time&&(e.time=i.date),e.scaledTime=(new Date(e.time).getTime()-E)/b,console.log(e.scaledTime),C[e.storyName]=C[e.storyName]||{events:[]},C[e.storyName].events.push(e),e.characters.forEach(function(t){S[t]=S[t]||{events:[]},S[t].events.push(e)})}),console.log(C),console.log(S),R.values(C).forEach(g),R.values(S).forEach(g),console.log(C),console.log(S);var k=n();l=new THREE.Scene,s=new THREE.PerspectiveCamera(45,k.width/k.height,.1,1e3);var x=new THREE.AxisHelper(20);l.add(x);var w=new THREE.PlaneGeometry(60,20,1,1),P=new THREE.MeshBasicMaterial({color:16777215,opacity:0}),I=new THREE.Mesh(w,P);I.rotation.x=-.5*Math.PI,I.position.x=15,I.position.y=0,I.position.z=0,l.add(I),s.position.copy(m),s.lookAt(new THREE.Vector3(0,0,0)),s.position.add(new THREE.Vector3(0,-100,0)),s.lookAt(new THREE.Vector3(0,0,0));var N=new THREE.AmbientLight(789516);l.add(N);var T=new THREE.SpotLight(16777215);T.position.copy(f),l.add(T);var B=!1;h()}function n(){var e=getComputedStyle(getEl("socialNetworkContainer")),t=.75*e.width.split("px").join(""),r=.75*e.height.split("px").join("");return c.setSize(t,r),{width:t,height:r}}function i(){if(s&&c){var e=n();s.aspect=e.width/e.height,s.updateProjectionMatrix()}}function o(e,t,r,a,n,i){var o=new THREE.CylinderGeometry(n,n,a,32),s=new THREE.MeshLambertMaterial({color:7829503}),c=new THREE.Mesh(o,s);c.name=i,c.position.x=e,c.position.y=t,c.position.z=r,c.rotation.x=-.5*Math.PI,l.add(c)}var s,l,c,d,u,m=new THREE.Vector3(0,0,60).multiplyScalar(2.5),p=25,f=new THREE.Vector3(0,0,50);e.init=r,e.refresh=a,window.addEventListener("resize",i,!1)}(this.TimelinedNetwork={});